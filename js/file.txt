voci l ddesign a gafdre et les manier d'afficher les evenemn avce els mme clase a gare :

comm el fait table.html :


    <script>
        // Variables globales
        let currentEvent = null;
        let currentUser = null;
        let allTables = [];
        let allGuests = [];
        let filteredTables = [];
        let currentView = 'grid';
        let currentFilter = 'all';
        let currentSearch = '';
        let currentPage = 1;
        const tablesPerPage = 12;
        let eventsViewMode = 'grid';
        let eventsList = [];
        
        // Variables pour la cr√©ation
        let creationMode = 'single'; // 'single' ou 'multiple'
        let creationStep = 1;
        let multipleTablesData = [];
        let selectedGuests = [];
        let availableGuestsList = [];


        let currentShape = 'circle';
        let zoomLevel = 1;
        let isEditMode = false;
        let editingTableId = null;

// üìä EXPORT DES INFORMATIONS DES TABLES
// ============================================

let exportStartTime = null;
let currentExportFormat = null;
let selectedExportFormat = null;

/**
 * Afficher le modal d'export
 */
function showExportTableInfoModal() {
    const modal = document.getElementById('tableExportInfoModal');
    if (modal) {
        modal.classList.add('active');
        
        // R√©initialiser l'√©tat
        resetExportModal();
        
        // Charger les statistiques
        updateExportStats();
    }
}

/**
 * Fermer le modal d'export
 */
function closeExportModal() {
    const modal = document.getElementById('tableExportInfoModal');
    if (modal) {
        modal.classList.remove('active');
        resetExportModal();
    }
}

/**
 * R√©initialiser le modal d'export
 */
function resetExportModal() {
    // R√©initialiser les √©tapes
    document.getElementById('exportStep1').classList.add('active');
    document.getElementById('exportStep2').classList.remove('active');
    document.getElementById('exportStep1Indicator').classList.add('active');
    document.getElementById('exportStep2Indicator').classList.remove('active');
    document.getElementById('exportProgressBar').style.width = '50%';
    document.getElementById('exportCurrentStep').textContent = '1';
    
    // R√©initialiser la s√©lection
    document.querySelectorAll('.export-format-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    selectedExportFormat = null;
    currentExportFormat = null;
}





                // Fonctions utilitaires pour l'aper√ßu
        function getEventImage(type) {
            const defaultImages = {
                marriage: 'https://images.unsplash.com/photo-1519167758481-83f550bb49b3?w=800&q=80',
                anniversaire: 'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=800&q=80',
                conference: 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=800&q=80',
                corporate: 'https://images.unsplash.com/photo-1515187029135-18ee286d815b?w=800&q=80',
                concert: 'https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?w=800&q=80',
                gala: 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=800&q=80',
                football: 'https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=800&q=80',
                autre: 'https://images.unsplash.com/photo-1501281668745-f7f579dff10e?w=800&q=80'
            };
            
            return defaultImages[type] || defaultImages.autre;
        }


        // Fonction pour afficher la vue √©v√©nements
        async function showEventsHome() {
            destroyCharts();
            currentEvent = null;
            document.getElementById('eventsHomeView').style.display = 'block';
            document.getElementById('tablesView').style.display = 'none';
            document.title = 'SECURA | S√©lectionnez un √©v√©nement';
            await loadEventsList();
        }

        // Fonction pour afficher la vue tables
        async function showTablesView(eventId) {
            window.history.pushState({}, '', `tables?id=${eventId}`);
            document.getElementById('eventsHomeView').style.display = 'none';
            document.getElementById('tablesView').style.display = 'block';

            await loadTablesForEvent(eventId);
        }

        // Charger la liste des √©v√©nements
        async function loadEventsList() {
            try {
                eventsList = await storage.getAllEvents();
                currentUser = await storage.getProfile();
                
                if (currentUser.role !== 'admin') {
                    eventsList = eventsList.filter(event => 
                        event.organizerId == currentUser.id
                    );
                }
            
                if (eventsList.length === 0) {
                    document.getElementById('emptyEventsState').style.display = 'flex';
                    document.getElementById('eventsGridView').style.display = 'none';
                    document.getElementById('eventsTableView').style.display = 'none';
                    return;
                }
                
                document.getElementById('emptyEventsState').style.display = 'none';
                renderEventsList();
                
            } catch (error) {
                console.error('Erreur chargement √©v√©nements:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de charger la liste des √©v√©nements',
                    confirmButtonColor: '#D97706'
                });
            }
        }

        function renderEventsList() {
            if (eventsViewMode === 'grid') {
                renderEventsGrid();
            } else {
                renderEventsTable();
            }
        }

         // Rendre la vue grille
        async function renderEventsGrid() {
            const grid = document.getElementById('eventsGridView');
            grid.innerHTML = '';
            grid.style.display = 'grid';
            document.getElementById('eventsTableView').style.display = 'none';
            
            for (const event of eventsList) {
                const tables = await storage.getAllTables(event.id);
                    
                    const guests = storage.getGuestsByEventId(event.id);
                    const scannedGuests = guests.filter(g => g.scanned).length;
                    const eventDate = new Date(event.date);
                    const isUpcoming = eventDate >= new Date();
                    
                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card-pro';
                    eventCard.style.backgroundImage = `url('${getEventImage(event.type)}')`;
                    eventCard.style.borderLeft = `4px solid ${event.design?.primaryColor || '#D97706'}`;
                    eventCard.onclick = () => showTablesView(event.id);
                    
                    eventCard.innerHTML = `
                        ${isUpcoming ? '<div class="upcoming-ribbon" style="background: linear-gradient(45deg, #3B82F6, #8B5CF6);">√Ä VENIR</div>' : ''}
                        
                        <div class="event-type-badge" style="background: ${getTypeColor(event.type)}">
                            ${getTypeLabel(event.type)}
                        </div>
                        
                        <div class="event-content">
                            <h3 class="event-title">${escapeHtml(event.name)}</h3>
                            
                            <div class="event-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>${eventDate.toLocaleDateString('fr-FR')}</span>
                                </div>
                                ${event.time ? `
                                <div class="meta-item">
                                    <i class="fas fa-clock"></i>
                                    <span>${event.time}</span>
                                </div>` : ''}
                                ${event.location ? `
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${event.location}</span>
                                </div>` : ''}
                            </div>

                            <div class="event-stats-circle">
                                <div class="stat-circle">
                                    <div class="circle" style="border-color: ${event.design?.primaryColor || '#D97706'}20;">
                                        <span class="value">${guests.length}</span>
                                        <span class="label">Invit√©s</span>
                                    </div>
                                </div>
                                <div class="stat-circle">
                                    <div class="circle" style="border-color: #10B98120;">
                                        <span class="value">${tables.count}</span>
                                        <span class="label">Tables</span>
                                    </div>
                                </div>
                                 
                                <div class="stat-circle">
                                    <div class="circle" style="border-color: #3B82F620;">
                                        <span class="value">${event.capacity || '‚àû'}</span>
                                        <span class="label">Capacit√©</span>
                                    </div>
                                </div>
                            </div>

                            <div class="event-footer">
                                <div class="event-status" style="background: ${event.active ? '#10B981' : '#EF4444'} !important; color: white">
                                    <i class="fas ${event.active ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                    <span>${event.active ? 'Actif' : 'Inactif'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="event-actions" onclick="event.stopPropagation()">
                            <button class="action-btn view" onclick="viewEvent('${event.id}')" title="Voir invit√©s">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="action-btn edit" onclick="editEvent('${event.id}')" title="Modifier">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="action-btn duplicate" onclick="duplicateEvent('${event.id}')" title="Dupliquer">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn stats" onclick="viewEventStats('${event.id}')" title="Statistiques">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteEvent('${event.id}')" title="Supprimer">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    `;
                    
                    grid.appendChild(eventCard);
                };
        }



        // Rendre la vue tableauhttp://localhost:42513/dashboard
        async function renderEventsTable() {
            const table = document.getElementById('eventsTableBody');
            const grid = document.getElementById('eventsGridView');
            
            grid.style.display = 'none';
            document.getElementById('eventsTableView').style.display = 'block';
            table.innerHTML = '';
            
            for (const event of eventsList) {
                const tables = await storage.getAllTables(event.id);
                const guests = storage.getGuestsByEventId(event.id);
                const scannedGuests = guests.filter(g => g.scanned).length;
                const eventDate = new Date(event.date);
                
                const row = document.createElement('tr');
                row.onclick = () => showTablesView(event.id);
                row.style.cursor = 'pointer';
                
                row.innerHTML = `
                    <td>
                        <div class="event-cell">
                            <div class="event-cell-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="event-cell-info">
                                <div class="event-cell-name" title="${escapeHtml(event.name)}">
                                    ${escapeHtml(event.name)}
                                </div>
                                <div class="event-cell-location" title="${event.location || 'Non sp√©cifi√©'}">
                                    ${escapeHtml(event.location || 'Non sp√©cifi√©')}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="event-cell-date">
                            ${eventDate.toLocaleDateString('fr-FR')}
                        </div>
                    </td>
                    <td>
                        <div class="event-cell-type" style="background: ${getTypeColor(event.type)}">
                            ${getTypeLabel(event.type)}
                        </div>
                    </td>
                    <td>
                        <div class="event-cell-stats">
                            <div class="event-cell-stat">
                                <span class="event-cell-stat-number">${tables.count || 0}</span>
                                <span class="event-cell-stat-label">Tables</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="event-cell-stats">
                            <div class="event-cell-stat">
                                <span class="event-cell-stat-number">${guests.length}</span>
                                <span class="event-cell-stat-label">Total</span>
                            </div>
                            <div class="event-cell-stat">
                                <span class="event-cell-stat-number">${scannedGuests}</span>
                                <span class="event-cell-stat-label">Pr√©sents</span>
                            </div>
                        </div>
                    </td>
                `;
                
                table.appendChild(row);
            }
        }

        // Fonctions utilitaires pour les types d'√©v√©nements
        function getTypeColor(type) {
            const colors = {
                marriage: '#EC4899',
                anniversaire: '#F59E0B',
                conference: '#3B82F6',
                corporate: '#6366F1',
                concert: '#8B5CF6',
                gala: '#D97706',
                football: '#10B981',
                autre: '#6B7280'
            };
            return colors[type] || colors.autre;
        }

        function getTypeLabel(type) {
            const labels = {
                marriage: 'Mariage',
                anniversaire: 'Anniversaire',
                conference: 'Conf√©rence',
                corporate: 'Corporate',
                concert: 'Concert',
                gala: 'Gala',
                football: 'Football',
                autre: 'Autre'
            };
            return labels[type] || 'Autre';
        }



        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && currentView !== 'grid') {
                goBackToGridView();
            }
        });
        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            // V√©rifier l'authentification
            const authCheck = await checkAuth();
            if (!authCheck) return;
            
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');

            // Initialiser les vues
            initVectorViewListeners();
            
            if (eventId) {
                document.getElementById('eventsHomeView').style.display = 'none';
                document.getElementById('tablesView').style.display = 'block';
                await loadTablesForEvent(eventId);
            } else {
                initEventsViewListeners();
                await showEventsHome();
                
                document.getElementById('searchEvents')?.focus();
            }
        });



       // Fonction pour basculer entre le menu de toggle principal et les actions sp√©cifiques
      // Fonction pour basculer entre les vues
function updateViewHeader(view) {
    const isGridView = view === 'grid';
    
    ['grid', 'table', 'visual', 'vector', 'stats'].forEach(viewName => {
        const container = document.getElementById(`${viewName}View`);
        if (!container) return;
        
        const header = container.querySelector('.grid-header');
        if (!header) return;
        
        const viewToggle = container.querySelector('.view-toggle');
        
        // Si c'est la vue active, afficher le toggle et activer le bon bouton
        if (viewName === view) {
            if (viewToggle) {
                viewToggle.style.display = 'flex';
                
                // Activer le bouton correspondant √† la vue
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    }
                });
            }
        } else {
            // Pour les autres vues, masquer le toggle
            if (viewToggle) viewToggle.style.display = 'none';
        }
    });
    
    // Mettre aussi √† jour les boutons dans toutes les vues
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === view) {
            btn.classList.add('active');
        }
    });
}

function goBackToGridView() {
    currentView = 'grid';
    currentFilter = 'all';
    currentSearch = '';
    currentPage = 1;
    
    // R√©initialiser les filtres visuels
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
        if (chip.dataset.filter === 'all') {
            chip.classList.add('active');
        }
    });
    
    // R√©initialiser la recherche
    const searchInput = document.getElementById('searchTables');
    if (searchInput) searchInput.value = '';
    
    // Mettre √† jour les boutons de vue
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === 'grid') {
            btn.classList.add('active');
        }
    });
    
    ['grid', 'table', 'visual', 'stats','vector'].forEach(view => {
        const container = document.getElementById(`${view}View`);
        if (container) {
            container.style.display = view === 'grid' ? 'block' : 'none';
        }
    });
    
    const gridView = document.getElementById('gridView');
    if (gridView) {
        const header = gridView.querySelector('.grid-header');
        if (header) header.classList.remove('in-specific-view');
    }
    
    updateViewHeader('grid');
    
    // R√©appliquer les filtres et afficher les tables
    applyFilters();
    renderTables();
}


        // Initialiser les √©couteurs pour la vue √©v√©nements
        function initEventsViewListeners() {



            // Changement de vue (MODIFI√â)
            document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.classList.contains('create')) return;
        
        currentView = this.dataset.view;
        
        // Mettre √† jour l'affichage des vues
        ['grid', 'table', 'visual', 'vector', 'stats'].forEach(view => {
            const container = document.getElementById(`${view}View`);
            if (container) {
                container.style.display = view === currentView ? 'block' : 'none';
            }
        });
        
        // Mettre √† jour l'en-t√™te et activer le bouton
        updateViewHeader(currentView);
        
        currentPage = 1;
        renderTables();
    });
});



            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    
                    document.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    eventsViewMode = this.dataset.mode;
                    renderEventsList();
                });
            });
            
            // Recherche dans la vue √©v√©nements
            const searchInput = document.getElementById('searchEvents');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.trim().toLowerCase();
                        if (searchTerm) {
                            const filteredEvents = eventsList.filter(event =>
                                event.name.toLowerCase().includes(searchTerm) ||
                                event.location?.toLowerCase().includes(searchTerm) ||
                                event.type?.toLowerCase().includes(searchTerm)
                            );
                            eventsList = filteredEvents;
                        } else {
                            loadEventsList();
                        }
                    }, 300);
                });
            }
        }

        async function loadTablesForEvent(eventId) {
            try {
                currentEvent = storage.getEventById(eventId);
                
                if (!currentEvent) {
                    await Swal.fire({
                        icon: 'error',
                        title: '√âv√©nement introuvable',
                        text: 'L\'√©v√©nement sp√©cifi√© n\'existe pas',
                        confirmButtonColor: '#D97706'
                    });
                    showEventsHome();
                    return;
                }
                
                // V√©rifier les permissions
                if (currentUser.role !== 'admin' && currentEvent.organizerId !== currentUser.id) {
                    await Swal.fire({
                        icon: 'warning',
                        title: 'Acc√®s refus√©',
                        text: 'Vous n\'√™tes pas autoris√© √† g√©rer cet √©v√©nement',
                        confirmButtonColor: '#D97706'
                    });
                    showEventsHome();
                    return;
                }
                
                await loadTables();
                initEventListeners();
                updateUI();
                
                // Mettre √† jour l'affichage
                document.getElementById('eventNameDisplay').innerHTML = `
                    <i class="fas fa-calendar-alt"></i>
                    <span>${escapeHtml(currentEvent.name)}</span>
                `;
                updateEventStatusIndicator();
                
                // Mettre √† jour le titre
                document.title = `SECURA | Tables - ${currentEvent.name}`;
                
            } catch (error) {
                console.error('Erreur chargement tables:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de charger les tables',
                    confirmButtonColor: '#D97706'
                });
            }
        }

        // V√©rifier l'authentification
        async function checkAuth() {
            try {
                currentUser = await storage.getProfile();
                if (!currentUser) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Erreur v√©rification auth:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Charger les tables
        async function loadTables() {
            try {
                showLoader('grid');
                
                const response = await storage.getAllTables(currentEvent.id);
                allTables = response.data || [];
                
                allGuests = storage.getGuestsByEventId(currentEvent.id) || [];

                
                // Trier par num√©ro de table
                allTables.sort((a, b) => {
                    const numA = parseInt(a.tableNumber) || 0;
                    const numB = parseInt(b.tableNumber) || 0;
                    if (numA !== numB) return numA - numB;
                    return (a.tableNumber || '').localeCompare(b.tableNumber || '');
                });
                
                applyFilters();
                updateStats();
                renderTables();
                
                hideLoader('grid');
                
            } catch (error) {
                console.error('Erreur chargement tables:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de charger les tables',
                    confirmButtonColor: '#D97706'
                });
                hideLoader('grid');
            }
        }

        // Appliquer les filtres
        function applyFilters() {
            filteredTables = [...allTables];
            
            // R√©initialiser la page √† 1 quand les filtres changent
            currentPage = 1;
            
            // Filtre par statut
            if (currentFilter !== 'all') {
                switch(currentFilter) {
                    case 'available':
                        filteredTables = filteredTables.filter(table => {
                            const totalSeats = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) || 0;
                            return totalSeats < table.capacity;
                        });
                        break;
                    case 'full':
                        filteredTables = filteredTables.filter(table => {
                            const totalSeats = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) || 0;
                            return totalSeats >= table.capacity;
                        });
                        break;
                    case 'empty':
                        filteredTables = filteredTables.filter(table => 
                            !table.assignedGuests || table.assignedGuests.length === 0
                        );
                        break;
                }
            }
            
            // Filtre par recherche
            if (currentSearch) {
                const searchTerm = currentSearch.toLowerCase();
                filteredTables = filteredTables.filter(table =>
                    table.tableNumber?.toLowerCase().includes(searchTerm) ||
                    table.tableName?.toLowerCase().includes(searchTerm) ||
                    table.location?.toLowerCase().includes(searchTerm) ||
                    table.category?.toLowerCase().includes(searchTerm) ||
                    table.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            updatePagination();
        }

        // Mettre √† jour les statistiques
        function updateStats() {
            const totalTables = allTables.length;
            let totalGuests = 0;
            let totalCapacity = 0;
            let occupiedSeats = 0;
            
            allTables.forEach(table => {
                totalCapacity += table.capacity || 0;
                const guestsCount = table.assignedGuests?.length || 0;
                totalGuests += guestsCount;
                
                const seatsOccupied = table.assignedGuests?.reduce((sum, guest) => 
                    sum + (guest.seats || 1), 0) || 0;
                occupiedSeats += seatsOccupied;
            });
            
            const occupancyRate = totalCapacity > 0 ? 
                Math.round((occupiedSeats / totalCapacity) * 100) : 0;
            
            // Mettre √† jour les compteurs
            document.getElementById('tablesCount').textContent = filteredTables.length;
            document.getElementById('tablesTableCount').textContent = filteredTables.length;
            document.getElementById('visualTablesCount').textContent = filteredTables.length;
            document.getElementById('statsTablesCount').textContent = filteredTables.length;
            
            // Mettre √† jour les statistiques avanc√©es
            updateAdvancedStats();
        }

       // Mettre √† jour les statistiques avanc√©es
function updateAdvancedStats() {
    if (currentView !== 'stats') return;
    
    let totalCapacity = 0;
    let occupiedSeats = 0;
    let fullTables = 0;
    let emptyTables = 0;
    let availableTables = 0;
    let totalGuests = 0;
    let totalSeatsUsed = 0;
    let totalQRScans = 0;
    let lastQRScan = null;
    let mostScannedTable = null;
    
    // Nouveaux tableaux pour les graphiques
    let categoryStats = {};
    let capacityDistribution = {};
    
    allTables.forEach(table => {
        totalCapacity += table.capacity || 0;
        const seatsOccupied = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        occupiedSeats += seatsOccupied;
        
        const guestsCount = table.assignedGuests?.length || 0;
        totalGuests += guestsCount;
        totalSeatsUsed += seatsOccupied;
        
        if (seatsOccupied >= table.capacity) fullTables++;
        if (seatsOccupied === 0) emptyTables++;
        if (seatsOccupied < table.capacity && seatsOccupied > 0) availableTables++;
        
        // Statistiques pour le graphique par cat√©gorie
        const category = table.category || 'standard';
        if (!categoryStats[category]) {
            categoryStats[category] = {
                count: 0,
                totalCapacity: 0,
                occupiedSeats: 0
            };
        }
        categoryStats[category].count++;
        categoryStats[category].totalCapacity += table.capacity || 0;
        categoryStats[category].occupiedSeats += seatsOccupied;
        
        // Statistiques pour le graphique de distribution des capacit√©s
        const capacity = table.capacity || 0;
        const capacityRange = getCapacityRange(capacity);
        if (!capacityDistribution[capacityRange]) {
            capacityDistribution[capacityRange] = 0;
        }
        capacityDistribution[capacityRange]++;
        
        // Statistiques QR
        if (table.qrCode?.scanCount) {
            totalQRScans += table.qrCode.scanCount;
            
            if (!lastQRScan || (table.qrCode.lastScan && table.qrCode.lastScan > lastQRScan)) {
                lastQRScan = table.qrCode.lastScan;
            }
            
            if (!mostScannedTable || table.qrCode.scanCount > mostScannedTable.scanCount) {
                mostScannedTable = {
                    name: table.tableName || `Table ${table.tableNumber}`,
                    scanCount: table.qrCode.scanCount
                };
            }
        }
    });
    
    const occupancyRate = totalCapacity > 0 ? 
        Math.round((occupiedSeats / totalCapacity) * 100) : 0;
    
    // Mettre √† jour l'interface
    document.getElementById('overallOccupancyRate').textContent = `${occupancyRate}%`;
    document.getElementById('totalOccupiedSeats').textContent = occupiedSeats;
    document.getElementById('totalCapacity').textContent = totalCapacity;
    
    document.getElementById('fullTablesCount').textContent = fullTables;
    document.getElementById('emptyTablesCount').textContent = emptyTables;
    document.getElementById('availableTablesCount').textContent = availableTables;
    
    document.getElementById('totalAssignedGuests').textContent = totalGuests;
    document.getElementById('guestsWithSeats').textContent = totalGuests;
    document.getElementById('totalSeatsUsed').textContent = totalSeatsUsed;
    
    document.getElementById('totalQRScans').textContent = totalQRScans;
    document.getElementById('lastQRScan').textContent = lastQRScan ? 
        new Date(lastQRScan).toLocaleDateString('fr-FR') : 'Jamais';
    document.getElementById('mostScannedTable').textContent = mostScannedTable ? 
        `${mostScannedTable.name} (${mostScannedTable.scanCount})` : 'Aucune';
    

        // AJOUTER APR√àS LES CALCULS EXISTANTS :
    // Calculer les donn√©es pour les graphiques avanc√©s
    const radarData = calculateRadarData(categoryStats);
    const lineData = calculateLineData(allTables);
    const bubbleData = calculateBubbleData(allTables);
    const polarData = calculatePolarData(categoryStats);
    
    // Calculer les KPIs
    const kpiData = calculateKPIs(allTables, categoryStats);
    
    // Mettre √† jour les KPIs
    document.getElementById('trendValue').textContent = kpiData.trend;
    document.getElementById('efficiencyValue').textContent = kpiData.efficiency + '%';
    document.getElementById('diversityValue').textContent = kpiData.diversity + '%';
    document.getElementById('predictionValue').textContent = kpiData.prediction + '%';
    
    // Rendre tous les graphiques
    renderCategoryChart(categoryStats);
    renderCapacityChart(capacityDistribution);
    renderRadarChart(radarData);
    renderLineChart(lineData);
    renderBubbleChart(bubbleData);
    renderPolarChart(polarData);
}


// Fonctions de calcul pour les graphiques avanc√©s
function calculateRadarData(categoryStats) {
    const categories = Object.keys(categoryStats);
    return {
        labels: categories.map(cat => getCategoryLabel(cat)),
        datasets: [
            {
                label: 'Nombre de tables',
                data: categories.map(cat => categoryStats[cat].count),
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: '#3B82F6',
                borderWidth: 2,
                pointBackgroundColor: '#3B82F6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 10
            },
            {
                label: 'Taux d\'occupation (%)',
                data: categories.map(cat => {
                    const stats = categoryStats[cat];
                    return stats.totalCapacity > 0 ? 
                        Math.round((stats.occupiedSeats / stats.totalCapacity) * 100) : 0;
                }),
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                borderColor: '#8B5CF6',
                borderWidth: 2,
                pointBackgroundColor: '#8B5CF6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 10
            }
        ]
    };
}

function calculateLineData(tables) {
    // Simuler des donn√©es temporelles (pour la d√©mo)
    const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    const today = new Date().getDay();
    
    return {
        labels: days,
        datasets: [
            {
                label: 'Tables occup√©es',
                data: days.map((_, index) => {
                    const dayIndex = (today + index) % 7;
                    const base = Math.floor(tables.length * 0.6);
                    const variation = Math.sin(dayIndex * 0.9) * 10;
                    return Math.max(0, Math.min(tables.length, Math.round(base + variation)));
                }),
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#10B981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            },
            {
                label: 'Tables disponibles',
                data: days.map((_, index) => {
                    const dayIndex = (today + index) % 7;
                    const base = Math.floor(tables.length * 0.4);
                    const variation = Math.cos(dayIndex * 0.9) * 10;
                    return Math.max(0, Math.min(tables.length, Math.round(base + variation)));
                }),
                borderColor: '#F59E0B',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#F59E0B',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }
        ]
    };
}

function calculateBubbleData(tables) {
    return tables.map(table => {
        const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        const occupancyRate = table.capacity > 0 ? 
            (totalSeats / table.capacity) * 100 : 0;
        
        // D√©terminer la cat√©gorie pour la couleur
        let color;
        switch(table.category) {
            case 'vip': color = '#F59E0B'; break;
            case 'family': color = '#8B5CF6'; break;
            case 'speaker': color = '#3B82F6'; break;
            case 'organizer': color = '#10B981'; break;
            default: color = '#D97706';
        }
        
        return {
            x: table.capacity || 0, // Capacit√©
            y: totalSeats, // Places occup√©es
            r: Math.max(10, (table.capacity || 0) * 2), // Taille selon capacit√©
            backgroundColor: color,
            tableNumber: table.tableNumber,
            tableName: table.tableName,
            category: table.category
        };
    });
}

function calculatePolarData(categoryStats) {
    const categories = Object.keys(categoryStats);
    const colors = {
        'vip': '#F59E0B',
        'family': '#8B5CF6',
        'speaker': '#3B82F6',
        'organizer': '#10B981',
        'standard': '#D97706'
    };
    
    return {
        labels: categories.map(cat => getCategoryLabel(cat)),
        datasets: [{
            label: 'Performance',
            data: categories.map(cat => {
                const stats = categoryStats[cat];
                // Score composite: nombre de tables + taux d'occupation
                const countScore = Math.min(stats.count * 10, 100);
                const occupancyScore = stats.totalCapacity > 0 ? 
                    Math.round((stats.occupiedSeats / stats.totalCapacity) * 100) : 0;
                return (countScore + occupancyScore) / 2;
            }),
            backgroundColor: categories.map(cat => colors[cat] + '80'),
            borderColor: categories.map(cat => colors[cat]),
            borderWidth: 2
        }]
    };
}

function calculateKPIs(tables, categoryStats) {
    // Calculer la tendance
    const totalOccupied = tables.reduce((sum, table) => {
        return sum + (table.assignedGuests?.reduce((s, g) => s + (g.seats || 1), 0) || 0);
    }, 0);
    
    const totalCapacity = tables.reduce((sum, table) => sum + (table.capacity || 0), 0);
    const currentRate = totalCapacity > 0 ? Math.round((totalOccupied / totalCapacity) * 100) : 0;
    
    // Simuler une tendance (pour la d√©mo)
    const trend = currentRate > 60 ? Math.min(25, Math.round((currentRate - 60) * 0.5)) : 
                  Math.max(-10, Math.round((currentRate - 40) * 0.3));
    
    // Calculer l'efficacit√© d'assignation
    const assignedTables = tables.filter(t => 
        t.assignedGuests && t.assignedGuests.length > 0
    ).length;
    const efficiency = tables.length > 0 ? 
        Math.round((assignedTables / tables.length) * 100) : 0;
    
    // Calculer la diversit√©
    const categories = Object.keys(categoryStats).length;
    const maxCategories = 7; // Nombre maximum de cat√©gories possibles
    const diversity = Math.round((categories / maxCategories) * 100);
    
    // Calculer la pr√©diction de satisfaction
    const avgOccupancy = currentRate;
    const tableUtilization = efficiency;
    const prediction = Math.round((avgOccupancy * 0.6 + tableUtilization * 0.4) * 0.9);
    
    return {
        trend: trend > 0 ? `+${trend}%` : `${trend}%`,
        efficiency,
        diversity,
        prediction
    };
}


// Fonction pour d√©terminer la plage de capacit√©
function getCapacityRange(capacity) {
    if (capacity <= 2) return '2 places';
    if (capacity <= 4) return '3-4 places';
    if (capacity <= 6) return '5-6 places';
    if (capacity <= 8) return '7-8 places';
    if (capacity <= 10) return '9-10 places';
    return '11+ places';
}

// Fonction pour rendre le graphique des cat√©gories
function renderCategoryChart(categoryStats) {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    // D√©truire le graphique existant s'il y en a un
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    // Si aucune donn√©e, afficher un message
    if (Object.keys(categoryStats).length === 0) {
        ctx.innerHTML = `
            <div style="padding: 40px 20px; text-align: center; color: var(--text-color); opacity: 0.5;">
                <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <p>Aucune donn√©e disponible</p>
            </div>
        `;
        return;
    }
    
    // Pr√©parer les donn√©es
    const categories = Object.keys(categoryStats);
    const colors = {
        'vip': '#F59E0B',
        'family': '#8B5CF6',
        'speaker': '#3B82F6',
        'organizer': '#10B981',
        'standard': '#D97706',
        'mariage': '#EC4899',
        'anniversaire': '#6366F1'
    };
    
    const backgroundColors = categories.map(cat => colors[cat] || '#6B7280');
    
    // Cr√©er le graphique
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    canvas.width = ctx.clientWidth;
    canvas.height = 300;
    
    ctx.chart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: categories.map(cat => getCategoryLabel(cat)),
            datasets: [{
                data: categories.map(cat => categoryStats[cat].count),
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color + '80'),
                borderWidth: 2,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'var(--text-color-chart) !important',
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const category = categories[context.dataIndex];
                            const stats = categoryStats[category];
                            const occupancy = stats.totalCapacity > 0 ? 
                                Math.round((stats.occupiedSeats / stats.totalCapacity) * 100) : 0;
                            return [
                                `Tables: ${stats.count}`,
                                `Capacit√© totale: ${stats.totalCapacity} places`,
                                `Taux d'occupation: ${occupancy}%`
                            ];
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
}

// Fonction pour rendre le graphique des capacit√©s
function renderCapacityChart(capacityDistribution) {
    const ctx = document.getElementById('capacityChart');
    if (!ctx) return;
    
    // D√©truire le graphique existant s'il y en a un
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    // Si aucune donn√©e, afficher un message
    if (Object.keys(capacityDistribution).length === 0) {
        ctx.innerHTML = `
            <div style="padding: 40px 20px; text-align: center; color: var(--text-color); opacity: 0.5;">
                <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <p>Aucune donn√©e disponible</p>
            </div>
        `;
        return;
    }
    
    // Pr√©parer les donn√©es
    const ranges = Object.keys(capacityDistribution).sort((a, b) => {
        // Trier par capacit√© croissante
        const getMin = range => parseInt(range.split('-')[0]) || parseInt(range);
        return getMin(a) - getMin(b);
    });
    const counts = ranges.map(range => capacityDistribution[range]);
    
    // Couleurs d√©grad√©es
    const baseColor = [217, 119, 6]; // Couleur primaire en RGB
    const backgroundColors = counts.map((_, index) => {
        const alpha = 0.7 + (index * 0.05);
        return `rgba(${baseColor[0]}, ${baseColor[1]}, ${baseColor[2]}, ${alpha})`;
    });
    
    // Cr√©er le graphique
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    canvas.width = ctx.clientWidth;
    canvas.height = 300;
    
    ctx.chart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: ranges,
            datasets: [{
                label: 'Nombre de tables',
                data: counts,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                borderWidth: 2,
                borderRadius: 8,
                hoverBackgroundColor: backgroundColors.map(color => color.replace('0.7', '0.9'))
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'var(--text-color-chart)',
                        precision: 0
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'var(--text-color)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Tables: ${context.raw}`;
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
}

// Fonctions de rendu des graphiques avanc√©s
function renderRadarChart(radarData) {
    const ctx = document.getElementById('radarChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    if (!radarData.labels || radarData.labels.length === 0) {
        ctx.innerHTML = '<div class="no-data">Aucune donn√©e disponible</div>';
        return;
    }
    
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    
    ctx.chart = new Chart(canvas, {
        type: 'radar',
        data: radarData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    pointLabels: {
                        color: 'var(--text-color-chart)',
                        font: {
                            size: 12
                        }
                    },
                    ticks: {
                        color: 'var(--text-color-chart)',
                        backdropColor: 'transparent'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'var(--text-color-chart)',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}`;
                        }
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        }
    });
}

function renderLineChart(lineData) {
    const ctx = document.getElementById('lineChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    
    ctx.chart = new Chart(canvas, {
        type: 'line',
        data: lineData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color)'
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color-chart)',
                        callback: function(value) {
                            return Math.round(value);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'var(--text-color-chart)',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${Math.round(context.parsed.y)} tables`;
                        }
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });
}

function renderBubbleChart(bubbleData) {
    const ctx = document.getElementById('bubbleChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    if (bubbleData.length === 0) {
        ctx.innerHTML = '<div class="no-data">Aucune donn√©e disponible</div>';
        return;
    }
    
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    
    // Regrouper par couleur pour les datasets
    const datasetsByColor = {};
    bubbleData.forEach(bubble => {
        if (!datasetsByColor[bubble.backgroundColor]) {
            datasetsByColor[bubble.backgroundColor] = {
                label: getCategoryLabel(bubble.category) || 'Standard',
                data: [],
                backgroundColor: bubble.backgroundColor,
                borderColor: bubble.backgroundColor.replace('80', 'FF'),
                borderWidth: 1
            };
        }
        datasetsByColor[bubble.backgroundColor].data.push({
            x: bubble.x,
            y: bubble.y,
            r: bubble.r
        });
    });
    
    ctx.chart = new Chart(canvas, {
        type: 'bubble',
        data: {
            datasets: Object.values(datasetsByColor)
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Capacit√©',
                        color: 'var(--text-color)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Places occup√©es',
                        color: 'var(--text-color)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'var(--text-color-chart)',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const bubble = bubbleData.find(b => 
                                b.x === context.parsed.x && 
                                b.y === context.parsed.y
                            );
                            if (bubble) {
                                return [
                                    `Table: #${bubble.tableNumber}`,
                                    `Nom: ${bubble.tableName || 'Sans nom'}`,
                                    `Cat√©gorie: ${getCategoryLabel(bubble.category)}`,
                                    `Capacit√©: ${bubble.x} places`,
                                    `Occup√©: ${bubble.y} places`
                                ];
                            }
                            return `Capacit√©: ${context.parsed.x}, Occup√©: ${context.parsed.y}`;
                        }
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        }
    });
}

function renderPolarChart(polarData) {
    const ctx = document.getElementById('polarChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    if (!polarData.labels || polarData.labels.length === 0) {
        ctx.innerHTML = '<div class="no-data">Aucune donn√©e disponible</div>';
        return;
    }
    
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    
    ctx.chart = new Chart(canvas, {
        type: 'polarArea',
        data: polarData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color-chart)',
                        backdropColor: 'transparent'
                    },
                    pointLabels: {
                        color: 'var(--text-color)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'var(--text-color-chart)',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: Score ${Math.round(context.raw)}`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });
}


function destroyCharts() {
    const categoryChart = document.getElementById('categoryChart');
    const capacityChart = document.getElementById('capacityChart');
    const radarChart = document.getElementById('radarChart');
    const lineChart = document.getElementById('lineChart');
    const bubbleChart = document.getElementById('bubbleChart');
    const polarChart = document.getElementById('polarChart');
    
     const charts = [
        categoryChart, capacityChart, radarChart, 
        lineChart, bubbleChart, polarChart
    ];
    
    charts.forEach(chart => {
        if (chart && chart.chart) {
            chart.chart.destroy();
            chart.chart = null;
        }
    });
}




        // Rendre les tables
        function renderTables() {
            const startIndex = (currentPage - 1) * tablesPerPage;
            const endIndex = startIndex + tablesPerPage;
            const tablesToShow = filteredTables.slice(startIndex, endIndex);
            
            // Afficher/masquer l'√©tat vide
            const emptyStates = ['grid', 'table', 'visual', 'stats','vector'];
            emptyStates.forEach(view => {
                const emptyState = document.getElementById(`emptyState${view.charAt(0).toUpperCase() + view.slice(1)}`);
                if (emptyState) {
                    emptyState.style.display = filteredTables.length === 0 ? 'flex' : 'none';
                }
            });
            
            hideLoader('all');
    
            // Mettre √† jour la pagination
            updatePagination();
            
            // Mode grille
            if (currentView === 'grid') {
                renderGridView(tablesToShow);
            } else if (currentView === 'table') {
                renderTableView(tablesToShow);
            } else if (currentView === 'visual') {
                renderVisualView(tablesToShow);
            }else if (currentView === 'vector') {
                renderVectorView(tablesToShow);
            } else if (currentView === 'stats') {
                setTimeout(() => {
                    updateAdvancedStats();
                }, 100);
            }

            setTimeout(() => updateViewHeader(currentView), 10);
        }

        // Rendre la vue grille avec aper√ßu am√©lior√©
        // Fonctions pour les images de fond des tables


        const fallbackImages = [
    'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?w=800&q=80', // Restaurant chic
    'https://images.unsplash.com/photo-1554679665-f5537f187268?w=800&q=80', // Salle de r√©ception
    'https://images.unsplash.com/photo-1519167758481-83f550bb49b3?w=800&q=80', // Mariage
    'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=800&q=80', // Anniversaire
    'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=800&q=80', // Conf√©rence
    'https://images.unsplash.com/photo-1511578314322-379afb476865?w=800&q=80', // Gala
    'https://images.unsplash.com/photo-1492684223066-e9e4aab4d25e?w=800&q=80', // Cocktail
    'https://images.unsplash.com/photo-1555244162-803834f70033?w=800&q=80'  // D√Æner √©l√©gant
];


function getTableBackgroundImage(table) {
    const category = (table.category || 'standard').toLowerCase();
    const tableIndex = allTables.findIndex(t => t.id === table.id);
    const isFull = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) >= (table.capacity || 0);
    const isEmpty = !table.assignedGuests || table.assignedGuests.length === 0;
    
    // Images prestigieuses selon la cat√©gorie
    const backgroundImages = {
        'vip': 'https://images.unsplash.com/photo-1519167758481-83f550bb49b3?w=800&q=80',
        'family': 'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=800&q=80',
        'speaker': 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=800&q=80',
        'organizer': 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=800&q=80',
        'mariage': 'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?w=800&q=80',
        'anniversaire': 'https://images.unsplash.com/photo-1530103862676-de8c9debad1d?w=800&q=80',
        'standard': 'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?w=800&q=80'
    };
    
    return backgroundImages[category] || backgroundImages.standard || fallbackImages[tableIndex % fallbackImages.length];
}

// Fonction pour obtenir les couleurs selon la cat√©gorie
function getCategoryColor(category) {
    const colors = {
        'vip': '#F59E0B',
        'family': '#8B5CF6',
        'speaker': '#3B82F6',
        'organizer': '#10B981',
        'standard': '#D97706',
        'mariage': '#EC4899',
        'anniversaire': '#6366F1'
    };
    
    return colors[category] || colors.standard;
}

// Fonction pour afficher le statut
function getTableStatus(table) {
    const totalSeats = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) || 0;
    const capacity = table.capacity || 0;
    
    if (totalSeats >= capacity) return 'full';
    if (totalSeats === 0) return 'empty';
    return 'available';
}

// Rendre la vue grille avec le nouveau design
function renderGridView(tables) {
    const grid = document.getElementById('tablesGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    tables.forEach(table => {
        const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        const availableSeats = Math.max(0, (table.capacity || 0) - totalSeats);
        const occupancyRate = table.capacity > 0 ? 
            Math.round((totalSeats / table.capacity) * 100) : 0;
        const status = getTableStatus(table);
        
        // Grouper les invit√©s par si√®ge
        const guestGroups = {};
        table.assignedGuests?.forEach(guest => {
            const seats = guest.seats || 1;
            if (!guestGroups[seats]) guestGroups[seats] = [];
            guestGroups[seats].push(guest);
        });
        
        // Cr√©er les indicateurs de si√®ge avec carr√©s
        let seatSquares = '';
        let seatIndex = 0;

        // Trier les groupes par nombre de si√®ges
        Object.keys(guestGroups).sort((a, b) => b - a).forEach(seats => {
            const groupSize = parseInt(seats);
            const group = guestGroups[seats];
            
            group.forEach(guest => {
                for (let i = 0; i < groupSize && seatIndex < (table.capacity || 0); i++) {
                    const isFirst = i === 0;
                    
                    seatSquares += `
                        <div class="seat-square occupied ${groupSize > 1 ? 'group' : ''}" 
                            data-group="${isFirst ? groupSize : ''}"
                            title="${isFirst ? guest.guestName + ' (' + groupSize + ' places)' : 'Place occup√©e'}"
                            style="${isFirst ? 'border-color: ' + getCategoryColor(table.category) + ';' : ''}">
                            ${isFirst ? getInitials(guest.guestName) : ''}
                        </div>
                    `;
                    seatIndex++;
                }
            });
        });

        // Ajouter les si√®ges disponibles
        for (let i = seatIndex; i < (table.capacity || 0); i++) {
            seatSquares += `<div class="seat-square available" title="Place disponible"></div>`;
        }
                
        const tableCard = document.createElement('div');
        tableCard.className = `table-card ${status}`;
        tableCard.dataset.category = table.category || 'standard';
        tableCard.dataset.tableId = table.id;
        tableCard.onclick = (e) => {
            if (e.target.closest('.table-card-toggle') || 
                e.target.closest('.table-actions') || 
                e.target.closest('.guests-toggle-btn') ||
                e.target.closest('.add-guest-btn') ||
                e.target.closest('.action-btn')) {
                return;
            }
            showEnhancedTableDetails(table);
        };
        
        tableCard.innerHTML = `
            <!-- Image de fond -->
            <div class="table-card-image" 
                 style="background-image: url('${getTableBackgroundImage(table)}')"></div>
            
            <!-- En-t√™te toujours visible -->
            <div class="table-card-header">
                <!-- Bouton de toggle pour d√©rouler le contenu -->
                <button class="table-card-toggle" onclick="toggleTableCardContent(this)" 
                        style="position: absolute; top: 15px; right: 15px; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.3s ease;">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <!-- Info principale toujours visible -->
                <div class="table-card-main-info">
                    <div class="table-number">${escapeHtml(table.tableNumber)}</div>
                    ${table.tableName ? `<div class="table-name">${escapeHtml(table.tableName)}</div>` : ''}
                    <div class="table-meta">
                        <div class="table-category">
                            <i class="fas fa-tag"></i>
                            ${escapeHtml(getCategoryLabel(table.category || 'standard'))}
                        </div>
                        <div class="table-status status-${status}">
                            <i class="fas ${status === 'full' ? 'fa-ban' : status === 'empty' ? 'fa-circle' : 'fa-check-circle'}"></i>
                            <span>${status === 'full' ? 'Compl√®te' : status === 'empty' ? 'Vide' : `${availableSeats} libres`}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contenu (cach√© par d√©faut) -->
            <div class="table-card-content">
                <!-- Indicateur de capacit√© -->
                <div class="capacity-indicator">
                    <div class="capacity-header">
                        <div class="capacity-label">
                            <i class="fas fa-chart-pie"></i>
                            Taux d'occupation
                        </div>
                        <div class="capacity-percentage">${occupancyRate}%</div>
                    </div>
                    <div class="capacity-visual-grid">
                        ${seatSquares}
                    </div>
                    <div class="capacity-stats">
                        <span>${totalSeats} occup√©e(s)</span>
                        <span>${availableSeats} disponible(s)</span>
                    </div>
                </div>
                
                <!-- Liste des invit√©s -->
                <div class="table-guests">
                    <button class="guests-toggle-btn" onclick="event.stopPropagation(); toggleGuestsList('${table.id}')">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                <i class="fas fa-users"></i>
                                <span>Invit√©s (${table.assignedGuests?.length || 0})</span>
                            </div>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                    </button>
                    
                    <div class="guests-list-container" id="guests-list-${table.id}" style="display: none;">
                        ${table.assignedGuests && table.assignedGuests.length > 0 ? `
                            <div class="guests-list">
                                ${renderGuestList(table.assignedGuests, table.id)}
                            </div>
                        ` : `
                            <div class="no-guests">
                                <i class="fas fa-user-plus"></i>
                                <p>Aucun invit√© assign√©</p>
                            </div>
                        `}
                        
                        ${availableSeats > 0 ? `
                            <button class="add-guest-btn" onclick="event.stopPropagation(); addGuestToTable('${table.id}')">
                                <i class="fas fa-user-plus"></i>
                                Ajouter un invit√©
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <!-- Pied de carte (cach√© par d√©faut) -->
            <div class="table-card-footer">
                ${table.location ? `
                    <div class="table-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${escapeHtml(table.location)}</span>
                    </div>
                ` : `<div></div>`}
                
                <div class="table-actions" onclick="event.stopPropagation()">
                    <button class="action-btn edit" 
                            data-tooltip="Modifier"
                            onclick="event.stopPropagation(); openEditTableModal('${table.id}')">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="action-btn qr" 
                            data-tooltip="QR Code"
                            onclick="event.stopPropagation(); generateTableQR('${table.id}')">
                        <i class="bi bi-qr-code"></i>
                    </button>
                    <button class="action-btn delete" 
                            data-tooltip="Supprimer"
                            onclick="event.stopPropagation(); deleteTable('${table.id}')">
                        <i class="bi bi-trash3"></i>
                    </button>
                </div>
            </div>
        `;
        
        grid.appendChild(tableCard);
    });
    
    initializeGuestInteractions();
}

window.toggleTableCardContent = function(toggleBtn) {
    const tableCard = toggleBtn.closest('.table-card');
    const content = tableCard.querySelector('.table-card-content');
    const footer = tableCard.querySelector('.table-card-footer');
    const icon = toggleBtn.querySelector('i');
    
    const isActive = tableCard.classList.contains('active');
    
    if (!isActive) {
        // Ouvrir cette carte
        tableCard.classList.add('active');
        content.style.display = 'flex';
        footer.style.display = 'flex';
        icon.className = 'fas fa-chevron-up';
        toggleBtn.style.background = 'var(--primary)';
        toggleBtn.style.borderColor = 'var(--primary)';
    } else {
        tableCard.classList.remove('active');
        content.style.display = 'none';
        footer.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
        toggleBtn.style.background = 'rgba(255,255,255,0.2)';
        toggleBtn.style.borderColor = 'rgba(255,255,255,0.3)';
    }
};


// Fonction pour basculer l'affichage de la liste des invit√©s
window.toggleGuestsList = function(tableId) {
    const listContainer = document.getElementById(`guests-list-${tableId}`);
    const toggleBtn = document.querySelector(`button[onclick*="toggleGuestsList('${tableId}')"]`);
    
    if (listContainer) {
        if (listContainer.style.display === 'none') {
            listContainer.style.display = 'block';
            if (toggleBtn) toggleBtn.classList.add('expanded');
        } else {
            listContainer.style.display = 'none';
            if (toggleBtn) toggleBtn.classList.remove('expanded');
        }
    }
};

// Fonction pour rendre la liste des invit√©s avec syst√®me d'expansion
function renderGuestList(guests, tableId) {
    return guests.map((guest, index) => `
        <div class="guest-item " id="guest-${tableId}-${guest.guestId}" data-guest-id="${guest.guestId}">
            <div class="guest-item-header" onclick="toggleGuestDetails('${tableId}', '${guest.guestId}', event)">
                <div class="guest-avatar  ${guest.isVip ? 'vip' : ''}">
                    ${getInitials(guest.guestName)}
                </div>
                <div class="guest-info" style="justify-content:space-between;">
                    <div class="guest-name">${escapeHtml(guest.guestName)}</div>
                    <div class="guest-meta">
                        <div class="guest-seats">
                            <i class="fas fa-chair"></i>
                            ${guest.seats || 1} place(s)
                        </div>
                        
                    </div>
                </div>
                <button class="guest-expand-btn">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="guest-details" style="display: none;">
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${guest.email || 'Non renseign√©'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">T√©l√©phone</div>
                        <div class="detail-value">${guest.phone || 'Non renseign√©'}</div>
                    </div>
                    


                    <div class="detail-item">
                        <div class="detail-label">Assign√© le</div>
                        <div class="detail-value">${guest.assignedAt ? new Date(guest.assignedAt).toLocaleDateString('fr-FR') : 'Non d√©fini'}</div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label status-confirmed">Status</div>
                        <div class="detail-value">
                            ${guest.confirmed ? 'Confirm√©' : 'En attente'}</div>
                    </div>
                </div>
                <div class="guest-actions">
                    <button class="action-btn-sm move" onclick="event.stopPropagation(); moveGuestToAnotherTable('${guest.guestId}', '${tableId}')">
                        <i class="fas fa-exchange-alt"></i>
                        D√©placer
                    </button>
                    <button class="action-btn-sm qr" onclick="event.stopPropagation(); viewGuestQR('${guest.guestId}')">
                        <i class="bi bi-qr-code"></i>
                        QR
                    </button>
                    <button class="action-btn-sm remove" onclick="event.stopPropagation(); removeGuestFromTable('${tableId}', '${guest.guestId}')">
                        <i class="bi bi-trash3"></i>
                        Retirer
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}
function getTableBackgroundImage(table) {
    const category = (table.category || 'standard').toLowerCase();
    const tableIndex = allTables.findIndex(t => t.id === table.id);
    const isFull = table.assignedGuest



// Fonction pour initialiser les interactions des invit√©s
function initializeGuestInteractions() {
    // Les √©couteurs sont ajout√©s dans la fonction toggleGuestDetails
}

// Fonction pour basculer l'affichage des d√©tails d'un invit√©
function toggleGuestDetails(tableId, guestId, event) {
    event.stopPropagation();
    
    // Fermer tous les d√©tails ouverts
    document.querySelectorAll('.guest-item.expanded').forEach(item => {
        if (!item.id.includes(`${tableId}-${guestId}`)) {
            item.classList.remove('expanded');
            const details = item.querySelector('.guest-details');
            const btn = item.querySelector('.guest-expand-btn');
            if (details) details.style.display = 'none';
            if (btn) {
                btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                btn.classList.remove('expanded');
            }
        }
    });
    
    const guestItem = document.getElementById(`guest-${tableId}-${guestId}`);
    const details = guestItem.querySelector('.guest-details');
    const btn = guestItem.querySelector('.guest-expand-btn');
    
    if (details.style.display === 'none') {
      
        guestItem.classList.add('expanded');
        details.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        btn.classList.add('expanded');
    } else {
        guestItem.classList.remove('expanded');
        details.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        btn.classList.remove('expanded');
    }
}




        

        // Initialiser les √©couteurs du modal de cr√©ation
        function initCreationModalListeners() {
            // Options de cr√©ation
            document.getElementById('singleTableOption').addEventListener('click', () => {
                selectCreationMode('single');
            });
            
            document.getElementById('multipleTablesOption').addEventListener('click', () => {
                selectCreationMode('multiple');
            });
            
            // Table rapide
            document.getElementById('quickTableBtn').addEventListener('click', createQuickTable);
            
            // Navigation
            document.getElementById('cancelCreationBtn').addEventListener('click', closeTableCreationModal);
            document.getElementById('closeTableModalBtn').addEventListener('click', closeTableCreationModal);
            document.getElementById('nextToStep2').addEventListener('click', () => goToCreationStep(2));
            document.getElementById('nextToStep3').addEventListener('click', () => goToCreationStep(3));
            document.getElementById('nextToStep4').addEventListener('click', () => goToCreationStep(4));
            document.getElementById('nextToStep5').addEventListener('click', () => goToCreationStep(5));
            
            document.getElementById('backToStep1').addEventListener('click', () => goToCreationStep(1));
            document.getElementById('backToStep2').addEventListener('click', () => goToCreationStep(2));
            document.getElementById('backToStep3').addEventListener('click', () => goToCreationStep(3));
            document.getElementById('backToStep4').addEventListener('click', () => goToCreationStep(4));
            
            // Ajouter une autre table (mode multiple)
            document.getElementById('addAnotherTableBtn').addEventListener('click', addAnotherTable);
            
            // Dupliquer les param√®tres
            document.getElementById('duplicateSettingsBtn').addEventListener('click', duplicateTableSettings);
            
            // Actualiser l'aper√ßu
            document.getElementById('refreshPreviewBtn')?.addEventListener('click', updateTablePreview);
            
            
            // Auto-assignation dans le modal
            document.getElementById('autoAssignCreationBtn').addEventListener('click', autoAssignInCreation);
            
            // Soumission finale
            document.getElementById('submitTablesCreation').addEventListener('click', submitTablesCreation);
            
            // Recherche d'invit√©s
            const searchGuestsInput = document.getElementById('searchGuestsCreation');
            let searchGuestsTimeout;
            searchGuestsInput?.addEventListener('input', function() {
                clearTimeout(searchGuestsTimeout);
                searchGuestsTimeout = setTimeout(() => {
                    filterAvailableGuests(this.value);
                }, 300);
            });
        }

        // S√©lectionner le mode de cr√©ation
        function selectCreationMode(mode) {
            creationMode = mode;
            
            // Mettre en √©vidence l'option s√©lectionn√©e
            document.querySelectorAll('.creation-option').forEach(option => {
                option.style.borderColor = 'var(--border-color)';
                option.style.transform = 'none';
            });
            
            if (mode === 'single') {
                document.getElementById('singleTableOption').style.borderColor = 'var(--primary)';
                document.getElementById('singleTableOption').style.transform = 'translateY(-5px)';
                document.getElementById('step2Subtitle').textContent = 'D√©finissez les informations de votre table';
            } else {
                document.getElementById('multipleTablesOption').style.borderColor = 'var(--info)';
                document.getElementById('multipleTablesOption').style.transform = 'translateY(-5px)';
                document.getElementById('step2Subtitle').textContent = 'D√©finissez les informations des tables √† cr√©er';
            }
            
            // Afficher le bouton suivant
            document.getElementById('nextToStep2').style.display = 'flex';
        }

        // Ouvrir le modal de cr√©ation
function openTableCreationModal(tableId = null) {
    creationStep = 1;
    creationMode = 'single';
    multipleTablesData = [];
    selectedGuests = [];
    editingTableId = null;
    isEditMode = false;
    
    // R√©initialiser l'interface
    document.querySelectorAll('.creation-option').forEach(option => {
        option.style.borderColor = 'var(--border-color)';
        option.style.transform = 'none';
    });
    
    document.getElementById('nextToStep2').style.display = 'none';
    document.getElementById('singleTableForm').style.display = 'none';
    document.getElementById('multipleTablesForm').style.display = 'none';
    document.getElementById('singleTableConfig').style.display = 'none';
    document.getElementById('multipleTablesConfig').style.display = 'none';
    document.getElementById('tablePreviewCard').style.display = 'none';
    
    // R√©initialiser les √©tapes
    document.querySelectorAll('.vertical-step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    document.querySelector('.vertical-step[data-step="1"]').classList.add('active');
    goToCreationStep(1);
    
    // Mettre √† jour le titre (CR√âATION par d√©faut)
    const progressTitle = document.getElementById('progressTitle');
    if (progressTitle) {
        progressTitle.textContent = 'CR√âATION DE TABLE(S)';
    }
    
    const submitBtn = document.getElementById('submitTablesCreation');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Cr√©er les tables';
    }
    
    // Afficher le modal
    document.getElementById('tableCreationModal').classList.add('active');
    updateCreationProgress();
}


// Fonction s√©par√©e pour ouvrir en mode √©dition
async function openEditTableModal(tableId) {
    try {
        const table = allTables.find(t => t.id === tableId);
        if (!table) {
            Toastify({
                text: "Table introuvable",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--danger)"
            }).showToast();
            return;
        }
        
        // R√©initialiser les donn√©es
        creationStep = 1;
        creationMode = 'single';
        multipleTablesData = [];
        selectedGuests = [];
        editingTableId = tableId;
        isEditMode = true;
        
        // R√©initialiser l'interface
        document.querySelectorAll('.creation-option').forEach(option => {
            option.style.borderColor = 'var(--border-color)';
            option.style.transform = 'none';
        });
        
        document.getElementById('nextToStep2').style.display = 'none';
        document.getElementById('singleTableForm').style.display = 'none';
        document.getElementById('multipleTablesForm').style.display = 'none';
        document.getElementById('singleTableConfig').style.display = 'none';
        document.getElementById('multipleTablesConfig').style.display = 'none';
        document.getElementById('tablePreviewCard').style.display = 'none';
        
        // R√©initialiser les √©tapes
        document.querySelectorAll('.vertical-step').forEach(step => {
            step.classList.remove('active', 'completed');
        });
        document.querySelector('.vertical-step[data-step="1"]').classList.add('active');
        
        // Mettre √† jour le titre et les boutons
        const progressTitle = document.getElementById('progressTitle');
        const submitBtn = document.getElementById('submitTablesCreation');
        
        if (progressTitle) {
            progressTitle.textContent = 'MODIFICATION DE TABLE';
        }
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
        }
        
        // Afficher le modal
        document.getElementById('tableCreationModal').classList.add('active');
        updateCreationProgress();
        
        // Charger les donn√©es de la table
        await loadTableForEdit(tableId);
        
        // Aller directement √† l'√©tape 2 (sauter le choix du type)
        selectCreationMode('single');
        setTimeout(() => goToCreationStep(2), 100);
        
    } catch (error) {
        console.error('Erreur ouverture √©dition:', error);
        Toastify({
            text: "Erreur lors du chargement de la table",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--danger)"
        }).showToast();
    }
}

async function loadTableForEdit(tableId) {
    try {
        const table = allTables.find(t => t.id === tableId);
        if (!table) return;
        
        // Afficher le message/display selon le mode
        const codeInfoMessage = document.getElementById('codeInfoMessage');
        const codeDisplayContainer = document.getElementById('codeDisplayContainer');
        const codeHelpText = document.getElementById('codeHelpText');
        
        if (codeInfoMessage && codeDisplayContainer && codeHelpText) {
            // Cacher le message de cr√©ation
            codeInfoMessage.style.display = 'none';
            
            // Afficher le display d'√©dition avec le code existant
            codeDisplayContainer.style.display = 'block';
            codeDisplayContainer.textContent = table.tableNumber || '--';
            
            // Mettre √† jour le texte d'aide
            codeHelpText.textContent = 'Code existant (non modifiable)';
        }
        
        // Remplir le formulaire avec les donn√©es existantes
        document.getElementById('singleTableName').value = table.tableName || '';
        document.getElementById('singleTableCapacity').value = table.capacity || 8;
        
        // Mettre √† jour le titre et sous-titre
        const step2Title = document.getElementById('step2Title');
        const step2Subtitle = document.getElementById('step2Subtitle');
        if (step2Title) {
            step2Title.textContent = `Modification de la table`;
        }
        if (step2Subtitle) {
            step2Subtitle.textContent = `Modifiez les informations de la table #${table.tableNumber}`;
        }
        
        // Initialiser les boutons de capacit√©
        setTimeout(() => {
            initCapacityButtons();
            highlightCurrentCapacity(table.capacity || 8);
        }, 100);
        
        // Stocker les donn√©es pour les √©tapes suivantes
        multipleTablesData = [{
            tableNumber: table.tableNumber, // Conserver le code existant
            tableName: table.tableName || '',
            capacity: table.capacity || 8,
            location: table.location || '',
            category: table.category || 'standard',
            description: table.description || ''
        }];
        
        // Charger les invit√©s assign√©s pour l'√©tape 4
        if (table.assignedGuests && table.assignedGuests.length > 0) {
            const guests = await storage.getAllGuests({ eventId: currentEvent.id });
            selectedGuests = guests.filter(g => 
                table.assignedGuests.some(ag => ag.guestId === g.id)
            );
        }
        
    } catch (error) {
        console.error('Erreur chargement table pour √©dition:', error);
        Toastify({
            text: "Erreur lors du chargement de la table",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--danger)"
        }).showToast();
    }
}

        // Fermer le modal de cr√©ation
        function closeTableCreationModal() {
            document.getElementById('tableCreationModal').classList.remove('active');
        }

        // Aller √† une √©tape de cr√©ation
        async function goToCreationStep(step) {

                if (isEditMode && step === 1) {
                    return;
                }

                if (step > creationStep) {
                const isValid = await validateCurrentCreationStep();
                if (!isValid) return;
            }
            
            creationStep = step;
            
            // Mettre √† jour les indicateurs de progression
            document.querySelectorAll('.vertical-step').forEach(stepEl => {
                const stepNum = parseInt(stepEl.dataset.step);
                stepEl.classList.remove('active', 'completed');
                
                if (stepNum < step) {
                    stepEl.classList.add('completed');
                } else if (stepNum === step) {
                    stepEl.classList.add('active');
                }
            });
            
            // Mettre √† jour le contenu
            document.querySelectorAll('.creation-step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`creationStep${step}`).classList.add('active');
            
            // Configurer l'interface selon l'√©tape
            switch(step) {
                case 2:
                    setupStep2();
                    break;
                case 3:
                    setupStep3();
                    break;
                case 4:
                    await setupStep4();
                    break;
                case 5:
                    setupStep5();
                    break;
            }
            
            updateCreationProgress();
        }

        // Valider l'√©tape actuelle de cr√©ation
        async function validateCurrentCreationStep() {
    switch(creationStep) {
        case 1:
            if (!creationMode) {
                Swal.fire({
                    icon: 'error',
                    title: 'S√©lection requise',
                    text: 'Veuillez s√©lectionner un mode de cr√©ation',
                    confirmButtonColor: '#D97706'
                });
                return false;
            }
            break;
            
        case 2:
            if (creationMode === 'single') {
                const tableName = document.getElementById('singleTableName').value.trim();
                const capacity = parseInt(document.getElementById('singleTableCapacity').value);
                
                // Validation du nom
                if (!tableName) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Nom manquant',
                        text: 'Veuillez saisir un nom pour la table',
                        confirmButtonColor: '#D97706'
                    });
                    return false;
                }
                
                // Validation de la capacit√©
                if (isNaN(capacity) || capacity < 1 || capacity > 50) {
                    showValidation('singleCapacityValidation', 'La capacit√© doit √™tre entre 1 et 50', false);
                    return false;
                }
                
                // Stocker les donn√©es
                if (!isEditMode) {
                    multipleTablesData = [{
                        tableNumber: '', // Vide, sera g√©n√©r√© par le backend
                        tableName: tableName,
                        capacity: capacity
                    }];
                } else {
                    const table = allTables.find(t => t.id === editingTableId);
                    if (table) {
                        multipleTablesData = [{
                            tableNumber: table.tableNumber, // Conserver le code existant
                            tableName: tableName || table.tableName,
                            capacity: capacity || table.capacity
                        }];
                    }
                }
                
            } else {
                // Validation mode multiple
                if (multipleTablesData.length === 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Tables requises',
                        text: 'Veuillez ajouter au moins une table',
                        confirmButtonColor: '#D97706'
                    });
                    return false;
                }
                
                for (let i = 0; i < multipleTablesData.length; i++) {
                    const table = multipleTablesData[i];
                    
                    // Validation du nom
                    if (!table.tableName || table.tableName.trim() === '') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Nom de table manquant',
                            text: `La table ${i + 1} n'a pas de nom`,
                            confirmButtonColor: '#D97706'
                        });
                        return false;
                    }
                    
                    // Validation de la capacit√©
                    if (isNaN(table.capacity) || table.capacity < 1 || table.capacity > 50) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Capacit√© invalide',
                            text: `La table ${i + 1} a une capacit√© invalide (entre 1 et 50)`,
                            confirmButtonColor: '#D97706'
                        });
                        return false;
                    }
                }
                
                // V√©rifier les noms en double pour la cr√©ation (pas pour l'√©dition)
                if (!isEditMode) {
                    const tableNames = multipleTablesData.map(t => t.tableName.toLowerCase());
                    const duplicates = tableNames.filter((name, index) => tableNames.indexOf(name) !== index);
                    
                    if (duplicates.length > 0) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Noms dupliqu√©s',
                            text: `Les noms suivants sont en double: ${Array.from(new Set(duplicates)).join(', ')}`,
                            confirmButtonColor: '#D97706'
                        });
                        return false;
                    }
                }
            }
            break;
            
        case 3:
            // R√©cup√©rer les donn√©es de configuration
            if (creationMode === 'single') {
                multipleTablesData[0].location = document.getElementById('singleTableLocation').value.trim();
                multipleTablesData[0].category = document.getElementById('singleTableCategory').value;
                multipleTablesData[0].description = document.getElementById('singleTableDescription').value.trim();
            } else {
                const location = document.getElementById('multipleTablesLocation').value.trim();
                const category = document.getElementById('multipleTablesCategory').value;
                const description = document.getElementById('multipleTablesDescription').value.trim();
                
                multipleTablesData = multipleTablesData.map(table => ({
                    ...table,
                    location,
                    category,
                    description
                }));
            }
            break;
            
        case 4:
            // Validation de la capacit√© pour les invit√©s (uniquement pour la cr√©ation simple)
            if (creationMode === 'single' && !isEditMode) {
               // const capacity = parseInt(document.getElementById('singleTableCapacity').value) || 8;
               // const totalSelectedSeats = selectedGuests.reduce((sum, guest) => 
                //    sum + (guest.seats || 1), 0);

                const capacity = getCurrentTableCapacity();
                const totalSelectedSeats = selectedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
                        
                if (totalSelectedSeats > capacity) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Capacit√© insuffisante',
                        html: `
                            <div style="text-align: center; padding: 20px 0;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning); margin-bottom: 15px;"></i>
                                <p>Vous avez s√©lectionn√© <strong>${totalSelectedSeats} places</strong></p>
                                <p>mais la capacit√© de la table est de <strong>${capacity} places</strong>.</p>
                                <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 10px;">
                                    Veuillez retirer ${totalSelectedSeats - capacity} place(s)
                                </p>
                            </div>
                        `,
                        confirmButtonColor: '#D97706'
                    });
                    return false;
                }
            }
            break;
    }
    
    return true;
}


// Configurer l'√©tape 2
function setupStep2() {
    if (creationMode === 'single') {
        document.getElementById('singleTableForm').style.display = 'block';
        document.getElementById('multipleTablesForm').style.display = 'none';
        
        const codeInfoMessage = document.getElementById('codeInfoMessage');
        const codeDisplayContainer = document.getElementById('codeDisplayContainer');
        const codeHelpText = document.getElementById('codeHelpText');
        
        if (codeInfoMessage && codeDisplayContainer && codeHelpText) {
            if (isEditMode) {
                // MODE √âDITION
                codeInfoMessage.style.display = 'none';
                codeDisplayContainer.style.display = 'block';
                codeHelpText.textContent = 'Code existant (non modifiable)';
                
                // Mettre √† jour le titre
                const step2Title = document.getElementById('step2Title');
                if (step2Title) {
                    step2Title.textContent = 'Modification de la table';
                }
            } else {
                // MODE CR√âATION
                codeInfoMessage.style.display = 'block';
                codeDisplayContainer.style.display = 'none';
                codeHelpText.textContent = 'Code automatiquement g√©n√©r√© par le syst√®me';
                
                // R√©initialiser les champs
                document.getElementById('singleTableName').value = '';
                document.getElementById('singleTableCapacity').value = '8';
                
                // Mettre √† jour le titre
                const step2Title = document.getElementById('step2Title');
                if (step2Title) {
                    step2Title.textContent = 'Informations de base';
                }
            }
        }

        // Ajouter les √©couteurs pour la mise √† jour en temps r√©el
        const tableNameInput = document.getElementById('singleTableName');
        const capacityInput = document.getElementById('singleTableCapacity');
        
        if (tableNameInput) {
            tableNameInput.addEventListener('input', function() {
                if (multipleTablesData[0]) {
                    multipleTablesData[0].tableName = this.value.trim();
                }
            });
        }
        
        if (capacityInput) {
            capacityInput.addEventListener('input', function() {
                if (multipleTablesData[0]) {
                    multipleTablesData[0].capacity = parseInt(this.value) || 8;
                }
            });
            capacityInput.addEventListener('change', function() {
                if (multipleTablesData[0]) {
                    multipleTablesData[0].capacity = parseInt(this.value) || 8;
                }
            });
        }
        
        // Initialiser les boutons de capacit√©
        initCapacityButtons();
        
    } else {
        document.getElementById('singleTableForm').style.display = 'none';
        document.getElementById('multipleTablesForm').style.display = 'block';
        
        // Mettre √† jour le titre pour le mode multiple
        const step2Title = document.getElementById('step2Title');
        if (step2Title) {
            step2Title.textContent = 'Cr√©ation multiple de tables';
        }
        
        // Initialiser avec une table si vide
        if (multipleTablesData.length === 0) {
            addAnotherTable();
        } else {
            renderMultipleTablesList();
        }
    }
}


function initCapacityButtons() {
    const capacityInput = document.getElementById('singleTableCapacity');
    const decreaseBtn = document.getElementById('decreaseCapacity');
    const increaseBtn = document.getElementById('increaseCapacity');
    const quickButtons = document.querySelectorAll('.quick-capacity-btn');
    
    // Boutons +/-
    if (decreaseBtn) {
        decreaseBtn.addEventListener('click', () => {
            let value = parseInt(capacityInput.value) || 8;
            if (value > 1) {
                capacityInput.value = value - 1;
                highlightCurrentCapacity(value - 1);
            }
        });
    }
    
    if (increaseBtn) {
        increaseBtn.addEventListener('click', () => {
            let value = parseInt(capacityInput.value) || 8;
            if (value < 50) {
                capacityInput.value = value + 1;
                highlightCurrentCapacity(value + 1);
            }
        });
    }
    
    // Boutons rapides
    quickButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const capacity = parseInt(btn.dataset.capacity);
            capacityInput.value = capacity;
            highlightCurrentCapacity(capacity);
        });
    });
    
    const currentCapacity = parseInt(capacityInput.value) || 8;
    highlightCurrentCapacity(currentCapacity);
}

function highlightCurrentCapacity(capacity) {
    const quickButtons = document.querySelectorAll('.quick-capacity-btn');
    
    quickButtons.forEach(btn => {
        const btnCapacity = parseInt(btn.dataset.capacity);
        
        if (btnCapacity === capacity) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

// Ajouter une autre table (mode multiple)
        function addAnotherTable() {
            const tableIndex = multipleTablesData.length + 1;
            const defaultTableNumber = (allTables.length + tableIndex).toString();
            
            multipleTablesData.push({
                tableNumber: defaultTableNumber,
                tableName: '',
                capacity: 8,
                location: '',
                category: 'standard',
                description: ''
            });
            
            renderMultipleTablesList();
        }

       
        // Rendre la liste des tables multiples
        function renderMultipleTablesList() {
            const listContainer = document.getElementById('multipleTablesList');
            listContainer.innerHTML = '';
            
            multipleTablesData.forEach((table, index) => {
                const tableItem = document.createElement('div');
                tableItem.className = 'table-item';
                tableItem.innerHTML = `
                    <div class="table-item-header">
                        <div class="table-item-number">Table #${index + 1}</div>
                        ${multipleTablesData.length > 1 ? `
                        <button type="button" class="remove-table-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tag"></i>
                            Nom de la table
                            <span class="required">*</span>
                        </label>
                        <input type="text" class="form-control table-name-input" 
                            data-index="${index}" value="${table.tableName || ''}" 
                            placeholder="Ex: Table standard, VIP, Familiale" maxlength="50" required>
                        <div class="form-help">Nom pour identifier la table</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-users"></i>
                            Capacit√©
                            <span class="required">*</span>
                        </label>
                        
                        <!-- Contr√¥les de capacit√© am√©lior√©s -->
                        <div class="capacity-control-group">
                            <button type="button" class="capacity-btn decrease-multiple" data-index="${index}" title="Diminuer la capacit√©">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" data-index="${index}" value="${table.capacity || 8}" 
                                class="form-control table-capacity-input" 
                                placeholder="Nombre de places" required min="1" max="50">
                            <button type="button" class="capacity-btn increase-multiple" data-index="${index}" title="Augmenter la capacit√©">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <!-- Boutons de capacit√© rapide -->
                        <div class="quick-capacity-buttons multiple-quick-buttons" data-index="${index}">
                            <button type="button" class="quick-capacity-btn" data-capacity="2">2 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="4">4 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="6">6 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="8">8 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="10">10 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="12">12 places</button>
                        </div>
                        
                        <div class="form-help">Entre 1 et 50 places</div>
                    </div>
                `;
                
                listContainer.appendChild(tableItem);
            });
            
            // Ajouter les √©couteurs pour les boutons de suppression
            listContainer.querySelectorAll('.remove-table-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    multipleTablesData.splice(index, 1);
                    renderMultipleTablesList();
                });
            });
            
            // Ajouter les √©couteurs pour les noms de table
            listContainer.querySelectorAll('.table-name-input').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    multipleTablesData[index].tableName = this.value.trim();
                });
            });
            
            // Ajouter les √©couteurs pour les boutons de capacit√© (mode multiple)
            initMultipleCapacityControls();
        }

        // Initialiser les contr√¥les de capacit√© pour le mode multiple
        function initMultipleCapacityControls() {
            const listContainer = document.getElementById('multipleTablesList');
            
            // Boutons + et - pour chaque table
            listContainer.querySelectorAll('.decrease-multiple').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const input = document.querySelector(`.table-capacity-input[data-index="${index}"]`);
                    let value = parseInt(input.value) || 8;
                    if (value > 1) {
                        input.value = value - 1;
                        multipleTablesData[index].capacity = value - 1;
                        highlightCurrentCapacityMultiple(index, value - 1);
                        updateTablePreview(); 
                    }
                });
            });
            
            listContainer.querySelectorAll('.increase-multiple').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const input = document.querySelector(`.table-capacity-input[data-index="${index}"]`);
                    let value = parseInt(input.value) || 8;
                    if (value < 50) {
                        input.value = value + 1;
                        multipleTablesData[index].capacity = value + 1;
                        highlightCurrentCapacityMultiple(index, value + 1);
                        updateTablePreview(); 
                    }
                });
            });
            
            // Input direct
            listContainer.querySelectorAll('.table-capacity-input').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    let value = parseInt(this.value) || 8;
                    
                    // Limiter la valeur
                    if (value < 1) value = 1;
                    if (value > 50) value = 50;
                    
                    this.value = value;
                    multipleTablesData[index].capacity = value;
                    highlightCurrentCapacityMultiple(index, value);
                    updateTablePreview(); 
                });
                
                // S'assurer que la valeur est correcte √† la perte de focus
                input.addEventListener('blur', function() {
                    const index = parseInt(this.dataset.index);
                    let value = parseInt(this.value) || 8;
                    
                    if (isNaN(value) || value < 1) {
                        value = 8;
                        this.value = 8;
                    } else if (value > 50) {
                        value = 50;
                        this.value = 50;
                    }
                    
                    multipleTablesData[index].capacity = value;
                    highlightCurrentCapacityMultiple(index, value);
                    updateTablePreview(); 
                });
            });
            
            // Boutons rapides de capacit√© pour chaque table
            listContainer.querySelectorAll('.multiple-quick-buttons').forEach(container => {
                const index = parseInt(container.dataset.index);
                const input = document.querySelector(`.table-capacity-input[data-index="${index}"]`);
                const currentValue = parseInt(input.value) || 8;
                
                // Mettre en surbrillance la capacit√© actuelle
                highlightCurrentCapacityMultiple(index, currentValue);
                
                // Ajouter les √©couteurs pour les boutons rapides
                container.querySelectorAll('.quick-capacity-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const capacity = parseInt(this.dataset.capacity);
                        const input = document.querySelector(`.table-capacity-input[data-index="${index}"]`);
                        
                        input.value = capacity;
                        multipleTablesData[index].capacity = capacity;
                        highlightCurrentCapacityMultiple(index, capacity);
                        updateTablePreview(); 
                    });
                });

                // √âcouteurs pour les noms de table
            listContainer.querySelectorAll('.table-name-input').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    multipleTablesData[index].tableName = this.value.trim();
                    updateTablePreview();
                });
            });
            });
        }

        // Mettre en surbrillance la capacit√© actuelle pour une table multiple
        function highlightCurrentCapacityMultiple(index, capacity) {
            const container = document.querySelector(`.multiple-quick-buttons[data-index="${index}"]`);
            if (!container) return;
            
            container.querySelectorAll('.quick-capacity-btn').forEach(btn => {
                const btnCapacity = parseInt(btn.dataset.capacity);
                
                if (btnCapacity === capacity) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
            
        // Dupliquer les param√®tres
        function duplicateTableSettings() {
            if (multipleTablesData.length < 2) return;
            
            const firstTable = multipleTablesData[0];
            
            // Appliquer les param√®tres de la premi√®re table √† toutes les autres
            for (let i = 1; i < multipleTablesData.length; i++) {
                multipleTablesData[i].tableName = firstTable.tableName;
                multipleTablesData[i].capacity = firstTable.capacity;
            }
            
            renderMultipleTablesList();
            
            Toastify({
                text: "Param√®tres dupliqu√©s sur toutes les tables",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--success)"
            }).showToast();
        }

        // Configurer l'√©tape 3
        function setupStep3() {
            if (creationMode === 'single') {
                document.getElementById('singleTableConfig').style.display = 'block';
                document.getElementById('multipleTablesConfig').style.display = 'none';
                
                // Remplir avec les donn√©es existantes si disponibles
                if (multipleTablesData[0]) {
                    document.getElementById('singleTableLocation').value = multipleTablesData[0].location || '';
                    document.getElementById('singleTableCategory').value = multipleTablesData[0].category || 'standard';
                    document.getElementById('singleTableDescription').value = multipleTablesData[0].description || '';
                }
                
                // Ajouter les √©couteurs pour la mise √† jour en temps r√©el
                const locationInput = document.getElementById('singleTableLocation');
                const categorySelect = document.getElementById('singleTableCategory');
                const descriptionTextarea = document.getElementById('singleTableDescription');
                
                if (locationInput) {
                    locationInput.addEventListener('input', updateTablePreview);
                    locationInput.addEventListener('change', updateTablePreview);
                }
                
                if (categorySelect) {
                    categorySelect.addEventListener('change', updateTablePreview);
                }
                
                if (descriptionTextarea) {
                    descriptionTextarea.addEventListener('input', updateTablePreview);
                }
                
            } else {
                document.getElementById('singleTableConfig').style.display = 'none';
                document.getElementById('multipleTablesConfig').style.display = 'block';
                
                // Remplir avec les donn√©es communes si disponibles
                if (multipleTablesData[0]) {
                    document.getElementById('multipleTablesLocation').value = multipleTablesData[0].location || '';
                    document.getElementById('multipleTablesCategory').value = multipleTablesData[0].category || 'standard';
                    document.getElementById('multipleTablesDescription').value = multipleTablesData[0].description || '';
                }
                
                // Ajouter les √©couteurs pour la mise √† jour en temps r√©el
                const locationInput = document.getElementById('multipleTablesLocation');
                const categorySelect = document.getElementById('multipleTablesCategory');
                const descriptionTextarea = document.getElementById('multipleTablesDescription');
                
                if (locationInput) {
                    locationInput.addEventListener('input', updateTablePreview);
                    locationInput.addEventListener('change', updateTablePreview);
                }
                
                if (categorySelect) {
                    categorySelect.addEventListener('change', updateTablePreview);
                }
                
                if (descriptionTextarea) {
                    descriptionTextarea.addEventListener('input', updateTablePreview);
                }
            }
            
            // Afficher l'aper√ßu
            document.getElementById('tablePreviewCard').style.display = 'block';
            updateTablePreview();
            
            // Ajouter l'√©couteur pour le bouton actualiser
            document.getElementById('refreshPreviewBtn')?.addEventListener('click', updateTablePreview);
        }


        // Mettre √† jour l'aper√ßu de la table
function updateTablePreview() {
    const previewContent = document.getElementById('previewTableContent');
    if (!previewContent) return;

    const scrollPos = previewContent.scrollTop;
    
    if (creationMode === 'single') {
        const table = multipleTablesData[0] || {};
        const location = document.getElementById('singleTableLocation')?.value || table.location || '';
        const category = document.getElementById('singleTableCategory')?.value || table.category || 'standard';
        const description = document.getElementById('singleTableDescription')?.value || table.description || '';
        
        previewContent.innerHTML = `
                ${isEditMode ? `
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-hashtag"></i> Num√©ro de table
                    </div>
                    <div class="preview-info-value highlight">#${escapeHtml(table.tableNumber || 'G√©n√©ration...')}</div>
                </div>
                ` : ''}
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-tag"></i> Nom
                    </div>
                    <div class="preview-info-value">${escapeHtml(table.tableName || 'Non sp√©cifi√©')}</div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-users"></i> Capacit√©
                    </div>
                    <div class="preview-info-value">
                        <span class="capacity-badge">${table.capacity || 8} places</span>
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-map-marker-alt"></i> Emplacement
                    </div>
                    <div class="preview-info-value ${location ? '' : 'empty'}">
                        ${escapeHtml(location || 'Non sp√©cifi√©')}
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-tags"></i> Cat√©gorie
                    </div>
                    <div class="preview-info-value category-${category}">
                        ${getCategoryLabel(category)}
                    </div>
                </div>
                
                ${description ? `
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-align-left"></i> Description
                    </div>
                    <div class="preview-info-value preview-description">
                        ${escapeHtml(description.substring(0, 100))}${description.length > 100 ? '...' : ''}
                    </div>
                </div>
                ` : ''}
           
        `;
    } else {
        // Mode multiple
        const location = document.getElementById('multipleTablesLocation')?.value || '';
        const category = document.getElementById('multipleTablesCategory')?.value || 'standard';
        const description = document.getElementById('multipleTablesDescription')?.value || '';
        const capacity = multipleTablesData[0]?.capacity || 8;
        
        previewContent.innerHTML = `
            <div class="preview-grid">
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-layer-group"></i> Nombre de tables
                    </div>
                    <div class="preview-info-value highlight">
                        ${multipleTablesData.length} table(s)
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-chair"></i> Capacit√© par table
                    </div>
                    <div class="preview-info-value">
                        <span class="capacity-badge">${capacity} places</span>
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-calculator"></i> Capacit√© totale
                    </div>
                    <div class="preview-info-value">
                        ${multipleTablesData.length * capacity} places
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-map-marker-alt"></i> Emplacement
                    </div>
                    <div class="preview-info-value ${location ? '' : 'empty'}">
                        ${escapeHtml(location || 'Commun')}
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-tags"></i> Cat√©gorie
                    </div>
                    <div class="preview-info-value category-${category}">
                        ${getCategoryLabel(category)}
                    </div>
                </div>
                
                ${description ? `
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-align-left"></i> Description
                    </div>
                    <div class="preview-info-value preview-description">
                        ${escapeHtml(description.substring(0, 100))}${description.length > 100 ? '...' : ''}
                    </div>
                </div>
                ` : ''}
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-list"></i> Liste des tables
                    </div>
                    <div class="preview-info-value table-list">
                        ${multipleTablesData.map((t, i) => `
                            <span class="table-pill">
                                ${i + 1}. ${escapeHtml(t.tableName || 'Table ' + (i + 1))}
                            </span>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

    previewContent.scrollTop = scrollPos;
    
    setTimeout(() => {
        const items = previewContent.querySelectorAll('.preview-info-item');
        items.forEach((item, index) => {
            setTimeout(() => {
                animatePreviewUpdate(item);
            }, index * 50);
        });
    }, 100);
    }
}

function animatePreviewUpdate(element) {
    if (element) {
        element.classList.add('updated');
        setTimeout(() => {
            element.classList.remove('updated');
        }, 500);
    }
}
        // Configurer l'√©tape 4
        async function setupStep4() {
            if (isEditMode) {
                document.getElementById('step4Subtitle').textContent = 
                    `G√©rez les invit√©s assign√©s √† la table (modification)`;
            } else {
                document.getElementById('step4Subtitle').textContent = creationMode === 'single' ?
                    `Assignez des invit√©s √† votre table (optionnel)` :
                    'Assignez des invit√©s aux tables (optionnel)';
            }
            
            await loadAvailableGuestsForCreation();
            
            if (isEditMode && selectedGuests.length > 0) {
                updateSelectedGuestsList();
            }
            
            // Mettre √† jour le compteur et la capacit√©
            updateSelectedGuestsCount();
            updateCapacityInfo();
        }

        // Charger les invit√©s disponibles pour la cr√©ation
        async function loadAvailableGuestsForCreation() {
            try {
                const guests = await storage.getAllGuests({ eventId: currentEvent.id });
                
                // Pour l'√©dition, inclure les invit√©s d√©j√† assign√©s
                if (isEditMode) {
                    availableGuestsList = guests; 
                } else {
                    availableGuestsList = guests.filter(guest => !guest.tableId);
                }
                
                // Afficher la liste
                filterAvailableGuests('');
                
            } catch (error) {
                console.error('Erreur chargement invit√©s:', error);
                document.getElementById('availableGuestsCreation').innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Impossible de charger les invit√©s</p>
                    </div>
                `;
            }
        }
        

        // Filtrer les invit√©s disponibles
        function filterAvailableGuests(searchTerm) {
            const container = document.getElementById('availableGuestsCreation');
            let filtered = [...availableGuestsList];
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(guest =>
                    guest.firstName?.toLowerCase().includes(term) ||
                    guest.lastName?.toLowerCase().includes(term) ||
                    guest.email?.toLowerCase().includes(term)
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-color); opacity: 0.5;">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Aucun invit√© disponible</p>
                        <small>Tous les invit√©s sont d√©j√† assign√©s ou aucun invit√© n'a √©t√© cr√©√©</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(guest => {
                const isSelected = selectedGuests.some(g => g.id === guest.id);
                const guestSeats = guest.seats || 1;
                const canSelect = canAddGuestToSelection(guest);
                
                return `
                    <div class="guest-select-item ${isSelected ? 'selected' : ''} ${!canSelect ? 'disabled' : ''}" 
                        data-guest-id="${guest.id}" 
                        style="margin-bottom: 10px; padding: 10px; border-radius: 8px; 
                                background: ${!canSelect ? 'var(--disabled-bg, #f3f4f6)' : 'var(--hover-bg)'}; 
                                cursor: ${!canSelect ? 'not-allowed' : 'pointer'}; 
                                opacity: ${!canSelect ? '0.6' : '1'};">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="guest-checkbox" style="width: 20px; height: 20px; border-radius: 4px; 
                                border: 2px solid ${!canSelect ? 'var(--border-color, #d1d5db)' : 'var(--border-color)'}; 
                                background: ${isSelected ? 'var(--primary)' : (!canSelect ? 'var(--disabled-bg, #f3f4f6)' : 'var(--input-bg)')}; 
                                display: flex; align-items: center; justify-content: center;">
                                ${isSelected ? '<i class="fas fa-check" style="color: white; font-size: 0.8rem;"></i>' : ''}
                            </div>
                            <div class="guest-avatar" style="width: 40px; height: 40px; border-radius: 50%; 
                                background: ${!canSelect ? 'var(--disabled-color, #9ca3af)' : 'var(--gradient)'}; 
                                display: flex; align-items: center; justify-content: center; 
                                color: white; font-weight: 600; font-size: 0.9rem;">
                                ${getInitials(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email)}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${!canSelect ? 'var(--disabled-text, #6b7280)' : 'var(--text-color)'};">
                                    ${escapeHtml(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email)}
                                </div>
                                <div style="font-size: 0.85rem; color: ${!canSelect ? 'var(--disabled-text, #6b7280)' : 'var(--text-color)'}; opacity: 0.7;">
                                    ${guest.email || ''} ‚Ä¢ ${guestSeats} place(s)
                                    ${!canSelect ? '<span style="color: var(--warning); margin-left: 5px;"><i class="fas fa-exclamation-triangle"></i> Capacit√© insuffisante</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Ajouter les √©couteurs
            container.querySelectorAll('.guest-select-item:not(.disabled)').forEach(item => {
                item.addEventListener('click', function() {
                    const guestId = this.dataset.guestId;
                    toggleGuestSelection(guestId);
                });
            });
        }

        // V√©rifier si un invit√© peut √™tre ajout√© √† la s√©lection
        function canAddGuestToSelection(guest) {
            if (creationMode === 'multiple') return true; // Mode multiple: pas de v√©rification ici
            
            const capacity = getCurrentTableCapacity();
            const guestSeats = guest.seats || 1;
            
            // Si l'invit√© est d√©j√† s√©lectionn√©, il peut √™tre retir√©
            if (selectedGuests.some(g => g.id === guest.id)) {
                return true;
            }
            
            // Calculer les places d√©j√† occup√©es
            const occupiedSeats = selectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0);
            
            // V√©rifier si on peut ajouter cet invit√©
            return (occupiedSeats + guestSeats) <= capacity;
        }

        // Obtenir la capacit√© actuelle de la table
        function getCurrentTableCapacity() {
            if (creationMode === 'single') {
                if (isEditMode && multipleTablesData[0]) {
                    return multipleTablesData[0].capacity || 8;
                }
                return parseInt(document.getElementById('singleTableCapacity').value) || 8;
            }
            
            return 9999;
        }

        // Basculer la s√©lection d'un invit√©
        function toggleGuestSelection(guestId) {
            const guest = availableGuestsList.find(g => g.id === guestId);
            if (!guest) return;
            
            const existingIndex = selectedGuests.findIndex(g => g.id === guestId);
            
            if (existingIndex === -1) {
                // V√©rifier la capacit√© avant d'ajouter
                if (!canAddGuestToSelection(guest)) {
                    const capacity = getCurrentTableCapacity();
                    const occupiedSeats = selectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0);
                    const guestSeats = guest.seats || 1;
                    const remainingSeats = capacity - occupiedSeats;
                    
                    Toastify({
                        text: `Capacit√© insuffisante. ${guestSeats} place(s) requise(s), ${remainingSeats} disponible(s)`,
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "var(--warning)"
                    }).showToast();
                    return;
                }
                
                selectedGuests.push(guest);
                Toastify({
                    text: "Invit√© s√©lectionn√©",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--success)"
                }).showToast();
            } else {
                selectedGuests.splice(existingIndex, 1);
                Toastify({
                    text: "Invit√© d√©s√©lectionn√©",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--info)"
                }).showToast();
            }
            
            filterAvailableGuests(document.getElementById('searchGuestsCreation').value);
            updateSelectedGuestsList();
            updateSelectedGuestsCount();
            updateCapacityInfo();
        }



       // Mettre √† jour la liste des invit√©s s√©lectionn√©s
        function updateSelectedGuestsList() {
            const container = document.getElementById('selectedGuestsList');
            
            if (selectedGuests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px; color: var(--text-color); opacity: 0.5;">
                        <i class="fas fa-user-plus" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Aucun invit√© s√©lectionn√©</p>
                        <small>S√©lectionnez des invit√©s dans la liste ci-dessus</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = selectedGuests.map(guest => {
                const guestSeats = guest.seats || 1;
                
                return `
                    <div class="selected-guest-item" data-guest-id="${guest.id}" 
                        style="display: flex; justify-content: space-between; align-items: center; 
                                padding: 12px; margin-bottom: 8px; background: var(--hover-bg); 
                                border-radius: 8px; border-left: 4px solid var(--primary);">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div class="guest-avatar" style="width: 36px; height: 36px; border-radius: 50%; 
                                background: var(--gradient); display: flex; align-items: center; 
                                justify-content: center; color: white; font-weight: 600; font-size: 0.85rem;">
                                ${getInitials(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email)}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-color);">
                                    ${escapeHtml(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email)}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-color); opacity: 0.7; 
                                    display: flex; align-items: center; gap: 8px;">
                                    <span>${guest.email || ''}</span>
                                    <span style="background: var(--primary-light); color: white; 
                                        padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                                        <i class="fas fa-chair"></i> ${guestSeats} place(s)
                                    </span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="remove-selected-guest" data-guest-id="${guest.id}"
                                style="background: none; border: none; color: var(--danger); cursor: pointer; 
                                    padding: 6px; border-radius: 4px; transition: all 0.3s ease;"
                                onmouseover="this.style.backgroundColor='var(--danger-light)'"
                                onmouseout="this.style.backgroundColor='transparent'"
                                title="Retirer cet invit√©">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // Ajouter les √©couteurs pour supprimer
            container.querySelectorAll('.remove-selected-guest').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const guestId = this.dataset.guestId;
                    toggleGuestSelection(guestId);
                });
            });
        }

        // Mettre √† jour le compteur d'invit√©s s√©lectionn√©s
        function updateSelectedGuestsCount() {
            const countElement = document.getElementById('selectedGuestsCount');
            const totalSelectedSeats = selectedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
            
            if (countElement) {
                countElement.textContent = selectedGuests.length;
                countElement.title = `${totalSelectedSeats} place(s) occup√©e(s)`;
            }
        }




        // Mettre √† jour les informations de capacit√©
        function updateCapacityInfo() {
            if (creationMode !== 'single') return;
            
            const capacity = getCurrentTableCapacity();
            const totalSelectedSeats = selectedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
            const remainingSeats = capacity - totalSelectedSeats;
            
            // Mettre √† jour le sous-titre avec les informations de capacit√©
            const subtitle = document.getElementById('step4Subtitle');
            if (subtitle) {
                if (isEditMode) {
                    subtitle.textContent = `G√©rez les invit√©s assign√©s √† la table (${totalSelectedSeats}/${capacity} places utilis√©es)`;
                } else {
                    subtitle.textContent = `Assignez des invit√©s √† votre table (${remainingSeats} place(s) disponible(s))`;
                }
            }
            
            const capacityIndicator = document.createElement('div');
            capacityIndicator.id = 'capacityIndicator';
            capacityIndicator.style.cssText = `
                margin: 10px 0;
                padding: 10px;
                background: ${remainingSeats === 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)'};
                border-radius: 8px;
                border-left: 4px solid ${remainingSeats === 0 ? 'var(--danger)' : 'var(--success)'};
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
            `;
            
            capacityIndicator.innerHTML = `
                <div>
                    <i class="fas fa-chart-pie" style="margin-right: 8px;"></i>
                    <strong>${totalSelectedSeats}/${capacity}</strong> places occup√©es
                </div>
                <div style="color: ${remainingSeats === 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: 600;">
                    ${remainingSeats === 0 ? 'Table compl√®te' : `${remainingSeats} place(s) disponible(s)`}
                </div>
            `;
            
            // Trouver ou cr√©er l'indicateur de capacit√©
            let existingIndicator = document.getElementById('capacityIndicator');
            const selectedGuestsContainer = document.getElementById('selectedGuestsList');
            
            if (existingIndicator) {
                existingIndicator.replaceWith(capacityIndicator);
            } else if (selectedGuestsContainer && selectedGuests.length > 0) {
                selectedGuestsContainer.parentNode.insertBefore(capacityIndicator, selectedGuestsContainer);
            }
            
            // Mettre √† jour l'√©tat des invit√©s disponibles
            filterAvailableGuests(document.getElementById('searchGuestsCreation').value);
        }

        // Fonction pour calculer l'occupation de la table
        function calculateTableOccupancy(tableCapacity, assignedGuests) {
            const totalSeats = assignedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
            const remainingSeats = Math.max(0, tableCapacity - totalSeats);
            const occupancyRate = tableCapacity > 0 ? Math.round((totalSeats / tableCapacity) * 100) : 0;
            
            return {
                totalSeats,
                remainingSeats,
                occupancyRate,
                isFull: totalSeats >= tableCapacity,
                isEmpty: totalSeats === 0
            };
        }



        // Auto-assignation dans la cr√©ation
        async function autoAssignInCreation() {
            if (creationMode === 'single') {
                // Pour une table unique, assigner jusqu'√† la capacit√©
                const table = multipleTablesData[0];
                const capacity = table.capacity;
                let seatsAvailable = capacity;
                
                // S√©lectionner les invit√©s non assign√©s
                const guestsToAssign = availableGuestsList.filter(guest => 
                    !selectedGuests.some(g => g.id === guest.id)
                );
                
                for (const guest of guestsToAssign) {
                    if (seatsAvailable <= 0) break;
                    
                    const guestSeats = guest.seats || 1;
                    if (guestSeats <= seatsAvailable) {
                        selectedGuests.push(guest);
                        seatsAvailable -= guestSeats;
                    }
                }
                
                filterAvailableGuests(document.getElementById('searchGuestsCreation').value);
                updateSelectedGuestsList();
                updateSelectedGuestsCount();
                
                Toastify({
                    text: `${selectedGuests.length} invit√©(s) auto-assign√©(s)`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--success)"
                }).showToast();
            } else {
                // Pour le mode multiple, demander la strat√©gie
                const { value: strategy } = await Swal.fire({
                    title: 'Strat√©gie d\'auto-assignation',
                    input: 'select',
                    inputOptions: {
                        'fill': 'Remplir chaque table avant de passer √† la suivante',
                        'distribute': 'R√©partir uniform√©ment sur toutes les tables',
                        'smart': 'Intelligente (par groupes)'
                    },
                    inputPlaceholder: 'S√©lectionnez une strat√©gie',
                    showCancelButton: true,
                    confirmButtonText: 'Auto-assigner',
                    cancelButtonText: 'Annuler',
                    confirmButtonColor: '#D97706'
                });
                
                if (!strategy) return;
                
                // Impl√©menter la logique d'auto-assignation selon la strat√©gie
                // Pour l'instant, on assigne simplement les invit√©s disponibles
                const availableGuests = availableGuestsList.filter(guest => 
                    !selectedGuests.some(g => g.id === guest.id)
                );
                
                // Limiter √† un certain nombre pour √©viter la surcharge
                const limit = Math.min(availableGuests.length, multipleTablesData.length * 5);
                const guestsToAdd = availableGuests.slice(0, limit);
                
                selectedGuests.push(...guestsToAdd);
                
                filterAvailableGuests(document.getElementById('searchGuestsCreation').value);
                updateSelectedGuestsList();
                updateSelectedGuestsCount();
                
                Toastify({
                    text: `${guestsToAdd.length} invit√©(s) auto-assign√©(s)`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--success)"
                }).showToast();
            }
        }

        // Configurer l'√©tape 5
        function setupStep5() {
            document.getElementById('step5Subtitle').textContent = creationMode === 'single' ?
                'V√©rifiez les informations de votre table avant cr√©ation' :
                `V√©rifiez les informations des ${multipleTablesData.length} tables avant cr√©ation`;
            
            const confirmationContent = document.getElementById('confirmationContent');
            
            if (creationMode === 'single') {
                const table = multipleTablesData[0];
                confirmationContent.innerHTML = `
                    <div class="table-preview-card">
                        <div class="preview-table-content">
                            <div class="preview-info-item">
                                <div class="preview-info-label">Num√©ro de table</div>
                                <div class="preview-info-value">#${escapeHtml(table.tableNumber)}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Nom</div>
                                <div class="preview-info-value">${escapeHtml(table.tableName || 'Non sp√©cifi√©')}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Capacit√©</div>
                                <div class="preview-info-value">${table.capacity} places</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Emplacement</div>
                                <div class="preview-info-value">${escapeHtml(table.location || 'Non sp√©cifi√©')}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Cat√©gorie</div>
                                <div class="preview-info-value">${getCategoryLabel(table.category || 'standard')}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Description</div>
                                <div class="preview-info-value" style="font-style: italic; opacity: 0.8;">
                                    ${escapeHtml(table.description || 'Aucune description')}
                                </div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Invit√©s assign√©s</div>
                                <div class="preview-info-value">${selectedGuests.length} invit√©(s)</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const totalCapacity = multipleTablesData.reduce((sum, table) => sum + table.capacity, 0);
                const commonLocation = document.getElementById('multipleTablesLocation').value;
                const commonCategory = document.getElementById('multipleTablesCategory').value;
                const commonDescription = document.getElementById('multipleTablesDescription').value;
                
                confirmationContent.innerHTML = `
                    <div class="table-preview-card">
                        <div class="preview-table-content">
                            <div class="preview-info-item" style="grid-column: 1 / -1;">
                                <div class="preview-info-label">Nombre de tables</div>
                                <div class="preview-info-value">${multipleTablesData.length} tables</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Capacit√© totale</div>
                                <div class="preview-info-value">${totalCapacity} places</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Capacit√© moyenne</div>
                                <div class="preview-info-value">${Math.round(totalCapacity / multipleTablesData.length)} places/table</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Emplacement commun</div>
                                <div class="preview-info-value">${escapeHtml(commonLocation || 'Non sp√©cifi√©')}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Cat√©gorie commune</div>
                                <div class="preview-info-value">${getCategoryLabel(commonCategory || 'standard')}</div>
                            </div>
                            <div class="preview-info-item" style="grid-column: 1 / -1;">
                                <div class="preview-info-label">Description commune</div>
                                <div class="preview-info-value" style="font-style: italic; opacity: 0.8;">
                                    ${escapeHtml(commonDescription || 'Aucune description')}
                                </div>
                            </div>
                            <div class="preview-info-item" style="grid-column: 1 / -1;">
                                <div class="preview-info-label">Liste des tables</div>
                                <div class="preview-info-value" style="font-size: 0.9rem; opacity: 0.8; line-height: 1.6;">
                                    ${multipleTablesData.map((t, i) => 
                                        `Table ${i + 1}: #${escapeHtml(t.tableNumber)} (${t.capacity} places)`
                                    ).join('<br>')}
                                </div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Invit√©s assign√©s</div>
                                <div class="preview-info-value">${selectedGuests.length} invit√©(s) √† r√©partir</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Cr√©er une table rapide
        async function createQuickTable() {
            try {
                // G√©n√©rer un num√©ro de table unique
                let tableNumber = (allTables.length + 1).toString();
                let attempts = 0;
                
                while (allTables.some(t => t.tableNumber === tableNumber) && attempts < 100) {
                    tableNumber = (parseInt(tableNumber) + 1).toString();
                    attempts++;
                }
                
                const tableData = {
                    tableNumber,
                    tableName: `Table ${tableNumber}`,
                    capacity: 8,
                    location: 'Zone principale',
                    category: 'standard',
                    description: 'Table cr√©√©e automatiquement',
                    eventId: currentEvent.id
                };
                
                const saveBtn = document.getElementById('quickTableBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<div class="spinner"></div>';
                
                const savedTable = await storage.createTable(currentEvent.id, tableData);
                
                if (savedTable) {
                    closeTableCreationModal();
                    await loadTables();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Table cr√©√©e !',
                        text: `La table #${savedTable.tableNumber} a √©t√© cr√©√©e avec succ√®s`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
            } catch (error) {
                console.error('Erreur cr√©ation table rapide:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de cr√©er la table',
                    confirmButtonColor: '#D97706'
                });
            } finally {
                const saveBtn = document.getElementById('quickTableBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        // Soumettre la cr√©ation des tables
        async function submitTablesCreation() {
            try {
                const submitBtn = document.getElementById('submitTablesCreation');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner"></div>';
                
                let result;
                
                if (isEditMode && editingTableId) {
                    // MODE √âDITION
                    const tableData = {
                        ...multipleTablesData[0],
                        eventId: currentEvent.id
                    };
                    
                    result = await storage.updateTable(editingTableId, tableData);
                    
                    // G√©rer les invit√©s assign√©s
                    if (selectedGuests.length > 0) {
                        // Retirer tous les invit√©s existants
                        const table = allTables.find(t => t.id === editingTableId);
                        if (table && table.assignedGuests) {
                            for (const guest of table.assignedGuests) {
                                await storage.removeGuestFromTable(editingTableId, guest.guestId);
                            }
                        }
                        
                        // Assigner les nouveaux invit√©s
                        for (const guest of selectedGuests) {
                            await storage.assignGuestToTable(editingTableId, guest.id, guest.seats || 1);
                        }
                    } else {
                        // Si aucun invit√© s√©lectionn√©, retirer tous les invit√©s
                        const table = allTables.find(t => t.id === editingTableId);
                        if (table && table.assignedGuests) {
                            for (const guest of table.assignedGuests) {
                                await storage.removeGuestFromTable(editingTableId, guest.guestId);
                            }
                        }
                    }
                    
                } else {
                    // MODE CR√âATION
                    if (creationMode === 'single') {
                        // Cr√©er une seule table
                        const tableData = {
                            ...multipleTablesData[0],
                            eventId: currentEvent.id
                        };
                        
                        result = await storage.createTable(currentEvent.id, tableData);
                        
                        // Assigner les invit√©s si s√©lectionn√©s
                        if (result && selectedGuests.length > 0) {
                            for (const guest of selectedGuests) {
                                await storage.assignGuestToTable(result.id, guest.id, guest.seats || 1);
                            }
                        }
                        
                    } else {
                        // Cr√©er plusieurs tables
                        const tablesToCreate = multipleTablesData.map(table => ({
                            ...table,
                            eventId: currentEvent.id
                        }));
                        
                        result = await storage.createMultipleTables(currentEvent.id, tablesToCreate);
                    }
                }
                
                if (result) {
                    closeTableCreationModal();
                    await loadTables();
                    
                    // Effets de succ√®s
                    SECURA_AUDIO.play('success');
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                    
                    // Message de succ√®s adapt√©
                    const successMessage = isEditMode ? 
                        'Table modifi√©e avec succ√®s !' :
                        creationMode === 'single' ? 
                            'Table cr√©√©e avec succ√®s !' : 
                            `${multipleTablesData.length} tables cr√©√©es avec succ√®s !`;
                    
                    await Swal.fire({
                        icon: 'success',
                        title: isEditMode ? 'Modification r√©ussie !' : 'Cr√©ation r√©ussie !',
                        html: `
                            <div style="text-align: center; padding: 20px 0;">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 15px;"></i>
                                <p style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                                    ${successMessage}
                                </p>
                                ${selectedGuests.length > 0 ? `
                                    <p style="color: rgba(255,255,255,0.8); margin-top: 10px;">
                                        <i class="fas fa-users"></i>
                                        ${selectedGuests.length} invit√©(s) assign√©(s)
                                    </p>
                                ` : ''}
                            </div>
                        `,
                        confirmButtonColor: '#D97706',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
                
            } catch (error) {
                console.error('Erreur cr√©ation/modification table:', error);
                
                SECURA_AUDIO.play('error');
                
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    html: `
                        <div style="text-align: center; padding: 20px 0;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: var(--danger); margin-bottom: 15px;"></i>
                            <p>Impossible de ${isEditMode ? 'modifier' : 'cr√©er'} ${creationMode === 'single' ? 'la table' : 'les tables'}.</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-top: 10px;">
                                ${error.message || 'Une erreur est survenue. Veuillez r√©essayer.'}
                            </p>
                        </div>
                    `,
                    confirmButtonColor: '#D97706'
                });
            } finally {
                const submitBtn = document.getElementById('submitTablesCreation');
                submitBtn.disabled = false;
                submitBtn.innerHTML = isEditMode ? 
                    '<i class="fas fa-save"></i> Enregistrer les modifications' :
                    '<i class="fas fa-check-circle"></i> Cr√©er les tables';
            }
        }

        // Mettre √† jour la progression de cr√©ation
        function updateCreationProgress() {
            const progress = Math.round(((creationStep - 1) / 4) * 100);
            
            // Mettre √† jour le pourcentage (s'il existe)
            const progressPercentage = document.getElementById('creationProgressPercentage');
            if (progressPercentage) {
                progressPercentage.textContent = `${progress}%`;
            }
            
            // Mettre √† jour la barre lin√©aire
            const progressBarFill = document.getElementById('progressBarFill');
            if (progressBarFill) {
                progressBarFill.style.width = `${Math.max(20, progress)}%`;
            }
        }

        // Mettre √† jour l'indicateur de statut de l'√©v√©nement
        function updateEventStatusIndicator() {
            const indicator = document.getElementById('eventStatusIndicator');
            if (!currentEvent) return;
            
            let statusText = '';
            let statusClass = '';
            
            switch(currentEvent.status) {
                case 'active':
                    statusText = 'Actif';
                    statusClass = 'status-active';
                    break;
                case 'draft':
                    statusText = 'Brouillon';
                    statusClass = 'status-inactive';
                    break;
                case 'archived':
                    statusText = 'Archiv√©';
                    statusClass = 'status-inactive';
                    break;
                default:
                    statusText = currentEvent.status;
                    statusClass = 'status-inactive';
            }
            
            indicator.innerHTML = `
                <i class="fas fa-circle"></i>
                <span>${statusText}</span>
            `;
            indicator.className = `status-indicator ${statusClass}`;
            indicator.style.display = 'flex';
        }

        // Mettre √† jour l'interface
        function updateUI() {
            document.title = `SECURA | Tables - ${currentEvent?.name || '√âv√©nement'}`;
        }

        // Afficher le loader
        function showLoader(view = 'all') {
            const loaders = {
                grid: 'gridLoader',
                table: 'tableLoader',
                visual: 'visualLoader',
                stats: 'statsLoader'
            };
            
            if (view === 'all') {
                Object.values(loaders).forEach(loaderId => {
                    const loader = document.getElementById(loaderId);
                    if (loader) loader.style.display = 'block';
                });
            } else if (loaders[view]) {
                const loader = document.getElementById(loaders[view]);
                if (loader) loader.style.display = 'block';
            }
        }

        // Cacher le loader
        function hideLoader(view = 'all') {
            const loaders = {
                grid: 'gridLoader',
                table: 'tableLoader',
                visual: 'visualLoader',
                stats: 'statsLoader'
            };
            
            if (view === 'all') {
                Object.values(loaders).forEach(loaderId => {
                    const loader = document.getElementById(loaderId);
                    if (loader) loader.style.display = 'none';
                });
            } else if (loaders[view]) {
                const loader = document.getElementById(loaders[view]);
                if (loader) loader.style.display = 'none';
            }
        }

        // Auto-assigner tous les invit√©s
        async function autoAssignGuests() {
            const saveBtn = document.getElementById('autoAssignBtn');
            const originalText = saveBtn.innerHTML;
            
            const result = await Swal.fire({
                title: 'Auto-assigner les invit√©s ?',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-robot" style="font-size: 4rem; color: var(--primary); margin-bottom: 15px;"></i>
                        <p>Cette op√©ration assignera automatiquement tous les invit√©s non assign√©s aux tables disponibles.</p>
                        <p style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem; margin-top: 10px;">
                            Strat√©gie: √âquilibrage optimal
                        </p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Auto-assigner',
                cancelButtonText: 'Annuler',
                confirmButtonColor: '#D97706',
                cancelButtonColor: '#6B7280'
            });

            if (!result.isConfirmed) {
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="spinner"></div>';
            
            try {
                
                
                const result = await storage.autoAssignGuests(currentEvent.id, 'balanced');
                
                if (result) {
                    await loadTables();
                    
                    await Swal.fire({
                        icon: 'success',
                        title: 'Auto-assignation termin√©e !',
                        html: `
                            <div style="text-align: center; padding: 20px 0;">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 15px;"></i>
                                <p><strong>${result.assigned?.length || 0} invit√©(s)</strong> assign√©(s) avec succ√®s</p>
                                ${result.errors && result.errors.length > 0 ? `
                                    <p style="color: var(--warning); font-size: 0.9rem; margin-top: 10px;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        ${result.errors.length} erreur(s) rencontr√©e(s)
                                    </p>
                                ` : ''}
                            </div>
                        `,
                        confirmButtonColor: '#D97706'
                    });
                }
                
            } catch (error) {
                console.error('Erreur auto-assignation:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible d\'auto-assigner les invit√©s',
                    confirmButtonColor: '#D97706'
                });
            } finally {
                const saveBtn = document.getElementById('autoAssignBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        // Exporter les tables
        async function exportTables() {
            try {
                const csv = [];
                const headers = ['Num√©ro', 'Nom', 'Capacit√©', 'Invit√©s assign√©s', 'Places occup√©es', 'Places disponibles', 'Emplacement', 'Cat√©gorie', 'Statut'];
                csv.push(headers.join(','));
                
                filteredTables.forEach(table => {
                    const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
                        sum + (guest.seats || 1), 0) || 0;
                    const availableSeats = Math.max(0, (table.capacity || 0) - totalSeats);
                    const status = totalSeats >= table.capacity ? 'Compl√®te' : 
                                  totalSeats === 0 ? 'Vide' : 'Partiellement occup√©e';
                    
                    const row = [
                        `"${table.tableNumber || ''}"`,
                        `"${table.tableName || ''}"`,
                        table.capacity,
                        table.assignedGuests?.length || 0,
                        totalSeats,
                        availableSeats,
                        `"${table.location || ''}"`,
                        `"${table.category || 'standard'}"`,
                        `"${status}"`
                    ];
                    
                    csv.push(row.join(','));
                });
                
                const csvContent = csv.join('\n');
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `secura-tables-${currentEvent.name}-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                Toastify({
                    text: `${filteredTables.length} tables export√©es`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--success)"
                }).showToast();
                
            } catch (error) {
                console.error('Erreur export tables:', error);
                Toastify({
                    text: "Erreur lors de l'export",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--danger)"
                }).showToast();
            }
        }

        // Fonctions utilitaires
        function showValidation(elementId, message, isValid) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = message;
            element.className = `validation-message ${isValid ? 'valid' : 'invalid'}`;
            element.style.opacity = '0';
            element.style.transform = 'translateY(-5px)';
            
            setTimeout(() => {
                element.style.opacity = '1';
                element.style.transform = 'translateY(0)';
            }, 10);
            
            return isValid;
        }

        function getInitials(name) {
    if (!name) return '?';
    return name.split(' ')
        .map(part => part.charAt(0))
        .join('')
        .toUpperCase()
        .substring(0, 2);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCategoryLabel(category) {
    const labels = {
        'vip': 'VIP',
        'family': 'Familiale',
        'speaker': 'Conf√©rencier',
        'organizer': 'Organisateur',
        'standard': 'Standard',
        'mariage': 'Mariage',
        'anniversaire': 'Anniversaire'
    };
    return labels[category] || 'Standard';
}

        // Fonctions globales
        window.showTableDetails = async function(table) {
            await showEnhancedTableDetails(table);
        };


        async function removeGuestFromTable(tableId, guestId) {
            const table = allTables.find(t => t.id === tableId);
            const guest = table?.assignedGuests?.find(g => g.guestId === guestId);
            if (!table || !guest) return;
            
            const result = await Swal.fire({
                title: 'Retirer l\'invit√© ?',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-user-minus" style="font-size: 3rem; color: #F59E0B; margin-bottom: 15px;"></i>
                        <p>√ätes-vous s√ªr de vouloir retirer</p>
                        <p style="font-weight: 600; color: var(--primary);">${escapeHtml(guest.guestName)}</p>
                        <p style="font-size: 0.9rem; opacity: 0.7;">de la table <strong>#${escapeHtml(table.tableNumber)}</strong> ?</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Oui, retirer',
                cancelButtonText: 'Annuler',
                confirmButtonColor: '#F59E0B',
                cancelButtonColor: '#6B7280',
                reverseButtons: true
            });
            
            if (result.isConfirmed) {
                try {
                    // Retirer l'invit√© de la table
                    table.assignedGuests = table.assignedGuests.filter(g => g.id !== guestId);
                    await storage.updateTable(tableId, table);
                    
                    // Recharger et r√©afficher
                    await loadTables();
                    
                    Toastify({
                        text: 'Invit√© retir√© de la table',
                        duration: 2000,
                        backgroundColor: '#10B981'
                    }).showToast();
                } catch (error) {
                    console.error('Erreur retrait invit√©:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: 'Impossible de retirer l\'invit√©',
                        confirmButtonColor: '#D97706'
                    });
                }
            }
        };

        

        window.deleteTable = async function(tableId) {
            const table = allTables.find(t => t.id === tableId);
            if (!table) return;
            
            const result = await Swal.fire({
                title: 'Supprimer la table ?',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #EF4444; margin-bottom: 15px;"></i>
                        <p>La table <strong>#${escapeHtml(table.tableNumber)}</strong> sera d√©finitivement supprim√©e.</p>
                        ${table.assignedGuests && table.assignedGuests.length > 0 ? `
                            <p style="color: var(--warning); font-size: 0.9rem; margin-top: 10px;">
                                <i class="fas fa-users"></i>
                                ${table.assignedGuests.length} invit√©(s) seront retir√©(s) de cette table
                            </p>
                        ` : ''}
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Oui, supprimer',
                cancelButtonText: 'Annuler',
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6B7280',
                reverseButtons: true
            });
            
            if (result.isConfirmed) {
                try {
                    await storage.deleteTable(tableId);
                    await loadTables();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Supprim√© !',
                        text: 'La table a √©t√© supprim√©e avec succ√®s',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } catch (error) {
                    console.error('Erreur suppression table:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: 'Impossible de supprimer la table',
                        confirmButtonColor: '#D97706'
                    });
                }
            }
        };

        let tablesCsvCurrentStep = 1;
        let tablesCsvRawData = [];
        let tablesCsvValidatedData = [];
        let tablesCsvEventSelected = null;

       

        function initializeTablesCsvImport() {

            const importBtn = document.getElementById('importTablesBtn');
            if (importBtn) {
                importBtn.addEventListener('click', openTablesCsvImportModal);
            }

            const closeCsvBtn = document.getElementById('closeTablesCsvBtn');
            if (closeCsvBtn) {
                closeCsvBtn.addEventListener('click', closeTablesCsvImportModal);
            }

            const closeModalBtn = document.getElementById('closeTablesCsvModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeTablesCsvImportModal);
            }

            const downloadTemplateBtn = document.getElementById('downloadTablesCsvTemplateBtn');
            if (downloadTemplateBtn) {
                downloadTemplateBtn.addEventListener('click', downloadTablesCsvTemplate);
            }

            const csvFileInput = document.getElementById('tablesCsvFileInput');
            const csvDropZone = document.getElementById('tablesCsvDropZone');

            if (csvFileInput && csvDropZone) {
                csvDropZone.addEventListener('click', () => csvFileInput.click());
                csvFileInput.addEventListener('change', handleTablesCsvFileSelect);

                // Drag & Drop
                csvDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    csvDropZone.style.borderColor = 'var(--primary)';
                    csvDropZone.style.backgroundColor = 'rgba(217, 119, 6, 0.05)';
                });

                csvDropZone.addEventListener('dragleave', () => {
                    csvDropZone.style.borderColor = 'var(--border-color)';
                    csvDropZone.style.backgroundColor = 'transparent';
                });

                csvDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    csvDropZone.style.borderColor = 'var(--border-color)';
                    csvDropZone.style.backgroundColor = 'transparent';

                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        handleTablesCsvFile(file);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Format invalide',
                            text: 'Veuillez s√©lectionner un fichier CSV',
                            confirmButtonColor: '#D97706'
                        });
                    }
                });
            }

            console.log('‚úÖ Syst√®me d\'import CSV pour tables initialis√©');
        }

        // ========== OUVERTURE DU MODAL D'IMPORT ==========
        function openTablesCsvImportModal() {
            console.log('üì• Ouverture du modal d\'import CSV pour tables');

            if (!currentEvent || !currentEvent.id) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Aucun √©v√©nement s√©lectionn√©',
                    text: 'Veuillez d\'abord s√©lectionner un √©v√©nement',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            tablesCsvCurrentStep = 1;
            tablesCsvRawData = [];
            tablesCsvValidatedData = [];
            tablesCsvEventSelected = currentEvent;

            const eventNameEl = document.getElementById('tablesCsvEventName');
            if (eventNameEl && tablesCsvEventSelected) {
                eventNameEl.textContent = tablesCsvEventSelected.name;
            }

            const fileInput = document.getElementById('tablesCsvFileInput');
            if (fileInput) {
                fileInput.value = '';
            }

            showTablesCsvStep(1);

            const modal = document.getElementById('tablesCsvImportModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        // ========== FERMETURE DU MODAL D'IMPORT ==========
        function closeTablesCsvImportModal() {
            console.log('‚úó Fermeture du modal d\'import CSV pour tables');

            const modal = document.getElementById('tablesCsvImportModal');
            if (modal) {
                modal.classList.remove('active');
                tablesCsvCurrentStep = 1;
                tablesCsvRawData = [];
                tablesCsvValidatedData = [];
                tablesCsvEventSelected = null;
            }
        }

        // ========== GESTION DE LA S√âLECTION DE FICHIER CSV ==========
        function handleTablesCsvFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleTablesCsvFile(file);
            }
        }

        function handleTablesCsvFile(file) {
            console.log(`üìÑ Fichier CSV s√©lectionn√©: ${file.name}`);

            if (!file.name.endsWith('.csv')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Format invalide',
                    text: 'Seuls les fichiers CSV sont accept√©s',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            if (!tablesCsvEventSelected) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Aucun √©v√©nement s√©lectionn√©',
                    text: 'Veuillez d\'abord s√©lectionner un √©v√©nement',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    parseTablesCsvData(csvContent);
                } catch (error) {
                    console.error('‚ùå Erreur lecture fichier CSV:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: 'Erreur de lecture du fichier CSV',
                        confirmButtonColor: '#D97706'
                    });
                }
            };

            reader.onerror = function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Erreur de lecture du fichier',
                    confirmButtonColor: '#D97706'
                });
            };

            reader.readAsText(file, 'UTF-8');
        }

        // ========== PARSING DU FICHIER CSV ==========
        // ========== PARSING DU FICHIER CSV (CORRIG√â POUR UTF-8) ==========
function parseTablesCsvData(csvContent) {
    console.log('üìÑ D√©but du parsing CSV avec gestion UTF-8');
    
    // D√©tection de l'encodage BOM UTF-8
    if (csvContent.charCodeAt(0) === 0xFEFF) {
        csvContent = csvContent.substring(1);
    }
    
    if (window.Papa) {
        Papa.parse(csvContent, {
            header: true,
            skipEmptyLines: true,
            encoding: 'UTF-8',
            complete: function(results) {
                console.log('‚úÖ CSV pars√© avec PapaParse:', results.data.length, 'lignes');
                // Nettoyer les caract√®res UTF-8
                const cleanedData = results.data.map(row => {
                    const cleanedRow = {};
                    for (const [key, value] of Object.entries(row)) {
                        if (typeof value === 'string') {
                            // D√©coder les entit√©s HTML et nettoyer
                            let cleanedValue = value.trim();
                            
                            // Nettoyer les caract√®res mal encod√©s
                            cleanedValue = cleanedValue
                                .replace(/√É¬©/g, '√©')
                                .replace(/√É¬™/g, '√™')
                                .replace(/√É¬®/g, '√®')
                                .replace(/√É¬ß/g, '√ß')
                                .replace(/√É¬¥/g, '√¥')
                                .replace(/√É¬π/g, '√π')
                                .replace(/√É¬Æ/g, '√Æ')
                                .replace(/√É¬¢/g, '√¢')
                                .replace(/√É¬®/g, '√®')
                                .replace(/√É/g, '√†')
                                .replace(/√¢¬Ç¬¨/g, '‚Ç¨')
                                .replace(/√¢¬Ä¬ô/g, "'")
                                .replace(/√¢¬Ä¬ô/g, "'")
                                .replace(/√¢¬Ä¬ú/g, '"')
                                .replace(/√¢¬Ä¬ù/g, '"')
                                .replace(/√¢¬Ä¬ì/g, '-');
                            
                            // D√©coder les entit√©s HTML
                            const textarea = document.createElement('textarea');
                            textarea.innerHTML = cleanedValue;
                            cleanedValue = textarea.value;
                            
                            cleanedRow[key] = cleanedValue;
                        } else {
                            cleanedRow[key] = value;
                        }
                    }
                    return cleanedRow;
                });
                
                console.log('üßπ Donn√©es nettoy√©es:', cleanedData);
                displayTablesCsvPreview(cleanedData);
            },
            error: function(error) {
                console.error('‚ùå Erreur parsing CSV:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Erreur de parsing du fichier CSV. V√©rifiez le format.',
                    confirmButtonColor: '#D97706'
                });
            }
        });
    } else {
        // M√©thode fallback am√©lior√©e pour UTF-8
        try {
            const parseCSVLine = (line) => {
                const result = [];
                let current = '';
                let insideQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (insideQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            insideQuotes = !insideQuotes;
                        }
                    } else if (char === ',' && !insideQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current);
                return result;
            };
            
            // Diviser les lignes en tenant compte des sauts de ligne Windows/Unix
            const lines = csvContent.split(/\r\n|\n|\r/).filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Fichier CSV vide ou invalide',
                    confirmButtonColor: '#D97706'
                });
                return;
            }
            
            const headers = parseCSVLine(lines[0]).map(h => {
                let header = h.trim().replace(/^"|"$/g, '');
                // Nettoyer l'UTF-8 dans les en-t√™tes
                header = header
                    .replace(/√É¬©/g, '√©')
                    .replace(/√É¬™/g, '√™')
                    .replace(/√É¬®/g, '√®')
                    .replace(/√É¬ß/g, '√ß')
                    .normalize();
                return header;
            });
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = parseCSVLine(lines[i]).map(v => {
                    let value = v.trim().replace(/^"|"$/g, '');
                    // Nettoyer l'UTF-8 dans les valeurs
                    value = value
                        .replace(/√É¬©/g, '√©')
                        .replace(/√É¬©/g, '')
                        .replace(/√É¬™/g, '√™')
                        .replace(/√É¬®/g, '√®')
                        .replace(/√É¬ß/g, '√ß')
                        .replace(/√É¬¥/g, '√¥')
                        .replace(/√É¬π/g, '√π')
                        .replace(/√É¬Æ/g, '√Æ')
                        .replace(/√É¬¢/g, '√¢')
                        .normalize();
                    
                    // D√©coder les entit√©s HTML
                    const textarea = document.createElement('textarea');
                    textarea.innerHTML = value;
                    value = textarea.value;
                    
                    return value;
                });
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                data.push(row);
            }
            
            console.log('‚úÖ CSV pars√© avec m√©thode fallback:', data);
            displayTablesCsvPreview(data);
            
        } catch (error) {
            console.error('‚ùå Erreur parsing fallback:', error);
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: 'Impossible de lire le fichier CSV. V√©rifiez le format.',
                confirmButtonColor: '#D97706'
            });
        }
    }
}
        // ========== AFFICHAGE DE L'APER√áU CSV ==========
        function displayTablesCsvPreview(data) {
            console.log(`üìä Aper√ßu CSV: ${data.length} ligne(s) trouv√©e(s)`);

            if (data.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Avertissement',
                    text: 'Aucune donn√©e valide trouv√©e dans le fichier',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            tablesCsvRawData = data;

            Swal.fire({
                title: '‚è≥ Chargement...',
                html: '<p>Pr√©paration de la validation...</p>',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: async () => {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    Swal.close();
                    tablesCsvCurrentStep = 1;
                    showTablesCsvStep(2);
                    openTablesCsvEditModal(data);
                }
            });
        }

        // ========== MODAL D'√âDITION CSV (CORRIG√â POUR SUPPRESSION) ==========
// ========== MODAL D'√âDITION CSV (LOGIQUE COMPL√àTE / STYLE INTACT) ==========
// ========== MODAL D'√âDITION CSV (LOGIQUE COMPL√àTE / STYLE INTACT) ==========
function openTablesCsvEditModal(data) {
    const requiredFields = {
        'tableName': { required: true, default: '' },
        'capacity': { required: true, default: '4' },
        'location': { required: false, default: '' },
        'category': { required: false, default: 'general' },
        'description': { required: false, default: '' }
    };

    // Initialisation / Nettoyage
    data.forEach((row, index) => {
        if (!row._id) row._id = `row_${Date.now()}_${index}`;
        if (row._toDelete === undefined) row._toDelete = false;
        Object.keys(requiredFields).forEach(field => {
            if (row[field] === undefined || row[field] === null) row[field] = requiredFields[field].default;
        });
    });

    const headers = ['tableName', 'capacity', 'category', 'location', 'description'];
    const categoryOptions = ['general', 'vip', 'premium', 'standard', 'special', 'organisateur', 'conferencier'];

    let html = `<div style="max-height:80vh;display:flex;flex-direction:column;gap:16px;">`;
    
    // Header (Style Intact)
    html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                <i class="fas fa-file-csv" style="font-size:24px;color:var(--primary)"></i>
                <h3 style="margin:0;color:var(--text-color);font-size:18px;font-weight:700">Import CSV - √âdition des Tables</h3>
             </div>`;

    // Stats Bar (Style Intact)
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:0 12px;">
                <div style="font-weight:600;color:var(--text-color)"><strong>${data.length}</strong> ligne(s) d√©tect√©e(s)</div>
                <div style="font-size:13px;color:var(--text-color); display:flex; flex-direction:row;align-items:end;"> Invalides: <span id="sw_csv_invalid_count_tables" style="color:var(--danger);font-weight:600">0</span> - Valides: <span id="sw_csv_valid_count_tables" style="color:var(--success);font-weight:700;font-size:14px">${data.length}</span><button type="button" id="sw_csv_add_new_row_btn" class="btn btn-success" style="margin-left:15px;flex:1;padding:10px;font-weight:600;"><i class="fas fa-plus"></i> Ajouter une ligne</button></div>
             </div>`;

    const markedForDeletion = data.filter(row => row._toDelete);
    if (markedForDeletion.length > 0) {
        html += `<div id="deletion-section" style="background:rgba(239, 68, 68, 0.1);border:1px solid rgba(239, 68, 68, 0.3);border-radius:6px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div><i class="fas fa-trash" style="color:var(--danger)"></i> <strong>${markedForDeletion.length}</strong> ligne(s) marqu√©e(s) pour suppression</div>
                        <button type="button" id="sw_csv_confirm_delete_btn" class="btn btn-danger btn-sm" style="padding:4px 8px;"><i class="fas fa-check"></i> Confirmer suppression</button>
                    </div>
                 </div>`;
    }

    html += `<div style="overflow-x:auto;flex:1;border:1px solid var(--border-color);border-radius:6px;">`;
    html += `<table class="data-table-pro" style="width:100%;border-collapse:collapse;">`;
    
    html += `<thead><tr style="background:var(--hover-bg);">`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Nom de la Table <span style="color:#ff4444;font-weight:700">*</span></th>`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Capacit√© <span style="color:#ff4444;font-weight:700">*</span></th>`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Cat√©gorie</th>`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Localisation</th>`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Description</th>`;
    html += `<th style="padding:14px;text-align:center;font-weight:600;font-size:13px;width:60px;white-space:nowrap">√âtat</th>`;
    html += `<th style="padding:14px;text-align:center;font-weight:600;font-size:13px;width:80px;white-space:nowrap">Actions</th>`;
    html += `</tr></thead><tbody id="sw_csv_tbody_tables">`;

    // Afficher d'abord les lignes normales, puis les lignes marqu√©es
    const normalRows = data.filter(row => !row._toDelete);
    const deletionRows = data.filter(row => row._toDelete);
    const allRows = [...normalRows, ...deletionRows];

    allRows.forEach((row) => {
        const isMarked = row._toDelete;
        const rowStyle = isMarked ? 'background:rgba(239, 68, 68, 0.08);opacity:0.6;' : '';
        
        html += `<tr id="sw_csv_row_tables_${row._id}" class="csv-data-row" style="border-bottom:1px solid var(--border-color);${rowStyle}">`;
       
        headers.forEach(h => {
            const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : requiredFields[h].default;
            const safeKey = String(h).replace(/[^\w\-]/g, '_');
            const isRequired = requiredFields[h]?.required;
            const reqStyle = isRequired ? 'border:1px solid rgba(255, 68, 68, 0.3);' : '';
            const disabledStyle = isMarked ? 'opacity:0.5;pointer-events:none;' : '';

            if (h === 'category') {
                html += `<td style="padding:10px;"><select ${isMarked ? 'disabled' : ''} data-id="${row._id}" data-key="${h}" id="sw_csv_${row._id}_${safeKey}" class="sw-csv-input form-control" style="width:100%;box-sizing:border-box;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;background:var(--input-bg);color:var(--text-color);${reqStyle}${disabledStyle}">`;
                categoryOptions.forEach(opt => {
                    const selected = val.toLowerCase() === opt ? 'selected' : '';
                    html += `<option value="${opt}" ${selected}>${opt}</option>`;
                });
                html += `</select></td>`;
            } else if (h === 'capacity') {
                html += `<td style="padding:10px;"><input ${isMarked ? 'disabled' : ''} type="number" data-id="${row._id}" data-key="${h}" id="sw_csv_${row._id}_${safeKey}" class="sw-csv-input form-control" value="${escapeHtml(val)}" min="1" style="width:100%;box-sizing:border-box;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;background:var(--input-bg);color:var(--text-color);${reqStyle}${disabledStyle}" /></td>`;
            } else {
                html += `<td style="padding:10px;"><input ${isMarked ? 'disabled' : ''} type="text" data-id="${row._id}" data-key="${h}" id="sw_csv_${row._id}_${safeKey}" class="sw-csv-input form-control" value="${escapeHtml(val)}" style="width:100%;box-sizing:border-box;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;background:var(--input-bg);color:var(--text-color);${reqStyle}${disabledStyle}" /></td>`;
            }
        });
        
        html += `<td style="padding:10px;text-align:center;white-space:nowrap;"><span id="sw_csv_badge_tables_${row._id}" class="badge ${isMarked ? 'bg-secondary' : 'bg-warning'}" style="font-size:14px;padding:6px 8px;">${isMarked ? 'üóëÔ∏è' : '?'}</span></td>`;
        html += `<td style="padding:10px;text-align:center;white-space:nowrap;display:flex;gap:5px;justify-content:space-around;align-items:center;">`;
        
        if (isMarked) {
            html += `<button type="button" class="action-btn btn-sm btn-success sw-csv-restore-row" data-id="${row._id}" style="padding:4px 8px;font-size:12px;" title="Restaurer"><i class="fas fa-undo"></i></button>`;
        } else {
            html += `<button type="button" class="action-btn btn-sm btn-danger delete sw-csv-mark-delete" data-id="${row._id}" style="padding:4px 8px;font-size:12px;" title="Marquer pour suppression"><i class="fas fa-trash"></i></button>`;
            html += `<button type="button" class="action-btn btn-success success sw-csv-add-after" data-id="${row._id}" style="padding:4px 8px;font-size:12px;" title="Ajouter apr√®s"><i class="fas fa-plus"></i></button>`;
        }
        
        html += `</td>`;
        html += `</tr>`;
        
        // Ligne d'erreurs (seulement pour les lignes non marqu√©es)
        if (!isMarked) {
            html += `<tr id="sw_csv_errors_tables_${row._id}" class="table-row-errors" style="display:none;border-bottom:1px solid var(--border-color);background:rgba(239, 68, 68, 0.05);border-left: 3px solid rgb(239, 68, 68);">`;
            html += `<td colspan="${headers.length + 3}" style="padding:8px 10px;">`;
            html += `<div id="sw_csv_errors_content_tables_${row._id}" style="font-size:12px;display:flex;gap:12px;flex-wrap:wrap;"></div>`;
            html += `</td>`;
            html += `</tr>`;
        }
    });

    html += `</tbody></table></div>`;

    html += `<div style="background:rgba(59, 130, 246, 0.05);padding:10px 12px;border-radius:4px;font-size:12px;color:var(--text-color);border-left:3px solid var(--info);margin-top:12px;">`;
    html += `<i class="fas fa-circle-info"></i> <strong>Conseils:</strong> Les champs marqu√©s d'un * sont obligatoires. Utilisez les boutons dans la colonne Actions pour ajouter ou supprimer des lignes.`;
    html += `</div>`;

    html += `</div>`;

    Swal.fire({
        title: '',
        html,
        width: '95%',
        showCancelButton: true,
        confirmButtonText: 'Continuer vers validation',
        cancelButtonText: 'Annuler',
        confirmButtonColor: 'var(--primary)',
        cancelButtonColor: '#888',
        didOpen: () => {
            const popup = Swal.getPopup();

            // Fonction pour rafra√Æchir les marques de validation
            const refreshValidationMarks = () => {
                let invalid = 0;
                let valid = 0;

                data.forEach((row) => {
                    if (row._toDelete) return; // Ignorer les lignes marqu√©es pour suppression
                    
                    const errors = [];
                    const tableName = row['tableName']?.trim();
                    const capacity = row['capacity']?.trim();
                    
                    if (!tableName) errors.push('<i class="fas fa-exclamation-circle"></i> Nom de la table requis');
                    else if (tableName.length < 2) errors.push('<i class="fas fa-exclamation-circle"></i> Nom min. 2 caract√®res');
                    
                    if (!capacity || isNaN(parseInt(capacity))) errors.push('<i class="fas fa-exclamation-circle"></i> Capacit√© invalide');
                    else if (parseInt(capacity) < 1) errors.push('<i class="fas fa-exclamation-circle"></i> Capacit√© minimum: 1');

                    const isValid = errors.length === 0;
                    
                    const tr = document.getElementById(`sw_csv_row_tables_${row._id}`);
                    const badgeEl = document.getElementById(`sw_csv_badge_tables_${row._id}`);
                    const errorRow = document.getElementById(`sw_csv_errors_tables_${row._id}`);
                    const errorContent = document.getElementById(`sw_csv_errors_content_tables_${row._id}`);
                    
                    if (tr) {
                        if (!isValid) {
                            tr.style.background = 'rgba(239, 68, 68, 0.08)';
                            tr.style.borderLeft = '3px solid #ef4444';
                            if (badgeEl) {
                                badgeEl.className = 'badge bg-danger';
                                badgeEl.innerHTML = '<i class="fas fa-xmark" style="font-size:16px;color:#ef4444;"></i>';
                            }
                            invalid++;
                        } else {
                            tr.style.background = 'rgba(16, 185, 129, 0.08)';
                            tr.style.borderLeft = '3px solid #10b981';
                            if (badgeEl) {
                                badgeEl.className = 'badge bg-success';
                                badgeEl.innerHTML = '<i class="fas fa-check" style="font-size:16px;color:#10b981;"></i>';
                            }
                            valid++;
                        }
                    }

                    // Affichage/masquage ligne d'erreurs
                    if (errorRow) {
                        if (errors.length > 0) {
                            errorRow.style.display = 'table-row';
                            if (errorContent) {
                                errorContent.innerHTML = errors.map(e => `<span style="background:rgba(239, 68, 68, 0.2);padding:4px 8px;border-radius:4px;border-left:2px solid #ef4444;">${e}</span>`).join('');
                            }
                        } else {
                            errorRow.style.display = 'none';
                        }
                    }
                });

                const invalidCountEl = popup.querySelector('#sw_csv_invalid_count_tables');
                const validCountEl = popup.querySelector('#sw_csv_valid_count_tables');
                
                if (invalidCountEl) invalidCountEl.textContent = String(invalid);
                if (validCountEl) validCountEl.textContent = String(valid);
            };

            // Event listeners pour les inputs
            const inputs = popup.querySelectorAll('.sw-csv-input:not([disabled])');
            inputs.forEach(inp => {
                inp.addEventListener('change', () => {
                    const row = data.find(r => r._id === inp.dataset.id);
                    if (row) {
                        row[inp.dataset.key] = inp.value;
                        refreshValidationMarks();
                    }
                });
                inp.addEventListener('input', () => {
                    const row = data.find(r => r._id === inp.dataset.id);
                    if (row) {
                        row[inp.dataset.key] = inp.value;
                        refreshValidationMarks();
                    }
                });
            });

            // Event listeners pour ajouter/supprimer des lignes
            const markDeleteButtons = popup.querySelectorAll('.sw-csv-mark-delete');
            const addAfterButtons = popup.querySelectorAll('.sw-csv-add-after');
            const restoreButtons = popup.querySelectorAll('.sw-csv-restore-row');

            // Marquer pour suppression
            markDeleteButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const row = data.find(r => r._id === btn.dataset.id);
                    if (row) {
                        row._toDelete = true;
                        Swal.close();
                        setTimeout(() => {
                            openTablesCsvEditModal(data);
                        }, 50);
                    }
                });
            });

            // Ajouter apr√®s une ligne
            addAfterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = data.findIndex(r => r._id === btn.dataset.id);
                    const newRow = {
                        _id: `row_${Date.now()}_${data.length}`,
                        _toDelete: false,
                        tableName: '',
                        capacity: '4',
                        location: '',
                        category: 'general',
                        description: ''
                    };
                    data.splice(idx + 1, 0, newRow);
                    Swal.close();
                    setTimeout(() => {
                        openTablesCsvEditModal(data);
                    }, 50);
                });
            });

            // Restaurer une ligne
            restoreButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const row = data.find(r => r._id === btn.dataset.id);
                    if (row) {
                        row._toDelete = false;
                        Swal.close();
                        setTimeout(() => {
                            openTablesCsvEditModal(data);
                        }, 50);
                    }
                });
            });

            // Ajouter une ligne √† la fin
            const addNewRowBtn = popup.querySelector('#sw_csv_add_new_row_btn');
            if (addNewRowBtn) {
                addNewRowBtn.addEventListener('click', () => {
                    const newRow = {
                        _id: `row_${Date.now()}_${data.length}`,
                        _toDelete: false,
                        tableName: '',
                        capacity: '4',
                        location: '',
                        category: 'general',
                        description: ''
                    };
                    data.push(newRow);
                    Swal.close();
                    setTimeout(() => {
                        openTablesCsvEditModal(data);
                    }, 50);
                });
            }

            // Confirmer la suppression d√©finitive
            const confirmDeleteBtn = popup.querySelector('#sw_csv_confirm_delete_btn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', () => {
                    Swal.close();
                    // Filtrer pour garder seulement les lignes non marqu√©es
                    const filteredData = data.filter(row => !row._toDelete);
                    
                    if (filteredData.length === 0) {
                        // Retour √† l'√©tape 1 si plus de donn√©es
                        tablesCsvCurrentStep = 1;
                        showTablesCsvStep(1);
                        
                        // R√©initialiser le fichier input
                        const csvFileInput = document.getElementById('tablesCsvFileInput');
                        if (csvFileInput) {
                            csvFileInput.value = '';
                        }
                        
                        Swal.fire({
                            icon: 'info',
                            title: 'Import annul√©',
                            text: 'Toutes les lignes ont √©t√© supprim√©es. Vous pouvez relancer un import.',
                            confirmButtonColor: 'var(--primary)'
                        });
                    } else {
                        setTimeout(() => {
                            openTablesCsvEditModal(filteredData);
                        }, 50);
                    }
                });
            }

            // Initialiser la validation
            refreshValidationMarks();
        },
        preConfirm: () => {
            // Filtrer les lignes marqu√©es pour suppression
            const filteredData = data.filter(row => !row._toDelete);
            
            // V√©rifier qu'il n'y a pas d'erreurs
            let hasErrors = false;
            filteredData.forEach(row => {
                if (!row.tableName || row.tableName.trim().length < 2) hasErrors = true;
                if (!row.capacity || parseInt(row.capacity) < 1) hasErrors = true;
            });
            
            if (hasErrors) {
                Swal.showValidationMessage('Veuillez corriger toutes les erreurs avant de continuer');
                return false;
            }
            
            // Nettoyer les donn√©es (enlever _id et _toDelete)
            const cleanData = filteredData.map(row => {
                const { _id, _toDelete, ...cleanRow } = row;
                return cleanRow;
            });
            
            return cleanData;
        }
    }).then((res) => {
        if (res.isConfirmed) {
            // Mettre √† jour les donn√©es globales
            tablesCsvRawData = res.value;
            prepareTablesCsvValidationStep();
        } else if (res.isDismissed) {
            // Annuler - retour √† l'√©tape 1
            tablesCsvCurrentStep = 1;
            showTablesCsvStep(1);
            tablesCsvRawData = [];
            tablesCsvValidatedData = [];
            
            // R√©initialiser le fichier input
            const csvFileInput = document.getElementById('tablesCsvFileInput');
            if (csvFileInput) {
                csvFileInput.value = '';
            }
        }
    });
}
        // ========== √âTAPE DE VALIDATION ==========
        function prepareTablesCsvValidationStep() {
            console.log('üîÑ Pr√©paration de l\'√©tape 2: validation');

            tablesCsvCurrentStep = 2;
            showTablesCsvStep(2);

            tablesCsvValidatedData = tablesCsvRawData.map((row, idx) => {
                const tableName = row['tableName']?.trim();
                const capacity = parseInt(row['capacity'] || '4') || 4;
                const location = row['location']?.trim() || '';
                const category = row['category']?.toLowerCase()?.trim() || 'general';
                const description = row['description']?.trim() || '';

                const errors = [];
                if (!tableName) errors.push('Nom de la table requis');
                else if (tableName.length < 2) errors.push('Nom min. 2 caract√®res');
                
                if (!capacity || capacity < 1) errors.push('Capacit√© invalide');

                const isValid = errors.length === 0;

                return {
                    index: idx,
                    tableName,
                    capacity: Math.max(1, capacity),
                    location,
                    category,
                    description,
                    isValid,
                    errors
                };
            });

            renderTablesCsvValidationWithSwal();
        }

        // ========== AFFICHAGE VALIDATION ==========
        function renderTablesCsvValidationWithSwal() {
            const validCount = tablesCsvValidatedData.filter(r => r.isValid).length;
            const invalidCount = tablesCsvValidatedData.filter(r => !r.isValid).length;

            let html = `<div style="max-height:75vh; overflow:auto;">`;

            html += `<div style="display:flex;gap:20px;margin-bottom:15px;padding:12px;background:var(--primary);border-radius:8px;color:white">`;
            html += `<div style="flex:1;text-align:center"><div style="font-size:12px;opacity:0.8"><i class="fas fa-check-circle"></i> Valides</div><div style="font-weight:600;font-size:18px">${validCount}</div></div>`;
            html += `<div style="flex:1;text-align:center"><div style="font-size:12px;opacity:0.8"><i class="fas fa-times-circle"></i> Invalides</div><div style="font-weight:600;font-size:18px">${invalidCount}</div></div>`;
            html += `<div style="flex:1;text-align:center"><div style="font-size:12px;opacity:0.8"><i class="fas fa-file-csv"></i> Total</div><div style="font-weight:600;font-size:18px">${tablesCsvValidatedData.length}</div></div>`;
            html += `</div>`;

            html += `<div class="guests-table-pro" style="margin:0;overflow:hidden">`;
            html += `<table class="data-table-pro">`;
            html += `<thead><tr style="background:var(--primary);color:white;position:sticky;top:0;z-index:10">`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:18%">Nom Table</th>`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:12%">Capacit√©</th>`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:15%">Cat√©gorie</th>`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:20%">Localisation</th>`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:25%">Description</th>`;
            html += `<th style="padding:12px;text-align:center;font-weight:600;font-size:12px;width:6%">‚úì</th>`;
            html += `</tr></thead><tbody>`;

            tablesCsvValidatedData.forEach((row, i) => {
                const rowBg = row.isValid ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)';
                html += `<tr id="csv-val-row-tables-${i}" class="guest-row-pro" style="background:${rowBg}">`;
                
                html += `<td style="padding:10px"><input data-idx="${i}" data-field="tableName" class="csv-val-input form-control" value="${escapeHtml(row.tableName || '')}" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)" /></td>`;
                html += `<td style="padding:10px"><input type="number" data-idx="${i}" data-field="capacity" class="csv-val-input form-control" value="${row.capacity || 4}" min="1" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)" /></td>`;
                
                html += `<td style="padding:10px"><select data-idx="${i}" data-field="category" class="csv-val-input form-control" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)">`;
                const categoryOptions = ['general', 'vip', 'premium', 'standard', 'special', 'organisateur', 'conferencier'];
                categoryOptions.forEach(cat => {
                    const selected = (row.category || 'general') === cat ? 'selected' : '';
                    const label = cat.charAt(0).toUpperCase() + cat.slice(1);
                    html += `<option value="${cat}" ${selected}>${label}</option>`;
                });
                html += `</select></td>`;
                
                html += `<td style="padding:10px"><input data-idx="${i}" data-field="location" class="csv-val-input form-control" value="${escapeHtml(row.location || '')}" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)" /></td>`;
                html += `<td style="padding:10px"><input data-idx="${i}" data-field="description" class="csv-val-input form-control" value="${escapeHtml(row.description || '')}" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)" /></td>`;
                
                html += `<td style="padding:10px;text-align:center"><span id="csv-val-badge-tables-${i}" class="badge ${row.isValid ? 'bg-success' : 'bg-danger'}" style="font-size:10px;padding:4px 6px">${row.isValid ? '‚úì' : '‚úó'}</span></td>`;
                html += `</tr>`;
            });

            html += `</tbody></table></div></div>`;

            Swal.fire({
                title: '<i class="fas fa-check-double"></i> Validation & √âdition compl√®te',
                html,
                width: '98%',
                showCancelButton: true,
                confirmButtonText: 'Continuer vers confirmation',
                cancelButtonText: 'Annuler',
                didOpen: () => {
                    const inputs = Swal.getPopup().querySelectorAll('.csv-val-input');

                    inputs.forEach(inp => {
                        inp.addEventListener('change', () => {
                            const idx = parseInt(inp.dataset.idx);
                            const field = inp.dataset.field;

                            if (field === 'capacity') {
                                tablesCsvValidatedData[idx][field] = parseInt(inp.value) || 4;
                            } else {
                                tablesCsvValidatedData[idx][field] = inp.value;
                            }

                            const row = tablesCsvValidatedData[idx];
                            const errors = [];

                            if (!row.tableName || row.tableName.trim().length < 2) errors.push('Nom de la table requis (min 2 caract√®res)');
                            if (!row.capacity || parseInt(row.capacity) < 1) errors.push('Capacit√© invalide (min 1)');

                            row.isValid = errors.length === 0;
                            row.errors = errors;

                            const tr = document.getElementById(`csv-val-row-tables-${idx}`);
                            const badge = document.getElementById(`csv-val-badge-tables-${idx}`);

                            if (tr) {
                                tr.style.background = row.isValid ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)';
                            }

                            if (badge) {
                                badge.className = `badge ${row.isValid ? 'bg-success' : 'bg-danger'}`;
                                badge.textContent = row.isValid ? '‚úì' : '‚úó';
                            }
                        });
                    });
                },
                preConfirm: () => {
                    const inputs = Swal.getPopup().querySelectorAll('.csv-val-input');
                    inputs.forEach(inp => {
                        const idx = parseInt(inp.dataset.idx);
                        const field = inp.dataset.field;
                        if (field === 'capacity') {
                            tablesCsvValidatedData[idx][field] = parseInt(inp.value) || 4;
                        } else {
                            tablesCsvValidatedData[idx][field] = inp.value;
                        }
                    });
                    return true;
                }
            }).then((res) => {
                if (res.isConfirmed) {
                    prepareTablesCsvConfirmationStep();
                } else if (res.isDismissed) {
                    // Annuler - retour √† l'√©tape 1
                    tablesCsvCurrentStep = 1;
                    showTablesCsvStep(1);
                    tablesCsvRawData = [];
                    tablesCsvValidatedData = [];
                    
                    // R√©initialiser le fichier input
                    const csvFileInput = document.getElementById('tablesCsvFileInput');
                    if (csvFileInput) {
                        csvFileInput.value = '';
                    }
                }
            });
        }

        // ========== √âTAPE DE CONFIRMATION ==========
        function prepareTablesCsvConfirmationStep() {
            console.log('üîÑ Pr√©paration de l\'√©tape 3: confirmation');

            tablesCsvCurrentStep = 3;
            showTablesCsvStep(3);

            const validRows = tablesCsvValidatedData.filter(r => r.isValid);
            const invalidRows = tablesCsvValidatedData.filter(r => !r.isValid);

            if (validRows.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Avertissement',
                    text: 'Aucune table valide √† importer',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            let html = `<div style="text-align:left;max-height:70vh;overflow:auto;">`;

            html += `<div style="display:flex;gap:20px;margin-bottom:15px;padding:12px;background:var(--hover-bg);border-radius:8px;">`;
            html += `<div><div style="font-size:12px;opacity:0.7">√Ä importer</div><div style="font-weight:600;color:var(--success);font-size:18px">${validRows.length}</div></div>`;
            if (invalidRows.length > 0) {
                html += `<div><div style="font-size:12px;opacity:0.7">Invalides</div><div style="font-weight:600;color:var(--danger);font-size:18px">${invalidRows.length}</div></div>`;
            }
            html += `<div><div style="font-size:12px;opacity:0.7">√âv√©nement</div><div style="font-weight:600;font-size:14px">${escapeHtml(tablesCsvEventSelected.name)}</div></div>`;
            html += `</div>`;

            html += `<div style="border:1px solid var(--border-color);border-radius:8px;overflow:hidden;">`;
            html += `<table style="width:100%;border-collapse:collapse">`;
            html += `<thead><tr style="background:var(--hover-bg);position:sticky;top:0;">`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px;width:18%">Nom Table</th>`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px;width:12%">Capacit√©</th>`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px;width:15%">Cat√©gorie</th>`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px;width:25%">Localisation</th>`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px">Description</th>`;
            html += `</tr></thead><tbody>`;

            validRows.forEach(row => {
                html += `<tr style="border-bottom:1px solid var(--border-color)">`;
                html += `<td style="padding:10px"><strong>${escapeHtml(row.tableName)}</strong></td>`;
                html += `<td style="padding:10px">${row.capacity}</td>`;
                html += `<td style="padding:10px"><span style="text-transform:uppercase;font-weight:600;color:var(--primary);font-size:12px">${escapeHtml(row.category || 'general')}</span></td>`;
                html += `<td style="padding:10px">${escapeHtml(row.location || '‚Äî')}</td>`;
                html += `<td style="padding:10px;font-size:12px;opacity:0.8">${escapeHtml(row.description || '‚Äî')}</td>`;
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;

            if (invalidRows.length > 0) {
                html += `<div style="margin-top:12px;padding:10px;background:#fef08a;border:1px solid #fcd34d;border-radius:6px;font-size:12px">`;
                html += `<strong>‚ö†Ô∏è ${invalidRows.length} table(s) invalide(s)</strong> ne seront pas import√©es.`;
                html += `</div>`;
            }

            html += `</div>`;

            Swal.fire({
                title: 'Confirmation de l\'import',
                html,
                width: '90%',
                showCancelButton: true,
                confirmButtonText: 'Confirmer & Importer',
                cancelButtonText: 'Retour √† l\'√©dition',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280'
            }).then((res) => {
                if (res.isConfirmed) {
                    performTablesCsvImport();
                } else if (res.isDismissed) {
                    // Retour √† l'√©dition - √©tape 2
                    renderTablesCsvValidationWithSwal();
                }
            });
        }

        // ========== IMPORT FINAL ==========
        async function performTablesCsvImport() {
            console.log('üì• Ex√©cution de l\'import final');

            tablesCsvCurrentStep = 4;
            showTablesCsvStep(3);

            const validRows = tablesCsvValidatedData.filter(r => r.isValid);

            if (validRows.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Aucune table valide √† importer',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            const progressSwal = Swal.fire({
                title: 'Importation en cours...',
                html: `
                    <div style="text-align: center;">
                        <div class="progress" style="height: 30px; border-radius: 8px; overflow: hidden; margin-bottom: 15px; background: var(--hover-bg);">
                            <div id="tablesCsvImportProgressBar" class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.3s ease;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span style="color:white;font-weight:600;font-size:14px">0%</span>
                            </div>
                        </div>
                        <div id="tablesCsvImportStatus" style="font-size:14px;margin-bottom:10px;">Pr√©paration...</div>
                        <div id="tablesCsvImportCount" style="font-size:12px;color:#6b7280">0/<strong>${validRows.length}</strong></div>
                    </div>
                `,
                icon: 'info',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: async () => {
                    await performTablesActualImport(validRows);
                }
            });
        }

        async function performTablesActualImport(validRows) {
            let importedCount = 0;
            let failedCount = 0;

            try {
                for (let i = 0; i < validRows.length; i++) {
                    const row = validRows[i];
                    const progress = Math.round(((i + 1) / validRows.length) * 100);

                    const progressBar = document.getElementById('tablesCsvImportProgressBar');
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                        progressBar.innerHTML = `<span style="color:white;font-weight:600;font-size:14px">${progress}%</span>`;
                    }

                    const statusEl = document.getElementById('tablesCsvImportStatus');
                    if (statusEl) {
                        statusEl.textContent = `Table "${row.tableName}"...`;
                    }

                    const countEl = document.getElementById('tablesCsvImportCount');
                    if (countEl) {
                        countEl.innerHTML = `${i + 1}/<strong>${validRows.length}</strong>`;
                    }

                    try {
                        const tableData = {
                            eventId: tablesCsvEventSelected.id,
                            tableName: row.tableName || `Table ${i + 1}`,
                            capacity: Math.max(1, row.capacity || 4),
                            category: row.category || 'general',
                            location: row.location || '',
                            description: row.description || '',
                            createdAt: new Date().toISOString()
                        };

                        const table = await storage.createTable(tablesCsvEventSelected.id,tableData);
                        if (table) {
                            importedCount++;
                        }
                    } catch (err) {
                        console.error(`‚ùå Erreur cr√©ation table ligne ${i}:`, err);
                        failedCount++;
                    }

                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                await Swal.close();

                await Swal.fire({
                    icon: importedCount > 0 ? 'success' : 'error',
                    title: importedCount > 0 ? 'Import termin√© !' : 'Erreur lors de l\'import',
                    html: `
                        <div style="text-align:center;padding:20px">
                            <div style="font-size:48px;margin-bottom:15px">
                                ${importedCount > 0 ? '‚úÖ' : '‚ùå'}
                            </div>
                            <h3 style="margin-bottom:5px;color:var(--text-color)">R√©sum√© de l'import</h3>
                            <div style="margin:15px 0;font-size:14px">
                                <div style="padding:8px;border-radius:6px;margin-bottom:8px">
                                    <strong style="color:var(--success);font-size:16px">${importedCount}</strong> table(s) import√©e(s) avec succ√®s
                                </div>
                                ${failedCount > 0 ? `
                                <div style="padding:8px;border-radius:6px">
                                    <strong style="color:#b45309;font-size:16px">${failedCount}</strong> table(s) en erreur
                                </div>
                                ` : ''}
                            </div>
                            <div style="margin-top:15px;font-size:12px;color:#6b7280">
                                <i class="fas fa-info-circle"></i> Les tables ont √©t√© ajout√©es √† l'√©v√©nement <strong>${escapeHtml(tablesCsvEventSelected.name)}</strong>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Fermer',
                    confirmButtonColor: '#D97706'
                });

                if (importedCount > 0) {
                    await loadTables();
                }

                closeTablesCsvImportModal();

            } catch (error) {
                console.error('‚ùå Erreur globale import:', error);
                await Swal.close();
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur fatale',
                    text: 'L\'import a √©t√© interrompu. Veuillez r√©essayer.',
                    confirmButtonColor: '#D97706'
                });
            }
        }

        // ========== T√âL√âCHARGEMENT TEMPLATE CSV ==========
       // ========== T√âL√âCHARGEMENT TEMPLATE CSV AM√âLIOR√â ==========
function downloadTablesCsvTemplate() {
    console.log('üì• T√©l√©chargement du template CSV pour tables');
    
    const csvContent = `tableName,capacity,location,category,description
Table A,4,Salle Principale,general,Table standard pour 4 personnes
Table VIP,6,√âtage 1 - C√¥t√© fen√™tres,vip,Table VIP avec vue directe sur la sc√®ne
Table Premium,8,√âtage 1 - Centre,premium,Table premium centrale
Table Standard,4,Salle Principale,standard,Table standard suppl√©mentaire
Table Cocktail,2,Bar,special,Table haute pour cocktails`;

    // Cr√©er avec BOM UTF-8 pour Excel
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { 
        type: 'text/csv;charset=utf-8;' 
    });
    
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'modele-tables-utf8.csv';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    Swal.fire({
        icon: 'success',
        title: 'Mod√®le t√©l√©charg√©',
        html: `Le fichier mod√®le a √©t√© t√©l√©charg√© avec succ√®s.<br><small>Format UTF-8 compatible avec Excel</small>`,
        timer: 2000,
        showConfirmButton: false
    });
}

        // ========== AFFICHAGE √âTAPE CSV ==========
        function showTablesCsvStep(step) {
            console.log(`üìä Affichage √©tape CSV tables: ${step}`);

            tablesCsvCurrentStep = step;

            const modal = document.getElementById('tablesCsvImportModal');
            if (modal) {
                modal.querySelectorAll('.creation-step-content').forEach((el, idx) => {
                    el.classList.remove('active');
                });

                const stepContent = document.getElementById(`tablesCsvStep${step}Content`);
                if (stepContent) {
                    stepContent.classList.add('active');
                }

                // Mise √† jour indicateurs de progression
                modal.querySelectorAll('.vertical-step').forEach((el, idx) => {
                    el.classList.remove('active', 'completed');
                    if (idx + 1 < step) el.classList.add('completed');
                    if (idx + 1 === step) el.classList.add('active');
                });

                // Mise √† jour barre de progression
                const progress = (step / 3) * 100;
                const progressBar = document.getElementById('tablesCsvProgressBar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }

                const progressText = document.getElementById('tablesCsvProgressText');
                if (progressText) {
                    progressText.textContent = `√âtape ${step}/3`;
                }
            }
        }

        // ========== FONCTION UTILITAIRE ==========
                function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            
            let str = String(text);
            
            str = str.replace(/[&<>"']/g, m => map[m]);
            
            str = str
                .replace(/√É¬©/g, '√©')
                .replace(/√É¬™/g, '√™')
                .replace(/√É¬®/g, '√®')
                .replace(/√É¬ß/g, '√ß')
                .replace(/√É¬¥/g, '√¥')
                .replace(/√É¬π/g, '√π')
                .replace(/√É¬Æ/g, '√Æ')
                .replace(/√É¬¢/g, '√¢')
                .replace(/√É¬®/g, '√®')
                .replace(/√É/g, '√©');
            
            return str;
        }
        // ========== INITIALISATION ==========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTablesCsvImport);
        } else {
            initializeTablesCsvImport();
        }

    </script>








met a jour de manier ultra comple en impleemntant la plupart des methode come afficher eveneme selectonne integralementa cu omeplet ici dans galleries.html :

 
    <script>
        // ============================================
        // üéØ GESTION DES GALERIES - STORAGE INT√âGR√â
        // ============================================

        // Variables globales
        let currentEvent = null;
        let currentUser = null;
        let eventsList = [];
        let currentGallery = null;
        let allGalleries = [];
        let galleryPhotos = [];
        let filteredGalleries = [];
        let filteredPhotos = [];
        let currentView = 'grid';
        let currentFilter = 'all';
        let currentPhotoFilter = 'all';
        let currentSearch = '';
        let currentGallerySearch = '';
        let currentPage = 1;
        const galleriesPerPage = 12;
        const photosPerPage = 20;
        let eventsViewMode = 'grid';
        let moderationPhotos = [];
        let currentModerationIndex = 0;
        let uploadedPhotos = [];
        let galleryCoverFile = null;
        let currentCreationStep = 1;

        // Images par d√©faut pour les galeries
        const GALLERY_IMAGES = {
            general: 'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?w=400&h=300&fit=crop',
            vip: 'https://images.unsplash.com/photo-1516450360452-9312f5e86fc7?w=400&h=300&fit=crop',
            backstage: 'https://images.unsplash.com/photo-1492684223066-e9e4aab4d25e?w=400&h=300&fit=crop',
            official: 'https://images.unsplash.com/photo-1533174072545-7a4b6ad7a6c3?w=400&h=300&fit=crop',
            guest: 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=400&h=300&fit=crop',
            behind_scenes: 'https://images.unsplash.com/photo-1519167758481-83f550bb49b3?w=400&h=300&fit=crop'
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
  
            setupEventListeners();
            setupCustomEventListeners();
            loadEvents();
        });

    
        function setupEventListeners() {
            // Navigation
            document.getElementById('backToEventsBtn')?.addEventListener('click', showEventsHome);
            document.getElementById('backToGalleriesBtn')?.addEventListener('click', showGalleriesView);
            
            // Boutons cr√©ation
            document.getElementById('createGalleryBtn')?.addEventListener('click', showCreateGalleryModal);
            document.getElementById('createGalleryActionBtn')?.addEventListener('click', showCreateGalleryModal);
            document.getElementById('createGalleryListBtn')?.addEventListener('click', showCreateGalleryModal);
            document.getElementById('createFirstGallery')?.addEventListener('click', showCreateGalleryModal);
            document.getElementById('createFirstGalleryList')?.addEventListener('click', showCreateGalleryModal);
            
            // Navigation modale cr√©ation
            document.getElementById('nextToStep2Btn')?.addEventListener('click', () => navigateToStep(2));
            document.getElementById('nextToStep3Btn')?.addEventListener('click', () => navigateToStep(3));
            document.getElementById('nextToStep4Btn')?.addEventListener('click', () => navigateToStep(4));
            document.getElementById('backToStep1Btn')?.addEventListener('click', () => navigateToStep(1));
            document.getElementById('backToStep2Btn')?.addEventListener('click', () => navigateToStep(2));
            document.getElementById('backToStep3Btn')?.addEventListener('click', () => navigateToStep(3));
            
            document.getElementById('closeGalleryModalBtn')?.addEventListener('click', closeCreateGalleryModal);
            document.getElementById('cancelGalleryBtn')?.addEventListener('click', closeCreateGalleryModal);
            document.getElementById('submitGalleryBtn')?.addEventListener('click', createGallery);
            
            // Upload cover
            document.getElementById('galleryCoverUpload')?.addEventListener('click', () => {
                document.getElementById('galleryCoverFile').click();
            });
            
            document.getElementById('galleryCoverFile')?.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleGalleryCoverSelect(e.target.files[0]);
                }
            });
            
            // Filtres
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    if (filter) {
                        setGalleryFilter(filter);
                    }
                    
                    const photoFilter = this.getAttribute('data-photo-filter');
                    if (photoFilter) {
                        setPhotoFilter(photoFilter);
                    }
                });
            });
            
            // Recherche
            document.getElementById('searchGalleries')?.addEventListener('input', debounce(searchGalleries, 300));
            document.getElementById('searchPhotos')?.addEventListener('input', debounce(searchPhotos, 300));
            
            // Vue toggle
            document.querySelectorAll('.view-btn[data-view]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const view = this.getAttribute('data-view');
                    setGalleryView(view);
                });
            });
            
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const mode = this.getAttribute('data-mode');
                    setEventsViewMode(mode);
                });
            });
            
            // Actions photos
            document.getElementById('addPhotosBtn')?.addEventListener('click', showAddPhotosModal);
            document.getElementById('addFirstPhotoBtn')?.addEventListener('click', showAddPhotosModal);
            document.getElementById('moderationBtn')?.addEventListener('click', showModerationModal);
            document.getElementById('viewAllPhotosBtn')?.addEventListener('click', viewAllPhotos);
            
            // D√©connexion
            document.getElementById('logout-btn')?.addEventListener('click', () => {
                storage.logout();
                window.location.href = 'index.html';
            });
            
            // Drag and drop pour cover
            setupCoverUploadDragAndDrop();
        }

        function setupCoverUploadDragAndDrop() {
            const coverUpload = document.getElementById('galleryCoverUpload');
            if (!coverUpload) return;
            
            coverUpload.addEventListener('dragover', (e) => {
                e.preventDefault();
                coverUpload.classList.add('dragover');
            });
            
            coverUpload.addEventListener('dragleave', () => {
                coverUpload.classList.remove('dragover');
            });
            
            coverUpload.addEventListener('drop', (e) => {
                e.preventDefault();
                coverUpload.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleGalleryCoverSelect(files[0]);
                }
            });
        }

        // ============================================
        // üéØ CONFIGURATION DES CUSTOM EVENTS (STORAGE)
        // ============================================

        function setupCustomEventListeners() {
           
            storage.on('gallery:created', (gallery) => {
                console.log('üéâ Galerie cr√©√©e:', gallery.id);
                if (currentEvent?.id === gallery.eventId) {
                    loadGalleries();
                }
            });

            storage.on('gallery:updated', (gallery) => {
                console.log('üìù Galerie modifi√©e:', gallery.id);
                if (currentEvent?.id === gallery.eventId) {
                    loadGalleries();
                }
            });

            storage.on('gallery:deleted', (data) => {
                console.log('üóëÔ∏è Galerie supprim√©e:', data.id);
                if (currentEvent?.id === data.eventId) {
                    loadGalleries();
                }
            });

            // √âv√©nements photos
            storage.on('photo:added', (photo) => {
                console.log('üì∏ Photo ajout√©e:', photo.id);
                if (currentGallery?.id === photo.galleryId) {
                    loadPhotos();
                }
            });

            storage.on('photo:deleted', (data) => {
                console.log('üóëÔ∏è Photo supprim√©e:', data.id);
                if (currentGallery?.id === data.galleryId) {
                    loadPhotos();
                }
            });

            storage.on('photo:approved', (data) => {
                console.log('‚úÖ Photo approuv√©e:', data.id);
                if (currentGallery?.id === data.galleryId) {
                    loadPhotos();
                }
            });

            storage.on('photo:rejected', (data) => {
                console.log('‚ùå Photo rejet√©e:', data.id);
                if (currentGallery?.id === data.galleryId) {
                    loadPhotos();
                }
            });

            // √âv√©nements likes et commentaires
            storage.on('like:added', (data) => {
                console.log('‚ù§Ô∏è Like ajout√© pour photo:', data.photoId);
            });

            storage.on('comment:added', (comment) => {
                console.log('üí¨ Commentaire ajout√©:', comment.id);
            });
        }



         // Charger la liste des √©v√©nements
        async function loadEventsList() {
            try {
                eventsList = await storage.getAllEvents();
                currentUser = await storage.getProfile();
                
                if (currentUser.role !== 'admin') {
                    eventsList = eventsList.filter(event => 
                        event.organizerId == currentUser.id
                    );
                }
            
                if (eventsList.length === 0) {
                    document.getElementById('emptyEventsState').style.display = 'flex';
                    document.getElementById('eventsGridView').style.display = 'none';
                    document.getElementById('eventsTableView').style.display = 'none';
                    return;
                }
                
                document.getElementById('emptyEventsState').style.display = 'none';
                renderEventsList();
                
            } catch (error) {
                console.error('Erreur chargement √©v√©nements:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de charger la liste des √©v√©nements',
                    confirmButtonColor: '#D97706'
                });
            }
        }


        // ============================================
        // üéØ GESTION DES √âV√âNEMENTS
        // ============================================

        async function loadEvents() {
            try {
                showLoading('eventsLoader');
                
                // Utiliser storage pour charger les √©v√©nements
                eventsList = await storage.getAllEvents() || [];
                
                if (!eventsList || eventsList.length === 0) {
                    eventsList = [];
                }
                
                displayEvents();
                checkEmptyState();
                hideLoading('eventsLoader');
            } catch (error) {
                console.error('Erreur chargement √©v√©nements:', error);
                eventsList = [];
                displayEvents();
                checkEmptyState();
                hideLoading('eventsLoader');
                showToast('Erreur lors du chargement des √©v√©nements', 'error');
            }
        }

        function displayEvents() {
            displayEventsGrid();
            displayEventsTable();
        }

        function displayEventsGrid() {
            const container = document.getElementById('eventsGridView');
            if (!container) return;
            
            if (eventsList.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = eventsList.map(event => {
                const eventDate = new Date(event.date);
                const isUpcoming = eventDate >= new Date();
                
                return `
                    <div class="event-mini-card" data-event-id="${event.id}">
                        ${isUpcoming ? '<div class="upcoming-ribbon" style="background: linear-gradient(45deg, #3B82F6, #8B5CF6);">√Ä VENIR</div>' : ''}
                        
                        <div class="event-mini-header">
                            <div class="event-mini-title">${escapeHtml(event.name)}</div>
                            <div class="event-mini-meta">
                                <div class="event-mini-meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    ${escapeHtml(event.location || 'Lieu non sp√©cifi√©')}
                                </div>
                                <div class="event-mini-meta-item">
                                    <i class="fas fa-calendar"></i>
                                    ${formatDate(event.date)}
                                </div>
                            </div>
                        </div>
                        <div class="event-mini-meta" style="padding: 15px;">
                            <div class="event-mini-stats">
                                <div class="event-mini-stat">
                                    <div class="event-mini-stat-number">${event.galleriesCount || 0}</div>
                                    <div class="event-mini-stat-label">Galeries</div>
                                </div>
                                <div class="event-mini-stat">
                                    <div class="event-mini-stat-number">${event.photosCount || 0}</div>
                                    <div class="event-mini-stat-label">Photos</div>
                                </div>
                                <div class="event-mini-stat">
                                    <div class="event-mini-stat-number">${event.likesCount || 0}</div>
                                    <div class="event-mini-stat-label">Likes</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Ajouter les √©v√©nements click
            document.querySelectorAll('.event-mini-card').forEach(card => {
                card.addEventListener('click', function() {
                    const eventId = this.getAttribute('data-event-id');
                    selectEvent(eventId);
                });
            });
        }

        function displayEventsTable() {
            const tbody = document.getElementById('eventsTableBody');
            if (!tbody) return;
            
            if (eventsList.length === 0) {
                tbody.innerHTML = '';
                return;
            }
            
            tbody.innerHTML = eventsList.map(event => {
                return `
                    <tr data-event-id="${event.id}">
                        <td>
                            <div class="event-cell">
                                <div class="event-cell-icon">
                                    <i class="fas fa-images"></i>
                                </div>
                                <div class="event-cell-info">
                                    <div class="event-cell-name">${escapeHtml(event.name)}</div>
                                    <div class="event-cell-location">${escapeHtml(event.location || 'Lieu non sp√©cifi√©')}</div>
                                </div>
                            </div>
                        </td>
                        <td class="event-cell-date">${formatDate(event.date)}</td>
                        <td>
                            <span class="event-cell-type">${escapeHtml(event.type || '√âv√©nement')}</span>
                        </td>
                        <td>
                            <div class="event-cell-stats">
                                <div class="event-cell-stat">
                                    <span class="event-cell-stat-number">${event.galleriesCount || 0}</span>
                                    <span class="event-cell-stat-label">Galeries</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="event-cell-stats">
                                <div class="event-cell-stat">
                                    <span class="event-cell-stat-number">${event.photosCount || 0}</span>
                                    <span class="event-cell-stat-label">Photos</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Ajouter les √©v√©nements click
            document.querySelectorAll('#eventsTableBody tr').forEach(row => {
                row.addEventListener('click', function() {
                    const eventId = this.getAttribute('data-event-id');
                    selectEvent(eventId);
                });
            });
        }

        function setEventsViewMode(mode) {
            eventsViewMode = mode;
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-mode') === mode);
            });
            
            // Afficher la bonne vue
            if (mode === 'grid') {
                document.getElementById('eventsGridView').style.display = 'grid';
                document.getElementById('eventsTableView').style.display = 'none';
            } else {
                document.getElementById('eventsGridView').style.display = 'none';
                document.getElementById('eventsTableView').style.display = 'block';
            }
        }

        function checkEmptyState() {
            const emptyState = document.getElementById('emptyEventsState');
            const hasEvents = eventsList.length > 0;
            
            if (emptyState) {
                emptyState.style.display = hasEvents ? 'none' : 'block';
            }
            
            document.getElementById('eventsGridView').style.display = hasEvents ? 'grid' : 'none';
            document.getElementById('eventsTableView').style.display = hasEvents ? 'block' : 'none';
        }

        // ============================================
        // üéØ GESTION DES GALERIES (STORAGE INT√âGR√â)
        // ============================================

        async function selectEvent(eventId) {
            try {
                showLoading('galleriesLoader');
                
                // R√©cup√©rer l'√©v√©nement
                const event = eventsList.find(e => e.id === eventId);
                if (!event) {
                    throw new Error('√âv√©nement non trouv√©');
                }
                
                currentEvent = event;
                
                // Mettre √† jour l'affichage
                document.getElementById('eventsHomeView').style.display = 'none';
                document.getElementById('galleriesView').style.display = 'block';
                
                document.getElementById('eventNameDisplay').innerHTML = `
                    <i class="fas fa-calendar-alt"></i>
                    <span>${escapeHtml(event.name)}</span>
                `;
                
                // Charger les galeries avec storage
                await loadGalleries();
                
                hideLoading('galleriesLoader');
                
            } catch (error) {
                console.error('Erreur s√©lection √©v√©nement:', error);
                hideLoading('galleriesLoader');
                showToast('Erreur lors du chargement des galeries', 'error');
            }
        }

        async function loadGalleries() {
            try {
                showLoading('galleriesLoader');
                
                // Utiliser storage pour obtenir les galeries
                const galleries = await storage.getGalleries(currentEvent.id) || [];
                allGalleries = galleries;
                
                // Mettre √† jour les statistiques
                updateStatistics();
                
                // Filtrer et afficher
                filterGalleries();
                
                // √âmettre l'√©v√©nement
                storage.emit('data:synced', { galleries: allGalleries });
                
                hideLoading('galleriesLoader');
            } catch (error) {
                console.error('Erreur chargement galeries:', error);
                allGalleries = [];
                updateStatistics();
                filterGalleries();
                hideLoading('galleriesLoader');
                showToast('Erreur lors du chargement des galeries', 'error');
            }
        }

        function filterGalleries() {
            filteredGalleries = [...allGalleries];
            
            // Appliquer le filtre
            if (currentFilter !== 'all') {
                filteredGalleries = filteredGalleries.filter(gallery => {
                    switch (currentFilter) {
                        case 'public':
                            return gallery.isPublic === true;
                        case 'private':
                            return gallery.isPublic === false;
                        case 'moderation':
                            return gallery.pendingPhotos > 0;
                        default:
                            return true;
                    }
                });
            }
            
            // Appliquer la recherche
            if (currentSearch) {
                const searchLower = currentSearch.toLowerCase();
                filteredGalleries = filteredGalleries.filter(gallery => 
                    gallery.name.toLowerCase().includes(searchLower) ||
                    (gallery.description && gallery.description.toLowerCase().includes(searchLower)) ||
                    (gallery.metadata?.tags && gallery.metadata.tags.some(tag => tag.toLowerCase().includes(searchLower)))
                );
            }
            
            // Mettre √† jour le compteur
            document.getElementById('galleriesCount').textContent = filteredGalleries.length;
            document.getElementById('galleriesListCount').textContent = filteredGalleries.length;
            
            // Afficher les galeries
            displayGalleries();
            
            // G√©rer l'√©tat vide
            checkGalleriesEmptyState();
        }

        function displayGalleries() {
            if (currentView === 'grid') {
                displayGalleriesGrid();
            } else {
                displayGalleriesList();
            }
        }

        function displayGalleriesGrid() {
            const grid = document.getElementById('galleriesGrid');
            if (!grid) return;
            
            if (filteredGalleries.length === 0) {
                grid.innerHTML = '';
                return;
            }
            
            grid.innerHTML = filteredGalleries.map(gallery => {
                const coverUrl = gallery.metadata?.coverPhoto || 
                                GALLERY_IMAGES[gallery.metadata?.category || 'general'];
                const galleryImage = getGalleryImage(gallery);
                
                return `
                    <div class="gallery-card" data-gallery-id="${gallery.id}" data-category="${gallery.metadata?.category || 'general'}">
                        <div class="gallery-card-header" style="background-image: url('${galleryImage}');">
                            <div>
                                <div class="gallery-number">${gallery.photoCount || 0}</div>
                                <h3 class="gallery-name">${escapeHtml(gallery.name)}</h3>
                                <div class="gallery-meta">
                                    <span class="gallery-status ${gallery.isPublic ? 'public' : 'private'}">
                                        <i class="fas ${gallery.isPublic ? 'fa-globe' : 'fa-lock'}"></i>
                                        ${gallery.isPublic ? 'Publique' : 'Priv√©e'}
                                    </span>
                                    <span class="gallery-category">
                                        <i class="fas fa-tag"></i>
                                        ${getCategoryLabel(gallery.metadata?.category)}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-card-content">
                            <div class="gallery-info-item">
                                <div class="gallery-info-label">
                                    <i class="fas fa-align-left"></i>
                                    Description
                                </div>
                                <div class="gallery-info-value">${escapeHtml(gallery.description || 'Aucune description')}</div>
                            </div>
                            
                            <div class="gallery-stats-indicator">
                                <div class="stats-header">
                                    <div class="stats-label">
                                        <i class="fas fa-chart-bar"></i>
                                        Statistiques
                                    </div>
                                    <div class="stats-percentage">${gallery.engagementScore || 0} pts</div>
                                </div>
                                <div class="stats-visual-grid">
                                    ${Array.from({ length: Math.min(gallery.photoCount || 0, 12) }).map((_, i) => {
                                        const status = i < (gallery.approvedPhotoCount || 0) ? 'uploaded' : 
                                                     i < (gallery.photoCount || 0) ? 'pending' : '';
                                        return `<div class="photo-square ${status}"></div>`;
                                    }).join('')}
                                </div>
                                <div class="stats-numbers">
                                    <span>${gallery.photoCount || 0} photos</span>
                                    <span>${gallery.likes || 0} likes</span>
                                </div>
                            </div>
                        </div>
                        <div class="gallery-card-footer">
                            <div class="gallery-location">
                                <i class="fas fa-calendar"></i>
                                ${formatDate(gallery.createdAt)}
                            </div>
                            <div class="gallery-actions">
                                <button class="action-btn view view-gallery-btn" data-gallery-id="${gallery.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn edit edit-gallery-btn" data-gallery-id="${gallery.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete delete-gallery-btn" data-gallery-id="${gallery.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Ajouter les √©v√©nements
            setupGalleryEventListeners();
        }

        function displayGalleriesList() {
            const tbody = document.getElementById('galleriesListBody');
            if (!tbody) return;
            
            if (filteredGalleries.length === 0) {
                tbody.innerHTML = '';
                return;
            }
            
            tbody.innerHTML = filteredGalleries.map(gallery => {
                return `
                    <tr data-gallery-id="${gallery.id}">
                        <td>
                            <div class="event-cell">
                                <div class="event-cell-icon" style="background: ${getGalleryColor(gallery)};">
                                    <i class="fas fa-images"></i>
                                </div>
                                <div class="event-cell-info">
                                    <div class="event-cell-name">${escapeHtml(gallery.name)}</div>
                                    <div class="event-cell-location">${escapeHtml(gallery.description || 'Aucune description')}</div>
                                </div>
                            </div>
                        </td>
                        <td>${gallery.photoCount || 0}</td>
                        <td>${gallery.likes || 0}</td>
                        <td>${gallery.comments || 0}</td>
                        <td>
                            ${gallery.isPublic ? 
                                '<span style="color: var(--success);"><i class="fas fa-globe"></i> Publique</span>' : 
                                '<span style="color: var(--warning);"><i class="fas fa-lock"></i> Priv√©e</span>'
                            }
                        </td>
                        <td>${formatDate(gallery.createdAt)}</td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="btn btn-xs btn-secondary view-gallery-btn" data-gallery-id="${gallery.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-xs btn-secondary edit-gallery-btn" data-gallery-id="${gallery.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-xs btn-danger delete-gallery-btn" data-gallery-id="${gallery.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function setupGalleryEventListeners() {
            // Click sur galerie pour voir les photos
            document.querySelectorAll('.gallery-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (!e.target.closest('.gallery-actions')) {
                        const galleryId = this.getAttribute('data-gallery-id');
                        selectGallery(galleryId);
                    }
                });
            });
            
            // Boutons actions
            document.querySelectorAll('.view-gallery-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const galleryId = this.getAttribute('data-gallery-id');
                    selectGallery(galleryId);
                });
            });
            
            document.querySelectorAll('.edit-gallery-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const galleryId = this.getAttribute('data-gallery-id');
                    editGallery(galleryId);
                });
            });
            
            document.querySelectorAll('.delete-gallery-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const galleryId = this.getAttribute('data-gallery-id');
                    deleteGallery(galleryId);
                });
            });
        }

        function getGalleryImage(gallery) {
            if (gallery.metadata?.coverPhoto) {
                // Ici, vous devriez r√©cup√©rer l'URL de la photo de couverture
                // Pour l'instant, retourner une image par d√©faut bas√©e sur la cat√©gorie
                return GALLERY_IMAGES[gallery.metadata?.category || 'general'];
            }
            return GALLERY_IMAGES[gallery.metadata?.category || 'general'];
        }

        function getGalleryColor(gallery) {
            const colors = {
                'general': '#D97706',
                'vip': '#F59E0B',
                'backstage': '#8B5CF6',
                'official': '#3B82F6',
                'guest': '#10B981',
                'behind_scenes': '#EC4899'
            };
            return colors[gallery.metadata?.category || 'general'];
        }

        function getCategoryLabel(category) {
            const labels = {
                'general': 'G√©n√©ral',
                'vip': 'VIP',
                'backstage': 'Backstage',
                'official': 'Officiel',
                'guest': 'Invit√©s',
                'behind_scenes': 'Coulisses'
            };
            return labels[category] || 'G√©n√©ral';
        }

        function setGalleryFilter(filter) {
            currentFilter = filter;
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.classList.toggle('active', chip.getAttribute('data-filter') === filter);
            });
            
            filterGalleries();
        }

        function setGalleryView(view) {
            currentView = view;
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.view-btn[data-view]').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-view') === view);
            });
            
            // Afficher la bonne vue
            document.getElementById('galleriesGridView').classList.toggle('active', view === 'grid');
            document.getElementById('galleriesListView').classList.toggle('active', view === 'list');
            
            displayGalleries();
        }

        function searchGalleries() {
            const searchInput = document.getElementById('searchGalleries');
            if (searchInput) {
                currentSearch = searchInput.value.trim();
                filterGalleries();
            }
        }

        function checkGalleriesEmptyState() {
            const hasGalleries = filteredGalleries.length > 0;
            
            document.getElementById('emptyStateGalleries').style.display = hasGalleries ? 'none' : 'flex';
            document.getElementById('emptyStateGalleriesList').style.display = hasGalleries ? 'none' : 'block';
        }

        // ============================================
        // üéØ CR√âATION ET GESTION DES GALERIES (STORAGE)
        // ============================================

        function showCreateGalleryModal() {
            currentCreationStep = 1;
            updateCreationModal();
            document.getElementById('galleryCreationModal').classList.add('active');
        }

        function closeCreateGalleryModal() {
            document.getElementById('galleryCreationModal').classList.remove('active');
            resetGalleryForm();
        }

        function navigateToStep(step) {
            if (validateCurrentStep(currentCreationStep)) {
                currentCreationStep = step;
                updateCreationModal();
                updatePreview();
            }
        }

                function updateCreationModal() {
            // Mettre √† jour la barre de progression
            document.getElementById('creationProgressBar').style.width = `${currentCreationStep * 25}%`;
            document.getElementById('creationProgressPercentage').textContent = `${currentCreationStep * 25}%`;
            
            // Mettre √† jour les √©tapes
            document.querySelectorAll('.vertical-step').forEach(step => {
                const stepNum = parseInt(step.getAttribute('data-step'));
                step.classList.toggle('active', stepNum === currentCreationStep);
                step.classList.toggle('completed', stepNum < currentCreationStep);
            });
            
            // Afficher/masquer les contenus d'√©tape
            document.querySelectorAll('.creation-step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.getElementById(`step${currentCreationStep}Content`).classList.add('active');
            
            // Mettre √† jour le titre
            const titles = [
                "Informations de la Galerie",
                "Configuration",
                "Image de Couverture",
                "Confirmation"
            ];
            
            const subtitles = [
                "D√©finissez le nom et la description de votre galerie",
                "Configurez les param√®tres et permissions",
                "Choisissez une image de pr√©sentation (optionnel)",
                "V√©rifiez les informations avant cr√©ation"
            ];
            
            document.getElementById('modalCreationTitle').textContent = titles[currentCreationStep - 1];
            document.getElementById('modalCreationSubtitle').textContent = subtitles[currentCreationStep - 1];
        }

        function validateCurrentStep(step) {
            switch(step) {
                case 1:
                    const name = document.getElementById('galleryName').value.trim();
                    if (!name) {
                        showToast('Veuillez saisir un nom pour la galerie', 'error');
                        return false;
                    }
                    return true;
                    
                case 2:
                    // √âtape de configuration, toujours valide
                    return true;
                    
                case 3:
                    // √âtape couverture, toujours valide
                    return true;
                    
                case 4:
                    // Validation finale
                    return validateGalleryForm();
                    
                default:
                    return true;
            }
        }

        function updatePreview() {
            // R√©cup√©rer les valeurs du formulaire
            const name = document.getElementById('galleryName').value.trim();
            const description = document.getElementById('galleryDescription').value.trim();
            const category = document.getElementById('galleryCategory').value;
            const isPublic = document.getElementById('galleryIsPublic').checked;
            const moderation = document.getElementById('moderationRequired').checked;
            
            // Mettre √† jour l'aper√ßu
            document.getElementById('previewGalleryName').textContent = name || 'Non sp√©cifi√©';
            document.getElementById('previewVisibility').textContent = isPublic ? 'Publique' : 'Priv√©e';
            document.getElementById('previewCategory').textContent = getCategoryLabel(category);
            document.getElementById('previewModeration').textContent = moderation ? 'Activ√©e' : 'D√©sactiv√©e';
            document.getElementById('previewDescription').textContent = description || 'Aucune description';
            document.getElementById('previewDescription').classList.toggle('empty', !description);
        }

        function handleGalleryCoverSelect(file) {
            if (!file.type.startsWith('image/')) {
                showToast('Veuillez s√©lectionner une image', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('L\'image ne doit pas d√©passer 5MB', 'error');
                return;
            }
            
            galleryCoverFile = file;
            
            // Afficher l'aper√ßu
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('coverPreviewImage').src = e.target.result;
                document.getElementById('coverPreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            showToast('Image s√©lectionn√©e avec succ√®s', 'success');
        }

        function validateGalleryForm() {
            const name = document.getElementById('galleryName').value.trim();
            
            if (!name) {
                showToast('Le nom de la galerie est requis', 'error');
                return false;
            }
            
            return true;
        }

        async function createGallery() {
            try {
                if (!validateGalleryForm()) return;
                
                // R√©cup√©rer les valeurs du formulaire
                const galleryData = {
                    eventId: currentEvent.id,
                    name: document.getElementById('galleryName').value.trim(),
                    description: document.getElementById('galleryDescription').value.trim(),
                    settings: {
                        moderationRequired: document.getElementById('moderationRequired').checked,
                        autoApprove: !document.getElementById('moderationRequired').checked,
                        allowComments: document.getElementById('allowComments').checked,
                        allowLikes: document.getElementById('allowLikes').checked,
                        allowDownloads: document.getElementById('allowDownloads').checked,
                        maxPhotos: 1000,
                        maxPhotoSize: 10 * 1024 * 1024,
                        allowedFormats: ['jpg', 'jpeg', 'png', 'webp', 'gif']
                    },
                    isPublic: document.getElementById('galleryIsPublic').checked,
                    metadata: {
                        category: document.getElementById('galleryCategory').value,
                        tags: [],
                        location: currentEvent.location
                    },
                    permissions: {
                        viewers: ['all'],
                        contributors: document.getElementById('allowContributions').checked ? ['all'] : [currentUser.id],
                        moderators: [currentUser.id]
                    }
                };
                
                // Ajouter l'image de couverture si fournie
                if (galleryCoverFile) {
                    try {
                        // Upload de l'image via storage
                        const uploadedFile = await storage.uploadFile(galleryCoverFile, 'gallery');
                        galleryData.metadata.coverPhoto = uploadedFile.id;
                        galleryData.metadata.coverPhotoUrl = uploadedFile.url;
                    } catch (error) {
                        console.warn('Erreur upload image couverture:', error);
                        // Continuer sans image de couverture
                    }
                }
                
                // Utiliser storage pour cr√©er la galerie
                const newGallery = await storage.createGallery(galleryData);
                
                showToast('Galerie cr√©√©e avec succ√®s!', 'success');
                
                // Confetti animation
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
                
                // Fermer la modale
                closeCreateGalleryModal();
                
                // Recharger les galeries
                await loadGalleries();
                
            } catch (error) {
                console.error('Erreur cr√©ation galerie:', error);
                showToast('Erreur lors de la cr√©ation de la galerie', 'error');
            }
        }

        function resetGalleryForm() {
            // R√©initialiser le formulaire
            document.getElementById('createGalleryForm').reset();
            document.getElementById('galleryIsPublic').checked = false;
            document.getElementById('moderationRequired').checked = true;
            document.getElementById('allowComments').checked = true;
            document.getElementById('allowLikes').checked = true;
            document.getElementById('allowDownloads').checked = false;
            document.getElementById('allowContributions').checked = false;
            
            // R√©initialiser l'image de couverture
            galleryCoverFile = null;
            document.getElementById('coverPreview').style.display = 'none';
            document.getElementById('galleryCoverFile').value = '';
            
            // R√©initialiser l'aper√ßu
            document.getElementById('previewGalleryName').textContent = '';
            document.getElementById('previewVisibility').textContent = '';
            document.getElementById('previewCategory').textContent = '';
            document.getElementById('previewModeration').textContent = '';
            document.getElementById('previewDescription').textContent = '';
        }

        function editGallery(galleryId) {
            const gallery = allGalleries.find(g => g.id === galleryId);
            if (!gallery) return;
            
            // Remplir le formulaire avec les donn√©es de la galerie
            document.getElementById('galleryName').value = gallery.name;
            document.getElementById('galleryDescription').value = gallery.description || '';
            document.getElementById('galleryCategory').value = gallery.metadata?.category || 'general';
            document.getElementById('galleryIsPublic').checked = gallery.isPublic || false;
            document.getElementById('moderationRequired').checked = gallery.settings?.moderationRequired !== false;
            document.getElementById('allowComments').checked = gallery.settings?.allowComments !== false;
            document.getElementById('allowLikes').checked = gallery.settings?.allowLikes !== false;
            document.getElementById('allowDownloads').checked = gallery.settings?.allowDownloads || false;
            document.getElementById('allowContributions').checked = gallery.permissions?.contributors?.includes('all') || false;
            
            // Mettre √† jour l'aper√ßu
            updatePreview();
            
            // Afficher la modale
            showCreateGalleryModal();
            
            // Modifier le bouton de soumission
            const submitBtn = document.getElementById('submitGalleryBtn');
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
            submitBtn.onclick = async () => {
                await updateGallery(galleryId);
            };
        }

        async function updateGallery(galleryId) {
            try {
                if (!validateGalleryForm()) return;
                
                const galleryData = {
                    name: document.getElementById('galleryName').value.trim(),
                    description: document.getElementById('galleryDescription').value.trim(),
                    isPublic: document.getElementById('galleryIsPublic').checked,
                    settings: {
                        moderationRequired: document.getElementById('moderationRequired').checked,
                        autoApprove: !document.getElementById('moderationRequired').checked,
                        allowComments: document.getElementById('allowComments').checked,
                        allowLikes: document.getElementById('allowLikes').checked,
                        allowDownloads: document.getElementById('allowDownloads').checked
                    },
                    metadata: {
                        category: document.getElementById('galleryCategory').value,
                        tags: []
                    },
                    permissions: {
                        contributors: document.getElementById('allowContributions').checked ? ['all'] : [currentUser.id]
                    }
                };
                
                // Upload nouvelle image de couverture si fournie
                if (galleryCoverFile) {
                    try {
                        const uploadedFile = await storage.uploadFile(galleryCoverFile, 'gallery');
                        galleryData.metadata.coverPhoto = uploadedFile.id;
                        galleryData.metadata.coverPhotoUrl = uploadedFile.url;
                    } catch (error) {
                        console.warn('Erreur upload image couverture:', error);
                    }
                }
                
                // Utiliser storage pour mettre √† jour la galerie
                await storage.updateGallery(galleryId, galleryData);
                
                showToast('Galerie modifi√©e avec succ√®s!', 'success');
                closeCreateGalleryModal();
                await loadGalleries();
                
            } catch (error) {
                console.error('Erreur modification galerie:', error);
                showToast('Erreur lors de la modification de la galerie', 'error');
            }
        }

        async function deleteGallery(galleryId) {
            try {
                const gallery = allGalleries.find(g => g.id === galleryId);
                if (!gallery) return;
                
                // Demander confirmation
                if (!confirm(`√ätes-vous s√ªr de vouloir supprimer la galerie "${gallery.name}" ? Cette action est irr√©versible.`)) {
                    return;
                }
                
                // Utiliser storage pour supprimer la galerie
                await storage.deleteGallery(galleryId);
                
                showToast('Galerie supprim√©e avec succ√®s', 'success');
                await loadGalleries();
                
            } catch (error) {
                console.error('Erreur suppression galerie:', error);
                showToast('Erreur lors de la suppression de la galerie', 'error');
            }
        }

        // ============================================
        // üéØ GESTION DES PHOTOS DANS UNE GALERIE
        // ============================================

        async function selectGallery(galleryId) {
            try {
                showLoading('photosLoader');
                
                // R√©cup√©rer la galerie
                currentGallery = allGalleries.find(g => g.id === galleryId);
                if (!currentGallery) {
                    throw new Error('Galerie non trouv√©e');
                }
                
                // Mettre √† jour l'affichage
                document.getElementById('galleriesGridView').classList.remove('active');
                document.getElementById('galleriesListView').classList.remove('active');
                document.getElementById('photosView').classList.add('active');
                
                document.getElementById('currentGalleryName').textContent = currentGallery.name;
                
                // Charger les photos
                await loadPhotos();
                
                hideLoading('photosLoader');
                
            } catch (error) {
                console.error('Erreur s√©lection galerie:', error);
                hideLoading('photosLoader');
                showToast('Erreur lors du chargement des photos', 'error');
            }
        }

        async function loadPhotos() {
            try {
                if (!currentGallery) return;
                
                // Utiliser storage pour obtenir les photos de la galerie
                const photos = await storage.getPhotos(currentGallery.id) || [];
                galleryPhotos = photos;
                
                // Mettre √† jour les statistiques
                updateGalleryStatistics();
                
                // Filtrer et afficher
                filterPhotos();
                
                hideLoading('photosLoader');
            } catch (error) {
                console.error('Erreur chargement photos:', error);
                galleryPhotos = [];
                updateGalleryStatistics();
                filterPhotos();
                hideLoading('photosLoader');
                showToast('Erreur lors du chargement des photos', 'error');
            }
        }

        function updateGalleryStatistics() {
            const stats = galleryPhotos.reduce((acc, photo) => {
                acc.totalPhotos++;
                acc.totalViews += photo.views || 0;
                acc.totalLikes += photo.likes?.length || 0;
                acc.totalComments += photo.comments?.length || 0;
                return acc;
            }, {
                totalPhotos: 0,
                totalViews: 0,
                totalLikes: 0,
                totalComments: 0
            });
            
            document.getElementById('galleryPhotosCount').textContent = stats.totalPhotos;
            document.getElementById('galleryLikesCount').textContent = stats.totalLikes;
            document.getElementById('galleryCommentsCount').textContent = stats.totalComments;
            document.getElementById('galleryViewsCount').textContent = stats.totalViews;
            document.getElementById('photosCount').textContent = stats.totalPhotos;
        }

        function filterPhotos() {
            filteredPhotos = [...galleryPhotos];
            
            // Appliquer le filtre
            if (currentPhotoFilter !== 'all') {
                filteredPhotos = filteredPhotos.filter(photo => {
                    return photo.status === currentPhotoFilter;
                });
            }
            
            // Appliquer la recherche
            if (currentGallerySearch) {
                const searchLower = currentGallerySearch.toLowerCase();
                filteredPhotos = filteredPhotos.filter(photo => 
                    (photo.filename && photo.filename.toLowerCase().includes(searchLower)) ||
                    (photo.metadata?.title && photo.metadata.title.toLowerCase().includes(searchLower)) ||
                    (photo.metadata?.description && photo.metadata.description.toLowerCase().includes(searchLower)) ||
                    (photo.metadata?.tags && photo.metadata.tags.some(tag => tag.toLowerCase().includes(searchLower)))
                );
            }
            
            // Trier par date d'upload
            filteredPhotos.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
            
            // Afficher les photos
            displayPhotos();
            
            // G√©rer l'√©tat vide
            checkPhotosEmptyState();
        }

        function displayPhotos() {
            const grid = document.getElementById('photosGrid');
            if (!grid) return;
            
            if (filteredPhotos.length === 0) {
                grid.innerHTML = '';
                return;
            }
            
            grid.innerHTML = filteredPhotos.map(photo => {
                const photoDate = new Date(photo.uploadedAt);
                const isPending = photo.status === 'pending';
                const isRejected = photo.status === 'rejected';
                const isApproved = photo.status === 'approved';
                
                return `
                    <div class="photo-card ${isPending ? 'pending' : isRejected ? 'rejected' : ''}" data-photo-id="${photo.id}">
                        <div class="photo-card-image">
                            <img src="${photo.url || photo.thumbnails?.small || 'assets/images/placeholder.jpg'}" 
                                 alt="${photo.filename}" 
                                 loading="lazy">
                            ${isPending ? `
                                <div class="photo-status-badge pending">
                                    <i class="fas fa-clock"></i> En attente
                                </div>
                            ` : ''}
                            ${isRejected ? `
                                <div class="photo-status-badge rejected">
                                    <i class="fas fa-times-circle"></i> Rejet√©e
                                </div>
                            ` : ''}
                            
                            <div class="photo-hover-actions">
                                <button class="photo-action-btn view" title="Voir la photo">
                                    <i class="fas fa-expand"></i>
                                </button>
                                <button class="photo-action-btn like ${photo.likedBy?.includes(currentUser.id) ? 'liked' : ''}" 
                                        title="${photo.likedBy?.includes(currentUser.id) ? 'Retirer le like' : 'Aimer la photo'}">
                                    <i class="fas fa-heart"></i>
                                </button>
                                <button class="photo-action-btn download" title="T√©l√©charger">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                        <div class="photo-card-info">
                            <div class="photo-title">${photo.metadata?.title || photo.filename}</div>
                            <div class="photo-meta">
                                <div class="photo-uploader">
                                    <i class="fas fa-user"></i>
                                    ${escapeHtml(photo.uploadedByName || 'Utilisateur')}
                                </div>
                                <div class="photo-date">
                                    <i class="fas fa-calendar"></i>
                                    ${formatDate(photo.uploadedAt)}
                                </div>
                            </div>
                            <div class="photo-stats">
                                <div class="photo-stat">
                                    <i class="fas fa-heart"></i>
                                    <span>${photo.likes?.length || 0}</span>
                                </div>
                                <div class="photo-stat">
                                    <i class="fas fa-comment"></i>
                                    <span>${photo.comments?.length || 0}</span>
                                </div>
                                <div class="photo-stat">
                                    <i class="fas fa-eye"></i>
                                    <span>${photo.views || 0}</span>
                                </div>
                            </div>
                            ${photo.metadata?.description ? `
                                <div class="photo-description">${escapeHtml(photo.metadata.description)}</div>
                            ` : ''}
                            <div class="photo-tags">
                                ${(photo.metadata?.tags || []).slice(0, 3).map(tag => `
                                    <span class="photo-tag">${escapeHtml(tag)}</span>
                                `).join('')}
                            </div>
                        </div>
                        <div class="photo-card-actions">
                            <button class="btn btn-xs btn-secondary view-photo-btn" data-photo-id="${photo.id}">
                                <i class="fas fa-eye"></i> Voir
                            </button>
                            <button class="btn btn-xs btn-secondary edit-photo-btn" data-photo-id="${photo.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${isPending && canModerateGallery(currentGallery, currentUser.id) ? `
                                <button class="btn btn-xs btn-success approve-photo-btn" data-photo-id="${photo.id}">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-xs btn-danger reject-photo-btn" data-photo-id="${photo.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                            <button class="btn btn-xs btn-danger delete-photo-btn" data-photo-id="${photo.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Ajouter les √©v√©nements
            setupPhotoEventListeners();
        }

        function setupPhotoEventListeners() {
            // Voir une photo
            document.querySelectorAll('.view-photo-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const photoId = this.getAttribute('data-photo-id');
                    viewPhoto(photoId);
                });
            });
            
            // Like une photo
            document.querySelectorAll('.photo-action-btn.like').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const photoCard = this.closest('.photo-card');
                    const photoId = photoCard.getAttribute('data-photo-id');
                    await toggleLikePhoto(photoId, photoCard);
                });
            });
            
            // T√©l√©charger une photo
            document.querySelectorAll('.photo-action-btn.download').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const photoCard = this.closest('.photo-card');
                    const photoId = photoCard.getAttribute('data-photo-id');
                    await downloadPhoto(photoId);
                });
            });
            
            // Approuver une photo
            document.querySelectorAll('.approve-photo-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const photoId = this.getAttribute('data-photo-id');
                    await approvePhoto(photoId);
                });
            });
            
            // Rejeter une photo
            document.querySelectorAll('.reject-photo-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const photoId = this.getAttribute('data-photo-id');
                    await rejectPhoto(photoId);
                });
            });
            
            // Supprimer une photo
            document.querySelectorAll('.delete-photo-btn').forEach(btn => {
                btn.addEventListener('click', async function(e) {
                    e.stopPropagation();
                    const photoId = this.getAttribute('data-photo-id');
                    await deletePhoto(photoId);
                });
            });
            
            // √âditer une photo
            document.querySelectorAll('.edit-photo-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const photoId = this.getAttribute('data-photo-id');
                    editPhoto(photoId);
                });
            });
        }

        function setPhotoFilter(filter) {
            currentPhotoFilter = filter;
            
            // Mettre √† jour les boutons
            document.querySelectorAll('.filter-chip[data-photo-filter]').forEach(chip => {
                chip.classList.toggle('active', chip.getAttribute('data-photo-filter') === filter);
            });
            
            filterPhotos();
        }

        function searchPhotos() {
            const searchInput = document.getElementById('searchPhotos');
            if (searchInput) {
                currentGallerySearch = searchInput.value.trim();
                filterPhotos();
            }
        }

        function checkPhotosEmptyState() {
            const hasPhotos = filteredPhotos.length > 0;
            document.getElementById('emptyStatePhotos').style.display = hasPhotos ? 'none' : 'flex';
        }

        function showEventsHome() {
            document.getElementById('galleriesView').style.display = 'none';
            document.getElementById('photosView').classList.remove('active');
            document.getElementById('eventsHomeView').style.display = 'block';
            currentEvent = null;
            currentGallery = null;
        }

        function showGalleriesView() {
            document.getElementById('photosView').classList.remove('active');
            document.getElementById('galleriesGridView').classList.add('active');
            document.getElementById('galleriesListView').classList.remove('active');
            currentGallery = null;
        }

        // ============================================
        // üéØ ACTIONS SUR LES PHOTOS
        // ============================================

        async function viewPhoto(photoId) {
            try {
                const photo = galleryPhotos.find(p => p.id === photoId);
                if (!photo) return;
                
                // Incr√©menter le compteur de vues
                photo.views = (photo.views || 0) + 1;
                if (!photo.viewedBy) photo.viewedBy = [];
                photo.viewedBy.push(currentUser.id);
                
                // Sauvegarder la mise √† jour
                await storage.updatePhoto(currentGallery.id, photoId, { 
                    views: photo.views,
                    viewedBy: photo.viewedBy 
                });
                
                // Afficher la photo en grand
                showPhotoModal(photo);
                
            } catch (error) {
                console.error('Erreur vue photo:', error);
                showToast('Erreur lors de l\'affichage de la photo', 'error');
            }
        }

        async function toggleLikePhoto(photoId, photoCard) {
            try {
                const photo = galleryPhotos.find(p => p.id === photoId);
                if (!photo) return;
                
                // V√©rifier si l'utilisateur a d√©j√† lik√©
                const hasLiked = photo.likedBy?.includes(currentUser.id);
                
                if (hasLiked) {
                    // Retirer le like
                    photo.likes = photo.likes.filter(like => like.userId !== currentUser.id);
                    photo.likedBy = photo.likedBy.filter(id => id !== currentUser.id);
                } else {
                    // Ajouter le like
                    if (!photo.likes) photo.likes = [];
                    if (!photo.likedBy) photo.likedBy = [];
                    
                    photo.likes.push({
                        id: `like_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        userId: currentUser.id,
                        userName: currentUser.fullName || currentUser.username,
                        likedAt: new Date().toISOString()
                    });
                    
                    photo.likedBy.push(currentUser.id);
                }
                
                // Sauvegarder la mise √† jour
                await storage.updatePhoto(currentGallery.id, photoId, {
                    likes: photo.likes,
                    likedBy: photo.likedBy
                });
                
                // Mettre √† jour l'affichage
                const likeBtn = photoCard.querySelector('.photo-action-btn.like');
                const likeCount = photoCard.querySelector('.photo-stat:nth-child(1) span');
                
                likeBtn.classList.toggle('liked', !hasLiked);
                likeCount.textContent = photo.likes.length;
                
                showToast(hasLiked ? 'Like retir√©' : 'Photo aim√©e!', 'success');
                
            } catch (error) {
                console.error('Erreur like photo:', error);
                showToast('Erreur lors de l\'action sur la photo', 'error');
            }
        }

        async function downloadPhoto(photoId) {
            try {
                const photo = galleryPhotos.find(p => p.id === photoId);
                if (!photo) return;
                
                if (!currentGallery.settings.allowDownloads) {
                    showToast('Les t√©l√©chargements sont d√©sactiv√©s pour cette galerie', 'error');
                    return;
                }
                
                // Incr√©menter le compteur de t√©l√©chargements
                photo.downloads = (photo.downloads || 0) + 1;
                if (!photo.downloadedBy) photo.downloadedBy = [];
                photo.downloadedBy.push({
                    userId: currentUser.id,
                    downloadedAt: new Date().toISOString()
                });
                
                // Sauvegarder la mise √† jour
                await storage.updatePhoto(currentGallery.id, photoId, {
                    downloads: photo.downloads,
                    downloadedBy: photo.downloadedBy
                });
                
                // T√©l√©charger l'image
                const link = document.createElement('a');
                link.href = photo.url;
                link.download = photo.filename || `photo_${photoId}.jpg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showToast('T√©l√©chargement d√©marr√©', 'success');
                
            } catch (error) {
                console.error('Erreur t√©l√©chargement photo:', error);
                showToast('Erreur lors du t√©l√©chargement', 'error');
            }
        }

        async function approvePhoto(photoId) {
            try {
                if (!canModerateGallery(currentGallery, currentUser.id)) {
                    showToast('Vous n\'avez pas la permission de mod√©rer', 'error');
                    return;
                }
                
                // Utiliser storage pour approuver la photo
                await storage.approvePhoto(currentGallery.id, photoId);
                
                showToast('Photo approuv√©e avec succ√®s', 'success');
                await loadPhotos();
                
            } catch (error) {
                console.error('Erreur approbation photo:', error);
                showToast('Erreur lors de l\'approbation', 'error');
            }
        }

        async function rejectPhoto(photoId) {
            try {
                if (!canModerateGallery(currentGallery, currentUser.id)) {
                    showToast('Vous n\'avez pas la permission de mod√©rer', 'error');
                    return;
                }
                
                const reason = prompt('Veuillez saisir la raison du rejet (optionnel):');
                
                // Utiliser storage pour rejeter la photo
                await storage.rejectPhoto(currentGallery.id, photoId, reason);
                
                showToast('Photo rejet√©e', 'success');
                await loadPhotos();
                
            } catch (error) {
                console.error('Erreur rejet photo:', error);
                showToast('Erreur lors du rejet', 'error');
            }
        }

        async function deletePhoto(photoId) {
            try {
                const photo = galleryPhotos.find(p => p.id === photoId);
                if (!photo) return;
                
                // V√©rifier les permissions
                if (photo.uploadedBy !== currentUser.id && !canModerateGallery(currentGallery, currentUser.id)) {
                    showToast('Vous n\'avez pas la permission de supprimer cette photo', 'error');
                    return;
                }
                
                // Demander confirmation
                if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?')) {
                    return;
                }
                
                // Utiliser storage pour supprimer la photo
                await storage.deletePhoto(currentGallery.id, photoId);
                
                showToast('Photo supprim√©e', 'success');
                await loadPhotos();
                
            } catch (error) {
                console.error('Erreur suppression photo:', error);
                showToast('Erreur lors de la suppression', 'error');
            }
        }

        function editPhoto(photoId) {
            const photo = galleryPhotos.find(p => p.id === photoId);
            if (!photo) return;
            
            // V√©rifier les permissions
            if (photo.uploadedBy !== currentUser.id && !canModerateGallery(currentGallery, currentUser.id)) {
                showToast('Vous n\'avez pas la permission de modifier cette photo', 'error');
                return;
            }
            
            // Afficher une modale d'√©dition
            const newTitle = prompt('Nouveau titre de la photo:', photo.metadata?.title || '');
            if (newTitle !== null) {
                updatePhotoMetadata(photoId, { title: newTitle.trim() });
            }
        }

        async function updatePhotoMetadata(photoId, metadata) {
            try {
                const photo = galleryPhotos.find(p => p.id === photoId);
                if (!photo) return;
                
                const updatedMetadata = { ...photo.metadata, ...metadata };
                
                // Utiliser storage pour mettre √† jour la photo
                await storage.updatePhoto(currentGallery.id, photoId, {
                    metadata: updatedMetadata
                });
                
                showToast('Photo modifi√©e avec succ√®s', 'success');
                await loadPhotos();
                
            } catch (error) {
                console.error('Erreur modification photo:', error);
                showToast('Erreur lors de la modification', 'error');
            }
        }

        // ============================================
        // üéØ MODAL AJOUT DE PHOTOS
        // ============================================

        function showAddPhotosModal() {
            uploadedPhotos = [];
            updatePhotosUploadList();
            
            document.getElementById('addPhotosModal').classList.add('active');
            
            // Setup drag and drop
            setupPhotosDragAndDrop();
        }

        function setupPhotosDragAndDrop() {
            const uploadArea = document.getElementById('photosUploadArea');
            if (!uploadArea) return;
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });
            
            // Bouton parcourir
            document.getElementById('browsePhotosBtn').addEventListener('click', () => {
                document.getElementById('photosFilesInput').click();
            });
            
            document.getElementById('photosFilesInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        function handleFiles(files) {
            if (!files || files.length === 0) return;
            
            const validFiles = Array.from(files).filter(file => {
                if (!file.type.startsWith('image/')) {
                    showToast(`${file.name} n'est pas une image valide`, 'error');
                    return false;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    showToast(`${file.name} d√©passe la taille maximale de 10MB`, 'error');
                    return false;
                }
                
                return true;
            });
            
            validFiles.forEach(file => {
                uploadedPhotos.push({
                    id: `preview_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    file: file,
                    previewUrl: URL.createObjectURL(file),
                    title: file.name.replace(/\.[^/.]+$/, ""),
                    description: '',
                    tags: []
                });
            });
            
            updatePhotosUploadList();
            showToast(`${validFiles.length} photo(s) ajout√©e(s)`, 'success');
        }

        function updatePhotosUploadList() {
            const grid = document.getElementById('uploadedPhotosGrid');
            const submitBtn = document.getElementById('submitPhotosBtn');
            const countSpan = document.getElementById('photosCountToAdd');
            
            countSpan.textContent = uploadedPhotos.length;
            submitBtn.disabled = uploadedPhotos.length === 0;
            
            if (uploadedPhotos.length === 0) {
                grid.innerHTML = '';
                return;
            }
            
            grid.innerHTML = uploadedPhotos.map((photo, index) => `
                <div class="uploaded-photo-item" data-photo-id="${photo.id}">
                    <div class="uploaded-photo-preview">
                        <img src="${photo.previewUrl}" alt="${photo.file.name}">
                        <button class="remove-photo-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="uploaded-photo-info">
                        <input type="text" 
                               class="form-control form-control-sm" 
                               placeholder="Titre (optionnel)" 
                               value="${escapeHtml(photo.title)}"
                               onchange="updateUploadedPhotoTitle(${index}, this.value)">
                        <textarea class="form-control form-control-sm mt-1" 
                                  placeholder="Description (optionnel)"
                                  rows="2"
                                  onchange="updateUploadedPhotoDescription(${index}, this.value)"></textarea>
                        <input type="text" 
                               class="form-control form-control-sm mt-1" 
                               placeholder="Tags (s√©par√©s par des virgules)"
                               onchange="updateUploadedPhotoTags(${index}, this.value)">
                    </div>
                </div>
            `).join('');
            
            // Ajouter les √©v√©nements de suppression
            document.querySelectorAll('.remove-photo-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const index = parseInt(this.getAttribute('data-index'));
                    removeUploadedPhoto(index);
                });
            });
        }

        function updateUploadedPhotoTitle(index, title) {
            if (uploadedPhotos[index]) {
                uploadedPhotos[index].title = title;
            }
        }

        function updateUploadedPhotoDescription(index, description) {
            if (uploadedPhotos[index]) {
                uploadedPhotos[index].description = description;
            }
        }

        function updateUploadedPhotoTags(index, tags) {
            if (uploadedPhotos[index]) {
                uploadedPhotos[index].tags = tags.split(',').map(tag => tag.trim()).filter(tag => tag);
            }
        }

        function removeUploadedPhoto(index) {
            if (uploadedPhotos[index]) {
                URL.revokeObjectURL(uploadedPhotos[index].previewUrl);
                uploadedPhotos.splice(index, 1);
                updatePhotosUploadList();
            }
        }

        async function submitPhotos() {
            try {
                if (!currentGallery || uploadedPhotos.length === 0) return;
                
                const autoApprove = document.getElementById('autoApprovePhotos').checked;
                const sendNotifications = document.getElementById('sendNotifications').checked;
                
                showLoading('photosLoader');
                
                // Upload chaque photo
                const results = {
                    success: 0,
                    failed: 0,
                    errors: []
                };
                
                for (const uploadedPhoto of uploadedPhotos) {
                    try {
                        const photoData = {
                            title: uploadedPhoto.title,
                            description: uploadedPhoto.description,
                            tags: uploadedPhoto.tags,
                            autoApprove: autoApprove
                        };
                        
                        // Utiliser storage pour ajouter la photo
                        await storage.addPhoto(currentGallery.id, uploadedPhoto.file, photoData);
                        
                        results.success++;
                        
                        // Mise √† jour progressive
                        const progress = Math.round((results.success + results.failed) / uploadedPhotos.length * 100);
                        updateUploadProgress(progress);
                        
                    } catch (error) {
                        console.error('Erreur upload photo:', error);
                        results.failed++;
                        results.errors.push(`Erreur ${uploadedPhoto.file.name}: ${error.message}`);
                    }
                }
                
                // Nettoyer les URLs d'aper√ßu
                uploadedPhotos.forEach(photo => {
                    URL.revokeObjectURL(photo.previewUrl);
                });
                
                uploadedPhotos = [];
                
                // Fermer la modale
                closeAddPhotosModal();
                hideLoading('photosLoader');
                
                // Afficher les r√©sultats
                if (results.success > 0) {
                    showToast(`${results.success} photo(s) ajout√©e(s) avec succ√®s!`, 'success');
                    
                    // Confetti pour succ√®s
                    if (results.success > 3) {
                        confetti({
                            particleCount: 100,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                    }
                }
                
                if (results.failed > 0) {
                    showToast(`${results.failed} photo(s) n'ont pas pu √™tre ajout√©es`, 'error');
                    console.error('Erreurs d√©taill√©es:', results.errors);
                }
                
                // Recharger les photos
                await loadPhotos();
                
            } catch (error) {
                console.error('Erreur ajout photos:', error);
                hideLoading('photosLoader');
                showToast('Erreur lors de l\'ajout des photos', 'error');
            }
        }

        function updateUploadProgress(progress) {
            const progressBar = document.createElement('div');
            progressBar.className = 'upload-progress-bar';
            progressBar.innerHTML = `
                <div class="progress-bar-fill" style="width: ${progress}%"></div>
                <div class="progress-text">${progress}%</div>
            `;
            
            // Mettre √† jour ou cr√©er la barre de progression
            let existingBar = document.getElementById('uploadProgressBar');
            if (!existingBar) {
                progressBar.id = 'uploadProgressBar';
                document.querySelector('.creation-navigation').prepend(progressBar);
            } else {
                existingBar.querySelector('.progress-bar-fill').style.width = `${progress}%`;
                existingBar.querySelector('.progress-text').textContent = `${progress}%`;
            }
        }

        function closeAddPhotosModal() {
            document.getElementById('addPhotosModal').classList.remove('active');
            
            // Nettoyer les URLs d'aper√ßu
            uploadedPhotos.forEach(photo => {
                URL.revokeObjectURL(photo.previewUrl);
            });
            
            uploadedPhotos = [];
            
            // R√©initialiser l'input
            document.getElementById('photosFilesInput').value = '';
        }

        // ============================================
        // üéØ MODAL MOD√âRATION
        // ============================================

        async function showModerationModal() {
            try {
                // R√©cup√©rer les photos en attente
                moderationPhotos = galleryPhotos.filter(p => p.status === 'pending');
                currentModerationIndex = 0;
                
                if (moderationPhotos.length === 0) {
                    showToast('Aucune photo en attente de mod√©ration', 'info');
                    return;
                }
                
                // Mettre √† jour les statistiques
                document.getElementById('moderationPending').textContent = moderationPhotos.length;
                document.getElementById('moderationApproved').textContent = galleryPhotos.filter(p => p.status === 'approved').length;
                document.getElementById('moderationRejected').textContent = galleryPhotos.filter(p => p.status === 'rejected').length;
                
                // Mettre √† jour la liste
                updateModerationList();
                
                // Afficher la premi√®re photo
                showCurrentModerationPhoto();
                
                // Afficher la modale
                document.getElementById('moderationModal').classList.add('active');
                
            } catch (error) {
                console.error('Erreur ouverture mod√©ration:', error);
                showToast('Erreur lors de l\'ouverture de la mod√©ration', 'error');
            }
        }

        function updateModerationList() {
            const list = document.getElementById('moderationList');
            list.innerHTML = '';
            
            moderationPhotos.forEach((photo, index) => {
                const item = document.createElement('div');
                item.className = `moderation-list-item ${index === currentModerationIndex ? 'active' : ''}`;
                item.setAttribute('data-index', index);
                item.innerHTML = `
                    <div class="moderation-list-thumb">
                        <img src="${photo.url || photo.thumbnails?.small || 'assets/images/placeholder.jpg'}" 
                             alt="${photo.filename}">
                    </div>
                    <div class="moderation-list-info">
                        <div class="moderation-list-name">${photo.filename}</div>
                        <div class="moderation-list-meta">
                            <i class="fas fa-user"></i> ${photo.uploadedByName}
                        </div>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    selectModerationPhoto(index);
                });
                
                list.appendChild(item);
            });
        }

        function showCurrentModerationPhoto() {
            if (moderationPhotos.length === 0 || currentModerationIndex >= moderationPhotos.length) {
                // Plus de photos √† mod√©rer
                document.getElementById('currentPhotoContainer').innerHTML = `
                    <div class="moderation-complete">
                        <i class="fas fa-check-circle"></i>
                        <h3>Mod√©ration termin√©e</h3>
                        <p>Toutes les photos ont √©t√© mod√©r√©es.</p>
                    </div>
                `;
                
                document.getElementById('currentPhotoInfo').innerHTML = '';
                document.getElementById('moderationActions').style.display = 'none';
                return;
            }
            
            const photo = moderationPhotos[currentModerationIndex];
            
            // Afficher la photo
            document.getElementById('currentPhotoContainer').innerHTML = `
                <img src="${photo.url || 'assets/images/placeholder.jpg'}" 
                     alt="${photo.filename}" 
                     class="moderation-photo">
            `;
            
            // Afficher les informations
            document.getElementById('currentPhotoInfo').innerHTML = `
                <div class="moderation-photo-details">
                    <h4>${photo.filename}</h4>
                    <div class="moderation-photo-meta">
                        <div class="moderation-photo-meta-item">
                            <i class="fas fa-user"></i>
                            <span>${photo.uploadedByName}</span>
                        </div>
                        <div class="moderation-photo-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${formatDate(photo.uploadedAt)}</span>
                        </div>
                        <div class="moderation-photo-meta-item">
                            <i class="fas fa-file"></i>
                            <span>${formatFileSize(photo.size || 0)}</span>
                        </div>
                    </div>
                    
                    ${photo.metadata?.description ? `
                        <div class="moderation-photo-description">
                            <h5>Description</h5>
                            <p>${escapeHtml(photo.metadata.description)}</p>
                        </div>
                    ` : ''}
                    
                    ${photo.metadata?.tags?.length > 0 ? `
                        <div class="moderation-photo-tags">
                            <h5>Tags</h5>
                            <div class="tag-list">
                                ${photo.metadata.tags.map(tag => `
                                    <span class="tag">${escapeHtml(tag)}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Mettre √† jour la liste
            updateModerationList();
        }

        function selectModerationPhoto(index) {
            currentModerationIndex = index;
            showCurrentModerationPhoto();
        }

        async function approveCurrentPhoto() {
            try {
                const photo = moderationPhotos[currentModerationIndex];
                if (!photo) return;
                
                // Utiliser storage pour approuver
                await storage.approvePhoto(currentGallery.id, photo.id);
                
                // Supprimer de la liste de mod√©ration
                moderationPhotos.splice(currentModerationIndex, 1);
                
                // Mettre √† jour les statistiques
                const approvedCount = parseInt(document.getElementById('moderationApproved').textContent) + 1;
                const pendingCount = parseInt(document.getElementById('moderationPending').textContent) - 1;
                
                document.getElementById('moderationApproved').textContent = approvedCount;
                document.getElementById('moderationPending').textContent = pendingCount;
                
                // Passer √† la photo suivante
                if (currentModerationIndex >= moderationPhotos.length) {
                    currentModerationIndex = Math.max(0, moderationPhotos.length - 1);
                }
                
                showCurrentModerationPhoto();
                showToast('Photo approuv√©e', 'success');
                
            } catch (error) {
                console.error('Erreur approbation:', error);
                showToast('Erreur lors de l\'approbation', 'error');
            }
        }

        async function rejectCurrentPhoto() {
            try {
                const photo = moderationPhotos[currentModerationIndex];
                if (!photo) return;
                
                const reason = prompt('Raison du rejet (optionnel):');
                
                // Utiliser storage pour rejeter
                await storage.rejectPhoto(currentGallery.id, photo.id, reason);
                
                // Supprimer de la liste de mod√©ration
                moderationPhotos.splice(currentModerationIndex, 1);
                
                // Mettre √† jour les statistiques
                const rejectedCount = parseInt(document.getElementById('moderationRejected').textContent) + 1;
                const pendingCount = parseInt(document.getElementById('moderationPending').textContent) - 1;
                
                document.getElementById('moderationRejected').textContent = rejectedCount;
                document.getElementById('moderationPending').textContent = pendingCount;
                
                // Passer √† la photo suivante
                if (currentModerationIndex >= moderationPhotos.length) {
                    currentModerationIndex = Math.max(0, moderationPhotos.length - 1);
                }
                
                showCurrentModerationPhoto();
                showToast('Photo rejet√©e', 'success');
                
            } catch (error) {
                console.error('Erreur rejet:', error);
                showToast('Erreur lors du rejet', 'error');
            }
        }

        function skipCurrentPhoto() {
            currentModerationIndex = (currentModerationIndex + 1) % moderationPhotos.length;
            showCurrentModerationPhoto();
        }

        function closeModerationModal() {
            document.getElementById('moderationModal').classList.remove('active');
            moderationPhotos = [];
        }

        // ============================================
        // üéØ UTILITAIRES
        // ============================================

        function showPhotoModal(photo) {
            // Cr√©er une modale simple pour afficher la photo
            const modal = document.createElement('div');
            modal.className = 'photo-modal-overlay';
            modal.innerHTML = `
                <div class="photo-modal">
                    <button class="photo-modal-close">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="photo-modal-image">
                        <img src="${photo.url}" alt="${photo.filename}">
                    </div>
                    <div class="photo-modal-info">
                        <h4>${photo.metadata?.title || photo.filename}</h4>
                        <div class="photo-modal-meta">
                            <span><i class="fas fa-user"></i> ${photo.uploadedByName}</span>
                            <span><i class="fas fa-calendar"></i> ${formatDate(photo.uploadedAt)}</span>
                            <span><i class="fas fa-eye"></i> ${photo.views || 0} vues</span>
                        </div>
                        ${photo.metadata?.description ? `
                            <p class="photo-modal-description">${escapeHtml(photo.metadata.description)}</p>
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Fermer la modale
            modal.querySelector('.photo-modal-close').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        function updateStatistics() {
            const totalGalleries = allGalleries.length;
            const totalPhotos = allGalleries.reduce((sum, g) => sum + (g.photoCount || 0), 0);
            const totalLikes = allGalleries.reduce((sum, g) => sum + (g.stats?.totalLikes || 0), 0);
            const totalComments = allGalleries.reduce((sum, g) => sum + (g.stats?.totalComments || 0), 0);
            
            document.getElementById('totalGalleries').textContent = totalGalleries;
            document.getElementById('totalPhotos').textContent = totalPhotos;
            document.getElementById('totalLikes').textContent = totalLikes;
            document.getElementById('totalComments').textContent = totalComments;
        }

        function canModerateGallery(gallery, userId) {
            return gallery.createdBy === userId || 
                   gallery.permissions?.moderators?.includes(userId) ||
                   gallery.permissions?.contributors?.includes(userId);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showToast(message, type = 'info') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: type === 'success' ? '#10B981' : 
                              type === 'error' ? '#EF4444' : 
                              type === 'warning' ? '#F59E0B' : 
                              '#3B82F6'
                }
            }).showToast();
        }

        function showLoading(loaderId) {
            const loader = document.getElementById(loaderId);
            if (loader) loader.style.display = 'block';
        }

        function hideLoading(loaderId) {
            const loader = document.getElementById(loaderId);
            if (loader) loader.style.display = 'none';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ============================================
        // üéØ √âV√âNEMENTS GLOBALES
        // ============================================

        // Exposer les fonctions globales
        window.updateUploadedPhotoTitle = updateUploadedPhotoTitle;
        window.updateUploadedPhotoDescription = updateUploadedPhotoDescription;
        window.updateUploadedPhotoTags = updateUploadedPhotoTags;

        // √âv√©nements de la modale d'ajout de photos
        document.getElementById('closeAddPhotosBtn')?.addEventListener('click', closeAddPhotosModal);
        document.getElementById('cancelAddPhotosBtn')?.addEventListener('click', closeAddPhotosModal);
        document.getElementById('submitPhotosBtn')?.addEventListener('click', submitPhotos);

        // √âv√©nements de la modale de mod√©ration
        document.getElementById('closeModerationBtn')?.addEventListener('click', closeModerationModal);
        document.getElementById('approvePhotoBtn')?.addEventListener('click', approveCurrentPhoto);
        document.getElementById('rejectPhotoBtn')?.addEventListener('click', rejectCurrentPhoto);
        document.getElementById('skipPhotoBtn')?.addEventListener('click', skipCurrentPhoto);

        // √âv√©nements globaux
        document.getElementById('importGalleryBtn')?.addEventListener('click', () => {
            showToast('Fonctionnalit√© d\'import en cours de d√©veloppement', 'info');
        });

        document.getElementById('exportGalleryBtn')?.addEventListener('click', async () => {
            if (!currentGallery) {
                showToast('Veuillez s√©lectionner une galerie', 'error');
                return;
            }
            await exportGallery();
        });

        function viewAllPhotos() {
            setPhotoFilter('all');
        }

        async function exportGallery() {
            try {
                showToast('Export en cours...', 'info');
                
                // Exporter les donn√©es de la galerie
                const exportData = {
                    gallery: currentGallery,
                    photos: galleryPhotos,
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser.id
                };
                
                // Cr√©er un blob JSON
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // T√©l√©charger
                const link = document.createElement('a');
                link.href = url;
                link.download = `export_${currentGallery.name}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                showToast('Export termin√© avec succ√®s', 'success');
                
            } catch (error) {
                console.error('Erreur export:', error);
                showToast('Erreur lors de l\'export', 'error');
            }
        }

        // Initialisation finale
        setTimeout(() => {
            updateProfileInfo();
            loadEvents();
        }, 100);

    </script>









rappelle de comment ftion les endpoint (deja utilis dans storage avce l'apple de ces fonction (utilis les ofctin pas des fetch )

server.js"







// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üì∏ ENDPOINTS GALERIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * GET /api/galleries
 * R√©cup√®re toutes les galeries avec filtres optionnels
 */
app.get('/api/galleries', (req, res) => {
    try {
        const data = loadData();
        const { eventId, userId, status, isPublic } = req.query;

        let galleries = data.galleries || [];

        // Filtres
        if (eventId) galleries = galleries.filter(g => g.eventId === eventId);
        if (userId) galleries = galleries.filter(g => g.createdBy === userId);
        if (status) galleries = galleries.filter(g => g.status === status);
        if (isPublic !== undefined) galleries = galleries.filter(g => g.isPublic === (isPublic === 'true'));

        // Enrichissement avec stats
        galleries = galleries.map(g => ({
            ...g,
            photoCount: (g.photos || []).length,
            approvedPhotoCount: (g.photos || []).filter(p => p.status === 'approved').length,
            engagementScore: calculateGalleryEngagement(g)
        }));

        log.crud('READ', 'GALLERIES', { count: galleries.length });

        res.json({
            success: true,
            galleries: galleries,
            meta: {
                total: galleries.length,
                timestamp: new Date().toISOString()
            }
        });

    } catch (err) {
        log.error('GET /api/galleries', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});



/**
 * GET /api/galleries/:id
 * R√©cup√®re une galerie sp√©cifique avec d√©tails complets
 */
app.get('/api/galleries/:id', (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        // Enrichissement
        const enrichedGallery = {
            ...gallery,
            photoCount: gallery.photos?.length || 0,
            approvedPhotos: gallery.photos?.filter(p => p.status === 'approved') || [],
            stats: {
                totalViews: (gallery.photos || []).reduce((sum, p) => sum + (p.views || 0), 0),
                totalLikes: (gallery.photos || []).reduce((sum, p) => sum + (p.likes?.length || 0), 0),
                totalComments: (gallery.photos || []).reduce((sum, p) => sum + (p.comments?.length || 0), 0),
                totalDownloads: (gallery.photos || []).reduce((sum, p) => sum + (p.downloads || 0), 0)
            },
            engagementScore: calculateGalleryEngagement(gallery),
            createdByUser: data.users?.find(u => u.id === gallery.createdBy),
            event: data.events?.find(e => e.id === gallery.eventId)
        };

        log.crud('READ', 'GALLERY', { id: req.params.id });

        res.json({
            success: true,
            gallery: enrichedGallery
        });

    } catch (err) {
        log.error('GET /api/galleries/:id', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});




/**
 * POST /api/galleries
 * Cr√©e une nouvelle galerie pour un √©v√©nement
 */
app.post('/api/galleries', jwtAuth, (req, res) => {
    try {
        const { eventId, name, description, isPublic, settings } = req.body;
        const data = loadData();

        // Validations
        if (!eventId || !name) {
            return res.status(400).json({ success: false, error: 'eventId et name requis' });
        }

        const event = data.events?.find(e => e.id === eventId);
        if (!event) {
            return res.status(404).json({ success: false, error: '√âv√©nement non trouv√©' });
        }

        // Cr√©er la galerie
        const gallery = {
            id: generateGalleryId(),
            eventId: eventId,
            name: name.trim(),
            description: description?.trim() || '',
            createdBy: req.user.id,
            createdByName: req.user.name,
            isPublic: Boolean(isPublic),
            status: 'active',
            photos: [],
            moderation: {
                enabled: settings?.moderationRequired !== false,
                approvedPhotos: [],
                pendingPhotos: [],
                rejectedPhotos: []
            },
            settings: {
                maxPhotos: settings?.maxPhotos || 1000,
                maxPhotoSize: settings?.maxPhotoSize || 8 * 1024 * 1024,
                allowedFormats: settings?.allowedFormats || ['jpg', 'jpeg', 'png', 'webp'],
                autoApprove: Boolean(settings?.autoApprove),
                allowDownloads: settings?.allowDownloads !== false,
                allowComments: settings?.allowComments !== false,
                allowLikes: settings?.allowLikes !== false,
                watermark: Boolean(settings?.watermark),
                ...settings
            },
            permissions: {
                viewers: settings?.viewers || ['all'],
                contributors: settings?.contributors || [req.user.id],
                moderators: settings?.moderators || [req.user.id]
            },
            stats: {
                totalPhotos: 0,
                totalViews: 0,
                totalLikes: 0,
                totalComments: 0,
                totalDownloads: 0
            },
            metadata: {
                coverPhoto: null,
                tags: settings?.tags || [],
                category: settings?.category || 'general',
                location: settings?.location || null
            },
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };

        // Sauvegarder
        if (!data.galleries) data.galleries = [];
        data.galleries.push(gallery);
        saveData(data);

        log.crud('CREATE', 'GALLERY', { name: gallery.name, eventId: eventId });

        res.status(201).json({
            success: true,
            gallery: gallery,
            message: 'Galerie cr√©√©e avec succ√®s'
        });

    } catch (err) {
        log.error('POST /api/galleries', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});



/**
 * PUT /api/galleries/:id
 * Met √† jour une galerie compl√®tement
 */
app.put('/api/galleries/:id', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!canEditGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Permission refus√©e' });
        }

        // Mise √† jour des champs
        const { name, description, isPublic, settings, metadata } = req.body;

        if (name) gallery.name = name.trim();
        if (description !== undefined) gallery.description = description.trim();
        if (isPublic !== undefined) gallery.isPublic = Boolean(isPublic);
        if (settings) gallery.settings = { ...gallery.settings, ...settings };
        if (metadata) gallery.metadata = { ...gallery.metadata, ...metadata };

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('UPDATE', 'GALLERY', { id: req.params.id });

        res.json({
            success: true,
            gallery: gallery,
            message: 'Galerie mise √† jour'
        });

    } catch (err) {
        log.error('PUT /api/galleries/:id', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});


/**
 * PATCH /api/galleries/:id
 * Mise √† jour partielle d'une galerie
 */
app.patch('/api/galleries/:id', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!canEditGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Permission refus√©e' });
        }

        // Patch s√©lectif
        Object.keys(req.body).forEach(key => {
            if (['name', 'description', 'isPublic', 'status'].includes(key)) {
                gallery[key] = req.body[key];
            }
        });

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        res.json({
            success: true,
            gallery: gallery
        });

    } catch (err) {
        log.error('PATCH /api/galleries/:id', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * DELETE /api/galleries/:id - Supprime une galerie
 */
app.delete('/api/galleries/:id', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (gallery.createdBy !== req.user.id) {
            return res.status(403).json({ success: false, error: 'Seul le cr√©ateur peut supprimer' });
        }

        // Supprimer les fichiers associ√©s
        gallery.photos?.forEach(photo => {
            if (photo.fileId) storageManager.deleteFile(photo.fileId);
        });

        data.galleries = data.galleries.filter(g => g.id !== req.params.id);
        saveData(data);

        log.crud('DELETE', 'GALLERY', { id: req.params.id });

        res.json({ success: true, message: 'Galerie supprim√©e' });

    } catch (err) {
        log.error('DELETE /api/galleries/:id', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});





// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üì∏ ENDPOINTS PHOTOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * GET /api/galleries/:id/photos
 * R√©cup√®re les photos d'une galerie
 */
app.get('/api/galleries/:id/photos', (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const { status, sort } = req.query;

        let photos = gallery.photos || [];

        // Filtrer par statut
        if (status) {
            photos = photos.filter(p => p.status === status);
        }

        // Tri
        if (sort === 'recent') {
            photos = photos.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
        } else if (sort === 'likes') {
            photos = photos.sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0));
        } else if (sort === 'views') {
            photos = photos.sort((a, b) => (b.views || 0) - (a.views || 0));
        }

        log.crud('READ', 'PHOTOS', { count: photos.length, galleryId: req.params.id });

        res.json({
            success: true,
            photos: photos,
            meta: {
                total: photos.length,
                approved: photos.filter(p => p.status === 'approved').length,
                pending: photos.filter(p => p.status === 'pending').length
            }
        });

    } catch (err) {
        log.error('GET /api/galleries/:id/photos', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});




/**
 * POST /api/galleries/:id/photos - Ajoute une photo avec upload
 */
app.post('/api/galleries/:id/photos', jwtAuth, upload.single('file'), async (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!canContributeGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Vous ne pouvez pas contribuer' });
        }

        if (gallery.photos.length >= gallery.settings.maxPhotos) {
            return res.status(400).json({ success: false, error: 'Galerie pleine' });
        }

        if (!req.file) {
            return res.status(400).json({ success: false, error: 'Fichier manquant' });
        }

        // Upload via storage
        const uploadedFile = await storageManager.uploadFile(
            {
                filename: req.file.originalname,
                mimetype: req.file.mimetype,
                size: req.file.size,
                buffer: req.file.buffer
            },
            'gallery',
            { userId: req.user.id, tags: JSON.parse(req.body.tags || '[]') }
        );

        // Cr√©er la photo
        const photoData = {
            id: generatePhotoId(),
            galleryId: req.params.id,
            fileId: uploadedFile.id,
            filename: uploadedFile.originalName,
            url: uploadedFile.url,
            thumbnails: uploadedFile.thumbnails,
            uploadedBy: req.user.id,
            uploadedByName: req.user.name,
            uploadedAt: new Date().toISOString(),
            size: uploadedFile.size,
            format: uploadedFile.extension,

            metadata: {
                title: req.body.title || '',
                description: req.body.description || '',
                tags: JSON.parse(req.body.tags || '[]'),
                location: req.body.location || null,
                camera: req.body.camera || null
            },

            status: gallery.settings.autoApprove ? 'approved' : 'pending',
            moderated: gallery.settings.autoApprove,
            moderatedBy: gallery.settings.autoApprove ? 'system' : null,
            moderatedAt: gallery.settings.autoApprove ? new Date().toISOString() : null,

            views: 0,
            viewedBy: [],
            likes: [],
            likedBy: [],
            comments: [],
            downloads: 0,
            downloadedBy: [],

            featured: Boolean(req.body.featured),
            isPublic: gallery.isPublic
        };

        gallery.photos.unshift(photoData);
        gallery.stats.totalPhotos = gallery.photos.length;

        if (photoData.status === 'pending') {
            gallery.moderation.pendingPhotos.push(photoData.id);
        } else {
            gallery.moderation.approvedPhotos.push(photoData.id);
        }

        if (!gallery.metadata.coverPhoto && gallery.photos.length === 1) {
            gallery.metadata.coverPhoto = photoData.id;
        }

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('CREATE', 'PHOTO', { 
            galleryId: req.params.id, 
            filename: photoData.filename,
            status: photoData.status
        });

        res.status(201).json({
            success: true,
            photo: photoData,
            message: `Photo ajout√©e (${photoData.status === 'pending' ? 'en attente' : 'approuv√©e'})`
        });

    } catch (err) {
        log.error('POST /api/galleries/:id/photos', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});


/**
 * GET /api/galleries/:galleryId/photos/:photoId - R√©cup√®re une photo
 */
app.get('/api/galleries/:galleryId/photos/:photoId', (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        // Enregistrer la vue
        if (!photo.viewedBy?.includes(req.user?.id || 'anonymous')) {
            photo.views++;
            if (req.user?.id) {
                photo.viewedBy = photo.viewedBy || [];
                photo.viewedBy.push(req.user.id);
            }
            gallery.stats.totalViews++;
            saveData(data);
        }

        res.json({
            success: true,
            photo: photo,
            stats: {
                likes: photo.likes?.length || 0,
                comments: photo.comments?.length || 0,
                views: photo.views || 0,
                downloads: photo.downloads || 0
            }
        });

    } catch (err) {
        log.error('GET /api/galleries/:galleryId/photos/:photoId', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});


/**
 * DELETE /api/galleries/:galleryId/photos/:photoId - Supprime une photo
 */
app.delete('/api/galleries/:galleryId/photos/:photoId', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photoIndex = gallery.photos?.findIndex(p => p.id === req.params.photoId);

        if (photoIndex === -1) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        const photo = gallery.photos[photoIndex];

        if (photo.uploadedBy !== req.user.id && !canModerateGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Permission refus√©e' });
        }

        if (photo.fileId) {
            storageManager.deleteFile(photo.fileId);
        }

        gallery.photos.splice(photoIndex, 1);

        gallery.stats.totalPhotos = gallery.photos.length;
        gallery.moderation.pendingPhotos = gallery.moderation.pendingPhotos.filter(id => id !== photo.id);
        gallery.moderation.approvedPhotos = gallery.moderation.approvedPhotos.filter(id => id !== photo.id);

        if (gallery.metadata.coverPhoto === photo.id) {
            gallery.metadata.coverPhoto = gallery.photos[0]?.id || null;
        }

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('DELETE', 'PHOTO', { photoId: req.params.photoId });

        res.json({ success: true, message: 'Photo supprim√©e' });

    } catch (err) {
        log.error('DELETE /api/galleries/:galleryId/photos/:photoId', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ù§Ô∏è  6. ENDPOINTS LIKES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * POST /api/galleries/:galleryId/photos/:photoId/like - Like une photo
 */
app.post('/api/galleries/:galleryId/photos/:photoId/like', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        if (!gallery.settings.allowLikes) {
            return res.status(400).json({ success: false, error: 'Les likes sont d√©sactiv√©s' });
        }

        photo.likes = photo.likes || [];
        photo.likedBy = photo.likedBy || [];

        const alreadyLiked = photo.likedBy.includes(req.user.id);

        if (alreadyLiked) {
            photo.likedBy = photo.likedBy.filter(id => id !== req.user.id);
            photo.likes = photo.likes.filter(like => like.userId !== req.user.id);
            gallery.stats.totalLikes = Math.max(0, gallery.stats.totalLikes - 1);
            saveData(data);

            return res.json({
                success: true,
                action: 'unlike',
                likes: photo.likes.length
            });
        }

        const like = {
            id: generateLikeId(),
            userId: req.user.id,
            userName: req.user.name,
            likedAt: new Date().toISOString()
        };

        photo.likes.push(like);
        photo.likedBy.push(req.user.id);
        gallery.stats.totalLikes++;

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('CREATE', 'LIKE', { photoId: req.params.photoId, userId: req.user.id });

        res.status(201).json({
            success: true,
            action: 'like',
            likes: photo.likes.length,
            like: like
        });

    } catch (err) {
        log.error('POST /api/galleries/:galleryId/photos/:photoId/like', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});



/**
 * GET /api/galleries/:galleryId/photos/:photoId/likes - R√©cup√®re les likes
 */
app.get('/api/galleries/:galleryId/photos/:photoId/likes', (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        res.json({
            success: true,
            likes: photo.likes || [],
            totalLikes: (photo.likes || []).length,
            userLiked: photo.likedBy?.includes(req.user?.id) || false
        });

    } catch (err) {
        log.error('GET /api/galleries/:galleryId/photos/:photoId/likes', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üí¨ 7. ENDPOINTS COMMENTAIRES COMPLETS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * POST /api/galleries/:galleryId/photos/:photoId/comments - Ajoute un commentaire
 */
app.post('/api/galleries/:galleryId/photos/:photoId/comments', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        if (!gallery.settings.allowComments) {
            return res.status(400).json({ success: false, error: 'Commentaires d√©sactiv√©s' });
        }

        const { content, parentCommentId } = req.body;

        if (!content || content.trim().length === 0) {
            return res.status(400).json({ success: false, error: 'Commentaire vide' });
        }

        photo.comments = photo.comments || [];

        const comment = {
            id: generateCommentId(),
            userId: req.user.id,
            userName: req.user.name,
            userAvatar: req.user.avatar || null,
            content: content.trim(),
            parentCommentId: parentCommentId || null,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            status: gallery.moderation.enabled ? 'pending' : 'approved',
            moderated: !gallery.moderation.enabled,
            likes: [],
            likedBy: [],
            replies: []
        };

        photo.comments.push(comment);
        gallery.stats.totalComments++;

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('CREATE', 'COMMENT', { photoId: req.params.photoId, userId: req.user.id });

        res.status(201).json({
            success: true,
            comment: comment,
            message: `Commentaire ${gallery.moderation.enabled ? 'en attente' : 'publi√©'}`,
            totalComments: photo.comments.length
        });

    } catch (err) {
        log.error('POST /api/galleries/:galleryId/photos/:photoId/comments', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * GET /api/galleries/:galleryId/photos/:photoId/comments - R√©cup√®re les commentaires
 */
app.get('/api/galleries/:galleryId/photos/:photoId/comments', (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        const { status } = req.query;
        let comments = photo.comments || [];

        if (status) {
            comments = comments.filter(c => c.status === status);
        }

        comments = comments.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        res.json({
            success: true,
            comments: comments,
            meta: {
                total: comments.length,
                approved: comments.filter(c => c.status === 'approved').length,
                pending: comments.filter(c => c.status === 'pending').length
            }
        });

    } catch (err) {
        log.error('GET /api/galleries/:galleryId/photos/:photoId/comments', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * PUT /api/galleries/:galleryId/photos/:photoId/comments/:commentId - Modifie un commentaire
 */
app.put('/api/galleries/:galleryId/photos/:photoId/comments/:commentId', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        const comment = photo.comments?.find(c => c.id === req.params.commentId);

        if (!comment) {
            return res.status(404).json({ success: false, error: 'Commentaire non trouv√©' });
        }

        if (comment.userId !== req.user.id) {
            return res.status(403).json({ success: false, error: 'Vous ne pouvez pas modifier' });
        }

        const { content } = req.body;

        if (!content || content.trim().length === 0) {
            return res.status(400).json({ success: false, error: 'Commentaire vide' });
        }

        comment.content = content.trim();
        comment.updatedAt = new Date().toISOString();

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        res.json({ success: true, comment: comment, message: 'Commentaire modifi√©' });

    } catch (err) {
        log.error('PUT /api/galleries/:galleryId/photos/:photoId/comments/:commentId', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * DELETE /api/galleries/:galleryId/photos/:photoId/comments/:commentId - Supprime un commentaire
 */
app.delete('/api/galleries/:galleryId/photos/:photoId/comments/:commentId', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        const commentIndex = photo.comments?.findIndex(c => c.id === req.params.commentId);

        if (commentIndex === -1) {
            return res.status(404).json({ success: false, error: 'Commentaire non trouv√©' });
        }

        const comment = photo.comments[commentIndex];

        if (comment.userId !== req.user.id && !canModerateGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Permission refus√©e' });
        }

        photo.comments.splice(commentIndex, 1);
        gallery.stats.totalComments = Math.max(0, gallery.stats.totalComments - 1);

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        res.json({ success: true, message: 'Commentaire supprim√©' });

    } catch (err) {
        log.error('DELETE /api/galleries/:galleryId/photos/:photoId/comments/:commentId', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * POST /api/galleries/:galleryId/photos/:photoId/comments/:commentId/like - Like un commentaire
 */
app.post('/api/galleries/:galleryId/photos/:photoId/comments/:commentId/like', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        const comment = photo.comments?.find(c => c.id === req.params.commentId);

        if (!comment) {
            return res.status(404).json({ success: false, error: 'Commentaire non trouv√©' });
        }

        comment.likedBy = comment.likedBy || [];
        const alreadyLiked = comment.likedBy.includes(req.user.id);

        if (alreadyLiked) {
            comment.likedBy = comment.likedBy.filter(id => id !== req.user.id);
            comment.likes = (comment.likes || []).filter(like => like.userId !== req.user.id);
        } else {
            comment.likedBy.push(req.user.id);
            comment.likes = comment.likes || [];
            comment.likes.push({
                userId: req.user.id,
                likedAt: new Date().toISOString()
            });
        }

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        res.json({
            success: true,
            comment: comment,
            action: alreadyLiked ? 'unlike' : 'like',
            likes: (comment.likes || []).length
        });

    } catch (err) {
        log.error('POST /api/galleries/:galleryId/photos/:photoId/comments/:commentId/like', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üìä 8. ENDPOINTS MOD√âRATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * POST /api/galleries/:galleryId/photos/:photoId/approve - Approuve une photo
 */
app.post('/api/galleries/:galleryId/photos/:photoId/approve', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!canModerateGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Permission refus√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        if (photo.status !== 'pending') {
            return res.status(400).json({ success: false, error: 'Photo non en attente' });
        }

        photo.status = 'approved';
        photo.moderated = true;
        photo.moderatedBy = req.user.id;
        photo.moderatedAt = new Date().toISOString();

        gallery.moderation.pendingPhotos = gallery.moderation.pendingPhotos.filter(id => id !== photo.id);
        gallery.moderation.approvedPhotos.push(photo.id);

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('APPROVE', 'PHOTO', { photoId: req.params.photoId });

        res.json({ success: true, photo: photo, message: 'Photo approuv√©e' });

    } catch (err) {
        log.error('POST /api/galleries/:galleryId/photos/:photoId/approve', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * POST /api/galleries/:galleryId/photos/:photoId/reject - Rejette une photo
 */
app.post('/api/galleries/:galleryId/photos/:photoId/reject', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!canModerateGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Permission refus√©e' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        if (photo.status !== 'pending') {
            return res.status(400).json({ success: false, error: 'Photo non en attente' });
        }

        const { reason } = req.body;

        photo.status = 'rejected';
        photo.moderated = true;
        photo.moderatedBy = req.user.id;
        photo.moderatedAt = new Date().toISOString();
        photo.rejectionReason = reason || 'Pas de raison';

        gallery.moderation.pendingPhotos = gallery.moderation.pendingPhotos.filter(id => id !== photo.id);
        gallery.moderation.rejectedPhotos.push(photo.id);

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('REJECT', 'PHOTO', { photoId: req.params.photoId });

        res.json({ success: true, photo: photo, message: 'Photo rejet√©e' });

    } catch (err) {
        log.error('POST /api/galleries/:galleryId/photos/:photoId/reject', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * GET /api/galleries/:id/moderation - Photos en attente
 */
app.get('/api/galleries/:id/moderation', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!canModerateGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Permission refus√©e' });
        }

        const pendingPhotos = (gallery.photos || [])
            .filter(p => p.status === 'pending')
            .map(p => ({
                id: p.id,
                filename: p.filename,
                url: p.url,
                uploadedBy: p.uploadedByName,
                uploadedAt: p.uploadedAt
            }));

        res.json({
            success: true,
            pendingPhotos: pendingPhotos,
            total: pendingPhotos.length
        });

    } catch (err) {
        log.error('GET /api/galleries/:id/moderation', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * GET /api/galleries/:id/stats - Statistiques galerie
 */
app.get('/api/galleries/:id/stats', (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        const stats = {
            totalPhotos: gallery.photos?.length || 0,
            approvedPhotos: (gallery.photos || []).filter(p => p.status === 'approved').length,
            pendingPhotos: (gallery.photos || []).filter(p => p.status === 'pending').length,
            rejectedPhotos: (gallery.photos || []).filter(p => p.status === 'rejected').length,

            totalViews: gallery.stats?.totalViews || 0,
            totalLikes: gallery.stats?.totalLikes || 0,
            totalComments: gallery.stats?.totalComments || 0,
            totalDownloads: gallery.stats?.totalDownloads || 0,

            engagement: {
                avgLikesPerPhoto: gallery.photos?.length > 0 
                    ? ((gallery.photos || []).reduce((sum, p) => sum + (p.likes?.length || 0), 0) / gallery.photos.length).toFixed(2)
                    : 0,
                avgCommentsPerPhoto: gallery.photos?.length > 0
                    ? ((gallery.photos || []).reduce((sum, p) => sum + (p.comments?.length || 0), 0) / gallery.photos.length).toFixed(2)
                    : 0,
                avgViewsPerPhoto: gallery.photos?.length > 0
                    ? ((gallery.photos || []).reduce((sum, p) => sum + (p.views || 0), 0) / gallery.photos.length).toFixed(2)
                    : 0
            },

             recentPhotos: (gallery.photos || [])
                .slice(0, 5)
                .map(p => ({
                    id: p.id,
                    filename: p.filename,
                    uploadedAt: p.uploadedAt,
                    likes: p.likes?.length || 0,
                    comments: p.comments?.length || 0,
                    views: p.views || 0
                })),

            topPhotos: (gallery.photos || [])
                .filter(p => p.status === 'approved')
                .sort((a, b) => (b.likes?.length || 0) - (a.likes?.length || 0))
                .slice(0, 5)
                .map(p => ({
                    id: p.id,
                    filename: p.filename,
                    likes: p.likes?.length || 0,
                    views: p.views || 0
                }))
        };

        res.json({ success: true, stats: stats });

    } catch (err) {
        log.error('GET /api/galleries/:id/stats', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});



/**
 * POST /api/galleries/:id/permissions
 * Met √† jour les permissions d'une galerie
 */
app.post('/api/galleries/:id/permissions', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!canEditGallery(gallery, req.user.id)) {
            return res.status(403).json({ success: false, error: 'Permission refus√©e' });
        }

        const { viewers, contributors, moderators } = req.body;

        if (viewers) gallery.permissions.viewers = viewers;
        if (contributors) gallery.permissions.contributors = contributors;
        if (moderators) gallery.permissions.moderators = moderators;

        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('UPDATE', 'PERMISSIONS', { galleryId: req.params.id });

        res.json({
            success: true,
            permissions: gallery.permissions,
            message: 'Permissions mises √† jour'
        });

    } catch (err) {
        log.error('POST /api/galleries/:id/permissions', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üì• 9. ENDPOINTS T√âL√âCHARGEMENTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * POST /api/galleries/:galleryId/photos/:photoId/download - T√©l√©charge une photo
 */
app.post('/api/galleries/:galleryId/photos/:photoId/download', jwtAuth, (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.galleryId);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!gallery.settings.allowDownloads) {
            return res.status(400).json({ success: false, error: 'T√©l√©chargements d√©sactiv√©s' });
        }

        const photo = gallery.photos?.find(p => p.id === req.params.photoId);

        if (!photo) {
            return res.status(404).json({ success: false, error: 'Photo non trouv√©e' });
        }

        photo.downloads = (photo.downloads || 0) + 1;
        photo.downloadedBy = photo.downloadedBy || [];
        photo.downloadedBy.push({
            userId: req.user.id,
            downloadedAt: new Date().toISOString()
        });

        gallery.stats.totalDownloads++;
        gallery.updatedAt = new Date().toISOString();
        saveData(data);

        log.crud('DOWNLOAD', 'PHOTO', { photoId: req.params.photoId, userId: req.user.id });

        res.json({
            success: true,
            downloadUrl: photo.url,
            filename: photo.filename,
            message: 'T√©l√©chargement enregistr√©'
        });

    } catch (err) {
        log.error('POST /api/galleries/:galleryId/photos/:photoId/download', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * GET /api/galleries/:id/download/zip - T√©l√©charge la galerie en ZIP
 */
app.get('/api/galleries/:id/download/zip', jwtAuth, async (req, res) => {
    try {
        const data = loadData();
        const gallery = data.galleries?.find(g => g.id === req.params.id);

        if (!gallery) {
            return res.status(404).json({ success: false, error: 'Galerie non trouv√©e' });
        }

        if (!gallery.settings.allowDownloads) {
            return res.status(400).json({ success: false, error: 'T√©l√©chargements d√©sactiv√©s' });
        }

        const archive = archiver('zip', { zlib: { level: 9 } });

        res.attachment(`${gallery.name}_${moment().format('YYYY-MM-DD')}.zip`);
        archive.pipe(res);

        gallery.photos?.forEach(photo => {
            const filePath = path.join(storageManager.galleriesDir, photo.filename);
            if (fs.existsSync(filePath)) {
                archive.file(filePath, { name: photo.filename });
            }
        });

        await archive.finalize();

        log.crud('DOWNLOAD', 'GALLERY_ZIP', { galleryId: req.params.id });

    } catch (err) {
        log.error('GET /api/galleries/:id/download/zip', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üíæ 14. ENDPOINTS STOCKAGE & NETTOYAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * GET /api/storage/stats - Statistiques de stockage
 */
app.get('/api/storage/stats', jwtAuth, (req, res) => {
    try {
        const stats = storageManager.getStorageStats();

        res.json({
            success: true,
            storage: stats,
            provider: process.env.CLOUD_PROVIDER || 'local',
            quota: '100GB'
        });

    } catch (err) {
        log.error('GET /api/storage/stats', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

/**
 * POST /api/storage/cleanup - Nettoie les fichiers temp
 */
app.post('/api/storage/cleanup', jwtAuth, (req, res) => {
    try {
        const deleted = storageManager.cleanupTempFiles();

        res.json({
            success: true,
            message: 'Nettoyage effectu√©',
            filesDeleted: deleted
        });

    } catch (err) {
        log.error('POST /api/storage/cleanup', err.message);
        res.status(500).json({ success: false, error: err.message });
    }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// üõ†Ô∏è 15. FONCTIONS UTILITAIRES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

/**
 * V√©rifie si l'utilisateur peut √©diter une galerie
 */
function canEditGallery(gallery, userId) {
    return gallery.createdBy === userId || gallery.permissions?.moderators?.includes(userId);
}

/**
 * V√©rifie si l'utilisateur peut contribuer √† une galerie
 */
function canContributeGallery(gallery, userId) {
    return gallery.createdBy === userId || 
           gallery.permissions?.contributors?.includes(userId) ||
           gallery.permissions?.moderators?.includes(userId);
}

/**
 * V√©rifie si l'utilisateur peut mod√©rer une galerie
 */
function canModerateGallery(gallery, userId) {
    return gallery.createdBy === userId || gallery.permissions?.moderators?.includes(userId);
}

/**
 * Calcule le score d'engagement d'une galerie
 */
function calculateGalleryEngagement(gallery) {
    const totalLikes = (gallery.photos || []).reduce((sum, p) => sum + (p.likes?.length || 0), 0);
    const totalComments = (gallery.photos || []).reduce((sum, p) => sum + (p.comments?.length || 0), 0);
    const totalViews = gallery.stats?.totalViews || 0;
    const photoCount = gallery.photos?.length || 1;

    return Math.round(((totalLikes * 2 + totalComments * 3 + totalViews) / photoCount) || 0);
}





et les focntion storag a implemenet toute au grand complet :





    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üì∏ GALERIES (6 endpoints)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async getGalleries(eventId, filters = {}, forceRefresh = false) {
        try {
            // Utiliser le cache si pas de forceRefresh et donn√©es existantes
            if (!forceRefresh && this.data.galleries?.length > 0) {
                return this.data.galleries;
            }

            const query = new URLSearchParams({ eventId, ...filters }).toString();
            const result = await this.apiRequest(`/galleries?${query}`);
            if (result.success) {
                this.data.galleries = result.galleries || [];
                this.emit('data:synced', { galleries: this.data.galleries });
                return this.data.galleries;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå getGalleries:', err);
            // Retourner le cache m√™me en cas d'erreur
            return this.data.galleries || [];
        }
    }

    async getGallery(galleryId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}`);
            if (result.success) {
                const idx = this.data.galleries.findIndex(g => g.id === galleryId);
                if (idx >= 0) this.data.galleries[idx] = result.gallery;
                else this.data.galleries.push(result.gallery);
                this.emit('gallery:updated', result.gallery);
                return result.gallery;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå getGallery:', err);
            return null;
        }
    }

    async createGallery(eventId, name, opts = {}) {
        try {
            const result = await this.apiRequest('/galleries', {
                method: 'POST',
                body: JSON.stringify({
                    eventId, name,
                    description: opts.description || '',
                    isPublic: opts.isPublic || false,
                    settings: opts.settings || {}
                })
            });
            if (result.success) {
                this.data.galleries.push(result.gallery);
                this.emit('gallery:created', result.gallery);
                this.saveToLocalStorage();
                return result.gallery;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå createGallery:', err);
            throw err;
        }
    }

    async updateGallery(galleryId, updates) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}`, {
                method: 'PUT',
                body: JSON.stringify(updates)
            });
            if (result.success) {
                const idx = this.data.galleries.findIndex(g => g.id === galleryId);
                if (idx >= 0) this.data.galleries[idx] = result.gallery;
                this.emit('gallery:updated', result.gallery);
                this.saveToLocalStorage();
                return result.gallery;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå updateGallery:', err);
            throw err;
        }
    }

    async deleteGallery(galleryId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}`, { method: 'DELETE' });
            if (result.success) {
                this.data.galleries = this.data.galleries.filter(g => g.id !== galleryId);
                this.emit('gallery:deleted', { id: galleryId });
                this.saveToLocalStorage();
                return true;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå deleteGallery:', err);
            throw err;
        }
    }

    async getGalleryStats(galleryId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/stats`);
            if (result.success) return result.stats;
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå getGalleryStats:', err);
            return null;
        }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üì∑ PHOTOS (8 endpoints)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async getPhotos(galleryId, opts = {}) {
        try {
            const query = new URLSearchParams(opts).toString();
            const result = await this.apiRequest(`/galleries/${galleryId}/photos?${query}`);
            if (result.success) {
                this.data.photos = result.photos || [];
                return this.data.photos;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå getPhotos:', err);
            return [];
        }
    }

    async addPhoto(galleryId, file, metadata = {}) {
        try {
            const fd = new FormData();
            fd.append('file', file);
            fd.append('title', metadata.title || file.name);
            fd.append('description', metadata.description || '');
            fd.append('tags', JSON.stringify(metadata.tags || []));

            const result = await this.apiRequest(`/galleries/${galleryId}/photos`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${this.token}` },
                body: fd
            });

            if (result.success) {
                this.data.photos.push(result.photo);
                this.emit('photo:added', result.photo);
                this.saveToLocalStorage();
                return result.photo;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå addPhoto:', err);
            throw err;
        }
    }

    async deletePhoto(galleryId, photoId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}`, {
                method: 'DELETE'
            });
            if (result.success) {
                this.data.photos = this.data.photos.filter(p => p.id !== photoId);
                this.emit('photo:deleted', { id: photoId });
                this.saveToLocalStorage();
                return true;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå deletePhoto:', err);
            throw err;
        }
    }

    async approvePhoto(galleryId, photoId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/approve`, {
                method: 'POST'
            });
            if (result.success) {
                this.emit('photo:approved', result.photo);
                this.saveToLocalStorage();
                return result.photo;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå approvePhoto:', err);
            throw err;
        }
    }

    async rejectPhoto(galleryId, photoId, reason = '') {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/reject`, {
                method: 'POST',
                body: JSON.stringify({ reason })
            });
            if (result.success) {
                this.emit('photo:rejected', result.photo);
                this.saveToLocalStorage();
                return result.photo;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå rejectPhoto:', err);
            throw err;
        }
    }

    async downloadGalleryZip(galleryId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/download/zip`);
            if (result.success && result.downloadUrl) {
                window.open(result.downloadUrl, '_blank');
                return true;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå downloadGalleryZip:', err);
            throw err;
        }
    }





    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üì∑ PHOTOS (8 endpoints)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async getPhotos(galleryId, opts = {}) {
        try {
            const query = new URLSearchParams(opts).toString();
            const result = await this.apiRequest(`/galleries/${galleryId}/photos?${query}`);
            if (result.success) {
                this.data.photos = result.photos || [];
                return this.data.photos;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå getPhotos:', err);
            return [];
        }
    }

    async addPhoto(galleryId, file, metadata = {}) {
        try {
            const fd = new FormData();
            fd.append('file', file);
            fd.append('title', metadata.title || file.name);
            fd.append('description', metadata.description || '');
            fd.append('tags', JSON.stringify(metadata.tags || []));

            const result = await this.apiRequest(`/galleries/${galleryId}/photos`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${this.token}` },
                body: fd
            });

            if (result.success) {
                this.data.photos.push(result.photo);
                this.emit('photo:added', result.photo);
                this.saveToLocalStorage();
                return result.photo;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå addPhoto:', err);
            throw err;
        }
    }

    async deletePhoto(galleryId, photoId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}`, {
                method: 'DELETE'
            });
            if (result.success) {
                this.data.photos = this.data.photos.filter(p => p.id !== photoId);
                this.emit('photo:deleted', { id: photoId });
                this.saveToLocalStorage();
                return true;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå deletePhoto:', err);
            throw err;
        }
    }

    async approvePhoto(galleryId, photoId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/approve`, {
                method: 'POST'
            });
            if (result.success) {
                this.emit('photo:approved', result.photo);
                this.saveToLocalStorage();
                return result.photo;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå approvePhoto:', err);
            throw err;
        }
    }

    async rejectPhoto(galleryId, photoId, reason = '') {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/reject`, {
                method: 'POST',
                body: JSON.stringify({ reason })
            });
            if (result.success) {
                this.emit('photo:rejected', result.photo);
                this.saveToLocalStorage();
                return result.photo;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå rejectPhoto:', err);
            throw err;
        }
    }

    async downloadGalleryZip(galleryId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/download/zip`);
            if (result.success && result.downloadUrl) {
                window.open(result.downloadUrl, '_blank');
                return true;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå downloadGalleryZip:', err);
            throw err;
        }
    }



    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ù§Ô∏è LIKES (2 endpoints)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async likePhoto(galleryId, photoId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/like`, {
                method: 'POST'
            });
            if (result.success) {
                this.emit(result.action === 'like' ? 'like:added' : 'like:removed', { photoId });
                this.saveToLocalStorage();
                return result;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå likePhoto:', err);
            throw err;
        }
    }

    async getLikes(galleryId, photoId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/likes`);
            if (result.success) return result.likes;
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå getLikes:', err);
            return [];
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üí¨ COMMENTAIRES (5 endpoints)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    async addComment(galleryId, photoId, content) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/comments`, {
                method: 'POST',
                body: JSON.stringify({ content })
            });
            if (result.success) {
                this.emit('comment:added', result.comment);
                this.saveToLocalStorage();
                return result.comment;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå addComment:', err);
            throw err;
        }
    }

    async getComments(galleryId, photoId, opts = {}) {
        try {
            const query = new URLSearchParams(opts).toString();
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/comments?${query}`);
            if (result.success) return result.comments;
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå getComments:', err);
            return [];
        }
    }

    async updateComment(galleryId, photoId, commentId, content) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/comments/${commentId}`, {
                method: 'PUT',
                body: JSON.stringify({ content })
            });
            if (result.success) {
                this.emit('comment:updated', result.comment);
                this.saveToLocalStorage();
                return result.comment;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå updateComment:', err);
            throw err;
        }
    }

    async deleteComment(galleryId, photoId, commentId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/comments/${commentId}`, {
                method: 'DELETE'
            });
            if (result.success) {
                this.emit('comment:deleted', { id: commentId });
                this.saveToLocalStorage();
                return true;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå deleteComment:', err);
            throw err;
        }
    }

    async likeComment(galleryId, photoId, commentId) {
        try {
            const result = await this.apiRequest(`/galleries/${galleryId}/photos/${photoId}/comments/${commentId}/like`, {
                method: 'POST'
            });
            if (result.success) {
                this.emit('comment:liked', result.comment);
                this.saveToLocalStorage();
                return result;
            }
            throw new Error(result.error);
        } catch (err) {
            console.error('‚ùå likeComment:', err);
            throw err;
        }
    }





donne moi le long et puissnat script complet de l apge gallerie.html au grand coplet