<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SECURA | Gestion des Tables</title>
    <link rel="icon" href="assets/images/icon.png" type="image/x-icon">
    
    <!-- Styles et Polices -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Styles locaux -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/loading.css">
    <link rel="stylesheet" href="css/dash.css">
    <link rel="stylesheet" href="css/toastify.css">
    <link rel="stylesheet" href="css/index.css">
    
    <!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Librairies pour QR Code et téléchargements en masse -->
    <script src="https://cdn.jsdelivr.net/npm/easyqrcodejs@4.4.13/dist/easy.qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    
    
    <style>
        /* stylelint-disable */
        /* ==========================================
           VARIABLES GLOBALES POUR LES THÈMES
           ========================================== */
        :root {
            /* Thème clair (par défaut) */
            --primary: #D97706;
            --primary-dark: #B45309;
            --primary-light: #F59E0B;
            --dark: #0A0A0A;
            --dark-card: #121212;
            --dark-elevated: #1A1A1A;
            --gradient: linear-gradient(135deg, #B45309 0%, #D97706 50%, #F59E0B 100%);
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --border-radius: 0.5rem;
            --border-radius-sm: 0.375rem;
            --card-shadow: 0 12px 40px rgba(0,0,0,0.4);
            
            /* Variables pour thème clair */
            --body-bg: #ffffff;
            --text-color: #333333;

            --text-color-chart: #ffffff;

            --card-bg: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #e0e0e0;
            --input-text: #333333;
            --placeholder-color: #666666;
            --border-color: rgba(0, 0, 0, 0.1);
            --hover-bg: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --progress-bg: rgba(0, 0, 0, 0.05);
        }

        /* Variables pour thème sombre */
        .dark-theme {
            --body-bg: #0A0A0A;
            --text-color: #ffffff;

            --text-color-chart: #333333;
            --card-bg: #121212;
            --input-bg: rgba(255, 255, 255, 0.04);
            --input-border: rgba(255, 255, 255, 0.12);
            --input-text: #ffffff;
            --placeholder-color: rgba(255, 255, 255, 0.4);
            --border-color: rgba(255, 255, 255, 0.1);
            --hover-bg: rgba(255, 255, 255, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --progress-bg: rgba(0, 0, 0, 0.2);
        }

        /* ==========================================
           STYLES DE BASE
           ========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            
            min-height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            
        }

        body {
            background-image:
                radial-gradient(circle at 10% 20%, rgba(217, 119, 6, 0.15) 0%, transparent 30%),
                radial-gradient(circle at 90% 80%, rgba(217, 119, 6, 0.15) 0%, transparent 30%);
        }

        .dark-theme body {
            background-image:
                radial-gradient(circle at 10% 20%, rgba(217, 119, 6, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(217, 119, 6, 0.08) 0%, transparent 40%);
        }

        .event-title {
            color: white !important;
        }
        /* === CONTENEUR PRINCIPAL === */
        .tables-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            margin-top: 100px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        /* === EN-TÊTE DE PAGE AMÉLIORÉ === */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .page-title h1 {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-title .event-name {
            font-size: 1rem;
            color: var(--text-color);
            opacity: 0.7;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background: var(--hover-bg);
            border-radius: var(--border-radius-sm);
            color: var(--text-color);
            text-decoration: none;
            font-size: 0.9rem;
            
        }

        .back-icon-link {
            width: 32px;
            height: 32px;
        }

        .back-link:hover {
            background: var(--primary);
            color: white;
            transform: translateX(-3px);
        }

        .page-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* === BOUTONS === */
        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

       

        .btn-secondary {
            background: var(--hover-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--input-bg);
            color: var(--text-color);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #0DA673;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
            transform: translateY(-2px);
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #2563EB;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-xs {
            padding: 6px 12px;
            font-size: 0.75rem;
            gap: 5px;
        }

        /* Classe active pour les boutons du modal QR */
        #qrBulkPrevBtn.active {
            display: inline-flex !important;
        }

        #qrBulkPrevBtn:not(.active) {
            display: none !important;
        }

        #qrBulkContinueBtn.active {
            display: inline-flex !important;
        }


        /* === VUE TABLEAU DES TABLES === */
        .tables-table-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            min-height: 500px;
            display: none;
        }

        .tables-table {
            width: 100%;
            border-collapse: collapse;
        }

        .tables-table th {
            background: var(--hover-bg);
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
        }

        .tables-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .tables-table tbody tr:hover {
            background: rgba(217, 119, 6, 0.05);
        }

        /* === TABLEAU DE SÉLECTION QR === */
        #qrTablesSelectionTable {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        #qrTablesSelectionTable thead {
            background: var(--hover-bg);
            border-bottom: 2px solid var(--border-color);
        }

        #qrTablesSelectionTable tbody {
            display: block;
            max-height: 380px;
            overflow-y: auto;
        }

        #qrTablesSelectionTable thead tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        #qrTablesSelectionTable tbody tr {
            display: table;
            width: 100%;
            table-layout: fixed;
        }

        #qrTablesSelectionTable th {
            padding: 14px;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-color);
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #qrTablesSelectionTable td {
            padding: 12px 14px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.95rem;
            color: var(--text-color);
        }

        #qrTablesSelectionTable tbody tr {
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        #qrTablesSelectionTable tbody tr:hover {
            background: rgba(217, 119, 6, 0.08);
        }

        #qrTablesSelectionTable tbody tr.qr-table-row {
            cursor: pointer;
            user-select: none;
        }

        #qrTablesSelectionTable tbody tr.qr-table-row input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* CUSTOM SCROLLBAR */
        #qrTablesSelectionTable tbody::-webkit-scrollbar {
            width: 3px;
        }

        #qrTablesSelectionTable tbody::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .dark-theme #qrTablesSelectionTable tbody::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        #qrTablesSelectionTable tbody::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        #qrTablesSelectionTable tbody::-webkit-scrollbar-thumb:hover {
            background: var(--primary-light);
        }

        /* === VUE VISUELLE DES TABLES (PLAN DE SALLE) === */
        .visual-layout-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            min-height: 500px;
            display: none;
        }

        .layout-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .layout-view {
            display: flex;
            gap: 15px;
        }

        .layout-btn {
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            cursor: pointer;
            
        }

        .layout-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .layout-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .visual-layout {
            display: flex;
            flex-direction: column;
            gap: 40px;
            max-width: 100%;
            overflow-x: auto;
            padding: 20px;
        }

        .table-row {
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;

            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* === REPRÉSENTATION VISUELLE D'UNE TABLE === */
        .table-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .table-shape {
            width: 120px;
            height: 80px;
            background: var(--card-bg);
            border: 2px solid var(--primary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            
            cursor: pointer;
        }

        .table-shape:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(217, 119, 6, 0.2);
        }

        .table-shape.full {
            border-color: var(--danger);
            background: rgba(239, 68, 68, 0.05);
        }

        .table-shape.empty {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .table-visual-info {
            text-align: center;
        }

        .table-visual-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .table-visual-name {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .table-visual-capacity {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.5;
        }

        /* === CHAISES AUTOUR DE LA TABLE === */
        .chairs-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }

        .chair {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            
        }

        .chair.empty {
            background: #666;
            opacity: 0.3;
        }

        .chair.occupied {
            background: var(--primary);
        }

        .chair.vip {
            background: var(--warning);
        }

        /* === VUE STATISTIQUES === */
        .stats-view-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            min-height: 500px;
            display: none;
        }

        .stats-view-container.active {
            display: block;
        }

        .stats-view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card-advanced {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            
            position: relative;
            overflow: hidden;
        }

        .stat-card-advanced:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-color);
        }

        .stat-card-advanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }

        .stat-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 10px;
            background: var(--gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-details {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* === CHARTS === */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-top: 40px;
        }

        .chart-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
        }

        .chart-card canvas {
            max-height: 300px;
            width: 100% !important;
            background-color: white;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }


        .chart-title i {
            color: var(--primary);
        }

        .chart-placeholder {
            width: 100%;
            height: 300px;
            background: var(--hover-bg);
            border-radius: var(--border-radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            opacity: 0.5;
        }

        

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-slide-in {
            animation: slideIn 0.4s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }


        /* Styles pour les graphiques avancés */
.advanced-charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 25px;
    margin-top: 30px;
}

.chart-card.advanced {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.chart-card.advanced:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    border-color: var(--primary);
}

.chart-placeholder.advanced {
    min-height: 350px;
    position: relative;
}

.chart-subtitle {
    font-size: 0.85rem;
    color: var(--text-color);
    opacity: 0.7;
    margin-left: 10px;
    font-weight: 400;
}

/* KPI Cards */
.kpi-grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.kpi-card {
    background: linear-gradient(135deg, var(--card-bg), rgba(255,255,255,0.05));
    border: 1px solid var(--border-color);
    border-radius: 16px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 20px;
    transition: all 0.3s ease;
}

.kpi-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border-color: var(--primary);
}

.kpi-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: white;
}

.kpi-card.trending .kpi-icon {
    background: linear-gradient(135deg, #3B82F6, #8B5CF6);
}

.kpi-card.efficiency .kpi-icon {
    background: linear-gradient(135deg, #10B981, #3B82F6);
}

.kpi-card.diversity .kpi-icon {
    background: linear-gradient(135deg, #F59E0B, #EC4899);
}

.kpi-card.prediction .kpi-icon {
    background: linear-gradient(135deg, #8B5CF6, #EC4899);
}

.kpi-content {
    flex: 1;
}

.kpi-value {
    font-size: 2.2rem;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 5px;
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: var(--text-color);
}

.kpi-label {
    font-size: 0.95rem;
    color: var(--text-color);
    opacity: 0.8;
    margin-bottom: 5px;
}

.kpi-trend {
    font-size: 0.85rem;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 20px;
    display: inline-block;
}

.kpi-trend.positive {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
}

.kpi-trend.stable {
    background: rgba(59, 130, 246, 0.15);
    color: var(--info);
}

/* Responsive */
@media (max-width: 1200px) {
    .advanced-charts-container {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .chart-card.advanced {
        padding: 20px;
    }
    
    .chart-placeholder.advanced {
        min-height: 300px;
    }
    
    .kpi-grid-container {
        grid-template-columns: 1fr;
    }
}

        /* === NOUVELLE VUE VECTORIELLE DES TABLES === */
.vector-tables-container {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 30px;
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 30px var(--shadow-color);
    min-height: 500px;
    display: none;
}

.vector-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.shape-selector {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.shape-btn {
    padding: 10px 20px;
    border-radius: var(--border-radius-sm);
    background: var(--hover-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    cursor: pointer;
    
    display: flex;
    align-items: center;
    gap: 8px;
}

.shape-btn:hover {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.shape-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

.vector-canvas {
    width: 100%;
    min-height: 600px;
    background: var(--hover-bg);
    border-radius: var(--border-radius);
    position: relative;
    overflow: auto;
    padding: 40px;
}

.table-vector-item {
    position: absolute;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.table-vector-item:hover {
    transform: scale(1.05);
    z-index: 100;
}

/* Formes vectorielles */
.table-shape-circle {
    width: 180px;
    height: 180px;
    border-radius: 50%;
    border: 3px solid var(--primary);
    background: rgba(217, 119, 6, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 8px 25px rgba(217, 119, 6, 0.15);
}

.table-shape-rectangle {
    width: 220px;
    height: 140px;
    border-radius: 12px;
    border: 3px solid var(--primary);
    background: rgba(217, 119, 6, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 8px 25px rgba(217, 119, 6, 0.15);
}

.table-shape-pentagon {
    width: 180px;
    height: 180px;
    clip-path: polygon(50% 0%, 100% 38%, 82% 100%, 18% 100%, 0% 38%);
    border: 3px solid var(--primary);
    background: rgba(217, 119, 6, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 8px 25px rgba(217, 119, 6, 0.15);
}

.table-shape-hexagon {
    width: 180px;
    height: 180px;
    clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
    border: 3px solid var(--primary);
    background: rgba(217, 119, 6, 0.1);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: 0 8px 25px rgba(217, 119, 6, 0.15);
}

.table-shape-full {
    border-color: var(--danger);
    background: rgba(239, 68, 68, 0.1);
}

.table-shape-empty {
    border-color: var(--success);
    background: rgba(16, 185, 129, 0.1);
}

/* Chaises autour des tables */
.chairs-ring {
    position: absolute;
    width: 100%;
    height: 100%;
    border-radius: 50%;
}

.chair-dot {
    position: absolute;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: white;
    font-weight: 600;
    transform: translate(-50%, -50%);
    transition: all 0.3s ease;
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    border: 2px solid white;
}

.chair-dot:hover {
    transform: translate(-50%, -50%) scale(1.3);
    z-index: 10;
}

.chair-dot.empty {
    background: linear-gradient(135deg, #6B7280, #9CA3AF);
    cursor: not-allowed;
}

.chair-dot.occupied {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    cursor: pointer;
}

.chair-dot.vip {
    background: linear-gradient(135deg, var(--warning), #D97706);
}

.chair-dot.group {
    width: 36px;
    height: 36px;
    font-size: 0.8rem;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
}

/* Info bulle pour les chaises avec groupe */
.chair-tooltip {
    position: absolute;
    top: -45px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--dark-card);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.chair-dot:hover .chair-tooltip {
    opacity: 1;
    visibility: visible;
    top: -55px;
}

/* Info de la table vectorielle */
.table-vector-info {
    text-align: center;
    padding: 10px;
    z-index: 2;
    background: rgba(0,0,0,0.7);
    border-radius: 8px;
    margin: 10px;
    backdrop-filter: blur(10px);
}

.table-vector-number {
    font-size: 1.4rem;
    font-weight: 800;
    color: white;
    margin-bottom: 5px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.table-vector-name {
    font-size: 0.9rem;
    color: rgba(255,255,255,0.9);
    margin-bottom: 5px;
}

.table-vector-stats {
    display: flex;
    gap: 10px;
    justify-content: center;
    font-size: 0.8rem;
    color: rgba(255,255,255,0.8);
}

/* Zoom controls */
.zoom-controls {
    position: absolute;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 100;
}

.zoom-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    
    font-size: 1.2rem;
}

.zoom-btn:hover {
    background: var(--primary);
    color: white;
    transform: scale(1.1);
}

/* Nouveaux stat cards pour l'événement */
.event-stats-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.event-stat-card {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 20px;
    border-left: 4px solid var(--primary);
    
}

.event-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px var(--shadow-color);
}

.event-stat-title {
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.7;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.event-stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 5px;
}

.event-stat-detail {
    font-size: 0.85rem;
    color: var(--text-color);
    opacity: 0.7;
}

/* Animation pour les chaises */
@keyframes pulse {
    0% { transform: translate(-50%, -50%) scale(1); }
    50% { transform: translate(-50%, -50%) scale(1.1); }
    100% { transform: translate(-50%, -50%) scale(1); }
}

.chair-dot.occupied.pulse {
    animation: pulse 2s infinite;
}

/* Badge pour chaises multiples */
.chair-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--danger);
    color: white;
    font-size: 0.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    border: 2px solid white;
}

        /* === RESPONSIVE === */
        @media (max-width: 1200px) {
            .tables-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .tables-main {
                margin-top: 80px;
                padding: 15px;
            }

            .tables-grid {
                grid-template-columns: 1fr;
            }

            .page-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .page-actions {
                width: 100%;
                justify-content: center;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .page-title h1 {
                font-size: 1.5rem;
            }

            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
        }

        /* === VUE GRID DES TABLES === */
        .tables-grid-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
            min-height: 500px;
        }

        .grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .grid-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
        }

 

       

        .table-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .table-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin: 5px 0;
            color: white;
        }

        


        .status-available {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-full {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-available {
            background: rgba(217, 119, 6, 0.2);
            color: var(--primary);
            border: 1px solid rgba(217, 119, 6, 0.3);
        }

        
        .table-capacity {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .capacity-bar {
            flex: 1;
            height: 8px;
            background: var(--hover-bg);
            border-radius: 4px;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .table-location {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .table-guests {
            margin-top: 15px;
        }

        .guests-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
            opacity: 0.7;
        }

        .guests-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .guest-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: var(--border-radius-sm);
            background: var(--hover-bg);
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .guest-item:last-child {
            margin-bottom: 0;
        }

        .guest-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
        }





.action-btn.details {
    background: var(--hover-bg);
    color: white;
}

/* === CARTE DE TABLE AVEC APERÇU DÉTAILLÉ AMÉLIORÉ === */
.table-card {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    overflow: hidden;
    cursor: pointer;
    position: relative;
    display: flex;
    flex-direction: column;
    box-shadow: var(--card-shadow);
    height: 180px;
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}


/* Remplacer les effets de survol par des classes actives */
.table-card.active {
    height: auto !important;
    min-height: 420px !important;
    box-shadow: 0 20px 60px var(--shadow-color) !important;
    z-index: 100 !important;
    position: relative !important;
    grid-row: span 3 !important;
    grid-column: span 1 !important;
}

.table-card.active .table-card-content,
.table-card.active .table-card-footer {
    opacity: 1 !important;
    max-height: none !important;
    transform: translateY(0) !important;
    animation: slideInUp 0.5s ease forwards;
}

/* Pour mobile - toujours visible */
@media (max-width: 768px) {
    .table-card {
        height: auto !important;
    }
    
   
    
    .table-card.active {
        grid-row: auto !important;
        grid-column: auto !important;
    }
}

/* Ajouter un bouton d'expansion sur l'en-tête */
.table-card-header {
    cursor: pointer;
    position: relative;
}



.table-card.active .table-card-header::after {
    transform: rotate(180deg);
    color: var(--primary);
}



/* Par défaut, masquer tout sauf le header */
.table-card-content,
.table-card-footer {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    transition: all 0.3s ease;
    transform: translateY(20px);
}





/* === GRILLE AVEC FLEXIBILITÉ AU SURVOL === */
.tables-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 25px;
    transition: all 0.3s ease;
}



/* Version mobile - toujours afficher tout */
@media (max-width: 768px) {
    .table-card {
        height: auto;
        min-height: auto;
    }
    
   
    
    .tables-grid {
        grid-template-columns: 1fr;
    }
    
}

/* Pour les écrans très larges */
@media (min-width: 1400px) {
    .tables-grid {
        grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    }
}




.table-card:hover .table-card-header {
    height: 150px;
}

/* Ajustements pour le contenu */
.table-card-content {
    padding: 20px;
    position: relative;
    z-index: 2;
    flex: 1;
    display: flex;
    flex-direction: column;
    background: linear-gradient(0deg, 
        rgba(0, 0, 0, 0.9) 0%, 
        rgba(0, 0, 0, 0.7) 50%,
        transparent 100%);
    backdrop-filter: blur(1px);
    overflow-y: auto;
    justify-content: space-between;
    align-content: space-between;
}

/* Footer initialement caché */
.table-card-footer {
    padding: 15px 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(180deg, 
        transparent 0%, 
        rgba(0, 0, 0, 0.8) 100%);
    position: relative;
    z-index: 2;
    transform: translateY(20px);
    transition: all 0.4s ease 0.1s;
}

.table-card:hover .table-card-footer {
    transform: translateY(0);
}

/* Assurer que l'image de fond couvre bien le header */
.table-card-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    transition: filter 0.3s ease;
}

/* Survol de l'image - légèrement plus foncée */
.table-card:hover .table-card-image {
    filter: brightness(0.8);
}

/* Animation de l'apparition du contenu */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}



/* Délai d'animation pour chaque élément */
.table-card:hover .capacity-indicator {
    animation-delay: 0.1s;
}

.table-card:hover .table-guests {
    animation-delay: 0.2s;
}

.table-card:hover .table-actions {
    animation-delay: 0.3s;
}

/* Style de l'info principale (toujours visible) */
.table-card-main-info {
    display: flex;
    flex-direction: column;
    gap: 5px;
    position: absolute;
    bottom: 15px;
    left: 20px;
    right: 20px;
    z-index: 3;
}

.table-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.table-number::before {
    content: '#';
    font-size: 1.5rem;
    opacity: 0.7;
}

.table-name {
    font-size: 1.3rem;
    font-weight: 600;
    color: white;
    margin: 5px 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
}

/* Meta info (catégorie et statut) toujours visible */
.table-meta {
    display: flex;
    gap: 10px;
    margin-top: 8px;
    flex-wrap: wrap;
    position: relative;
    z-index: 2;
}

.table-category,
.table-status {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Effet de gradient subtil au survol */
.table-card:hover::before {
    opacity: 0.3;
}


.table-card::after {
    position: absolute;
    bottom: 10px;
    right: 10px;
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.5);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 4;
}

.table-card:hover::after {
    opacity: 0;
}

/* Version mobile - toujours afficher tout */
@media (max-width: 768px) {
    .table-card {
        min-height: auto;
        max-height: none;
    }
    
    .table-card-content,
    .table-card-footer {
        opacity: 1;
        max-height: none;
    }
    
    .table-card:hover {
        min-height: auto;
        max-height: none;
    }
    
    .table-card::after {
        display: none;
    }
}


.table-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.7) 0%, 
        rgba(0, 0, 0, 0.5) 50%,
        rgba(0, 0, 0, 0.3) 100%);
    z-index: 1;
    opacity: 0.8;
    transition: opacity 0.3s ease;
}

.table-card:hover::before {
    opacity: 0.6;
}

.table-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 60px var(--shadow-color);
    border-color: var(--primary);
}

.table-card.full {
    border-color: var(--success);
}

.table-card.empty {
    border-color: #d0d0d0;
}

.dark-theme .table-card.empty {
    border-color: #444444;
}

.table-card.available {
    border-color: var(--primary);
}

.table-card.vip {
    border-color: var(--warning);
}

/* Image de fond prestigieuse */
.table-card-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
}

.table-card:hover .table-card-image {
    filter: brightness(0.9);
}

/* Couleurs selon la catégorie */
.table-card[data-category="vip"] .table-card-image {
    filter: sepia(0.3) brightness(0.8);
}

.table-card[data-category="family"] .table-card-image {
    filter: hue-rotate(180deg) brightness(0.8);
}

.table-card[data-category="speaker"] .table-card-image {
    filter: saturate(1.5) brightness(0.8);
}

.table-card-header {
    padding: 20px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    background-image: url('https://media.istockphoto.com/id/493839116/fr/photo/d%C3%A9corations-centrales-des-tables-lors-dune-r%C3%A9ception-de-mariage.jpg?s=612x612&w=0&k=20&c=y2C-EN_Z2Pegk2zHrH_JJg2J3AQOGVCIpbLREEjRmKY=');
    background-size: cover;
    background-position: center;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    position: relative;
    z-index: 2;
    min-height: 180px;
    overflow: hidden;
}
    
.table-card-header::before {
    content: '';

    background: linear-gradient(135deg, 
        rgba(0, 0, 0, 0.7) 0%, 
        rgba(0, 0, 0, 0.5) 50%,
        rgba(0, 0, 0, 0.3) 100%);
    position: absolute;
    inset: 0;
}

.table-number {
    font-size: 2.5rem;
    font-weight: 800;
    color: white;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
    z-index: 2;
}

.table-number::before {
    content: '#';
    font-size: 1.5rem;
    opacity: 0.7;
}

.table-name {
    font-size: 1.3rem;
    font-weight: 600;
    color: white;
    margin: 5px 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    position: relative;
    z-index: 2;
.table-meta {
    display: flex;
    gap: 10px;
    margin-top: 8px;
    flex-wrap: wrap;
    position: relative;
    z-index: 2;
}   margin-top: 8px;
    flex-wrap: wrap;
}

.table-category {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    background: rgba(217, 119, 6, 0.3);
    color: white;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(217, 119, 6, 0.5);
}



.status-available {
    background: rgba(16, 185, 129, 0.3);
    color: white;
    border: 1px solid rgba(16, 185, 129, 0.5);
}

.status-full {
    background: rgba(16, 185, 129, 0.3);
    color: white;
    border: 1px solid rgba(16, 185, 129, 0.5);
}

.status-available {
    background: rgba(217, 119, 6, 0.3);
    color: white;
    border: 1px solid rgba(217, 119, 6, 0.5);
}

.status-partial {
    background: rgba(245, 158, 11, 0.3);
    color: white;
    border: 1px solid rgba(245, 158, 11, 0.5);
}

/* Indicateur de capacité */
.capacity-indicator {
    margin-bottom: 20px;
    padding: 15px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 5px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.capacity-indicator.detail {
    background: var(--hover-bg);
    border: 1px solid var(--border-color);
}

.capacity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.capacity-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    gap: 8px;
}

.capacity-label.detail {
    font-size: 1rem;
    font-weight: 700;
    color: var(--text-color);
}

.capacity-percentage {
    font-size: 1.2rem;
    font-weight: 700;
    color: var(--primary);
    background: rgba(0, 0, 0, 0.3);
    padding: 4px 12px;
    border-radius: 20px;
}

.capacity-percentage.detail {
    background: var(--primary);
    color: white;
}

.capacity-stats.detail {
    font-size: 0.9rem;
    color: var(--text-color);
    opacity: 0.8;
}

/* Nouvelle barre avec carrés */
.capacity-visual-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(28px, 1fr));
    gap: 6px;
    margin-bottom: 15px;
}

.seat-square {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    color: white;
    position: relative;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    cursor: default;
}

/* Carrés vides (disponibles) */
.seat-square.available {
    background: rgba(255, 255, 255, 0.1);
    border: 2px dashed rgba(255, 255, 255, 0.2);
}

.seat-square.available:hover {
    background: rgba(255, 255, 255, 0.2);
}

.seat-square.available.detail {
    background: var(--hover-bg);
    border-color: var(--border-color);
    cursor: pointer;
}

/* Carrés occupés */
.seat-square.occupied {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
}

/* Carrés pour groupes */
.seat-square.group {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, #8B5CF6, #7C3AED);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
}

/* Badge pour groupes */
.seat-square.group::after {
    content: attr(data-group);
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--warning);
    color: white;
    font-size: 0.6rem;
    padding: 2px 5px;
    border-radius: 10px;
    min-width: 16px;
    text-align: center;
    font-weight: 700;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.capacity-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: rgba(255, 255, 255, 0.7);
}


/* Section invités améliorée */
.table-guests {
    flex: 0;
    display: flex;
    flex-direction: column;
}

.guests-toggle-btn {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.15);
    padding: 12px 15px;
    border-radius: var(--border-radius-sm);
    color: rgba(255, 255, 255, 0.9);
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
}

.guests-toggle-btn:hover {
    background: rgba(255, 255, 255, 0.12);
    border-color: rgba(255, 255, 255, 0.25);
    transform: translateY(-1px);
}

.guests-toggle-btn .toggle-icon {
    transition: transform 0.3s ease;
    font-size: 0.8rem;
}

.guests-toggle-btn.expanded .toggle-icon {
    transform: rotate(180deg);
}

.guests-list-container {
    margin-top: 10px;
    border-radius: var(--border-radius-sm);
    background: rgba(0, 0, 0, 0.3);
    padding: 10px;
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 500px;
    }
}

.guests-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.guests-title {
    font-size: 1rem;
    font-weight: 600;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 8px;
}

.guests-count {
    background: var(--primary);
    color: white;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 600;
}

.guests-list {
    flex: 1;
    max-height: 200px;
    overflow-y: auto;
    padding-right: 5px;
}

/* Scrollbar personnalisée pour la liste des invités */
.guests-list::-webkit-scrollbar {
    width: 6px;
}

.guests-list::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 3px;
}

.guests-list::-webkit-scrollbar-thumb {
    background: var(--primary);
    border-radius: 3px;
}

.guests-list::-webkit-scrollbar-thumb:hover {
    background: var(--primary-dark);
}

.guest-item {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid rgba(255, 255, 255, 0.05);
    transition: all 0.3s ease;
    cursor: pointer;
}

.guest-item:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.1);
    transform: translateX(5px);
}

.guest-item.expanded {
    background: rgba(0, 0, 0, 0.4);
    border-color: var(--primary);
    margin-bottom: 15px;
    flex-direction: column;
}

.guest-item-header {
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
}

.guest-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
    flex-shrink: 0;
    position: relative;
}

.guest-avatar.vip::after {
    content: '👑';
    position: absolute;
    bottom: -3px;
    right: -3px;
    font-size: 0.7rem;
    background: var(--warning);
    border-radius: 50%;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.guest-info {
    flex: 1;
    min-width: 0;
}

.guest-name {
    font-weight: 600;
    color: white;
    margin-bottom: 3px;
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.guest-meta {
    display: flex;
    gap: 10px;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.7);
}

.guest-seats {
    display: flex;
    align-items: center;
    gap: 4px;
}

.guest-seats i {
    color: var(--primary);
}

.guest-status {
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.7rem;
    font-weight: 600;
}

.status-confirmed {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
}

.status-pending {
    background: rgba(245, 158, 11, 0.2);
    color: var(--warning);
}

.guest-expand-btn {
    background: none;
    border: none;
    color: rgba(255, 255, 255, 0.6);
    cursor: pointer;
    padding: 5px;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.guest-expand-btn:hover {
    color: white;
    background: rgba(255, 255, 255, 0.1);
}

.guest-expand-btn.expanded {
    transform: rotate(180deg);
    color: var(--primary);
}

.guest-details {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        max-height: 0;
    }
    to {
        opacity: 1;
        max-height: 200px;
    }
}

.details-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    font-size: 0.85rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.detail-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.75rem;
    font-weight: 600;
}

.detail-value {
    color: white;
    word-break: break-word;
}

.guest-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.action-btn-sm {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.3s ease;
    flex: 1;
    justify-content: center;
}

.action-btn-sm.move {
    background: rgba(59, 130, 246, 0.2);
    color: var(--info);
    border: 1px solid rgba(59, 130, 246, 0.3);
}

.action-btn-sm.move:hover {
    background: rgba(59, 130, 246, 0.3);
}

.action-btn-sm.remove {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
    border: 1px solid rgba(239, 68, 68, 0.3);
}

.action-btn-sm.remove:hover {
    background: rgba(239, 68, 68, 0.3);
}

.action-btn-sm.qr {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.action-btn-sm.qr:hover {
    background: rgba(16, 185, 129, 0.3);
}

/* Pied de carte amélioré */
.table-card-footer {
    padding: 15px 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(180deg, 
        transparent 0%, 
        rgba(0, 0, 0, 0.8) 100%);
    position: relative;
    z-index: 2;
}

.table-location {
    display: flex;
    align-items: center;
    gap: 8px;
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.9rem;
    max-width: 60%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.table-actions {
    display: flex;
    gap: 8px;
}

.action-btn {
    width: 36px;
    height: 36px;
    border-radius: 0.5rem;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    position: relative;
}

.action-btn:hover {
    transform: translateY(-2px) scale(1.1);
    background: var(--primary);
    color: white;
    box-shadow: 0 5px 15px rgba(217, 119, 6, 0.3);
}

.action-btn.edit {
    background: rgba(59, 130, 246, 0.2);
    color: var(--info);
}

.action-btn.edit:hover {
    background: var(--info);
}

.action-btn.qr {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
}

.action-btn.qr:hover {
    background: var(--success);
}

.action-btn.delete {
    background: rgba(239, 68, 68, 0.2);
    color: var(--danger);
}

.action-btn.delete:hover {
    background: var(--danger);
}

/* Styles pour les cases à cocher des invités */
.guest-checkbox.selected {
    background: var(--primary) !important;
    border-color: var(--primary) !important;
}

.guest-checkbox.selected i {
    display: block !important;
}

/* Animation pour l'expansion des invités */
.guest-full-details {
    animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
    }
    to {
        opacity: 1;
        transform: translateY(0);
        max-height: 500px;
    }
}


/* Styles pour le modal de création */
.code-info-message {
    padding: 12px;
    background: var(--hover-bg);
    border-radius: var(--border-radius);
    border: 1px dashed var(--border-color);
    font-weight: 500;
    font-size: 0.95rem;
    color: var(--text-color);
    opacity: 0.7;
    text-align: center;
    margin-bottom: 20px;
    font-style: italic;
    display: none;
}

.code-display-container {
    padding: 12px;
    background: var(--hover-bg);
    border-radius: var(--border-radius);
    border: 1px solid var(--border-color);
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--primary);
    text-align: center;
    margin-bottom: 20px;
    display: none;
}

.capacity-control-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0 15px;
}



.quick-capacity-buttons {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    flex-wrap: wrap;
}

.quick-capacity-btn {
    padding: 6px 12px;
    border-radius: 6px;
    background: var(--hover-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.quick-capacity-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

.quick-capacity-btn.active {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

.multiple-tables-title {
    margin-bottom: 20px;
    color: var(--text-color);
    display: flex;
    align-items: center;
    gap: 10px;
}

.duplicate-settings-container {
    display: flex;
    gap: 15px;
    align-items: center;
}

/* Styles pour les invités */
.guest-select-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    margin-bottom: 8px;
    background: var(--hover-bg);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.guest-select-item:hover {
    background: var(--primary-light);
    transform: translateY(-2px);
}

.guest-select-item.selected {
    background: var(--primary-light);
    border-color: var(--primary);
}

.selected-guest-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px;
    margin-bottom: 8px;
    background: var(--hover-bg);
    border-radius: 8px;
}

.remove-selected-guest {
    background: none;
    border: none;
    color: var(--danger);
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
}

.remove-selected-guest:hover {
    background: var(--danger-light);
}

/* Bouton de confirmation amélioré */
.confirmation-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    background: var(--success-light);
    color: var(--success);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}


/* Effet de survol pour les éléments interactifs */
.guest-select-item:hover {
    background: rgba(217, 119, 6, 0.1) !important;
    border-color: var(--primary) !important;
    transform: translateX(5px);
}

/* Badge pour les invités VIP */
.vip-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: linear-gradient(135deg, var(--warning), #D97706);
    color: white;
    font-size: 0.6rem;
    padding: 2px 6px;
    border-radius: 10px;
    font-weight: 700;
    border: 2px solid white;
}

/* Indicateur de chargement pour les images */
.table-card-image::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, 
        transparent 25%, 
        rgba(255,255,255,0.1) 50%, 
        transparent 75%);
    background-size: 200% 200%;
}

/* Responsive pour les écrans très petits */
@media (max-width: 380px) {
    .table-number {
        font-size: 1.8rem;
    }
    
    .table-name {
        font-size: 1rem;
    }
    
    .guest-avatar {
        width: 32px;
        height: 32px;
        font-size: 0.8rem;
    }
    
    .guest-meta {
        flex-direction: column;
        gap: 5px;
    }
    
    .table-actions {
        gap: 5px;
    }
    
    .action-btn {
        width: 32px;
        height: 32px;
    }
}


/* Bouton d'ajout rapide d'invités */
.add-guest-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 15px;
    background: rgba(217, 119, 6, 0.2);
    border: 1px dashed rgba(217, 119, 6, 0.5);
    border-radius: 10px;
    color: var(--primary);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-top: 15px;
    justify-content: center;
    width: 100%;
}

.add-guest-btn:hover {
    background: rgba(217, 119, 6, 0.3);
    border-color: var(--primary);
    transform: translateY(-2px);
}

/* Indicateur "Aucun invité" amélioré */
.no-guests {
    text-align: center;
    padding: 40px 20px;
    color: rgba(255, 255, 255, 0.5);
}

.no-guests i {
    font-size: 3rem;
    margin-bottom: 15px;
    opacity: 0.5;
}

.no-guests p {
    font-size: 0.9rem;
    margin-bottom: 10px;
}

/* Vue tableau améliorée */
.table-data-view {
    background: var(--card-bg);
    border-radius: var(--border-radius);
    padding: 20px;
    border: 1px solid var(--border-color);
    box-shadow: 0 8px 30px var(--shadow-color);
    display: none;
}

.table-data-view.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.table-header-details {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.table-basic-info {
    flex: 1;
}

.table-stats-overview {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-item {
    text-align: center;
    padding: 15px;
    background: var(--hover-bg);
    border-radius: var(--border-radius-sm);
}

.stat-number {
    font-size: 1.8rem;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 5px;
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-color);
    opacity: 0.7;
}

/* Responsive amélioré */
@media (max-width: 1200px) {
    .tables-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .tables-grid {
        grid-template-columns: 1fr;
    }
    
    .table-card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .table-card-footer {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .table-location {
        max-width: 100%;
    }
    
    .details-grid {
        grid-template-columns: 1fr;
    }
    
    .guest-actions {
        flex-direction: column;
    }
}

@media (max-width: 480px) {
    .table-number {
        font-size: 2rem;
    }
    
    .table-name {
        font-size: 1.1rem;
    }
    
    .capacity-visual {
        gap: 3px;
    }
    
    .seat-indicator {
        width: 20px;
        height: 20px;
        font-size: 0.6rem;
    }
    
    .seat-indicator.group {
        width: 24px;
        height: 24px;
    }
}


        .guest-info {
            flex: 1;
        }

        .guest-name {
            font-weight: 500;
        }

        .guest-seats {
            color: var(--secura-white);
            opacity: 0.7;
            font-size: 0.8rem;
        }

        /* === CASIER BOXES (OCCUPANCY VISUALIZATION) === */
        .casier-box {
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .casier-box:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .casier-box.occupied {
            border-color: rgba(0, 0, 0, 0.2);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .casier-box.empty {
            border: 1px dashed rgba(0, 0, 0, 0.15);
        }


        .dark-theme .table-card-footer {
            background: rgba(0, 0, 0, 0.3);
        }

        .table-actions {
            display: flex;
            gap: 8px;
        }

       
        .action-btn:hover {
            transform: scale(1.1);
            background: var(--primary);
            color: white;
        }

        .action-btn.edit:hover {
            background: var(--info);
        }

        .action-btn.delete:hover {
            background: var(--danger);
        }

        .action-btn.qr:hover {
            background: var(--success);
        }

        /* === TOGGLE DE VUE === */
        .view-toggle {
            display: flex;
            gap: 5px;
            background: var(--hover-bg);
            padding: 5px;
            border-radius: var(--border-radius-sm);
        }

        .view-btn {
            padding: 10px 20px;
            border-radius: var(--border-radius-sm);
            background: transparent;
            border: none;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            
            display: flex;
            align-items: center;
            gap: 5px;
        }


        .view-btn.create {
            background:  var(--text-color);
            color: white;
        }

        .dark-theme .view-btn.create {
            background:  var(--primary);
            color: white;
        }

        .view-btn.create:hover {
            background: var(--primary);
        }

        .view-btn:hover {
            background: var(--hover-bg);
            opacity: 1;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
            opacity: 1;
        }

        /* === FILTRES RAPIDES === */
        .quick-filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-chip {
            padding: 8px 16px;
            background: var(--hover-bg);
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            
            border: 2px solid transparent;
        }

        .filter-chip:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        .filter-chip.active {
            background: var(--primary);
            color: white;
            border-color: white;
        }

        /* === BARRE DE RECHERCHE === */
        .search-container {
            position: relative;
            width: 300px;
        }

        @media (max-width: 768px) {
            .search-container {
                width: 100%;
            }
        }

        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--placeholder-color);
        }

        .search-container input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--input-text);
            
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
        }

        /* === BARRE D'ACTIONS === */
        .actions-bar {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 30px var(--shadow-color);
        }

        .actions-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .actions-left, .actions-right {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

       

/* Conteneur pour les actions spécifiques à la vue */
.actions-container {
    display: flex;
    align-items: center;
    gap: 10px;
}



.grid-header.in-specific-view h3 {
    margin-right: auto;
}
        /* === VUE ACCUEIL DES ÉVÉNEMENTS === */
        .events-home-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            margin-top: 100px;
            margin-top: 100px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        .events-home-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .events-home-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .events-home-header p {
            color: var(--text-color);
            opacity: 0.7;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

       

        /* Vue tableau réduite */
        .events-mini-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 8px 30px var(--shadow-color);
        }

        .events-mini-table th {
            background: var(--hover-bg);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
            border-bottom: 2px solid var(--border-color);
        }

        .events-mini-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .events-mini-table tbody tr:hover {
            background: rgba(217, 119, 6, 0.05);
        }

        .events-mini-table .event-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .event-cell-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .event-cell-info {
            flex: 1;
            min-width: 0;
        }

        .event-cell-name {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 2px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-cell-location {
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.7;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-cell-date {
            white-space: nowrap;
            font-size: 0.85rem;
        }

        .event-cell-type {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            background: var(--primary);
            display: inline-block;
        }

        .event-cell-stats {
            display: flex;
            gap: 15px;
        }

        .event-cell-stat {
            text-align: center;
            min-width: 50px;
        }

        .event-cell-stat-number {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            display: block;
        }

        .event-cell-stat-label {
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Toggle vue */
        .view-mode-toggle {
            display: flex;
            gap: 5px;
            background: var(--hover-bg);
            padding: 5px;
            border-radius: var(--border-radius-sm);
            margin: 0 auto 30px;
            width: fit-content;
        }

        .view-mode-btn {
            padding: 8px 20px;
            border-radius: var(--border-radius-sm);
            background: transparent;
            border: none;
            font-weight: 600;
            cursor: pointer;
            color: var(--text-color);
            opacity: 0.7;
            
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        .view-mode-btn:hover {
            background: var(--hover-bg);
            opacity: 1;
        }

        .view-mode-btn.active {
            background: var(--primary);
            color: white;
            opacity: 1;
        }

        /* Message d'accueil */
        .home-message {
            text-align: center;
            padding: 60px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .home-message i {
            font-size: 4rem;
            color: var(--primary);
            margin-bottom: 20px;
            opacity: 0.8;
        }

        .home-message h2 {
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: var(--text-color);
        }

        .home-message p {
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        

        /* === INDICATEUR DE STATUT === */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-active {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-inactive {
            background: rgba(107, 114, 128, 0.2);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(107, 114, 128, 0.3);
        }

        .status-draft {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* === BADGES === */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-primary {
            background: rgba(217, 119, 6, 0.2);
            color: var(--primary);
            border: 1px solid rgba(217, 119, 6, 0.3);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        /* === LOADER === */
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* === PAGINATION === */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .page-btn {
            width: 40px;
            height: 40px;
            border-radius: var(--border-radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--hover-bg);
            border: none;
            cursor: pointer;
            
            color: var(--text-color);
        }

        .page-btn:hover {
            background: var(--primary);
            color: white;
        }

        .page-btn.active {
            background: var(--primary);
            color: white;
        }

        .page-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-btn.disabled:hover {
            background: var(--hover-bg);
            color: var(--text-color);
        }

        /* === MODAL DE CRÉATION EN ÉTAPES === */
        .table-creation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            overflow-y: auto;
        }

        .table-creation-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .table-creation-wrapper {
            display: flex;
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
        }

        /* Bouton fermeture du modal */
        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            
            z-index: 100;
            font-size: 1.2rem;
        }

        .modal-close-btn:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(60px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Panel de progression vertical */
        .creation-progress-panel {
            flex: 0 0 300px;
            background: var(--progress-bg);
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            
            position: relative;
        }

        .progress-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 20px;
            letter-spacing: 0.5px;
            
        }

        /* Barre de progression linéaire */
        .progress-bar-container {
            width: 100%;
            height: 4px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-bar-fill {
            height: 100%;
            background: var(--gradient);
            border-radius: 10px;
            width: 20%;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .vertical-steps {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: auto;
            position: relative;
        }

        /* Ligne de progression verticale */
        .vertical-steps::before {
            content: '';
            position: absolute;
            left: 1px;
            top: 30px;
            bottom: 33px;
            width: 5px;
            background: var(--hover-bg);
            z-index: 1;
        }


        .dark-theme .vertical-steps::before {
            background: rgba(255, 255, 255, 0.1);
        }

        .vertical-step {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 18px 20px;
            border-radius: var(--border-radius);
            cursor: pointer;
            
            position: relative;
            z-index: 2;
            background: transparent;
        }

        .vertical-step::before {
            content: '';
            position: absolute;
            left: -7px;
            top: 41%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border-radius: 26%;
            
            background: var(--text-color);
            border: 3px solid var(--border-color);
            
            z-index: 3;
        }

        .vertical-step.active::before {
            background: var(--primary);
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.15);
        }

        .vertical-step.completed::before {
            background: var(--success);
            border-color: var(--success);
        }

        .vertical-step-info {
            flex: 1;
            opacity: 0.5;
            
            transform: translateX(30px);
        }

        .vertical-step.active .vertical-step-info {
            opacity: 1;
            transform: translateX(0);
        }

        .vertical-step.completed .vertical-step-info {
            opacity: 0.8;
        }

        .vertical-step-label {
            display: block;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .vertical-step.active .vertical-step-label {
            color: var(--primary-light);
        }

        .vertical-step-description {
            display: block;
            font-size: 0.8rem;
            color: var(--text-color);
            opacity: 0.5;
            line-height: 1.3;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .vertical-step:hover .vertical-step-description {
            max-height: 100px;
            opacity: 0.7;
        }

        .vertical-step.active .vertical-step-description {
            max-height: 100px;
            opacity: 0.7;
        }

        .creation-progress-info {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .creation-progress-text {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.5;
            margin-bottom: 8px;
            
        }

        .creation-progress-percentage {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Panel de formulaire */
        .creation-form-panel {
            flex: 1;
            padding: 40px;
            overflow: hidden;
            position: relative;
        }

        .creation-header {
            margin-bottom: 40px;
        }

        .creation-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .creation-subtitle {
            font-size: 0.95rem;
            color: var(--text-color);
            opacity: 0.6;
            line-height: 1.5;
            
        }

        /* Contenu des étapes */
        .creation-step-content {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 40px;
            opacity: 0;
            transform: translateX(40px);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            overflow-y: auto;
        }

        .creation-step-content.active {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }

        .creation-step-content::-webkit-scrollbar {
            width: 6px;
        }

        .creation-step-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .dark-theme .creation-step-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        .creation-step-content::-webkit-scrollbar-thumb {
            background: var(--gradient);
            border-radius: 3px;
        }

        /* === FORMULAIRES === */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-light);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            background: var(--input-bg);
            border: 1.5px solid var(--input-border);
            color: var(--input-text);
            padding: 12px 16px;
            border-radius: var(--border-radius-sm);
            font-size: 0.95rem;
            
            font-family: inherit;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--input-bg);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
        }

        .form-control::placeholder {
            color: var(--placeholder-color);
            font-size: 0.9rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .form-help {
            display: block;
            margin-top: 6px;
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.5;
        }

        .required {
            color: var(--danger);
            font-size: 1.2rem;
            line-height: 1;
        }

        /* Étape de création multiple */
        .multiple-tables-form {
            background: var(--hover-bg);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            margin-bottom: 20px;
        }

        .table-item {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: 15px;
            margin-bottom: 15px;
            
        }

        .table-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .table-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .table-item-number {
            font-weight: 600;
            color: var(--primary);
        }

        .remove-table-btn {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            
        }

        .remove-table-btn:hover {
            transform: scale(1.1);
        }

        .multiple-quick-buttons .quick-capacity-btn.active {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .add-table-btn {
            width: 100%;
            padding: 15px;
            background: var(--hover-bg);
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius-sm);
            color: var(--text-color);
            font-size: 1rem;
            cursor: pointer;
            
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-table-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Boutons de navigation */
        .creation-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* Aperçu de table */
        .table-preview-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            padding: 25px;
            margin-top: 20px;
            box-shadow: 0 8px 30px var(--shadow-color);
        }

        .preview-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .preview-table-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .preview-table-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
         
                gap: 15px;
        margin-top: 10px;
        }

        .preview-info-item {
    padding: 12px;
    background: var(--hover-bg);
    border-radius: 0.2rem;
    border-left: 3px solid var(--primary);
}

.preview-info-item.full-width {
    grid-column: 1 / -1;
}

.preview-info-label {
    font-size: 0.85rem;
    color: var(--text-color);
    opacity: 0.7;
    margin-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.preview-info-value {
    font-weight: 600;
    color: var(--text-color);
    font-size: 1rem;
    word-break: break-word;
}

.preview-info-value.highlight {
    color: var(--primary);
    font-size: 1.1rem;
}

.preview-info-value.empty {
    color: var(--text-color);
    opacity: 0.5;
    font-style: italic;
}

.preview-description {
    font-size: 0.9rem;
    line-height: 1.4;
    opacity: 0.8;
}

.capacity-badge {
    display: inline-block;
    color: var(--primary);
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
}

.category-standard { color: var(--primary); }
.category-vip { color: #F59E0B; }
.category-family { color: #8B5CF6; }
.category-speaker { color: #3B82F6; }
.category-organizer { color: #10B981; }
.category-other { color: #6B7280; }

.table-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 5px;
}

.table-pill {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    color: var(--text-color);
}

/* Animation pour les mises à jour */
.preview-info-item {
    transition: all 0.3s ease;
}

.preview-info-item.updated {
    animation: highlightUpdate 0.5s ease;
}

@keyframes highlightUpdate {
    0% { background: var(--primary-light); }
    100% { background: var(--hover-bg); }
}


        

        /* Transition globale */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

          /* Mini version des cartes d'événements */
        .events-mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 10px;
            margin-bottom: 40px;
        }

        .event-mini-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            
            cursor: pointer;
            position: relative;
            height: 180px;
        }

        .event-mini-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-color);
            border-color: var(--primary);
        }

        .event-mini-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(217, 119, 6, 0.05);
            height: 60px;
            overflow: hidden;
        }

        .event-mini-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: var(--primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .event-content {

                background: rgb(0 0 0 / 75%);
            backdrop-filter: blur(2px);
        }

        .event-mini-meta {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .event-mini-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        .event-mini-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        .event-mini-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .event-mini-stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .event-mini-stat-label {
            font-size: 0.75rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Styles pour les boutons de capacité */
.capacity-control-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.capacity-btn {
    width: 45px;
    height: 45px;
    border-radius: 0.3rem;
    background: var(--hover-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.capacity-btn:hover {
    background: var(--primary);
    color: white;
}

.quick-capacity-btn {
    padding: 6px 12px;
    border-radius: 6px;
    background: var(--hover-bg);
    border: 1px solid var(--border-color);
    color: var(--text-color);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.quick-capacity-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
}

/* === RESPONSIVE GRID BOOTSTRAP === */
@media (max-width: 576px) {
    .tables-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .table-card {
        margin-bottom: 15px;
    }
}

@media (min-width: 577px) and (max-width: 768px) {
    .tables-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
    }
}

@media (min-width: 769px) and (max-width: 992px) {
    .tables-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 25px;
    }
}

@media (min-width: 993px) and (max-width: 1200px) {
    .tables-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 25px;
    }
}

@media (min-width: 1201px) {
    .tables-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 25px;
    }
}

/* Animation douce pour l'expansion */
.table-card {
    transition: height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                box-shadow 0.3s ease,
                transform 0.3s ease;
}

.table-card:hover {
    transform: translateY(-5px);
}

/* Styles pour la gestion de capacité */
.disabled {
    opacity: 0.6;
    cursor: not-allowed !important;
    pointer-events: none;
}

.capacity-warning {
    color: var(--warning);
    font-size: 0.85rem;
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
}

.capacity-progress {
    width: 100%;
    height: 6px;
    background: var(--border-color);
    border-radius: 3px;
    overflow: hidden;
    margin: 5px 0;
}

.capacity-progress-fill {
    height: 100%;
    background: var(--primary);
    transition: width 0.3s ease;
}

.selected-guest-item {
    transition: all 0.3s ease;
}

.selected-guest-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

 .qr-generated-indicator {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
        100% { transform: scale(1); opacity: 1; }
    }
    
    #qrPreviewGrid {
        perspective: 1000px;
    }
    
    #qrPreviewGrid > div {
        transform-style: preserve-3d;
    }
    
    .qr-table-row:hover {
        background: rgba(217, 119, 6, 0.05) !important;
    }
    
    .qr-table-checkbox:checked + .table-selection-label {
        background: rgba(217, 119, 6, 0.1);
        border-color: var(--primary);
    }

    /* Styles améliorés pour la modal QR */
#qrPreviewContainer {
    min-height: 220px;
    background: linear-gradient(135deg, var(--hover-bg) 0%, var(--card-bg) 100%);
    border-radius: 12px;
    padding: 20px;
    margin: 15px 0;
    border: 1px solid var(--border-color);
    position: relative;
    overflow: hidden;
}

#qrPreviewContainer::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--primary), transparent);
}

#qrPreviewGrid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 15px;
    padding: 10px;
    align-items: start;
    justify-items: center;
}

/* Statistiques en temps réel - Style amélioré */
.stat-card {
    background: linear-gradient(135deg, var(--card-bg) 0%, rgba(217, 119, 6, 0.05) 100%);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(217, 119, 6, 0.1);
    border-color: var(--primary);
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--primary);
}

.stat-card:nth-child(1)::before { background: var(--success); }
.stat-card:nth-child(2)::before { background: var(--warning); }
.stat-card:nth-child(3)::before { background: var(--info); }

.stat-card .stat-value {
    font-size: 2.5rem;
    font-weight: 800;
    line-height: 1;
    margin: 10px 0;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.stat-card:nth-child(1) .stat-value {
    background: linear-gradient(135deg, var(--success), #0ca678);
}

.stat-card:nth-child(2) .stat-value {
    background: linear-gradient(135deg, var(--warning), #e67700);
}

.stat-card:nth-child(3) .stat-value {
    background: linear-gradient(135deg, var(--info), #1971c2);
}

/* Animation de génération */
@keyframes qrGeneration {
    0% { transform: scale(0.8); opacity: 0; }
    70% { transform: scale(1.05); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
}

.qr-generating {
    animation: qrGeneration 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
}

/* Tooltip pour les QR codes */
.qr-tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.qr-tooltip::after {
    content: '';
    position: absolute;
    bottom: -5px;
    left: 50%;
    transform: translateX(-50%);
    border-width: 5px 5px 0;
    border-style: solid;
    border-color: rgba(0, 0, 0, 0.9) transparent transparent;
}

/* Animation de rotation pour le loader circulaire */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
    </style>
</head>

<body class="dark-theme">
    <!-- Particles Background -->
    <div id="particles-js"></div>
    
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">
                    <img src="assets/images/icon.png" alt="logo secura">
                </div>
                <div class="sidebar-logo-text">
                    <h1>SECURA</h1>
                    <p>Gestion Sécurisée</p>
                </div>
            </div>
            <button class="sidebar-close action-btn" id="sidebarClose" aria-label="Fermer le menu">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Profile Section -->
        <div class="sidebar-profile">
            <div class="profile-avatar large">
                <i class="bi bi-person-circle"></i>
            </div>
            <div class="profile-details">
                <strong id="sidebarProfileName">Chargement...</strong>
                <small id="sidebarProfileEmail">email@exemple.com</small>
                <span class="badge-role" id="sidebarProfileRole">Utilisateur</span>
            </div>
        </div>
        <!-- Navigation Links -->
        <div id="navMenu" class="sidebar-menu">
            <a href="index.html" class="sidebar-link">
                <i class="fas fa-home"></i>
                <span>Accueil</span>
            </a>
            <a href="events.html" class="sidebar-link">
                <i class="fas fa-calendar-alt"></i>
                <span>Événements</span>
            </a>
            <a href="guests.html" class="sidebar-link">
                <i class="fas fa-users"></i>
                <span>Invités</span>
            </a>
            <a href="tables.html" class="sidebar-link active">
                <i class="fas fa-chair"></i>
                <span>Tables</span>
            </a>
             <a href="galleries.html" class="sidebar-link">
                <i class="fas fa-images"></i>
                <span>Galeries</span>
            </a>
            
           
            <a href="checkin.html" class="sidebar-link">
                <i class="fas fa-clipboard-check"></i>
                <span>Validation de Présence</span>
            </a>
            <hr class="sidebar-divider">
            <a href="access.html" class="sidebar-link" id="accessEventLink">
                <i class="fas fa-ticket-alt"></i>
                <span>Accès Événement</span>
            </a>
            <a href="profile.html" class="sidebar-link">
                <i class="fas fa-user"></i>
                <span>Mon Profil</span>
            </a>
            <a href="settings.html" class="sidebar-link">
                <i class="fas fa-cog"></i>
                <span>Paramètres</span>
            </a>
            <button class="sidebar-link text-danger" id="sidebarLogout">
                <i class="fas fa-sign-out-alt"></i>
                <span>Déconnexion</span>
            </button>
        </div>
        <!-- Footer -->
        <div class="sidebar-footer">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
                <span>Mode Sombre</span>
            </button>
            <button class="fullscreen-toggle" id="fullscreenToggle">
                <i class="fas fa-expand"></i>
                <span>Plein écran</span>
            </button>
        </div>
    </nav>
    
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Bouton flottant pour ouvrir la sidebar -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Ouvrir le menu">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Top Bar -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="assets/images/icon.png" alt="logo secura">
                </div>
                <div class="logo-text">
                    <h1>SECURA</h1>
                    <p class="form-title">Gestion des Tables</p>
                </div>
            </div>
           
            <!-- Profile Button -->
            <button class="profile-toggle header-profile-btn" id="profileToggle" aria-haspopup="true" aria-expanded="false">
                <div class="profile-avatar">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div class="profile-info">
                    <span class="profile-name" id="profileName">Chargement...</span>
                    <span class="profile-role" id="profileRole">Utilisateur</span>
                </div>
                <i class="bi bi-chevron-down profile-arrow"></i>
            </button>
        </div>
    </header>
    
    <!-- Profile Menu -->
    <div class="floating-profile-menu" id="floatingProfileMenu">
        <div class="profile-dropdown show" id="profileDropdown" role="menu">
            <div class="profile-header">
                <div class="profile-avatar large">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div class="profile-details">
                    <strong id="dropdownName">Chargement...</strong>
                    <small id="dropdownEmail">email@exemple.com</small>
                    <span class="badge-role" id="dropdownRole">Utilisateur</span>
                </div>
            </div>
            <div class="dropdown-actions">
                <a href="profile.html" class="dropdown-item" role="menuitem">
                    <i class="bi bi-person"></i> Mon Profil
                </a>
                <a href="settings.html" class="dropdown-item" role="menuitem">
                    <i class="bi bi-gear"></i> Paramètres
                </a>
                <hr class="dropdown-divider">
                <button class="dropdown-item text-danger" id="logout-btn" role="menuitem">
                    <i class="bi bi-box-arrow-right"></i> Déconnexion
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="main-content">
        <!-- Vue Accueil (Liste des événements) -->
        <div id="eventsHomeView" class="events-home-container">
            <div class="events-home-header">
                <h1><i class="fas fa-chair"></i> Gestion des Tables</h1>
                <p>Sélectionnez un événement pour gérer ses tables de placement</p>
            </div>
            
            <!-- Toggle vue -->
            <div class="view-mode-toggle">
                <button class="view-mode-btn active" data-mode="grid">
                    <i class="fas fa-th-large"></i>
                    <span>Grille</span>
                </button>
                <button class="view-mode-btn" data-mode="table">
                    <i class="fas fa-table"></i>
                    <span>Tableau</span>
                </button>
            </div>
            
            <!-- Vue Grille (mini cartes) -->
            <div id="eventsGridView" class="events-mini-grid">
                <!-- Les mini cartes d'événements seront injectées ici -->
            </div>
            
            <!-- Vue Tableau -->
            <div id="eventsTableView" class="events-table-container" style="display: none;">
                <table class="events-mini-table">
                    <thead>
                        <tr>
                            <th>Événement</th>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Tables</th>
                            <th>Invitations</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTableBody">
                        <!-- Les lignes du tableau seront injectées ici -->
                    </tbody>
                </table>
            </div>
            
            <!-- État vide -->
            <div id="emptyEventsState" class="home-message" style="display: none;">
                <i class="fas fa-calendar-times"></i>
                <h2>Aucun événement disponible</h2>
                <p>Créez d'abord un événement pour pouvoir gérer ses tables de placement.</p>
                <a href="events.html" class="btn btn-primary">
                    <i class="fas fa-plus-circle"></i>
                    Créer un événement
                </a>
            </div>
        </div>
        
        <!-- Vue Tables (affichage normal) -->
        <div id="tablesView" class="tables-main" style="display: none;">
            <!-- En-tête de page amélioré -->
            <div class="page-header">
                <div class="page-title">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        
                        <a class="back-link" id="backToEventsBtn"><svg class="back-icon-link" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></a>
                        <div>
                            <h1><i class="fas fa-chair"></i> Gestion des Tables</h1>
                            <div class="event-name" id="eventNameDisplay">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Chargement de l'événement...</span>
                            </div>
                        </div>
                    </div>
                    <div class="status-indicator" id="eventStatusIndicator" style="display: none;">
                        <i class="fas fa-circle"></i>
                        <span>Chargement...</span>
                    </div>
                </div>
                <div class="page-actions">
                    <button class="btn btn-secondary" id="autoAssignBtn">
                        <i class="fas fa-robot"></i>
                     <span class="text-btn">   Auto-assigner </span>
                    </button>
                    <button class="btn btn-secondary" id="importTablesBtn" title="Importer des tables via CSV">
                        <i class="fas fa-file-csv"></i>
                      <span class="text-btn">  Importer Tables CSV <span class="text-btn"></span>
                    </button>
                    <button class="btn btn-secondary" id="exportTableInfoBtn" title="Exporter les informations des tables">
                        <i class="bi bi-file-earmark-arrow-down"></i>
                       <span class="text-btn"> Exporter Infos </span>
                    </button>
                    <button class="btn btn-primary" id="generateQRBulkBtn" title="Générer des QR codes en masse">
                        <i class="fas fa-qrcode"></i>
                       <span class="text-btn"> Générer QR Codes </span>
                    </button>
                </div>
            </div>

            <style>

                
                .text-btn {
                    display: none;
                }

                .btn:hover .text-btn {

                    display: block;
                }
            </style>

            <!-- Barre d'actions -->
            <div class="actions-bar">
                <div class="actions-top">
                    <div class="actions-left">
                        <div class="quick-filters">
                            <div class="filter-chip active" data-filter="all">
                                <i class="fas fa-layer-group"></i> Toutes
                            </div>
                            <div class="filter-chip" data-filter="available">
                                <i class="fas fa-check-circle"></i> Disponibles
                            </div>
                            <div class="filter-chip" data-filter="full">
                                <i class="fas fa-ban"></i> Complètes
                            </div>
                            <div class="filter-chip" data-filter="empty">
                                <i class="fas fa-circle"></i> Vides
                            </div>
                        </div>
                    </div>
                    <div class="actions-right">
                        <div class="search-container">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchTables" placeholder="Rechercher une table...">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vue Grille des Tables -->
            <div class="tables-grid-container" id="gridView">
                <div class="grid-header">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        
                        <h3><i class="fas fa-list-ul"></i> Liste des Tables (<span id="tablesCount">0</span>)</h3>
                    </div>
                    <div class="actions-container">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid">
                                <i class="fas fa-th-large"></i>
                                <span>Grille</span>
                            </button>
                            <button class="view-btn" data-view="table">
                                <i class="fas fa-table"></i>
                                <span>Tableau</span>
                            </button>
                            <button class="view-btn" data-view="visual">
                                <i class="fas fa-th"></i>
                                <span>Visuel</span>
                            </button>
                            <button class="view-btn" data-view="stats">
                                <i class="fas fa-chart-bar"></i>
                                <span>Statistiques</span>
                            </button>
                             <button class="view-btn" data-view="vector">
                                <i class="fas fa-shapes"></i>
                                <span>Vectoriel</span>
                            </button>
                            <button class="view-btn create create-table-btn">
                                <i class="fas fa-plus-circle"></i>
                                Nouvelle Table
                            </button>
                        </div>
                    </div>
                </div>
                <div class="tables-grid" id="tablesGrid"></div>
                <!-- État vide -->
                <div class="empty-state" id="emptyStateGrid" style="display: flex !important;">
                    <i class="fas fa-chair"></i>
                    <h3>Aucune table trouvée</h3>
                    <p>Commencez par créer votre première table</p>
                    <button class="btn btn-primary" id="createFirstTable">
                        <i class="fas fa-plus-circle"></i>
                        Créer une table
                    </button>
                </div>
                <!-- Loader -->
                <div class="loader" id="gridLoader" style="display: none;"></div>
            </div>

            <!-- Vue Tableau des Tables -->
            <div class="tables-table-container" id="tableView">
                <div class="grid-header in-specific-view">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3><i class="fas fa-table"></i> Tableau des Tables (<span id="tablesTableCount">0</span>)</h3>
                    </div>
                    <div class="actions-container">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid">
                                <i class="fas fa-th-large"></i>
                                <span>Grille</span>
                            </button>
                            <button class="view-btn" data-view="table">
                                <i class="fas fa-table"></i>
                                <span>Tableau</span>
                            </button>
                            <button class="view-btn" data-view="visual">
                                <i class="fas fa-th"></i>
                                <span>Visuel</span>
                            </button>
                            <button class="view-btn" data-view="stats">
                                <i class="fas fa-chart-bar"></i>
                                <span>Statistiques</span>
                            </button>
                             <button class="view-btn" data-view="vector">
                                <i class="fas fa-shapes"></i>
                                <span>Vectoriel</span>
                            </button>
                            <button class="view-btn create create-table-btn">
                                <i class="fas fa-plus-circle"></i>
                                Nouvelle Table
                            </button>
                        </div>
                    </div>
                </div>
                <table class="tables-table">
                    <thead>
                        <tr>
                            <th>Table #</th>
                            <th>Nom</th>
                            <th>Capacité</th>
                            <th>Inv. assignés</th>
                            <th>Places dispo.</th>
                            <th>Emplacement</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tablesTableBody">
                        <!-- Les lignes de tableau seront injectées ici -->
                    </tbody>
                </table>
                <!-- État vide -->
                <div class="empty-state" id="emptyStateTable" style="display: none;">
                    <i class="fas fa-table"></i>
                    <h3>Aucune table trouvée</h3>
                    <p>Commencez par créer votre première table</p>
                    <button class="btn btn-primary" id="createFirstTableTable">
                        <i class="fas fa-plus-circle"></i>
                        Créer une table
                    </button>
                </div>
                <!-- Loader -->
                <div class="loader" id="tableLoader" style="display: none;"></div>
            </div>

            <!-- Vue Visuelle (Plan de salle) -->
            <div class="visual-layout-container" id="visualView">
                <div class="grid-header in-specific-view">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h3><i class="fas fa-th"></i> Plan de Salle (<span id="visualTablesCount">0</span>)</h3>
                    </div>
                    <div class="actions-container">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid">
                                <i class="fas fa-th-large"></i>
                                <span>Grille</span>
                            </button>
                            <button class="view-btn" data-view="table">
                                <i class="fas fa-table"></i>
                                <span>Tableau</span>
                            </button>
                            <button class="view-btn" data-view="visual">
                                <i class="fas fa-th"></i>
                                <span>Visuel</span>
                            </button>
                            <button class="view-btn" data-view="stats">
                                <i class="fas fa-chart-bar"></i>
                                <span>Statistiques</span>
                            </button>
                             <button class="view-btn" data-view="vector">
                                <i class="fas fa-shapes"></i>
                                <span>Vectoriel</span>
                            </button>
                            <button class="view-btn create create-table-btn">
                                <i class="fas fa-plus-circle"></i>
                                Nouvelle Table
                            </button>
                        </div>
                    </div>
                </div>
                <div class="visual-layout" id="visualLayout">
                    <!-- Le plan de salle sera injecté ici -->
                </div>
                <!-- État vide -->
                <div class="empty-state" id="emptyStateVisual" style="display: none;">
                    <i class="fas fa-th"></i>
                    <h3>Aucune table à afficher</h3>
                    <p>Créez des tables pour visualiser le plan de salle</p>
                    <button class="btn btn-primary" id="createFirstTableVisual">
                        <i class="fas fa-plus-circle"></i>
                        Créer une table
                    </button>
                </div>
                <!-- Loader -->
                <div class="loader" id="visualLoader" style="display: none;"></div>
            </div>

            <!-- Vue Statistiques -->
             <!-- Vue Statistiques -->
            <div class="stats-view-container" id="statsView">
            <div class="grid-header in-specific-view">
                <div style="display: flex; align-items: center; gap: 15px;">
                   
                    <h3><i class="fas fa-chart-bar"></i> Statistiques des Tables (<span id="statsTablesCount">0</span>)</h3>
                </div>
                <div class="actions-container">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid">
                                <i class="fas fa-th-large"></i>
                                <span>Grille</span>
                            </button>
                            <button class="view-btn" data-view="table">
                                <i class="fas fa-table"></i>
                                <span>Tableau</span>
                            </button>
                            <button class="view-btn" data-view="visual">
                                <i class="fas fa-th"></i>
                                <span>Visuel</span>
                            </button>
                            <button class="view-btn" data-view="stats">
                                <i class="fas fa-chart-bar"></i>
                                <span>Statistiques</span>
                            </button>
                             <button class="view-btn" data-view="vector">
                                <i class="fas fa-shapes"></i>
                                <span>Vectoriel</span>
                            </button>
                            <button class="view-btn create create-table-btn">
                                <i class="fas fa-plus-circle"></i>
                                Nouvelle Table
                            </button>
                        </div>
                    </div>
                
            </div>
                
                <div class="stats-grid">
                    <div class="stat-card-advanced">
                        <div class="stat-title">
                            <i class="fas fa-chart-pie"></i>
                            Taux d'occupation global
                        </div>
                        <div class="stat-value" id="overallOccupancyRate">0%</div>
                        <div class="stat-details">
                            <span id="totalOccupiedSeats">0</span> places occupées sur <span id="totalCapacity">0</span>
                        </div>
                    </div>
                    
                    <div class="stat-card-advanced">
                        <div class="stat-title">
                            <i class="fas fa-users"></i>
                            Distribution des tables
                        </div>
                        <div class="stat-value" id="fullTablesCount">0</div>
                        <div class="stat-details">
                            <span id="emptyTablesCount">0</span> vides • <span id="availableTablesCount">0</span> disponibles
                        </div>
                    </div>
                    
                    <div class="stat-card-advanced">
                        <div class="stat-title">
                            <i class="fas fa-user-friends"></i>
                            Invités assignés
                        </div>
                        <div class="stat-value" id="totalAssignedGuests">0</div>
                        <div class="stat-details">
                            <span id="guestsWithSeats">0</span> invités • <span id="totalSeatsUsed">0</span> places utilisées
                        </div>
                    </div>
                    
                    <div class="stat-card-advanced">
                        <div class="stat-title">
                            <i class="bi bi-qr-code"></i>
                            Activité QR Code
                        </div>
                        <div class="stat-value" id="totalQRScans">0</div>
                        <div class="stat-details">
                            <span id="lastQRScan">Jamais</span> • <span id="mostScannedTable">Aucune</span>
                        </div>
                    </div>
                </div>
                
                <!-- Ajoutez après le div .charts-container existant -->
<div class="charts-container">
    <!-- Chart existant -->
    <div class="chart-card">
        <div class="chart-title">
            <i class="fas fa-chart-bar"></i>
            Distribution des capacités
        </div>
        <div class="chart-placeholder" id="capacityChart">
            <!-- Chart.js s'affichera ici -->
        </div>
    </div>
    
    <!-- Chart existant -->
    <div class="chart-card">
        <div class="chart-title">
            <i class="fas fa-chart-pie"></i>
            Occupation par catégorie
        </div>
        <div class="chart-placeholder" id="categoryChart">
            <!-- Chart.js s'affichera ici -->
        </div>
    </div>
</div>

<!-- AJOUTER CES NOUVELLES SECTIONS -->
<div class="advanced-charts-container">
    <!-- Radar Chart - Vue 360° des catégories -->
    <div class="chart-card advanced">
        <div class="chart-title">
            <i class="fas fa-bullseye"></i>
            Performance par catégorie
            <span class="chart-subtitle">Comparaison multidimensionnelle</span>
        </div>
        <div class="chart-placeholder advanced" id="radarChart">
            <canvas></canvas>
        </div>
    </div>
    
    <!-- Line Chart - Évolution de l'occupation -->
    <div class="chart-card advanced">
        <div class="chart-title">
            <i class="fas fa-chart-line"></i>
            Tendance d'occupation
            <span class="chart-subtitle">Évolution temporelle</span>
        </div>
        <div class="chart-placeholder advanced" id="lineChart">
            <canvas></canvas>
        </div>
    </div>
    
    <!-- Bubble Chart - Vue densité/taille -->
    <div class="chart-card advanced">
        <div class="chart-title">
            <i class="fas fa-circle-nodes"></i>
            Densité des tables
            <span class="chart-subtitle">Capacité vs Occupation</span>
        </div>
        <div class="chart-placeholder advanced" id="bubbleChart">
            <canvas></canvas>
        </div>
    </div>
    
    <!-- Polar Area Chart - Vue circulaire avancée -->
    <div class="chart-card advanced">
        <div class="chart-title">
            <i class="fas fa-chart-polar"></i>
            Répartition des statuts
            <span class="chart-subtitle">Par catégorie et occupation</span>
        </div>
        <div class="chart-placeholder advanced" id="polarChart">
            <canvas></canvas>
        </div>
    </div>
</div>

<!-- KPI Cards améliorées -->
<div class="kpi-grid-container">
    <div class="kpi-card trending">
        <div class="kpi-icon">
            <i class="fas fa-trending-up"></i>
        </div>
        <div class="kpi-content">
            <div class="kpi-value" id="trendValue">+12%</div>
            <div class="kpi-label">Tendance occupation</div>
            <div class="kpi-trend positive">Sur la semaine</div>
        </div>
    </div>
    
    <div class="kpi-card efficiency">
        <div class="kpi-icon">
            <i class="fas fa-bolt"></i>
        </div>
        <div class="kpi-content">
            <div class="kpi-value" id="efficiencyValue">87%</div>
            <div class="kpi-label">Efficacité d'assignation</div>
            <div class="kpi-trend stable">Optimisé</div>
        </div>
    </div>
    
    <div class="kpi-card diversity">
        <div class="kpi-icon">
            <i class="fas fa-layer-group"></i>
        </div>
        <div class="kpi-content">
            <div class="kpi-value" id="diversityValue">64%</div>
            <div class="kpi-label">Diversité des groupes</div>
            <div class="kpi-trend positive">Équilibré</div>
        </div>
    </div>
    
    <div class="kpi-card prediction">
        <div class="kpi-icon">
            <i class="fas fa-crystal-ball"></i>
        </div>
        <div class="kpi-content">
            <div class="kpi-value" id="predictionValue">92%</div>
            <div class="kpi-label">Taux de satisfaction prévu</div>
            <div class="kpi-trend positive">Excellent</div>
        </div>
    </div>
</div>
                
                <!-- État vide 
                <div class="empty-state" id="emptyStateStats" style="display: none !important;">
                    <i class="fas fa-chart-bar"></i>
                    <h3>Aucune donnée statistique</h3>
                    <p>Créez des tables pour générer des statistiques</p>
                    <button class="btn btn-primary" id="createFirstTableStats">
                        <i class="fas fa-plus-circle"></i>
                        Créer une table
                    </button>
                </div> -->
                <!-- Loader -->
                <div class="loader" id="statsLoader" style="display: none;"></div>
            </div>

            <!-- Vue Vectorielle (Plan de salle avancé) -->
            <div class="vector-tables-container" id="vectorView">
                <div class="grid-header in-specific-view">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        
                        <h3><i class="fas fa-shapes"></i> Plan Vectoriel (<span id="vectorTablesCount">0</span>)</h3>
                    </div>
                    <div class="actions-container">
                        <div class="view-toggle">
                            <button class="view-btn active" data-view="grid">
                                <i class="fas fa-th-large"></i>
                                <span>Grille</span>
                            </button>
                            <button class="view-btn" data-view="table">
                                <i class="fas fa-table"></i>
                                <span>Tableau</span>
                            </button>
                            <button class="view-btn" data-view="visual">
                                <i class="fas fa-th"></i>
                                <span>Visuel</span>
                            </button>
                            <button class="view-btn" data-view="stats">
                                <i class="fas fa-chart-bar"></i>
                                <span>Statistiques</span>
                            </button>
                             <button class="view-btn" data-view="vector">
                                <i class="fas fa-shapes"></i>
                                <span>Vectoriel</span>
                            </button>
                            <button class="btn btn-secondary btn-sm" id="arrangeTablesBtn">
                                <i class="fas fa-th"></i>
                                Réarranger
                            </button>
                            <button class="view-btn create create-table-btn">
                                <i class="fas fa-plus-circle"></i>
                                Nouvelle Table
                            </button>
                        </div>
                    </div>
                           
                </div>
                
                <!-- Statistiques de l'événement -->
                <div class="event-stats-cards" id="eventStatsCards">
                    <!-- Rempli dynamiquement -->
                </div>
                
                <div class="vector-canvas" id="vectorCanvas">
                    <!-- Les tables vectorielles seront injectées ici -->
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomInBtn" title="Zoomer">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button class="zoom-btn" id="zoomOutBtn" title="Dézoomer">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="zoom-btn" id="resetZoomBtn" title="Réinitialiser">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
                
                <!-- État vide -->
                <div class="empty-state" id="emptyStateVector" style="display: none;">
                    <i class="fas fa-shapes"></i>
                    <h3>Aucune table à afficher</h3>
                    <p>Créez des tables pour visualiser le plan vectoriel</p>
                    <button class="btn btn-primary" id="createFirstTableVector">
                        <i class="fas fa-plus-circle"></i>
                        Créer une table
                    </button>
                </div>
                
                <!-- Loader -->
                <div class="loader" id="vectorLoader" style="display: none;"></div>
            </div>
            <!-- Pagination -->
            <div class="pagination" id="pagination" style="display: none;">
                <!-- La pagination sera injectée ici -->
            </div>
        </div>
        
        
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-top">
                <div class="row">
                    <div class="col-lg-4 mb-5 mb-lg-0">
                        <div class="footer-brand">
                            <div class="footer-logo">
                                <img src="assets/images/icon.png" alt="SECURA Logo">
                            </div>
                            <div class="footer-title">
                                <h3>SECURA</h3>
                                <p>Plateforme d'accès événementiel</p>
                            </div>
                        </div>
                        <p class="footer-description">
                            SECURA révolutionne l'accès aux événements avec des solutions innovantes, 
                            sécurisées et intuitives pour organisateurs et participants.
                        </p>
                        <div class="social-links">
                            <a href="#" class="social-link">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-linkedin-in"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-youtube"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg-2 col-md-4 mb-5">
                        <h4>Navigation</h4>
                        <ul class="footer-links">
                            <li><a href="index.html">Accueil</a></li>
                            <li><a href="access.html">Accès événement</a></li>
                            <li><a href="#features">Fonctionnalités</a></li>
                            <li><a href="#how-it-works">Comment ça marche</a></li>
                        </ul>
                    </div>
                    
                    <div class="col-lg-2 col-md-4 mb-5">
                        <h4>Compte</h4>
                        <ul class="footer-links">
                            <li><a href="login.html">Connexion</a></li>
                            <li><a href="register.html">Inscription</a></li>
                            <li><a href="forgot-password.html">Mot de passe oublié</a></li>
                        </ul>
                    </div>
                    
                    <div class="col-lg-4 col-md-4">
                        <h4>Newsletter</h4>
                        <p class="mb-4">Inscrivez-vous pour recevoir nos actualités et offres exclusives.</p>
                        <form class="newsletter-form" id="newsletterForm">
                            <div class="newsletter-input-group">
                                <input type="email" class="newsletter-input" placeholder="Votre email" required>
                                <button type="submit" class="newsletter-btn">
                                    <i class="fas fa-paper-plane"></i>
                                   
                                </button>
                            </div>
                        </form>
                       
                        <div class="footer-controls-inline">
                            <!-- Theme Switch Button -->
                            <div class="theme-switch-footer">
                                <label class="theme-switch">
                                    <input type="checkbox" id="themeSwitchFooter" aria-label="Basculer le thème">
                                    <span class="theme-switch-slider">
                                        <i class="fas fa-moon"></i>
                                        <i class="fas fa-sun"></i>
                                    </span>
                                </label>
                            </div>

                            <!-- Language Selector -->
                            <div class="language-selector"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="copyright">© 2025 SECURA. Tous droits réservés.</p>
                    </div>
                    <div class="col-md-6">
                        <div class="footer-legal">
                            <a href="#">Mentions légales</a>
                            <a href="#">Confidentialité</a>
                            <a href="#">CGU</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Bouton retour en haut -->
    <button class="scroll-top" id="scrollTop" aria-label="Retour en haut">
        <i class="fas fa-arrow-up"></i>
    </button>




    <!-- MODAL DE CRÉATION EN ÉTAPES -->
<div class="table-creation-modal" id="tableCreationModal">
    <div class="table-creation-wrapper">
        <!-- Bouton fermeture -->
        <button class="modal-close-btn" id="closeTableModalBtn" title="Fermer">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Panneau de progression vertical -->
        <div class="creation-progress-panel">
            <div class="progress-title" id="progressTitle">CRÉATION DE TABLE(S)</div>
            
            
            
            <div class="vertical-steps">
                <div class="vertical-step active" data-step="1">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Type de création</span>
                        <span class="vertical-step-description">Choisissez entre création simple ou multiple</span>
                    </div>
                </div>
                
                <div class="vertical-step" data-step="2">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Informations de base</span>
                        <span class="vertical-step-description">Nom et capacité de la table</span>
                    </div>
                </div>
                
                <div class="vertical-step" data-step="3">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Configuration</span>
                        <span class="vertical-step-description">Emplacement, catégorie et options</span>
                    </div>
                </div>
                
                <div class="vertical-step" data-step="4">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Assignation</span>
                        <span class="vertical-step-description">Ajouter des invités à la table</span>
                    </div>
                </div>
                
                <div class="vertical-step" data-step="5">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Confirmation</span>
                        <span class="vertical-step-description">Vérification avant création</span>
                    </div>
                </div>
            </div>
            
            <div class="creation-progress-info">
                <div class="creation-progress-text">Progression</div>
                <div class="creation-progress-percentage" id="creationProgressPercentage">20%</div>
            </div>
            <!-- Barre de progression linéaire -->
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
        </div>

        <!-- Panneau de formulaire -->
        <div class="creation-form-panel">
            <!-- Étape 1: Type de création -->
            <div class="creation-step-content active" id="creationStep1">
                <div class="creation-header">
                    <h2 class="creation-title">Type de création</h2>
                    <p class="creation-subtitle">Choisissez comment vous souhaitez créer vos tables</p>
                </div>

                <div class="form-group" style="text-align: center; margin-top: 40px;">
                    <div style="display: flex; gap: 30px; justify-content: center; margin-bottom: 40px;">
                        <div class="creation-option" id="singleTableOption" 
                             style="flex: 1; max-width: 300px; cursor: pointer; padding: 30px; background: var(--hover-bg); border-radius: var(--border-radius); border: 2px solid var(--border-color); ">
                            <i class="fas fa-chair" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 10px;">Table unique</h3>
                            <p style="color: var(--text-color); opacity: 0.7; margin-bottom: 20px;">
                                Créer une seule table avec des paramètres détaillés
                            </p>
                            <div class="form-help">Idéal pour les tables spéciales (VIP, Mariés, etc.)</div>
                        </div>
                        
                        <div class="creation-option" id="multipleTablesOption" 
                             style="flex: 1; max-width: 300px; cursor: pointer; padding: 30px; background: var(--hover-bg); border-radius: var(--border-radius); border: 2px solid var(--border-color); ">
                            <i class="fas fa-layer-group" style="font-size: 3rem; color: var(--info); margin-bottom: 20px;"></i>
                            <h3 style="margin-bottom: 10px;">Création multiple</h3>
                            <p style="color: var(--text-color); opacity: 0.7; margin-bottom: 20px;">
                                Créer plusieurs tables similaires en une seule fois
                            </p>
                            <div class="form-help">Parfait pour les salles avec tables standardisées</div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 30px;">
                        <label class="form-label" style="text-align: center; display: block; margin-bottom: 15px;">
                            <i class="fas fa-bolt"></i>
                            Option rapide
                        </label>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-secondary" id="quickTableBtn" style="padding: 10px 20px;">
                                <i class="fas fa-bolt"></i>
                                Table rapide
                            </button>
                            <div class="form-help" style="text-align: center; margin-top: 10px;">
                                Crée une table avec des paramètres par défaut en un clic
                            </div>
                        </div>
                    </div>
                </div>

                <div class="creation-navigation">
                    <button class="btn btn-secondary" id="cancelCreationBtn">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button class="btn btn-primary" id="nextToStep2" style="display: none;">
                        Suivant
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Étape 2: Informations de base -->
<!-- Étape 2: Informations de base -->
<div class="creation-step-content" id="creationStep2">
    <div class="creation-header">
        <h2 class="creation-title" id="step2Title">Informations de base</h2>
        <p class="creation-subtitle" id="step2Subtitle">Définissez les informations essentielles de votre table</p>
    </div>

    <div id="singleTableForm" style="display: none;">
        <form id="singleTableStep2Form">
            <!-- Section pour afficher le code de table -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-hashtag"></i>
                    Code de table
                </label>
                
                <!-- Message pour nouvelle table (CRÉATION) -->
                <div id="codeInfoMessage" class="code-info-message">
                    Le code de table sera généré automatiquement par le système
                </div>
                
                <!-- Display pour édition (ÉDITION) -->
                <div id="codeDisplayContainer" class="code-display-container">
                    --
                </div>
                
                <div class="form-help" id="codeHelpText">Code automatiquement généré</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-tag"></i>
                    Nom de la table
                    <span class="required">*</span>
                </label>
                <input type="text" id="singleTableName" class="form-control" 
                       placeholder="Ex: Amour, Éternité, Rose, VIP 1" maxlength="50" required>
                <div class="form-help">Nom pour identifier la table</div>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-users"></i>
                    Capacité
                    <span class="required">*</span>
                </label>
                
                <!-- Contrôles de capacité améliorés -->
                <div class="capacity-control-group">
                    <button type="button" class="capacity-btn" id="decreaseCapacity" title="Diminuer la capacité">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="singleTableCapacity" class="form-control" 
                           placeholder="Nombre de places" required min="1" max="50" value="8">
                    <button type="button" class="capacity-btn" id="increaseCapacity" title="Augmenter la capacité">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- Boutons de capacité rapide -->
                <div class="quick-capacity-buttons">
                    <button type="button" class="quick-capacity-btn" data-capacity="2">2 places</button>
                    <button type="button" class="quick-capacity-btn" data-capacity="4">4 places</button>
                    <button type="button" class="quick-capacity-btn" data-capacity="6">6 places</button>
                    <button type="button" class="quick-capacity-btn" data-capacity="8">8 places</button>
                    <button type="button" class="quick-capacity-btn" data-capacity="10">10 places</button>
                    <button type="button" class="quick-capacity-btn" data-capacity="12">12 places</button>
                </div>
                
                <div class="validation-message" id="singleCapacityValidation"></div>
                <div class="form-help">Entre 1 et 50 places</div>
            </div>
        </form>
    </div>

    <div id="multipleTablesForm" style="display: none;">
        <div class="multiple-tables-form">
            <h4 class="multiple-tables-title">
                <i class="fas fa-layer-group"></i>
                Tables à créer
            </h4>
            
            <div id="multipleTablesList">
                <!-- Les formulaires de tables multiples seront ajoutés ici dynamiquement -->
            </div>
            
            <button type="button" class="add-table-btn" id="addAnotherTableBtn">
                <i class="fas fa-plus-circle"></i>
                Ajouter une autre table
            </button>
        </div>
        
        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-copy"></i>
                Options de duplication
            </label>
            <div class="duplicate-settings-container">
                <button type="button" class="btn btn-secondary btn-sm" id="duplicateSettingsBtn">
                    <i class="fas fa-clone"></i>
                    Dupliquer les paramètres
                </button>
                <div class="form-help">
                    Applique les paramètres de la première table à toutes les autres
                </div>
            </div>
        </div>
    </div>

    <div class="creation-navigation">
        <button class="btn btn-secondary" id="backToStep1">
            <i class="fas fa-arrow-left"></i>
            Précédent
        </button>
        <button class="btn btn-primary" id="nextToStep3">
            Suivant
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>
            <!-- Étape 3: Configuration -->
            <div class="creation-step-content" id="creationStep3">
                <div class="creation-header">
                    <h2 class="creation-title">Configuration</h2>
                    <p class="creation-subtitle">Configurez l'emplacement et la catégorie de votre table</p>
                </div>

                <div id="singleTableConfig" style="display: none;">
                    <form id="singleTableStep3Form">
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-map-marker-alt"></i>
                                    Emplacement
                                </label>
                                <input type="text" id="singleTableLocation" class="form-control" 
                                       placeholder="Ex: Zone VIP, Près de l'estrade" maxlength="100">
                                <div class="form-help">Position dans la salle</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-tags"></i>
                                    Catégorie
                                </label>
                                <select id="singleTableCategory" class="form-control">
                                    <option value="standard">Standard</option>
                                    <option value="vip">VIP</option>
                                    <option value="family">Familiale</option>
                                    <option value="speaker">Conférencier</option>
                                    <option value="organizer">Organisateur</option>
                                    <option value="other">Autre</option>
                                </select>
                                <div class="form-help">Catégorie de la table</div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-align-left"></i>
                                Description
                            </label>
                            <textarea id="singleTableDescription" class="form-control" 
                                      placeholder="Description de la table..." 
                                      rows="3" maxlength="500"></textarea>
                            <div class="form-help">Maximum 500 caractères</div>
                        </div>
                    </form>
                </div>

                <div id="multipleTablesConfig" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-map-marker-alt"></i>
                            Emplacement commun
                        </label>
                        <input type="text" id="multipleTablesLocation" class="form-control" 
                               placeholder="Ex: Zone principale, Salle Est" maxlength="100">
                        <div class="form-help">Emplacement appliqué à toutes les tables</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tags"></i>
                            Catégorie commune
                        </label>
                        <select id="multipleTablesCategory" class="form-control">
                            <option value="standard">Standard</option>
                            <option value="vip">VIP</option>
                            <option value="family">Familiale</option>
                            <option value="speaker">Conférencier</option>
                            <option value="organizer">Organisateur</option>
                            <option value="other">Autre</option>
                        </select>
                        <div class="form-help">Catégorie appliquée à toutes les tables</div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-align-left"></i>
                            Description commune
                        </label>
                        <textarea id="multipleTablesDescription" class="form-control" 
                                  placeholder="Description commune pour toutes les tables..." 
                                  rows="3" maxlength="500"></textarea>
                        <div class="form-help">Description appliquée à toutes les tables</div>
                    </div>
                </div>

                <!-- Aperçu -->
                <div class="table-preview-card" id="tablePreviewCard" style="display: none;">
                    <div class="preview-table-header">
                        <div class="preview-table-title">Aperçu de la table</div>
                        <button type="button" class="btn btn-secondary btn-sm" id="refreshPreviewBtn">
                            <i class="fas fa-sync-alt"></i>
                            Actualiser
                        </button>
                    </div>
                    <div class="preview-table-content" id="previewTableContent">
                        <!-- L'aperçu sera injecté ici -->
                    </div>
                </div>

                <div class="creation-navigation">
                    <button class="btn btn-secondary" id="backToStep2">
                        <i class="fas fa-arrow-left"></i>
                        Précédent
                    </button>
                    <button class="btn btn-primary" id="nextToStep4">
                        Suivant
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Étape 4: Assignation -->
            <div class="creation-step-content" id="creationStep4">
                <div class="creation-header">
                    <h2 class="creation-title">Assignation d'invités</h2>
                    <p class="creation-subtitle" id="step4Subtitle">Assignez des invités à votre table (optionnel)</p>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-search"></i>
                        Rechercher des invités
                    </label>
                    <div class="search-container">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchGuestsCreation" class="form-control" 
                               placeholder="Rechercher un invité par nom, email...">
                    </div>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <label class="form-label" style="margin: 0;">
                            <i class="fas fa-users"></i>
                            Invités disponibles
                        </label>
                        <button type="button" class="btn btn-secondary btn-sm" id="autoAssignCreationBtn">
                            <i class="fas fa-robot"></i>
                            Auto-assigner
                        </button>
                    </div>
                    
                    <div class="available-guests" id="availableGuestsCreation" 
                         style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 15px;">
                        <!-- Les invités disponibles seront injectés ici -->
                        <div style="text-align: center; padding: 40px 20px; color: var(--text-color); opacity: 0.5;">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 15px;"></i>
                            <p>Chargement des invités...</p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-user-check"></i>
                        Invités sélectionnés
                        <span class="badge" id="selectedGuestsCount">0</span>
                    </label>
                    <div class="selected-guests" id="selectedGuestsList" 
                         style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 15px;">
                        <!-- Les invités sélectionnés seront affichés ici -->
                        <div style="text-align: center; padding: 30px 20px; color: var(--text-color); opacity: 0.5;">
                            <i class="fas fa-user-plus" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>Aucun invité sélectionné</p>
                            <small>Sélectionnez des invités dans la liste ci-dessus</small>
                        </div>
                    </div>
                </div>

                <div class="creation-navigation">
                    <button class="btn btn-secondary" id="backToStep3">
                        <i class="fas fa-arrow-left"></i>
                        Précédent
                    </button>
                    <button class="btn btn-primary" id="nextToStep5">
                        Suivant
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>

            <!-- Étape 5: Confirmation -->
            <div class="creation-step-content" id="creationStep5">
                <div class="creation-header">
                    <h2 class="creation-title">Confirmation</h2>
                    <p class="creation-subtitle" id="step5Subtitle">Vérifiez les informations avant de créer</p>
                </div>

                <div id="confirmationContent">
                    <!-- Le contenu de confirmation sera injecté ici -->
                </div>

                <div class="creation-navigation">
                    <button class="btn btn-secondary" id="backToStep4">
                        <i class="fas fa-arrow-left"></i>
                        Précédent
                    </button>
                    <button class="btn btn-primary" id="submitTablesCreation">
                        <i class="fas fa-check-circle"></i>
                        Créer les tables
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- MODAL EXPORT TABLE INFO -->
<!-- MODAL EXPORT TABLE INFO -->
<div class="table-creation-modal" id="tableExportInfoModal">
    <div class="table-creation-wrapper">
        <button class="modal-close-btn" id="closeExportInfoBtn" title="Fermer">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="creation-progress-panel">
            <div class="progress-title">EXPORTATION</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="exportProgressBar" style="width: 50%;"></div>
            </div>
            <div style="text-align: center; font-size: 12px; color: var(--text-color); margin-top: 5px;">
                Étape <span id="exportCurrentStep">1</span> sur 2
            </div>
            
            <div class="vertical-steps">
                <div class="vertical-step active" id="exportStep1Indicator">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Format</span>
                        <span class="vertical-step-description">Choisir le type</span>
                    </div>
                </div>
                <div class="vertical-step" id="exportStep2Indicator">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Téléchargement</span>
                        <span class="vertical-step-description">Obtenir le fichier</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="creation-form-panel">
            <!-- ÉTAPE 1 : Choix du format -->
            <div class="creation-step-content active" id="exportStep1">
                <div class="creation-header">
                    <h2 class="creation-title">Exporter les Informations</h2>
                    <p class="creation-subtitle">Sélectionnez le format d'export qui vous convient</p>
                </div>

                <div style="padding: 10px 0;">
                    <!-- Statistiques -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px;">
                        <div style="background: var(--hover-bg); padding: 20px; border-radius: 2px; border-left: 4px solid var(--primary);">
                            <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">TABLES</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--primary);" id="exportTableCount">0</div>
                        </div>
                        <div style="background: var(--hover-bg); padding: 20px; border-radius: 2px; border-left: 4px solid var(--success);">
                            <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">INVITÉS</div>
                            <div style="font-size: 2em; font-weight: 700; color: var(--success);" id="exportGuestCount">0</div>
                        </div>
                    </div>

                    <!-- Options d'export -->
                    <div style="background: var(--hover-bg); padding: 30px; border-radius: 2px; border: 1px solid var(--border-color);">
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                            <!-- PDF Option -->
                            <button onclick="selectExportFormat('pdf')" class="export-format-btn" data-format="pdf">
                                <i class="bi bi-file-pdf" style="font-size: 3.5em; color: #dc2626;"></i>
                                <span style="font-weight: 700; color: var(--text-color); font-size: 1.1em;">PDF</span>
                                <small style="color: #999; font-size: 0.85em;">Document professionnel</small>
                            </button>
                            
                            <!-- JSON Option -->
                            <button onclick="selectExportFormat('json')" class="export-format-btn" data-format="json">
                                <i class="bi bi-file-code" style="font-size: 3.5em; color: #7c3aed;"></i>
                                <span style="font-weight: 700; color: var(--text-color); font-size: 1.1em;">JSON</span>
                                <small style="color: #999; font-size: 0.85em;">Format données</small>
                            </button>
                            
                            <!-- CSV Option -->
                            <button onclick="selectExportFormat('csv')" class="export-format-btn" data-format="csv">
                                <i class="bi bi-file-spreadsheet" style="font-size: 3.5em; color: #16a34a;"></i>
                                <span style="font-weight: 700; color: var(--text-color); font-size: 1.1em;">CSV</span>
                                <small style="color: #999; font-size: 0.85em;">Tableur Excel</small>
                            </button>
                            
                            <!-- Imprimer Option -->
                            <button onclick="selectExportFormat('print')" class="export-format-btn" data-format="print">
                                <i class="bi bi-printer" style="font-size: 3.5em; color: #0891b2;"></i>
                                <span style="font-weight: 700; color: var(--text-color); font-size: 1.1em;">Imprimer</span>
                                <small style="color: #999; font-size: 0.85em;">Aperçu impression</small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÉTAPE 2 : Génération et téléchargement -->
            <div class="creation-step-content" id="exportStep2">
                <div class="creation-header">
                    <h2 class="creation-title">Génération en cours...</h2>
                    <p class="creation-subtitle" id="exportSubtitle">Préparation de votre fichier</p>
                </div>

                <div style="padding: 40px 0;">
                    <!-- État de génération -->
                    <div id="exportLoader" style="display: block; text-align: center;">
                        <div class="spinner" style="width: 80px; height: 80px; border: 6px solid var(--hover-bg); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; margin: 0 auto 30px;"></div>
                        
                        <div style="background: var(--hover-bg); padding: 25px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; text-align: left;">
                                <div>
                                    <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">TYPE D'EXPORT</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--text-color); text-transform: uppercase;" id="exportOperationType">PDF</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">TABLES TRAITÉES</div>
                                    <div style="font-size: 1.1em; font-weight: 600; color: var(--primary);" id="exportTablesDone">0</div>
                                </div>
                            </div>
                        </div>

                        <p style="color: #999; font-size: 0.95em;">Veuillez patienter pendant la génération de votre document...</p>
                    </div>

                    <!-- Succès -->
                    <div id="exportSuccess" style="display: none; text-align: center;">
                        <i class="bi bi-check-circle" style="font-size: 5em; color: var(--success);"></i>
                        <p style="margin-top: 20px; font-size: 1.3em; font-weight: 700; color: var(--success);" id="exportMessage">Export réussi !</p>
                        <div style="background: var(--hover-bg); padding: 20px; border-radius: 12px; margin: 20px 0;">
                            <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">TEMPS D'EXÉCUTION</div>
                            <div style="font-size: 1.5em; font-weight: 700; color: var(--text-color);"><span id="exportTimeTaken">0</span></div>
                        </div>
                        
                        <button onclick="closeExportModal()" class="btn btn-primary" style="margin-top: 20px; padding: 12px 40px;">
                            <i class="bi bi-check-lg me-2"></i>
                            Terminé
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Boutons de format d'export */
.export-format-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 25px 20px;
    background: var(--card-bg);
    border: 2px solid transparent;
    border-radius: 2px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-family: inherit;
}

.export-format-btn:hover {
    border-color: var(--primary);
    box-shadow: 0 8px 24px rgba(217, 119, 6, 0.15);
    background: var(--input-bg);
    transform: translateY(-2px);
}

.export-format-btn.selected {
    border-color: var(--primary);
    background: var(--input-bg);
    box-shadow: 0 0 0 4px rgba(217, 119, 6, 0.1);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>



    <!-- MODAL IMPORT CSV TABLES -->
    <div class="table-creation-modal" id="tablesCsvImportModal">
        <div class="table-creation-wrapper">
            <button class="modal-close-btn" id="closeTablesCsvBtn" title="Fermer">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="creation-progress-panel">
                <div class="progress-title">IMPORT CSV</div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill" id="tablesCsvProgressBar" style="width: 33%;"></div>
                </div>
                <div id="tablesCsvProgressText" style="text-align: center; font-size: 12px; color: var(--text-color); margin-top: 5px;">Étape 1/3</div>
                
                <div class="vertical-steps">
                    <div class="vertical-step active" id="tablesCsvStep1Indicator">
                        <div class="vertical-step-info">
                            <span class="vertical-step-label">Sélection</span>
                            <span class="vertical-step-description">Importez votre fichier CSV</span>
                        </div>
                    </div>
                    <div class="vertical-step" id="tablesCsvStep2Indicator">
                        <div class="vertical-step-info">
                            <span class="vertical-step-label">Validation</span>
                            <span class="vertical-step-description">Corrigez les champs</span>
                        </div>
                    </div>
                    <div class="vertical-step" id="tablesCsvStep3Indicator">
                        <div class="vertical-step-info">
                            <span class="vertical-step-label">Confirmation</span>
                            <span class="vertical-step-description">Finaliser l'import</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="creation-form-panel">
                <!-- ÉTAPE 1: SÉLECTION DU FICHIER -->
                <div class="creation-step-content active" id="tablesCsvStep1Content">
                    <div class="creation-header">
                        <h2 class="creation-title">Importer des Tables depuis CSV</h2>
                        <p class="creation-subtitle">Importez plusieurs tables en une seule fois pour <strong id="tablesCsvEventName">l'événement</strong></p>
                    </div>

                    <div class="alert alert-info" style="margin-bottom: 20px;">
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>Format CSV attendu :</strong>
                            <p>Numéro,Nom,Capacité,Catégorie,Lieu,Notes</p>
                            <button type="button" class="btn btn-link" id="downloadTablesCsvTemplateBtn">
                                <i class="fas fa-download"></i>
                                Télécharger un modèle
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-file-upload"></i>
                            Fichier CSV
                            <span class="required">*</span>
                        </label>
                        <div class="file-upload-area" id="tablesCsvDropZone" style="cursor: pointer;">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Glissez-déposez votre fichier CSV ici</p>
                            <p class="text-sm">ou cliquez pour sélectionner un fichier</p>
                            <input type="file" id="tablesCsvFileInput" accept=".csv" style="display: none;">
                        </div>
                    </div>

                    <div class="creation-navigation">
                        <button class="btn btn-secondary" id="closeTablesCsvModalBtn">
                            <i class="fas fa-times"></i>
                            Annuler
                        </button>
                    </div>
                </div>

                <!-- ÉTAPE 2: VALIDATION ET ÉDITION DES CHAMPS -->
                <div class="creation-step-content" id="tablesCsvStep2Content">
                    <div class="creation-header">
                        <h2 class="creation-title">Valider et Éditer les Tables</h2>
                        <p class="creation-subtitle">Une fenêtre de validation s'est ouverte. Veuillez modifier les données invalides.</p>
                    </div>

                    <div style="padding: 40px; text-align: center; color: var(--text-color); opacity: 0.7;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 40px; margin-bottom: 20px;"></i>
                        <p>La fenêtre de validation est en cours de chargement...</p>
                    </div>
                </div>

                <!-- ÉTAPE 3: CONFIRMATION ET IMPORT -->
                <div class="creation-step-content" id="tablesCsvStep3Content">
                    <div class="creation-header">
                        <h2 class="creation-title">Confirmation Finale</h2>
                        <p class="creation-subtitle">Vérifiez les données avant de finaliser l'import</p>
                    </div>

                    <div style="padding: 40px; text-align: center; color: var(--text-color); opacity: 0.7;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 40px; margin-bottom: 20px;"></i>
                        <p>Préparation de la confirmation...</p>
                    </div>

                    <div class="creation-navigation">
                        <button class="btn btn-secondary" id="tablesCsvBackToStep2Btn">
                            <i class="fas fa-arrow-left"></i>
                            Précédent
                        </button>
                        <button class="btn btn-success" id="tablesCsvFinalImportBtn">
                            <i class="fas fa-upload"></i>
                            Finaliser l'import
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- MODAL DE GÉNÉRATION DE QR CODES EN MASSE -->
<div class="table-creation-modal" id="qrBulkGenerationModal">
    <div class="table-creation-wrapper">
        <button class="modal-close-btn" id="closeQrBulkBtn" title="Fermer">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="creation-progress-panel">
            <div class="progress-title" id="progressTitle">GÉNÉRATION QR CODES</div>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" id="qrBulkProgressBar" style="width: 0%;"></div>
            </div>
            <div id="qrBulkProgressText" style="text-align: center; font-size: 12px; color: var(--text-color); margin-top: 5px;">Étape 1/3</div>
            
            <div class="vertical-steps">
                <div class="vertical-step active" id="qrBulkStep1Indicator" data-step="1">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Sélection</span>
                        <span class="vertical-step-description">Choisissez les tables</span>
                    </div>
                </div>
                <div class="vertical-step" id="qrBulkStep2Indicator" data-step="2">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Génération</span>
                        <span class="vertical-step-description">Création des QR codes</span>
                    </div>
                </div>
                <div class="vertical-step" id="qrBulkStep3Indicator" data-step="3">
                    <div class="vertical-step-info">
                        <span class="vertical-step-label">Téléchargement</span>
                        <span class="vertical-step-description">Récupérer l'archive</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="creation-form-panel">
            <!-- ÉTAPE 1: SÉLECTION DES TABLES -->
            <div class="creation-step-content active" id="qrBulkStep1Content">
                <div class="creation-header">
                    <h2 class="creation-title">Sélectionner les Tables</h2>
                    <p class="creation-subtitle">Choisissez les tables pour lesquelles générer les QR codes</p>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: space-between; align-items: center;">
                    <div style="display: flex; flex: 1; gap: 10px;">
                        <button class="btn btn-sm btn-secondary" id="selectAllTablesBtn">
                            <i class="fas fa-check-double"></i>
                            Tout sélectionner
                        </button>
                        <button class="btn btn-sm btn-secondary" id="deselectAllTablesBtn">
                            <i class="fas fa-times"></i>
                            Tout désélectionner
                        </button>
                    </div>
                    <div style="padding: 8px 16px; background: var(--primary); color: white; border-radius: 6px; font-weight: 600;">
                        <span id="qrSelectedTablesCount">0</span> sélectionnée(s)
                    </div>
                </div>

                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    <table style="width: 100%; border-collapse: collapse;" id="qrTablesSelectionTable">
                        <thead style="position: sticky; top: 0; background: var(--card-bg); z-index: 10;">
                            <tr>
                                <th style="width: 50px; text-align: center; padding: 12px 8px; border-bottom: 1px solid var(--border-color);">
                                    <input type="checkbox" id="masterCheckbox" style="cursor: pointer; width: 16px; height: 16px;">
                                </th>
                                <th style="width: 100px; padding: 12px 8px; border-bottom: 1px solid var(--border-color); text-align: left; font-weight: 600;">N° Table</th>
                                <th style="width: 150px; padding: 12px 8px; border-bottom: 1px solid var(--border-color); text-align: left; font-weight: 600;">Nom</th>
                                <th style="width: 100px; padding: 12px 8px; border-bottom: 1px solid var(--border-color); text-align: left; font-weight: 600;">Capacité</th>
                                <th style="width: 120px; padding: 12px 8px; border-bottom: 1px solid var(--border-color); text-align: left; font-weight: 600;">Catégorie</th>
                                <th style="width: 100px; padding: 12px 8px; border-bottom: 1px solid var(--border-color); text-align: left; font-weight: 600;">Emplacement</th>
                            </tr>
                        </thead>
                        <tbody id="qrTablesChecklistContainer"></tbody>
                    </table>
                </div>

                <div class="creation-navigation" style="margin-top: 20px;">
                    <button class="btn btn-secondary" id="closeQrBulkModalBtn">
                        <i class="fas fa-times"></i>
                        Annuler
                    </button>
                    <button class="btn btn-primary" id="qrBulkGenerateBtn">
                        <i class="fas fa-wand-magic-sparkles"></i>
                        Générer les QR Codes
                    </button>
                </div>
            </div>

            <!-- ÉTAPE 2: GÉNÉRATION -->
            <div class="creation-step-content" id="qrBulkStep2Content">
                <div class="creation-header">
                    <h2 class="creation-title">Génération en Cours</h2>
                    <p class="creation-subtitle" id="generationSubtitle">Veuillez patienter pendant la génération...</p>
                </div>

                <div style="padding: 20px 0;">
                    <!-- Prévisualisation des QR codes en temps réel - Au centre -->
                    <div style="margin: 20px 0; background: var(--hover-bg); padding: 30px; border-radius: 12px; border: 1px solid var(--border-color); position: relative;">
                        <div id="qrPreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(190px, 1fr)); gap: 25px; max-height: 500px; overflow-y: auto;">
                            <!-- Les QR codes apparaîtront ici en grid -->
                        </div>
                        
                        <!-- Barre de progression circulaire en overlay pendant la génération -->
                        <div id="qrLoadingOverlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.308); border-radius: 12px; display: flex; align-items: center; justify-content: center; opacity: 1; transition: opacity 0.3s;">
                            <div style="width: 80px; height: 80px; border: 4px solid var(--border-color); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        </div>
                    </div>

                    <!-- Statistiques en temps réel avec meilleur style -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0;">
                        <!-- Générés -->
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); padding: 16px; border-radius: 12px; transition: all 0.3s ease;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-color); opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
                                <i class="bi bi-check-circle"></i> Générés
                            </div>
                            <div style="font-size: 2rem; font-weight: 800; color: var(--success);" id="generatedCount">0</div>
                        </div>
                        
                        <!-- Restants -->
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); padding: 16px; border-radius: 12px; transition: all 0.3s ease;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-color); opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
                                <i class="bi bi-hourglass-split"></i> Restants
                            </div>
                            <div style="font-size: 2rem; font-weight: 800; color: var(--warning);" id="remainingCount">0</div>
                        </div>
                        
                        <!-- Temps estimé -->
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); padding: 16px; border-radius: 12px; transition: all 0.3s ease;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-color); opacity: 0.7; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
                                <i class="bi bi-clock"></i> Temps estimé
                            </div>
                            <div style="font-size: 2rem; font-weight: 800; color: var(--info);" id="estimatedTime">--</div>
                        </div>
                    </div>
                </div>

                <div class="creation-navigation" style="margin-top: 20px; justify-content: space-between;">
                    <button class="btn btn-secondary" id="qrBulkPrevBtn">
                        <i class="bi bi-arrow-left"></i>
                        Retour à la sélection
                    </button>
                    <button class="btn btn-primary" id="qrBulkContinueBtn" style="display: none;">
                        <i class="bi bi-arrow-right"></i>
                        Continuer
                    </button>
                </div>
            </div>

            <!-- ÉTAPE 3: TÉLÉCHARGEMENT -->
            <div class="creation-step-content" id="qrBulkStep3Content">
                <div class="creation-header">
                    <h2 class="creation-title"><i class="bi bi-check-circle"></i> Génération Terminée !</h2>
                    <p class="creation-subtitle" id="qrDownloadSummary">QR codes générés avec succès</p>
                </div>

                <div style="padding: 20px 0;">
                    <!-- Résumé de succès -->
                    <div style="background: rgba(16, 185, 129, 0.1); padding: 24px; border-radius: 12px; margin: 20px 0; border-left: 4px solid var(--success); text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 800; color: var(--success); margin-bottom: 10px;">
                            <span id="successCount">0</span>
                        </div>
                        <div style="font-size: 1rem; color: var(--text-color); font-weight: 600;">QR codes générés</div>
                        <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7; margin-top: 8px;">Archive ZIP prête au téléchargement</div>
                    </div>

                    <!-- Aperçu des QR codes générés en grid -->
                    <div style="margin: 25px 0; background: var(--hover-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color);">
                        <h3 style="font-size: 0.9rem; font-weight: 600; color: var(--text-color); margin: 0 0 15px 0;">
                            <i class="bi bi-image"></i> Aperçu des QR codes
                        </h3>
                        <div id="qrSummaryPreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; max-height: 500px; overflow-y: auto;">
                            <!-- Les QR codes apparaîtront ici -->
                        </div>
                    </div>

                    <!-- Infos supplémentaires -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0;">
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-color); opacity: 0.7; text-transform: uppercase; margin-bottom: 8px;">
                                <i class="bi bi-calendar"></i> Date
                            </div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--text-color);" id="generationDate">-</div>
                        </div>
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-color); opacity: 0.7; text-transform: uppercase; margin-bottom: 8px;">
                                <i class="bi bi-file-zip"></i> Taille
                            </div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--text-color);" id="totalSize">-</div>
                        </div>
                        <div style="background: var(--card-bg); border: 2px solid var(--border-color); padding: 16px; border-radius: 12px; text-align: center;">
                            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-color); opacity: 0.7; text-transform: uppercase; margin-bottom: 8px;">
                                <i class="bi bi-hourglass-end"></i> Durée
                            </div>
                            <div style="font-size: 1rem; font-weight: 600; color: var(--text-color);" id="generationTime">-</div>
                        </div>
                    </div>
                </div>

                <div class="creation-navigation">
                    <button class="btn btn-secondary" id="qrBulkCloseBtn">
                        <i class="bi bi-x-circle"></i>
                        Fermer
                    </button>
                    <button class="btn btn-primary" id="downloadQrZipBtn" >
                        <i class="bi bi-download"></i>
                        Télécharger l'Archive ZIP
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- MODAL D'AFFICHAGE DU QR CODE DE TABLE -->
<div class="table-creation-modal" id="tableQrModal" style="display: none;">
    <div class="table-creation-wrapper" style="max-width: 600px;">
        <button class="modal-close-btn" id="closeTableQrModalBtn" title="Fermer">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="creation-form-panel" style="padding: 40px; text-align: center;">
            <!-- En-tête -->
            <div class="creation-header" style="text-align: center;">
                <h2 class="creation-title" style="font-size: 1.5rem; margin-bottom: 10px;">QR Code de Table</h2>
                <p class="creation-subtitle" id="tableQrName" style="font-size: 1.1rem; margin-bottom: 20px;">Table 1</p>
            </div>

            <!-- QR Code affichage -->
            <div style="background: white; border-radius: 15px; padding: 30px; margin: 30px 0; box-shadow: 0 8px 24px rgba(0,0,0,0.15); display: inline-block; position: relative;">
                <div id="tableQrCodeContainer" style="width: 250px; height: 250px; display: flex; align-items: center; justify-content: center;">
                    <!-- QR code sera injecté ici -->
                    <i class="fas fa-qrcode" style="font-size: 80px; color: var(--primary); opacity: 0.3;"></i>
                </div>
                
              
            </div>

            <!-- Informations -->
            <div style="margin: 20px 0; text-align: center;">
                <p style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem; margin: 10px 0;">
                    <i class="fas fa-eye"></i> Scans: <span id="tableQrScanCount" style="font-weight: 600;">0</span>
                </p>
                <p style="color: var(--text-color); opacity: 0.7; font-size: 0.85rem; margin: 10px 0;">
                    <i class="fas fa-link"></i> 
                    <span id="tableQrLink" style="word-break: break-all; font-family: monospace; font-size: 0.8rem; background: var(--hover-bg); padding: 8px 12px; border-radius: 6px; display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis;">
                        Chargement...
                    </span>
                </p>
            </div>

            <!-- Actions -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-top: 30px;">
                <!-- Copier -->
                <button id="copyTableQrBtn" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; border-radius: 10px; background: var(--hover-bg); border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-copy" style="font-size: 1.3rem;"></i>
                    <span style="font-size: 0.75rem; font-weight: 500;">Copier</span>
                </button>

                <!-- Partager -->
                <button id="shareTableQrBtn" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; border-radius: 10px; background: var(--hover-bg); border: 1px solid var(--border-color); color: var(--text-color); cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-share-alt" style="font-size: 1.3rem;"></i>
                    <span style="font-size: 0.75rem; font-weight: 500;">Partager</span>
                </button>

                <!-- Télécharger -->
                <button id="downloadTableQrBtn" style="display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 12px; border-radius: 10px; background: var(--primary); border: none; color: white; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-download" style="font-size: 1.3rem;"></i>
                    <span style="font-size: 0.75rem; font-weight: 500;">Télécharger</span>
                </button>
            </div>

        </div>
    </div>
</div>
    <!-- CSS pour le modal QR -->
    <style>
    

        #tableQrModal.active {
            display: flex !important;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #copyTableQrBtn:hover, #shareTableQrBtn:hover {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
            transform: translateY(-2px);
        }

        #downloadTableQrBtn:hover {
            background: var(--primary-dark) !important;
            transform: translateY(-2px);
        }

    </style>


    <!-- Scripts -->
    <script src="js/audio-utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            SECURA_AUDIO.preload();
        });
    </script>
    
    <!-- Librairies -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="js/toastify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <!-- Scripts locaux -->
    <script src="js/auth-check.js"></script>
    <script defer src="js/particles-config.js"></script>
    <script defer src="js/theme.js"></script>
    <script defer src="js/main.js"></script>
    <script defer src="js/sidebar.js"></script>
    <script src="js/auth.js"></script>
    <script defer src="js/langue.js"></script>
    <script src="js/storage.js"></script>
    
    <script>
        // Variables globales
        let currentEvent = null;
        let currentUser = null;
        let allTables = [];
        let allGuests = [];
        let filteredTables = [];
        let currentView = 'grid';
        let currentFilter = 'all';
        let currentSearch = '';
        let currentPage = 1;
        const tablesPerPage = 12;
        let eventsViewMode = 'grid';
        let eventsList = [];
        
        // Variables pour la création
        let creationMode = 'single'; // 'single' ou 'multiple'
        let creationStep = 1;
        let multipleTablesData = [];
        let selectedGuests = [];
        let availableGuestsList = [];


        let currentShape = 'circle';
        let zoomLevel = 1;
        let isEditMode = false;
        let editingTableId = null;

        // ============================================
// 🎯 GESTION COMPLÈTE DES QR CODES
// ============================================

// Variables globales pour la génération
let selectedTablesForQR = [];
let generatedQRCodes = [];
let qrZipData = null;
let qrGenerationStartTime = null;

// Initialiser les écouteurs d'événements
document.addEventListener('DOMContentLoaded', function() {
    // Bouton d'ouverture du modal bulk QR
    const openBtn = document.getElementById('openQrBulkBtn');
    if (openBtn) {
        openBtn.addEventListener('click', showQrBulkModal);
    }

    // Bouton de fermeture du modal bulk QR
    const closeBtn = document.getElementById('closeQrBulkBtn');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeQrBulkModal);
    }

    // Fermeture via le bouton dans le modal
    const closeModalBtn = document.getElementById('closeQrBulkModalBtn');
    if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeQrBulkModal);
    }

    // Bouton de fermeture du modal individuel
    const closeSingleBtn = document.getElementById('closeTableQrModalBtn');
    if (closeSingleBtn) {
        closeSingleBtn.addEventListener('click', closeTableQRModal);
    }

    console.log('✅ Système QR codes initialisé');
});


// ============================================
// 🎯 GESTION DE LA NAVIGATION ENTRE ÉTAPES
// ============================================

function goToStep1() {
    console.log('📋 Retour à l\'étape 1');
    
    // Masquer toutes les étapes
    hideAllSteps();
    
    // Afficher l'étape 1
    document.getElementById('qrBulkStep1Content').classList.add('active');
    
    // Mettre à jour les indicateurs
    updateStepIndicators(1);
    
    // Réactiver le bouton générer
    const generateBtn = document.getElementById('qrBulkGenerateBtn');
    if (generateBtn) {
        generateBtn.disabled = false;
        generateBtn.textContent = '🪄 Générer les QR Codes';
        generateBtn.onclick = () => generateQRCodesInBulk();
    }
    
    // Masquer le bouton précédent à l'étape 1
    const prevBtn = document.getElementById('qrBulkPrevBtn');
    if (prevBtn) {
        prevBtn.classList.remove('active');
    }
}

function goToStep2() {
    console.log('🚀 Passage à l\'étape 2 - Génération');
    
    // Masquer toutes les étapes
    hideAllSteps();
    
    // Afficher l'étape 2
    const step2Content = document.getElementById('qrBulkStep2Content');
    step2Content.classList.add('active');
    
    // Mettre à jour la barre de progression latérale
    updateProgressPanel(2);
    
    // Mettre à jour les indicateurs
    updateStepIndicators(2);
    
    // Désactiver le bouton générer
    document.getElementById('qrBulkGenerateBtn').disabled = true;
    
    // Montrer le loader
    const loadingOverlay = document.getElementById('qrLoadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'flex';
        loadingOverlay.style.opacity = '1';
    }
    
    // Afficher le bouton précédent
    const prevBtn = document.getElementById('qrBulkPrevBtn');
    if (prevBtn) {
        prevBtn.classList.add('active');
        prevBtn.textContent = '↩️ Retour';
        prevBtn.onclick = () => goToStep1();
    }
}

// Améliorer la fonction goToStep3 pour de meilleures statistiques
function goToStep3() {
    console.log('📊 Passage à l\'étape 3 - Téléchargement');
    
    // Masquer toutes les étapes
    hideAllSteps();
    
    // Afficher l'étape 3
    const step3Content = document.getElementById('qrBulkStep3Content');
    step3Content.classList.add('active');
    
    // Mettre à jour la barre de progression latérale
    updateProgressPanel(3);
    
    // Mettre à jour les indicateurs
    updateStepIndicators(3);
    
    // Cacher le bouton précédent
    const prevBtn = document.getElementById('qrBulkPrevBtn');
    if (prevBtn) {
        prevBtn.classList.remove('active');
    }
    
    // Calculer les statistiques
    const totalSize = Math.round(generatedQRCodes.length * 35); // Estimation en KB
    const generationTime = Math.round((Date.now() - qrGenerationStartTime) / 1000);
    
    // Mettre à jour les informations principales
    document.getElementById('successCount').textContent = generatedQRCodes.length;
    document.getElementById('qrDownloadSummary').textContent = 
        `${generatedQRCodes.length} QR code(s) généré(s) avec succès`;
    
    // Créer l'aperçu des QR codes en grille
    const previewContainer = document.getElementById('qrSummaryPreviewContainer');
    if (previewContainer) {
        previewContainer.innerHTML = generatedQRCodes.map((qr) => `
            <div style="background: white; border-radius: 12px; padding: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.12); border: 2px solid rgba(217, 119, 6, 0.25); display: flex; align-items: center; justify-content: center; width: 240px; height: 240px;">
                <img src="${qr.dataUrl}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;">
            </div>
        `).join('');
    }
    
    // Mettre à jour les métadonnées
    document.getElementById('generationDate').textContent = 
        new Date().toLocaleDateString('fr-FR');
    document.getElementById('totalSize').textContent = `${totalSize} KB`;
    document.getElementById('generationTime').textContent = `${generationTime}s`;
    
    // Configurer le bouton de téléchargement
    const downloadBtn = document.getElementById('downloadQrZipBtn');
    if (downloadBtn) {
        downloadBtn.onclick = downloadQRZipArchive;
    }
    
    
    // Configurer le bouton de fermeture
    const closeBtn = document.getElementById('qrBulkCloseBtn');
    if (closeBtn) {
        closeBtn.onclick = closeQrBulkModal;
    }

    if (downloadBtn) {
        downloadBtn.innerHTML = `
            <i class="fas fa-file-archive"></i>
            <span>Télécharger l'Archive (${generatedQRCodes.length} fichiers)</span>
        `;
        downloadBtn.onclick = downloadQRZipArchive;
    }
}




function hideAllSteps() {
    const steps = [
        'qrBulkStep1Content',
        'qrBulkStep2Content',
        'qrBulkStep3Content'
    ];
    
    steps.forEach(stepId => {
        const step = document.getElementById(stepId);
        if (step) {
            step.classList.remove('active');
            // Ne pas appliquer d'opacité inline - la classe .active gère tout
        }
    });
}

function updateStepIndicators(activeStep) {
    // Réinitialiser tous les indicateurs
    const indicators = [
        'qrBulkStep1Indicator',
        'qrBulkStep2Indicator',
        'qrBulkStep3Indicator'
    ];
    
    indicators.forEach(indicatorId => {
        const indicator = document.getElementById(indicatorId);
        if (indicator) {
            indicator.classList.remove('active', 'completed');
        }
    });
    
    // Marquer les étapes précédentes comme complétées
    for (let i = 1; i < activeStep; i++) {
        const indicator = document.getElementById(`qrBulkStep${i}Indicator`);
        if (indicator) {
            indicator.classList.add('completed');
        }
    }
    
    // Marquer l'étape active
    const activeIndicator = document.getElementById(`qrBulkStep${activeStep}Indicator`);
    if (activeIndicator) {
        activeIndicator.classList.add('active');
    }
}

function updateProgressPanel(step) {
    // Mettre à jour la barre de progression latérale
    const progressBar = document.getElementById('qrBulkProgressBar');
    const progressText = document.getElementById('qrBulkProgressText');
    
    if (progressBar) {
        progressBar.style.width = `${step * 33}%`;
    }
    if (progressText) {
        progressText.textContent = `Étape ${step}/3`;
    }
}


// Modifier la fonction showQrBulkModal pour utiliser la nouvelle gestion des étapes
function showQrBulkModal() {
    console.log('📱 Ouverture du modal bulk QR');
    
    selectedTablesForQR = [];
    generatedQRCodes = [];
    qrZipData = null;
    
    const modal = document.getElementById('qrBulkGenerationModal');
    if (modal) {
        modal.classList.add('active');
        
        // Réinitialiser l'interface
        resetQrBulkInterface();
        
        // Remplir la liste des tables
        populateTablesChecklistForQR();
        updateQRTablesSelection();
        
        // Aller à l'étape 1
        goToStep1();
    }
}


// Modifier la fonction resetQrBulkInterface
function resetQrBulkInterface() {
    // Réinitialiser les compteurs (vérifier qu'ils existent)
    const generatedCountEl = document.getElementById('generatedCount');
    if (generatedCountEl) generatedCountEl.textContent = '0';
    
    const remainingCountEl = document.getElementById('remainingCount');
    if (remainingCountEl) remainingCountEl.textContent = '0';
    
    const estimatedTimeEl = document.getElementById('estimatedTime');
    if (estimatedTimeEl) estimatedTimeEl.textContent = '--';
    
    // Vider le conteneur de prévisualisation
    const previewContainer = document.getElementById('qrPreviewContainer');
    if (previewContainer) {
        previewContainer.innerHTML = `
            <div style="grid-column: 1/-1; text-align: center; padding: 30px;">
                <i class="fas fa-qrcode" style="font-size: 50px; color: var(--primary); opacity: 0.3; margin-bottom: 10px; display: block;"></i>
                <p style="color: var(--text-color); opacity: 0.6; font-size: 0.9rem; margin: 0;">
                    Les QR codes apparaîtront ici...
                </p>
            </div>
        `;
        previewContainer.style.display = 'grid';
        previewContainer.style.gridTemplateColumns = 'repeat(auto-fi, minmax(180px, 3fr))';
        previewContainer.style.gap = '10px';
    }
    
    // Masquer le loader
    const loadingOverlay = document.getElementById('qrLoadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
        loadingOverlay.style.opacity = '0';
    }
}

// Fonction utilitaire pour échapper les HTML
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function closeQrBulkModal() {
    console.log('✗ Fermeture du modal bulk QR');
    
    const modal = document.getElementById('qrBulkGenerationModal');
    if (modal) {
        modal.classList.remove('active');
    }
    
    // Nettoyer les données
    selectedTablesForQR = [];
    generatedQRCodes = [];
    qrZipData = null;
}


// ============================================
// 🎯 SÉLECTION DES TABLES
// ============================================

function populateTablesChecklistForQR() {
    const container = document.getElementById('qrTablesChecklistContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    allTables.forEach(table => {
        const totalSeats = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) || 0;
        const capacity = table.capacity || 0;
        const occupancyRate = capacity > 0 ? Math.round((totalSeats / capacity) * 100) : 0;
        const isFull = totalSeats >= capacity;
        const isEmpty = totalSeats === 0;
        
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.style.transition = 'background 0.2s';
        row.setAttribute('data-table-id', table.id);
        row.className = 'qr-table-row';
        
        row.innerHTML = `
            <td style="text-align: center; width: 50px; padding: 12px 8px;">
                <input type="checkbox" class="qr-table-checkbox" value="${table.id}" 
                       style="cursor: pointer; width: 18px; height: 18px;">
            </td>
            <td style="width: 100px; padding: 12px 8px; font-weight: 600; color: var(--primary);">
                ${escapeHtml(table.tableNumber)}
            </td>
            <td style="width: 150px; padding: 12px 8px;">${escapeHtml(table.tableName || 'Sans nom')}</td>
            <td style="width: 100px; padding: 12px 8px; text-align: center;">
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <div style="font-weight: 600;">${capacity}</div>
                    <div style="font-size: 0.75rem; color: var(--text-color); opacity: 0.7;">
                        ${totalSeats} occupé(s)
                    </div>
                </div>
            </td>
            <td style="width: 120px; padding: 12px 8px;">
                <span style="padding: 4px 12px; background: ${getCategoryColor(table.category || 'standard')}20; 
                      color: ${getCategoryColor(table.category || 'standard')}; 
                      border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                    ${escapeHtml(getCategoryLabel(table.category || 'standard'))}
                </span>
            </td>
            <td style="width: 100px; padding: 12px 8px; font-size: 0.8rem; color: var(--text-color); opacity: 0.8;">
                ${escapeHtml(table.location || '-')}
            </td>
        `;
        
        const rowCheckbox = row.querySelector('.qr-table-checkbox');
        
        // Click sur la ligne pour cocher/décocher
        row.addEventListener('click', (e) => {
            if (e.target !== rowCheckbox && !e.target.closest('button')) {
                rowCheckbox.checked = !rowCheckbox.checked;
                updateRowStyle(row, rowCheckbox.checked);
                updateQRTablesSelection();
            }
        });
        
        // Click sur le checkbox
        rowCheckbox.addEventListener('change', (e) => {
            e.stopPropagation();
            updateRowStyle(row, rowCheckbox.checked);
            updateQRTablesSelection();
        });
        
        // Hover effect
        row.addEventListener('mouseenter', () => {
            if (!rowCheckbox.checked) {
                row.style.background = 'rgba(217, 119, 6, 0.05)';
            }
        });
        
        row.addEventListener('mouseleave', () => {
            if (!rowCheckbox.checked) {
                row.style.background = 'transparent';
            }
        });
        
        container.appendChild(row);
    });

    // Configurer les boutons Sélectionner/Désélectionner
    const selectAllBtn = document.getElementById('selectAllTablesBtn');
    const deselectAllBtn = document.getElementById('deselectAllTablesBtn');
    const masterCheckbox = document.getElementById('masterCheckbox');
    
    if (selectAllBtn) {
        selectAllBtn.onclick = () => {
            document.querySelectorAll('#qrTablesChecklistContainer .qr-table-checkbox').forEach(cb => {
                cb.checked = true;
                updateRowStyle(cb.closest('tr'), true);
            });
            if (masterCheckbox) masterCheckbox.checked = true;
            updateQRTablesSelection();
        };
    }

    if (deselectAllBtn) {
        deselectAllBtn.onclick = () => {
            document.querySelectorAll('#qrTablesChecklistContainer .qr-table-checkbox').forEach(cb => {
                cb.checked = false;
                updateRowStyle(cb.closest('tr'), false);
            });
            if (masterCheckbox) masterCheckbox.checked = false;
            updateQRTablesSelection();
        };
    }
    
    if (masterCheckbox) {
        masterCheckbox.onchange = (e) => {
            const isChecked = e.target.checked;
            document.querySelectorAll('#qrTablesChecklistContainer .qr-table-checkbox').forEach(cb => {
                cb.checked = isChecked;
                updateRowStyle(cb.closest('tr'), isChecked);
            });
            updateQRTablesSelection();
        };
    }
}

function updateRowStyle(row, isChecked) {
    if (isChecked) {
        row.style.background = 'rgba(217, 119, 6, 0.1)';
        row.style.borderLeft = '3px solid var(--primary)';
    } else {
        row.style.background = 'transparent';
        row.style.borderLeft = 'none';
    }
}

function updateQRTablesSelection() {
    selectedTablesForQR = Array.from(
        document.querySelectorAll('#qrTablesChecklistContainer .qr-table-checkbox:checked')
    ).map(cb => cb.value);
    
    // Mettre à jour le compteur
    const countEl = document.getElementById('qrSelectedTablesCount');
    if (countEl) {
        countEl.textContent = selectedTablesForQR.length;
    }
    
    // Mettre à jour la checkbox maître
    const totalCheckboxes = document.querySelectorAll('#qrTablesChecklistContainer .qr-table-checkbox').length;
    const checkedCount = selectedTablesForQR.length;
    const masterCheckbox = document.getElementById('masterCheckbox');
    
    if (masterCheckbox) {
        if (checkedCount === 0) {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = false;
        } else if (checkedCount === totalCheckboxes) {
            masterCheckbox.checked = true;
            masterCheckbox.indeterminate = false;
        } else {
            masterCheckbox.checked = false;
            masterCheckbox.indeterminate = true;
        }
    }
    
    return selectedTablesForQR.length;
}


// Modifier la fonction generateQRCodesInBulk
async function generateQRCodesInBulk() {
    console.log('🚀 Lancement de la génération bulk QR améliorée');
    
    // Compter les tables sélectionnées
    const selectedTableIds = Array.from(
        document.querySelectorAll('#qrTablesChecklistContainer .qr-table-checkbox:checked')
    ).map(cb => cb.value);
    
    const selectedCount = selectedTableIds.length;
    selectedTablesForQR = selectedTableIds;
    
    if (selectedCount === 0) {
        Swal.fire({
            icon: 'warning',
            title: 'Aucune table sélectionnée',
            text: 'Veuillez sélectionner au moins une table pour générer les QR codes.',
            confirmButtonColor: '#D97706'
        });
        return;
    }

    // Passer à l'étape 2 avec mise à jour de la progression
    goToStep2();
    
    try {
        // Réinitialiser les données
        generatedQRCodes = [];
        qrGenerationStartTime = Date.now();
        
        // Filtrer les tables à traiter
        const tablesToProcess = allTables.filter(t => selectedTablesForQR.includes(t.id));
        const totalTables = tablesToProcess.length;
        
        // Préparer l'interface de progression
        setupProgressInterface(totalTables);
        
        // Afficher le loader
        const loadingOverlay = document.getElementById('qrLoadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
        
        // Générer chaque QR code
        for (let i = 0; i < tablesToProcess.length; i++) {
            const table = tablesToProcess[i];
            
            // Mettre à jour l'interface de progression
            updateProgressDisplay(i + 1, totalTables, table);
            
            // Générer le QR code
            const qrData = await generateSingleQRCode(table);
            
            if (qrData) {
                generatedQRCodes.push(qrData);
                
                // Afficher la prévisualisation avec animation
                displayQRPreviewEnhanced(qrData, i);
                
                // Petit délai pour l'animation
                await new Promise(resolve => setTimeout(resolve, 100));
            }
        }
        
        if (loadingOverlay) {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => {
                loadingOverlay.style.display = 'none';
            }, 300);
        }
       
        // Finaliser la génération
        await finalizeGeneration();
        
    } catch (error) {
        console.error('❌ Erreur lors de la génération:', error);
        showGenerationError(error);
    }
}


// Nouvelle fonction pour configurer l'interface de progression
function setupProgressInterface(totalTables) {
    const previewContainer = document.getElementById('qrPreviewContainer');
    if (previewContainer) {
        previewContainer.innerHTML = ``;
    }
    
    // Mettre à jour les compteurs initiaux
    document.getElementById('remainingCount').textContent = totalTables;
    document.getElementById('generatedCount').textContent = '0';
    document.getElementById('estimatedTime').textContent = 'Calcul...';
}

// Nouvelle fonction pour mettre à jour l'affichage de progression
function updateProgressDisplay(current, total, table) {
    // Mettre à jour les compteurs
    document.getElementById('generatedCount').textContent = current;
    document.getElementById('remainingCount').textContent = total - current;
    
    // Mettre à jour le nom de la table en cours
    const subtitle = document.getElementById('generationSubtitle');
    if (subtitle) {
        subtitle.textContent = `Génération de la table "${table.tableName || table.tableNumber}" (${current}/${total})`;
    }
    
    // Calculer et afficher le temps estimé
    if (qrGenerationStartTime && current > 0) {
        const elapsedTime = (Date.now() - qrGenerationStartTime) / 1000;
        const timePerTable = elapsedTime / current;
        const remainingTime = Math.round((total - current) * timePerTable);
        
        const estimatedTimeEl = document.getElementById('estimatedTime');
        if (estimatedTimeEl) {
            estimatedTimeEl.textContent = `${remainingTime}s`;
        }
    }
}



// Nouvelle fonction améliorée pour afficher la prévisualisation
function displayQRPreviewEnhanced(qrData, index) {
    const previewGrid = document.getElementById('qrPreviewContainer');
    if (!previewGrid) return;
    
    // Créer une div conteneur pour la case de grille
    const gridCell = document.createElement('div');
    gridCell.style.cssText = `
        width: 100%;
        height: 200px;
        background: var(--input-bg);
        border-radius: 8px;
        padding: 2px;
    `;
    
    // Créer une image du QR code qui occupe tout l'espace
    const qrImg = document.createElement('img');
    qrImg.src = qrData.dataUrl;
    qrImg.alt = `QR Code - ${qrData.tableName}`;
    qrImg.style.cssText = `
        width: 100%;
        height: 100%;
        object-fit: contain;
        transform: scale(0.8);
        opacity: 0;
        transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        cursor: pointer;
    `;
    
    gridCell.appendChild(qrImg);
    previewGrid.appendChild(gridCell);
    
    // Animation d'apparition
    setTimeout(() => {
        qrImg.style.opacity = '1';
        qrImg.style.transform = 'scale(1)';
    }, index * 50);
    
    
}

// Nouvelle fonction pour finaliser la génération
async function finalizeGeneration() {
    // Mettre à jour l'interface de fin
    const subtitle = document.getElementById('generationSubtitle');
    if (subtitle) {
        subtitle.textContent = `✅ ${generatedQRCodes.length} QR code(s) généré(s) avec succès`;
    }
    
    // Créer l'archive ZIP
    await createQRZipArchive();
    
    // Afficher le bouton de continuation
    const continueBtn = document.getElementById('qrBulkContinueBtn');
    if (continueBtn) {
        continueBtn.style.display = 'inline-block';
        continueBtn.innerHTML = '<i class="fas fa-check-circle"></i> Confirmer et Télécharger';
        continueBtn.onclick = () => goToStep3();
    }
    
    // Mettre à jour le bouton précédent
    const prevBtn = document.getElementById('qrBulkPrevBtn');
    if (prevBtn) {
        prevBtn.innerHTML = '<i class="fas fa-redo"></i> Recommencer';
    }
    
    // Jouer le son de succès
    if (typeof SECURA_AUDIO !== 'undefined') {
        SECURA_AUDIO.play('success');
    }
}

// Fonction pour afficher les erreurs
function showGenerationError(error) {
    const previewContainer = document.getElementById('qrPreviewContainer');
    if (previewContainer) {
        previewContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="fas fa-exclamation-triangle" 
                   style="font-size: 60px; color: var(--danger); margin-bottom: 20px;">
                </i>
                <p style="color: var(--danger); font-weight: 600;">Erreur lors de la génération</p>
                <p style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem;">
                    ${error.message || 'Une erreur est survenue'}
                </p>
                <button class="btn btn-secondary" onclick="goToStep1()" 
                        style="margin-top: 20px;">
                    <i class="fas fa-arrow-left"></i> Retour
                </button>
            </div>
        `;
    }
}


// Modifier la fonction generateSingleQRCode pour créer un QR avec le style demandé
async function generateSingleQRCode(table) {
    try {

        const accessLink = `${storage.FRONTEND_URL}/access?eventId=${currentEvent.id}&tableId=${table.id}`;
     
        // Créer un conteneur temporaire pour le QR code
        const tempContainer = document.createElement('div');
        tempContainer.style.cssText = `
            position: fixed;
            left: -9999px;
            top: -9999px;
            background: white;
            border-radius: 15px;
            padding: 15px;
            width: 350px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border: 2px solid #333333;
        `;
        
        document.body.appendChild(tempContainer);
        
        // Créer le conteneur du QR code
        const qrContainer = document.createElement('div');
        qrContainer.style.cssText = `
            width: 320px;
            height: 320px;
            display: flex;
            align-items: center;
            justify-content: center;
        `;
        tempContainer.appendChild(qrContainer);
        
        // Options du QR code - identiques à generateTableQR
        const options = {
            text: accessLink,
            width: 320,
            height: 320,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H,
            dotScale: 0.8,
            PO: '#000000',
            PI: '#000000',
            AO: '#ffffff',
            AI: '#ffffff',
            logo: 'assets/images/logo.png',
            logoWidth: 70,
            logoHeight: 70,
            logoBackgroundColor: '#ffffff',
            logoBackgroundTransparent: false,
            quietZone: 10,
            quietZoneColor: '#ffffff',
            drawer: 'canvas'
        };

        
        // Générer le QR code
        new QRCode(qrContainer, options);
        
        // Attendre que le QR code soit généré
        return await new Promise(resolve => {
            setTimeout(() => {
                try {
                    const canvas = tempContainer.querySelector('canvas');
                    if (canvas) {
                        // Créer un canvas final avec le footer
                        const finalCanvas = document.createElement('canvas');
                        finalCanvas.width = 350;
                        finalCanvas.height = 380;
                        const ctx = finalCanvas.getContext('2d');
                        
                        // Fond blanc
                        ctx.fillStyle = '#ffffff';
                        ctx.fillRect(0, 0, 350, 380);
                        
                        // Bordure
                        ctx.strokeStyle = '#333333';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(0, 0, 350, 380);
                        
                        // Dessiner le QR code au centre
                        ctx.drawImage(canvas, 15, 15, 320, 320);
                        
                        ctx.fillStyle = '#666666';
                        ctx.font = 'italic 12px Arial, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText('GeekHub ❖ Secura QR', 175, 360);
                        
                        const dataUrl = finalCanvas.toDataURL('image/png');
                        
                        // Nettoyer
                        document.body.removeChild(tempContainer);
                        
                        resolve({
                            tableId: table.id,
                            tableNumber: table.tableNumber,
                            tableName: table.tableName || 'Sans nom',
                            fileName: `QR_${table.tableName || 'Table'}_${table.tableNumber}`.replace(/[^a-z0-9]/gi, '_'),
                            dataUrl: dataUrl,
                            accessLink: accessLink,
                            canvas: finalCanvas
                        });
                    } else {
                        document.body.removeChild(tempContainer);
                        resolve(null);
                    }
                } catch (err) {
                    console.error('Erreur lors de la génération du QR code:', err);
                    if (tempContainer.parentNode) {
                        document.body.removeChild(tempContainer);
                    }
                    resolve(null);
                }
            }, 1000);
        });
        
    } catch (error) {
        console.error('Erreur génération QR pour table', table.id, error);
        return null;
    }
}


function updateGenerationProgress(current, total, percentage) {
    // Mettre à jour les compteurs de l'étape 2
    const generatedCountEl = document.getElementById('generatedCount');
    const remainingCountEl = document.getElementById('remainingCount');
    
    if (generatedCountEl) {
        generatedCountEl.textContent = current;
    }
    
    if (remainingCountEl) {
        remainingCountEl.textContent = total - current;
    }
    
    // Calculer et afficher le temps estimé restant
    if (qrGenerationStartTime && current > 0) {
        const elapsedTime = (Date.now() - qrGenerationStartTime) / 1000; // en secondes
        const timePerTable = elapsedTime / current;
        const remainingTime = Math.round((total - current) * timePerTable);
        
        const estimatedTimeEl = document.getElementById('estimatedTime');
        if (estimatedTimeEl) {
            if (remainingTime < 60) {
                estimatedTimeEl.textContent = `${remainingTime}s`;
            } else {
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                estimatedTimeEl.textContent = `${minutes}m ${seconds}s`;
            }
        }
    }
}

function displayQRPreview(qrData, index) {
    const previewContainer = document.getElementById('qrPreviewContainer');
    const loadingOverlay = document.getElementById('qrLoadingOverlay');
    
    if (!previewContainer) return;
    
    // Masquer le loader une fois le premier QR arrive
    if (index === 1 && loadingOverlay) {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 300);
    }
    
    // Créer la carte du QR code avec wrapper blanc et label
    const qrCard = document.createElement('div');
    qrCard.style.cssText = `
        position: relative;
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        text-align: center;
        width: 240px;
        border: 2px solid rgba(217, 119, 6, 0.25);
        overflow: hidden;
        transition: all 0.3s ease;
    `;
    
    qrCard.innerHTML = `
        <div style="width: 208px; height: 208px; margin: 0 auto; border-radius: 10px; overflow: hidden; background: white; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(217, 119, 6, 0.1);">
            <img src="${qrData.dataUrl}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;">
        </div>
        <div style="font-size: 0.7rem; color: var(--text-color); opacity: 0.5; margin-top: 12px; font-weight: 500; letter-spacing: 1px;">
            GeekHub
        </div>
    `;
    
    // Animation d'apparition
    qrCard.style.opacity = '0';
    qrCard.style.transform = 'scale(0.85)';
    previewContainer.appendChild(qrCard);
    
    setTimeout(() => {
        qrCard.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
        qrCard.style.opacity = '1';
        qrCard.style.transform = 'scale(1)';
    }, 10);
    
    // Ajouter effet hover
    qrCard.addEventListener('mouseenter', () => {
        qrCard.style.boxShadow = '0 12px 32px rgba(217, 119, 6, 0.25)';
        qrCard.style.transform = 'translateY(-6px)';
    });
    
    qrCard.addEventListener('mouseleave', () => {
        qrCard.style.boxShadow = '0 8px 24px rgba(0,0,0,0.15)';
        qrCard.style.transform = 'translateY(0)';
    });
}

// ============================================
// 🎯 CRÉATION DE L'ARCHIVE ZIP
// ============================================

async function createQRZipArchive() {
    
    try {
        const zip = new JSZip();
        const eventName = currentEvent.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const timestamp = new Date().getTime();
        const qrFolder = zip.folder(`qr_codes_${eventName}_${timestamp}`);
        
        // Ajouter chaque QR code à l'archive
        for (let i = 0; i < generatedQRCodes.length; i++) {
            const qrData = generatedQRCodes[i];
            const filename = `${qrData.fileName}.png`;
            
            // Convertir dataUrl en base64
            const base64Data = qrData.dataUrl.split(',')[1];
            qrFolder.file(filename, base64Data, { base64: true });
            
            // Mettre à jour la progression (optionnel)
            const progress = Math.round(((i + 1) / generatedQRCodes.length) * 100);
            // Pas de mise à jour de progression pour l'archive (trop rapide)
        }
        
        // Sauvegarder l'archive
        qrZipData = zip;
        
        console.log(`✅ Archive créée avec ${generatedQRCodes.length} fichiers QR`);
        return true;
        
    } catch (error) {
        console.error('❌ Erreur création ZIP:', error);
        throw error;
    }
}

/**
 * Générer le document HTML professionnel complet
 */
async function generateProfessionalDocumentHTML(guestsData) {
    const tables = allTables && Array.isArray(allTables) ? allTables : [];
    const currentDate = new Date();
    const allGuests = guestsData && Array.isArray(guestsData) && guestsData.length > 0 
        ? guestsData 
        : (currentEvent ? storage.getGuestsByEventId(currentEvent.id) : []);
    
    console.log(`📊 Génération document: ${tables.length} table(s), ${allGuests.length} invité(s)`);
    
    // Organiser les invités par table
    const guestsByTable = {};
    allGuests.forEach(guest => {
        if (guest.tableId) {
            if (!guestsByTable[guest.tableId]) {
                guestsByTable[guest.tableId] = [];
            }
            guestsByTable[guest.tableId].push(guest);
        }
    });
    
    // Récupérer les couleurs de l'événement
    const primaryColor = '#D97706';
    const secondaryColor = '#1f2937';
    
    const tablesWithQR = await Promise.all(tables.map(async (table) => {
        try {
            const accessLink = `${storage.FRONTEND_URL || window.location.origin}/access?eventId=${currentEvent.id}&tableId=${table.id}`;
            
            const tempContainer = document.createElement('div');
            tempContainer.style.cssText = `
                position: fixed;
                left: -9999px;
                top: -9999px;
                background: white;
                border-radius: 15px;
                padding: 1px;
                width: 355px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(tempContainer);
            
            const qrContainer = document.createElement('div');
            qrContainer.style.cssText = `
                width: 350px;
                height: 350px;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            tempContainer.appendChild(qrContainer);
            
            // Options du QR code
            const options = {
                text: accessLink,
                width: 320,
                height: 320,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H,
                dotScale: 0.8,
                PO: '#000000',
                PI: '#000000',
                AO: '#ffffff',
                AI: '#ffffff',
                logo: 'assets/images/icon.png',
                logoWidth: 70,
                logoHeight: 70,
                logoBackgroundColor: '#ffffff',
                logoBackgroundTransparent: false,
                quietZone: 10,
                quietZoneColor: '#ffffff',
                drawer: 'canvas'
            };
            
            new QRCode(qrContainer, options);
            
            return await new Promise(resolve => {
                setTimeout(() => {
                    try {
                        const canvas = tempContainer.querySelector('canvas');
                        if (canvas) {
                            const finalCanvas = document.createElement('canvas');
                            finalCanvas.width = 350;
                            finalCanvas.height = 380;
                            const ctx = finalCanvas.getContext('2d');
                            
                            ctx.fillStyle = '#ffffff';
                            ctx.fillRect(0, 0, 350, 380);
                            
                            ctx.strokeStyle = '#333333';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(0, 0, 350, 380);
                            
                            ctx.drawImage(canvas, 15, 15, 320, 320);
                            
                            ctx.fillStyle = '#666666';
                            ctx.font = 'italic 12px Arial, sans-serif';
                            ctx.textAlign = 'center';
                            ctx.fillText('GeekHub ❖ Secura QR', 175, 360);
                            
                            const dataUrl = finalCanvas.toDataURL('image/png');
                            
                            document.body.removeChild(tempContainer);
                            
                            resolve({
                                ...table,
                                dataUrl: dataUrl,
                                accessLink: accessLink
                            });
                        } else {
                            document.body.removeChild(tempContainer);
                            resolve(table);
                        }
                    } catch (err) {
                        console.error('Erreur génération QR:', err);
                        if (tempContainer.parentNode) {
                            document.body.removeChild(tempContainer);
                        }
                        resolve(table);
                    }
                }, 500);
            });
        } catch (error) {
            console.error('Erreur génération QR pour table:', error);
            return table;
        }
    }));
    
    // Préparer les données pour l'affichage tabulaire
    const tableData = tablesWithQR.map((table, index) => {
        const guests = guestsByTable[table.id] || [];
        const tableGuests = guests.map((guest, guestIndex) => {
            const firstName = guest.firstName || '';
            const lastName = guest.lastName || guest.name || '';
            const fullName = `${firstName} ${lastName}`.trim() || 'Invité';
            const initials = `${(firstName || '?')[0]}${(lastName || '')[0]}`.toUpperCase();
            const avatarUrl = getGuestAvatarImage(guest);
            const color = stringToColor(fullName);
            
            return {
                ...guest,
                fullName,
                initials,
                avatarColor: color,
                avatarUrl,
                contact: guest.email && guest.email !== '-' ? guest.email : 
                        guest.phone && guest.phone !== '-' ? guest.phone : '',
                company: guest.company && guest.company !== '-' ? guest.company : '',
                vipBadge: guest.type === 'vip' || guest.isVIP ? 'VIP' : '',
                seatNumber: guest.seats || 1
            };
        });
        
        return {
            ...table,
            guests: tableGuests,
            guestCount: tableGuests.length,
            tableNumberDisplay: table.tableNumber || index + 1,
            capacityText: table.capacity ? `${tableGuests.length}/${table.capacity}` : tableGuests.length.toString()
        };
    });
    
    // Statistiques
    const totalAssignedGuests = allGuests.filter(g => g.tableId).length;
    const tablesWithGuests = tables.filter(t => guestsByTable[t.id]?.length > 0).length;
    
    return `
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Table Officiel - ${escapeHtml(currentEvent.name)}</title>
    
    <!-- Fonts élégantes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Variables CSS */
        :root {
            --primary: ${primaryColor};
            --primary-dark: #B45309;
            --primary-light: #F59E0B;
            --secondary: '#1f2937;
            --accent: #8B5CF6;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;
            
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-light: #9CA3AF;
            
            --bg-white: #FFFFFF;
            --bg-light: #F9FAFB;
            --bg-card: #FFFFFF;
            --border: #E5E7EB;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 60px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            
            --radius: 0.5rem;
            --radius-sm: 0.3rem;
            --radius-lg: 0.60rem;
            --radius-xl: 0.35rem;
        }
        
        /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            font-size: 16px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 40px;
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,0 L100,100 M100,0 L0,100" stroke="%23f1f5f9" stroke-width="0.5"/></svg>');
            opacity: 0.3;
            z-index: -1;
        }
        
        /* Typographie élégante */
        h1, h2, h3, h4, h5, .title-font {
            font-family: 'Playfair Display', Georgia, serif;
            font-weight: 600;
            line-height: 1.2;
        }
        
        /* Layout principal */
        .document-container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            position: relative;
        }
        
        /* Bandeau supérieur */
        .document-header {
            color: white;
            padding: 40px 50px;
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        .document-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 1;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            position: relative;
            z-index: 1;
        }
        
        /* Logo et nom de l'app */
        .app-brand {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .app-logo {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .app-logo img {
            width: 70px;
            height: 70px;
            object-fit: contain;
        }
        
        .app-info h1 {
            font-size: 2.8rem;
            color: white;
            margin-bottom: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .app-info .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        /* Logo de l'événement */
        .event-logo-section {
            text-align: right;
        }
        
        .event-logo-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 3px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            margin: 0 auto 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        
        .event-logo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .event-name {
            font-size: 1.3rem;
            font-weight: 600;
            color: white;
        }
        
        /* Info événement */
        .event-info-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 30px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            z-index: 1;
        }
        
        .event-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-item .icon {
            font-size: 1.5rem;
            color: white;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .info-item .label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .info-item .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }
        
        /* Contenu principal */
        .document-content {
            padding: 50px;
        }
        
        /* Section statistiques */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            padding: 25px;
            text-align: center;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 1.5rem;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-family: 'Playfair Display', serif;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        /* Section tables */
        .tables-section-title {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .tables-section-title h2 {
            font-size: 2.2rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }
        
        .tables-section-title h2::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 2px;
        }
        
        .tables-section-title p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 20px auto 0;
        }
        
        /* Grille des tables */
        .tables-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 50px;
        }
        
        @media (max-width: 768px) {
            .tables-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Carte de table */
        .table-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .table-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }
        
        /* En-tête de table */
        .table-header {
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
            color: white;
            padding: 25px 30px;
            position: relative;
        }
        
        .table-header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .table-info h3 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .table-number {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .table-meta {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .table-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* QR Code */
        .table-qr {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: var(--radius-sm);
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .table-qr img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        /* Corps de la table */
        .table-body {
            padding: 30px;
        }
        
        /* En-tête des invités */
        .guests-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }
        
        .guests-header h4 {
            font-size: 1.2rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .guest-count {
            background: var(--primary);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        /* Tableau des invités */
        .guests-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .guests-table th {
            background: var(--bg-light);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 12px 15px;
            border-bottom: 2px solid var(--border);
            text-align: left;
        }
        
        .guests-table th:first-child {
            border-top-left-radius: var(--radius-sm);
        }
        
        .guests-table th:last-child {
            border-top-right-radius: var(--radius-sm);
        }
        
        .guests-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }
        
        .guests-table tr:last-child td {
            border-bottom: none;
        }
        
        .guests-table tr:hover td {
            background: var(--bg-light);
        }
        
        /* Colonne avatar */
        .guest-avatar-cell {
            width: 50px;
        }
        
        .guest-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .guest-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .guest-avatar-initials {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: white;
            font-size: 1rem;
        }
        
        /* Informations invité */
        .guest-info {
            min-width: 200px;
        }
        
        .guest-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .vip-badge {
            background: var(--warning);
            color: white;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        
        .guest-contact {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 2px;
        }
        
        .guest-company {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Colonne siège */
        .seat-cell {
            text-align: center;
            width: 60px;
        }
        
        .seat-number {
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 5px 10px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: inline-block;
        }
        
        /* Message pas d'invités */
        .no-guests {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-light);
            background: var(--bg-light);
            border-radius: var(--radius);
            border: 2px dashed var(--border);
        }
        
        .no-guests i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* Pied de page */
        .document-footer {
            background: var(--bg-light);
            border-top: 1px solid var(--border);
            padding: 40px 50px;
        }
        
        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .footer-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .footer-logo i {
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .footer-logo span {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'Playfair Display', serif;
        }
        
        .footer-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .footer-info p {
            margin-bottom: 8px;
        }
        
        .footer-meta {
            display: flex;
            justify-content: center;
            gap: 30px;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }
        
        /* Watermark */
        .watermark {
            position: fixed;
            bottom: 20px;
            right: 20px;
            opacity: 0.03;
            font-size: 120px;
            font-weight: 900;
            color: var(--primary);
            transform: rotate(-15deg);
            pointer-events: none;
            z-index: -1;
            font-family: 'Playfair Display', serif;
        }
        
        /* Styles d'impression */
        @media print {
            body {
                background: white;
                padding: 20px;
            }
            
           
            
            .tables-grid {
                grid-template-columns: 1fr;
            }
            
            .table-card {
                page-break-inside: avoid;
                break-inside: avoid;
            }
            
            .watermark {
                display: none;
            }
            
          
    body {
        background: #fff !important;
        color: #000 !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Conteneur principal du CV */
    .document-container {
       box-shadow: none !important; 
       overflow: visible !important; 
       border-radius: 0 !important;
    }

    /* Masquer les éléments non pertinents */
    .download-btn, 
    .loading-overlay, 
    .no-print, 
    .print-hide {
        display: none !important;
    }

   
   
    /* Paramètres de la page imprimée */
   @page { size: A3 portrait; margin: 0; }
        }
        
        /* Utilitaires */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mb-20 { margin-bottom: 20px; }
        .mb-30 { margin-bottom: 30px; }
        .mt-20 { margin-top: 20px; }
        .mt-30 { margin-top: 30px; }
        .opacity-75 { opacity: 0.75; }
        .opacity-90 { opacity: 0.9; }
        
        /* Animation légère */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .table-card {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="watermark">SECURA</div>
    
    <div class="document-container">
        <!-- En-tête du document -->
        <header class="document-header" style="background-image: url('${currentEvent.design.backgroundImage || 'data:image/svg+xml,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,0 L100,100 M100,0 L0,100" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></svg>'}')">
            <div class="header-top">
                <!-- Logo GeekHub -->
                <div class="app-brand">
                    <div class="app-logo">
                        <img src="assets/images/logo.png" alt="Logo">
                    </div>
                    <div class="app-info">
                        <h1>${escapeHtml(currentEvent.name)}</h1>
                        <div class="tagline">Secura QR • Gestion Professionnelle d'Événements</div>
                    </div>
                </div>
                
                <!-- Logo de l'événement -->
                <div class="event-logo-section">
                    ${currentEvent.design?.logo ? `
                    <div class="event-logo-circle">
                        <img src="${currentEvent.design.logo}" alt="Logo ${escapeHtml(currentEvent.name)}">
                    </div>
                    ` : ''}
                    <div class="event-name">${currentEvent.type ? currentEvent.type.charAt(0).toUpperCase() + currentEvent.type.slice(1) : 'Événement'}</div>
                </div>
            </div>
            
            <!-- Informations événement -->
            <div class="event-info-section">
                <div class="event-info-grid">
                    <div class="info-item">
                        <div class="icon"><i class="fas fa-calendar-alt"></i></div>
                        <div class="label">Date</div>
                        <div class="value">
                            ${currentEvent.date ? new Date(currentEvent.date).toLocaleDateString('fr-FR', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            }) : 'À définir'}
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="icon"><i class="fas fa-clock"></i></div>
                        <div class="label">Heure</div>
                        <div class="value">${currentEvent.time || 'À définir'}</div>
                    </div>
                    <div class="info-item">
                        <div class="icon"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="label">Lieu</div>
                        <div class="value">${escapeHtml(currentEvent.location || 'À définir')}</div>
                    </div>
                  
                </div>
            </div>
        </header>
        
        <!-- Contenu principal -->
        <main class="document-content">
            <!-- Section statistiques -->
            <section class="stats-section">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-table"></i></div>
                    <div class="stat-value">${tables.length}</div>
                    <div class="stat-label">Tables</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-value">${allGuests.length}</div>
                    <div class="stat-label">Invités totaux</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chair"></i></div>
                    <div class="stat-value">${totalAssignedGuests}</div>
                    <div class="stat-label">Invités assignés</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-chart-pie"></i></div>
                    <div class="stat-value">${tablesWithGuests}</div>
                    <div class="stat-label">Tables occupées</div>
                </div>
            </section>
            
            <!-- Section tables -->
            <section class="tables-section">
                <div class="tables-section-title">
                    <h2>Plan de Tables Officiel</h2>
                    <p>Document protocolaire pour la gestion des places et des invités</p>
                </div>
                
                ${tables.length > 0 ? `
                <div class="tables-grid">
                    ${tableData.map((table, tableIndex) => `
                    <div class="table-card">
                        <!-- En-tête de la table -->
                        <div class="table-header">
                            <div class="table-header-content">
                                <div class="table-info">
                                    <h3>
                                        <i class="fas fa-chair"></i>
                                        ${escapeHtml(table.tableName || `Table ${table.tableNumberDisplay}`)}
                                        <span class="table-number">#${table.tableNumberDisplay}</span>
                                    </h3>
                                    <div class="table-meta">
                                        <div class="table-meta-item">
                                            <i class="fas fa-users"></i>
                                            <span>${table.capacityText} places</span>
                                        </div>
                                        ${table.location ? `
                                        <div class="table-meta-item">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span>${escapeHtml(table.location)}</span>
                                        </div>
                                        ` : ''}
                                        ${table.category ? `
                                        <div class="table-meta-item">
                                            <i class="fas fa-tag"></i>
                                            <span>${escapeHtml(table.category)}</span>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                
                                  ${table.dataUrl ? `
                            <div class="table-qr">
                                <img src="${table.dataUrl}" alt="QR Code - Table ${table.tableNumber}">
                               
                            </div>
                            ` : ''}
                            </div>
                        </div>
                        
                        <!-- Corps de la table -->
                        <div class="table-body">
                            <div class="guests-header">
                                <h4>
                                    <i class="fas fa-user-friends"></i>
                                    Liste des invités
                                    <span class="guest-count">${table.guestCount}</span>
                                </h4>
                            </div>
                            
                            ${table.guestCount > 0 ? `
                            <table class="guests-table">
                                <thead>
                                    <tr>
                                        <th width="50"></th>
                                        <th>Invité</th>
                                        <th>Contact</th>
                                        <th width="100">Places</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${table.guests.map(guest => `
                                    <tr>
                                        <!-- Avatar -->
                                        <td class="guest-avatar-cell">
                                            <div class="guest-avatar">
                                                ${guest.avatarUrl ? `
                                                <img src="${guest.avatarUrl}" alt="${guest.fullName}" 
                                                     onerror="this.parentElement.innerHTML='<div class=\\'guest-avatar-initials\\' style=\\'background: ${guest.avatarColor}\\'>${guest.initials}</div>'">
                                                ` : `
                                                <div class="guest-avatar-initials" style="background: ${guest.avatarColor}">
                                                    ${guest.initials}
                                                </div>
                                                `}
                                            </div>
                                        </td>
                                        
                                        <!-- Informations -->
                                        <td>
                                            <div class="guest-info">
                                                <div class="guest-name">
                                                    ${escapeHtml(guest.fullName)}
                                                    ${guest.vipBadge ? `
                                                    <span class="vip-badge">
                                                        <i class="fas fa-crown"></i> ${guest.vipBadge}
                                                    </span>
                                                    ` : ''}
                                                </div>
                                                ${guest.company ? `
                                                <div class="guest-company">
                                                    <i class="fas fa-key opacity"></i>
                                                    ${escapeHtml(guest.accessCode)}
                                                </div>
                                                ` : ''}
                                            </div>
                                        </td>
                                        
                                        <!-- Contact -->
                                        <td>
                                            ${guest.contact ? `
                                            <div class="guest-contact">
                                                <i class="fas ${guest.contact.includes('@') ? 'fa-envelope' : 'fa-phone'} opacity-75"></i>
                                                ${escapeHtml(guest.contact)}
                                            </div>
                                            ` : '—'}
                                        </td>
                                        
                                        <!-- Siège -->
                                        <td class="seat-cell">
                                            <div class="seat-number">${guest.seatNumber}</div>
                                        </td>
                                    </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ` : `
                            <div class="no-guests">
                                <i class="fas fa-users-slash"></i>
                                <h4>Aucun invité assigné</h4>
                                <p>Cette table est actuellement disponible</p>
                            </div>
                            `}
                        </div>
                    </div>
                    `).join('')}
                </div>
                ` : `
                <div class="no-guests" style="max-width: 600px; margin: 0 auto;">
                    <i class="fas fa-table fa-3x mb-20"></i>
                    <h3 style="color: var(--text-secondary); margin-bottom: 10px;">Aucune table créée</h3>
                    <p style="color: var(--text-light);">Aucune table n'a été configurée pour cet événement.</p>
                </div>
                `}
            </section>
        </main>
        
        <!-- Pied de page -->
        <footer class="document-footer">
            <div class="footer-content">
                <div style="display: grid; grid-template-columns: 0fr 1fr; gap: 40px;">
                    <!-- Colonne gauche: Logo et Informations -->
                    <div>
                        <div class="footer-logo">
                           
                            <img src="assets/images/geek.png" alt="GeekHub" style="height: 60px; border-radius: 12px;">
                            <span>GeekHub</span>
                        </div>
                        
                        <div class="footer-meta" style="margin-top: 20px; text-align: left;">
                            <div style="margin-bottom: 12px;">
                                <i class="fas fa-calendar-alt" style="width: 20px;"></i>
                                Généré le ${currentDate.toLocaleDateString('fr-FR', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </div>
                           
                        </div>
                    </div>
                    
                    <!-- Colonne droite: Informations -->
                    <div class="footer-info">
                        <p><strong>Document protocolaire confidentiel</strong></p>
                        <p>Ce document contient des informations sensibles relatives à l'organisation de l'événement.</p>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);">
                            <p style="color: var(--text-light); font-size: 0.8rem; margin-top: 10px;">
                                © ${currentDate.getFullYear()} GeekHub - Secura QR<br>
                                Tous droits réservés
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>
    

</body>
</html>`;
}
/**
 * Fonction utilitaire pour échapper le HTML
 */
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
}

/**
 * Générer une couleur à partir d'une chaîne
 */
function stringToColor(str) {
    if (!str) return '#D97706';
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const colors = [
        '#D97706', '#3B82F6', '#10B981', '#EF4444', '#8B5CF6',
        '#EC4899', '#F59E0B', '#06B6D4', '#84CC16', '#F97316'
    ];
    return colors[Math.abs(hash) % colors.length];
}


// Obtenir l'avatar selon le sexe avec détection intelligente
function getGuestAvatarImage(guest) {
    const baseUrl = 'assets/images/';
    const validGenders = ['m', 'f', 'homme', 'femme', 'male', 'female', 'couple', 'maman', 'mother', 'autre'];
    
    // 1️⃣ Vérifier d'abord le champ gender/sexe
    const gender = (guest.gender?.toLowerCase() || guest.sexe?.toLowerCase() || '').trim();
    
    if (gender) {
        // Normaliser et checker les valeurs connues
        if (gender === 'f' || gender === 'femme' || gender === 'woman' || gender === 'female') {
            return `${baseUrl}femme.png`;
        } else if (gender === 'm' || gender === 'homme' || gender === 'man' || gender === 'male') {
            return `${baseUrl}homme.png`;
        } else if (gender === 'couple') {
            return `${baseUrl}couple.png`;
        } else if (gender === 'maman' || gender === 'mother') {
            return `${baseUrl}maman.png`;
        } else if (gender === 'autre') {
            return null; // Utiliser les initiales
        }
    }
    
    // 2️⃣ Détection intelligente basée sur les titres de civilité et notes
    const firstName = (guest.firstName || '').toLowerCase().trim();
    const lastName = (guest.lastName || '').toLowerCase().trim();
    const notes = (guest.notes || '').toLowerCase().trim();
    const company = (guest.company || '').toLowerCase().trim();
    
    // 🎖️ Détecter "Maman", "Mother" dans les notes ou le nom
    if (notes.includes('maman') || notes.includes('mother') || 
        firstName.includes('maman') || firstName.includes('mother') ||
        lastName.includes('maman') || lastName.includes('mother')) {
        return `${baseUrl}maman.png`;
    }
    
    // 👫 Détecter "Couple" dans les notes ou le type
    if (guest.type === 'couple' || 
        notes.includes('couple') || 
        company.includes('couple')) {
        return `${baseUrl}couple.png`;
    }
    
    // 👨 Détecter les titres masculins et préfixes
    const malePatterns = [
        /\bm\b\.?/i,           // M. ou M
        /\bmonsieur\b/i,       // Monsieur
        /\bmr\b\.?/i,          // Mr ou Mr.
        /\bmon\b\.?/i,         // Mon (de Monsieur)
        /père/i,               // Père
        /father/i,             // Father
        /dad\b/i,              // Dad
        /papa/i                // Papa
    ];
    
    // Chercher dans les notes
    if (malePatterns.some(pattern => pattern.test(notes))) {
        return `${baseUrl}homme.png`;
    }
    
    // Chercher dans le prénom ou nom
    if (malePatterns.some(pattern => pattern.test(firstName + ' ' + lastName))) {
        return `${baseUrl}homme.png`;
    }
    
    // 👩 Détecter les titres féminins et préfixes
    const femalePatterns = [
        /\bm[lle]{1,3}\.?/i,    // Mlle ou Mme ou Mme.
        /\bmme\b\.?/i,          // Mme
        /\bmlle\b\.?/i,         // Mlle
        /\bmademoiselle\b/i,    // Mademoiselle
        /\bmadame\b/i,          // Madame
        /\bmrs\b\.?/i,          // Mrs
        /\bms\b\.?/i,           // Ms
        /mère/i,                // Mère
        /mother/i,              // Mother
        /maman/i,               // Maman
        /mom\b/i,               // Mom
        /mama/i                 // Mama
    ];
    
    // Chercher dans les notes
    if (femalePatterns.some(pattern => pattern.test(notes))) {
        return `${baseUrl}femme.png`;
    }
    
    // Chercher dans le prénom ou nom
    if (femalePatterns.some(pattern => pattern.test(firstName + ' ' + lastName))) {
        return `${baseUrl}femme.png`;
    }
    
    const commonFemaleNames = [
        'marie', 'anne', 'sophie', 'christine', 'catherine', 'nathalie',
        'isabelle', 'francine', 'fabienne', 'nadine', 'monique', 'dominique',
        'michelle', 'carole', 'patricia', 'béatrice', 'denise', 'brigitte',
        'véronique', 'christine', 'joëlle', 'chantal', 'thérèse', 'simone',
        'valerie', 'annie', 'elise', 'alice', 'claire', 'nicole', 'sylvie',
        'martine', 'emilie', 'victoria', 'laura', 'sarah', 'jessica', 'jessica'
    ];
    
    // Liste de prénoms masculins courants en français
    const commonMaleNames = [
        'jean', 'pierre', 'michel', 'andré', 'bernard', 'françois',
        'jacques', 'patrick', 'christian', 'daniel', 'olivier', 'alain',
        'marc', 'thierry', 'charles', 'paul', 'jean-paul', 'jean-claude',
        'serge', 'gérard', 'dominique', 'richard', 'joseph', 'louis',
        'luc', 'eric', 'david', 'nicolas', 'thomas', 'alexandre', 'benoit'
    ];
    
    if (firstName) {
        if (commonFemaleNames.includes(firstName)) {
            return `${baseUrl}femme.png`;
        } else if (commonMaleNames.includes(firstName)) {
            return `${baseUrl}homme.png`;
        }
    }
    
    return null;
}


/**
 * Obtenir le nombre total d'invités
 */
function getAllGuestsCount() {
    if (!allGuests || !Array.isArray(allGuests)) return 0;
    return allGuests.length;
}

// Initialisation des écouteurs d'événements
document.addEventListener('DOMContentLoaded', function() {
    // Bouton d'ouverture du modal d'export
    const openExportBtn = document.getElementById('openExportInfoBtn');
    if (openExportBtn) {
        openExportBtn.addEventListener('click', showExportTableInfoModal);
    }

    // Bouton de fermeture
    const closeExportBtn = document.getElementById('closeExportInfoBtn');
    if (closeExportBtn) {
        closeExportBtn.addEventListener('click', closeExportModal);
    }

    // Fermeture en cliquant à l'extérieur
    const modal = document.getElementById('tableExportInfoModal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeExportModal();
            }
        });
    }

    console.log('✅ Module d\'export initialisé');
});




async function downloadQRZipArchive() {
    console.log('📥 Début du téléchargement ZIP');
    
    try {
        const downloadBtn = document.getElementById('downloadQrZipBtn');
        const originalText = downloadBtn.innerHTML;
        
        // Afficher l'indicateur de chargement
        downloadBtn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: white; animation: spin 1s linear infinite; margin: 0 auto;"></div>';
        downloadBtn.disabled = true;
        
        // Générer le blob ZIP
        const blob = await qrZipData.generateAsync({ type: 'blob' });
        
        // Créer le lien de téléchargement
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        
        // Nom du fichier
        const eventName = currentEvent.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        const timestamp = new Date().toISOString().split('T')[0];
        a.download = `qr_codes_${eventName}_${timestamp}.zip`;
        
        // Déclencher le téléchargement
        document.body.appendChild(a);
        a.click();
        
        // Nettoyer
        setTimeout(() => {
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }, 100);
        
        // Restaurer le bouton
        downloadBtn.innerHTML = originalText;
        downloadBtn.disabled = false;
        
        // Afficher la confirmation
        Toastify({
            text: `Archive téléchargée (${generatedQRCodes.length} fichiers)`,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--success)"
        }).showToast();
        
        // Jouer le son de succès
        if (typeof SECURA_AUDIO !== 'undefined') {
            SECURA_AUDIO.play('success');
        }
        
    } catch (error) {
        console.error('❌ Erreur téléchargement ZIP:', error);
        
        // Restaurer le bouton
        const downloadBtn = document.getElementById('downloadQrZipBtn');
        downloadBtn.innerHTML = '<i class="fas fa-download"></i> Télécharger l\'Archive ZIP';
        downloadBtn.disabled = false;
        
        Swal.fire({
            icon: 'error',
            title: 'Erreur de téléchargement',
            text: 'Impossible de télécharger l\'archive. Veuillez réessayer.',
            confirmButtonColor: '#D97706'
        });
    }
}

async function printQRDocumentPDF() {
    try {
        const allGuests = currentEvent ? storage.getGuestsByEventId(currentEvent.id) : [];
    const docHTML = await generateProfessionalDocumentHTML(allGuests);
        
        // Créer une nouvelle fenêtre
        const printWindow = window.open('', '', 'width=1200,height=800');
        
        // Écrire le HTML dans la nouvelle fenêtre
        printWindow.document.write(docHTML);
        printWindow.document.close();
        
        // Attendre que le contenu soit chargé puis imprimer
        printWindow.onload = function() {
            setTimeout(() => {
                // Ajouter le background image du header avec l'image de l'événement
                const headerElement = printWindow.document.querySelector('.document-header');
                if (headerElement && currentEvent) {
                    headerElement.style.backgroundImage = `url('${currentEvent.backgroundImage}' || 'data:image/svg+xml,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,0 L100,100 M100,0 L0,100" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></svg>')`;
                    headerElement.style.backgroundSize = 'cover';
                    headerElement.style.backgroundPosition = 'center';
                    headerElement.style.backgroundAttachment = 'fixed';
                }
                
                printWindow.print();
                // Optionnel: Fermer la fenêtre après impression
                // printWindow.close();
            }, 250);
        };
        
        // Si la fenêtre est déjà chargée
        if (document.readyState === 'complete') {
            printWindow.print();
        }
        
        Toastify({
            text: 'Document prêt pour l\'impression PDF',
            duration: 2000,
            gravity: "top",
            position: "right",
            backgroundColor: "#10B981"
        }).showToast();
        
    } catch (error) {
        console.error('❌ Erreur impression PDF:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Impossible de générer le document PDF',
            confirmButtonColor: '#D97706'
        });
    }
}

// ============================================
// 📊 EXPORT DES INFORMATIONS DES TABLES
// ============================================

let exportStartTime = null;
let currentExportFormat = null;
let selectedExportFormat = null;

/**
 * Afficher le modal d'export
 */
function showExportTableInfoModal() {
    const modal = document.getElementById('tableExportInfoModal');
    if (modal) {
        modal.classList.add('active');
        
        // Réinitialiser l'état
        resetExportModal();
        
        // Charger les statistiques
        updateExportStats();
    }
}

/**
 * Fermer le modal d'export
 */
function closeExportModal() {
    const modal = document.getElementById('tableExportInfoModal');
    if (modal) {
        modal.classList.remove('active');
        resetExportModal();
    }
}

/**
 * Réinitialiser le modal d'export
 */
function resetExportModal() {
    // Réinitialiser les étapes
    document.getElementById('exportStep1').classList.add('active');
    document.getElementById('exportStep2').classList.remove('active');
    document.getElementById('exportStep1Indicator').classList.add('active');
    document.getElementById('exportStep2Indicator').classList.remove('active');
    document.getElementById('exportProgressBar').style.width = '50%';
    document.getElementById('exportCurrentStep').textContent = '1';
    
    // Réinitialiser la sélection
    document.querySelectorAll('.export-format-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    selectedExportFormat = null;
    currentExportFormat = null;
}

/**
 * Mettre à jour les statistiques
 */
function updateExportStats() {
    const tables = allTables && Array.isArray(allTables) ? allTables : [];
    const guests = allGuests && Array.isArray(allGuests) ? allGuests : [];
    
    document.getElementById('exportTableCount').textContent = tables.length;
    document.getElementById('exportGuestCount').textContent = guests.length;
}

/**
 * Sélectionner un format d'export
 */
function selectExportFormat(format) {
    selectedExportFormat = format;
    
    // Mise à jour visuelle
    document.querySelectorAll('.export-format-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    document.querySelector(`[data-format="${format}"]`).classList.add('selected');
    
    // Passer à l'étape suivante après un délai
    setTimeout(() => {
        goToExportStep2(format);
    }, 300);
}

/**
 * Passer à l'étape 2
 */
function goToExportStep2(format) {

    document.getElementById('exportStep1').classList.remove('active');
    document.getElementById('exportStep2').classList.add('active');
    document.getElementById('exportStep1Indicator').classList.remove('active');
    document.getElementById('exportStep2Indicator').classList.add('active');
    document.getElementById('exportProgressBar').style.width = '100%';
    document.getElementById('exportCurrentStep').textContent = '2';
    
    // Afficher le loader
    document.getElementById('exportLoader').style.display = 'block';
    document.getElementById('exportSuccess').style.display = 'none';
    
    // Démarrer l'export
    startExport(format);
}



/**
 * Démarrer l'export
 */
async function startExport(format) {
    currentExportFormat = format;
    exportStartTime = Date.now();
    
    const formatLabels = {
        'pdf': 'Génération PDF',
        'json': 'Génération JSON',
        'csv': 'Génération CSV',
        'print': 'Préparation Impression'
    };
    
    document.getElementById('exportSubtitle').textContent = formatLabels[format] + '...';
    document.getElementById('exportOperationType').textContent = format.toUpperCase();
    document.getElementById('exportTablesDone').textContent = allTables.length;
    
    try {
        // Exécuter l'export selon le format
        switch(format) {
            case 'pdf':
                await exportTableInfoPDF();
                break;
            case 'json':
                await exportTableInfoJSON();
                break;
            case 'csv':
                await exportTableInfoCSV();
                break;
            case 'print':
                await printTableInfo();
                break;
        }
        
        // Afficher le succès
        showExportSuccess(format);
        
    } catch (error) {
        console.error('Erreur export:', error);
        showExportError(error);
    }
}

/**
 * Afficher le succès
 */
function showExportSuccess(format) {
    document.getElementById('exportLoader').style.display = 'none';
    document.getElementById('exportSuccess').style.display = 'block';
    
    const timeTaken = Math.round((Date.now() - exportStartTime) / 1000);
    document.getElementById('exportTimeTaken').textContent = timeTaken + 's';
    
    const messages = {
        'pdf': 'Le document PDF a été généré avec succès.',
        'csv': 'Le fichier CSV est prêt pour le téléchargement.',
        'json': 'Le fichier JSON structuré a été créé.',
        'print': 'L\'aperçu d\'impression est ouvert dans un nouvel onglet.'
    };
    
    document.getElementById('exportMessage').textContent = messages[format];
    
    // Jouer le son de succès
    if (typeof SECURA_AUDIO !== 'undefined') {
        SECURA_AUDIO.play('success');
    }
}

/**
 * Afficher l'erreur
 */
function showExportError(error) {
    document.getElementById('exportLoader').style.display = 'none';
    document.getElementById('exportSuccess').style.display = 'block';
    document.getElementById('exportSuccess').innerHTML = `
        <i class="bi bi-x-circle" style="font-size: 5em; color: var(--danger);"></i>
        <p style="margin-top: 20px; font-size: 1.3em; font-weight: 700; color: var(--danger);">Erreur !</p>
        <p style="color: #666; margin-top: 10px;">${error.message || 'Une erreur est survenue'}</p>
        <button onclick="closeExportModal()" class="btn btn-primary" style="margin-top: 20px;">
            Fermer
        </button>
    `;
}



/**
 * Export PDF
 */
async function exportTableInfoPDF() {
    const allGuests = currentEvent ? storage.getGuestsByEventId(currentEvent.id) : [];
    const docHTML = await generateProfessionalDocumentHTML(allGuests);
    const printWindow = window.open('', '', 'width=1200,height=800');
    printWindow.document.write(docHTML);
    printWindow.document.close();
    
    return new Promise(resolve => {
        printWindow.onload = function() {
            setTimeout(() => {
                printWindow.print();
                resolve();
            }, 250);
        };
    });
}


// Export JSON
async function exportTableInfoJSON() {
    // Charger les données correctement
    const tables = allTables && Array.isArray(allTables) ? allTables : [];
    const allGuests = currentEvent ? storage.getGuestsByEventId(currentEvent.id) : [];
    
    console.log(`📊 Export JSON: ${tables.length} table(s), ${allGuests.length} invité(s)`);
    
    const data = {
        evenement: {
            nom: currentEvent.name,
            description: currentEvent.description || '',
            date: new Date().toLocaleDateString('fr-FR'),
            totalTables: tables.length,
            totalInvites: allGuests.length
        },
        tables: tables.map((table, index) => {
            const guests = allGuests.filter(guest => guest.tableId === table.id || guest.table_id === table.id);
            return {
                numero: index + 1,
                nom: table.tableName,
                numeroTable: table.tableNumber,
                invites: guests.map(g => ({
                    nom: (g.firstName || '') + ' ' + (g.lastName || g.name || 'Invité'),
                    email: g.email || '',
                    telephone: g.phone || '',
                    confirme: g.confirmed || false
                }))
            };
        })
    };
    
    const jsonString = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tables_info_${currentEvent.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    return Promise.resolve();
}

// Export CSV
async function exportTableInfoCSV() {
    // Charger les données correctement
    const tables = allTables && Array.isArray(allTables) ? allTables : [];
    const allGuests = currentEvent ? storage.getGuestsByEventId(currentEvent.id) : [];
    
    console.log(`📊 Export CSV: ${tables.length} table(s), ${allGuests.length} invité(s)`);
    
    let csv = 'Table,Numéro,Nom Invité,Email,Téléphone,Confirmé\n';
    
    tables.forEach((table, index) => {
        const guests = allGuests.filter(guest => guest.tableId === table.tableId || guest.table_id === table.tableId);
        if (guests.length > 0) {
            guests.forEach(guest => {
                const nom = ((guest.firstName || '') + ' ' + (guest.lastName || guest.name || 'Invité')).trim();
                const email = guest.email || '';
                const phone = guest.phone || '';
                const confirme = guest.confirmed ? 'Oui' : 'Non';
                csv += `"${table.tableName}","${table.tableNumber}","${nom}","${email}","${phone}","${confirme}"\n`;
            });
        } else {
            csv += `"${table.tableName}","${table.tableNumber}","Aucun invité","","",""\n`;
        }
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tables_info_${currentEvent.name.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    return Promise.resolve();
}


/**
 * Imprimer
 */
async function printTableInfo() {
    const allGuests = currentEvent ? storage.getGuestsByEventId(currentEvent.id) : [];
    const docHTML = await generateProfessionalDocumentHTML(allGuests);
    const printWindow = window.open('', '', 'width=1200,height=800');
    printWindow.document.write(docHTML);
    printWindow.document.close();
    
    return new Promise(resolve => {
        printWindow.onload = function() {
            setTimeout(() => {
                printWindow.print();
                resolve();
            }, 250);
        };
    });
}



// ============================================
// 🎯 QR CODE INDIVIDUEL
// ============================================

window.generateTableQR = async function(tableId) {
    console.log('🔗 Génération QR individuel pour table:', tableId);
    
    try {
        // Récupérer la table
        const table = allTables.find(t => t.id === tableId);
        if (!table) {
            Toastify({
                text: "Table non trouvée",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--danger)"
            }).showToast();
            return;
        }

        // Construire le lien d'accès
        const accessLink = `${storage.FRONTEND_URL}/access?eventId=${currentEvent.id}&tableId=${table.id}`;

        // Afficher le modal
        const modal = document.getElementById('tableQrModal');
        document.getElementById('tableQrName').textContent = `${table.tableNumber} ⬝ ${table.tableName || 'Sans nom'}`;
        document.getElementById('tableQrLink').textContent = accessLink;

        // Générer le QR code
        const qrContainer = document.getElementById('tableQrCodeContainer');
        qrContainer.innerHTML = '';

        // URL du logo
        const logoUrl = 'assets/images/image.png';

        // Options du QR code
        const options = {
            text: accessLink,
            width: 250,
            height: 250,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H,
            dotScale: 0.8,
            PO: '#000000',
            PI: '#000000',
            AO: '#ffffff',
            AI: '#ffffff',
            logo: logoUrl,
            logoWidth: 70,
            logoHeight: 70,
            logoBackgroundColor: '#ffffff',
            logoBackgroundTransparent: false,
            quietZone: 10,
            quietZoneColor: '#ffffff',
            drawer: 'canvas'
        };

        new QRCode(qrContainer, options);

        // Récupérer le nombre de scans
        try {
            const qrCode = await storage.generateTableQR(tableId);
            if (qrCode && qrCode.scanCount !== undefined) {
                document.getElementById('tableQrScanCount').textContent = qrCode.scanCount;
            }
        } catch (scanError) {
            console.warn('Impossible de récupérer le nombre de scans:', scanError);
            document.getElementById('tableQrScanCount').textContent = '0';
        }

        // Afficher le modal
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('active');
        }, 10);

        // Configurer les actions
        setupTableQRActions(table, accessLink);

    } catch (error) {
        console.error('❌ Erreur génération QR individuel:', error);
        
        Toastify({
            text: "Erreur lors de la génération du QR code",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--danger)"
        }).showToast();
    }
};

function setupTableQRActions(table, accessLink) {
    // Copier le lien
    document.getElementById('copyTableQrBtn').onclick = () => {
        navigator.clipboard.writeText(accessLink).then(() => {
            Toastify({
                text: "Lien copié dans le presse-papiers",
                duration: 2000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--success)"
            }).showToast();
        }).catch(() => {
            Toastify({
                text: "Erreur lors de la copie",
                duration: 2000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--danger)"
            }).showToast();
        });
    };

    // Partager
    document.getElementById('shareTableQrBtn').onclick = async () => {
        if (navigator.share) {
            try {
                // Récupérer le canvas du QR code
                const canvas = document.querySelector('#tableQrCodeContainer canvas');
                if (!canvas) {
                    Toastify({
                        text: "QR code non généré",
                        duration: 2000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "var(--danger)"
                    }).showToast();
                    return;
                }

                // Convertir le canvas en blob
                canvas.toBlob(async (blob) => {
                    const file = new File([blob], `QR_${table.tableNumber}.png`, { type: 'image/png' });
                    
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        try {
                            await navigator.share({
                                title: `QR Code - Table ${table.tableNumber}`,
                                text: `Accédez à la table ${table.tableNumber}`,
                                files: [file]
                            });
                            
                            Toastify({
                                text: "Partagé avec succès",
                                duration: 2000,
                                gravity: "top",
                                position: "right",
                                backgroundColor: "var(--success)"
                            }).showToast();
                        } catch (err) {
                            if (err.name !== 'AbortError') {
                                throw err;
                            }
                        }
                    } else {
                        // Fallback: partager le lien seulement
                        await navigator.share({
                            title: `QR Code - Table ${table.tableNumber}`,
                            text: `Accédez à la table ${table.tableNumber}\n${accessLink}`,
                            url: accessLink
                        });
                        
                        Toastify({
                            text: "Lien partagé avec succès",
                            duration: 2000,
                            gravity: "top",
                            position: "right",
                            backgroundColor: "var(--success)"
                        }).showToast();
                    }
                });
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('Erreur partage:', err);
                }
            }
        } else {
            // Fallback pour les navigateurs sans support du partage
            Toastify({
                text: "Le partage n'est pas supporté par votre navigateur",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--warning)"
            }).showToast();
        }
    };

    // Télécharger le QR code
    document.getElementById('downloadTableQrBtn').onclick = () => {
        const canvas = document.querySelector('#tableQrCodeContainer canvas');
        if (!canvas) {
            Toastify({
                text: "QR code non généré",
                duration: 2000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--danger)"
            }).showToast();
            return;
        }

        // Convertir en blob et télécharger
        canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `QR_${table.tableName || 'Table'}_${table.tableNumber}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Toastify({
                text: "QR code téléchargé",
                duration: 2000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--success)"
            }).showToast();
        }, 'image/png');
    };
}

function closeTableQRModal() {
    const modal = document.getElementById('tableQrModal');
    if (modal) {
        modal.classList.remove('active');
        
        setTimeout(() => {
            modal.style.display = 'none';
            
            // Nettoyer le conteneur
            const qrContainer = document.getElementById('tableQrCodeContainer');
            if (qrContainer) {
                qrContainer.innerHTML = '<i class="fas fa-qrcode" style="font-size: 80px; color: var(--primary); opacity: 0.3;"></i>';
            }
        }, 300);
    }
}

// ============================================
// 🎯 FONCTIONS UTILITAIRES
// ============================================

// Fonction pour obtenir la couleur d'une catégorie
function getCategoryColor(category) {
    const colors = {
        'vip': '#F59E0B',
        'family': '#8B5CF6',
        'speaker': '#3B82F6',
        'organizer': '#10B981',
        'standard': '#D97706',
        'mariage': '#EC4899',
        'anniversaire': '#6366F1'
    };
    return colors[category] || colors.standard;
}

// Fonction pour obtenir le libellé d'une catégorie
function getCategoryLabel(category) {
    const labels = {
        'vip': 'VIP',
        'family': 'Familiale',
        'speaker': 'Conférencier',
        'organizer': 'Organisateur',
        'standard': 'Standard',
        'mariage': 'Mariage',
        'anniversaire': 'Anniversaire'
    };
    return labels[category] || 'Standard';
}

// Fonction d'échappement HTML
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}





                // Fonctions utilitaires pour l'aperçu
        function getEventImage(type) {
            const defaultImages = {
                marriage: 'https://images.unsplash.com/photo-1519167758481-83f550bb49b3?w=800&q=80',
                anniversaire: 'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=800&q=80',
                conference: 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=800&q=80',
                corporate: 'https://images.unsplash.com/photo-1515187029135-18ee286d815b?w=800&q=80',
                concert: 'https://images.unsplash.com/photo-1470229722913-7c0e2dbbafd3?w=800&q=80',
                gala: 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=800&q=80',
                football: 'https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=800&q=80',
                autre: 'https://images.unsplash.com/photo-1501281668745-f7f579dff10e?w=800&q=80'
            };
            
            return defaultImages[type] || defaultImages.autre;
        }


        // Fonction pour afficher la vue événements
        async function showEventsHome() {
            destroyCharts();
            currentEvent = null;
            document.getElementById('eventsHomeView').style.display = 'block';
            document.getElementById('tablesView').style.display = 'none';
            document.title = 'SECURA | Sélectionnez un événement';
            await loadEventsList();
        }

        // Fonction pour afficher la vue tables
        async function showTablesView(eventId) {
            window.history.pushState({}, '', `tables?id=${eventId}`);
            document.getElementById('eventsHomeView').style.display = 'none';
            document.getElementById('tablesView').style.display = 'block';

            await loadTablesForEvent(eventId);
        }

        // Charger la liste des événements
        async function loadEventsList() {
            try {
                eventsList = await storage.getAllEvents();
                currentUser = await storage.getProfile();
                
                if (currentUser.role !== 'admin') {
                    eventsList = eventsList.filter(event => 
                        event.organizerId == currentUser.id
                    );
                }
            
                if (eventsList.length === 0) {
                    document.getElementById('emptyEventsState').style.display = 'flex';
                    document.getElementById('eventsGridView').style.display = 'none';
                    document.getElementById('eventsTableView').style.display = 'none';
                    return;
                }
                
                document.getElementById('emptyEventsState').style.display = 'none';
                renderEventsList();
                
            } catch (error) {
                console.error('Erreur chargement événements:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de charger la liste des événements',
                    confirmButtonColor: '#D97706'
                });
            }
        }

        function renderEventsList() {
            if (eventsViewMode === 'grid') {
                renderEventsGrid();
            } else {
                renderEventsTable();
            }
        }

         // Rendre la vue grille
        async function renderEventsGrid() {
            const grid = document.getElementById('eventsGridView');
            grid.innerHTML = '';
            grid.style.display = 'grid';
            document.getElementById('eventsTableView').style.display = 'none';
            
            for (const event of eventsList) {
                const tables = await storage.getAllTables(event.id);
                    
                    const guests = storage.getGuestsByEventId(event.id);
                    const scannedGuests = guests.filter(g => g.scanned).length;
                    const eventDate = new Date(event.date);
                    const isUpcoming = eventDate >= new Date();
                    
                    const eventCard = document.createElement('div');
                    eventCard.className = 'event-card-pro';
                    eventCard.style.backgroundImage = `url('${getEventImage(event.type)}')`;
                    eventCard.style.borderLeft = `4px solid ${event.design?.primaryColor || '#D97706'}`;
                    eventCard.onclick = () => showTablesView(event.id);
                    
                    eventCard.innerHTML = `
                        ${isUpcoming ? '<div class="upcoming-ribbon" style="background: linear-gradient(45deg, #3B82F6, #8B5CF6);">À VENIR</div>' : ''}
                        
                        <div class="event-type-badge" style="background: ${getTypeColor(event.type)}">
                            ${getTypeLabel(event.type)}
                        </div>
                        
                        <div class="event-content">
                            <h3 class="event-title">${escapeHtml(event.name)}</h3>
                            
                            <div class="event-meta">
                                <div class="meta-item">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>${eventDate.toLocaleDateString('fr-FR')}</span>
                                </div>
                                ${event.time ? `
                                <div class="meta-item">
                                    <i class="fas fa-clock"></i>
                                    <span>${event.time}</span>
                                </div>` : ''}
                                ${event.location ? `
                                <div class="meta-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${event.location}</span>
                                </div>` : ''}
                            </div>

                            <div class="event-stats-circle">
                                <div class="stat-circle">
                                    <div class="circle" style="border-color: ${event.design?.primaryColor || '#D97706'}20;">
                                        <span class="value">${guests.length}</span>
                                        <span class="label">Invités</span>
                                    </div>
                                </div>
                                <div class="stat-circle">
                                    <div class="circle" style="border-color: #10B98120;">
                                        <span class="value">${tables.count}</span>
                                        <span class="label">Tables</span>
                                    </div>
                                </div>
                                 
                                <div class="stat-circle">
                                    <div class="circle" style="border-color: #3B82F620;">
                                        <span class="value">${event.capacity || '∞'}</span>
                                        <span class="label">Capacité</span>
                                    </div>
                                </div>
                            </div>

                            <div class="event-footer">
                                <div class="event-status" style="background: ${event.active ? '#10B981' : '#EF4444'} !important; color: white">
                                    <i class="fas ${event.active ? 'fa-check-circle' : 'fa-times-circle'}"></i>
                                    <span>${event.active ? 'Actif' : 'Inactif'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="event-actions" onclick="event.stopPropagation()">
                            <button class="action-btn view" onclick="viewEvent('${event.id}')" title="Voir invités">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="action-btn edit" onclick="editEvent('${event.id}')" title="Modifier">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="action-btn duplicate" onclick="duplicateEvent('${event.id}')" title="Dupliquer">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button class="action-btn stats" onclick="viewEventStats('${event.id}')" title="Statistiques">
                                <i class="fas fa-chart-bar"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteEvent('${event.id}')" title="Supprimer">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    `;
                    
                    grid.appendChild(eventCard);
                };
        }



        // Rendre la vue tableauhttp://localhost:42513/dashboard
        async function renderEventsTable() {
            const table = document.getElementById('eventsTableBody');
            const grid = document.getElementById('eventsGridView');
            
            grid.style.display = 'none';
            document.getElementById('eventsTableView').style.display = 'block';
            table.innerHTML = '';
            
            for (const event of eventsList) {
                const tables = await storage.getAllTables(event.id);
                const guests = storage.getGuestsByEventId(event.id);
                const scannedGuests = guests.filter(g => g.scanned).length;
                const eventDate = new Date(event.date);
                
                const row = document.createElement('tr');
                row.onclick = () => showTablesView(event.id);
                row.style.cursor = 'pointer';
                
                row.innerHTML = `
                    <td>
                        <div class="event-cell">
                            <div class="event-cell-icon">
                                <i class="fas fa-calendar-alt"></i>
                            </div>
                            <div class="event-cell-info">
                                <div class="event-cell-name" title="${escapeHtml(event.name)}">
                                    ${escapeHtml(event.name)}
                                </div>
                                <div class="event-cell-location" title="${event.location || 'Non spécifié'}">
                                    ${escapeHtml(event.location || 'Non spécifié')}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="event-cell-date">
                            ${eventDate.toLocaleDateString('fr-FR')}
                        </div>
                    </td>
                    <td>
                        <div class="event-cell-type" style="background: ${getTypeColor(event.type)}">
                            ${getTypeLabel(event.type)}
                        </div>
                    </td>
                    <td>
                        <div class="event-cell-stats">
                            <div class="event-cell-stat">
                                <span class="event-cell-stat-number">${tables.count || 0}</span>
                                <span class="event-cell-stat-label">Tables</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="event-cell-stats">
                            <div class="event-cell-stat">
                                <span class="event-cell-stat-number">${guests.length}</span>
                                <span class="event-cell-stat-label">Total</span>
                            </div>
                            <div class="event-cell-stat">
                                <span class="event-cell-stat-number">${scannedGuests}</span>
                                <span class="event-cell-stat-label">Présents</span>
                            </div>
                        </div>
                    </td>
                `;
                
                table.appendChild(row);
            }
        }

        // Fonctions utilitaires pour les types d'événements
        function getTypeColor(type) {
            const colors = {
                marriage: '#EC4899',
                anniversaire: '#F59E0B',
                conference: '#3B82F6',
                corporate: '#6366F1',
                concert: '#8B5CF6',
                gala: '#D97706',
                football: '#10B981',
                autre: '#6B7280'
            };
            return colors[type] || colors.autre;
        }

        function getTypeLabel(type) {
            const labels = {
                marriage: 'Mariage',
                anniversaire: 'Anniversaire',
                conference: 'Conférence',
                corporate: 'Corporate',
                concert: 'Concert',
                gala: 'Gala',
                football: 'Football',
                autre: 'Autre'
            };
            return labels[type] || 'Autre';
        }



        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && currentView !== 'grid') {
                goBackToGridView();
            }
        });
        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            // Vérifier l'authentification
            const authCheck = await checkAuth();
            if (!authCheck) return;
            
            const urlParams = new URLSearchParams(window.location.search);
            const eventId = urlParams.get('id');

            // Initialiser les vues
            initVectorViewListeners();
            
            if (eventId) {
                document.getElementById('eventsHomeView').style.display = 'none';
                document.getElementById('tablesView').style.display = 'block';
                await loadTablesForEvent(eventId);
            } else {
                initEventsViewListeners();
                await showEventsHome();
                
                document.getElementById('searchEvents')?.focus();
            }
        });



       // Fonction pour basculer entre le menu de toggle principal et les actions spécifiques
      // Fonction pour basculer entre les vues
function updateViewHeader(view) {
    const isGridView = view === 'grid';
    
    ['grid', 'table', 'visual', 'vector', 'stats'].forEach(viewName => {
        const container = document.getElementById(`${viewName}View`);
        if (!container) return;
        
        const header = container.querySelector('.grid-header');
        if (!header) return;
        
        const viewToggle = container.querySelector('.view-toggle');
        
        // Si c'est la vue active, afficher le toggle et activer le bon bouton
        if (viewName === view) {
            if (viewToggle) {
                viewToggle.style.display = 'flex';
                
                // Activer le bouton correspondant à la vue
                document.querySelectorAll('.view-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.view === view) {
                        btn.classList.add('active');
                    }
                });
            }
        } else {
            // Pour les autres vues, masquer le toggle
            if (viewToggle) viewToggle.style.display = 'none';
        }
    });
    
    // Mettre aussi à jour les boutons dans toutes les vues
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === view) {
            btn.classList.add('active');
        }
    });
}

function goBackToGridView() {
    currentView = 'grid';
    currentFilter = 'all';
    currentSearch = '';
    currentPage = 1;
    
    // Réinitialiser les filtres visuels
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.remove('active');
        if (chip.dataset.filter === 'all') {
            chip.classList.add('active');
        }
    });
    
    // Réinitialiser la recherche
    const searchInput = document.getElementById('searchTables');
    if (searchInput) searchInput.value = '';
    
    // Mettre à jour les boutons de vue
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.view === 'grid') {
            btn.classList.add('active');
        }
    });
    
    ['grid', 'table', 'visual', 'stats','vector'].forEach(view => {
        const container = document.getElementById(`${view}View`);
        if (container) {
            container.style.display = view === 'grid' ? 'block' : 'none';
        }
    });
    
    const gridView = document.getElementById('gridView');
    if (gridView) {
        const header = gridView.querySelector('.grid-header');
        if (header) header.classList.remove('in-specific-view');
    }
    
    updateViewHeader('grid');
    
    // Réappliquer les filtres et afficher les tables
    applyFilters();
    renderTables();
}


        // Initialiser les écouteurs pour la vue événements
        function initEventsViewListeners() {



            // Changement de vue (MODIFIÉ)
            document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        if (this.classList.contains('create')) return;
        
        currentView = this.dataset.view;
        
        // Mettre à jour l'affichage des vues
        ['grid', 'table', 'visual', 'vector', 'stats'].forEach(view => {
            const container = document.getElementById(`${view}View`);
            if (container) {
                container.style.display = view === currentView ? 'block' : 'none';
            }
        });
        
        // Mettre à jour l'en-tête et activer le bouton
        updateViewHeader(currentView);
        
        currentPage = 1;
        renderTables();
    });
});



            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    
                    document.querySelectorAll('.view-mode-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    eventsViewMode = this.dataset.mode;
                    renderEventsList();
                });
            });
            
            // Recherche dans la vue événements
            const searchInput = document.getElementById('searchEvents');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchTerm = this.value.trim().toLowerCase();
                        if (searchTerm) {
                            const filteredEvents = eventsList.filter(event =>
                                event.name.toLowerCase().includes(searchTerm) ||
                                event.location?.toLowerCase().includes(searchTerm) ||
                                event.type?.toLowerCase().includes(searchTerm)
                            );
                            eventsList = filteredEvents;
                        } else {
                            loadEventsList();
                        }
                    }, 300);
                });
            }
        }

        async function loadTablesForEvent(eventId) {
            try {
                currentEvent = storage.getEventById(eventId);
                
                if (!currentEvent) {
                    await Swal.fire({
                        icon: 'error',
                        title: 'Événement introuvable',
                        text: 'L\'événement spécifié n\'existe pas',
                        confirmButtonColor: '#D97706'
                    });
                    showEventsHome();
                    return;
                }
                
                // Vérifier les permissions
                if (currentUser.role !== 'admin' && currentEvent.organizerId !== currentUser.id) {
                    await Swal.fire({
                        icon: 'warning',
                        title: 'Accès refusé',
                        text: 'Vous n\'êtes pas autorisé à gérer cet événement',
                        confirmButtonColor: '#D97706'
                    });
                    showEventsHome();
                    return;
                }
                
                await loadTables();
                initEventListeners();
                updateUI();
                
                // Mettre à jour l'affichage
                document.getElementById('eventNameDisplay').innerHTML = `
                    <i class="fas fa-calendar-alt"></i>
                    <span>${escapeHtml(currentEvent.name)}</span>
                `;
                updateEventStatusIndicator();
                
                // Mettre à jour le titre
                document.title = `SECURA | Tables - ${currentEvent.name}`;
                
            } catch (error) {
                console.error('Erreur chargement tables:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de charger les tables',
                    confirmButtonColor: '#D97706'
                });
            }
        }

        // Vérifier l'authentification
        async function checkAuth() {
            try {
                currentUser = await storage.getProfile();
                if (!currentUser) {
                    window.location.href = 'login.html';
                    return false;
                }
                return true;
            } catch (error) {
                console.error('Erreur vérification auth:', error);
                window.location.href = 'login.html';
                return false;
            }
        }

        // Charger les tables
        async function loadTables() {
            try {
                showLoader('grid');
                
                const response = await storage.getAllTables(currentEvent.id);
                allTables = response.data || [];
                
                allGuests = storage.getGuestsByEventId(currentEvent.id) || [];

                
                // Trier par numéro de table
                allTables.sort((a, b) => {
                    const numA = parseInt(a.tableNumber) || 0;
                    const numB = parseInt(b.tableNumber) || 0;
                    if (numA !== numB) return numA - numB;
                    return (a.tableNumber || '').localeCompare(b.tableNumber || '');
                });
                
                applyFilters();
                updateStats();
                renderTables();
                
                hideLoader('grid');
                
            } catch (error) {
                console.error('Erreur chargement tables:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de charger les tables',
                    confirmButtonColor: '#D97706'
                });
                hideLoader('grid');
            }
        }

        // Appliquer les filtres
        function applyFilters() {
            filteredTables = [...allTables];
            
            // Réinitialiser la page à 1 quand les filtres changent
            currentPage = 1;
            
            // Filtre par statut
            if (currentFilter !== 'all') {
                switch(currentFilter) {
                    case 'available':
                        filteredTables = filteredTables.filter(table => {
                            const totalSeats = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) || 0;
                            return totalSeats < table.capacity;
                        });
                        break;
                    case 'full':
                        filteredTables = filteredTables.filter(table => {
                            const totalSeats = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) || 0;
                            return totalSeats >= table.capacity;
                        });
                        break;
                    case 'empty':
                        filteredTables = filteredTables.filter(table => 
                            !table.assignedGuests || table.assignedGuests.length === 0
                        );
                        break;
                }
            }
            
            // Filtre par recherche
            if (currentSearch) {
                const searchTerm = currentSearch.toLowerCase();
                filteredTables = filteredTables.filter(table =>
                    table.tableNumber?.toLowerCase().includes(searchTerm) ||
                    table.tableName?.toLowerCase().includes(searchTerm) ||
                    table.location?.toLowerCase().includes(searchTerm) ||
                    table.category?.toLowerCase().includes(searchTerm) ||
                    table.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            updatePagination();
        }

        // Mettre à jour les statistiques
        function updateStats() {
            const totalTables = allTables.length;
            let totalGuests = 0;
            let totalCapacity = 0;
            let occupiedSeats = 0;
            
            allTables.forEach(table => {
                totalCapacity += table.capacity || 0;
                const guestsCount = table.assignedGuests?.length || 0;
                totalGuests += guestsCount;
                
                const seatsOccupied = table.assignedGuests?.reduce((sum, guest) => 
                    sum + (guest.seats || 1), 0) || 0;
                occupiedSeats += seatsOccupied;
            });
            
            const occupancyRate = totalCapacity > 0 ? 
                Math.round((occupiedSeats / totalCapacity) * 100) : 0;
            
            // Mettre à jour les compteurs
            document.getElementById('tablesCount').textContent = filteredTables.length;
            document.getElementById('tablesTableCount').textContent = filteredTables.length;
            document.getElementById('visualTablesCount').textContent = filteredTables.length;
            document.getElementById('statsTablesCount').textContent = filteredTables.length;
            
            // Mettre à jour les statistiques avancées
            updateAdvancedStats();
        }

       // Mettre à jour les statistiques avancées
function updateAdvancedStats() {
    if (currentView !== 'stats') return;
    
    let totalCapacity = 0;
    let occupiedSeats = 0;
    let fullTables = 0;
    let emptyTables = 0;
    let availableTables = 0;
    let totalGuests = 0;
    let totalSeatsUsed = 0;
    let totalQRScans = 0;
    let lastQRScan = null;
    let mostScannedTable = null;
    
    // Nouveaux tableaux pour les graphiques
    let categoryStats = {};
    let capacityDistribution = {};
    
    allTables.forEach(table => {
        totalCapacity += table.capacity || 0;
        const seatsOccupied = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        occupiedSeats += seatsOccupied;
        
        const guestsCount = table.assignedGuests?.length || 0;
        totalGuests += guestsCount;
        totalSeatsUsed += seatsOccupied;
        
        if (seatsOccupied >= table.capacity) fullTables++;
        if (seatsOccupied === 0) emptyTables++;
        if (seatsOccupied < table.capacity && seatsOccupied > 0) availableTables++;
        
        // Statistiques pour le graphique par catégorie
        const category = table.category || 'standard';
        if (!categoryStats[category]) {
            categoryStats[category] = {
                count: 0,
                totalCapacity: 0,
                occupiedSeats: 0
            };
        }
        categoryStats[category].count++;
        categoryStats[category].totalCapacity += table.capacity || 0;
        categoryStats[category].occupiedSeats += seatsOccupied;
        
        // Statistiques pour le graphique de distribution des capacités
        const capacity = table.capacity || 0;
        const capacityRange = getCapacityRange(capacity);
        if (!capacityDistribution[capacityRange]) {
            capacityDistribution[capacityRange] = 0;
        }
        capacityDistribution[capacityRange]++;
        
        // Statistiques QR
        if (table.qrCode?.scanCount) {
            totalQRScans += table.qrCode.scanCount;
            
            if (!lastQRScan || (table.qrCode.lastScan && table.qrCode.lastScan > lastQRScan)) {
                lastQRScan = table.qrCode.lastScan;
            }
            
            if (!mostScannedTable || table.qrCode.scanCount > mostScannedTable.scanCount) {
                mostScannedTable = {
                    name: table.tableName || `Table ${table.tableNumber}`,
                    scanCount: table.qrCode.scanCount
                };
            }
        }
    });
    
    const occupancyRate = totalCapacity > 0 ? 
        Math.round((occupiedSeats / totalCapacity) * 100) : 0;
    
    // Mettre à jour l'interface
    document.getElementById('overallOccupancyRate').textContent = `${occupancyRate}%`;
    document.getElementById('totalOccupiedSeats').textContent = occupiedSeats;
    document.getElementById('totalCapacity').textContent = totalCapacity;
    
    document.getElementById('fullTablesCount').textContent = fullTables;
    document.getElementById('emptyTablesCount').textContent = emptyTables;
    document.getElementById('availableTablesCount').textContent = availableTables;
    
    document.getElementById('totalAssignedGuests').textContent = totalGuests;
    document.getElementById('guestsWithSeats').textContent = totalGuests;
    document.getElementById('totalSeatsUsed').textContent = totalSeatsUsed;
    
    document.getElementById('totalQRScans').textContent = totalQRScans;
    document.getElementById('lastQRScan').textContent = lastQRScan ? 
        new Date(lastQRScan).toLocaleDateString('fr-FR') : 'Jamais';
    document.getElementById('mostScannedTable').textContent = mostScannedTable ? 
        `${mostScannedTable.name} (${mostScannedTable.scanCount})` : 'Aucune';
    

        // AJOUTER APRÈS LES CALCULS EXISTANTS :
    // Calculer les données pour les graphiques avancés
    const radarData = calculateRadarData(categoryStats);
    const lineData = calculateLineData(allTables);
    const bubbleData = calculateBubbleData(allTables);
    const polarData = calculatePolarData(categoryStats);
    
    // Calculer les KPIs
    const kpiData = calculateKPIs(allTables, categoryStats);
    
    // Mettre à jour les KPIs
    document.getElementById('trendValue').textContent = kpiData.trend;
    document.getElementById('efficiencyValue').textContent = kpiData.efficiency + '%';
    document.getElementById('diversityValue').textContent = kpiData.diversity + '%';
    document.getElementById('predictionValue').textContent = kpiData.prediction + '%';
    
    // Rendre tous les graphiques
    renderCategoryChart(categoryStats);
    renderCapacityChart(capacityDistribution);
    renderRadarChart(radarData);
    renderLineChart(lineData);
    renderBubbleChart(bubbleData);
    renderPolarChart(polarData);
}


// Fonctions de calcul pour les graphiques avancés
function calculateRadarData(categoryStats) {
    const categories = Object.keys(categoryStats);
    return {
        labels: categories.map(cat => getCategoryLabel(cat)),
        datasets: [
            {
                label: 'Nombre de tables',
                data: categories.map(cat => categoryStats[cat].count),
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: '#3B82F6',
                borderWidth: 2,
                pointBackgroundColor: '#3B82F6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 10
            },
            {
                label: 'Taux d\'occupation (%)',
                data: categories.map(cat => {
                    const stats = categoryStats[cat];
                    return stats.totalCapacity > 0 ? 
                        Math.round((stats.occupiedSeats / stats.totalCapacity) * 100) : 0;
                }),
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                borderColor: '#8B5CF6',
                borderWidth: 2,
                pointBackgroundColor: '#8B5CF6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6,
                pointHoverRadius: 10
            }
        ]
    };
}

function calculateLineData(tables) {
    // Simuler des données temporelles (pour la démo)
    const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
    const today = new Date().getDay();
    
    return {
        labels: days,
        datasets: [
            {
                label: 'Tables occupées',
                data: days.map((_, index) => {
                    const dayIndex = (today + index) % 7;
                    const base = Math.floor(tables.length * 0.6);
                    const variation = Math.sin(dayIndex * 0.9) * 10;
                    return Math.max(0, Math.min(tables.length, Math.round(base + variation)));
                }),
                borderColor: '#10B981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#10B981',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            },
            {
                label: 'Tables disponibles',
                data: days.map((_, index) => {
                    const dayIndex = (today + index) % 7;
                    const base = Math.floor(tables.length * 0.4);
                    const variation = Math.cos(dayIndex * 0.9) * 10;
                    return Math.max(0, Math.min(tables.length, Math.round(base + variation)));
                }),
                borderColor: '#F59E0B',
                backgroundColor: 'rgba(245, 158, 11, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#F59E0B',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5
            }
        ]
    };
}

function calculateBubbleData(tables) {
    return tables.map(table => {
        const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        const occupancyRate = table.capacity > 0 ? 
            (totalSeats / table.capacity) * 100 : 0;
        
        // Déterminer la catégorie pour la couleur
        let color;
        switch(table.category) {
            case 'vip': color = '#F59E0B'; break;
            case 'family': color = '#8B5CF6'; break;
            case 'speaker': color = '#3B82F6'; break;
            case 'organizer': color = '#10B981'; break;
            default: color = '#D97706';
        }
        
        return {
            x: table.capacity || 0, // Capacité
            y: totalSeats, // Places occupées
            r: Math.max(10, (table.capacity || 0) * 2), // Taille selon capacité
            backgroundColor: color,
            tableNumber: table.tableNumber,
            tableName: table.tableName,
            category: table.category
        };
    });
}

function calculatePolarData(categoryStats) {
    const categories = Object.keys(categoryStats);
    const colors = {
        'vip': '#F59E0B',
        'family': '#8B5CF6',
        'speaker': '#3B82F6',
        'organizer': '#10B981',
        'standard': '#D97706'
    };
    
    return {
        labels: categories.map(cat => getCategoryLabel(cat)),
        datasets: [{
            label: 'Performance',
            data: categories.map(cat => {
                const stats = categoryStats[cat];
                // Score composite: nombre de tables + taux d'occupation
                const countScore = Math.min(stats.count * 10, 100);
                const occupancyScore = stats.totalCapacity > 0 ? 
                    Math.round((stats.occupiedSeats / stats.totalCapacity) * 100) : 0;
                return (countScore + occupancyScore) / 2;
            }),
            backgroundColor: categories.map(cat => colors[cat] + '80'),
            borderColor: categories.map(cat => colors[cat]),
            borderWidth: 2
        }]
    };
}

function calculateKPIs(tables, categoryStats) {
    // Calculer la tendance
    const totalOccupied = tables.reduce((sum, table) => {
        return sum + (table.assignedGuests?.reduce((s, g) => s + (g.seats || 1), 0) || 0);
    }, 0);
    
    const totalCapacity = tables.reduce((sum, table) => sum + (table.capacity || 0), 0);
    const currentRate = totalCapacity > 0 ? Math.round((totalOccupied / totalCapacity) * 100) : 0;
    
    // Simuler une tendance (pour la démo)
    const trend = currentRate > 60 ? Math.min(25, Math.round((currentRate - 60) * 0.5)) : 
                  Math.max(-10, Math.round((currentRate - 40) * 0.3));
    
    // Calculer l'efficacité d'assignation
    const assignedTables = tables.filter(t => 
        t.assignedGuests && t.assignedGuests.length > 0
    ).length;
    const efficiency = tables.length > 0 ? 
        Math.round((assignedTables / tables.length) * 100) : 0;
    
    // Calculer la diversité
    const categories = Object.keys(categoryStats).length;
    const maxCategories = 7; // Nombre maximum de catégories possibles
    const diversity = Math.round((categories / maxCategories) * 100);
    
    // Calculer la prédiction de satisfaction
    const avgOccupancy = currentRate;
    const tableUtilization = efficiency;
    const prediction = Math.round((avgOccupancy * 0.6 + tableUtilization * 0.4) * 0.9);
    
    return {
        trend: trend > 0 ? `+${trend}%` : `${trend}%`,
        efficiency,
        diversity,
        prediction
    };
}


// Fonction pour déterminer la plage de capacité
function getCapacityRange(capacity) {
    if (capacity <= 2) return '2 places';
    if (capacity <= 4) return '3-4 places';
    if (capacity <= 6) return '5-6 places';
    if (capacity <= 8) return '7-8 places';
    if (capacity <= 10) return '9-10 places';
    return '11+ places';
}

// Fonction pour rendre le graphique des catégories
function renderCategoryChart(categoryStats) {
    const ctx = document.getElementById('categoryChart');
    if (!ctx) return;
    
    // Détruire le graphique existant s'il y en a un
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    // Si aucune donnée, afficher un message
    if (Object.keys(categoryStats).length === 0) {
        ctx.innerHTML = `
            <div style="padding: 40px 20px; text-align: center; color: var(--text-color); opacity: 0.5;">
                <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <p>Aucune donnée disponible</p>
            </div>
        `;
        return;
    }
    
    // Préparer les données
    const categories = Object.keys(categoryStats);
    const colors = {
        'vip': '#F59E0B',
        'family': '#8B5CF6',
        'speaker': '#3B82F6',
        'organizer': '#10B981',
        'standard': '#D97706',
        'mariage': '#EC4899',
        'anniversaire': '#6366F1'
    };
    
    const backgroundColors = categories.map(cat => colors[cat] || '#6B7280');
    
    // Créer le graphique
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    canvas.width = ctx.clientWidth;
    canvas.height = 300;
    
    ctx.chart = new Chart(canvas, {
        type: 'doughnut',
        data: {
            labels: categories.map(cat => getCategoryLabel(cat)),
            datasets: [{
                data: categories.map(cat => categoryStats[cat].count),
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color + '80'),
                borderWidth: 2,
                hoverOffset: 15
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'var(--text-color-chart) !important',
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const category = categories[context.dataIndex];
                            const stats = categoryStats[category];
                            const occupancy = stats.totalCapacity > 0 ? 
                                Math.round((stats.occupiedSeats / stats.totalCapacity) * 100) : 0;
                            return [
                                `Tables: ${stats.count}`,
                                `Capacité totale: ${stats.totalCapacity} places`,
                                `Taux d'occupation: ${occupancy}%`
                            ];
                        }
                    }
                }
            },
            animation: {
                animateScale: true,
                animateRotate: true
            }
        }
    });
}

// Fonction pour rendre le graphique des capacités
function renderCapacityChart(capacityDistribution) {
    const ctx = document.getElementById('capacityChart');
    if (!ctx) return;
    
    // Détruire le graphique existant s'il y en a un
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    // Si aucune donnée, afficher un message
    if (Object.keys(capacityDistribution).length === 0) {
        ctx.innerHTML = `
            <div style="padding: 40px 20px; text-align: center; color: var(--text-color); opacity: 0.5;">
                <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 15px;"></i>
                <p>Aucune donnée disponible</p>
            </div>
        `;
        return;
    }
    
    // Préparer les données
    const ranges = Object.keys(capacityDistribution).sort((a, b) => {
        // Trier par capacité croissante
        const getMin = range => parseInt(range.split('-')[0]) || parseInt(range);
        return getMin(a) - getMin(b);
    });
    const counts = ranges.map(range => capacityDistribution[range]);
    
    // Couleurs dégradées
    const baseColor = [217, 119, 6]; // Couleur primaire en RGB
    const backgroundColors = counts.map((_, index) => {
        const alpha = 0.7 + (index * 0.05);
        return `rgba(${baseColor[0]}, ${baseColor[1]}, ${baseColor[2]}, ${alpha})`;
    });
    
    // Créer le graphique
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    canvas.width = ctx.clientWidth;
    canvas.height = 300;
    
    ctx.chart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: ranges,
            datasets: [{
                label: 'Nombre de tables',
                data: counts,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                borderWidth: 2,
                borderRadius: 8,
                hoverBackgroundColor: backgroundColors.map(color => color.replace('0.7', '0.9'))
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: 'var(--text-color-chart)',
                        precision: 0
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: 'var(--text-color)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Tables: ${context.raw}`;
                        }
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
}

// Fonctions de rendu des graphiques avancés
function renderRadarChart(radarData) {
    const ctx = document.getElementById('radarChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    if (!radarData.labels || radarData.labels.length === 0) {
        ctx.innerHTML = '<div class="no-data">Aucune donnée disponible</div>';
        return;
    }
    
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    
    ctx.chart = new Chart(canvas, {
        type: 'radar',
        data: radarData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    angleLines: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    pointLabels: {
                        color: 'var(--text-color-chart)',
                        font: {
                            size: 12
                        }
                    },
                    ticks: {
                        color: 'var(--text-color-chart)',
                        backdropColor: 'transparent'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'var(--text-color-chart)',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw}`;
                        }
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        }
    });
}

function renderLineChart(lineData) {
    const ctx = document.getElementById('lineChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    
    ctx.chart = new Chart(canvas, {
        type: 'line',
        data: lineData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color)'
                    }
                },
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color-chart)',
                        callback: function(value) {
                            return Math.round(value);
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'var(--text-color-chart)',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${Math.round(context.parsed.y)} tables`;
                        }
                    }
                }
            },
            animation: {
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });
}

function renderBubbleChart(bubbleData) {
    const ctx = document.getElementById('bubbleChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    if (bubbleData.length === 0) {
        ctx.innerHTML = '<div class="no-data">Aucune donnée disponible</div>';
        return;
    }
    
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    
    // Regrouper par couleur pour les datasets
    const datasetsByColor = {};
    bubbleData.forEach(bubble => {
        if (!datasetsByColor[bubble.backgroundColor]) {
            datasetsByColor[bubble.backgroundColor] = {
                label: getCategoryLabel(bubble.category) || 'Standard',
                data: [],
                backgroundColor: bubble.backgroundColor,
                borderColor: bubble.backgroundColor.replace('80', 'FF'),
                borderWidth: 1
            };
        }
        datasetsByColor[bubble.backgroundColor].data.push({
            x: bubble.x,
            y: bubble.y,
            r: bubble.r
        });
    });
    
    ctx.chart = new Chart(canvas, {
        type: 'bubble',
        data: {
            datasets: Object.values(datasetsByColor)
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Capacité',
                        color: 'var(--text-color)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Places occupées',
                        color: 'var(--text-color)'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: 'var(--text-color-chart)',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const bubble = bubbleData.find(b => 
                                b.x === context.parsed.x && 
                                b.y === context.parsed.y
                            );
                            if (bubble) {
                                return [
                                    `Table: #${bubble.tableNumber}`,
                                    `Nom: ${bubble.tableName || 'Sans nom'}`,
                                    `Catégorie: ${getCategoryLabel(bubble.category)}`,
                                    `Capacité: ${bubble.x} places`,
                                    `Occupé: ${bubble.y} places`
                                ];
                            }
                            return `Capacité: ${context.parsed.x}, Occupé: ${context.parsed.y}`;
                        }
                    }
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        }
    });
}

function renderPolarChart(polarData) {
    const ctx = document.getElementById('polarChart');
    if (!ctx) return;
    
    if (ctx.chart) {
        ctx.chart.destroy();
    }
    
    if (!polarData.labels || polarData.labels.length === 0) {
        ctx.innerHTML = '<div class="no-data">Aucune donnée disponible</div>';
        return;
    }
    
    ctx.innerHTML = '<canvas></canvas>';
    const canvas = ctx.querySelector('canvas');
    
    ctx.chart = new Chart(canvas, {
        type: 'polarArea',
        data: polarData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'var(--text-color-chart)',
                        backdropColor: 'transparent'
                    },
                    pointLabels: {
                        color: 'var(--text-color)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'var(--text-color-chart)',
                        padding: 20,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.label}: Score ${Math.round(context.raw)}`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 2000,
                easing: 'easeOutQuart'
            }
        }
    });
}


function destroyCharts() {
    const categoryChart = document.getElementById('categoryChart');
    const capacityChart = document.getElementById('capacityChart');
    const radarChart = document.getElementById('radarChart');
    const lineChart = document.getElementById('lineChart');
    const bubbleChart = document.getElementById('bubbleChart');
    const polarChart = document.getElementById('polarChart');
    
     const charts = [
        categoryChart, capacityChart, radarChart, 
        lineChart, bubbleChart, polarChart
    ];
    
    charts.forEach(chart => {
        if (chart && chart.chart) {
            chart.chart.destroy();
            chart.chart = null;
        }
    });
}




        // Rendre les tables
        function renderTables() {
            const startIndex = (currentPage - 1) * tablesPerPage;
            const endIndex = startIndex + tablesPerPage;
            const tablesToShow = filteredTables.slice(startIndex, endIndex);
            
            // Afficher/masquer l'état vide
            const emptyStates = ['grid', 'table', 'visual', 'stats','vector'];
            emptyStates.forEach(view => {
                const emptyState = document.getElementById(`emptyState${view.charAt(0).toUpperCase() + view.slice(1)}`);
                if (emptyState) {
                    emptyState.style.display = filteredTables.length === 0 ? 'flex' : 'none';
                }
            });
            
            hideLoader('all');
    
            // Mettre à jour la pagination
            updatePagination();
            
            // Mode grille
            if (currentView === 'grid') {
                renderGridView(tablesToShow);
            } else if (currentView === 'table') {
                renderTableView(tablesToShow);
            } else if (currentView === 'visual') {
                renderVisualView(tablesToShow);
            }else if (currentView === 'vector') {
                renderVectorView(tablesToShow);
            } else if (currentView === 'stats') {
                setTimeout(() => {
                    updateAdvancedStats();
                }, 100);
            }

            setTimeout(() => updateViewHeader(currentView), 10);
        }

        // Rendre la vue grille avec aperçu amélioré
        // Fonctions pour les images de fond des tables


        const fallbackImages = [
    'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?w=800&q=80', // Restaurant chic
    'https://images.unsplash.com/photo-1554679665-f5537f187268?w=800&q=80', // Salle de réception
    'https://images.unsplash.com/photo-1519167758481-83f550bb49b3?w=800&q=80', // Mariage
    'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=800&q=80', // Anniversaire
    'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=800&q=80', // Conférence
    'https://images.unsplash.com/photo-1511578314322-379afb476865?w=800&q=80', // Gala
    'https://images.unsplash.com/photo-1492684223066-e9e4aab4d25e?w=800&q=80', // Cocktail
    'https://images.unsplash.com/photo-1555244162-803834f70033?w=800&q=80'  // Dîner élégant
];


function getTableBackgroundImage(table) {
    const category = (table.category || 'standard').toLowerCase();
    const tableIndex = allTables.findIndex(t => t.id === table.id);
    const isFull = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) >= (table.capacity || 0);
    const isEmpty = !table.assignedGuests || table.assignedGuests.length === 0;
    
    // Images prestigieuses selon la catégorie
    const backgroundImages = {
        'vip': 'https://images.unsplash.com/photo-1519167758481-83f550bb49b3?w=800&q=80',
        'family': 'https://images.unsplash.com/photo-1464349095431-e9a21285b5f3?w=800&q=80',
        'speaker': 'https://images.unsplash.com/photo-1540575467063-178a50c2df87?w=800&q=80',
        'organizer': 'https://images.unsplash.com/photo-1511578314322-379afb476865?w=800&q=80',
        'mariage': 'https://images.unsplash.com/photo-1465495976277-4387d4b0e4a6?w=800&q=80',
        'anniversaire': 'https://images.unsplash.com/photo-1530103862676-de8c9debad1d?w=800&q=80',
        'standard': 'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?w=800&q=80'
    };
    
    return backgroundImages[category] || backgroundImages.standard || fallbackImages[tableIndex % fallbackImages.length];
}

// Fonction pour obtenir les couleurs selon la catégorie
function getCategoryColor(category) {
    const colors = {
        'vip': '#F59E0B',
        'family': '#8B5CF6',
        'speaker': '#3B82F6',
        'organizer': '#10B981',
        'standard': '#D97706',
        'mariage': '#EC4899',
        'anniversaire': '#6366F1'
    };
    
    return colors[category] || colors.standard;
}

// Fonction pour afficher le statut
function getTableStatus(table) {
    const totalSeats = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) || 0;
    const capacity = table.capacity || 0;
    
    if (totalSeats >= capacity) return 'full';
    if (totalSeats === 0) return 'empty';
    return 'available';
}

// Rendre la vue grille avec le nouveau design
function renderGridView(tables) {
    const grid = document.getElementById('tablesGrid');
    if (!grid) return;
    
    grid.innerHTML = '';
    
    tables.forEach(table => {
        const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        const availableSeats = Math.max(0, (table.capacity || 0) - totalSeats);
        const occupancyRate = table.capacity > 0 ? 
            Math.round((totalSeats / table.capacity) * 100) : 0;
        const status = getTableStatus(table);
        
        // Grouper les invités par siège
        const guestGroups = {};
        table.assignedGuests?.forEach(guest => {
            const seats = guest.seats || 1;
            if (!guestGroups[seats]) guestGroups[seats] = [];
            guestGroups[seats].push(guest);
        });
        
        // Créer les indicateurs de siège avec carrés
        let seatSquares = '';
        let seatIndex = 0;

        // Trier les groupes par nombre de sièges
        Object.keys(guestGroups).sort((a, b) => b - a).forEach(seats => {
            const groupSize = parseInt(seats);
            const group = guestGroups[seats];
            
            group.forEach(guest => {
                for (let i = 0; i < groupSize && seatIndex < (table.capacity || 0); i++) {
                    const isFirst = i === 0;
                    
                    seatSquares += `
                        <div class="seat-square occupied ${groupSize > 1 ? 'group' : ''}" 
                            data-group="${isFirst ? groupSize : ''}"
                            title="${isFirst ? guest.guestName + ' (' + groupSize + ' places)' : 'Place occupée'}"
                            style="${isFirst ? 'border-color: ' + getCategoryColor(table.category) + ';' : ''}">
                            ${isFirst ? getInitials(guest.guestName) : ''}
                        </div>
                    `;
                    seatIndex++;
                }
            });
        });

        // Ajouter les sièges disponibles
        for (let i = seatIndex; i < (table.capacity || 0); i++) {
            seatSquares += `<div class="seat-square available" title="Place disponible"></div>`;
        }
                
        const tableCard = document.createElement('div');
        tableCard.className = `table-card ${status}`;
        tableCard.dataset.category = table.category || 'standard';
        tableCard.dataset.tableId = table.id;
        tableCard.onclick = (e) => {
            if (e.target.closest('.table-card-toggle') || 
                e.target.closest('.table-actions') || 
                e.target.closest('.guests-toggle-btn') ||
                e.target.closest('.add-guest-btn') ||
                e.target.closest('.action-btn')) {
                return;
            }
            showEnhancedTableDetails(table);
        };
        
        tableCard.innerHTML = `
            <!-- Image de fond -->
            <div class="table-card-image" 
                 style="background-image: url('${getTableBackgroundImage(table)}')"></div>
            
            <!-- En-tête toujours visible -->
            <div class="table-card-header">
                <!-- Bouton de toggle pour dérouler le contenu -->
                <button class="table-card-toggle" onclick="toggleTableCardContent(this)" 
                        style="position: absolute; top: 15px; right: 15px; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 10; transition: all 0.3s ease;">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <!-- Info principale toujours visible -->
                <div class="table-card-main-info">
                    <div class="table-number">${escapeHtml(table.tableNumber)}</div>
                    ${table.tableName ? `<div class="table-name">${escapeHtml(table.tableName)}</div>` : ''}
                    <div class="table-meta">
                        <div class="table-category">
                            <i class="fas fa-tag"></i>
                            ${escapeHtml(getCategoryLabel(table.category || 'standard'))}
                        </div>
                        <div class="table-status status-${status}">
                            <i class="fas ${status === 'full' ? 'fa-ban' : status === 'empty' ? 'fa-circle' : 'fa-check-circle'}"></i>
                            <span>${status === 'full' ? 'Complète' : status === 'empty' ? 'Vide' : `${availableSeats} libres`}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contenu (caché par défaut) -->
            <div class="table-card-content">
                <!-- Indicateur de capacité -->
                <div class="capacity-indicator">
                    <div class="capacity-header">
                        <div class="capacity-label">
                            <i class="fas fa-chart-pie"></i>
                            Taux d'occupation
                        </div>
                        <div class="capacity-percentage">${occupancyRate}%</div>
                    </div>
                    <div class="capacity-visual-grid">
                        ${seatSquares}
                    </div>
                    <div class="capacity-stats">
                        <span>${totalSeats} occupée(s)</span>
                        <span>${availableSeats} disponible(s)</span>
                    </div>
                </div>
                
                <!-- Liste des invités -->
                <div class="table-guests">
                    <button class="guests-toggle-btn" onclick="event.stopPropagation(); toggleGuestsList('${table.id}')">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%; gap: 10px;">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1;">
                                <i class="fas fa-users"></i>
                                <span>Invités (${table.assignedGuests?.length || 0})</span>
                            </div>
                            <i class="fas fa-chevron-down toggle-icon"></i>
                        </div>
                    </button>
                    
                    <div class="guests-list-container" id="guests-list-${table.id}" style="display: none;">
                        ${table.assignedGuests && table.assignedGuests.length > 0 ? `
                            <div class="guests-list">
                                ${renderGuestList(table.assignedGuests, table.id)}
                            </div>
                        ` : `
                            <div class="no-guests">
                                <i class="fas fa-user-plus"></i>
                                <p>Aucun invité assigné</p>
                            </div>
                        `}
                        
                        ${availableSeats > 0 ? `
                            <button class="add-guest-btn" onclick="event.stopPropagation(); addGuestToTable('${table.id}')">
                                <i class="fas fa-user-plus"></i>
                                Ajouter un invité
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
            
            <!-- Pied de carte (caché par défaut) -->
            <div class="table-card-footer">
                ${table.location ? `
                    <div class="table-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${escapeHtml(table.location)}</span>
                    </div>
                ` : `<div></div>`}
                
                <div class="table-actions" onclick="event.stopPropagation()">
                    <button class="action-btn edit" 
                            data-tooltip="Modifier"
                            onclick="event.stopPropagation(); openEditTableModal('${table.id}')">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="action-btn qr" 
                            data-tooltip="QR Code"
                            onclick="event.stopPropagation(); generateTableQR('${table.id}')">
                        <i class="bi bi-qr-code"></i>
                    </button>
                    <button class="action-btn delete" 
                            data-tooltip="Supprimer"
                            onclick="event.stopPropagation(); deleteTable('${table.id}')">
                        <i class="bi bi-trash3"></i>
                    </button>
                </div>
            </div>
        `;
        
        grid.appendChild(tableCard);
    });
    
    initializeGuestInteractions();
}

window.toggleTableCardContent = function(toggleBtn) {
    const tableCard = toggleBtn.closest('.table-card');
    const content = tableCard.querySelector('.table-card-content');
    const footer = tableCard.querySelector('.table-card-footer');
    const icon = toggleBtn.querySelector('i');
    
    const isActive = tableCard.classList.contains('active');
    
    if (!isActive) {
        // Ouvrir cette carte
        tableCard.classList.add('active');
        content.style.display = 'flex';
        footer.style.display = 'flex';
        icon.className = 'fas fa-chevron-up';
        toggleBtn.style.background = 'var(--primary)';
        toggleBtn.style.borderColor = 'var(--primary)';
    } else {
        tableCard.classList.remove('active');
        content.style.display = 'none';
        footer.style.display = 'none';
        icon.className = 'fas fa-chevron-down';
        toggleBtn.style.background = 'rgba(255,255,255,0.2)';
        toggleBtn.style.borderColor = 'rgba(255,255,255,0.3)';
    }
};


// Fonction pour basculer l'affichage de la liste des invités
window.toggleGuestsList = function(tableId) {
    const listContainer = document.getElementById(`guests-list-${tableId}`);
    const toggleBtn = document.querySelector(`button[onclick*="toggleGuestsList('${tableId}')"]`);
    
    if (listContainer) {
        if (listContainer.style.display === 'none') {
            listContainer.style.display = 'block';
            if (toggleBtn) toggleBtn.classList.add('expanded');
        } else {
            listContainer.style.display = 'none';
            if (toggleBtn) toggleBtn.classList.remove('expanded');
        }
    }
};

// Fonction pour rendre la liste des invités avec système d'expansion
function renderGuestList(guests, tableId) {
    return guests.map((guest, index) => `
        <div class="guest-item " id="guest-${tableId}-${guest.guestId}" data-guest-id="${guest.guestId}">
            <div class="guest-item-header" onclick="toggleGuestDetails('${tableId}', '${guest.guestId}', event)">
                <div class="guest-avatar  ${guest.isVip ? 'vip' : ''}">
                    ${getInitials(guest.guestName)}
                </div>
                <div class="guest-info" style="justify-content:space-between;">
                    <div class="guest-name">${escapeHtml(guest.guestName)}</div>
                    <div class="guest-meta">
                        <div class="guest-seats">
                            <i class="fas fa-chair"></i>
                            ${guest.seats || 1} place(s)
                        </div>
                        
                    </div>
                </div>
                <button class="guest-expand-btn">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="guest-details" style="display: none;">
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">Email</div>
                        <div class="detail-value">${guest.email || 'Non renseigné'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Téléphone</div>
                        <div class="detail-value">${guest.phone || 'Non renseigné'}</div>
                    </div>
                    


                    <div class="detail-item">
                        <div class="detail-label">Assigné le</div>
                        <div class="detail-value">${guest.assignedAt ? new Date(guest.assignedAt).toLocaleDateString('fr-FR') : 'Non défini'}</div>
                    </div>

                    <div class="detail-item">
                        <div class="detail-label status-confirmed">Status</div>
                        <div class="detail-value">
                            ${guest.confirmed ? 'Confirmé' : 'En attente'}</div>
                    </div>
                </div>
                <div class="guest-actions">
                    <button class="action-btn-sm move" onclick="event.stopPropagation(); moveGuestToAnotherTable('${guest.guestId}', '${tableId}')">
                        <i class="fas fa-exchange-alt"></i>
                        Déplacer
                    </button>
                    <button class="action-btn-sm qr" onclick="event.stopPropagation(); viewGuestQR('${guest.guestId}')">
                        <i class="bi bi-qr-code"></i>
                        QR
                    </button>
                    <button class="action-btn-sm remove" onclick="event.stopPropagation(); removeGuestFromTable('${tableId}', '${guest.guestId}')">
                        <i class="bi bi-trash3"></i>
                        Retirer
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}



// Fonction pour initialiser les interactions des invités
function initializeGuestInteractions() {
    // Les écouteurs sont ajoutés dans la fonction toggleGuestDetails
}

// Fonction pour basculer l'affichage des détails d'un invité
function toggleGuestDetails(tableId, guestId, event) {
    event.stopPropagation();
    
    // Fermer tous les détails ouverts
    document.querySelectorAll('.guest-item.expanded').forEach(item => {
        if (!item.id.includes(`${tableId}-${guestId}`)) {
            item.classList.remove('expanded');
            const details = item.querySelector('.guest-details');
            const btn = item.querySelector('.guest-expand-btn');
            if (details) details.style.display = 'none';
            if (btn) {
                btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
                btn.classList.remove('expanded');
            }
        }
    });
    
    const guestItem = document.getElementById(`guest-${tableId}-${guestId}`);
    const details = guestItem.querySelector('.guest-details');
    const btn = guestItem.querySelector('.guest-expand-btn');
    
    if (details.style.display === 'none') {
      
        guestItem.classList.add('expanded');
        details.style.display = 'block';
        btn.innerHTML = '<i class="fas fa-chevron-up"></i>';
        btn.classList.add('expanded');
    } else {
        guestItem.classList.remove('expanded');
        details.style.display = 'none';
        btn.innerHTML = '<i class="fas fa-chevron-down"></i>';
        btn.classList.remove('expanded');
    }
}




// Fonction pour afficher les détails améliorés de la table
async function showEnhancedTableDetails(table) {
    const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
        sum + (guest.seats || 1), 0) || 0;
    const availableSeats = Math.max(0, table.capacity - totalSeats);
    const occupancyRate = table.capacity > 0 ? 
        Math.round((totalSeats / table.capacity) * 100) : 0;
    
    // Obtenir les détails complets des invités
    const guestDetails = await Promise.all(
        (table.assignedGuests || []).map(async guest => {
            const fullGuest = await storage.getGuestById(guest.guestId);
            return {
                ...guest,
                email: fullGuest?.email || '',
                phone: fullGuest?.phone || '',
                company: fullGuest?.company || '',
                notes: fullGuest?.notes || ''
            };
        })
    );

    // Grouper les invités par siège
    const guestGroups = {};
    table.assignedGuests?.forEach(guest => {
        const seats = guest.seats || 1;
        if (!guestGroups[seats]) guestGroups[seats] = [];
        guestGroups[seats].push(guest);
    });
    
    // Créer les indicateurs de siège avec carrés
    let seatSquares = '';
    let seatIndex = 0;

    // Trier les groupes par nombre de sièges
    Object.keys(guestGroups).sort((a, b) => b - a).forEach(seats => {
        const groupSize = parseInt(seats);
        const group = guestGroups[seats];
        
        group.forEach(guest => {
            for (let i = 0; i < groupSize && seatIndex < (table.capacity || 0); i++) {
                const isFirst = i === 0;
                
                seatSquares += `
                    <div class="seat-square occupied ${groupSize > 1 ? 'group' : ''}" 
                        data-group="${isFirst ? groupSize : ''}"
                        title="${isFirst ? guest.guestName + ' (' + groupSize + ' places)' : 'Place occupée'}"
                        style="${isFirst ? 'border-color: ' + getCategoryColor(table.category) + '40;' : ''}">
                        ${isFirst ? getInitials(guest.guestName) : ''}
                    </div>
                `;
                seatIndex++;
            }
        });
    });

    // Ajouter les sièges disponibles
    for (let i = seatIndex; i < (table.capacity || 0); i++) {
        seatSquares += `<div class="seat-square available detail" title="Place disponible"></div>`;
    }

    await Swal.fire({
        title: `${escapeHtml(table.tableName)} - Détails`,
        html: `
        <div style="max-width: 900px; margin: 0 auto; padding: 0;">
            <!-- EN-TÊTE AMÉLIORÉE -->
            <div style="position: relative; border-radius: 12px;padding:3rem; overflow: hidden; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                <!-- Image de fond avec overlay -->
                <div style="position: absolute; inset: 0; background: url('https://media.istockphoto.com/id/493839116/fr/photo/d%C3%A9corations-centrales-des-tables-lors-dune-r%C3%A9ception-de-mariage.jpg?s=612x612&w=0&k=20&c=y2C-EN_Z2Pegk2zHrH_JJg2J3AQOGVCIpbLREEjRmKY='); background-size: cover; background-position: center; filter: brightness(0.7) contrast(1.1);"></div>
                <div style="position: absolute; inset: 0; background: linear-gradient(45deg, rgba(0,0,0,0.6) 25%, rgba(0,0,0,0.3) 50%, transparent 75%)"></div>
                
                <!-- Contenu de l'en-tête -->
                <div style="position: relative; z-index: 2; padding: 25px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                        
                        
                        <!-- Informations principales -->
                        <div style="flex: 1; min-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 8px; flex-wrap: wrap;">
                                <h1 style="font-size: 1.8rem; font-weight: 800; color: white; margin: 0; line-height: 1.2;">
                                    Table #${escapeHtml(table.tableNumber)}
                                </h1>
                                <div style="background: ${getCategoryColor(table.category)}; color: white; padding: 4px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-tag"></i>
                                    ${getCategoryLabel(table.category || 'standard')}
                                </div>
                            </div>
                            
                          
                           
                        </div>
                    </div>
                    
                   
                </div>
            </div>

            <!-- Section occupation détaillée -->
            <div class="capacity-indicator detail" style="margin-bottom: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                    <div style="font-weight: 700; color: var(--text-color); font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-chair" style="color: var(--primary);"></i>
                        Répartition visuelle des places
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-color);">
                            <div style="width: 14px; height: 14px; border-radius: 4px; background: var(--primary);"></div>
                            <span>Occupée</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px; font-size: 0.85rem; color: var(--text-color);">
                            <div style="width: 14px; height: 14px; border-radius: 4px; background: var(--hover-bg); border: 1px dashed rgba(0,0,0,0.4);"></div>
                            <span>Disponible</span>
                        </div>
                    </div>
                </div>
                
                <div class="capacity-visual-grid">
                    ${seatSquares}
                </div>
                
               
                            <!-- Stats rapides en grille -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 15px;">
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; backdrop-filter: blur(5px);">
                                    <div style="font-size: 1.8rem; font-weight: 800; color: var(--text-color); margin-bottom: 4px;">${table.capacity}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-color); display: flex; align-items: center; justify-content: center; gap: 5px;">
                                        <i class="fas fa-chair"></i> Capacité
                                    </div>
                                </div>
                                
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; backdrop-filter: blur(5px);">
                                    <div style="font-size: 1.8rem; font-weight: 800; color: ${occupancyRate === 100 ? '#EF4444' : occupancyRate >= 75 ? '#F59E0B' : '#10B981'}; margin-bottom: 4px;">${occupancyRate}%</div>
                                    <div style="font-size: 0.8rem; color: var(--text-color); display: flex; align-items: center; justify-content: center; gap: 5px;">
                                        <i class="fas fa-chart-pie"></i> Occupation
                                    </div>
                                </div>
                                
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; backdrop-filter: blur(5px);">
                                    <div style="font-size: 1.8rem; font-weight: 800; color: ${availableSeats === 0 ? '#EF4444' : '#10B981'}; margin-bottom: 4px;">${availableSeats}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-color); display: flex; align-items: center; justify-content: center; gap: 5px;">
                                        <i class="fas fa-user-check"></i> Libres
                                    </div>
                                </div>
                                
                                <div style="text-align: center; background: rgba(255,255,255,0.1); padding: 12px; border-radius: 10px; backdrop-filter: blur(5px);">
                                    <div style="font-size: 1.8rem; font-weight: 800; color: var(--info); margin-bottom: 4px;">${guestDetails.length}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-color); display: flex; align-items: center; justify-content: center; gap: 5px;">
                                        <i class="fas fa-users"></i> Invités
                                    </div>
                                </div>
                            </div>
            </div>
            
            <!-- Liste des invités -->
            <div style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 10px;">
                    <div style="font-weight: 700; color: var(--text-color); font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-users" style="color: var(--primary);"></i>
                        Invités assignés (${guestDetails.length})
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button id="searchGuestsBtn" style="background: var(--primary); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px; font-size: 0.9rem;">
                            <i class="fas fa-search"></i>
                            Rechercher
                        </button>
                        ${availableSeats > 0 ? `
                            <button id="quickAddBtn" style="background: var(--success); color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 6px; font-size: 0.9rem;">
                                <i class="fas fa-user-plus"></i>
                                Ajouter
                            </button>
                        ` : ''}
                    </div>
                </div>
                
                <div id="guestsSearchContainer" style="margin-bottom: 15px; display: none; animation: slideDown 0.3s ease;">
                    <input type="text" id="guestsSearchInput" placeholder="Rechercher un invité par nom, email..." 
                           style="width: 100%; padding: 10px 14px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--input-bg); color: var(--input-text); font-size: 0.95rem;">
                </div>
                
                <div style="max-height: 350px; overflow-y: auto; padding-right: 8px;">
                    ${guestDetails.length > 0 ? renderEnhancedGuestList(guestDetails, table.id) : `
                        <div style="text-align: center; padding: 30px 15px; color: var(--text-color); opacity: 0.5; background: var(--hover-bg); border-radius: 10px;">
                            <i class="fas fa-user-plus" style="font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5;"></i>
                            <p style="font-size: 1.1rem; margin-bottom: 8px; font-weight: 600;">Aucun invité assigné</p>
                            <p style="font-size: 0.9rem; opacity: 0.7; margin-bottom: 15px;">Ajoutez des invités pour commencer à remplir cette table</p>
                            ${availableSeats > 0 ? `
                                <button id="addFirstGuestBtn" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem;">
                                    <i class="fas fa-user-plus"></i>
                                    Ajouter le premier invité
                                </button>
                            ` : ''}
                        </div>
                    `}
                </div>
            </div>
            
            <!-- Actions rapides -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <button id="addMoreGuestsBtn" style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem;">
                    <i class="fas fa-user-plus"></i>
                    Ajouter des invités
                </button>
                
                <button id="editTableBtn" style="background: var(--info); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem;">
                    <i class="bi bi-pencil-square"></i>
                    Modifier la table
                </button>
                
                <button id="viewQrBtn" style="background: var(--success); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.95rem;">
                    <i class="bi bi-qr-code"></i>
                    QR Code
                </button>
            </div>
        </div>
        
        <style>
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                    max-height: 0;
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                    max-height: 200px;
                }
            }
            
            .capacity-visual-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
                gap: 6px;
                margin-bottom: 15px;
            }
            
            .seat-square {
                width: 30px;
                height: 30px;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.7rem;
                font-weight: 600;
                color: white;
                transition: all 0.3s ease;
                position: relative;
            }
            
            .seat-square.occupied {
                background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                border: 2px solid rgba(255,255,255,0.2);
                box-shadow: 0 3px 6px rgba(217, 119, 6, 0.2);
            }
            
            .seat-square.occupied.group::after {
                content: attr(data-group);
                position: absolute;
                top: -5px;
                right: -5px;
                background: var(--warning);
                color: white;
                font-size: 0.55rem;
                padding: 1px 4px;
                border-radius: 8px;
                min-width: 12px;
                text-align: center;
                border: 1.5px solid white;
            }
            
            .seat-square.available {
                background: rgba(0,0,0,0.03);
                border: 2px dashed rgba(0,0,0,0.15);
            }
            
            .seat-square:hover {
                transform: scale(1.1);
                z-index: 10;
            }
            
            @media (max-width: 768px) {
                .capacity-visual-grid {
                    grid-template-columns: repeat(auto-fill, minmax(28px, 1fr));
                    gap: 5px;
                }
                
                .seat-square {
                    width: 28px;
                    height: 28px;
                    font-size: 0.65rem;
                }
            }
        </style>
        `,
        width: '900px',
        padding: '20px',
        showConfirmButton: false,
        showCloseButton: true,
        background: 'var(--card-bg)',
        customClass: {
            popup: 'swal2-popup-compact',
            htmlContainer: 'swal2-html-container-compact'
        },
        didOpen: () => {
            // Gérer la recherche d'invités
            const searchBtn = document.getElementById('searchGuestsBtn');
            const searchContainer = document.getElementById('guestsSearchContainer');
            const searchInput = document.getElementById('guestsSearchInput');
            
            if (searchBtn && searchContainer) {
                searchBtn.addEventListener('click', () => {
                    searchContainer.style.display = searchContainer.style.display === 'none' ? 'block' : 'none';
                    if (searchContainer.style.display === 'block') {
                        setTimeout(() => searchInput.focus(), 100);
                    }
                });
                
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const term = e.target.value.toLowerCase();
                        const guestItems = document.querySelectorAll('.enhanced-guest-item');
                        
                        guestItems.forEach(item => {
                            const name = item.querySelector('.guest-name-full')?.textContent.toLowerCase() || '';
                            const email = item.querySelector('.guest-email')?.textContent.toLowerCase() || '';
                            
                            if (name.includes(term) || email.includes(term)) {
                                item.style.display = 'flex';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    });
                }
            }
            
            // Gérer les boutons d'action
            document.getElementById('addMoreGuestsBtn')?.addEventListener('click', () => {
                Swal.close();
                addGuestToTable(table.id);
            });
            
            document.getElementById('quickAddBtn')?.addEventListener('click', () => {
                Swal.close();
                addGuestToTable(table.id);
            });
            
            document.getElementById('addFirstGuestBtn')?.addEventListener('click', () => {
                Swal.close();
                addGuestToTable(table.id);
            });
            
            document.getElementById('editTableBtn')?.addEventListener('click', () => {
                Swal.close();
                openEditTableModal(table.id);
            });
            
            document.getElementById('viewQrBtn')?.addEventListener('click', () => {
                Swal.close();
                generateTableQR(table.id);
            });
            
            // Initialiser l'accordéon des invités
            initializeEnhancedGuestAccordion();
        }
    });
}

// Fonction pour rendre la liste des invités améliorée
function renderEnhancedGuestList(guests, tableId) {
    return guests.map((guest, index) => `
        <div class="enhanced-guest-item" data-guest-id="${guest.guestId}" 
             style="background: var(--hover-bg); border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid var(--border-color);">
            <div class="guest-summary" style="display: flex; align-items: center; gap: 15px; cursor: pointer;">
                <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem;">
                    ${getInitials(guest.guestName)}
                </div>
                <div style="flex: 1;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <div class="guest-name-full" style="font-weight: 700; color: var(--text-color); font-size: 1.1rem;">
                            ${escapeHtml(guest.guestName)}
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <div style="background: ${guest.confirmed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)'}; color: ${guest.confirmed ? 'var(--success)' : 'var(--warning)'}; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                ${guest.confirmed ? 'Confirmé' : 'En attente'}
                            </div>
                            <button class="expand-guest-btn" style="background: none; border: none; color: var(--text-color); opacity: 0.6; cursor: pointer; padding: 5px;">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                    <div style="display: flex; gap: 20px; font-size: 0.9rem; color: var(--text-color); opacity: 0.7;">
                        <div class="guest-email">
                            <i class="fas fa-envelope"></i> ${escapeHtml(guest.email || 'Non renseigné')}
                        </div>
                        <div>
                            <i class="fas fa-chair"></i> ${guest.seats || 1} place(s)
                        </div>
                        ${guest.phone ? `
                            <div>
                                <i class="fas fa-phone"></i> ${escapeHtml(guest.phone)}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            <div class="guest-full-details" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.6; margin-bottom: 5px;">Société</div>
                        <div style="color: var(--text-color);">${escapeHtml(guest.company || 'Non renseigné')}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.6; margin-bottom: 5px;">Assigné le</div>
                        <div style="color: var(--text-color);">${guest.assignedAt ? new Date(guest.assignedAt).toLocaleDateString('fr-FR', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : 'Non défini'}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.6; margin-bottom: 5px;">Notes</div>
                        <div style="color: var(--text-color);">${escapeHtml(guest.notes || 'Aucune note')}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.6; margin-bottom: 5px;">Statut QR</div>
                        <div style="color: ${guest.qrScanned ? 'var(--success)' : 'var(--warning)'};">
                            ${guest.qrScanned ? 'Scanné' : 'Non scanné'}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button onclick="moveGuestToAnotherTable('${guest.guestId}', '${tableId}')" 
                            style="flex: 1; background: rgba(59, 130, 246, 0.1); color: var(--info); border: 1px solid rgba(59, 130, 246, 0.3); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="fas fa-exchange-alt"></i>
                        Déplacer
                    </button>
                    <button onclick="viewGuestQR('${guest.guestId}')" 
                            style="flex: 1; background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="bi bi-qr-code"></i>
                        QR Code
                    </button>
                    <button onclick="removeGuestFromTable('${tableId}', '${guest.guestId}')" 
                            style="flex: 1; background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <i class="bi bi-trash3"></i>
                        Retirer
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}


function initializeEnhancedGuestAccordion() {
    document.querySelectorAll('.enhanced-guest-item .guest-summary').forEach(summary => {
        summary.addEventListener('click', function() {
            const parent = this.closest('.enhanced-guest-item');
            const details = parent.querySelector('.guest-full-details');
            const btn = parent.querySelector('.expand-guest-btn i');
            
            // Fermer tous les autres détails
            document.querySelectorAll('.enhanced-guest-item').forEach(item => {
                if (item !== parent) {
                    const otherDetails = item.querySelector('.guest-full-details');
                    const otherBtn = item.querySelector('.expand-guest-btn i');
                    if (otherDetails) otherDetails.style.display = 'none';
                    if (otherBtn) otherBtn.className = 'fas fa-chevron-down';
                }
            });
            
            // Basculer l'élément courant
            if (details.style.display === 'none' || !details.style.display) {
                details.style.display = 'block';
                btn.className = 'fas fa-chevron-up';
            } else {
                details.style.display = 'none';
                btn.className = 'fas fa-chevron-down';
            }
        });
    });
}



// Fonction pour ajouter un invité à une table
async function addGuestToTable(tableId) {
    try {
        // Récupérer la table
        const table = allTables.find(t => t.id === tableId);
        if (!table) return;
        
        // Récupérer les invités disponibles
        const guests = await storage.getAllGuests({ eventId: currentEvent.id });
        const availableGuests = guests.filter(guest => 
            !guest.tableId && guest.eventId === currentEvent.id
        );
        
        if (availableGuests.length === 0) {
            await Swal.fire({
                icon: 'info',
                title: 'Aucun invité disponible',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-users-slash" style="font-size: 4rem; color: var(--warning); margin-bottom: 15px;"></i>
                        <p>Tous les invités sont déjà assignés à des tables.</p>
                        <p style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem; margin-top: 10px;">
                            Créez d'abord de nouveaux invités pour les assigner.
                        </p>
                    </div>
                `,
                confirmButtonColor: '#D97706'
            });
            return;
        }
        
        // Calculer les places disponibles
        const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        const availableSeats = Math.max(0, table.capacity - totalSeats);
        
        // Variable pour stocker les invités temporairement sélectionnés
        let tempSelectedGuests = [];
        
        // Fonction pour vérifier si un invité peut être ajouté
        const canAddGuest = (guest) => {
            const guestSeats = guest.seats || 1;
            const currentSelectedSeats = tempSelectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0);
            return (currentSelectedSeats + guestSeats) <= availableSeats;
        };
        
        const { value: selectedGuests } = await Swal.fire({
            title: 'Ajouter des invités',
            html: `
                <div style="text-align: left; padding: 20px 0;">
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--hover-bg); border-radius: 10px;">
                        <div style="font-weight: 600; color: var(--text-color); margin-bottom: 8px;">
                            <i class="fas fa-info-circle"></i> Informations de la table
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-color); opacity: 0.8;">
                            Table: <strong>#${escapeHtml(table.tableNumber)}</strong><br>
                            Capacité: <strong>${table.capacity} places</strong><br>
                            Places actuellement occupées: <strong>${totalSeats} place(s)</strong><br>
                            Places disponibles: <strong>${availableSeats} place(s)</strong><br>
                            Invités actuellement: <strong>${table.assignedGuests?.length || 0}</strong>
                        </div>
                    </div>
                    
                    ${availableSeats === 0 ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; border-left: 4px solid var(--danger);">
                        <div style="font-weight: 600; color: var(--danger); margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Table complète
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-color);">
                            Cette table a atteint sa capacité maximale de <strong>${table.capacity} places</strong>.
                            Vous ne pouvez pas ajouter d'autres invités.
                        </div>
                    </div>
                    ` : `
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: var(--text-color); margin-bottom: 8px;">
                            <i class="fas fa-search"></i> Rechercher des invités
                        </label>
                        <input type="text" id="searchAvailableGuests" 
                               placeholder="Rechercher un invité par nom, email..." 
                               style="width: 100%; padding: 10px 15px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--input-bg); color: var(--input-text);">
                    </div>
                    
                    <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                        <div style="font-size: 0.9rem; color: var(--text-color);">
                            <span id="selectedCount">0 invité(s) sélectionné(s)</span> • 
                            <span id="selectedSeats">0 place(s)</span> • 
                            <span id="remainingSeats" style="color: ${availableSeats > 0 ? 'var(--success)' : 'var(--danger)'};">
                                ${availableSeats} place(s) disponible(s)
                            </span>
                        </div>
                    </div>
                    
                    <div style="max-height: 300px; overflow-y: auto; padding-right: 5px; border: 1px solid var(--border-color); border-radius: 8px;" id="availableGuestsList">
                        ${renderGuestSelectionList(availableGuests, availableSeats)}
                    </div>
                    `}
                </div>
            `,
            width: '700px',
            showCancelButton: true,
            confirmButtonText: availableSeats === 0 ? 'Fermer' : 'Ajouter sélection',
            cancelButtonText: 'Annuler',
            confirmButtonColor: availableSeats === 0 ? '#6B7280' : '#D97706',
            cancelButtonColor: '#6B7280',
            showConfirmButton: availableSeats > 0,
            didOpen: () => {
                if (availableSeats === 0) return;
                
                // Gestion de la recherche
                const searchInput = document.getElementById('searchAvailableGuests');
                const guestsList = document.getElementById('availableGuestsList');
                
                if (searchInput && guestsList) {
                    searchInput.addEventListener('input', function() {
                        const term = this.value.toLowerCase();
                        const items = guestsList.querySelectorAll('.guest-select-item');
                        
                        items.forEach(item => {
                            const name = item.querySelector('.guest-name')?.textContent.toLowerCase() || '';
                            const email = item.querySelector('.guest-email')?.textContent.toLowerCase() || '';
                            
                            if (name.includes(term) || email.includes(term)) {
                                item.style.display = 'flex';
                            } else {
                                item.style.display = 'none';
                            }
                        });
                    });
                }
                
                // Gestion de la sélection
                guestsList.querySelectorAll('.guest-select-item:not(.disabled)').forEach(item => {
                    item.addEventListener('click', function() {
                        const guestId = this.dataset.guestId;
                        const guest = availableGuests.find(g => g.id === guestId);
                        if (!guest) return;
                        
                        const guestSeats = guest.seats || 1;
                        const currentSelectedSeats = tempSelectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0);
                        
                        // Vérifier si l'invité est déjà sélectionné
                        const existingIndex = tempSelectedGuests.findIndex(g => g.id === guestId);
                        
                        if (existingIndex === -1) {
                            // Vérifier si on peut ajouter cet invité
                            if ((currentSelectedSeats + guestSeats) <= availableSeats) {
                                tempSelectedGuests.push(guest);
                                this.classList.add('selected');
                                this.querySelector('.guest-checkbox').classList.add('selected');
                            } else {
                                // Afficher un message d'erreur
                                const remaining = availableSeats - currentSelectedSeats;
                                Toastify({
                                    text: `Plus de place disponible. ${remaining} place(s) restante(s), ${guestSeats} requise(s)`,
                                    duration: 2000,
                                    gravity: "top",
                                    position: "right",
                                    backgroundColor: "var(--warning)"
                                }).showToast();
                                return;
                            }
                        } else {
                            // Retirer l'invité
                            tempSelectedGuests.splice(existingIndex, 1);
                            this.classList.remove('selected');
                            this.querySelector('.guest-checkbox').classList.remove('selected');
                        }
                        
                        // Mettre à jour les compteurs
                        updateSelectionCounters();
                        
                        // Mettre à jour l'état des autres invités
                        updateGuestsAvailability();
                    });
                });
                
                // Fonction pour mettre à jour les compteurs
                function updateSelectionCounters() {
                    const selectedCount = tempSelectedGuests.length;
                    const selectedSeats = tempSelectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0);
                    const remainingSeats = availableSeats - selectedSeats;
                    
                    document.getElementById('selectedCount').textContent = `${selectedCount} invité(s) sélectionné(s)`;
                    document.getElementById('selectedSeats').textContent = `${selectedSeats} place(s)`;
                    document.getElementById('remainingSeats').textContent = `${remainingSeats} place(s) disponible(s)`;
                    document.getElementById('remainingSeats').style.color = remainingSeats > 0 ? 'var(--success)' : 'var(--danger)';
                }
                
                // Fonction pour mettre à jour la disponibilité des invités
                function updateGuestsAvailability() {
                    const currentSelectedSeats = tempSelectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0);
                    const remainingSeats = availableSeats - currentSelectedSeats;
                    
                    guestsList.querySelectorAll('.guest-select-item').forEach(item => {
                        const guestId = item.dataset.guestId;
                        const guest = availableGuests.find(g => g.id === guestId);
                        if (!guest) return;
                        
                        const guestSeats = guest.seats || 1;
                        const isSelected = tempSelectedGuests.some(g => g.id === guestId);
                        
                        if (isSelected) {
                            item.classList.remove('disabled');
                        } else if (guestSeats > remainingSeats) {
                            item.classList.add('disabled');
                            item.title = `Capacité insuffisante: ${guestSeats} place(s) requise(s), ${remainingSeats} disponible(s)`;
                        } else {
                            item.classList.remove('disabled');
                            item.title = '';
                        }
                    });
                }
                
                // Initialiser les compteurs
                updateSelectionCounters();
                updateGuestsAvailability();
            },
            preConfirm: () => {
                if (availableSeats === 0) return null;
                
                if (tempSelectedGuests.length === 0) {
                    Swal.showValidationMessage('Veuillez sélectionner au moins un invité');
                    return false;
                }
                
                // Vérifier la capacité (double vérification)
                const totalSelectedSeats = tempSelectedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
                if (totalSelectedSeats > availableSeats) {
                    Swal.showValidationMessage(`Capacité insuffisante. Vous avez sélectionné ${totalSelectedSeats} places, mais seulement ${availableSeats} sont disponibles.`);
                    return false;
                }
                
                return tempSelectedGuests;
            }
        });
        
        if (selectedGuests && selectedGuests.length > 0) {
            // Assigner les invités
            for (const guest of selectedGuests) {
                await storage.assignGuestToTable(tableId, guest.id, guest.seats || 1);
            }
            
            // Recharger les tables
            await loadTables();
            
            SECURA_AUDIO.play('success');
            
            await Swal.fire({
                icon: 'success',
                title: 'Invités ajoutés !',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 15px;"></i>
                        <p><strong>${selectedGuests.length} invité(s)</strong> ajouté(s) à la table <strong>#${escapeHtml(table.tableNumber)}</strong></p>
                        <div style="margin-top: 15px; padding: 10px; background: var(--hover-bg); border-radius: 8px; max-height: 150px; overflow-y: auto;">
                            ${selectedGuests.map(g => {
                                const guestSeats = g.seats || 1;
                                return `
                                <div style="display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.8rem;">
                                        ${getInitials(`${g.firstName} ${g.lastName}`.trim() || g.email)}
                                    </div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: var(--text-color);">${escapeHtml(`${g.firstName} ${g.lastName}`.trim() || g.email)}</div>
                                        <div style="font-size: 0.8rem; color: var(--text-color); opacity: 0.7; display: flex; align-items: center; gap: 10px;">
                                            <span>${g.email || ''}</span>
                                            <span style="background: rgba(217, 119, 6, 0.2); color: var(--primary); padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                                                <i class="fas fa-chair"></i> ${guestSeats} place(s)
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 4px solid var(--success);">
                            <div style="font-size: 0.9rem; color: var(--text-color);">
                                <i class="fas fa-info-circle" style="color: var(--success); margin-right: 8px;"></i>
                                <strong>${selectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0)} place(s)</strong> ont été ajoutées à la table.
                            </div>
                        </div>
                    </div>
                `,
                confirmButtonColor: '#D97706',
                timer: 3000,
                showConfirmButton: false
            });
        } else if (availableSeats === 0) {
            // Si la table est complète, afficher un message différent
            await Swal.fire({
                icon: 'info',
                title: 'Table complète',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-ban" style="font-size: 4rem; color: var(--warning); margin-bottom: 15px;"></i>
                        <p>La table <strong>#${escapeHtml(table.tableNumber)}</strong> a atteint sa capacité maximale.</p>
                        <p style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem; margin-top: 10px;">
                            Capacité: ${table.capacity} places<br>
                            Actuellement: ${totalSeats} places occupées
                        </p>
                    </div>
                `,
                confirmButtonColor: '#D97706',
                timer: 2000,
                showConfirmButton: false
            });
        }
        
    } catch (error) {
        console.error('Erreur ajout invités:', error);
        
        let errorMessage = 'Impossible d\'ajouter les invités';
        if (error.message.includes('Capacité insuffisante')) {
            errorMessage = 'Capacité insuffisante pour ajouter tous les invités';
        } else if (error.message.includes('introuvable')) {
            errorMessage = 'Table ou invité introuvable';
        }
        
        await Swal.fire({
            icon: 'error',
            title: 'Erreur',
            html: `
                <div style="text-align: center; padding: 20px 0;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: var(--danger); margin-bottom: 15px;"></i>
                    <p>${errorMessage}</p>
                    <p style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem; margin-top: 10px;">
                        ${error.message || 'Une erreur est survenue'}
                    </p>
                </div>
            `,
            confirmButtonColor: '#D97706'
        });
    }
}

// Fonction pour rendre la liste de sélection des invités
function renderGuestSelectionList(guests, availableSeats = 999) {
    return guests.map(guest => {
        const guestSeats = guest.seats || 1;
        const canBeSelected = guestSeats <= availableSeats;
        
        return `
            <div class="guest-select-item ${canBeSelected ? '' : 'disabled'}" 
                 data-guest-id="${guest.id}" 
                 style="display: flex; align-items: center; gap: 12px; padding: 12px; margin-bottom: 8px; 
                        background: ${canBeSelected ? 'var(--hover-bg)' : 'rgba(239, 68, 68, 0.05)'}; 
                        border-radius: 8px; cursor: ${canBeSelected ? 'pointer' : 'not-allowed'}; 
                        border: 1px solid ${canBeSelected ? 'var(--border-color)' : 'rgba(239, 68, 68, 0.2)'};
                        opacity: ${canBeSelected ? '1' : '0.6'};">
                <div class="guest-checkbox" 
                     style="width: 24px; height: 24px; border-radius: 6px; 
                            border: 2px solid ${canBeSelected ? 'var(--border-color)' : 'rgba(239, 68, 68, 0.3)'}; 
                            background: ${canBeSelected ? 'var(--input-bg)' : 'rgba(239, 68, 68, 0.1)'}; 
                            display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                    <i class="fas fa-check" style="color: white; font-size: 0.8rem; display: none;"></i>
                </div>
                <div class="guest-avatar" 
                     style="width: 40px; height: 40px; border-radius: 50%; 
                            background: ${canBeSelected ? 'linear-gradient(135deg, var(--primary), var(--primary-dark))' : 'linear-gradient(135deg, #6B7280, #9CA3AF)'}; 
                            display: flex; align-items: center; justify-content: center; 
                            color: white; font-weight: 600; font-size: 0.9rem; flex-shrink: 0;">
                    ${getInitials(`${guest.firstName} ${guest.lastName}`.trim() || guest.email)}
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div class="guest-name" style="font-weight: 600; color: ${canBeSelected ? 'var(--text-color)' : 'var(--text-color)'}; margin-bottom: 3px; 
                          display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">
                        ${escapeHtml(`${guest.firstName} ${guest.lastName}`.trim() || guest.email)}
                    </div>
                    <div class="guest-email" style="font-size: 0.85rem; color: ${canBeSelected ? 'var(--text-color)' : 'var(--text-color)'}; 
                          opacity: ${canBeSelected ? '0.7' : '0.5'}; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">
                        ${escapeHtml(guest.email || '')}
                    </div>
                </div>
                <div style="font-size: 0.85rem; color: ${canBeSelected ? 'var(--text-color)' : 'var(--text-color)'}; 
                      opacity: ${canBeSelected ? '0.7' : '0.5'}; flex-shrink: 0; 
                      display: flex; align-items: center; gap: 5px;">
                    <i class="fas fa-chair"></i>
                    ${guestSeats} place(s)
                    ${!canBeSelected ? '<i class="fas fa-exclamation-triangle" style="color: var(--warning); margin-left: 5px;"></i>' : ''}
                </div>
            </div>
        `;
    }).join('');
}


// Fonction pour déplacer un invité vers une autre table
async function moveGuestToAnotherTable(guestId, fromTableId) {
    try {
        // Récupérer l'invité
        const guest = await storage.getGuestById(guestId);
        if (!guest) return;
        
        // Récupérer les tables disponibles (sauf celle actuelle)
        const availableTables = allTables.filter(table => 
            table.id !== fromTableId && 
            currentEvent.id === table.eventId
        );
        
        if (availableTables.length === 0) {
            await Swal.fire({
                icon: 'info',
                title: 'Aucune table disponible',
                text: 'Il n\'y a pas d\'autre table vers laquelle déplacer cet invité.',
                confirmButtonColor: '#D97706'
            });
            return;
        }
        
        const { value: selectedTable } = await Swal.fire({
            title: 'Déplacer l\'invité',
            html: `
                <div style="text-align: left; padding: 20px 0;">
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--hover-bg); border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1rem;">
                                ${getInitials(`${guest.firstName} ${guest.lastName}`.trim() || guest.email)}
                            </div>
                            <div>
                                <div style="font-weight: 700; color: var(--text-color);">${escapeHtml(`${guest.firstName} ${guest.lastName}`.trim() || guest.email)}</div>
                                <div style="font-size: 0.9rem; color: var(--text-color); opacity: 0.7;">${guest.seats || 1} place(s)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; color: var(--text-color); margin-bottom: 8px;">
                            <i class="fas fa-chair"></i> Sélectionner une table de destination
                        </label>
                        <select id="destinationTableSelect" 
                                style="width: 100%; padding: 12px 15px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--input-bg); color: var(--input-text); font-size: 1rem;">
                            ${availableTables.map(table => {
                                const totalSeats = table.assignedGuests?.reduce((sum, g) => sum + (g.seats || 1), 0) || 0;
                                const availableSeats = Math.max(0, table.capacity - totalSeats);
                                return `
                                    <option value="${table.id}" ${availableSeats >= (guest.seats || 1) ? '' : 'disabled'}>
                                        Table #${escapeHtml(table.tableNumber)} - 
                                        ${escapeHtml(table.tableName || 'Sans nom')} 
                                        (${availableSeats} place(s) disponible(s))
                                    </option>
                                `;
                            }).join('')}
                        </select>
                    </div>
                </div>
            `,
            width: '600px',
            showCancelButton: true,
            confirmButtonText: 'Déplacer',
            cancelButtonText: 'Annuler',
            confirmButtonColor: '#D97706',
            cancelButtonColor: '#6B7280',
            preConfirm: () => {
                const select = document.getElementById('destinationTableSelect');
                const tableId = select.value;
                const table = availableTables.find(t => t.id === tableId);
                
                if (!table) {
                    Swal.showValidationMessage('Veuillez sélectionner une table valide');
                    return false;
                }
                
                return { tableId, table };
            }
        });
        
        if (selectedTable) {
            // Retirer l'invité de l'ancienne table
            await storage.removeGuestFromTable(fromTableId, guestId);
            
            // Ajouter l'invité à la nouvelle table
            await storage.assignGuestToTable(selectedTable.tableId, guestId, guest.seats || 1);
            
            // Recharger les tables
            await loadTables();
            
            await Swal.fire({
                icon: 'success',
                title: 'Invité déplacé !',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-exchange-alt" style="font-size: 4rem; color: var(--success); margin-bottom: 15px;"></i>
                        <p>L'invité a été déplacé vers la table <strong>#${escapeHtml(selectedTable.table.tableNumber)}</strong></p>
                    </div>
                `,
                confirmButtonColor: '#D97706',
                timer: 2000,
                showConfirmButton: false
            });
        }
        
    } catch (error) {
        console.error('Erreur déplacement invité:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Impossible de déplacer l\'invité',
            confirmButtonColor: '#D97706'
        });
    }
}


async function viewGuestQR(id) {
    try {
        // Récupérer l'invité
        const guest = await storage.getGuestById(id);
        if (!guest) {
            Toastify({
                text: "Invité introuvable",
                duration: 3000,
                gravity: "top",
                position: "right",
            }).showToast();
            return;
        }
        
        // Récupérer l'événement
        const event = currentEvent || await storage.getEventById(guest.eventId);
        if (!event) {
            Toastify({
                text: "Événement introuvable",
                duration: 3000,
                gravity: "top",
                position: "right",
            }).showToast();
            return;
        }
        // Trouver la table de l'invité
        const table = allTables.find(t => 
            t.assignedGuests?.some(g => g.guestId === id)
        );
        
        
       const qrRecord = storage.getQRCodeByGuestId(id);
    if (!qrRecord) {
        return showNotification('warning', 'QR Code non généré pour cet invité');
    }

    const qrData = typeof qrRecord.data === 'string' ? JSON.parse(qrRecord.data) : qrRecord.data;

        
        // Génération du QR Code en haute qualité
        const tempDiv = document.createElement('div');
        tempDiv.style.cssText = 'position:absolute; left:-9999px; top:-9999px;';
        document.body.appendChild(tempDiv);

       
        new QRCode(tempDiv, {
            text: JSON.stringify(qrData),
            width: 512,
            height: 512,
            colorDark: '#000000',
            colorLight: '#FFFFFF',
            correctLevel: QRCode.CorrectLevel.H
        });

        await new Promise(r => setTimeout(r, 150));
        const canvas = tempDiv.querySelector('canvas');
        const qrImageUrl = canvas.toDataURL('image/png');
        document.body.removeChild(tempDiv);

        // Informations de l'invité
        const accentColor = '#D97706'; // Couleur primaire par défaut
        const initials = getInitials(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email);
        const name = `${guest.firstName != '-' ? guest.firstName : '' } ${guest.lastName != '-' ? guest.lastName : '' }`.trim() || guest.email;
        
        const eventDate = new Date(event.date).toLocaleDateString('fr-FR', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });

        const scannedStatus = guest.scanned ? `<span style="background: rgba(16, 185, 129, 0.2); color: var(--success); padding: 6px 14px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;"><i class="fas fa-check-circle"></i> Présent </span>
                <small style="display: block; margin-top: 5px; opacity: 0.8;">
                    Le ${new Date(guest.scannedAt).toLocaleString('fr-FR')}
                </small>`
            : `<span style="background: rgba(245, 158, 11, 0.2); color: var(--warning); padding: 6px 14px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fas fa-hourglass-half"></i> En attente
                </span>`;

        await Swal.fire({
            title: 'QR Code Invité',
            html: `
                <div style="text-align: center; padding: 20px 0; max-width: 600px; margin: 0 auto;">
                    <!-- En-tête avec avatar et informations -->
                    <div style="background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), rgba(217, 119, 6, 0.05)); padding: 25px; border-radius: 16px; margin-bottom: 25px; border: 1px solid rgba(217, 119, 6, 0.2);">
                        <div style="display: flex; align-items: center; gap: 20px; text-align: left;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.8rem; flex-shrink: 0; box-shadow: 0 8px 20px rgba(217, 119, 6, 0.3);">
                                ${initials}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 1.6rem; font-weight: 800; color: var(--text-color); margin-bottom: 5px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                    ${escapeHtml(name)}
                                </div>
                                <div style="font-size: 0.95rem; color: var(--text-color); opacity: 0.8; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-envelope" style="color: var(--primary);"></i> ${escapeHtml(guest.email || 'Non renseigné')}
                                </div>
                                ${table ? `
                                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                                        <div style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; padding: 6px 16px; border-radius: 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);">
                                            <i class="fas fa-chair"></i> Table #${escapeHtml(table.tableNumber)}
                                        </div>
                                        ${table.tableName ? `
                                            <div style="color: var(--text-color); opacity: 0.7; font-style: italic;">
                                                "${escapeHtml(table.tableName)}"
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: right;">
                            ${scannedStatus}
                        </div>
                    </div>
                    
                    <!-- QR Code -->
                    <div style="margin: 30px auto; position: relative;">
                        <div style="width: 280px; height: 280px; margin: 0 auto; background: linear-gradient(135deg, var(--hover-bg), var(--card-bg)); border-radius: 16px; display: flex; align-items: center; justify-content: center; border: 3px solid var(--border-color); position: relative; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.1);">
                            <div style="position: absolute; inset: 0; background: conic-gradient(from 0deg, transparent 0%, rgba(217, 119, 6, 0.1) 50%, transparent 100%); animation: rotate 10s linear infinite;"></div>
                            <img src="${qrImageUrl}" alt="QR Code" style="width: 240px; height: 240px; z-index: 2; position: relative; border-radius: 10px; border: 2px solid white; box-shadow: 0 10px 25px rgba(0,0,0,0.15);">
                            <div style="position: absolute; bottom: 10px; right: 10px; background: var(--primary); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; z-index: 3; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                        </div>
                        <div style="position: absolute; bottom: -30px; left: 0; right: 0; text-align: center; font-size: 0.8rem; color: var(--text-color); opacity: 0.6; font-weight: 500;">
                            <i class="fas fa-lock"></i> SECURA • Invité • ${new Date().getFullYear()}
                        </div>
                    </div>
                    
                    <!-- Statistiques -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 40px 0 30px;">
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(217, 119, 6, 0.1), transparent); border-radius: 12px; border: 1px solid rgba(217, 119, 6, 0.2);">
                            <div style="font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-bottom: 5px;">${qrRecord.scanCount || 0}</div>
                            <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                <i class="bi bi-qr-code"></i> Scans
                            </div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), transparent); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="font-size: 1.8rem; font-weight: 800; color: var(--info); margin-bottom: 5px;">${guest.seats || 1}</div>
                            <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                <i class="fas fa-chair"></i> Places
                            </div>
                        </div>
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, ${guest.confirmed ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}, transparent); border-radius: 12px; border: 1px solid ${guest.confirmed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(245, 158, 11, 0.2)'}">
                            <div style="font-size: 1.8rem; font-weight: 800; color: ${guest.confirmed ? 'var(--success)' : 'var(--warning)'}; margin-bottom: 5px;">
                                ${guest.confirmed ? '✓' : '?'}
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7; display: flex; align-items: center; justify-content: center; gap: 5px;">
                                <i class="fas ${guest.confirmed ? 'fa-check-circle' : 'fa-question-circle'}"></i> Statut
                            </div>
                        </div>
                    </div>
                    
                    <!-- Informations de l'événement -->
                    <div style="background: var(--hover-bg); padding: 20px; border-radius: 12px; margin-top: 10px; border-left: 4px solid var(--primary);">
                        <div style="font-weight: 600; color: var(--text-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-calendar-alt" style="color: var(--primary);"></i>
                            Informations de l'événement
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">Événement</div>
                                <div style="font-weight: 600; color: var(--text-color); font-size: 1.1rem;">${escapeHtml(event.name)}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">Date</div>
                                <div style="font-weight: 600; color: var(--text-color); font-size: 1.1rem;">${eventDate}</div>
                            </div>
                            ${event.location ? `
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">Lieu</div>
                                    <div style="font-weight: 600; color: var(--text-color); font-size: 1.1rem;">${escapeHtml(event.location)}</div>
                                </div>
                            ` : ''}
                            ${event.time ? `
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">Heure</div>
                                    <div style="font-weight: 600; color: var(--text-color); font-size: 1.1rem;">${escapeHtml(event.time)}</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Boutons d'action -->
                    <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: center;">
                        <button onclick="downloadQRImage('${qrImageUrl}', 'SECURA_${name.replace(/\s+/g, '_')}_QR')" 
                                style="background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
                            <i class="fas fa-download"></i>
                            Télécharger
                        </button>
                        <button onclick="copyQRToClipboard('${qrImageUrl}', '${name}')" 
                                style="background: var(--hover-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease;">
                            <i class="fas fa-copy"></i>
                            Copier
                        </button>
                    </div>
                </div>
                <style>
                    @keyframes rotate {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                </style>
            `,
            width: '700px',
            showConfirmButton: false,
            showCloseButton: true,
            background: 'var(--card-bg)',
            didOpen: () => {
                // Animation d'apparition
                const modal = document.querySelector('.swal2-popup');
                if (modal) {
                    modal.style.opacity = '0';
                    modal.style.transform = 'scale(0.9) translateY(20px)';
                    setTimeout(() => {
                        modal.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                        modal.style.opacity = '1';
                        modal.style.transform = 'scale(1) translateY(0)';
                    }, 10);
                }
            }
        });
        
    } catch (error) {
        console.error('Erreur affichage QR:', error);
        Toastify({
            text: "Erreur affichage QR Code",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--danger)"
        }).showToast();
    }
}

// Fonctions utilitaires pour les boutons d'action
function downloadQRImage(imageUrl, filename) {
    const link = document.createElement('a');
    link.href = imageUrl;
    link.download = `${filename}.png`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    Toastify({
        text: "QR Code téléchargé",
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: "var(--success)"
    }).showToast();
}

async function copyQRToClipboard(imageUrl, guestName) {
    try {
        const response = await fetch(imageUrl);
        const blob = await response.blob();
        
        const item = new ClipboardItem({
            [blob.type]: blob
        });
        
        await navigator.clipboard.write([item]);
        
        Toastify({
            text: `QR Code de ${guestName} copié`,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--success)"
        }).showToast();
    } catch (error) {
        console.error('Erreur copie:', error);
        Toastify({
            text: "Erreur lors de la copie",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--danger)"
        }).showToast();
    }
}
       
        function getTablePreviewImage(table) {
            try {
                const totalSeats = table.assignedGuests?.reduce((s,g)=>s+(g.seats||1),0) || 0;
               
                return `assets/images/table.png`;
            } catch (e) {
                return 'assets/images/table-placeholder.svg';
            }
        }

        // Rendre la vue tableau
function renderTableView(tables) {
    const tbody = document.getElementById('tablesTableBody');
    tbody.innerHTML = '';
    
    tables.forEach(table => {
        const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        const availableSeats = Math.max(0, (table.capacity || 0) - totalSeats);
        const occupancyRate = table.capacity > 0 ? 
            Math.round((totalSeats / table.capacity) * 100) : 0;
        const isFull = totalSeats >= table.capacity;
        const isEmpty = totalSeats === 0;
        
        const row = document.createElement('tr');
        row.className = 'animate-fade-in';
        row.style.cursor = 'pointer';
        row.onclick = ()=> toggleTableDetails(table.id);
        
        row.innerHTML = `
            <td>
                <strong>#${escapeHtml(table.tableNumber)}</strong>
                ${table.tableName ? `<div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7; margin-top: 2px;">${escapeHtml(table.tableName)}</div>` : ''}
            </td>
            <td>
                <strong style="font-size: 0.85rem; color: var(--text-color);"">${escapeHtml(table.tableName)}</strong>
            </td>
            <td>
                <div style="font-weight: 600;">${table.capacity}</div>
                <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">places</div>
            </td>
            <td>
                <div style="display: flex; flex-direction: column; gap: 2px;">
                    <div style="font-weight: 600;">${totalSeats}</div>
                    <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">
                        ${table.assignedGuests?.length || 0} invité(s)
                    </div>
                </div>
            </td>
            <td>
                <div class="${availableSeats === 0 ? 'badge-danger' : 'badge-success'} table-status">
                    
                    ${availableSeats}
                    <i class="fas fa-chair"></i>
                </div>
            </td>
            <td>${escapeHtml(table.location || '-')}</td>
            <td>
                <div class="table-status ${isFull ? 'status-full' : 'status-available'}">
                    <i class="fas ${isFull ? 'fa-ban' : 'fa-check-circle'}"></i>
                    <span>${isFull ? 'Complète' : `${occupancyRate}%`}</span>
                </div>
            </td>
            <td>
                <div style="display: flex; gap: 8px; justify-content: center;">
                    <button class="action-btn edit" onclick="event.stopPropagation(); openEditTableModal('${table.id}')" title="Modifier">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button class="action-btn qr" onclick="event.stopPropagation(); generateTableQR('${table.id}')" title="QR Code">
                        <i class="bi bi-qr-code"></i>
                    </button>
                    <button class="action-btn delete" onclick="event.stopPropagation(); deleteTable('${table.id}')" title="Supprimer">
                        <i class="bi bi-trash3"></i>
                    </button>
                    <button class="action-btn details" onclick="event.stopPropagation(); toggleTableDetails('${table.id}')" title="Détails">
                        <i class="bi bi-chevron-down"></i>
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
        
        // Ajouter une ligne détaillée
        const detailRow = document.createElement('tr');
        detailRow.id = `table-details-${table.id}`;
        detailRow.className = 'table-details-row';
        detailRow.style.display = 'none';
        
        detailRow.innerHTML = `
            <td colspan="10" style="padding: 0;">
                <div class="table-details-container" style="background: var(--hover-bg); border-radius: 0 0 var(--border-radius) var(--border-radius);">
                    <div style="padding: 20px;">
                        <!-- En-tête des détails -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <h4 style="font-weight: 600; color: var(--text-color); margin: 0;">
                                    <i class="bi bi-people-fill" style="color: var(--primary); margin-right: 8px;"></i>
                                    Invités de la table #${escapeHtml(table.tableNumber)}
                                </h4>
                                <span class="badge ${isFull ? 'badge-danger' : isEmpty ? 'badge-secondary' : 'badge-success'}">
                                    ${table.assignedGuests?.length || 0} invité(s)
                                </span>
                            </div>
                            <button onclick="addGuestToTable('${table.id}')" 
                                    class="btn btn-secondary btn-sm" 
                                    ${isFull ? 'disabled style="opacity: 0.5;"' : ''}>
                                <i class="bi bi-person-plus"></i>
                                Ajouter un invité
                            </button>
                        </div>
                        
                        <!-- Statistiques -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: var(--card-bg); padding: 15px; border-radius: var(--border-radius-sm); border-left: 3px solid var(--primary);">
                                <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">Places occupées</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${totalSeats}</div>
                            </div>
                            <div style="background: var(--card-bg); padding: 15px; border-radius: var(--border-radius-sm); border-left: 3px solid ${availableSeats > 0 ? 'var(--success)' : 'var(--danger)'};">
                                <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">Places libres</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${availableSeats > 0 ? 'var(--success)' : 'var(--danger)'};">${availableSeats}</div>
                            </div>
                            <div style="background: var(--card-bg); padding: 15px; border-radius: var(--border-radius-sm); border-left: 3px solid var(--info);">
                                <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">Taux d'occupation</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--info);">${occupancyRate}%</div>
                            </div>
                        </div>
                        
                        <!-- Liste des invités -->
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${table.assignedGuests && table.assignedGuests.length > 0 ? `
                                <div style="display: grid; gap: 10px;">
                                    ${table.assignedGuests.map(guest => `
                                        <div class="guest-row" style="display: flex; align-items: center; justify-content: space-between; background: var(--card-bg); padding: 12px 15px; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);">
                                            <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                                                <div class="guest-avatar" style="width: 36px; height: 36px; border-radius: 50%; background: var(--gradient); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.85rem;">
                                                    ${getInitials(guest.guestName)}
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: var(--text-color);">${escapeHtml(guest.guestName)}</div>
                                                    <div style="font-size: 0.85rem; color: var(--text-color); opacity: 0.7;">
                                                        <i class="bi bi-person-fill" style="margin-right: 5px;"></i>
                                                        ${guest.seats || 1} place(s)
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 8px;">
                                                <button class="action-btn-sm move" onclick="event.stopPropagation(); moveGuestToAnotherTable('${guest.guestId}', '${table.id}')" title="Déplacer">
                                                    <i class="bi bi-arrow-right-circle"></i>
                                                </button>
                                                <button class="action-btn-sm qr" onclick="event.stopPropagation(); viewGuestQR('${guest.guestId}')" title="QR Code">
                                                    <i class="bi bi-qr-code"></i>
                                                </button>
                                                <button class="action-btn-sm remove" onclick="event.stopPropagation(); removeGuestFromTable('${table.id}', '${guest.guestId}')" title="Retirer">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 40px 20px; color: var(--text-color); opacity: 0.5;display:flex;flex-direction:column;align-items:center;">
                                    <i class="bi bi-people" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                                    <p style="font-size: 1rem; margin-bottom: 10px;">Aucun invité assigné</p>
                                    <p style="font-size: 0.85rem; opacity: 0.7; margin-bottom: 20px;">
                                        Ajoutez des invités à cette table
                                    </p>
                                    <button onclick="addGuestToTable('${table.id}')" class="btn btn-secondary btn-sm">
                                        <i class="bi bi-person-plus"></i>
                                        Ajouter le premier invité
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            </td>
        `;
        
        tbody.appendChild(detailRow);
    });
    
    // Ajouter le style pour les boutons action-sm
    if (!document.getElementById('table-view-styles')) {
        const style = document.createElement('style');
        style.id = 'table-view-styles';
        style.innerHTML = `
           
        `;
        document.head.appendChild(style);
    }
}

// Fonction pour basculer l'affichage des détails
function toggleTableDetails(tableId) {
    const detailRow = document.getElementById(`table-details-${tableId}`);
    const toggleBtn = document.querySelector(`button[onclick="toggleTableDetails('${tableId}')"]`);
    
    if (detailRow.style.display === 'none') {
        // Fermer tous les autres détails ouverts
        document.querySelectorAll('.table-details-row').forEach(row => {
            if (row.id !== `table-details-${tableId}`) {
                row.style.display = 'none';
                const otherToggleBtn = document.querySelector(`button[onclick="toggleTableDetails('${row.id.replace('table-details-', '')}')"]`);
                if (otherToggleBtn) {
                    otherToggleBtn.classList.remove('opened');
                    otherToggleBtn.innerHTML = '<i class="bi bi-chevron-down"></i>';
                }
            }
        });
        
        // Ouvrir les détails
        detailRow.style.display = 'table-row';
        if (toggleBtn) {
            toggleBtn.classList.add('opened');
            toggleBtn.innerHTML = '<i class="bi bi-chevron-up"></i>';
        }
    } else {
        // Fermer les détails
        detailRow.style.display = 'none';
        if (toggleBtn) {
            toggleBtn.classList.remove('opened');
            toggleBtn.innerHTML = '<i class="bi bi-chevron-down"></i>';
        }
    }
}


        // Rendre la vue visuelle
        function renderVisualView(tables) {
            const layout = document.getElementById('visualLayout');
            layout.innerHTML = '';
            
            // Grouper par rangées (simplifié)
            const rows = {};
            tables.forEach((table, index) => {
                const rowNum = Math.floor(index / 4) + 1;
                if (!rows[rowNum]) rows[rowNum] = [];
                rows[rowNum].push(table);
            });
            
            // Créer les rangées
            Object.keys(rows).sort().forEach(rowNum => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'table-row animate-fade-in';
                
                rows[rowNum].forEach(table => {
                    const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
                        sum + (guest.seats || 1), 0) || 0;
                    const isFull = totalSeats >= table.capacity;
                    const isEmpty = totalSeats === 0;
                    
                    const tableVisual = document.createElement('div');
                    tableVisual.className = 'table-visual';
                    tableVisual.onclick = () => showTableDetails(table);
                    
                    // Créer les chaises
                    const chairs = [];
                    const chairCount = Math.min(table.capacity, 8);
                    
                    for (let i = 0; i < chairCount; i++) {
                        const isOccupied = i < totalSeats;
                        chairs.push(`
                            <div class="chair ${isOccupied ? 'occupied' : 'empty'}">
                                ${isOccupied ? '<i class="fas fa-user"></i>' : ''}
                            </div>
                        `);
                    }
                    
                    // Use image preview instead of drawing chairs
                    tableVisual.innerHTML = `
                        <div class="table-shape ${isFull ? 'full' : isEmpty ? 'empty' : ''}" style="padding:12px;">
                            <img src="${getTablePreviewImage(table)}" alt="Aperçu" style="width:160px;height:100px;object-fit:cover;border-radius:8px;border:1px solid var(--border-color);"/>
                            <div class="table-visual-info">
                                <div class="table-visual-number">#${escapeHtml(table.tableNumber)}</div>
                                ${table.tableName ? `<div class="table-visual-name">${escapeHtml(table.tableName)}</div>` : ''}
                                <div class="table-visual-capacity">${totalSeats}/${table.capacity}</div>
                            </div>
                        </div>
                    `;
                    
                    rowDiv.appendChild(tableVisual);
                });
                
                layout.appendChild(rowDiv);
            });
        }

        // Mettre à jour la pagination
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const totalPages = Math.ceil(filteredTables.length / tablesPerPage);
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            let paginationHTML = '';
            
            // Bouton précédent
            paginationHTML += `
                <button class="page-btn ${currentPage === 1 ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage - 1})" 
                        ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Pages
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationHTML += `
                        <button class="page-btn ${i === currentPage ? 'active' : ''}" 
                                onclick="changePage(${i})">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    paginationHTML += `<span class="page-btn" style="cursor: default;">...</span>`;
                }
            }
            
            // Bouton suivant
            paginationHTML += `
                <button class="page-btn ${currentPage === totalPages ? 'disabled' : ''}" 
                        onclick="changePage(${currentPage + 1})" 
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            pagination.innerHTML = paginationHTML;
            pagination.style.display = 'flex';
        }

        // Changer de page
        function changePage(page) {
            if (page < 1 || page > Math.ceil(filteredTables.length / tablesPerPage)) return;
            
            // Animer la transition
            const container = document.querySelector('.tables-grid-container');
            if (container) {
                container.style.opacity = '0.5';
                container.style.transform = 'translateY(10px)';
            }
            
            currentPage = page;
            
            setTimeout(() => {
                renderTables();
                if (container) {
                    container.style.opacity = '1';
                    container.style.transform = 'translateY(0)';
                }
            }, 300);
        }

        // Initialiser les écouteurs d'événements
        function initEventListeners() {
            // Bouton retour aux événements
            document.getElementById('backToEventsBtn').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.href = 'tables';
                showEventsHome();
            });
            
            document.querySelectorAll('.create-table-btn').forEach(btn => {
                btn.addEventListener('click', openTableCreationModal);
            });
            
            
            // Filtres rapides
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    currentPage = 1;
                    applyFilters();
                    renderTables();
                });
            });
            
            // Recherche
            const searchInput = document.getElementById('searchTables');
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentSearch = this.value.trim();
                    currentPage = 1;
                    applyFilters();
                    renderTables();
                }, 300);
            });
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                        if (this.classList.contains('create')) return;
                        
                        document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        currentView = this.dataset.view;
                        
                        // Afficher/masquer les conteneurs
                        ['grid', 'table', 'visual', 'vector', 'stats'].forEach(view => {
                            const container = document.getElementById(`${view}View`);
                            if (container) {
                                container.style.display = view === currentView ? 'block' : 'none';
                            }
                        });
                        
                        currentPage = 1;
                        renderTables();
                    });
                });
            
            // Layout visuel
            document.querySelectorAll('.layout-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    // Implémenter le changement de layout ici
                });
            });
            
            // Auto-assignation
            document.getElementById('autoAssignBtn').addEventListener('click', async () => {
                await autoAssignGuests();
            });
            
            // Générer QR codes en masse
            document.getElementById('generateQRBulkBtn')?.addEventListener('click', () => {

                showQrBulkModal();
            });
            
            // Export des informations des tables
            document.getElementById('exportTableInfoBtn')?.addEventListener('click', () => {
                showExportTableInfoModal();
            });
            
            // Export
          //  document.getElementById('exportTablesBtn').addEventListener('click', async () => {
            //    await exportTables();
            //});
            
            // Actualiser les statistiques
            document.getElementById('refreshStatsBtn')?.addEventListener('click', () => {
                updateAdvancedStats();
            });
            
            // Initialiser les écouteurs du modal de création
            initCreationModalListeners();
            initVectorViewListeners();
        }




// Ajouter la vue vectorielle aux boutons de toggle
function initVectorViewListeners() {
  
    
    // Bouton retour pour la vue vectorielle
    document.getElementById('backToMainToggleVector')?.addEventListener('click', goBackToGridView);
    document.getElementById('createFirstTableVector')?.addEventListener('click', openTableCreationModal);
    
    // Contrôles de forme
    document.querySelectorAll('.shape-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentShape = this.dataset.shape;
            renderVectorView(filteredTables);
        });
    });
    
    // Zoom controls
    document.getElementById('zoomInBtn')?.addEventListener('click', () => {
        zoomLevel = Math.min(zoomLevel + 0.1, 2);
        updateZoom();
    });
    
    document.getElementById('zoomOutBtn')?.addEventListener('click', () => {
        zoomLevel = Math.max(zoomLevel - 0.1, 0.5);
        updateZoom();
    });
    
    document.getElementById('resetZoomBtn')?.addEventListener('click', () => {
        zoomLevel = 1;
        updateZoom();
    });
    
    // Réarranger les tables
    document.getElementById('arrangeTablesBtn')?.addEventListener('click', arrangeTablesAutomatically);
}

function updateZoom() {
    const canvas = document.getElementById('vectorCanvas');
    if (canvas) {
        canvas.style.transform = `scale(${zoomLevel})`;
    }
}

function renderVectorView(tables) {
    const canvas = document.getElementById('vectorCanvas');
    if (!canvas) return;
    
    canvas.innerHTML = '';
    
    tables.forEach((table, index) => {
        const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
            sum + (guest.seats || 1), 0) || 0;
        const isFull = totalSeats >= table.capacity;
        const isEmpty = totalSeats === 0;
        
        // Position aléatoire mais évite les chevauchements
        const posX = 50 + (index % 4) * 250;
        const posY = 50 + Math.floor(index / 4) * 250;
        
        const tableElement = document.createElement('div');
        tableElement.className = `table-vector-item ${isFull ? 'full' : isEmpty ? 'empty' : ''}`;
        tableElement.style.left = `${posX}px`;
        tableElement.style.top = `${posY}px`;
        tableElement.dataset.tableId = table.id;
        tableElement.onclick = () => showTableDetails(table);
        
        // Sélectionner la forme
        let shapeClass = 'table-shape-circle';
        switch(currentShape) {
            case 'rectangle': shapeClass = 'table-shape-rectangle'; break;
            case 'pentagon': shapeClass = 'table-shape-pentagon'; break;
            case 'hexagon': shapeClass = 'table-shape-hexagon'; break;
        }
        
        // Grouper les invités par siège (pour gérer les groupes)
        const guestGroups = {};
        table.assignedGuests?.forEach(guest => {
            if (!guestGroups[guest.seats || 1]) {
                guestGroups[guest.seats || 1] = [];
            }
            guestGroups[guest.seats || 1].push(guest);
        });
        
        // Use an image snapshot for the vector-item preview (no drawn chairs)
        tableElement.innerHTML = `
            <div class="vector-preview">
                <img src="${getTablePreviewImage(table)}" alt="Aperçu table" style="width:200px;height:120px;object-fit:cover;border-radius:8px;border:1px solid var(--border-color);"/>
                <div style="padding:8px 6px;text-align:center;">
                    <div style="font-weight:700;color:var(--primary);">#${escapeHtml(table.tableNumber)}</div>
                    ${table.tableName ? `<div style="font-size:0.9rem;opacity:0.8">${escapeHtml(table.tableName)}</div>` : ''}
                    <div style="font-size:0.85rem;opacity:0.7;margin-top:6px;">${totalSeats}/${table.capacity} places</div>
                </div>
            </div>
        `;
        
        canvas.appendChild(tableElement);
    });
    
    // Mettre à jour le compteur
    document.getElementById('vectorTablesCount').textContent = tables.length;
    
}

function renderChairsAroundTable(capacity, occupiedSeats, guestGroups) {
    const chairCount = Math.min(capacity, 12); // Limiter à 12 chaises visibles
    let chairsHtml = '<div class="chairs-ring">';
    
    for (let i = 0; i < chairCount; i++) {
        const angle = (i / chairCount) * 2 * Math.PI;
        const radius = 100; // Rayon du cercle
        const x = 50 + radius * Math.cos(angle);
        const y = 50 + radius * Math.sin(angle);
        
        const isOccupied = i < occupiedSeats;
        const chairClass = isOccupied ? 'occupied' : 'empty';
        
        // Trouver le groupe pour cette chaise
        let groupInfo = null;
        let groupIndex = 0;
        Object.keys(guestGroups).forEach(seats => {
            const groupSize = parseInt(seats);
            const groupCount = guestGroups[seats].length;
            for (let g = 0; g < groupCount; g++) {
                if (groupIndex === i) {
                    groupInfo = {
                        seats: groupSize,
                        guest: guestGroups[seats][g]
                    };
                }
                groupIndex += groupSize;
            }
        });
        
        chairsHtml += `
            <div class="chair-dot ${chairClass} ${groupInfo?.seats > 1 ? 'group' : ''}" 
                 style="left: ${x}%; top: ${y}%;"
                 ${groupInfo ? `data-guest-id="${groupInfo.guest.guestId}"` : ''}>
                ${isOccupied ? '<i class="fas fa-user"></i>' : ''}
                ${groupInfo?.seats > 1 ? `
                    <div class="chair-badge">${groupInfo.seats}</div>
                    <div class="chair-tooltip">
                        ${escapeHtml(groupInfo.guest.guestName)}<br>
                        ${groupInfo.seats} place(s)
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    chairsHtml += '</div>';
    return chairsHtml;
}

function arrangeTablesAutomatically() {
    const tables = filteredTables;
    const canvas = document.getElementById('vectorCanvas');
    if (!canvas) return;
    
    // Algorithme de disposition automatique
    const cols = Math.ceil(Math.sqrt(tables.length));
    const spacingX = 250;
    const spacingY = 250;
    
    tables.forEach((table, index) => {
        const col = index % cols;
        const row = Math.floor(index / cols);
        const posX = 50 + col * spacingX;
        const posY = 50 + row * spacingY;
        
        const tableElement = canvas.querySelector(`[data-table-id="${table.id}"]`);
        if (tableElement) {
            tableElement.style.left = `${posX}px`;
            tableElement.style.top = `${posY}px`;
        }
    });
}

// Ajouter les statistiques de l'événement
function renderEventStats() {
    const statsContainer = document.getElementById('eventStatsCards');
    if (!statsContainer || !currentEvent) return;
    
    // Calculer les statistiques avancées
    const totalTables = allTables.length;
    const totalGuests = allTables.reduce((sum, table) => 
        sum + (table.assignedGuests?.length || 0), 0);
    const totalCapacity = allTables.reduce((sum, table) => sum + (table.capacity || 0), 0);
    const occupiedSeats = allTables.reduce((sum, table) => 
        sum + (table.assignedGuests?.reduce((s, g) => s + (g.seats || 1), 0) || 0), 0);
    
    const stats = [
        {
            title: 'Tables',
            value: totalTables,
            icon: 'fas fa-chair',
            detail: `${occupiedSeats} places occupées`,
            color: '#D97706'
        },
        {
            title: 'Taux d\'occupation',
            value: totalCapacity > 0 ? `${Math.round((occupiedSeats / totalCapacity) * 100)}%` : '0%',
            icon: 'fas fa-chart-pie',
            detail: `${occupiedSeats}/${totalCapacity} places`,
            color: '#10B981'
        },
        {
            title: 'Invités assignés',
            value: totalGuests,
            icon: 'fas fa-users',
            detail: `${allTables.filter(t => t.assignedGuests?.length > 0).length} tables utilisées`,
            color: '#3B82F6'
        },
        {
            title: 'Capacité moyenne',
            value: totalTables > 0 ? Math.round(totalCapacity / totalTables) : '0',
            icon: 'fas fa-user-friends',
            detail: 'Places par table',
            color: '#8B5CF6'
        }
    ];
    
    statsContainer.innerHTML = stats.map(stat => `
        <div class="event-stat-card" style="border-left-color: ${stat.color}">
            <div class="event-stat-title">
                <i class="${stat.icon}"></i>
                ${stat.title}
            </div>
            <div class="event-stat-value" style="color: ${stat.color}">
                ${stat.value}
            </div>
            <div class="event-stat-detail">
                ${stat.detail}
            </div>
        </div>
    `).join('');
}











        

        // Initialiser les écouteurs du modal de création
        function initCreationModalListeners() {
            // Options de création
            document.getElementById('singleTableOption').addEventListener('click', () => {
                selectCreationMode('single');
            });
            
            document.getElementById('multipleTablesOption').addEventListener('click', () => {
                selectCreationMode('multiple');
            });
            
            // Table rapide
            document.getElementById('quickTableBtn').addEventListener('click', createQuickTable);
            
            // Navigation
            document.getElementById('cancelCreationBtn').addEventListener('click', closeTableCreationModal);
            document.getElementById('closeTableModalBtn').addEventListener('click', closeTableCreationModal);
            document.getElementById('nextToStep2').addEventListener('click', () => goToCreationStep(2));
            document.getElementById('nextToStep3').addEventListener('click', () => goToCreationStep(3));
            document.getElementById('nextToStep4').addEventListener('click', () => goToCreationStep(4));
            document.getElementById('nextToStep5').addEventListener('click', () => goToCreationStep(5));
            
            document.getElementById('backToStep1').addEventListener('click', () => goToCreationStep(1));
            document.getElementById('backToStep2').addEventListener('click', () => goToCreationStep(2));
            document.getElementById('backToStep3').addEventListener('click', () => goToCreationStep(3));
            document.getElementById('backToStep4').addEventListener('click', () => goToCreationStep(4));
            
            // Ajouter une autre table (mode multiple)
            document.getElementById('addAnotherTableBtn').addEventListener('click', addAnotherTable);
            
            // Dupliquer les paramètres
            document.getElementById('duplicateSettingsBtn').addEventListener('click', duplicateTableSettings);
            
            // Actualiser l'aperçu
            document.getElementById('refreshPreviewBtn')?.addEventListener('click', updateTablePreview);
            
            
            // Auto-assignation dans le modal
            document.getElementById('autoAssignCreationBtn').addEventListener('click', autoAssignInCreation);
            
            // Soumission finale
            document.getElementById('submitTablesCreation').addEventListener('click', submitTablesCreation);
            
            // Recherche d'invités
            const searchGuestsInput = document.getElementById('searchGuestsCreation');
            let searchGuestsTimeout;
            searchGuestsInput?.addEventListener('input', function() {
                clearTimeout(searchGuestsTimeout);
                searchGuestsTimeout = setTimeout(() => {
                    filterAvailableGuests(this.value);
                }, 300);
            });
        }

        // Sélectionner le mode de création
        function selectCreationMode(mode) {
            creationMode = mode;
            
            // Mettre en évidence l'option sélectionnée
            document.querySelectorAll('.creation-option').forEach(option => {
                option.style.borderColor = 'var(--border-color)';
                option.style.transform = 'none';
            });
            
            if (mode === 'single') {
                document.getElementById('singleTableOption').style.borderColor = 'var(--primary)';
                document.getElementById('singleTableOption').style.transform = 'translateY(-5px)';
                document.getElementById('step2Subtitle').textContent = 'Définissez les informations de votre table';
            } else {
                document.getElementById('multipleTablesOption').style.borderColor = 'var(--info)';
                document.getElementById('multipleTablesOption').style.transform = 'translateY(-5px)';
                document.getElementById('step2Subtitle').textContent = 'Définissez les informations des tables à créer';
            }
            
            // Afficher le bouton suivant
            document.getElementById('nextToStep2').style.display = 'flex';
        }

        // Ouvrir le modal de création
function openTableCreationModal(tableId = null) {
    creationStep = 1;
    creationMode = 'single';
    multipleTablesData = [];
    selectedGuests = [];
    editingTableId = null;
    isEditMode = false;
    
    // Réinitialiser l'interface
    document.querySelectorAll('.creation-option').forEach(option => {
        option.style.borderColor = 'var(--border-color)';
        option.style.transform = 'none';
    });
    
    document.getElementById('nextToStep2').style.display = 'none';
    document.getElementById('singleTableForm').style.display = 'none';
    document.getElementById('multipleTablesForm').style.display = 'none';
    document.getElementById('singleTableConfig').style.display = 'none';
    document.getElementById('multipleTablesConfig').style.display = 'none';
    document.getElementById('tablePreviewCard').style.display = 'none';
    
    // Réinitialiser les étapes
    document.querySelectorAll('.vertical-step').forEach(step => {
        step.classList.remove('active', 'completed');
    });
    document.querySelector('.vertical-step[data-step="1"]').classList.add('active');
    goToCreationStep(1);
    
    // Mettre à jour le titre (CRÉATION par défaut)
    const progressTitle = document.getElementById('progressTitle');
    if (progressTitle) {
        progressTitle.textContent = 'CRÉATION DE TABLE(S)';
    }
    
    const submitBtn = document.getElementById('submitTablesCreation');
    if (submitBtn) {
        submitBtn.innerHTML = '<i class="fas fa-check-circle"></i> Créer les tables';
    }
    
    // Afficher le modal
    document.getElementById('tableCreationModal').classList.add('active');
    updateCreationProgress();
}


// Fonction séparée pour ouvrir en mode édition
async function openEditTableModal(tableId) {
    try {
        const table = allTables.find(t => t.id === tableId);
        if (!table) {
            Toastify({
                text: "Table introuvable",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--danger)"
            }).showToast();
            return;
        }
        
        // Réinitialiser les données
        creationStep = 1;
        creationMode = 'single';
        multipleTablesData = [];
        selectedGuests = [];
        editingTableId = tableId;
        isEditMode = true;
        
        // Réinitialiser l'interface
        document.querySelectorAll('.creation-option').forEach(option => {
            option.style.borderColor = 'var(--border-color)';
            option.style.transform = 'none';
        });
        
        document.getElementById('nextToStep2').style.display = 'none';
        document.getElementById('singleTableForm').style.display = 'none';
        document.getElementById('multipleTablesForm').style.display = 'none';
        document.getElementById('singleTableConfig').style.display = 'none';
        document.getElementById('multipleTablesConfig').style.display = 'none';
        document.getElementById('tablePreviewCard').style.display = 'none';
        
        // Réinitialiser les étapes
        document.querySelectorAll('.vertical-step').forEach(step => {
            step.classList.remove('active', 'completed');
        });
        document.querySelector('.vertical-step[data-step="1"]').classList.add('active');
        
        // Mettre à jour le titre et les boutons
        const progressTitle = document.getElementById('progressTitle');
        const submitBtn = document.getElementById('submitTablesCreation');
        
        if (progressTitle) {
            progressTitle.textContent = 'MODIFICATION DE TABLE';
        }
        if (submitBtn) {
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Enregistrer les modifications';
        }
        
        // Afficher le modal
        document.getElementById('tableCreationModal').classList.add('active');
        updateCreationProgress();
        
        // Charger les données de la table
        await loadTableForEdit(tableId);
        
        // Aller directement à l'étape 2 (sauter le choix du type)
        selectCreationMode('single');
        setTimeout(() => goToCreationStep(2), 100);
        
    } catch (error) {
        console.error('Erreur ouverture édition:', error);
        Toastify({
            text: "Erreur lors du chargement de la table",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--danger)"
        }).showToast();
    }
}

async function loadTableForEdit(tableId) {
    try {
        const table = allTables.find(t => t.id === tableId);
        if (!table) return;
        
        // Afficher le message/display selon le mode
        const codeInfoMessage = document.getElementById('codeInfoMessage');
        const codeDisplayContainer = document.getElementById('codeDisplayContainer');
        const codeHelpText = document.getElementById('codeHelpText');
        
        if (codeInfoMessage && codeDisplayContainer && codeHelpText) {
            // Cacher le message de création
            codeInfoMessage.style.display = 'none';
            
            // Afficher le display d'édition avec le code existant
            codeDisplayContainer.style.display = 'block';
            codeDisplayContainer.textContent = table.tableNumber || '--';
            
            // Mettre à jour le texte d'aide
            codeHelpText.textContent = 'Code existant (non modifiable)';
        }
        
        // Remplir le formulaire avec les données existantes
        document.getElementById('singleTableName').value = table.tableName || '';
        document.getElementById('singleTableCapacity').value = table.capacity || 8;
        
        // Mettre à jour le titre et sous-titre
        const step2Title = document.getElementById('step2Title');
        const step2Subtitle = document.getElementById('step2Subtitle');
        if (step2Title) {
            step2Title.textContent = `Modification de la table`;
        }
        if (step2Subtitle) {
            step2Subtitle.textContent = `Modifiez les informations de la table #${table.tableNumber}`;
        }
        
        // Initialiser les boutons de capacité
        setTimeout(() => {
            initCapacityButtons();
            highlightCurrentCapacity(table.capacity || 8);
        }, 100);
        
        // Stocker les données pour les étapes suivantes
        multipleTablesData = [{
            tableNumber: table.tableNumber, // Conserver le code existant
            tableName: table.tableName || '',
            capacity: table.capacity || 8,
            location: table.location || '',
            category: table.category || 'standard',
            description: table.description || ''
        }];
        
        // Charger les invités assignés pour l'étape 4
        if (table.assignedGuests && table.assignedGuests.length > 0) {
            const guests = await storage.getAllGuests({ eventId: currentEvent.id });
            selectedGuests = guests.filter(g => 
                table.assignedGuests.some(ag => ag.guestId === g.id)
            );
        }
        
    } catch (error) {
        console.error('Erreur chargement table pour édition:', error);
        Toastify({
            text: "Erreur lors du chargement de la table",
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "var(--danger)"
        }).showToast();
    }
}

        // Fermer le modal de création
        function closeTableCreationModal() {
            document.getElementById('tableCreationModal').classList.remove('active');
        }

        // Aller à une étape de création
        async function goToCreationStep(step) {

                if (isEditMode && step === 1) {
                    return;
                }

                if (step > creationStep) {
                const isValid = await validateCurrentCreationStep();
                if (!isValid) return;
            }
            
            creationStep = step;
            
            // Mettre à jour les indicateurs de progression
            document.querySelectorAll('.vertical-step').forEach(stepEl => {
                const stepNum = parseInt(stepEl.dataset.step);
                stepEl.classList.remove('active', 'completed');
                
                if (stepNum < step) {
                    stepEl.classList.add('completed');
                } else if (stepNum === step) {
                    stepEl.classList.add('active');
                }
            });
            
            // Mettre à jour le contenu
            document.querySelectorAll('.creation-step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`creationStep${step}`).classList.add('active');
            
            // Configurer l'interface selon l'étape
            switch(step) {
                case 2:
                    setupStep2();
                    break;
                case 3:
                    setupStep3();
                    break;
                case 4:
                    await setupStep4();
                    break;
                case 5:
                    setupStep5();
                    break;
            }
            
            updateCreationProgress();
        }

        // Valider l'étape actuelle de création
        async function validateCurrentCreationStep() {
    switch(creationStep) {
        case 1:
            if (!creationMode) {
                Swal.fire({
                    icon: 'error',
                    title: 'Sélection requise',
                    text: 'Veuillez sélectionner un mode de création',
                    confirmButtonColor: '#D97706'
                });
                return false;
            }
            break;
            
        case 2:
            if (creationMode === 'single') {
                const tableName = document.getElementById('singleTableName').value.trim();
                const capacity = parseInt(document.getElementById('singleTableCapacity').value);
                
                // Validation du nom
                if (!tableName) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Nom manquant',
                        text: 'Veuillez saisir un nom pour la table',
                        confirmButtonColor: '#D97706'
                    });
                    return false;
                }
                
                // Validation de la capacité
                if (isNaN(capacity) || capacity < 1 || capacity > 50) {
                    showValidation('singleCapacityValidation', 'La capacité doit être entre 1 et 50', false);
                    return false;
                }
                
                // Stocker les données
                if (!isEditMode) {
                    multipleTablesData = [{
                        tableNumber: '', // Vide, sera généré par le backend
                        tableName: tableName,
                        capacity: capacity
                    }];
                } else {
                    const table = allTables.find(t => t.id === editingTableId);
                    if (table) {
                        multipleTablesData = [{
                            tableNumber: table.tableNumber, // Conserver le code existant
                            tableName: tableName || table.tableName,
                            capacity: capacity || table.capacity
                        }];
                    }
                }
                
            } else {
                // Validation mode multiple
                if (multipleTablesData.length === 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Tables requises',
                        text: 'Veuillez ajouter au moins une table',
                        confirmButtonColor: '#D97706'
                    });
                    return false;
                }
                
                for (let i = 0; i < multipleTablesData.length; i++) {
                    const table = multipleTablesData[i];
                    
                    // Validation du nom
                    if (!table.tableName || table.tableName.trim() === '') {
                        Swal.fire({
                            icon: 'error',
                            title: 'Nom de table manquant',
                            text: `La table ${i + 1} n'a pas de nom`,
                            confirmButtonColor: '#D97706'
                        });
                        return false;
                    }
                    
                    // Validation de la capacité
                    if (isNaN(table.capacity) || table.capacity < 1 || table.capacity > 50) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Capacité invalide',
                            text: `La table ${i + 1} a une capacité invalide (entre 1 et 50)`,
                            confirmButtonColor: '#D97706'
                        });
                        return false;
                    }
                }
                
                // Vérifier les noms en double pour la création (pas pour l'édition)
                if (!isEditMode) {
                    const tableNames = multipleTablesData.map(t => t.tableName.toLowerCase());
                    const duplicates = tableNames.filter((name, index) => tableNames.indexOf(name) !== index);
                    
                    if (duplicates.length > 0) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Noms dupliqués',
                            text: `Les noms suivants sont en double: ${Array.from(new Set(duplicates)).join(', ')}`,
                            confirmButtonColor: '#D97706'
                        });
                        return false;
                    }
                }
            }
            break;
            
        case 3:
            // Récupérer les données de configuration
            if (creationMode === 'single') {
                multipleTablesData[0].location = document.getElementById('singleTableLocation').value.trim();
                multipleTablesData[0].category = document.getElementById('singleTableCategory').value;
                multipleTablesData[0].description = document.getElementById('singleTableDescription').value.trim();
            } else {
                const location = document.getElementById('multipleTablesLocation').value.trim();
                const category = document.getElementById('multipleTablesCategory').value;
                const description = document.getElementById('multipleTablesDescription').value.trim();
                
                multipleTablesData = multipleTablesData.map(table => ({
                    ...table,
                    location,
                    category,
                    description
                }));
            }
            break;
            
        case 4:
            // Validation de la capacité pour les invités (uniquement pour la création simple)
            if (creationMode === 'single' && !isEditMode) {
               // const capacity = parseInt(document.getElementById('singleTableCapacity').value) || 8;
               // const totalSelectedSeats = selectedGuests.reduce((sum, guest) => 
                //    sum + (guest.seats || 1), 0);

                const capacity = getCurrentTableCapacity();
                const totalSelectedSeats = selectedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
                        
                if (totalSelectedSeats > capacity) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Capacité insuffisante',
                        html: `
                            <div style="text-align: center; padding: 20px 0;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: var(--warning); margin-bottom: 15px;"></i>
                                <p>Vous avez sélectionné <strong>${totalSelectedSeats} places</strong></p>
                                <p>mais la capacité de la table est de <strong>${capacity} places</strong>.</p>
                                <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 10px;">
                                    Veuillez retirer ${totalSelectedSeats - capacity} place(s)
                                </p>
                            </div>
                        `,
                        confirmButtonColor: '#D97706'
                    });
                    return false;
                }
            }
            break;
    }
    
    return true;
}


// Configurer l'étape 2
function setupStep2() {
    if (creationMode === 'single') {
        document.getElementById('singleTableForm').style.display = 'block';
        document.getElementById('multipleTablesForm').style.display = 'none';
        
        const codeInfoMessage = document.getElementById('codeInfoMessage');
        const codeDisplayContainer = document.getElementById('codeDisplayContainer');
        const codeHelpText = document.getElementById('codeHelpText');
        
        if (codeInfoMessage && codeDisplayContainer && codeHelpText) {
            if (isEditMode) {
                // MODE ÉDITION
                codeInfoMessage.style.display = 'none';
                codeDisplayContainer.style.display = 'block';
                codeHelpText.textContent = 'Code existant (non modifiable)';
                
                // Mettre à jour le titre
                const step2Title = document.getElementById('step2Title');
                if (step2Title) {
                    step2Title.textContent = 'Modification de la table';
                }
            } else {
                // MODE CRÉATION
                codeInfoMessage.style.display = 'block';
                codeDisplayContainer.style.display = 'none';
                codeHelpText.textContent = 'Code automatiquement généré par le système';
                
                // Réinitialiser les champs
                document.getElementById('singleTableName').value = '';
                document.getElementById('singleTableCapacity').value = '8';
                
                // Mettre à jour le titre
                const step2Title = document.getElementById('step2Title');
                if (step2Title) {
                    step2Title.textContent = 'Informations de base';
                }
            }
        }

        // Ajouter les écouteurs pour la mise à jour en temps réel
        const tableNameInput = document.getElementById('singleTableName');
        const capacityInput = document.getElementById('singleTableCapacity');
        
        if (tableNameInput) {
            tableNameInput.addEventListener('input', function() {
                if (multipleTablesData[0]) {
                    multipleTablesData[0].tableName = this.value.trim();
                }
            });
        }
        
        if (capacityInput) {
            capacityInput.addEventListener('input', function() {
                if (multipleTablesData[0]) {
                    multipleTablesData[0].capacity = parseInt(this.value) || 8;
                }
            });
            capacityInput.addEventListener('change', function() {
                if (multipleTablesData[0]) {
                    multipleTablesData[0].capacity = parseInt(this.value) || 8;
                }
            });
        }
        
        // Initialiser les boutons de capacité
        initCapacityButtons();
        
    } else {
        document.getElementById('singleTableForm').style.display = 'none';
        document.getElementById('multipleTablesForm').style.display = 'block';
        
        // Mettre à jour le titre pour le mode multiple
        const step2Title = document.getElementById('step2Title');
        if (step2Title) {
            step2Title.textContent = 'Création multiple de tables';
        }
        
        // Initialiser avec une table si vide
        if (multipleTablesData.length === 0) {
            addAnotherTable();
        } else {
            renderMultipleTablesList();
        }
    }
}


function initCapacityButtons() {
    const capacityInput = document.getElementById('singleTableCapacity');
    const decreaseBtn = document.getElementById('decreaseCapacity');
    const increaseBtn = document.getElementById('increaseCapacity');
    const quickButtons = document.querySelectorAll('.quick-capacity-btn');
    
    // Boutons +/-
    if (decreaseBtn) {
        decreaseBtn.addEventListener('click', () => {
            let value = parseInt(capacityInput.value) || 8;
            if (value > 1) {
                capacityInput.value = value - 1;
                highlightCurrentCapacity(value - 1);
            }
        });
    }
    
    if (increaseBtn) {
        increaseBtn.addEventListener('click', () => {
            let value = parseInt(capacityInput.value) || 8;
            if (value < 50) {
                capacityInput.value = value + 1;
                highlightCurrentCapacity(value + 1);
            }
        });
    }
    
    // Boutons rapides
    quickButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const capacity = parseInt(btn.dataset.capacity);
            capacityInput.value = capacity;
            highlightCurrentCapacity(capacity);
        });
    });
    
    const currentCapacity = parseInt(capacityInput.value) || 8;
    highlightCurrentCapacity(currentCapacity);
}

function highlightCurrentCapacity(capacity) {
    const quickButtons = document.querySelectorAll('.quick-capacity-btn');
    
    quickButtons.forEach(btn => {
        const btnCapacity = parseInt(btn.dataset.capacity);
        
        if (btnCapacity === capacity) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

// Ajouter une autre table (mode multiple)
        function addAnotherTable() {
            const tableIndex = multipleTablesData.length + 1;
            const defaultTableNumber = (allTables.length + tableIndex).toString();
            
            multipleTablesData.push({
                tableNumber: defaultTableNumber,
                tableName: '',
                capacity: 8,
                location: '',
                category: 'standard',
                description: ''
            });
            
            renderMultipleTablesList();
        }

       
        // Rendre la liste des tables multiples
        function renderMultipleTablesList() {
            const listContainer = document.getElementById('multipleTablesList');
            listContainer.innerHTML = '';
            
            multipleTablesData.forEach((table, index) => {
                const tableItem = document.createElement('div');
                tableItem.className = 'table-item';
                tableItem.innerHTML = `
                    <div class="table-item-header">
                        <div class="table-item-number">Table #${index + 1}</div>
                        ${multipleTablesData.length > 1 ? `
                        <button type="button" class="remove-table-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tag"></i>
                            Nom de la table
                            <span class="required">*</span>
                        </label>
                        <input type="text" class="form-control table-name-input" 
                            data-index="${index}" value="${table.tableName || ''}" 
                            placeholder="Ex: Table standard, VIP, Familiale" maxlength="50" required>
                        <div class="form-help">Nom pour identifier la table</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-users"></i>
                            Capacité
                            <span class="required">*</span>
                        </label>
                        
                        <!-- Contrôles de capacité améliorés -->
                        <div class="capacity-control-group">
                            <button type="button" class="capacity-btn decrease-multiple" data-index="${index}" title="Diminuer la capacité">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" data-index="${index}" value="${table.capacity || 8}" 
                                class="form-control table-capacity-input" 
                                placeholder="Nombre de places" required min="1" max="50">
                            <button type="button" class="capacity-btn increase-multiple" data-index="${index}" title="Augmenter la capacité">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        
                        <!-- Boutons de capacité rapide -->
                        <div class="quick-capacity-buttons multiple-quick-buttons" data-index="${index}">
                            <button type="button" class="quick-capacity-btn" data-capacity="2">2 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="4">4 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="6">6 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="8">8 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="10">10 places</button>
                            <button type="button" class="quick-capacity-btn" data-capacity="12">12 places</button>
                        </div>
                        
                        <div class="form-help">Entre 1 et 50 places</div>
                    </div>
                `;
                
                listContainer.appendChild(tableItem);
            });
            
            // Ajouter les écouteurs pour les boutons de suppression
            listContainer.querySelectorAll('.remove-table-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    multipleTablesData.splice(index, 1);
                    renderMultipleTablesList();
                });
            });
            
            // Ajouter les écouteurs pour les noms de table
            listContainer.querySelectorAll('.table-name-input').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    multipleTablesData[index].tableName = this.value.trim();
                });
            });
            
            // Ajouter les écouteurs pour les boutons de capacité (mode multiple)
            initMultipleCapacityControls();
        }

        // Initialiser les contrôles de capacité pour le mode multiple
        function initMultipleCapacityControls() {
            const listContainer = document.getElementById('multipleTablesList');
            
            // Boutons + et - pour chaque table
            listContainer.querySelectorAll('.decrease-multiple').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const input = document.querySelector(`.table-capacity-input[data-index="${index}"]`);
                    let value = parseInt(input.value) || 8;
                    if (value > 1) {
                        input.value = value - 1;
                        multipleTablesData[index].capacity = value - 1;
                        highlightCurrentCapacityMultiple(index, value - 1);
                        updateTablePreview(); 
                    }
                });
            });
            
            listContainer.querySelectorAll('.increase-multiple').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    const input = document.querySelector(`.table-capacity-input[data-index="${index}"]`);
                    let value = parseInt(input.value) || 8;
                    if (value < 50) {
                        input.value = value + 1;
                        multipleTablesData[index].capacity = value + 1;
                        highlightCurrentCapacityMultiple(index, value + 1);
                        updateTablePreview(); 
                    }
                });
            });
            
            // Input direct
            listContainer.querySelectorAll('.table-capacity-input').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    let value = parseInt(this.value) || 8;
                    
                    // Limiter la valeur
                    if (value < 1) value = 1;
                    if (value > 50) value = 50;
                    
                    this.value = value;
                    multipleTablesData[index].capacity = value;
                    highlightCurrentCapacityMultiple(index, value);
                    updateTablePreview(); 
                });
                
                // S'assurer que la valeur est correcte à la perte de focus
                input.addEventListener('blur', function() {
                    const index = parseInt(this.dataset.index);
                    let value = parseInt(this.value) || 8;
                    
                    if (isNaN(value) || value < 1) {
                        value = 8;
                        this.value = 8;
                    } else if (value > 50) {
                        value = 50;
                        this.value = 50;
                    }
                    
                    multipleTablesData[index].capacity = value;
                    highlightCurrentCapacityMultiple(index, value);
                    updateTablePreview(); 
                });
            });
            
            // Boutons rapides de capacité pour chaque table
            listContainer.querySelectorAll('.multiple-quick-buttons').forEach(container => {
                const index = parseInt(container.dataset.index);
                const input = document.querySelector(`.table-capacity-input[data-index="${index}"]`);
                const currentValue = parseInt(input.value) || 8;
                
                // Mettre en surbrillance la capacité actuelle
                highlightCurrentCapacityMultiple(index, currentValue);
                
                // Ajouter les écouteurs pour les boutons rapides
                container.querySelectorAll('.quick-capacity-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const capacity = parseInt(this.dataset.capacity);
                        const input = document.querySelector(`.table-capacity-input[data-index="${index}"]`);
                        
                        input.value = capacity;
                        multipleTablesData[index].capacity = capacity;
                        highlightCurrentCapacityMultiple(index, capacity);
                        updateTablePreview(); 
                    });
                });

                // Écouteurs pour les noms de table
            listContainer.querySelectorAll('.table-name-input').forEach(input => {
                input.addEventListener('input', function() {
                    const index = parseInt(this.dataset.index);
                    multipleTablesData[index].tableName = this.value.trim();
                    updateTablePreview();
                });
            });
            });
        }

        // Mettre en surbrillance la capacité actuelle pour une table multiple
        function highlightCurrentCapacityMultiple(index, capacity) {
            const container = document.querySelector(`.multiple-quick-buttons[data-index="${index}"]`);
            if (!container) return;
            
            container.querySelectorAll('.quick-capacity-btn').forEach(btn => {
                const btnCapacity = parseInt(btn.dataset.capacity);
                
                if (btnCapacity === capacity) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
            
        // Dupliquer les paramètres
        function duplicateTableSettings() {
            if (multipleTablesData.length < 2) return;
            
            const firstTable = multipleTablesData[0];
            
            // Appliquer les paramètres de la première table à toutes les autres
            for (let i = 1; i < multipleTablesData.length; i++) {
                multipleTablesData[i].tableName = firstTable.tableName;
                multipleTablesData[i].capacity = firstTable.capacity;
            }
            
            renderMultipleTablesList();
            
            Toastify({
                text: "Paramètres dupliqués sur toutes les tables",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "var(--success)"
            }).showToast();
        }

        // Configurer l'étape 3
        function setupStep3() {
            if (creationMode === 'single') {
                document.getElementById('singleTableConfig').style.display = 'block';
                document.getElementById('multipleTablesConfig').style.display = 'none';
                
                // Remplir avec les données existantes si disponibles
                if (multipleTablesData[0]) {
                    document.getElementById('singleTableLocation').value = multipleTablesData[0].location || '';
                    document.getElementById('singleTableCategory').value = multipleTablesData[0].category || 'standard';
                    document.getElementById('singleTableDescription').value = multipleTablesData[0].description || '';
                }
                
                // Ajouter les écouteurs pour la mise à jour en temps réel
                const locationInput = document.getElementById('singleTableLocation');
                const categorySelect = document.getElementById('singleTableCategory');
                const descriptionTextarea = document.getElementById('singleTableDescription');
                
                if (locationInput) {
                    locationInput.addEventListener('input', updateTablePreview);
                    locationInput.addEventListener('change', updateTablePreview);
                }
                
                if (categorySelect) {
                    categorySelect.addEventListener('change', updateTablePreview);
                }
                
                if (descriptionTextarea) {
                    descriptionTextarea.addEventListener('input', updateTablePreview);
                }
                
            } else {
                document.getElementById('singleTableConfig').style.display = 'none';
                document.getElementById('multipleTablesConfig').style.display = 'block';
                
                // Remplir avec les données communes si disponibles
                if (multipleTablesData[0]) {
                    document.getElementById('multipleTablesLocation').value = multipleTablesData[0].location || '';
                    document.getElementById('multipleTablesCategory').value = multipleTablesData[0].category || 'standard';
                    document.getElementById('multipleTablesDescription').value = multipleTablesData[0].description || '';
                }
                
                // Ajouter les écouteurs pour la mise à jour en temps réel
                const locationInput = document.getElementById('multipleTablesLocation');
                const categorySelect = document.getElementById('multipleTablesCategory');
                const descriptionTextarea = document.getElementById('multipleTablesDescription');
                
                if (locationInput) {
                    locationInput.addEventListener('input', updateTablePreview);
                    locationInput.addEventListener('change', updateTablePreview);
                }
                
                if (categorySelect) {
                    categorySelect.addEventListener('change', updateTablePreview);
                }
                
                if (descriptionTextarea) {
                    descriptionTextarea.addEventListener('input', updateTablePreview);
                }
            }
            
            // Afficher l'aperçu
            document.getElementById('tablePreviewCard').style.display = 'block';
            updateTablePreview();
            
            // Ajouter l'écouteur pour le bouton actualiser
            document.getElementById('refreshPreviewBtn')?.addEventListener('click', updateTablePreview);
        }


        // Mettre à jour l'aperçu de la table
function updateTablePreview() {
    const previewContent = document.getElementById('previewTableContent');
    if (!previewContent) return;

    const scrollPos = previewContent.scrollTop;
    
    if (creationMode === 'single') {
        const table = multipleTablesData[0] || {};
        const location = document.getElementById('singleTableLocation')?.value || table.location || '';
        const category = document.getElementById('singleTableCategory')?.value || table.category || 'standard';
        const description = document.getElementById('singleTableDescription')?.value || table.description || '';
        
        previewContent.innerHTML = `
                ${isEditMode ? `
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-hashtag"></i> Numéro de table
                    </div>
                    <div class="preview-info-value highlight">#${escapeHtml(table.tableNumber || 'Génération...')}</div>
                </div>
                ` : ''}
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-tag"></i> Nom
                    </div>
                    <div class="preview-info-value">${escapeHtml(table.tableName || 'Non spécifié')}</div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-users"></i> Capacité
                    </div>
                    <div class="preview-info-value">
                        <span class="capacity-badge">${table.capacity || 8} places</span>
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-map-marker-alt"></i> Emplacement
                    </div>
                    <div class="preview-info-value ${location ? '' : 'empty'}">
                        ${escapeHtml(location || 'Non spécifié')}
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-tags"></i> Catégorie
                    </div>
                    <div class="preview-info-value category-${category}">
                        ${getCategoryLabel(category)}
                    </div>
                </div>
                
                ${description ? `
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-align-left"></i> Description
                    </div>
                    <div class="preview-info-value preview-description">
                        ${escapeHtml(description.substring(0, 100))}${description.length > 100 ? '...' : ''}
                    </div>
                </div>
                ` : ''}
           
        `;
    } else {
        // Mode multiple
        const location = document.getElementById('multipleTablesLocation')?.value || '';
        const category = document.getElementById('multipleTablesCategory')?.value || 'standard';
        const description = document.getElementById('multipleTablesDescription')?.value || '';
        const capacity = multipleTablesData[0]?.capacity || 8;
        
        previewContent.innerHTML = `
            <div class="preview-grid">
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-layer-group"></i> Nombre de tables
                    </div>
                    <div class="preview-info-value highlight">
                        ${multipleTablesData.length} table(s)
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-chair"></i> Capacité par table
                    </div>
                    <div class="preview-info-value">
                        <span class="capacity-badge">${capacity} places</span>
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-calculator"></i> Capacité totale
                    </div>
                    <div class="preview-info-value">
                        ${multipleTablesData.length * capacity} places
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-map-marker-alt"></i> Emplacement
                    </div>
                    <div class="preview-info-value ${location ? '' : 'empty'}">
                        ${escapeHtml(location || 'Commun')}
                    </div>
                </div>
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-tags"></i> Catégorie
                    </div>
                    <div class="preview-info-value category-${category}">
                        ${getCategoryLabel(category)}
                    </div>
                </div>
                
                ${description ? `
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-align-left"></i> Description
                    </div>
                    <div class="preview-info-value preview-description">
                        ${escapeHtml(description.substring(0, 100))}${description.length > 100 ? '...' : ''}
                    </div>
                </div>
                ` : ''}
                
                <div class="preview-info-item">
                    <div class="preview-info-label">
                        <i class="fas fa-list"></i> Liste des tables
                    </div>
                    <div class="preview-info-value table-list">
                        ${multipleTablesData.map((t, i) => `
                            <span class="table-pill">
                                ${i + 1}. ${escapeHtml(t.tableName || 'Table ' + (i + 1))}
                            </span>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

    previewContent.scrollTop = scrollPos;
    
    setTimeout(() => {
        const items = previewContent.querySelectorAll('.preview-info-item');
        items.forEach((item, index) => {
            setTimeout(() => {
                animatePreviewUpdate(item);
            }, index * 50);
        });
    }, 100);
    }
}

function animatePreviewUpdate(element) {
    if (element) {
        element.classList.add('updated');
        setTimeout(() => {
            element.classList.remove('updated');
        }, 500);
    }
}
        // Configurer l'étape 4
        async function setupStep4() {
            if (isEditMode) {
                document.getElementById('step4Subtitle').textContent = 
                    `Gérez les invités assignés à la table (modification)`;
            } else {
                document.getElementById('step4Subtitle').textContent = creationMode === 'single' ?
                    `Assignez des invités à votre table (optionnel)` :
                    'Assignez des invités aux tables (optionnel)';
            }
            
            await loadAvailableGuestsForCreation();
            
            if (isEditMode && selectedGuests.length > 0) {
                updateSelectedGuestsList();
            }
            
            // Mettre à jour le compteur et la capacité
            updateSelectedGuestsCount();
            updateCapacityInfo();
        }

        // Charger les invités disponibles pour la création
        async function loadAvailableGuestsForCreation() {
            try {
                const guests = await storage.getAllGuests({ eventId: currentEvent.id });
                
                // Pour l'édition, inclure les invités déjà assignés
                if (isEditMode) {
                    availableGuestsList = guests; 
                } else {
                    availableGuestsList = guests.filter(guest => !guest.tableId);
                }
                
                // Afficher la liste
                filterAvailableGuests('');
                
            } catch (error) {
                console.error('Erreur chargement invités:', error);
                document.getElementById('availableGuestsCreation').innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Impossible de charger les invités</p>
                    </div>
                `;
            }
        }
        

        // Filtrer les invités disponibles
        function filterAvailableGuests(searchTerm) {
            const container = document.getElementById('availableGuestsCreation');
            let filtered = [...availableGuestsList];
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(guest =>
                    guest.firstName?.toLowerCase().includes(term) ||
                    guest.lastName?.toLowerCase().includes(term) ||
                    guest.email?.toLowerCase().includes(term)
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-color); opacity: 0.5;">
                        <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 15px;"></i>
                        <p>Aucun invité disponible</p>
                        <small>Tous les invités sont déjà assignés ou aucun invité n'a été créé</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(guest => {
                const isSelected = selectedGuests.some(g => g.id === guest.id);
                const guestSeats = guest.seats || 1;
                const canSelect = canAddGuestToSelection(guest);
                
                return `
                    <div class="guest-select-item ${isSelected ? 'selected' : ''} ${!canSelect ? 'disabled' : ''}" 
                        data-guest-id="${guest.id}" 
                        style="margin-bottom: 10px; padding: 10px; border-radius: 8px; 
                                background: ${!canSelect ? 'var(--disabled-bg, #f3f4f6)' : 'var(--hover-bg)'}; 
                                cursor: ${!canSelect ? 'not-allowed' : 'pointer'}; 
                                opacity: ${!canSelect ? '0.6' : '1'};">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="guest-checkbox" style="width: 20px; height: 20px; border-radius: 4px; 
                                border: 2px solid ${!canSelect ? 'var(--border-color, #d1d5db)' : 'var(--border-color)'}; 
                                background: ${isSelected ? 'var(--primary)' : (!canSelect ? 'var(--disabled-bg, #f3f4f6)' : 'var(--input-bg)')}; 
                                display: flex; align-items: center; justify-content: center;">
                                ${isSelected ? '<i class="fas fa-check" style="color: white; font-size: 0.8rem;"></i>' : ''}
                            </div>
                            <div class="guest-avatar" style="width: 40px; height: 40px; border-radius: 50%; 
                                background: ${!canSelect ? 'var(--disabled-color, #9ca3af)' : 'var(--gradient)'}; 
                                display: flex; align-items: center; justify-content: center; 
                                color: white; font-weight: 600; font-size: 0.9rem;">
                                ${getInitials(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email)}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: ${!canSelect ? 'var(--disabled-text, #6b7280)' : 'var(--text-color)'};">
                                    ${escapeHtml(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email)}
                                </div>
                                <div style="font-size: 0.85rem; color: ${!canSelect ? 'var(--disabled-text, #6b7280)' : 'var(--text-color)'}; opacity: 0.7;">
                                    ${guest.email || ''} • ${guestSeats} place(s)
                                    ${!canSelect ? '<span style="color: var(--warning); margin-left: 5px;"><i class="fas fa-exclamation-triangle"></i> Capacité insuffisante</span>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Ajouter les écouteurs
            container.querySelectorAll('.guest-select-item:not(.disabled)').forEach(item => {
                item.addEventListener('click', function() {
                    const guestId = this.dataset.guestId;
                    toggleGuestSelection(guestId);
                });
            });
        }

        // Vérifier si un invité peut être ajouté à la sélection
        function canAddGuestToSelection(guest) {
            if (creationMode === 'multiple') return true; // Mode multiple: pas de vérification ici
            
            const capacity = getCurrentTableCapacity();
            const guestSeats = guest.seats || 1;
            
            // Si l'invité est déjà sélectionné, il peut être retiré
            if (selectedGuests.some(g => g.id === guest.id)) {
                return true;
            }
            
            // Calculer les places déjà occupées
            const occupiedSeats = selectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0);
            
            // Vérifier si on peut ajouter cet invité
            return (occupiedSeats + guestSeats) <= capacity;
        }

        // Obtenir la capacité actuelle de la table
        function getCurrentTableCapacity() {
            if (creationMode === 'single') {
                if (isEditMode && multipleTablesData[0]) {
                    return multipleTablesData[0].capacity || 8;
                }
                return parseInt(document.getElementById('singleTableCapacity').value) || 8;
            }
            
            return 9999;
        }

        // Basculer la sélection d'un invité
        function toggleGuestSelection(guestId) {
            const guest = availableGuestsList.find(g => g.id === guestId);
            if (!guest) return;
            
            const existingIndex = selectedGuests.findIndex(g => g.id === guestId);
            
            if (existingIndex === -1) {
                // Vérifier la capacité avant d'ajouter
                if (!canAddGuestToSelection(guest)) {
                    const capacity = getCurrentTableCapacity();
                    const occupiedSeats = selectedGuests.reduce((sum, g) => sum + (g.seats || 1), 0);
                    const guestSeats = guest.seats || 1;
                    const remainingSeats = capacity - occupiedSeats;
                    
                    Toastify({
                        text: `Capacité insuffisante. ${guestSeats} place(s) requise(s), ${remainingSeats} disponible(s)`,
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "var(--warning)"
                    }).showToast();
                    return;
                }
                
                selectedGuests.push(guest);
                Toastify({
                    text: "Invité sélectionné",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--success)"
                }).showToast();
            } else {
                selectedGuests.splice(existingIndex, 1);
                Toastify({
                    text: "Invité désélectionné",
                    duration: 2000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--info)"
                }).showToast();
            }
            
            filterAvailableGuests(document.getElementById('searchGuestsCreation').value);
            updateSelectedGuestsList();
            updateSelectedGuestsCount();
            updateCapacityInfo();
        }



       // Mettre à jour la liste des invités sélectionnés
        function updateSelectedGuestsList() {
            const container = document.getElementById('selectedGuestsList');
            
            if (selectedGuests.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 30px 20px; color: var(--text-color); opacity: 0.5;">
                        <i class="fas fa-user-plus" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>Aucun invité sélectionné</p>
                        <small>Sélectionnez des invités dans la liste ci-dessus</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = selectedGuests.map(guest => {
                const guestSeats = guest.seats || 1;
                
                return `
                    <div class="selected-guest-item" data-guest-id="${guest.id}" 
                        style="display: flex; justify-content: space-between; align-items: center; 
                                padding: 12px; margin-bottom: 8px; background: var(--hover-bg); 
                                border-radius: 8px; border-left: 4px solid var(--primary);">
                        <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                            <div class="guest-avatar" style="width: 36px; height: 36px; border-radius: 50%; 
                                background: var(--gradient); display: flex; align-items: center; 
                                justify-content: center; color: white; font-weight: 600; font-size: 0.85rem;">
                                ${getInitials(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email)}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--text-color);">
                                    ${escapeHtml(`${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email)}
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-color); opacity: 0.7; 
                                    display: flex; align-items: center; gap: 8px;">
                                    <span>${guest.email || ''}</span>
                                    <span style="background: var(--primary-light); color: white; 
                                        padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">
                                        <i class="fas fa-chair"></i> ${guestSeats} place(s)
                                    </span>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="remove-selected-guest" data-guest-id="${guest.id}"
                                style="background: none; border: none; color: var(--danger); cursor: pointer; 
                                    padding: 6px; border-radius: 4px; transition: all 0.3s ease;"
                                onmouseover="this.style.backgroundColor='var(--danger-light)'"
                                onmouseout="this.style.backgroundColor='transparent'"
                                title="Retirer cet invité">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // Ajouter les écouteurs pour supprimer
            container.querySelectorAll('.remove-selected-guest').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const guestId = this.dataset.guestId;
                    toggleGuestSelection(guestId);
                });
            });
        }

        // Mettre à jour le compteur d'invités sélectionnés
        function updateSelectedGuestsCount() {
            const countElement = document.getElementById('selectedGuestsCount');
            const totalSelectedSeats = selectedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
            
            if (countElement) {
                countElement.textContent = selectedGuests.length;
                countElement.title = `${totalSelectedSeats} place(s) occupée(s)`;
            }
        }




        // Mettre à jour les informations de capacité
        function updateCapacityInfo() {
            if (creationMode !== 'single') return;
            
            const capacity = getCurrentTableCapacity();
            const totalSelectedSeats = selectedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
            const remainingSeats = capacity - totalSelectedSeats;
            
            // Mettre à jour le sous-titre avec les informations de capacité
            const subtitle = document.getElementById('step4Subtitle');
            if (subtitle) {
                if (isEditMode) {
                    subtitle.textContent = `Gérez les invités assignés à la table (${totalSelectedSeats}/${capacity} places utilisées)`;
                } else {
                    subtitle.textContent = `Assignez des invités à votre table (${remainingSeats} place(s) disponible(s))`;
                }
            }
            
            const capacityIndicator = document.createElement('div');
            capacityIndicator.id = 'capacityIndicator';
            capacityIndicator.style.cssText = `
                margin: 10px 0;
                padding: 10px;
                background: ${remainingSeats === 0 ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)'};
                border-radius: 8px;
                border-left: 4px solid ${remainingSeats === 0 ? 'var(--danger)' : 'var(--success)'};
                font-size: 0.9rem;
                display: flex;
                align-items: center;
                justify-content: space-between;
            `;
            
            capacityIndicator.innerHTML = `
                <div>
                    <i class="fas fa-chart-pie" style="margin-right: 8px;"></i>
                    <strong>${totalSelectedSeats}/${capacity}</strong> places occupées
                </div>
                <div style="color: ${remainingSeats === 0 ? 'var(--danger)' : 'var(--success)'}; font-weight: 600;">
                    ${remainingSeats === 0 ? 'Table complète' : `${remainingSeats} place(s) disponible(s)`}
                </div>
            `;
            
            // Trouver ou créer l'indicateur de capacité
            let existingIndicator = document.getElementById('capacityIndicator');
            const selectedGuestsContainer = document.getElementById('selectedGuestsList');
            
            if (existingIndicator) {
                existingIndicator.replaceWith(capacityIndicator);
            } else if (selectedGuestsContainer && selectedGuests.length > 0) {
                selectedGuestsContainer.parentNode.insertBefore(capacityIndicator, selectedGuestsContainer);
            }
            
            // Mettre à jour l'état des invités disponibles
            filterAvailableGuests(document.getElementById('searchGuestsCreation').value);
        }

        // Fonction pour calculer l'occupation de la table
        function calculateTableOccupancy(tableCapacity, assignedGuests) {
            const totalSeats = assignedGuests.reduce((sum, guest) => sum + (guest.seats || 1), 0);
            const remainingSeats = Math.max(0, tableCapacity - totalSeats);
            const occupancyRate = tableCapacity > 0 ? Math.round((totalSeats / tableCapacity) * 100) : 0;
            
            return {
                totalSeats,
                remainingSeats,
                occupancyRate,
                isFull: totalSeats >= tableCapacity,
                isEmpty: totalSeats === 0
            };
        }



        // Auto-assignation dans la création
        async function autoAssignInCreation() {
            if (creationMode === 'single') {
                // Pour une table unique, assigner jusqu'à la capacité
                const table = multipleTablesData[0];
                const capacity = table.capacity;
                let seatsAvailable = capacity;
                
                // Sélectionner les invités non assignés
                const guestsToAssign = availableGuestsList.filter(guest => 
                    !selectedGuests.some(g => g.id === guest.id)
                );
                
                for (const guest of guestsToAssign) {
                    if (seatsAvailable <= 0) break;
                    
                    const guestSeats = guest.seats || 1;
                    if (guestSeats <= seatsAvailable) {
                        selectedGuests.push(guest);
                        seatsAvailable -= guestSeats;
                    }
                }
                
                filterAvailableGuests(document.getElementById('searchGuestsCreation').value);
                updateSelectedGuestsList();
                updateSelectedGuestsCount();
                
                Toastify({
                    text: `${selectedGuests.length} invité(s) auto-assigné(s)`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--success)"
                }).showToast();
            } else {
                // Pour le mode multiple, demander la stratégie
                const { value: strategy } = await Swal.fire({
                    title: 'Stratégie d\'auto-assignation',
                    input: 'select',
                    inputOptions: {
                        'fill': 'Remplir chaque table avant de passer à la suivante',
                        'distribute': 'Répartir uniformément sur toutes les tables',
                        'smart': 'Intelligente (par groupes)'
                    },
                    inputPlaceholder: 'Sélectionnez une stratégie',
                    showCancelButton: true,
                    confirmButtonText: 'Auto-assigner',
                    cancelButtonText: 'Annuler',
                    confirmButtonColor: '#D97706'
                });
                
                if (!strategy) return;
                
                // Implémenter la logique d'auto-assignation selon la stratégie
                // Pour l'instant, on assigne simplement les invités disponibles
                const availableGuests = availableGuestsList.filter(guest => 
                    !selectedGuests.some(g => g.id === guest.id)
                );
                
                // Limiter à un certain nombre pour éviter la surcharge
                const limit = Math.min(availableGuests.length, multipleTablesData.length * 5);
                const guestsToAdd = availableGuests.slice(0, limit);
                
                selectedGuests.push(...guestsToAdd);
                
                filterAvailableGuests(document.getElementById('searchGuestsCreation').value);
                updateSelectedGuestsList();
                updateSelectedGuestsCount();
                
                Toastify({
                    text: `${guestsToAdd.length} invité(s) auto-assigné(s)`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--success)"
                }).showToast();
            }
        }

        // Configurer l'étape 5
        function setupStep5() {
            document.getElementById('step5Subtitle').textContent = creationMode === 'single' ?
                'Vérifiez les informations de votre table avant création' :
                `Vérifiez les informations des ${multipleTablesData.length} tables avant création`;
            
            const confirmationContent = document.getElementById('confirmationContent');
            
            if (creationMode === 'single') {
                const table = multipleTablesData[0];
                confirmationContent.innerHTML = `
                    <div class="table-preview-card">
                        <div class="preview-table-content">
                            <div class="preview-info-item">
                                <div class="preview-info-label">Numéro de table</div>
                                <div class="preview-info-value">#${escapeHtml(table.tableNumber)}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Nom</div>
                                <div class="preview-info-value">${escapeHtml(table.tableName || 'Non spécifié')}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Capacité</div>
                                <div class="preview-info-value">${table.capacity} places</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Emplacement</div>
                                <div class="preview-info-value">${escapeHtml(table.location || 'Non spécifié')}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Catégorie</div>
                                <div class="preview-info-value">${getCategoryLabel(table.category || 'standard')}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Description</div>
                                <div class="preview-info-value" style="font-style: italic; opacity: 0.8;">
                                    ${escapeHtml(table.description || 'Aucune description')}
                                </div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Invités assignés</div>
                                <div class="preview-info-value">${selectedGuests.length} invité(s)</div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                const totalCapacity = multipleTablesData.reduce((sum, table) => sum + table.capacity, 0);
                const commonLocation = document.getElementById('multipleTablesLocation').value;
                const commonCategory = document.getElementById('multipleTablesCategory').value;
                const commonDescription = document.getElementById('multipleTablesDescription').value;
                
                confirmationContent.innerHTML = `
                    <div class="table-preview-card">
                        <div class="preview-table-content">
                            <div class="preview-info-item" style="grid-column: 1 / -1;">
                                <div class="preview-info-label">Nombre de tables</div>
                                <div class="preview-info-value">${multipleTablesData.length} tables</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Capacité totale</div>
                                <div class="preview-info-value">${totalCapacity} places</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Capacité moyenne</div>
                                <div class="preview-info-value">${Math.round(totalCapacity / multipleTablesData.length)} places/table</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Emplacement commun</div>
                                <div class="preview-info-value">${escapeHtml(commonLocation || 'Non spécifié')}</div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Catégorie commune</div>
                                <div class="preview-info-value">${getCategoryLabel(commonCategory || 'standard')}</div>
                            </div>
                            <div class="preview-info-item" style="grid-column: 1 / -1;">
                                <div class="preview-info-label">Description commune</div>
                                <div class="preview-info-value" style="font-style: italic; opacity: 0.8;">
                                    ${escapeHtml(commonDescription || 'Aucune description')}
                                </div>
                            </div>
                            <div class="preview-info-item" style="grid-column: 1 / -1;">
                                <div class="preview-info-label">Liste des tables</div>
                                <div class="preview-info-value" style="font-size: 0.9rem; opacity: 0.8; line-height: 1.6;">
                                    ${multipleTablesData.map((t, i) => 
                                        `Table ${i + 1}: #${escapeHtml(t.tableNumber)} (${t.capacity} places)`
                                    ).join('<br>')}
                                </div>
                            </div>
                            <div class="preview-info-item">
                                <div class="preview-info-label">Invités assignés</div>
                                <div class="preview-info-value">${selectedGuests.length} invité(s) à répartir</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Créer une table rapide
        async function createQuickTable() {
            try {
                // Générer un numéro de table unique
                let tableNumber = (allTables.length + 1).toString();
                let attempts = 0;
                
                while (allTables.some(t => t.tableNumber === tableNumber) && attempts < 100) {
                    tableNumber = (parseInt(tableNumber) + 1).toString();
                    attempts++;
                }
                
                const tableData = {
                    tableNumber,
                    tableName: `Table ${tableNumber}`,
                    capacity: 8,
                    location: 'Zone principale',
                    category: 'standard',
                    description: 'Table créée automatiquement',
                    eventId: currentEvent.id
                };
                
                const saveBtn = document.getElementById('quickTableBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<div class="spinner"></div>';
                
                const savedTable = await storage.createTable(currentEvent.id, tableData);
                
                if (savedTable) {
                    closeTableCreationModal();
                    await loadTables();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Table créée !',
                        text: `La table #${savedTable.tableNumber} a été créée avec succès`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                }
                
            } catch (error) {
                console.error('Erreur création table rapide:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible de créer la table',
                    confirmButtonColor: '#D97706'
                });
            } finally {
                const saveBtn = document.getElementById('quickTableBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        // Soumettre la création des tables
        async function submitTablesCreation() {
            try {
                const submitBtn = document.getElementById('submitTablesCreation');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<div class="spinner"></div>';
                
                let result;
                
                if (isEditMode && editingTableId) {
                    // MODE ÉDITION
                    const tableData = {
                        ...multipleTablesData[0],
                        eventId: currentEvent.id
                    };
                    
                    result = await storage.updateTable(editingTableId, tableData);
                    
                    // Gérer les invités assignés
                    if (selectedGuests.length > 0) {
                        // Retirer tous les invités existants
                        const table = allTables.find(t => t.id === editingTableId);
                        if (table && table.assignedGuests) {
                            for (const guest of table.assignedGuests) {
                                await storage.removeGuestFromTable(editingTableId, guest.guestId);
                            }
                        }
                        
                        // Assigner les nouveaux invités
                        for (const guest of selectedGuests) {
                            await storage.assignGuestToTable(editingTableId, guest.id, guest.seats || 1);
                        }
                    } else {
                        // Si aucun invité sélectionné, retirer tous les invités
                        const table = allTables.find(t => t.id === editingTableId);
                        if (table && table.assignedGuests) {
                            for (const guest of table.assignedGuests) {
                                await storage.removeGuestFromTable(editingTableId, guest.guestId);
                            }
                        }
                    }
                    
                } else {
                    // MODE CRÉATION
                    if (creationMode === 'single') {
                        // Créer une seule table
                        const tableData = {
                            ...multipleTablesData[0],
                            eventId: currentEvent.id
                        };
                        
                        result = await storage.createTable(currentEvent.id, tableData);
                        
                        // Assigner les invités si sélectionnés
                        if (result && selectedGuests.length > 0) {
                            for (const guest of selectedGuests) {
                                await storage.assignGuestToTable(result.id, guest.id, guest.seats || 1);
                            }
                        }
                        
                    } else {
                        // Créer plusieurs tables
                        const tablesToCreate = multipleTablesData.map(table => ({
                            ...table,
                            eventId: currentEvent.id
                        }));
                        
                        result = await storage.createMultipleTables(currentEvent.id, tablesToCreate);
                    }
                }
                
                if (result) {
                    closeTableCreationModal();
                    await loadTables();
                    
                    // Effets de succès
                    SECURA_AUDIO.play('success');
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                    
                    // Message de succès adapté
                    const successMessage = isEditMode ? 
                        'Table modifiée avec succès !' :
                        creationMode === 'single' ? 
                            'Table créée avec succès !' : 
                            `${multipleTablesData.length} tables créées avec succès !`;
                    
                    await Swal.fire({
                        icon: 'success',
                        title: isEditMode ? 'Modification réussie !' : 'Création réussie !',
                        html: `
                            <div style="text-align: center; padding: 20px 0;">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 15px;"></i>
                                <p style="font-size: 1.2rem; font-weight: 600; margin-bottom: 10px;">
                                    ${successMessage}
                                </p>
                                ${selectedGuests.length > 0 ? `
                                    <p style="color: rgba(255,255,255,0.8); margin-top: 10px;">
                                        <i class="fas fa-users"></i>
                                        ${selectedGuests.length} invité(s) assigné(s)
                                    </p>
                                ` : ''}
                            </div>
                        `,
                        confirmButtonColor: '#D97706',
                        timer: 3000,
                        showConfirmButton: false
                    });
                }
                
            } catch (error) {
                console.error('Erreur création/modification table:', error);
                
                SECURA_AUDIO.play('error');
                
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    html: `
                        <div style="text-align: center; padding: 20px 0;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: var(--danger); margin-bottom: 15px;"></i>
                            <p>Impossible de ${isEditMode ? 'modifier' : 'créer'} ${creationMode === 'single' ? 'la table' : 'les tables'}.</p>
                            <p style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-top: 10px;">
                                ${error.message || 'Une erreur est survenue. Veuillez réessayer.'}
                            </p>
                        </div>
                    `,
                    confirmButtonColor: '#D97706'
                });
            } finally {
                const submitBtn = document.getElementById('submitTablesCreation');
                submitBtn.disabled = false;
                submitBtn.innerHTML = isEditMode ? 
                    '<i class="fas fa-save"></i> Enregistrer les modifications' :
                    '<i class="fas fa-check-circle"></i> Créer les tables';
            }
        }

        // Mettre à jour la progression de création
        function updateCreationProgress() {
            const progress = Math.round(((creationStep - 1) / 4) * 100);
            
            // Mettre à jour le pourcentage (s'il existe)
            const progressPercentage = document.getElementById('creationProgressPercentage');
            if (progressPercentage) {
                progressPercentage.textContent = `${progress}%`;
            }
            
            // Mettre à jour la barre linéaire
            const progressBarFill = document.getElementById('progressBarFill');
            if (progressBarFill) {
                progressBarFill.style.width = `${Math.max(20, progress)}%`;
            }
        }

        // Mettre à jour l'indicateur de statut de l'événement
        function updateEventStatusIndicator() {
            const indicator = document.getElementById('eventStatusIndicator');
            if (!currentEvent) return;
            
            let statusText = '';
            let statusClass = '';
            
            switch(currentEvent.status) {
                case 'active':
                    statusText = 'Actif';
                    statusClass = 'status-active';
                    break;
                case 'draft':
                    statusText = 'Brouillon';
                    statusClass = 'status-inactive';
                    break;
                case 'archived':
                    statusText = 'Archivé';
                    statusClass = 'status-inactive';
                    break;
                default:
                    statusText = currentEvent.status;
                    statusClass = 'status-inactive';
            }
            
            indicator.innerHTML = `
                <i class="fas fa-circle"></i>
                <span>${statusText}</span>
            `;
            indicator.className = `status-indicator ${statusClass}`;
            indicator.style.display = 'flex';
        }

        // Mettre à jour l'interface
        function updateUI() {
            document.title = `SECURA | Tables - ${currentEvent?.name || 'Événement'}`;
        }

        // Afficher le loader
        function showLoader(view = 'all') {
            const loaders = {
                grid: 'gridLoader',
                table: 'tableLoader',
                visual: 'visualLoader',
                stats: 'statsLoader'
            };
            
            if (view === 'all') {
                Object.values(loaders).forEach(loaderId => {
                    const loader = document.getElementById(loaderId);
                    if (loader) loader.style.display = 'block';
                });
            } else if (loaders[view]) {
                const loader = document.getElementById(loaders[view]);
                if (loader) loader.style.display = 'block';
            }
        }

        // Cacher le loader
        function hideLoader(view = 'all') {
            const loaders = {
                grid: 'gridLoader',
                table: 'tableLoader',
                visual: 'visualLoader',
                stats: 'statsLoader'
            };
            
            if (view === 'all') {
                Object.values(loaders).forEach(loaderId => {
                    const loader = document.getElementById(loaderId);
                    if (loader) loader.style.display = 'none';
                });
            } else if (loaders[view]) {
                const loader = document.getElementById(loaders[view]);
                if (loader) loader.style.display = 'none';
            }
        }

        // Auto-assigner tous les invités
        async function autoAssignGuests() {
            const saveBtn = document.getElementById('autoAssignBtn');
            const originalText = saveBtn.innerHTML;
            
            const result = await Swal.fire({
                title: 'Auto-assigner les invités ?',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-robot" style="font-size: 4rem; color: var(--primary); margin-bottom: 15px;"></i>
                        <p>Cette opération assignera automatiquement tous les invités non assignés aux tables disponibles.</p>
                        <p style="color: var(--text-color); opacity: 0.7; font-size: 0.9rem; margin-top: 10px;">
                            Stratégie: Équilibrage optimal
                        </p>
                    </div>
                `,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Auto-assigner',
                cancelButtonText: 'Annuler',
                confirmButtonColor: '#D97706',
                cancelButtonColor: '#6B7280'
            });

            if (!result.isConfirmed) {
                return;
            }

            saveBtn.disabled = true;
            saveBtn.innerHTML = '<div class="spinner"></div>';
            
            try {
                
                
                const result = await storage.autoAssignGuests(currentEvent.id, 'balanced');
                
                if (result) {
                    await loadTables();
                    
                    await Swal.fire({
                        icon: 'success',
                        title: 'Auto-assignation terminée !',
                        html: `
                            <div style="text-align: center; padding: 20px 0;">
                                <i class="fas fa-check-circle" style="font-size: 4rem; color: var(--success); margin-bottom: 15px;"></i>
                                <p><strong>${result.assigned?.length || 0} invité(s)</strong> assigné(s) avec succès</p>
                                ${result.errors && result.errors.length > 0 ? `
                                    <p style="color: var(--warning); font-size: 0.9rem; margin-top: 10px;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        ${result.errors.length} erreur(s) rencontrée(s)
                                    </p>
                                ` : ''}
                            </div>
                        `,
                        confirmButtonColor: '#D97706'
                    });
                }
                
            } catch (error) {
                console.error('Erreur auto-assignation:', error);
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Impossible d\'auto-assigner les invités',
                    confirmButtonColor: '#D97706'
                });
            } finally {
                const saveBtn = document.getElementById('autoAssignBtn');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        // Exporter les tables
        async function exportTables() {
            try {
                const csv = [];
                const headers = ['Numéro', 'Nom', 'Capacité', 'Invités assignés', 'Places occupées', 'Places disponibles', 'Emplacement', 'Catégorie', 'Statut'];
                csv.push(headers.join(','));
                
                filteredTables.forEach(table => {
                    const totalSeats = table.assignedGuests?.reduce((sum, guest) => 
                        sum + (guest.seats || 1), 0) || 0;
                    const availableSeats = Math.max(0, (table.capacity || 0) - totalSeats);
                    const status = totalSeats >= table.capacity ? 'Complète' : 
                                  totalSeats === 0 ? 'Vide' : 'Partiellement occupée';
                    
                    const row = [
                        `"${table.tableNumber || ''}"`,
                        `"${table.tableName || ''}"`,
                        table.capacity,
                        table.assignedGuests?.length || 0,
                        totalSeats,
                        availableSeats,
                        `"${table.location || ''}"`,
                        `"${table.category || 'standard'}"`,
                        `"${status}"`
                    ];
                    
                    csv.push(row.join(','));
                });
                
                const csvContent = csv.join('\n');
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `secura-tables-${currentEvent.name}-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                Toastify({
                    text: `${filteredTables.length} tables exportées`,
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--success)"
                }).showToast();
                
            } catch (error) {
                console.error('Erreur export tables:', error);
                Toastify({
                    text: "Erreur lors de l'export",
                    duration: 3000,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "var(--danger)"
                }).showToast();
            }
        }

        // Fonctions utilitaires
        function showValidation(elementId, message, isValid) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            element.textContent = message;
            element.className = `validation-message ${isValid ? 'valid' : 'invalid'}`;
            element.style.opacity = '0';
            element.style.transform = 'translateY(-5px)';
            
            setTimeout(() => {
                element.style.opacity = '1';
                element.style.transform = 'translateY(0)';
            }, 10);
            
            return isValid;
        }

        function getInitials(name) {
    if (!name) return '?';
    return name.split(' ')
        .map(part => part.charAt(0))
        .join('')
        .toUpperCase()
        .substring(0, 2);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCategoryLabel(category) {
    const labels = {
        'vip': 'VIP',
        'family': 'Familiale',
        'speaker': 'Conférencier',
        'organizer': 'Organisateur',
        'standard': 'Standard',
        'mariage': 'Mariage',
        'anniversaire': 'Anniversaire'
    };
    return labels[category] || 'Standard';
}

        // Fonctions globales
        window.showTableDetails = async function(table) {
            await showEnhancedTableDetails(table);
        };


        async function removeGuestFromTable(tableId, guestId) {
            const table = allTables.find(t => t.id === tableId);
            const guest = table?.assignedGuests?.find(g => g.guestId === guestId);
            if (!table || !guest) return;
            
            const result = await Swal.fire({
                title: 'Retirer l\'invité ?',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-user-minus" style="font-size: 3rem; color: #F59E0B; margin-bottom: 15px;"></i>
                        <p>Êtes-vous sûr de vouloir retirer</p>
                        <p style="font-weight: 600; color: var(--primary);">${escapeHtml(guest.guestName)}</p>
                        <p style="font-size: 0.9rem; opacity: 0.7;">de la table <strong>#${escapeHtml(table.tableNumber)}</strong> ?</p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Oui, retirer',
                cancelButtonText: 'Annuler',
                confirmButtonColor: '#F59E0B',
                cancelButtonColor: '#6B7280',
                reverseButtons: true
            });
            
            if (result.isConfirmed) {
                try {
                    // Retirer l'invité de la table
                    table.assignedGuests = table.assignedGuests.filter(g => g.id !== guestId);
                    await storage.updateTable(tableId, table);
                    
                    // Recharger et réafficher
                    await loadTables();
                    
                    Toastify({
                        text: 'Invité retiré de la table',
                        duration: 2000,
                        backgroundColor: '#10B981'
                    }).showToast();
                } catch (error) {
                    console.error('Erreur retrait invité:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: 'Impossible de retirer l\'invité',
                        confirmButtonColor: '#D97706'
                    });
                }
            }
        };

        

        window.deleteTable = async function(tableId) {
            const table = allTables.find(t => t.id === tableId);
            if (!table) return;
            
            const result = await Swal.fire({
                title: 'Supprimer la table ?',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #EF4444; margin-bottom: 15px;"></i>
                        <p>La table <strong>#${escapeHtml(table.tableNumber)}</strong> sera définitivement supprimée.</p>
                        ${table.assignedGuests && table.assignedGuests.length > 0 ? `
                            <p style="color: var(--warning); font-size: 0.9rem; margin-top: 10px;">
                                <i class="fas fa-users"></i>
                                ${table.assignedGuests.length} invité(s) seront retiré(s) de cette table
                            </p>
                        ` : ''}
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Oui, supprimer',
                cancelButtonText: 'Annuler',
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6B7280',
                reverseButtons: true
            });
            
            if (result.isConfirmed) {
                try {
                    await storage.deleteTable(tableId);
                    await loadTables();
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Supprimé !',
                        text: 'La table a été supprimée avec succès',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } catch (error) {
                    console.error('Erreur suppression table:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: 'Impossible de supprimer la table',
                        confirmButtonColor: '#D97706'
                    });
                }
            }
        };

        let tablesCsvCurrentStep = 1;
        let tablesCsvRawData = [];
        let tablesCsvValidatedData = [];
        let tablesCsvEventSelected = null;

       

        function initializeTablesCsvImport() {

            const importBtn = document.getElementById('importTablesBtn');
            if (importBtn) {
                importBtn.addEventListener('click', openTablesCsvImportModal);
            }

            const closeCsvBtn = document.getElementById('closeTablesCsvBtn');
            if (closeCsvBtn) {
                closeCsvBtn.addEventListener('click', closeTablesCsvImportModal);
            }

            const closeModalBtn = document.getElementById('closeTablesCsvModalBtn');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeTablesCsvImportModal);
            }

            const downloadTemplateBtn = document.getElementById('downloadTablesCsvTemplateBtn');
            if (downloadTemplateBtn) {
                downloadTemplateBtn.addEventListener('click', downloadTablesCsvTemplate);
            }

            const csvFileInput = document.getElementById('tablesCsvFileInput');
            const csvDropZone = document.getElementById('tablesCsvDropZone');

            if (csvFileInput && csvDropZone) {
                csvDropZone.addEventListener('click', () => csvFileInput.click());
                csvFileInput.addEventListener('change', handleTablesCsvFileSelect);

                // Drag & Drop
                csvDropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    csvDropZone.style.borderColor = 'var(--primary)';
                    csvDropZone.style.backgroundColor = 'rgba(217, 119, 6, 0.05)';
                });

                csvDropZone.addEventListener('dragleave', () => {
                    csvDropZone.style.borderColor = 'var(--border-color)';
                    csvDropZone.style.backgroundColor = 'transparent';
                });

                csvDropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    csvDropZone.style.borderColor = 'var(--border-color)';
                    csvDropZone.style.backgroundColor = 'transparent';

                    const file = e.dataTransfer.files[0];
                    if (file && file.name.endsWith('.csv')) {
                        handleTablesCsvFile(file);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Format invalide',
                            text: 'Veuillez sélectionner un fichier CSV',
                            confirmButtonColor: '#D97706'
                        });
                    }
                });
            }

            console.log('✅ Système d\'import CSV pour tables initialisé');
        }

        // ========== OUVERTURE DU MODAL D'IMPORT ==========
        function openTablesCsvImportModal() {
            console.log('📥 Ouverture du modal d\'import CSV pour tables');

            if (!currentEvent || !currentEvent.id) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Aucun événement sélectionné',
                    text: 'Veuillez d\'abord sélectionner un événement',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            tablesCsvCurrentStep = 1;
            tablesCsvRawData = [];
            tablesCsvValidatedData = [];
            tablesCsvEventSelected = currentEvent;

            const eventNameEl = document.getElementById('tablesCsvEventName');
            if (eventNameEl && tablesCsvEventSelected) {
                eventNameEl.textContent = tablesCsvEventSelected.name;
            }

            const fileInput = document.getElementById('tablesCsvFileInput');
            if (fileInput) {
                fileInput.value = '';
            }

            showTablesCsvStep(1);

            const modal = document.getElementById('tablesCsvImportModal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        // ========== FERMETURE DU MODAL D'IMPORT ==========
        function closeTablesCsvImportModal() {
            console.log('✗ Fermeture du modal d\'import CSV pour tables');

            const modal = document.getElementById('tablesCsvImportModal');
            if (modal) {
                modal.classList.remove('active');
                tablesCsvCurrentStep = 1;
                tablesCsvRawData = [];
                tablesCsvValidatedData = [];
                tablesCsvEventSelected = null;
            }
        }

        // ========== GESTION DE LA SÉLECTION DE FICHIER CSV ==========
        function handleTablesCsvFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleTablesCsvFile(file);
            }
        }

        function handleTablesCsvFile(file) {
            console.log(`📄 Fichier CSV sélectionné: ${file.name}`);

            if (!file.name.endsWith('.csv')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Format invalide',
                    text: 'Seuls les fichiers CSV sont acceptés',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            if (!tablesCsvEventSelected) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Aucun événement sélectionné',
                    text: 'Veuillez d\'abord sélectionner un événement',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    parseTablesCsvData(csvContent);
                } catch (error) {
                    console.error('❌ Erreur lecture fichier CSV:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: 'Erreur de lecture du fichier CSV',
                        confirmButtonColor: '#D97706'
                    });
                }
            };

            reader.onerror = function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Erreur de lecture du fichier',
                    confirmButtonColor: '#D97706'
                });
            };

            reader.readAsText(file, 'UTF-8');
        }

        // ========== PARSING DU FICHIER CSV ==========
        // ========== PARSING DU FICHIER CSV (CORRIGÉ POUR UTF-8) ==========
function parseTablesCsvData(csvContent) {
    console.log('📄 Début du parsing CSV avec gestion UTF-8');
    
    // Détection de l'encodage BOM UTF-8
    if (csvContent.charCodeAt(0) === 0xFEFF) {
        csvContent = csvContent.substring(1);
    }
    
    if (window.Papa) {
        Papa.parse(csvContent, {
            header: true,
            skipEmptyLines: true,
            encoding: 'UTF-8',
            complete: function(results) {
                console.log('✅ CSV parsé avec PapaParse:', results.data.length, 'lignes');
                // Nettoyer les caractères UTF-8
                const cleanedData = results.data.map(row => {
                    const cleanedRow = {};
                    for (const [key, value] of Object.entries(row)) {
                        if (typeof value === 'string') {
                            // Décoder les entités HTML et nettoyer
                            let cleanedValue = value.trim();
                            
                            // Nettoyer les caractères mal encodés
                            cleanedValue = cleanedValue
                                .replace(/Ã©/g, 'é')
                                .replace(/Ãª/g, 'ê')
                                .replace(/Ã¨/g, 'è')
                                .replace(/Ã§/g, 'ç')
                                .replace(/Ã´/g, 'ô')
                                .replace(/Ã¹/g, 'ù')
                                .replace(/Ã®/g, 'î')
                                .replace(/Ã¢/g, 'â')
                                .replace(/Ã¨/g, 'è')
                                .replace(/Ã/g, 'à')
                                .replace(/â¬/g, '€')
                                .replace(/â/g, "'")
                                .replace(/â/g, "'")
                                .replace(/â/g, '"')
                                .replace(/â/g, '"')
                                .replace(/â/g, '-');
                            
                            // Décoder les entités HTML
                            const textarea = document.createElement('textarea');
                            textarea.innerHTML = cleanedValue;
                            cleanedValue = textarea.value;
                            
                            cleanedRow[key] = cleanedValue;
                        } else {
                            cleanedRow[key] = value;
                        }
                    }
                    return cleanedRow;
                });
                
                console.log('🧹 Données nettoyées:', cleanedData);
                displayTablesCsvPreview(cleanedData);
            },
            error: function(error) {
                console.error('❌ Erreur parsing CSV:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Erreur de parsing du fichier CSV. Vérifiez le format.',
                    confirmButtonColor: '#D97706'
                });
            }
        });
    } else {
        // Méthode fallback améliorée pour UTF-8
        try {
            const parseCSVLine = (line) => {
                const result = [];
                let current = '';
                let insideQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (insideQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            insideQuotes = !insideQuotes;
                        }
                    } else if (char === ',' && !insideQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current);
                return result;
            };
            
            // Diviser les lignes en tenant compte des sauts de ligne Windows/Unix
            const lines = csvContent.split(/\r\n|\n|\r/).filter(line => line.trim() !== '');
            
            if (lines.length < 2) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Fichier CSV vide ou invalide',
                    confirmButtonColor: '#D97706'
                });
                return;
            }
            
            const headers = parseCSVLine(lines[0]).map(h => {
                let header = h.trim().replace(/^"|"$/g, '');
                // Nettoyer l'UTF-8 dans les en-têtes
                header = header
                    .replace(/Ã©/g, 'é')
                    .replace(/Ãª/g, 'ê')
                    .replace(/Ã¨/g, 'è')
                    .replace(/Ã§/g, 'ç')
                    .normalize();
                return header;
            });
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                
                const values = parseCSVLine(lines[i]).map(v => {
                    let value = v.trim().replace(/^"|"$/g, '');
                    // Nettoyer l'UTF-8 dans les valeurs
                    value = value
                        .replace(/Ã©/g, 'é')
                        .replace(/Ã©/g, '')
                        .replace(/Ãª/g, 'ê')
                        .replace(/Ã¨/g, 'è')
                        .replace(/Ã§/g, 'ç')
                        .replace(/Ã´/g, 'ô')
                        .replace(/Ã¹/g, 'ù')
                        .replace(/Ã®/g, 'î')
                        .replace(/Ã¢/g, 'â')
                        .normalize();
                    
                    // Décoder les entités HTML
                    const textarea = document.createElement('textarea');
                    textarea.innerHTML = value;
                    value = textarea.value;
                    
                    return value;
                });
                
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                
                data.push(row);
            }
            
            console.log('✅ CSV parsé avec méthode fallback:', data);
            displayTablesCsvPreview(data);
            
        } catch (error) {
            console.error('❌ Erreur parsing fallback:', error);
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: 'Impossible de lire le fichier CSV. Vérifiez le format.',
                confirmButtonColor: '#D97706'
            });
        }
    }
}
        // ========== AFFICHAGE DE L'APERÇU CSV ==========
        function displayTablesCsvPreview(data) {
            console.log(`📊 Aperçu CSV: ${data.length} ligne(s) trouvée(s)`);

            if (data.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Avertissement',
                    text: 'Aucune donnée valide trouvée dans le fichier',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            tablesCsvRawData = data;

            Swal.fire({
                title: '⏳ Chargement...',
                html: '<p>Préparation de la validation...</p>',
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: async () => {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    Swal.close();
                    tablesCsvCurrentStep = 1;
                    showTablesCsvStep(2);
                    openTablesCsvEditModal(data);
                }
            });
        }

        // ========== MODAL D'ÉDITION CSV (CORRIGÉ POUR SUPPRESSION) ==========
// ========== MODAL D'ÉDITION CSV (LOGIQUE COMPLÈTE / STYLE INTACT) ==========
// ========== MODAL D'ÉDITION CSV (LOGIQUE COMPLÈTE / STYLE INTACT) ==========
function openTablesCsvEditModal(data) {
    const requiredFields = {
        'tableName': { required: true, default: '' },
        'capacity': { required: true, default: '4' },
        'location': { required: false, default: '' },
        'category': { required: false, default: 'general' },
        'description': { required: false, default: '' }
    };

    // Initialisation / Nettoyage
    data.forEach((row, index) => {
        if (!row._id) row._id = `row_${Date.now()}_${index}`;
        if (row._toDelete === undefined) row._toDelete = false;
        Object.keys(requiredFields).forEach(field => {
            if (row[field] === undefined || row[field] === null) row[field] = requiredFields[field].default;
        });
    });

    const headers = ['tableName', 'capacity', 'category', 'location', 'description'];
    const categoryOptions = ['general', 'vip', 'premium', 'standard', 'special', 'organisateur', 'conferencier'];

    let html = `<div style="max-height:80vh;display:flex;flex-direction:column;gap:16px;">`;
    
    // Header (Style Intact)
    html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;">
                <i class="fas fa-file-csv" style="font-size:24px;color:var(--primary)"></i>
                <h3 style="margin:0;color:var(--text-color);font-size:18px;font-weight:700">Import CSV - Édition des Tables</h3>
             </div>`;

    // Stats Bar (Style Intact)
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding:0 12px;">
                <div style="font-weight:600;color:var(--text-color)"><strong>${data.length}</strong> ligne(s) détectée(s)</div>
                <div style="font-size:13px;color:var(--text-color); display:flex; flex-direction:row;align-items:end;"> Invalides: <span id="sw_csv_invalid_count_tables" style="color:var(--danger);font-weight:600">0</span> - Valides: <span id="sw_csv_valid_count_tables" style="color:var(--success);font-weight:700;font-size:14px">${data.length}</span><button type="button" id="sw_csv_add_new_row_btn" class="btn btn-success" style="margin-left:15px;flex:1;padding:10px;font-weight:600;"><i class="fas fa-plus"></i> Ajouter une ligne</button></div>
             </div>`;

    const markedForDeletion = data.filter(row => row._toDelete);
    if (markedForDeletion.length > 0) {
        html += `<div id="deletion-section" style="background:rgba(239, 68, 68, 0.1);border:1px solid rgba(239, 68, 68, 0.3);border-radius:6px;padding:12px;margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div><i class="fas fa-trash" style="color:var(--danger)"></i> <strong>${markedForDeletion.length}</strong> ligne(s) marquée(s) pour suppression</div>
                        <button type="button" id="sw_csv_confirm_delete_btn" class="btn btn-danger btn-sm" style="padding:4px 8px;"><i class="fas fa-check"></i> Confirmer suppression</button>
                    </div>
                 </div>`;
    }

    html += `<div style="overflow-x:auto;flex:1;border:1px solid var(--border-color);border-radius:6px;">`;
    html += `<table class="data-table-pro" style="width:100%;border-collapse:collapse;">`;
    
    html += `<thead><tr style="background:var(--hover-bg);">`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Nom de la Table <span style="color:#ff4444;font-weight:700">*</span></th>`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Capacité <span style="color:#ff4444;font-weight:700">*</span></th>`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Catégorie</th>`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Localisation</th>`;
    html += `<th style="padding:14px;text-align:left;font-weight:600;font-size:13px;border-right:1px solid var(--border-color);white-space:nowrap">Description</th>`;
    html += `<th style="padding:14px;text-align:center;font-weight:600;font-size:13px;width:60px;white-space:nowrap">État</th>`;
    html += `<th style="padding:14px;text-align:center;font-weight:600;font-size:13px;width:80px;white-space:nowrap">Actions</th>`;
    html += `</tr></thead><tbody id="sw_csv_tbody_tables">`;

    // Afficher d'abord les lignes normales, puis les lignes marquées
    const normalRows = data.filter(row => !row._toDelete);
    const deletionRows = data.filter(row => row._toDelete);
    const allRows = [...normalRows, ...deletionRows];

    allRows.forEach((row) => {
        const isMarked = row._toDelete;
        const rowStyle = isMarked ? 'background:rgba(239, 68, 68, 0.08);opacity:0.6;' : '';
        
        html += `<tr id="sw_csv_row_tables_${row._id}" class="csv-data-row" style="border-bottom:1px solid var(--border-color);${rowStyle}">`;
       
        headers.forEach(h => {
            const val = row[h] !== undefined && row[h] !== null ? String(row[h]) : requiredFields[h].default;
            const safeKey = String(h).replace(/[^\w\-]/g, '_');
            const isRequired = requiredFields[h]?.required;
            const reqStyle = isRequired ? 'border:1px solid rgba(255, 68, 68, 0.3);' : '';
            const disabledStyle = isMarked ? 'opacity:0.5;pointer-events:none;' : '';

            if (h === 'category') {
                html += `<td style="padding:10px;"><select ${isMarked ? 'disabled' : ''} data-id="${row._id}" data-key="${h}" id="sw_csv_${row._id}_${safeKey}" class="sw-csv-input form-control" style="width:100%;box-sizing:border-box;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;background:var(--input-bg);color:var(--text-color);${reqStyle}${disabledStyle}">`;
                categoryOptions.forEach(opt => {
                    const selected = val.toLowerCase() === opt ? 'selected' : '';
                    html += `<option value="${opt}" ${selected}>${opt}</option>`;
                });
                html += `</select></td>`;
            } else if (h === 'capacity') {
                html += `<td style="padding:10px;"><input ${isMarked ? 'disabled' : ''} type="number" data-id="${row._id}" data-key="${h}" id="sw_csv_${row._id}_${safeKey}" class="sw-csv-input form-control" value="${escapeHtml(val)}" min="1" style="width:100%;box-sizing:border-box;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;background:var(--input-bg);color:var(--text-color);${reqStyle}${disabledStyle}" /></td>`;
            } else {
                html += `<td style="padding:10px;"><input ${isMarked ? 'disabled' : ''} type="text" data-id="${row._id}" data-key="${h}" id="sw_csv_${row._id}_${safeKey}" class="sw-csv-input form-control" value="${escapeHtml(val)}" style="width:100%;box-sizing:border-box;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:12px;background:var(--input-bg);color:var(--text-color);${reqStyle}${disabledStyle}" /></td>`;
            }
        });
        
        html += `<td style="padding:10px;text-align:center;white-space:nowrap;"><span id="sw_csv_badge_tables_${row._id}" class="badge ${isMarked ? 'bg-secondary' : 'bg-warning'}" style="font-size:14px;padding:6px 8px;">${isMarked ? '🗑️' : '?'}</span></td>`;
        html += `<td style="padding:10px;text-align:center;white-space:nowrap;display:flex;gap:5px;justify-content:space-around;align-items:center;">`;
        
        if (isMarked) {
            html += `<button type="button" class="action-btn btn-sm btn-success sw-csv-restore-row" data-id="${row._id}" style="padding:4px 8px;font-size:12px;" title="Restaurer"><i class="fas fa-undo"></i></button>`;
        } else {
            html += `<button type="button" class="action-btn btn-sm btn-danger delete sw-csv-mark-delete" data-id="${row._id}" style="padding:4px 8px;font-size:12px;" title="Marquer pour suppression"><i class="fas fa-trash"></i></button>`;
            html += `<button type="button" class="action-btn btn-success success sw-csv-add-after" data-id="${row._id}" style="padding:4px 8px;font-size:12px;" title="Ajouter après"><i class="fas fa-plus"></i></button>`;
        }
        
        html += `</td>`;
        html += `</tr>`;
        
        // Ligne d'erreurs (seulement pour les lignes non marquées)
        if (!isMarked) {
            html += `<tr id="sw_csv_errors_tables_${row._id}" class="table-row-errors" style="display:none;border-bottom:1px solid var(--border-color);background:rgba(239, 68, 68, 0.05);border-left: 3px solid rgb(239, 68, 68);">`;
            html += `<td colspan="${headers.length + 3}" style="padding:8px 10px;">`;
            html += `<div id="sw_csv_errors_content_tables_${row._id}" style="font-size:12px;display:flex;gap:12px;flex-wrap:wrap;"></div>`;
            html += `</td>`;
            html += `</tr>`;
        }
    });

    html += `</tbody></table></div>`;

    html += `<div style="background:rgba(59, 130, 246, 0.05);padding:10px 12px;border-radius:4px;font-size:12px;color:var(--text-color);border-left:3px solid var(--info);margin-top:12px;">`;
    html += `<i class="fas fa-circle-info"></i> <strong>Conseils:</strong> Les champs marqués d'un * sont obligatoires. Utilisez les boutons dans la colonne Actions pour ajouter ou supprimer des lignes.`;
    html += `</div>`;

    html += `</div>`;

    Swal.fire({
        title: '',
        html,
        width: '95%',
        showCancelButton: true,
        confirmButtonText: 'Continuer vers validation',
        cancelButtonText: 'Annuler',
        confirmButtonColor: 'var(--primary)',
        cancelButtonColor: '#888',
        didOpen: () => {
            const popup = Swal.getPopup();

            // Fonction pour rafraîchir les marques de validation
            const refreshValidationMarks = () => {
                let invalid = 0;
                let valid = 0;

                data.forEach((row) => {
                    if (row._toDelete) return; // Ignorer les lignes marquées pour suppression
                    
                    const errors = [];
                    const tableName = row['tableName']?.trim();
                    const capacity = row['capacity']?.trim();
                    
                    if (!tableName) errors.push('<i class="fas fa-exclamation-circle"></i> Nom de la table requis');
                    else if (tableName.length < 2) errors.push('<i class="fas fa-exclamation-circle"></i> Nom min. 2 caractères');
                    
                    if (!capacity || isNaN(parseInt(capacity))) errors.push('<i class="fas fa-exclamation-circle"></i> Capacité invalide');
                    else if (parseInt(capacity) < 1) errors.push('<i class="fas fa-exclamation-circle"></i> Capacité minimum: 1');

                    const isValid = errors.length === 0;
                    
                    const tr = document.getElementById(`sw_csv_row_tables_${row._id}`);
                    const badgeEl = document.getElementById(`sw_csv_badge_tables_${row._id}`);
                    const errorRow = document.getElementById(`sw_csv_errors_tables_${row._id}`);
                    const errorContent = document.getElementById(`sw_csv_errors_content_tables_${row._id}`);
                    
                    if (tr) {
                        if (!isValid) {
                            tr.style.background = 'rgba(239, 68, 68, 0.08)';
                            tr.style.borderLeft = '3px solid #ef4444';
                            if (badgeEl) {
                                badgeEl.className = 'badge bg-danger';
                                badgeEl.innerHTML = '<i class="fas fa-xmark" style="font-size:16px;color:#ef4444;"></i>';
                            }
                            invalid++;
                        } else {
                            tr.style.background = 'rgba(16, 185, 129, 0.08)';
                            tr.style.borderLeft = '3px solid #10b981';
                            if (badgeEl) {
                                badgeEl.className = 'badge bg-success';
                                badgeEl.innerHTML = '<i class="fas fa-check" style="font-size:16px;color:#10b981;"></i>';
                            }
                            valid++;
                        }
                    }

                    // Affichage/masquage ligne d'erreurs
                    if (errorRow) {
                        if (errors.length > 0) {
                            errorRow.style.display = 'table-row';
                            if (errorContent) {
                                errorContent.innerHTML = errors.map(e => `<span style="background:rgba(239, 68, 68, 0.2);padding:4px 8px;border-radius:4px;border-left:2px solid #ef4444;">${e}</span>`).join('');
                            }
                        } else {
                            errorRow.style.display = 'none';
                        }
                    }
                });

                const invalidCountEl = popup.querySelector('#sw_csv_invalid_count_tables');
                const validCountEl = popup.querySelector('#sw_csv_valid_count_tables');
                
                if (invalidCountEl) invalidCountEl.textContent = String(invalid);
                if (validCountEl) validCountEl.textContent = String(valid);
            };

            // Event listeners pour les inputs
            const inputs = popup.querySelectorAll('.sw-csv-input:not([disabled])');
            inputs.forEach(inp => {
                inp.addEventListener('change', () => {
                    const row = data.find(r => r._id === inp.dataset.id);
                    if (row) {
                        row[inp.dataset.key] = inp.value;
                        refreshValidationMarks();
                    }
                });
                inp.addEventListener('input', () => {
                    const row = data.find(r => r._id === inp.dataset.id);
                    if (row) {
                        row[inp.dataset.key] = inp.value;
                        refreshValidationMarks();
                    }
                });
            });

            // Event listeners pour ajouter/supprimer des lignes
            const markDeleteButtons = popup.querySelectorAll('.sw-csv-mark-delete');
            const addAfterButtons = popup.querySelectorAll('.sw-csv-add-after');
            const restoreButtons = popup.querySelectorAll('.sw-csv-restore-row');

            // Marquer pour suppression
            markDeleteButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const row = data.find(r => r._id === btn.dataset.id);
                    if (row) {
                        row._toDelete = true;
                        Swal.close();
                        setTimeout(() => {
                            openTablesCsvEditModal(data);
                        }, 50);
                    }
                });
            });

            // Ajouter après une ligne
            addAfterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const idx = data.findIndex(r => r._id === btn.dataset.id);
                    const newRow = {
                        _id: `row_${Date.now()}_${data.length}`,
                        _toDelete: false,
                        tableName: '',
                        capacity: '4',
                        location: '',
                        category: 'general',
                        description: ''
                    };
                    data.splice(idx + 1, 0, newRow);
                    Swal.close();
                    setTimeout(() => {
                        openTablesCsvEditModal(data);
                    }, 50);
                });
            });

            // Restaurer une ligne
            restoreButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const row = data.find(r => r._id === btn.dataset.id);
                    if (row) {
                        row._toDelete = false;
                        Swal.close();
                        setTimeout(() => {
                            openTablesCsvEditModal(data);
                        }, 50);
                    }
                });
            });

            // Ajouter une ligne à la fin
            const addNewRowBtn = popup.querySelector('#sw_csv_add_new_row_btn');
            if (addNewRowBtn) {
                addNewRowBtn.addEventListener('click', () => {
                    const newRow = {
                        _id: `row_${Date.now()}_${data.length}`,
                        _toDelete: false,
                        tableName: '',
                        capacity: '4',
                        location: '',
                        category: 'general',
                        description: ''
                    };
                    data.push(newRow);
                    Swal.close();
                    setTimeout(() => {
                        openTablesCsvEditModal(data);
                    }, 50);
                });
            }

            // Confirmer la suppression définitive
            const confirmDeleteBtn = popup.querySelector('#sw_csv_confirm_delete_btn');
            if (confirmDeleteBtn) {
                confirmDeleteBtn.addEventListener('click', () => {
                    Swal.close();
                    // Filtrer pour garder seulement les lignes non marquées
                    const filteredData = data.filter(row => !row._toDelete);
                    
                    if (filteredData.length === 0) {
                        // Retour à l'étape 1 si plus de données
                        tablesCsvCurrentStep = 1;
                        showTablesCsvStep(1);
                        
                        // Réinitialiser le fichier input
                        const csvFileInput = document.getElementById('tablesCsvFileInput');
                        if (csvFileInput) {
                            csvFileInput.value = '';
                        }
                        
                        Swal.fire({
                            icon: 'info',
                            title: 'Import annulé',
                            text: 'Toutes les lignes ont été supprimées. Vous pouvez relancer un import.',
                            confirmButtonColor: 'var(--primary)'
                        });
                    } else {
                        setTimeout(() => {
                            openTablesCsvEditModal(filteredData);
                        }, 50);
                    }
                });
            }

            // Initialiser la validation
            refreshValidationMarks();
        },
        preConfirm: () => {
            // Filtrer les lignes marquées pour suppression
            const filteredData = data.filter(row => !row._toDelete);
            
            // Vérifier qu'il n'y a pas d'erreurs
            let hasErrors = false;
            filteredData.forEach(row => {
                if (!row.tableName || row.tableName.trim().length < 2) hasErrors = true;
                if (!row.capacity || parseInt(row.capacity) < 1) hasErrors = true;
            });
            
            if (hasErrors) {
                Swal.showValidationMessage('Veuillez corriger toutes les erreurs avant de continuer');
                return false;
            }
            
            // Nettoyer les données (enlever _id et _toDelete)
            const cleanData = filteredData.map(row => {
                const { _id, _toDelete, ...cleanRow } = row;
                return cleanRow;
            });
            
            return cleanData;
        }
    }).then((res) => {
        if (res.isConfirmed) {
            // Mettre à jour les données globales
            tablesCsvRawData = res.value;
            prepareTablesCsvValidationStep();
        } else if (res.isDismissed) {
            // Annuler - retour à l'étape 1
            tablesCsvCurrentStep = 1;
            showTablesCsvStep(1);
            tablesCsvRawData = [];
            tablesCsvValidatedData = [];
            
            // Réinitialiser le fichier input
            const csvFileInput = document.getElementById('tablesCsvFileInput');
            if (csvFileInput) {
                csvFileInput.value = '';
            }
        }
    });
}
        // ========== ÉTAPE DE VALIDATION ==========
        function prepareTablesCsvValidationStep() {
            console.log('🔄 Préparation de l\'étape 2: validation');

            tablesCsvCurrentStep = 2;
            showTablesCsvStep(2);

            tablesCsvValidatedData = tablesCsvRawData.map((row, idx) => {
                const tableName = row['tableName']?.trim();
                const capacity = parseInt(row['capacity'] || '4') || 4;
                const location = row['location']?.trim() || '';
                const category = row['category']?.toLowerCase()?.trim() || 'general';
                const description = row['description']?.trim() || '';

                const errors = [];
                if (!tableName) errors.push('Nom de la table requis');
                else if (tableName.length < 2) errors.push('Nom min. 2 caractères');
                
                if (!capacity || capacity < 1) errors.push('Capacité invalide');

                const isValid = errors.length === 0;

                return {
                    index: idx,
                    tableName,
                    capacity: Math.max(1, capacity),
                    location,
                    category,
                    description,
                    isValid,
                    errors
                };
            });

            renderTablesCsvValidationWithSwal();
        }

        // ========== AFFICHAGE VALIDATION ==========
        function renderTablesCsvValidationWithSwal() {
            const validCount = tablesCsvValidatedData.filter(r => r.isValid).length;
            const invalidCount = tablesCsvValidatedData.filter(r => !r.isValid).length;

            let html = `<div style="max-height:75vh; overflow:auto;">`;

            html += `<div style="display:flex;gap:20px;margin-bottom:15px;padding:12px;background:var(--primary);border-radius:8px;color:white">`;
            html += `<div style="flex:1;text-align:center"><div style="font-size:12px;opacity:0.8"><i class="fas fa-check-circle"></i> Valides</div><div style="font-weight:600;font-size:18px">${validCount}</div></div>`;
            html += `<div style="flex:1;text-align:center"><div style="font-size:12px;opacity:0.8"><i class="fas fa-times-circle"></i> Invalides</div><div style="font-weight:600;font-size:18px">${invalidCount}</div></div>`;
            html += `<div style="flex:1;text-align:center"><div style="font-size:12px;opacity:0.8"><i class="fas fa-file-csv"></i> Total</div><div style="font-weight:600;font-size:18px">${tablesCsvValidatedData.length}</div></div>`;
            html += `</div>`;

            html += `<div class="guests-table-pro" style="margin:0;overflow:hidden">`;
            html += `<table class="data-table-pro">`;
            html += `<thead><tr style="background:var(--primary);color:white;position:sticky;top:0;z-index:10">`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:18%">Nom Table</th>`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:12%">Capacité</th>`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:15%">Catégorie</th>`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:20%">Localisation</th>`;
            html += `<th style="padding:12px;text-align:left;font-weight:600;font-size:12px;width:25%">Description</th>`;
            html += `<th style="padding:12px;text-align:center;font-weight:600;font-size:12px;width:6%">✓</th>`;
            html += `</tr></thead><tbody>`;

            tablesCsvValidatedData.forEach((row, i) => {
                const rowBg = row.isValid ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)';
                html += `<tr id="csv-val-row-tables-${i}" class="guest-row-pro" style="background:${rowBg}">`;
                
                html += `<td style="padding:10px"><input data-idx="${i}" data-field="tableName" class="csv-val-input form-control" value="${escapeHtml(row.tableName || '')}" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)" /></td>`;
                html += `<td style="padding:10px"><input type="number" data-idx="${i}" data-field="capacity" class="csv-val-input form-control" value="${row.capacity || 4}" min="1" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)" /></td>`;
                
                html += `<td style="padding:10px"><select data-idx="${i}" data-field="category" class="csv-val-input form-control" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)">`;
                const categoryOptions = ['general', 'vip', 'premium', 'standard', 'special', 'organisateur', 'conferencier'];
                categoryOptions.forEach(cat => {
                    const selected = (row.category || 'general') === cat ? 'selected' : '';
                    const label = cat.charAt(0).toUpperCase() + cat.slice(1);
                    html += `<option value="${cat}" ${selected}>${label}</option>`;
                });
                html += `</select></td>`;
                
                html += `<td style="padding:10px"><input data-idx="${i}" data-field="location" class="csv-val-input form-control" value="${escapeHtml(row.location || '')}" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)" /></td>`;
                html += `<td style="padding:10px"><input data-idx="${i}" data-field="description" class="csv-val-input form-control" value="${escapeHtml(row.description || '')}" style="width:100%;padding:6px;border:1px solid var(--border-color);border-radius:4px;font-size:11px;background:var(--input-bg);color:var(--text-color)" /></td>`;
                
                html += `<td style="padding:10px;text-align:center"><span id="csv-val-badge-tables-${i}" class="badge ${row.isValid ? 'bg-success' : 'bg-danger'}" style="font-size:10px;padding:4px 6px">${row.isValid ? '✓' : '✗'}</span></td>`;
                html += `</tr>`;
            });

            html += `</tbody></table></div></div>`;

            Swal.fire({
                title: '<i class="fas fa-check-double"></i> Validation & Édition complète',
                html,
                width: '98%',
                showCancelButton: true,
                confirmButtonText: 'Continuer vers confirmation',
                cancelButtonText: 'Annuler',
                didOpen: () => {
                    const inputs = Swal.getPopup().querySelectorAll('.csv-val-input');

                    inputs.forEach(inp => {
                        inp.addEventListener('change', () => {
                            const idx = parseInt(inp.dataset.idx);
                            const field = inp.dataset.field;

                            if (field === 'capacity') {
                                tablesCsvValidatedData[idx][field] = parseInt(inp.value) || 4;
                            } else {
                                tablesCsvValidatedData[idx][field] = inp.value;
                            }

                            const row = tablesCsvValidatedData[idx];
                            const errors = [];

                            if (!row.tableName || row.tableName.trim().length < 2) errors.push('Nom de la table requis (min 2 caractères)');
                            if (!row.capacity || parseInt(row.capacity) < 1) errors.push('Capacité invalide (min 1)');

                            row.isValid = errors.length === 0;
                            row.errors = errors;

                            const tr = document.getElementById(`csv-val-row-tables-${idx}`);
                            const badge = document.getElementById(`csv-val-badge-tables-${idx}`);

                            if (tr) {
                                tr.style.background = row.isValid ? 'rgba(16, 185, 129, 0.05)' : 'rgba(239, 68, 68, 0.05)';
                            }

                            if (badge) {
                                badge.className = `badge ${row.isValid ? 'bg-success' : 'bg-danger'}`;
                                badge.textContent = row.isValid ? '✓' : '✗';
                            }
                        });
                    });
                },
                preConfirm: () => {
                    const inputs = Swal.getPopup().querySelectorAll('.csv-val-input');
                    inputs.forEach(inp => {
                        const idx = parseInt(inp.dataset.idx);
                        const field = inp.dataset.field;
                        if (field === 'capacity') {
                            tablesCsvValidatedData[idx][field] = parseInt(inp.value) || 4;
                        } else {
                            tablesCsvValidatedData[idx][field] = inp.value;
                        }
                    });
                    return true;
                }
            }).then((res) => {
                if (res.isConfirmed) {
                    prepareTablesCsvConfirmationStep();
                } else if (res.isDismissed) {
                    // Annuler - retour à l'étape 1
                    tablesCsvCurrentStep = 1;
                    showTablesCsvStep(1);
                    tablesCsvRawData = [];
                    tablesCsvValidatedData = [];
                    
                    // Réinitialiser le fichier input
                    const csvFileInput = document.getElementById('tablesCsvFileInput');
                    if (csvFileInput) {
                        csvFileInput.value = '';
                    }
                }
            });
        }

        // ========== ÉTAPE DE CONFIRMATION ==========
        function prepareTablesCsvConfirmationStep() {
            console.log('🔄 Préparation de l\'étape 3: confirmation');

            tablesCsvCurrentStep = 3;
            showTablesCsvStep(3);

            const validRows = tablesCsvValidatedData.filter(r => r.isValid);
            const invalidRows = tablesCsvValidatedData.filter(r => !r.isValid);

            if (validRows.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Avertissement',
                    text: 'Aucune table valide à importer',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            let html = `<div style="text-align:left;max-height:70vh;overflow:auto;">`;

            html += `<div style="display:flex;gap:20px;margin-bottom:15px;padding:12px;background:var(--hover-bg);border-radius:8px;">`;
            html += `<div><div style="font-size:12px;opacity:0.7">À importer</div><div style="font-weight:600;color:var(--success);font-size:18px">${validRows.length}</div></div>`;
            if (invalidRows.length > 0) {
                html += `<div><div style="font-size:12px;opacity:0.7">Invalides</div><div style="font-weight:600;color:var(--danger);font-size:18px">${invalidRows.length}</div></div>`;
            }
            html += `<div><div style="font-size:12px;opacity:0.7">Événement</div><div style="font-weight:600;font-size:14px">${escapeHtml(tablesCsvEventSelected.name)}</div></div>`;
            html += `</div>`;

            html += `<div style="border:1px solid var(--border-color);border-radius:8px;overflow:hidden;">`;
            html += `<table style="width:100%;border-collapse:collapse">`;
            html += `<thead><tr style="background:var(--hover-bg);position:sticky;top:0;">`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px;width:18%">Nom Table</th>`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px;width:12%">Capacité</th>`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px;width:15%">Catégorie</th>`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px;width:25%">Localisation</th>`;
            html += `<th style="padding:10px;text-align:left;border-bottom:2px solid var(--border-color);font-weight:600;font-size:13px">Description</th>`;
            html += `</tr></thead><tbody>`;

            validRows.forEach(row => {
                html += `<tr style="border-bottom:1px solid var(--border-color)">`;
                html += `<td style="padding:10px"><strong>${escapeHtml(row.tableName)}</strong></td>`;
                html += `<td style="padding:10px">${row.capacity}</td>`;
                html += `<td style="padding:10px"><span style="text-transform:uppercase;font-weight:600;color:var(--primary);font-size:12px">${escapeHtml(row.category || 'general')}</span></td>`;
                html += `<td style="padding:10px">${escapeHtml(row.location || '—')}</td>`;
                html += `<td style="padding:10px;font-size:12px;opacity:0.8">${escapeHtml(row.description || '—')}</td>`;
                html += `</tr>`;
            });

            html += `</tbody></table></div>`;

            if (invalidRows.length > 0) {
                html += `<div style="margin-top:12px;padding:10px;background:#fef08a;border:1px solid #fcd34d;border-radius:6px;font-size:12px">`;
                html += `<strong>⚠️ ${invalidRows.length} table(s) invalide(s)</strong> ne seront pas importées.`;
                html += `</div>`;
            }

            html += `</div>`;

            Swal.fire({
                title: 'Confirmation de l\'import',
                html,
                width: '90%',
                showCancelButton: true,
                confirmButtonText: 'Confirmer & Importer',
                cancelButtonText: 'Retour à l\'édition',
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280'
            }).then((res) => {
                if (res.isConfirmed) {
                    performTablesCsvImport();
                } else if (res.isDismissed) {
                    // Retour à l'édition - étape 2
                    renderTablesCsvValidationWithSwal();
                }
            });
        }

        // ========== IMPORT FINAL ==========
        async function performTablesCsvImport() {
            console.log('📥 Exécution de l\'import final');

            tablesCsvCurrentStep = 4;
            showTablesCsvStep(3);

            const validRows = tablesCsvValidatedData.filter(r => r.isValid);

            if (validRows.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Aucune table valide à importer',
                    confirmButtonColor: '#D97706'
                });
                return;
            }

            const progressSwal = Swal.fire({
                title: 'Importation en cours...',
                html: `
                    <div style="text-align: center;">
                        <div class="progress" style="height: 30px; border-radius: 8px; overflow: hidden; margin-bottom: 15px; background: var(--hover-bg);">
                            <div id="tablesCsvImportProgressBar" class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, #10b981, #059669); transition: width 0.3s ease;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <span style="color:white;font-weight:600;font-size:14px">0%</span>
                            </div>
                        </div>
                        <div id="tablesCsvImportStatus" style="font-size:14px;margin-bottom:10px;">Préparation...</div>
                        <div id="tablesCsvImportCount" style="font-size:12px;color:#6b7280">0/<strong>${validRows.length}</strong></div>
                    </div>
                `,
                icon: 'info',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: async () => {
                    await performTablesActualImport(validRows);
                }
            });
        }

        async function performTablesActualImport(validRows) {
            let importedCount = 0;
            let failedCount = 0;

            try {
                for (let i = 0; i < validRows.length; i++) {
                    const row = validRows[i];
                    const progress = Math.round(((i + 1) / validRows.length) * 100);

                    const progressBar = document.getElementById('tablesCsvImportProgressBar');
                    if (progressBar) {
                        progressBar.style.width = progress + '%';
                        progressBar.innerHTML = `<span style="color:white;font-weight:600;font-size:14px">${progress}%</span>`;
                    }

                    const statusEl = document.getElementById('tablesCsvImportStatus');
                    if (statusEl) {
                        statusEl.textContent = `Table "${row.tableName}"...`;
                    }

                    const countEl = document.getElementById('tablesCsvImportCount');
                    if (countEl) {
                        countEl.innerHTML = `${i + 1}/<strong>${validRows.length}</strong>`;
                    }

                    try {
                        const tableData = {
                            eventId: tablesCsvEventSelected.id,
                            tableName: row.tableName || `Table ${i + 1}`,
                            capacity: Math.max(1, row.capacity || 4),
                            category: row.category || 'general',
                            location: row.location || '',
                            description: row.description || '',
                            createdAt: new Date().toISOString()
                        };

                        const table = await storage.createTable(tablesCsvEventSelected.id,tableData);
                        if (table) {
                            importedCount++;
                        }
                    } catch (err) {
                        console.error(`❌ Erreur création table ligne ${i}:`, err);
                        failedCount++;
                    }

                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                await Swal.close();

                await Swal.fire({
                    icon: importedCount > 0 ? 'success' : 'error',
                    title: importedCount > 0 ? 'Import terminé !' : 'Erreur lors de l\'import',
                    html: `
                        <div style="text-align:center;padding:20px">
                            <div style="font-size:48px;margin-bottom:15px">
                                ${importedCount > 0 ? '✅' : '❌'}
                            </div>
                            <h3 style="margin-bottom:5px;color:var(--text-color)">Résumé de l'import</h3>
                            <div style="margin:15px 0;font-size:14px">
                                <div style="padding:8px;border-radius:6px;margin-bottom:8px">
                                    <strong style="color:var(--success);font-size:16px">${importedCount}</strong> table(s) importée(s) avec succès
                                </div>
                                ${failedCount > 0 ? `
                                <div style="padding:8px;border-radius:6px">
                                    <strong style="color:#b45309;font-size:16px">${failedCount}</strong> table(s) en erreur
                                </div>
                                ` : ''}
                            </div>
                            <div style="margin-top:15px;font-size:12px;color:#6b7280">
                                <i class="fas fa-info-circle"></i> Les tables ont été ajoutées à l'événement <strong>${escapeHtml(tablesCsvEventSelected.name)}</strong>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Fermer',
                    confirmButtonColor: '#D97706'
                });

                if (importedCount > 0) {
                    await loadTables();
                }

                closeTablesCsvImportModal();

            } catch (error) {
                console.error('❌ Erreur globale import:', error);
                await Swal.close();
                await Swal.fire({
                    icon: 'error',
                    title: 'Erreur fatale',
                    text: 'L\'import a été interrompu. Veuillez réessayer.',
                    confirmButtonColor: '#D97706'
                });
            }
        }

        // ========== TÉLÉCHARGEMENT TEMPLATE CSV ==========
       // ========== TÉLÉCHARGEMENT TEMPLATE CSV AMÉLIORÉ ==========
function downloadTablesCsvTemplate() {
    console.log('📥 Téléchargement du template CSV pour tables');
    
    const csvContent = `tableName,capacity,location,category,description
Table A,4,Salle Principale,general,Table standard pour 4 personnes
Table VIP,6,Étage 1 - Côté fenêtres,vip,Table VIP avec vue directe sur la scène
Table Premium,8,Étage 1 - Centre,premium,Table premium centrale
Table Standard,4,Salle Principale,standard,Table standard supplémentaire
Table Cocktail,2,Bar,special,Table haute pour cocktails`;

    // Créer avec BOM UTF-8 pour Excel
    const bom = '\uFEFF';
    const blob = new Blob([bom + csvContent], { 
        type: 'text/csv;charset=utf-8;' 
    });
    
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'modele-tables-utf8.csv';
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);

    Swal.fire({
        icon: 'success',
        title: 'Modèle téléchargé',
        html: `Le fichier modèle a été téléchargé avec succès.<br><small>Format UTF-8 compatible avec Excel</small>`,
        timer: 2000,
        showConfirmButton: false
    });
}

        // ========== AFFICHAGE ÉTAPE CSV ==========
        function showTablesCsvStep(step) {
            console.log(`📊 Affichage étape CSV tables: ${step}`);

            tablesCsvCurrentStep = step;

            const modal = document.getElementById('tablesCsvImportModal');
            if (modal) {
                modal.querySelectorAll('.creation-step-content').forEach((el, idx) => {
                    el.classList.remove('active');
                });

                const stepContent = document.getElementById(`tablesCsvStep${step}Content`);
                if (stepContent) {
                    stepContent.classList.add('active');
                }

                // Mise à jour indicateurs de progression
                modal.querySelectorAll('.vertical-step').forEach((el, idx) => {
                    el.classList.remove('active', 'completed');
                    if (idx + 1 < step) el.classList.add('completed');
                    if (idx + 1 === step) el.classList.add('active');
                });

                // Mise à jour barre de progression
                const progress = (step / 3) * 100;
                const progressBar = document.getElementById('tablesCsvProgressBar');
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }

                const progressText = document.getElementById('tablesCsvProgressText');
                if (progressText) {
                    progressText.textContent = `Étape ${step}/3`;
                }
            }
        }

        // ========== FONCTION UTILITAIRE ==========
                function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            
            let str = String(text);
            
            str = str.replace(/[&<>"']/g, m => map[m]);
            
            str = str
                .replace(/Ã©/g, 'é')
                .replace(/Ãª/g, 'ê')
                .replace(/Ã¨/g, 'è')
                .replace(/Ã§/g, 'ç')
                .replace(/Ã´/g, 'ô')
                .replace(/Ã¹/g, 'ù')
                .replace(/Ã®/g, 'î')
                .replace(/Ã¢/g, 'â')
                .replace(/Ã¨/g, 'è')
                .replace(/Ã/g, 'é');
            
            return str;
        }
        // ========== INITIALISATION ==========
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTablesCsvImport);
        } else {
            initializeTablesCsvImport();
        }

    </script>

</body>
</html>