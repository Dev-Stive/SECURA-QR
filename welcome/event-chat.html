<!DOCTYPE html>
<html lang="fr" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Chat Événement - SECURA">
    <title>Chat Événement - SECURA</title>
    
    <link rel="icon" href="../assets/images/icon.png" type="image/x-icon">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" as="style">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

     <!-- Styles et Polices -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Emoji Picker -->
    
    <!-- Styles locaux -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/loading.css">
    <link rel="stylesheet" href="../css/dash.css">
    <link rel="stylesheet" href="../css/toastify.css">
    <link rel="stylesheet" href="../css/gallerie.css">
    
    <style>
        /* ==========================================
           VARIABLES GLOBALES POUR LES THÈMES
           ========================================== */
        :root {
            /* Thème clair (par défaut) */
            --primary: #D97706;
            --primary-dark: #B45309;
            --primary-light: #F59E0B;
            --dark: #0A0A0A;
            --dark-card: #121212;
            --dark-elevated: #1A1A1A;
            --gradient: linear-gradient(135deg, #B45309 0%, #D97706 50%, #F59E0B 100%);
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --border-radius: 0.5rem;
            --border-radius-sm: 0.375rem;
            --card-shadow: 0 12px 40px rgba(0,0,0,0.4);
            
            /* Variables pour thème clair */
            --body-bg: #ffffff;
            --text-color: #333333;
            --card-bg: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #e0e0e0;
            --input-text: #333333;
            --placeholder-color: #666666;
            --border-color: rgba(0, 0, 0, 0.1);
            --hover-bg: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --progress-bg: rgba(0, 0, 0, 0.05);
            
            /* Variables spécifiques chat */
            --chat-bg: #f0f2f5;
            --message-bg-outgoing: #DCF8C6;
            --message-bg-incoming: #ffffff;
            --message-text-outgoing: #111b21;
            --message-text-incoming: #111b21;
            --message-time-color: #667781;
            --chat-header-bg: #f0f2f5;
            --chat-footer-bg: #f0f2f5;
        }

        /* Variables pour thème sombre */
        .dark-theme {
            --body-bg: #0A0A0A;
            --text-color: #ffffff;
            --card-bg: #121212;
            --input-bg: rgba(255, 255, 255, 0.04);
            --input-border: rgba(255, 255, 255, 0.12);
            --input-text: #ffffff;
            --placeholder-color: rgba(255, 255, 255, 0.4);
            --border-color: rgba(255, 255, 255, 0.1);
            --hover-bg: rgba(255, 255, 255, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --progress-bg: rgba(0, 0, 0, 0.2);
            
            /* Variables spécifiques chat (mode sombre WhatsApp) */
            --chat-bg: #0a1014;
            --message-bg-outgoing: #005c4b;
            --message-bg-incoming: #202c33;
            --message-text-outgoing: #e9edef;
            --message-text-incoming: #e9edef;
            --message-time-color: #a3b3bc;
            --chat-header-bg: #202c33;
            --chat-footer-bg: #202c33;
        }

        /* ==========================================
           STYLES DE BASE
           ========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            overflow: hidden;
        }

        /* ==========================================
           LAYOUT PRINCIPAL DU CHAT
           ========================================== */
        .chat-container {
            display: flex;
            height: 100vh;
            margin: 0;
            position: relative;
            flex-direction: row;
        }

        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: 100vh;
                overflow: hidden;
            }
        }

        /* ==========================================
           PANEL LATÉRAL DES CONVERSATIONS
           ========================================== */
        .conversations-panel {
            width: 380px;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 100;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        /* Sur grand écran (>768px): toujours visible */
        @media (min-width: 769px) {
            .conversations-panel {
                display: flex;
                width: 380px;
                position: relative;
                transform: none;
                opacity: 1;
            }
        }

        /* Sur petit écran (<= 768px): comportement mobile */
        @media (max-width: 768px) {
            .conversations-panel {
                width: 100%;
                height: 100vh;
                min-height: 100vh;
                border-right: none;
                border-bottom: none;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 99;
                transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease;
                will-change: transform, opacity;
                /* État par défaut: visible (en accord avec la classe 'visible' du HTML) */
                transform: translateX(0);
                opacity: 1;
                pointer-events: auto;
            }
            
            /* Panel visible quand aucune conversation sélectionnée (état par défaut) */
            .conversations-panel.visible {
                transform: translateX(0);
                opacity: 1;
                pointer-events: auto;
            }
            
            /* Panel caché quand conversation sélectionnée */
            .conversations-panel.hidden {
                transform: translateX(-100%);
                opacity: 0;
                pointer-events: none;
            }
        }

       

        .conversations-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 480px) {
            .conversations-header-left {
                gap: 10px;
            }
        }

        .back-to-events {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .back-to-events:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .conversations-header h2 {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        @media (max-width: 480px) {
            .conversations-header h2 {
                font-size: 1rem;
                gap: 6px;
            }

            .conversations-header h2 span {
                display: none;
            }
        }

        .conversations-header-right {
            display: flex;
            gap: 10px;
            align-items: center;
            position: relative;
        }

        .header-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .header-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        /* Menu d'actions du chat */
        .chat-actions-menu {
            position: relative;
            display: flex;
            align-items: center;
        }

        .chat-actions-menu .menu-toggle {
            margin-left: 5px;
        }

        .actions-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            margin-top: 5px;
            overflow: hidden;
            display: none;
        }

        .actions-dropdown.active {
            display: block;
        }

        .action-menu-item {
            width: 100%;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            text-align: left;
        }

        .action-menu-item:hover {
            background: var(--hover-bg);
            padding-left: 20px;
        }

        .action-menu-item i {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .action-menu-item.danger {
            color: #e74c3c;
        }

        .action-menu-item.danger:hover {
            background: rgba(231, 76, 60, 0.1);
        }

        /* États d'appel */
        .call-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            background: var(--card-bg);
        }

        .call-state-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            max-width: 500px;
        }

        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .call-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .call-status {
            font-size: 0.95rem;
            color: var(--placeholder-color);
            text-align: center;
        }

        .status-text {
            display: inline-block;
            padding: 4px 12px;
            background: var(--hover-bg);
            border-radius: 20px;
        }

        .call-timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
            font-family: 'Courier New', monospace;
        }

        .call-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .call-action-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: none;
            background: var(--hover-bg);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
        }

        .call-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .call-action-btn.active {
            background: #e74c3c;
            color: white;
        }

        .call-action-btn.active:hover {
            background: #c0392b;
        }

        .end-call-btn {
            background: #e74c3c;
            color: white;
        }

        .end-call-btn:hover {
            background: #c0392b;
        }

        /* Bouton de retour pour les vues d'appel */
        .back-to-chat-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: var(--hover-bg);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            z-index: 10;
        }

        .back-to-chat-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .back-to-chat-btn:active {
            transform: scale(0.95);
        }

        

       

        

        .remote-video-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-fallback {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .local-video-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 120px;
            height: 120px;
            border-radius: 10px;
            background: #333;
            border: 2px solid white;
            overflow: hidden;
            z-index: 10;
        }

        #localVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        .local-video-label {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            z-index: 11;
        }

        #videoCallStatus {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }

        #videoCallTimer {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }

        .video-call .call-actions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
        }

        @media (max-width: 480px) {
            .header-action-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }

            .conversations-header {
                padding: 12px 16px;
            }
        }

        /* Menu d'options mobile */
        .mobile-menu-btn {
            display: none;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: var(--hover-bg);
                border: 1px solid var(--border-color);
                color: var(--text-color);
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .mobile-menu-btn:hover {
                background: var(--primary);
                color: white;
            }
        }

        .mobile-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 0,5rem;
            min-width: 280px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            margin-top: 5px;
            overflow: hidden;
            max-height: 400px;
            overflow-y: auto;
        }

        .mobile-menu.active {
            display: block;
        }

        /* Mobile Menu Profile Section */
        .mobile-menu-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.05) 0%, rgba(239, 68, 68, 0.05) 100%);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mobile-menu-profile:hover {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
        }

        .mobile-menu-profile-header {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
        }

        .mobile-menu-profile-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            color: white;
            border: 3px solid rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
            overflow: hidden;
        }

        .mobile-menu-profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .mobile-menu-profile-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .mobile-menu-profile-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-menu-profile-status {
            font-size: 12px;
            color: var(--text-muted, #999);
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            gap: 6px;
        }

        .mobile-menu-item {
            padding: 12px 16px;
            color: var(--text-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
        }

        .mobile-menu-item:hover {
            background: var(--hover-bg);
        }

        .mobile-menu-item i {
            width: 18px;
            text-align: center;
        }

        /* Recherche conversations */
        .conversations-search {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px 12px 45px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--input-text);
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.2);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--placeholder-color);
        }

        /* ==========================================
           BARRE DE FILTRES RAPIDES
           ========================================== */
        .conversations-filters {
            display: flex;
            gap: 6px;
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            overflow-y: hidden;
            background: var(--card-bg);
        }

        .conversations-filters::-webkit-scrollbar {
            height: 0px;
        }

        .conversations-filters::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversations-filters::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .filter-btn {
            padding: 8px 14px;
            background: var(--hover-bg);
            border: 1px solid transparent;
            border-radius: 0.2rem;
            color: var(--text-color);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary-dark);
        }

        .filter-btn i {
            font-size: 0.9rem;
        }

        @media (max-width: 480px) {
            .conversations-filters {
                padding: 10px 12px;
                gap: 5px;
            }

            .filter-btn {
                padding: 7px 12px;
                font-size: 0.8rem;
            }
        }

        /* Liste des conversations */
        .conversations-list {
            flex: 1;
            overflow-y: auto;
            padding: 5px 0;
        }

        .conversations-list::-webkit-scrollbar {
            width: 6px;
        }

        .conversations-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversations-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        /* Barre d'options en bas du panel conversations */
        .conversations-footer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .conversations-footer {
                display: none;
            }
        }

     

        .conversation-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .conversation-item:hover {
            background: var(--hover-bg);
        }

        .conversation-item.active {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .conversation-item.active .conversation-name,
        .conversation-item.active .conversation-preview,
        .conversation-item.active .conversation-time,
        .conversation-item.active .unread-count {
            color: inherit !important;
        }

        .conversation-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            flex-shrink: 0;
            overflow: hidden;
            position: relative;
        }

        .conversation-avatar img,
        .conversation-avatar-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .conversation-avatar-text {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .conversation-status {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background: var(--success);
            border: 2px solid var(--card-bg);
            border-radius: 50%;
            display: none;
        }

        .conversation-status.online {
            display: block;
            animation: pulse-online 2s infinite;
        }

        @keyframes pulse-online {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .conversation-status-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 4px;
        }

        .online-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
        }

        .online-indicator.offline {
            color: var(--text-muted);
        }

        .conversation-details {
            flex: 1;
            min-width: 0;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .conversation-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-time {
            font-size: 0.75rem;
            color: var(--placeholder-color);
            white-space: nowrap;
        }

        .conversation-time-status {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: flex-end;
        }

        .conversation-preview {
            font-size: 0.85rem;
            color: var(--placeholder-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .conversation-meta {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 3px;
        }

        .unread-count {
            background: var(--primary);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .message-status {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
        }

        .message-status.read {
            color: var(--info);
        }

        .message-status.delivered {
            color: #95a5a6;
        }

        .message-status.sent {
            color: var(--message-time-color);
            opacity: 0.7;
        }

        /* État vide */
        .empty-conversations {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-color);
            opacity: 0.5;
        }

        .empty-conversations i.big {
            font-size: 3rem;
            margin-bottom: 20px;
            display: block;
        }

        .empty-conversations p {
            margin-bottom: 20px;
        }

        /* Bouton créer première conversation */
        .create-first-conversation-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 15px rgba(217, 119, 6, 0.3);
            position: relative;
            overflow: hidden;
        }

        .create-first-conversation-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .create-first-conversation-btn:hover::before {
            left: 100%;
        }

        .create-first-conversation-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(217, 119, 6, 0.4);
        }

        .create-first-conversation-btn:active {
            transform: translateY(0px);
            box-shadow: 0 2px 10px rgba(217, 119, 6, 0.3);
        }

        .create-first-conversation-btn i {
            font-size: 18px;
            animation: chatIconBounce 2s ease-in-out infinite;
        }

        @keyframes chatIconBounce {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-4px);
            }
        }

        .create-first-conversation-btn .btn-text {
            font-size: 15px;
            letter-spacing: 0.5px;
        }

        /* ==========================================
           ZONE DE CHAT PRINCIPALE
           ========================================== */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--chat-bg);
            position: relative;
        }

        @media (max-width: 768px) {
            .chat-main {
                width: 100%;
                height: 100vh;
                min-height: 100vh;
                display: none;
                flex-direction: column;
                position: fixed;
                top: 0;
                left: 0;
                z-index: 98;
                background: var(--chat-bg);
                transform: translateX(100%);
                opacity: 0;
                pointer-events: none;
                transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease;
            }

            .chat-main.active {
                display: flex;
                transform: translateX(0);
                opacity: 1;
                pointer-events: auto;
            }

            .chat-main.hidden {
                transform: translateX(100%);
                opacity: 0;
                pointer-events: none;
            }
        }

        /* En-tête de chat */
        .chat-header , .conversations-header{
            padding: 12px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

           
        
        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .toggle-conversations-btn {
            display: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Visible uniquement sur petit écran */
        @media (max-width: 768px) {
            .toggle-conversations-btn {
                display: flex;
            }
        }

        /* Caché sur grand écran */
        @media (min-width: 769px) {
            .toggle-conversations-btn {
                display: none !important;
            }
        }

        .toggle-conversations-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .toggle-conversations-btn:active {
            transform: scale(0.95);
        }

        .chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
            overflow: hidden;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-title {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-color);
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-status {
            font-size: 0.8rem;
            color: var(--placeholder-color);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-dot.online {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--placeholder-color);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes pulse-badge {
            0%, 100% { 
                transform: scale(1);
                opacity: 1;
            }
            50% { 
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .pulse-badge {
            animation: pulse-badge 0.6s ease-in-out 2 !important;
        }

        .chat-header-right {
            display: flex;
            gap: 10px;
        }

        /* Zone des messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            background: linear-gradient(135deg , var(--dark-card) , var(--dark));
            display: flex;
            flex-direction: column;
            order: 1;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        /* Conteneur des messages (qui remplace le ancien innerHTML) */
        #messagesWrapper {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        #messagesWrapper::-webkit-scrollbar {
            width: 2px;
        }

        #messagesWrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        #messagesWrapper::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        /* Groupes de messages par date */
        .message-date-group {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-separator {
            display: inline-block;
            padding: 6px 15px;
            background: var(--hover-bg);
            border-radius: 20px;
            font-size: 0.75rem;
            color: var(--placeholder-color);
            font-weight: 500;
        }

        /* Indicateur de chargement des anciens messages */
        .messages-loading {
            text-align: center;
            padding: 20px;
            color: var(--placeholder-color);
            font-size: 0.9rem;
        }

        .load-more-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .load-more-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Messages */
        .message-wrapper {
            display: flex;
            margin-bottom: 15px;
            position: relative;
            z-index: auto;
        }

        .message-wrapper.incoming {
            justify-content: flex-start;
        }

        .message-wrapper.outgoing {
            justify-content: flex-end;
        }

        .message-wrapper.outgoing .message-content {
            background: var(--message-bg-outgoing);
            color: var(--message-text-outgoing);
            border-radius: 18px 4px 18px 18px;
        }

        .message-wrapper.incoming .message-content {
            background: var(--message-bg-incoming);
            color: var(--message-text-incoming);
            border-radius: 4px 18px 18px 18px;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gradient);
            margin-right: 10px;
            flex-shrink: 0;
            overflow: hidden;
            align-self: flex-end;
        }

        .message-wrapper.outgoing .message-avatar {
            margin-right: 0;
            margin-left: 10px;
            order: 2;
        }

        .message-content {
            max-width: 65%;
            padding: 10px 15px;
            position: relative;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            word-wrap: break-word;
            overflow: visible;
        }

        /* Message avec réponse */
        .message-replied {
            background: rgba(0,0,0,0.05);
            border-left: 3px solid var(--primary);
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            
        }

        .replied-sender {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--primary);
            margin-bottom: 2px;
        }

        .replied-content {
            font-size: 0.85rem;
            opacity: 0.9;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Contenu du message */
        .message-text {
            font-size: 0.95rem;
            margin-right: 5px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Images dans les messages */
        .message-image {
            max-width: 300px;
            max-height: 300px;
            border-radius: 12px;
            overflow: hidden;
            margin: 8px 0;
            cursor: pointer;
        }

        .message-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .message-image img:hover {
            transform: scale(1.05);
        }

        /* Fichiers dans les messages */
        .message-file {
            background: rgba(0,0,0,0.05);
            border-radius: 10px;
            padding: 12px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .message-file:hover {
            background: rgba(0,0,0,0.08);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
        }

        .file-info {
            flex: 1;
            min-width: 0;
        }

        .file-name {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-size {
            font-size: 0.75rem;
            color: var(--placeholder-color);
        }

        .download-btn {
            padding: 6px 12px;
            background: var(--primary);
            color: white;
            border-radius: 6px;
            font-size: 0.8rem;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Pied du message */
        .message-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--message-time-color);
            white-space: nowrap;
        }

        .message-status-icons {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .status-icon {
            font-size: 0.7rem;
        }

        .status-icon.sent { color: var(--message-time-color); }
        .status-icon.delivered { color: #95a5a6; }
        .status-icon.read { color: var(--info); }

        .message-reactions {
            position: absolute;
            bottom: -14px;
            left: 45px;
            background: var(--hover-bg);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 0.5rem;
            padding: 1px;
            display: flex;
            gap: 0;
            align-items: center;
            box-shadow: none;
            z-index: 1;
        }

        .reaction-item {
            display: flex;
            align-items: center;
            gap: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: transparent;
            border: none;
            padding: 2px 4px;
            border-radius: 6px;
            font-size: 0;
        }

        .reaction-item:hover {
            background: rgba(0,0,0,0.05);
            transform: scale(1.15);
        }

        .reaction-emoji {
            font-size: 0.9rem;
        }

        .reaction-count {
            font-size: 0.75rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .add-reaction-btn {
            background: transparent;
            border: none;
            border-radius: 50%;
            border: 1px solid var(--border-color);
            padding: 6px;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            animation: rotateIn 0.3s ease;
        }

        .message-content:hover .add-reaction-btn {
            display: flex;
        }

        .add-reaction-btn:hover {
            background: rgba(0,0,0,0.1);
            color: var(--primary);
            transform: scale(1.1) rotate(360deg);
        }

        @keyframes rotateIn {
            from {
                transform: rotate(-90deg) scale(0);
                opacity: 0;
            }
            to {
                transform: rotate(0) scale(1);
                opacity: 1;
            }
        }

        /* ========================================== */
        /* ACTIONS DES MESSAGES - DROPDOWN WHATSAPP  */
        /* ========================================== */
        
        .message-actions-dropdown {
            position: relative;
        }

        .btn-message-actions {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 4px 8px;
            opacity: 0.5;
            transition: opacity 0.2s ease, color 0.2s ease, transform 0.3s ease;
        }

        .message-content:hover .btn-message-actions {
            opacity: 1;
        }

        .btn-message-actions:hover {
            opacity: 1 !important;
        }

        .btn-message-actions.open {
            transform: rotate(180deg);
            color: var(--primary);
        }

        .message-actions-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--card-bg);
            border-radius: 0.5rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            z-index: 99999;
            min-width: 160px;
            overflow: visible;
            animation: fadeInUp 0.25s ease;
            border: none;
            margin-top: 4px;
            display: none;
            flex-direction: column;
        }

       

        .message-actions-menu.show {
            display: flex;
        }

        .message-actions-menu button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            color: var(--text-color);
            text-align: left;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;

             
    gap: 12px;
    background: none;
    width: 100%;
    text-align: left;
    font-size: 14px;
        }

        .message-actions-menu button:hover {
            background: var(--hover-bg);
            padding-left: 18px;
            color: var(--primary);
        }

        .message-actions-menu button.danger {
            border-top: 1px solid var(--border-color);
            margin-top: 4px;
            padding-top: 12px;
            color: #e74c3c;
        }

        .mobile-menu-item.danger {
            border-top: 1px solid var(--border-color);
            margin-top: 4px;
            padding-top: 12px;
            color: #e74c3c;
        }

        .mobile-menu-item.danger:hover {
            background: rgba(231, 76, 60, 0.1);
            color: #c0392b;
        }

        .message-actions-menu button.danger:hover {
            background: rgba(231, 76, 60, 0.1);
            color: #c0392b;
        }

        /* ========================================== */
        /* EMOJI REACTIONS - STYLE WHATSAPP          */
        /* ========================================== */

        .emoji-reactions-picker {
            position: absolute;
            bottom: auto;
            top: -60px;
            right: 0;
            background: var(--card-bg);
            border-radius: 50px;
            padding: 8px 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            display: none;
            gap: 8px;
            align-items: center;
            z-index: 10001;
            animation: popUp 0.3s ease;
        }

        .emoji-reactions-picker.show {
            display: flex;
            z-index: 99999;
        }

        @keyframes popUp {
            from {
                transform: scale(0.3);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .emoji-reaction-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-reaction-btn:hover {
            background: var(--hover-bg);
            transform: scale(1.2);
        }

        /* Réactions affichées sous le message - voir première définition à ligne 1241 */

        .reaction-count {
            font-size: 0.7rem;
            color: var(--placeholder-color);
        }

        .reaction-item:hover .reaction-count {
            color: white;
        }

        .message-wrapper:hover .btn-message-actions {
            opacity: 1;
        }

        .btn-message-actions:hover {
            color: var(--primary);
            transform: scale(1.1);
        }

        /* message-actions-menu removed - see primary definition at line 1303 */
        /* .action-btn removed - buttons now defined in .message-actions-menu button */

        /* CONVERSATION META (métadonnées des messages) */
        .conversation-meta {
            font-size: 0.75rem;
            color: var(--placeholder-color);
            display: inline-block;
        }

        .conversation-meta.sender-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
            font-size: 0.85rem;
        }

        .conversation-meta.message-time {
            white-space: nowrap;
        }

        /* BADGES ET INDICATEURS */
        .editing-badge {
            background: var(--warning);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
            white-space: nowrap;
        }

        .message-being-replied {
            border-left: 3px solid var(--warning);
            opacity: 0.7;
        }


        .reply-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .reply-sender {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--primary);
        }

        .btn-cancel-reply {
            background: transparent;
            border: none;
            color: var(--placeholder-color);
            cursor: pointer;
            font-size: 0.9rem;
            transition: color 0.2s ease;
            padding: 4px 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-cancel-reply:hover {
            color: var(--danger);
        }

        .reply-text {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.8;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Menu contextuel des messages */
        .message-context-menu {
            position: fixed;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            min-width: 180px;
            overflow: hidden;
            animation: fadeInUp 0.2s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .context-menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            text-decoration: none;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: var(--hover-bg);
            padding-left: 25px;
        }

        .context-menu-item.danger {
            color: var(--danger);
        }

        .context-menu-item.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Zone de saisie */
        .chat-input-area {
            padding: 15px 20px;
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: flex-end;
            gap: 15px;
            position: sticky;
            bottom: 0;
            z-index: 10;
            order: 3;
        }

        .input-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .input-action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .input-action-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.05);
        }

        .message-input-container {
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 10px 20px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            min-height: 44px;
            max-height: 200px;
            overflow: hidden;
            flex-wrap: wrap;
            align-content: flex-start;
        }

        /* Reply preview inline dans message-input-container */
        .reply-preview-inline {
            width: 100%;
            background: transparent !important;
            border: none !important;
            padding: 0 !important;
            margin: 8px 0 0 0 !important;
            display: none;
            flex-direction: column;
            gap: 4px;
            border-top: 1px solid var(--border-color);
            padding-top: 8px !important;
        }

        .reply-preview-inline .reply-preview-content {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .reply-preview-inline .reply-info {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .reply-preview-inline .reply-sender {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--primary);
            opacity: 0.8;
        }

        .reply-preview-inline .reply-text {
            font-size: 0.8rem;
            color: var(--input-text);
            opacity: 0.7;
            line-height: 1.2;
            word-break: break-word;
            max-width: 100%;
        }

        #messageInput {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--input-text);
            font-size: 0.95rem;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            outline: none;
            padding: 0;
            min-width: 100px;
        }

        #messageInput:empty::before {
            content: attr(placeholder);
            color: var(--placeholder-color);
            pointer-events: none;
        }

        #messageInput:focus{
            border: none !important;
            border-color: transparent !important;
             outline: none !important;
        }

        #messageInput::placeholder {
            color: var(--placeholder-color);
        }

        /* Scrollbar juste pour le textarea */
        #messageInput::-webkit-scrollbar {
            width: 4px;
        }

        #messageInput::-webkit-scrollbar-track {
            background: transparent;
        }

        #messageInput::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }

        .emoji-btn {
            color: var(--primary);
            cursor: pointer;
            font-size: 1.2rem;
            transition: transform 0.2s ease;
        }

        .emoji-btn:hover {
            transform: scale(1.1);
        }

        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 0.5rem;
            background: var(--hover-bg);
            border: 1px solid var(--border-color) !important;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Picker emoji */
        .emoji-picker-container {
            position: absolute;
            bottom: 80px;
            right: 20px;
            z-index: 1000;
            display: none;
        }

        .emoji-picker-container.show {
            display: block;
            animation: fadeInUp 0.3s ease;
        }

        emoji-picker {
            --emoji-size: 1.5rem;
            --num-columns: 8;
            --category-emoji-size: 1.2rem;
            width: 350px;
            max-width: 90vw;
            height: 400px;
        }

        @media (max-width: 480px) {
            emoji-picker {
                width: 100vw;
                height: 50vh;
            }
        }

        /* Indicateur d'écriture */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            font-size: 0.85rem;
            color: var(--placeholder-color);
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
            border-radius: 0;
            box-shadow: none;
            animation: fadeIn 0.3s ease;
            order: 2;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--primary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-5px);
            }
        }

        /* ==========================================
           MODAL D'INFORMATIONS DE CONVERSATION
           ========================================== */
        .chat-info-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .chat-info-modal.active {
            display: flex;
        }

        .chat-info-content {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(60px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-info-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-info-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
        }

        .close-info-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: none;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-info-btn:hover {
            background: var(--danger);
            color: white;
        }

        .chat-info-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .participants-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-color);
            padding: 5px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 15px;
            font-weight: 600;
        }

        .participants-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .participant-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--hover-bg);
            border-radius: var(--border-radius-sm);
            transition: all 0.3s ease;
        }

        .participant-item:hover {
            background: var(--border-color);
            transform: translateX(5px);
        }

        .participant-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            flex-shrink: 0;
            overflow: hidden;
        }

        .participant-details {
            flex: 1;
            min-width: 0;
        }

        .participant-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
            margin-bottom: 3px;
        }

        .participant-role {
            font-size: 0.8rem;
            color: var(--placeholder-color);
        }

        /* ==========================================
           MODAL D'ENVOI DE FICHIER
           ========================================== */
                .file-upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .file-upload-modal.active {
            display: flex;
        }

        .file-upload-content {
            width: 100%;
            max-width: 500px;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            overflow: hidden;
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .file-upload-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-upload-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
        }

        .close-upload-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--hover-bg);
            border: none;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close-upload-btn:hover {
            background: var(--danger);
            color: white;
        }

        .file-upload-body {
            padding: 20px;
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-zone:hover {
            border-color: var(--primary);
            background: rgba(217, 119, 6, 0.05);
        }

        .upload-zone.drag-over {
            border-color: var(--primary);
            background: rgba(217, 119, 6, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1rem;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: var(--placeholder-color);
        }

        #fileInput {
            display: none;
        }

        .upload-btn {
            display: inline-block;
            padding: 12px 30px;
            background: var(--primary);
            color: white;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .file-preview {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: var(--hover-bg);
            border-radius: var(--border-radius-sm);
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .preview-header h4 {
            font-size: 1rem;
            color: var(--text-color);
            margin: 0;
        }

        .remove-preview {
            background: none;
            border: none;
            color: var(--danger);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .preview-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .preview-icon {
            width: 50px;
            height: 50px;
            background: var(--gradient);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .preview-info {
            flex: 1;
            min-width: 0;
        }

        .preview-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }

        .preview-size {
            font-size: 0.85rem;
            color: var(--placeholder-color);
        }

        .upload-progress {
            margin-top: 15px;
            display: none;
        }

        .progress-bar {
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            font-size: 0.85rem;
            color: var(--placeholder-color);
        }

        .upload-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .cancel-upload-btn {
            flex: 1;
            padding: 12px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cancel-upload-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .confirm-upload-btn {
            flex: 1;
            padding: 12px;
            background: var(--primary);
            border: none;
            color: white;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-upload-btn:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .confirm-upload-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ==========================================
           MODAL DE RÉACTION AUX MESSAGES
           ========================================== */
        .reaction-modal {
            position: fixed;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            padding: 10px;
            display: flex;
            gap: 8px;
            animation: fadeInUp 0.2s ease;
        }

        .reaction-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .reaction-option:hover {
            background: var(--hover-bg);
            transform: scale(1.2);
        }

        /* ==========================================
           MODAL DE RÉPONSE AU MESSAGE
           ========================================== */
        .reply-modal {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 90%;
            max-width: 500px;
            animation: slideUp 0.3s ease;
        }

        .reply-header {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reply-header h4 {
            font-size: 1rem;
            color: var(--text-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-reply-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.2rem;
        }

        .reply-content {
            padding: 15px;
            background: var(--hover-bg);
            margin: 15px;
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--primary);
        }

        .reply-sender {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .reply-text {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.9;
            max-height: 100px;
            overflow-y: auto;
        }

        .reply-input-container {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        /* ==========================================
           INDICATEURS D'ÉTAT
           ========================================== */
        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.3s ease;
        }

        .connection-status.connected {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .connection-status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .connection-status.connecting {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Animations pour les mises à jour de conversations */
        .conversation-list-update {
            animation: slideDown 0.3s ease-out;
        }

        @keyframes conversationBringToTop {
            from {
                opacity: 0.7;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .conversation-message-received {
            animation: conversationBringToTop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes pulse-border {
            0%, 100% {
                border-left-color: transparent;
            }
            50% {
                border-left-color: var(--secura-red);
            }
        }

        .new-message-indicator {
            animation: pulse-border 1s ease-in-out infinite;
            border-left: 3px solid transparent;
            padding-left: 10px;
        }

        /* ==========================================
           ANIMATIONS DE MESSAGES
           ========================================== */
        .message-slide-in {
            animation: slideInMessage 0.3s ease;
        }

        @keyframes slideInMessage {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-pop-in {
            animation: popInMessage 0.3s ease;
        }

        @keyframes popInMessage {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            70% {
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ==========================================
           RESPONSIVE DESIGN
           ========================================== */
        @media (max-width: 1024px) {
            .conversations-panel {
                width: 340px;
            }
        }

        @media (max-width: 768px) {
            .conversations-panel {
                width: 100%;
            }
            
            .message-content {
                max-width: 19rem;
                width: auto;

            }
            
            .emoji-picker-container {
                right: 10px;
                bottom: 70px;
            }
            
            emoji-picker {
                width: 100vw;
            }
        }

        @media (max-width: 480px) {
            .chat-header {
                padding: 10px 15px;
            }
            
            .messages-container {
                padding: 15px 10px;
            }
            
            .chat-input-area {
                padding: 10px 15px;
            }
            
            .message-input-container {
                padding: 8px 15px;
            }
            
            .input-action-btn {
                width: 36px;
                height: 36px;
            }
            
            .send-btn {
                width: 40px;
                height: 40px;
            }
            
            .conversation-item {
                padding: 10px 15px;
            }
            
            .conversation-avatar {
                width: 45px;
                height: 45px;
            }
        }

        /* ==========================================
           LOADERS ET ÉTATS VIDES
           ========================================== */
        .loading-messages {
            text-align: center;
            padding: 40px 20px;
            color: var(--placeholder-color);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==========================================
           SKELETON LOADERS - ANIMATIONS DE PULSATION
           ========================================== */
        
        @keyframes skeleton-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .skeleton {
            background: linear-gradient(90deg, var(--hover-bg) 25%, var(--border-color) 50%, var(--hover-bg) 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 2s ease-in-out infinite;
            border-radius: var(--border-radius-sm);
        }
        
        /* Skeleton pour les messages */
        .skeleton-message {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            animation: skeleton-pulse 2s ease-in-out infinite;
        }
        
        .skeleton-message.outgoing {
            flex-direction: row-reverse;
        }
        
        .skeleton-message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--border-color);
            animation: skeleton-pulse 2s ease-in-out infinite;
        }
        
        .skeleton-message-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .skeleton-message-bubble {
            height: 40px;
            width: 60%;
            background: var(--border-color);
            border-radius: 12px;
            animation: skeleton-pulse 2s ease-in-out infinite;
        }
        
        .skeleton-message.outgoing .skeleton-message-bubble {
            align-self: flex-end;
            width: 50%;
        }
        
        .skeleton-message-time {
            height: 12px;
            width: 40%;
            background: var(--border-color);
            border-radius: 4px;
            animation: skeleton-pulse 2s ease-in-out infinite;
            font-size: 0;
        }
        
        /* Skeleton pour la liste de conversations */
        .skeleton-conversation {
            display: flex;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: var(--border-radius-sm);
            animation: skeleton-pulse 2s ease-in-out infinite;
        }
        
        .skeleton-conversation-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            flex-shrink: 0;
            background: var(--border-color);
            animation: skeleton-pulse 2s ease-in-out infinite;
        }
        
        .skeleton-conversation-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .skeleton-conversation-name {
            height: 16px;
            width: 70%;
            background: var(--border-color);
            border-radius: 4px;
            animation: skeleton-pulse 2s ease-in-out infinite;
        }
        
        .skeleton-conversation-preview {
            height: 12px;
            width: 90%;
            background: var(--border-color);
            border-radius: 4px;
            animation: skeleton-pulse 2s ease-in-out infinite;
        }
        
        .skeleton-conversation-time {
            height: 12px;
            width: 30%;
            background: var(--border-color);
            border-radius: 4px;
            animation: skeleton-pulse 2s ease-in-out infinite;
            position: absolute;
            top: 12px;
            right: 12px;
        }
        
        /* Conteneur de skeletons */
        .skeleton-loader-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Overlay du loader pour les messages (ne détruit pas les placeholders) */
        .loading-messages-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.3);
            z-index: 10;
            border-radius: 8px;
        }

        .loading-messages-overlay .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .loading-messages-overlay p {
            color: var(--placeholder-color);
            margin: 0;
        }

        .no-conversation-selected {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px;
            text-align: center;
            color: var(--placeholder-color);
        }

        .no-conversation-selected i.big {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .no-conversation-selected h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .no-conversation-selected p {
            font-size: 0.95rem;
            opacity: 0.8;
        }

        /* État: Aucun message dans la conversation */
        .no-messages-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            text-align: center;
            color: var(--placeholder-color);
        }

        .empty-state-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            max-width: 400px;
        }

        /* Avatar au centre du placeholder */
        .empty-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.5rem;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
            animation: float-up 3s ease-in-out infinite;
        }

        @keyframes float-up {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Conteneur des messages d'exemple */
        .example-messages {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 15px;
        }

        /* Bulles de messages d'exemple */
        .message-bubble {
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            max-width: 70%;
            word-wrap: break-word;
            animation: fadeInScale 0.5s ease-out;
        }

        .message-bubble.received {
            align-self: flex-start;
            background: var(--hover-bg);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .message-bubble.sent {
            align-self: flex-end;
            background: var(--hover-bg);
            color: white;
            border-bottom-right-radius: 4px;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .no-messages-state h3 {
            font-size: 1.3rem;
            margin: 0;
            color: var(--text-color);
            font-weight: 600;
        }

        .no-messages-state .placeholder-text {
            font-size: 0.9rem;
            opacity: 0.7;
            margin: 0;
            line-height: 1.5;
        }

        /* État de connexion perdue */
        .connection-error-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }

        .connection-error-state i.big {
            font-size: 4rem;
            margin-bottom: 20px;
            color: var(--danger);
        }

        .connection-error-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: var(--danger);
            font-weight: 600;
        }

        .connection-error-state p {
            font-size: 0.95rem;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .connection-error-state .retry-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .connection-error-state .retry-btn:hover {
            background: #DC2626;
            transform: translateY(-2px);
        }

        .connection-error-state .retry-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .connection-status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .connection-status-indicator.online {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .connection-status-indicator.offline {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .connection-status-indicator::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .connection-status-indicator.online::before {
            animation: pulse-dot 1s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .no-messages {
            text-align: center;
            padding: 40px 20px;
            color: var(--placeholder-color);
            font-size: 0.95rem;
        }

        /* ==========================================
           TRANSITIONS ET ANIMATIONS
           ========================================== */
        .fade-enter {
            opacity: 0;
        }

        .fade-enter-active {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .fade-exit {
            opacity: 1;
        }

        .fade-exit-active {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* ==========================================
           UTILITAIRES
           ========================================== */
        .hidden {
            display: none !important;
        }

        .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .p-10 {
            padding: 10px;
        }

        .p-20 {
            padding: 20px;
        }

        /* ==========================================
           SCROLLBAR PERSONNALISÉE
           ========================================== */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--hover-bg);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ==========================================
           TOOLTIPS
           ========================================== */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-card);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 10px);
        }

        /* ═══════════════════════════════════════════════════════════════ */
        /* PANEL NOUVELLE CONVERSATION - STYLES PROFESSIONNELS */
        /* ═══════════════════════════════════════════════════════════════ */

        .new-conversation-panel {
            position: fixed;
            right: -450px;
            top: 0;
            height: 100vh;
            width: 450px;
            background: var(--card-bg);
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            z-index: 1050;
            transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 1px solid var(--border-color);
        }

        .new-conversation-panel.active {
            right: 0;
        }

        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            z-index: 1040;
            transition: background 0.35s ease;
            pointer-events: none;
        }

        .panel-overlay.active {
            background: rgba(0, 0, 0, 0.4);
            pointer-events: auto;
        }

        /* Header du panel */
        .panel-header {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            gap: 16px;
            flex-shrink: 0;
        }

        .panel-header .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text-color);
            border: none;
            background: transparent;
        }

        .panel-header .back-btn:hover {
            background: var(--hover-bg);
            transform: scale(1.05);
        }

        .panel-header .back-btn i {
            font-size: 20px;
        }

        .panel-title {
            flex: 1;
        }

        .panel-title h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        .panel-spacer {
            width: 40px;
        }

        /* Contenu du panel */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* Type de conversation */
        .conversation-type-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--hover-bg);
        }

        /* Mise à jour du titre du panel selon le type */
        .panel-title h3 {
            transition: all 0.3s ease;
        }

        .type-selector {
            display: flex;
            gap: 5px;
            background: var(--secura-light-gray);
            padding: 5px;
            border-radius: var(--radius-md);
        }

        .dark-theme .type-selector {
            background: var(--secura-brown);
        }

        .type-selector input {
            display: none;
        }

        .type-label {
            flex: 1;
            padding: 10px 20px;
            border-radius: var(--radius-lg);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s ease;
            background: transparent;
            color: var(--secura-text-gray);
            font-weight: 600;
            font-size: 14px;
        }

        .type-label i {
            font-size: 18px;
        }

        .type-label:hover {
            background: var(--secura-red);
            color: white;
        }

        .type-selector input:checked + .type-label {
            background: var(--secura-red);
            color: white;
            box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
        }

        /* Section nom du groupe */
        .group-name-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .group-name-input {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 14px;
            color: var(--text-color);
            transition: all 0.2s ease;
        }

        .group-name-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }

        /* Barre de recherche */
        

        /* Liste des invités */
        .guests-list-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .guests-list {
            display: flex;
            flex-direction: column;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            gap: 12px;
            color: var(--placeholder-color);
        }

        .loading-state .spinner-border {
            color: var(--primary-color);
        }

        /* Carte d'invité */
        .guest-card {
            position: relative;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .guest-card:hover {
            background: var(--hover-bg);
        }

        .guest-card.selected {
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.1) 0%, rgba(244, 162, 97, 0.1) 100%);
            border-left: 3px solid var(--secura-red);
            padding-left: 13px;
        }

        /* Styles pour les cartes de conversations existantes */
        .guest-card.existing-conversation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(52, 152, 219, 0.05);
            border-left: 3px solid #3498db;
        }

        .guest-card.existing-conversation:hover {
            background: rgba(52, 152, 219, 0.1);
        }

        .guest-card.existing-conversation .guest-card-label {
            padding: 0;
            cursor: default;
        }

        .chat-existing-btn {
            background: #3498db;
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            transition: all 0.2s ease;
        }

        .chat-existing-btn:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .chat-existing-btn:active {
            transform: scale(0.95);
        }

        .guest-card input {
            display: none;
        }

        .guest-card-label {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            gap: 12px;
            margin: 0;
            width: 100%;
            position: relative;
        }

        .guest-avatar-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
        }

        .guest-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secura-white);
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }

        .guest-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .guest-info {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            min-width: 0;
        }

        .guest-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .guest-email {
            font-size: 12px;
            color: var(--secura-medium-gray);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .guest-checkbox-indicator {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            background: transparent;
            color: white;
            position: absolute;
            top: 8px;
            right: 8px;
        }

        .guest-card input:checked ~ .guest-card-label .guest-checkbox-indicator {
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
        }

      

        .guest-card.selected .guest-checkbox-indicator {
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            border-color: transparent;
            box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
            color: white;
        }

        /* Footer du panel */
        .panel-footer {
            display: flex;
            gap: 12px;
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

                /* Style du bouton Créer quand activé */
                .new-conversation-panel .panel-footer #createConversationBtn:not([disabled]) {
                    background: var(--hover-bg) !important;
                    border-color: var(--hover-bg) !important;
                    color: var(--text-on-hover, #fff) !important;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                    cursor: pointer;
                }

        .btn { box-shadow: none;}

        .btn-cancel,
        .btn-create {
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .btn-cancel {
            background: var(--hover-bg);
            color: var(--text-color);
        }

        .btn-cancel:hover:not(:disabled) {
            background: var(--border-color);
        }

        .btn-create {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-create:hover:not(:disabled) {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .btn-create:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-block {
            width: 100%;
        }

        /* ==========================================
           STYLES POUR PANEL PROFIL ET PARAMÈTRES
           ========================================== */

        /* Profile Header */
        .profile-header {

            padding: 24px 16px;
            background: linear-gradient(135deg , var(--dark-card) , var(--dark));
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.2rem;
            font-weight: 800;
            color: white;
            background: var(--gradient);
            flex-shrink: 0;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        
        }

        .profile-info h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .profile-info p {
            margin: 4px 0 0 0;
            font-size: 13px;
            opacity: 0.9;
        }

        .profile-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 12px;
            opacity: 0.9;
        }

        .status-indicator {
            padding: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.online {
            background: #10B981;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
        }

        .status-indicator.busy {
            background: var(--secura-accent);
            box-shadow: 0 0 6px rgba(217, 119, 6, 0.5);
        }

        .status-indicator.away {
            background: #999;
            box-shadow: 0 0 6px rgba(153, 153, 153, 0.3);
        }

        /* Profile Details */
        .profile-details {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .details-section {
            padding: 16px;
            border-radius: 10px;
        }

        

        .details-section .section-title {
            font-size: 13px;
            font-weight: 700;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 12px;
            padding-bottom: 8px;
            color: var(--text-color);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 8px;
            gap: 16px;
        }

        .detail-item:last-child {
            margin-bottom: 0;
        }

        .detail-item .label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-color);
            font-weight: 500;
            flex: 1;
        }

        .detail-item .value {
            font-size: 13px;
            color: var(--secura-red);
            font-weight: 600;
        }

        /* Status Selector */
        .status-selector {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .status-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .status-option:hover {
            border-color: var(--secura-red);
            background: var(--hover-bg);
        }

        .status-option.active {
            border-color: var(--secura-red);
            background: linear-gradient(135deg, rgba(217, 119, 6, 0.1) 0%, rgba(239, 68, 68, 0.1) 100%);
            color: var(--secura-red);
            font-weight: 600;
        }

        .status-option.active[data-status="online"] {
            background: rgba(16, 185, 129, 0.1);
            border-color: #10B981;
            color: #10B981;
            box-shadow: 0 0 6px rgba(16, 185, 129, 0.5);
        }
        .status-option.active[data-status="busy"] {
            color: var(--secura-accent);
            background: rgba(217, 119, 6, 0.1);
            border-color: var(--secura-accent);
            box-shadow: 0 0 6px rgba(217, 119, 6, 0.5);
        }
        .status-option.active[data-status="away"] {
            color: #999;
            background: rgba(153, 153, 153, 0.1);
            border-color: #999;
            box-shadow: 0 0 6px rgba(153, 153, 153, 0.3);
        }

        /* Action Buttons */
        .action-btn,
        .action-btn-primary,
        .action-btn-secondary {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .action-btn:last-child,
        .action-btn-primary:last-child,
        .action-btn-secondary:last-child {
            margin-bottom: 0;
        }

        .action-btn-primary {
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            color: white;
        }

        .action-btn-primary:hover {
            box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
            transform: translateY(-2px);
        }

        .action-btn-secondary {
            background: var(--hover-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .action-btn-secondary:hover {
            background: var(--border-color);
        }

        .action-btn-sm {
            padding: 8px 12px;
            font-size: 12px;
            border-radius: 6px;
            background: var(--hover-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn-sm:hover {
            background: var(--border-color);
        }

        .action-btn-sm.danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .action-btn-sm.danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        /* ==========================================
           STYLES POUR SETTINGS PANEL
           ========================================== */

        .settings-section {
            padding: 16px;
            margin-bottom: 16px;
        }

        .settings-section:last-child {
            margin-bottom: 0;
        }

        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 8px;
            gap: 16px;
        }

        .setting-item:last-child {
            margin-bottom: 0;
        }

        .setting-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .setting-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-color);
        }

        .setting-description {
            font-size: 12px;
            color: var(--text-muted, #999);
        }

        /* Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
        }

        .toggle-checkbox {
            display: none;
        }

        .toggle-label {
            position: relative;
            width: 48px;
            height: 26px;
            background: var(--border-color);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: block;
        }

        .toggle-label::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: all 0.2s ease;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-checkbox:checked + .toggle-label {
            background: var(--secura-red);
        }

        .toggle-checkbox:checked + .toggle-label::after {
            transform: translateX(22px);
        }

        /* Form Selects */
        .theme-selector {
            flex: 1;
        }

        .form-select {
            width: 100%;
            padding: 8px 12px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .form-select:hover,
        .form-select:focus {
            border-color: var(--secura-red);
            outline: none;
            box-shadow: 0 0 0 3px rgba(217, 119, 6, 0.1);
        }

        .form-range {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--secura-red);
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        .form-range::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--secura-red);
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        /* Font Size Selector */
        .font-size-selector {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        #fontSizeValue {
            font-size: 12px;
            color: var(--text-muted, #999);
            min-width: 40px;
        }

        /* Storage Bar */
        .storage-bar {
            width: 100%;
            height: 6px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }

        .storage-used {
            height: 100%;
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            border-radius: 3px;
        }

        

        /* Conversations footer buttons - Round icons with tooltip */
        .conversations-footer-btn {
            width: 48px;
            height: 48px;
            border-radius: 0.5rem;
            border: none;
            background: var(--hover-bg);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            font-size: 18px;
            flex: 0 0 auto;
        }

        .conversations-footer-btn:hover {
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 2px 12px rgba(217, 119, 6, 0.3);
        }

        /* Profile button with avatar */
        .conversations-footer-profile {
            width: auto;
            height: 56px;
            border-radius: 12px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 0 0 auto;
        }

        .conversations-footer-profile:hover {
            background: var(--hover-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .profile-btn-content {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .profile-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
            overflow: hidden;
        }

        .profile-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .profile-btn-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .profile-btn-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .profile-btn-status {
            font-size: 10px;
            color: var(--text-muted, #999);
            display: flex;
            align-items: center;
            gap: 4px;
        }

     
        .status-dot.online {
            background: #10B981;
            box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
        }

        .status-dot.busy {
            background: var(--secura-accent);
        }

        .status-dot.away {
            background: #999;
        }

        .conversations-footer-btn i {
            display: block;
        }

        .conversations-footer-btn span {
            display: none;
        }

        /* Tooltip on hover */
        .conversations-footer-btn::after {
            content: attr(title);
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 999;
            font-weight: 500;
        }

        .conversations-footer-btn:hover::after {
            opacity: 1;
        }
        

        /* Responsive */
        @media (max-width: 768px) {
            .new-conversation-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <!-- Indicateur de connexion -->
    <div id="connectionStatus" class="connection-status hidden">
        <i class="fas fa-circle"></i>
        <span>Connecté</span>
    </div>

    <!-- Conteneur principal du chat -->
    <div class="chat-container">
        <!-- Panel des conversations -->
        <div class="conversations-panel visible" id="conversationsPanel">
            <!-- En-tête des conversations -->
            <div class="conversations-header">
                <div class="conversations-header-left">
                    <a href="../welcome/index.html" class="back-to-events" id="backToEventsBtn">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                    <h2><i class="fas fa-comments"></i> Messages</h2>
                </div>
                <div class="conversations-header-right">
                    <button class="header-action-btn" id="newConversationBtn" title="Nouvelle conversation">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="header-action-btn" id="refreshConversationsBtn" title="Actualiser">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <!-- Menu mobile -->
                    <button class="mobile-menu-btn" id="mobileMenuBtn" title="Options">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="mobile-menu" id="mobileMenu">
                        <!-- Profile Block en haut -->
                        <div class="mobile-menu-profile" id="mobileMenuProfile">
                            <div class="mobile-menu-profile-header">
                                <div class="mobile-menu-profile-avatar" id="mobileMenuProfileAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="mobile-menu-profile-info">
                                    <div class="mobile-menu-profile-name" id="mobileMenuProfileName">
                                        Utilisateur
                                    </div>
                                    <div class="mobile-menu-profile-status" id="mobileMenuProfileStatus">
                                        <span class="status-indicator online"></span>
                                        <span>En ligne</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Menu Items -->
                        <button class="mobile-menu-item" id="menuNewConversation">
                            <i class="fas fa-edit"></i>
                            <span>Nouvelle conversation</span>
                        </button>
                        <button class="mobile-menu-item" id="menuRefresh">
                            <i class="fas fa-sync-alt"></i>
                            <span>Actualiser</span>
                        </button>
                        <button class="mobile-menu-item" id="menuSettings">
                            <i class="fas fa-cog"></i>
                            <span>Paramètres</span>
                        </button>
                        <button class="mobile-menu-item" id="menuProfile">
                            <i class="fas fa-user"></i>
                            <span>Profil</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recherche de conversations -->
            <div class="conversations-search">
                <div class="search-container ">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="search-input" id="conversationsSearch" placeholder="Rechercher une conversation...">
                </div>
            </div>

            <!-- Filtres rapides -->
            <div class="conversations-filters">
                <button class="filter-btn active" data-filter="all" title="Tous les chats">
                    <i class="fas fa-list"></i> Tous
                </button>
                <button class="filter-btn" data-filter="online" title="Utilisateurs en ligne">
                    <i class="fas fa-circle" style="color: #4ade80;"></i> En ligne
                </button>
                <button class="filter-btn" data-filter="unread" title="Messages non lus">
                    <i class="fas fa-circle"></i> Non lus
                </button>
                <button class="filter-btn" data-filter="direct" title="Conversations directes">
                    <i class="fas fa-user"></i> Direct
                </button>
                <button class="filter-btn" data-filter="group" title="Conversations de groupe">
                    <i class="fas fa-users"></i> Groupe
                </button>
                <button class="filter-btn" data-filter="archived" title="Conversations archivées">
                    <i class="fas fa-archive"></i> Archivé
                </button>
            </div>

            <!-- Liste des conversations -->
            <div class="conversations-list" id="conversationsList">
                <!-- Les conversations seront chargées dynamiquement ici -->
                <div class="loading-messages">
                    <div class="spinner"></div>
                    <p>Chargement des conversations...</p>
                </div>
            </div>

            <!-- Barre d'options en bas (desktop) -->
            <div class="conversations-footer">
                <button class="conversations-footer-btn conversations-footer-profile" id="conversationsProfileBtn" title="Profil">
                    <div class="profile-btn-content">
                        <div class="profile-avatar-small" id="profileBtnAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="profile-btn-info">
                            <div class="profile-btn-name" id="profileBtnName">Profil</div>
                            <div class="profile-btn-status">
                                <span class="status-dot online"></span>
                                <span id="profileBtnStatus">En ligne</span>
                            </div>
                        </div>
                    </div>
                </button>
                <button class="conversations-footer-btn" id="conversationsSettingsBtn" title="Paramètres">
                    <i class="fas fa-cog"></i>
                    <span>Paramètres</span>
                </button>
                  
               
            </div>
        </div>

          <div class="new-conversation-panel" id="newConversationPanel">
            <!-- Header du panel -->
            <div class="panel-header">
                <button class="back-to-events" id="backToConversationsBtn" title="Retour">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="panel-title">
                    <h3>Nouvelle conversation</h3>
                </div>
                <div class="panel-spacer"></div>
            </div>

            <!-- Contenu du panel -->
            <div class="panel-content">
                <!-- Type de conversation -->
                <div class="conversation-type-section">
                    <div class="type-selector">
                        <input type="radio" class="btn-check" name="conversationType" id="typeDirect" value="direct" autocomplete="off" checked>
                        <label class="type-label" for="typeDirect">
                            <i class="fas fa-user"></i>
                            <span>Conversation</span>
                        </label>
                        
                        <input type="radio" class="btn-check" name="conversationType" id="typeGroup" value="group" autocomplete="off">
                        <label class="type-label" for="typeGroup">
                            <i class="fas fa-users"></i>
                            <span>Groupe</span>
                        </label>
                    </div>
                </div>

                <!-- Nom du groupe supprimé - déplacé au modal -->

                <!-- Barre de recherche -->
                <div class="search-section conversations-search">
                    <div class="search-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="newConversationSearch" placeholder="Rechercher un contact...">
                    </div>
                </div>

                <!-- Liste des invités -->
                <div class="guests-list-container">
                    <div id="newConversationUsersList" class="guests-list">
                        <!-- Invités seront chargés ici -->
                        <div class="loading-state">
                            <div class="spinner-border text-primary"></div>
                            <p>Chargement des contacts...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer avec bouton créer -->
            <div class="panel-footer">
                <button type="button" class="btn btn-secondary btn-cancel" id="cancelConversationBtn">Annuler</button>
                <button type="button" class="btn btn-primary " id="createConversationBtn" disabled>
                    <i class="fas fa-comments me-1"></i> Continuer
                </button>
            </div>
        </div>

        <!-- Overlay semi-transparent -->
        <div class="panel-overlay" id="panelOverlay"></div>

        <!-- Modal de création de groupe -->
        <div class="new-group-modal" id="newGroupModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000; align-items: center; justify-content: center;">
            <!-- Overlay pour le modal -->
            <div class="modal-overlay" id="groupModalOverlay" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1999;"></div>
            <div class="modal-content" style="position: relative; background: var(--bg-color); border-radius: 12px; padding: 24px; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.1); z-index: 2001;">
                <!-- Header du modal -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Créer le groupe</h3>
                    <button type="button" class="close-modal-btn" id="closeGroupModalBtn" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-color); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Input du nom du groupe -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; color: var(--text-color);">Nom du groupe</label>
                    <div style="position: relative;">
                        <i class="fas fa-tag" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--secura-medium-gray); font-size: 14px;"></i>
                        <input type="text" id="groupNameModalInput" placeholder="Entrez le nom du groupe" maxlength="50" style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--bg-color); color: var(--text-color); box-sizing: border-box;" />
                    </div>
                </div>

                <!-- Participants sélectionnés -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 14px; font-weight: 500; margin-bottom: 12px; color: var(--text-color);">Participants (<span id="participantCount">0</span>/5)</label>
                    <div id="groupModalParticipants" style="display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto;">
                        <!-- Les participants sélectionnés seront affichés ici -->
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div style="display: flex; gap: 12px; margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" id="cancelGroupModalBtn" style="flex: 1; padding: 12px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;">Annuler</button>
                    <button type="button" class="btn btn-primary" id="confirmGroupCreationBtn" style="flex: 1; padding: 12px 16px; border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer;" disabled>
                        <i class="fas fa-check me-1"></i> Créer Groupe
                    </button>
                </div>
            </div>
        </div>

        <!-- Panel Profil -->
        <div class="new-conversation-panel" id="profilePanel">
            <!-- Header du panel -->
            <div class="panel-header">
                <button class="btn btn-icon back-btn" id="backProfileBtn" title="Retour">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="panel-title">
                    <h3>Profil</h3>
                </div>
                <div class="panel-spacer"></div>
            </div>

            <!-- Contenu du panel -->
            <div class="panel-content">
                <!-- Avatar et infos utilisateur -->
                <div class="profile-header">
                    <div class="profile-avatar-large" id="profileAvatarLarge">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="profile-info">
                        <h3 id="profileName">Nom Utilisateur</h3>
                        <p id="profileEmail" >email@example.com</p>
                        <div class="profile-status">
                            <span class="status-indicator online" id="profileStatusIndicator"></span>
                            <span id="profileStatusText">En ligne</span>
                        </div>
                    </div>
                </div>

                <!-- Détails du profil -->
                <div class="profile-details">
                    <div class="details-section">
                        <h4 class="section-title">Informations personnelles</h4>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-user"></i> Nom</span>
                            <span id="detailName" class="value">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-envelope"></i> Email</span>
                            <span id="detailEmail" class="value">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-phone"></i> Téléphone</span>
                            <span id="detailPhone" class="value">-</span>
                        </div>
                        <div class="detail-item">
                            <span class="label"><i class="fas fa-calendar"></i> Date d'adhésion</span>
                            <span id="detailJoinDate" class="value">-</span>
                        </div>
                    </div>

    
                    
                </div>
            </div>

            <!-- Footer du panel -->
            <div class="panel-footer">
                <button type="button" class="btn btn-secondary btn-block" id="closeProfileBtn">Fermer</button>
            </div>
        </div>

        <!-- Panel Paramètres -->
        <div class="new-conversation-panel" id="settingsPanel">
            <!-- Header du panel -->
            <div class="panel-header">
                <button class="btn btn-icon back-btn" id="backSettingsBtn" title="Retour">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="panel-title">
                    <h3>Paramètres</h3>
                </div>
                <div class="panel-spacer"></div>
            </div>

            <!-- Contenu du panel -->
            <div class="panel-content">
                <!-- Paramètres de notification -->
                <div class="settings-section">
                    <h4 class="section-title">
                        <i class="fas fa-bell"></i> Notifications
                    </h4>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Notifications de messages</span>
                            <small class="setting-description">Recevoir une notification pour chaque nouveau message</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="notifMessages" class="toggle-checkbox" checked>
                            <label for="notifMessages" class="toggle-label"></label>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Notifications sonores</span>
                            <small class="setting-description">Activer les sons de notification</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="notifSound" class="toggle-checkbox" checked>
                            <label for="notifSound" class="toggle-label"></label>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Notifications de lecture</span>
                            <small class="setting-description">Recevoir une notification quand un message est lu</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="notifRead" class="toggle-checkbox" checked>
                            <label for="notifRead" class="toggle-label"></label>
                        </div>
                    </div>
                </div>

                <!-- Paramètres d'affichage -->
                <div class="settings-section">
                    <h4 class="section-title">
                        <i class="fas fa-palette"></i> Affichage
                    </h4>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Thème</span>
                            <small class="setting-description">Choisir le thème de l'interface</small>
                        </div>
                        <div class="theme-selector">
                            <select id="themeSelect" class="form-select">
                                <option value="light">Clair</option>
                                <option value="dark">Sombre</option>
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Taille des caractères</span>
                            <small class="setting-description">Ajuster la taille du texte</small>
                        </div>
                        <div class="font-size-selector">
                            <input type="range" id="fontSizeRange" min="12" max="18" value="14" class="form-range">
                            <span id="fontSizeValue">14px</span>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Indicateurs de frappe</span>
                            <small class="setting-description">Afficher quand quelqu'un est en train d'écrire</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="showTyping" class="toggle-checkbox" checked>
                            <label for="showTyping" class="toggle-label"></label>
                        </div>
                    </div>
                </div>

                <!-- Paramètres de confidentialité -->
                <div class="settings-section">
                    <h4 class="section-title">
                        <i class="fas fa-shield-alt"></i> Confidentialité
                    </h4>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Statut en ligne visible</span>
                            <small class="setting-description">Montrer votre statut aux autres utilisateurs</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="showStatus" class="toggle-checkbox" checked>
                            <label for="showStatus" class="toggle-label"></label>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Confirmations de lecture</span>
                            <small class="setting-description">Confirmer la lecture de vos messages</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="readReceipts" class="toggle-checkbox" checked>
                            <label for="readReceipts" class="toggle-label"></label>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Historique des messages</span>
                            <small class="setting-description">Conserver l'historique des anciens messages</small>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="keepHistory" class="toggle-checkbox" checked>
                            <label for="keepHistory" class="toggle-label"></label>
                        </div>
                    </div>
                </div>

                <!-- Paramètres de stockage -->
                <div class="settings-section">
                    <h4 class="section-title">
                        <i class="fas fa-hdd"></i> Stockage
                    </h4>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Espace utilisé</span>
                            <div class="storage-bar">
                                <div class="storage-used" style="width: 45%;"></div>
                            </div>
                            <small class="setting-description">450 MB sur 1 GB</small>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Vider le cache</span>
                            <small class="setting-description">Supprimer les fichiers temporaires</small>
                        </div>
                        <button class="action-btn-sm" id="clearCacheBtn">
                            <i class="fas fa-trash"></i> Vider
                        </button>
                    </div>
                </div>

                <!-- Paramètres avancés -->
                <div class="settings-section">
                    <h4 class="section-title">
                        <i class="fas fa-cog"></i> Avancés
                    </h4>
                    
                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Données personnelles</span>
                            <small class="setting-description">Télécharger vos données</small>
                        </div>
                        <button class="action-btn-sm" id="downloadDataBtn">
                            <i class="fas fa-download"></i> Télécharger
                        </button>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <span class="setting-label">Supprimer le compte</span>
                            <small class="setting-description">Supprimer définitivement votre compte</small>
                        </div>
                        <button class="action-btn-sm danger" id="deleteAccountBtn">
                            <i class="fas fa-times"></i> Supprimer
                        </button>
                    </div>
                </div>
            </div>

            <!-- Footer du panel -->
            <div class="panel-footer">
                <button type="button" class="btn btn-secondary btn-block" id="closeSettingsBtn">Fermer</button>
            </div>
        </div>

        <!-- Panel Overlay pour profil et paramètres -->
        <div class="panel-overlay" id="profileSettingsOverlay"></div>

        <!-- Zone de chat principale -->
        <div class="chat-main" id="chatMain">
            <!-- En-tête du chat (visible quand une conversation est sélectionnée) -->
            <div class="chat-header" id="chatHeader" style="display: none;">
                <div class="chat-header-left">
                    <button class="toggle-conversations-btn" id="toggleConversationsBtn">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <div class="chat-avatar" id="chatAvatar">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="chat-info">
                        <div class="chat-title" id="chatTitle">Nom de la conversation</div>
                        <div class="chat-status" id="chatStatus">
                            <span id="statusText">En ligne</span>
                        </div>
                    </div>
                </div>
                <div class="chat-header-right">
                    <!-- Bouton d'appel audio -->
                    <button class="header-action-btn" id="audioCallBtn" title="Appel audio">
                        <i class="fas fa-phone"></i>
                    </button>
                    
                    <!-- Bouton d'appel vidéo -->
                    <button class="header-action-btn" id="videoCallBtn" title="Appel vidéo">
                        <i class="fas fa-video"></i>
                    </button>
                    
                    <!-- Menu d'actions -->
                    <div class="chat-actions-menu" id="chatActionsMenu">
                        <button class="header-action-btn menu-toggle" id="chatActionsBtn" title="Actions">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="mobile-menu" id="actionsDropdown">
                            

                        <div class="mobile-menu-profile" id="MenuProfile">
                            <div class="mobile-menu-profile-header">
                                <div class="mobile-menu-profile-avatar" id="MenuProfileAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="mobile-menu-profile-info">
                                    <div class="mobile-menu-profile-name" id="MenuProfileName">
                                        Utilisateur
                                    </div>
                                    <div class="mobile-menu-profile-status" id="MenuProfileStatus">
                                        <span class="status-indicator online"></span>
                                        <span>En ligne</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                            <!-- Infos de la conversation -->
                            <button class="mobile-menu-item" id="actionInfoBtn">
                                <i class="fas fa-info-circle"></i>
                                <span>Informations</span>
                            </button>
                            <!-- Fermer la conversation -->
                            <button class="mobile-menu-item" id="actionCloseBtn">
                                <i class="fas fa-times"></i>
                                <span>Fermer</span>
                            </button>
                            <!-- Supprimer la conversation -->
                            <button class="mobile-menu-item danger" id="actionDeleteBtn">
                                <i class="fas fa-trash"></i>
                                <span>Supprimer</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zone des messages -->
            <div class="messages-container" id="messagesContainer">
                <!-- Aucune conversation sélectionnée -->
                <div class="no-conversation-selected" id="noConversationSelected">
                    <i class="fas fa-comments big"></i>
                    <h3>Bienvenue sur le chat</h3>
                    <p>Sélectionnez une conversation pour commencer à discuter</p>
                </div>

                <!-- Aucun message dans la conversation -->
                <div class="no-messages-state" id="noMessagesState" style="display: none;">
                    <div class="empty-state-content">
                        <!-- Avatar de la personne au centre -->
                        <div class="empty-avatar" id="emptyStateAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        
                        <!-- Messages d'exemple -->
                        <div class="example-messages">
                            <div class="message-bubble received">
                                <span>Bonjour ! 👋</span>
                            </div>
                            <div class="message-bubble sent">
                                <span>Salut ! Comment ça va ? 😊</span>
                            </div>
                        </div>
                        
                        <!-- Texte d'encouragement -->
                        <h3>Commencez la conversation</h3>
                        <p class="placeholder-text">Envoyez un message pour démarrer une discussion avec cette personne</p>
                    </div>
                </div>

                <!-- État de connexion perdue -->
                <div class="connection-error-state" id="connectionErrorState" style="display: none;">
                    <i class="fas fa-wifi-off big"></i>
                    <h3>Connexion perdue</h3>
                    <p>Le serveur est actuellement indisponible.</p>
                    <p>Tentative de reconnexion automatique en cours...</p>
                    <button class="retry-btn" id="manualRetryBtn">
                        <i class="fas fa-redo me-2"></i>Réessayer maintenant
                    </button>
                </div>

                <!-- État d'appel audio -->
                <div class="call-state" id="audioCallState" data-call-type="audio" style="display: none;">
                    <button class="back-to-chat-btn" id="backFromAudioBtn" title="Retour au chat">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="call-state-content">
                        <!-- Avatar de l'appelé -->
                        <div class="call-avatar" id="callAvatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <!-- Nom de l'appelé -->
                        <div class="call-name" id="callName">Appel audio</div>
                        <!-- État de l'appel -->
                        <div class="call-status" id="callStatus">
                            <span class="status-text">En attente...</span>
                        </div>
                        <!-- Minuteur -->
                        <div class="call-timer" id="callTimer" style="display: none;">00:00</div>
                        <!-- Actions d'appel -->
                        <div class="call-actions">
                            <button class="call-action-btn mute-btn" id="muteBtn" title="Couper le son">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="call-action-btn end-call-btn" id="endCallBtn" title="Terminer l'appel">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                            <button class="call-action-btn speaker-btn" id="speakerBtn" title="Haut-parleur">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- État d'appel vidéo -->
                <div class="call-state video-call" id="videoCallState" data-call-type="video" style="display: none;">
                    <button class="back-to-chat-btn" id="backFromVideoBtn" title="Retour au chat">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="call-state-content">
                        <!-- Vidéo distante (principal) -->
                        <div class="remote-video-container" id="remoteVideoContainer">
                            <video id="remoteVideo" autoplay playsinline></video>
                            <!-- Fallback avatar si pas de vidéo -->
                            <div class="video-fallback" id="videoFallback">
                                <div class="call-avatar" id="videoCallAvatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="call-name" id="videoCallName">Appel vidéo</div>
                            </div>
                        </div>
                        
                        <!-- Vidéo locale (coin) -->
                        <div class="local-video-container" id="localVideoContainer">
                            <video id="localVideo" autoplay muted playsinline></video>
                            <div class="local-video-label">Vous</div>
                        </div>
                        
                        <!-- État de l'appel -->
                        <div class="call-status" id="videoCallStatus">
                            <span class="status-text">En attente...</span>
                        </div>
                        
                        <!-- Minuteur -->
                        <div class="call-timer" id="videoCallTimer" style="display: none;">00:00</div>
                        
                        <!-- Actions d'appel -->
                        <div class="call-actions">
                            <button class="call-action-btn mute-btn" id="videoMuteBtn" title="Couper le son">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="call-action-btn camera-btn" id="cameraBtn" title="Caméra">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="call-action-btn end-call-btn" id="videoEndCallBtn" title="Terminer l'appel">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                            <button class="call-action-btn speaker-btn" id="videoSpeakerBtn" title="Haut-parleur">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Zone de saisie -->
            <div class="chat-input-area" id="chatInputArea" style="display: none;">
                <div class="input-actions">
                    <button class="input-action-btn" id="attachFileBtn" title="Joindre un fichier">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <button class="input-action-btn" id="attachImageBtn" title="Joindre une image">
                        <i class="fas fa-image"></i>
                    </button>
                </div>
                
                <div class="message-input-container">
                    <!-- Aperçu de réponse -->
                    <div id="replyPreview" class="reply-preview-inline" style="display: none;">
                        <div class="reply-preview-content">
                            <div class="reply-info">
                                <span class="reply-sender"></span>
                                <button onclick="cancelReply()" class="btn-cancel-reply" title="Annuler la réponse">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="reply-text"></div>
                        </div>
                    </div>

                    <textarea id="messageInput" placeholder="Écrivez votre message..." rows="1"></textarea>
                    <div class="emoji-btn" id="emojiBtn">
                        <span>😀</span>
                    </div>
                </div>
                
                <button class="send-btn" id="sendBtn" title="Envoyer">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <!-- Indicateur d'écriture -->
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
                <span id="typingText">quelqu'un est en train d'écrire...</span>
            </div>
        </div>
    </div>

    
    <!-- Modal d'informations de conversation -->
    <div class="chat-info-modal" id="chatInfoModal">
        <div class="chat-info-content">
            <div class="chat-info-header">
                <h3>Informations du chat</h3>
                <button class="close-info-btn" id="closeInfoBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chat-info-body" id="chatInfoBody">
                <!-- Contenu chargé dynamiquement -->
            </div>
        </div>
    </div>

    <!-- Modal d'envoi de fichier -->
    <div class="file-upload-modal" id="fileUploadModal">
        <div class="file-upload-content">
            <div class="file-upload-header">
                <h3>Envoyer un fichier</h3>
                <button class="close-upload-btn" id="closeUploadBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="file-upload-body">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">Glissez-déposez votre fichier ici</div>
                    <div class="upload-subtext">ou cliquez pour parcourir</div>
                    <input type="file" id="fileInput" accept="*">
                </div>
                
                <div class="file-preview" id="filePreview">
                    <div class="preview-header">
                        <h4>Fichier à envoyer</h4>
                        <button class="remove-preview" id="removePreviewBtn">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="preview-content" id="previewContent">
                        <!-- Contenu chargé dynamiquement -->
                    </div>
                    <div class="upload-progress" id="uploadProgress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">0%</div>
                    </div>
                </div>
                
                <div class="upload-actions">
                    <button class="cancel-upload-btn" id="cancelUploadBtn">Annuler</button>
                    <button class="confirm-upload-btn" id="confirmUploadBtn" disabled>Envoyer le fichier</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de réaction aux messages -->
    <div class="reaction-modal" id="reactionModal" style="display: none;">
        <div class="reaction-option" data-reaction="👍">👍</div>
        <div class="reaction-option" data-reaction="❤️">❤️</div>
        <div class="reaction-option" data-reaction="😂">😂</div>
        <div class="reaction-option" data-reaction="😮">😮</div>
        <div class="reaction-option" data-reaction="😢">😢</div>
        <div class="reaction-option" data-reaction="👏">👏</div>
    </div>

    <!-- Modal de réponse au message -->
    <div class="reply-modal" id="replyModal" style="display: none;">
        <div class="reply-header">
            <h4><i class="fas fa-reply"></i> Répondre à</h4>
            <button class="close-reply-btn" id="closeReplyBtn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="reply-content" id="replyContent">
            <!-- Contenu du message à répondre -->
        </div>
        <div class="reply-input-container">
            <textarea id="replyInput" placeholder="Votre réponse..." class="message-input" rows="2"></textarea>
        </div>
    </div>

    <div class="emoji-picker-container" id="emojiPickerContainer">
        <emoji-picker></emoji-picker>
    </div>

    <!-- Scripts -->
    <script src="../js/audio-utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            SECURA_AUDIO.preload();
        });
    </script>
    
    <!-- Librairies -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
 
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>


   <!-- Librairies -->
  
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <!-- Socket.io pour WebSockets temps réel -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Scripts locaux -->
    <script src="../js/storage.js"></script>
    <script src="../js/auth-check.js"></script>
    <script src="../js/theme.js" defer></script>
    <script src="../js/toastify.js" defer></script>
    <script src="../js/langue.js"></script>
    <script src="../js/main.js"></script>
    


    <!-- Script principal du chat -->
    <script>

        
        function getAuthToken() {
            return localStorage.getItem('secura_event_session_token') 
                || localStorage.getItem('secura_token') 
                || window.storage?.token 
                || null;
        }

        // Variables globales
        let currentUser = null;
        let currentEvent = null;
        let currentConversation = null;
        let currentConversationId = null;
        let conversations = [];
        let messages = [];
        let typingTimeout = null;
        let messagePollingInterval = null;
        let conversationPollingInterval = null;
        let chatSocket = null; // WebSocket connection
        let selectedFile = null;
        let replyingToMessage = null;
        let reactingToMessage = null;
        let isOnline = navigator.onLine;
        let messagePage = 1;
        const messagesPerPage = 50;
        
        // Gestion de l'état de connexion
        let isServerOnline = true;
        let connectionRetryCount = 0;
        let maxConnectionRetries = 5;
        let connectionRetryInterval = null;
        const connectionRetryDelay = 3000; // 3 secondes

        // Initialisation
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Vérifier l'authentification
                await checkAuthentication();
                
                
                // Charger l'utilisateur courant
                await loadCurrentUser();
                
                // Initialiser les composants
                initComponents();
                
                // Initialiser WebSocket après chargement de l'utilisateur
                setTimeout(() => initWebSocket(), 500);
                
                // Charger les conversations
                await loadConversations();
                
                // Démarrer le polling
                startPolling();
                
                // Gérer la connexion/réseau
                setupNetworkHandling();
                
            } catch (error) {
                console.error('Erreur d\'initialisation:', error);
                showToast('Erreur de chargement du chat', 'error');
            }
        });

        // Vérifier l'authentification de session d'événement
        async function checkAuthentication() {
            const token = localStorage.getItem('secura_event_session_token');
            if (!token) {
                window.location.href = '../access.html';
                throw new Error('Aucune session d\'événement active');
            }
            
            try {
                // Vérifier que la session existe et est valide
                const sessionResult = await window.storage.getCurrentSessionDetails();
                
                if (!sessionResult?.success || !sessionResult?.data) {
                    throw new Error('Session invalide ou expirée');
                }
                
                const sessionData = sessionResult.data;
                
                // Vérifier qu'on a au minimum une table
                if (!sessionData.table) {
                    throw new Error('Table non associée à la session');
                }
                
                console.log('✅ Session valide:', sessionData);
                return sessionData;
                
            } catch (error) {
                console.error('❌ Erreur vérification session:', error);
                throw error;
            }
        }

        // Charger l'invité courant de la session
        async function loadCurrentUser() {
            try {
                // Récupérer les détails de la session d'événement
                const sessionResult = await window.storage.getCurrentSessionDetails();
                
                if (!sessionResult?.success || !sessionResult?.data) {
                    throw new Error('Session introuvable');
                }
                
                const sessionData = sessionResult.data;
                
                
                // L'invité courant (peut être null en mode anonyme)
                currentUser = sessionData.guest || null;
                currentEvent = sessionData.event || null;
                
                // Stocker aussi les données de session pour utilisation ultérieure
                window.storage.currentSession = sessionData;
                
                if (currentUser) {
                    console.log('✅ Invité chargé:', {
                        id: currentUser.id,
                        name: `${currentUser.firstName} ${currentUser.lastName}`,
                        email: currentUser.email,
                    });
                } else {
                    console.log('ℹ️ Mode anonyme - table:', sessionData.table?.tableNumber);
                }
                
                return currentUser;
                
            } catch (error) {
                console.error('❌ Erreur chargement invité:', error);
                throw error;
            }
        }

        // ════════════════════════════════════════════════════════════════════
        // 🔌 WEBSOCKET - INITIALISATION ET GESTION
        // ════════════════════════════════════════════════════════════════════

        // Initialiser la connexion WebSocket
        async function initWebSocket() {
            if (!currentUser || !window.storage?.currentSession) {
                console.warn('⚠️ WebSocket: Session non disponible, tentative en mode anonyme');
            }

            try {
                const token = localStorage.getItem('secura_event_session_token');
                const eventId = currentEvent?.id || 'unknown_event';
                const userId = currentUser?.id || 'anonymous';

                // Configuration de la connexion WebSocket
                const socketConfig = {
                    auth: {
                        token,
                        userId,
                        eventId
                    },
                    reconnection: true,
                    reconnectionDelay: 1000,
                    reconnectionDelayMax: 5000,
                    reconnectionAttempts: 5,
                    transports: ['websocket', 'polling']
                };

                // Déterminer l'URL du serveur (développement ou production)
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const serverUrl = isLocalhost 
                    ? 'http://localhost:3000' 
                    : window.location.origin.replace(/\/welcome.*/, ''); // Récupère l'origin correct sans /api

                console.log('🌐 WebSocket URL:', serverUrl, '| Socket path: /chat | User:', userId);

                // Se connecter au namespace /chat
                chatSocket = io(serverUrl + '/chat', socketConfig);

                // Configurer les écouteurs WebSocket
                setupWebSocketListeners();

                console.log('✅ WebSocket: Initialisation en cours...');

            } catch (error) {
                console.error('❌ WebSocket: Erreur initialisation', error);
            }
        }

        // Configurer les écouteurs WebSocket
        function setupWebSocketListeners() {
            if (!chatSocket) {
                console.warn('⚠️ WebSocket: Socket non disponible');
                return;
            }

            // ────────────────────────────────────────────────────────
            // 🔌 Événements de connexion
            // ────────────────────────────────────────────────────────

            chatSocket.on('connect', () => {
                console.log('✅ WebSocket: Connecté au serveur | Socket ID:', chatSocket.id);
                isOnline = true;
                updateConnectionStatus();
                
                console.log('📤 Émission user:online:', {
                    userId: currentUser?.id || 'anonymous',
                    timestamp: new Date()
                });
                
                // Notifier le serveur que l'utilisateur est en ligne
                chatSocket.emit('user:online', {
                    userId: currentUser?.id || 'anonymous',
                    timestamp: new Date()
                });
            });

            chatSocket.on('disconnect', () => {
                console.log('❌ WebSocket: Déconnecté du serveur');
                isOnline = false;
                updateConnectionStatus();
            });

            chatSocket.on('connect_error', (error) => {
                console.warn('⚠️ WebSocket: Erreur de connexion', error);
                console.log('Erreur détails:', {
                    message: error.message,
                    type: error.type,
                    data: error.data
                });
                isOnline = false;
                updateConnectionStatus();
            });

            // ────────────────────────────────────────────────────────
            // 💬 Événements de messages
            // ────────────────────────────────────────────────────────

            // Nouveau message reçu
            chatSocket.on('message:new', (data) => {
                const { id, conversationId, senderId, content, timestamp, type, createdAt } = data;
                
                console.log('💬 WebSocket: Nouveau message reçu', { conversationId, senderId, id });

                if (!Array.isArray(messages)) {
                    messages = [];
                }

                if (!messages.some(m => m.id === id)) {
                    messages.push({
                        id,
                        conversationId,
                        senderId,
                        content,
                        createdAt: createdAt || timestamp,
                        type: type || 'text',
                        delivered: true,
                        readBy: [],
                        reactions: {}
                    });

                    // 📋 TOUJOURS mettre à jour la liste des conversations
                    const conv = conversations.find(c => c.id === conversationId);
                    if (conv) {
                        // ✅ Construire un objet message complet pour lastMessage
                        const messageTimestamp = createdAt || timestamp;
                        conv.lastMessage = {
                            id,
                            content,
                            senderId,
                            createdAt: messageTimestamp,
                            type: type || 'text',
                            delivered: true,
                            readBy: [],
                            reactions: {}
                        };
                        
                        // ✅ Mettre à jour updatedAt pour le tri
                        conv.updatedAt = messageTimestamp;
                        
                        // ✅ Réordonner les conversations
                        conversations.sort((a, b) => 
                            new Date(b.updatedAt || b.createdAt || 0) - new Date(a.updatedAt || a.createdAt || 0)
                        );
                        
                        // ✅ Rendu de la liste des conversations
                        renderConversationsList(conversations);
                    }

                    // 💬 Afficher le message UNIQUEMENT si c'est un message d'un autre utilisateur
                    if (currentConversationId === conversationId && senderId !== (currentUser?.id || 'anonymous')) {
                        renderMessages(messages);
                        setTimeout(scrollToBottom, 100);
                    }
                } else {
                    console.log('⚠️ Message déjà existant, ignoré');
                }
            });

            chatSocket.on('conversation:message-received', (data) => {
                const { conversationId, senderId, messagePreview, timestamp } = data;
                
                console.log('📬 WebSocket: Message reçu dans conversation', { conversationId });

                const conv = conversations.find(c => c.id === conversationId);
                if (conv) {
                    conv.lastMessage = {
                        content: messagePreview,
                        senderId,
                        createdAt: timestamp,
                        type: 'text',
                        delivered: true,
                        readBy: [],
                        reactions: {}
                    };
                    
                    // ✅ Mettre à jour updatedAt pour le tri
                    conv.updatedAt = timestamp;
                    
                    // ✅ Réordonner les conversations
                    conversations.sort((a, b) => 
                        new Date(b.updatedAt || b.createdAt || 0) - new Date(a.updatedAt || a.createdAt || 0)
                    );

                    // ✅ Rendu de la liste des conversations
                    renderConversationsList(conversations);
                    
                    // Animation de notification
                    const convElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                    if (convElement && currentConversationId !== conversationId) {
                        convElement.classList.add('pulse-notification');
                        setTimeout(() => convElement.classList.remove('pulse-notification'), 1000);
                    }
                }
            });

            // ────────────────────────────────────────────────────────
            // ✏️ Événements d'édition/suppression
            // ────────────────────────────────────────────────────────

            chatSocket.on('message:edited', (data) => {
                const { messageId, newContent, editedBy, editedAt } = data;
                
                const message = messages.find(m => m.id === messageId);
                if (message) {
                    message.content = newContent;
                    message.edited = true;
                    message.editedAt = new Date(editedAt);
                    
                    if (currentConversationId) {
                        renderMessages();
                    }
                }
            });

            chatSocket.on('message:deleted', (data) => {
                const { messageId, deletedBy, deletedAt } = data;
                
                const messageIndex = messages.findIndex(m => m.id === messageId);
                if (messageIndex > -1) {
                    messages.splice(messageIndex, 1);
                    
                    if (currentConversationId) {
                        renderMessages();
                    }
                }
            });

            // ────────────────────────────────────────────────────────
            // � Événements de réactions
            // ────────────────────────────────────────────────────────

            chatSocket.on('message:reaction:add', (data) => {
                const { conversationId, messageId, userId: reactionUserId, emoji, action, timestamp } = data;
                
                // Mettre à jour le message localement
                const message = messages.find(m => m.id === messageId);
                if (!message) return;
                
                if (!message.reactions) {
                    message.reactions = {};
                }
                
                if (action === 'added') {
                    // Ajouter la réaction
                    if (!message.reactions[emoji]) {
                        message.reactions[emoji] = [];
                    }
                    
                    if (!message.reactions[emoji].includes(reactionUserId)) {
                        message.reactions[emoji].push(reactionUserId);
                    }
                } else if (action === 'removed') {
                    // Retirer la réaction
                    if (message.reactions[emoji]) {
                        const index = message.reactions[emoji].indexOf(reactionUserId);
                        if (index !== -1) {
                            message.reactions[emoji].splice(index, 1);
                        }
                        
                        // Supprimer l'emoji s'il n'y a plus de réactions
                        if (message.reactions[emoji].length === 0) {
                            delete message.reactions[emoji];
                        }
                    }
                }
                
                // Rerendre les messages pour afficher la réaction
                renderMessages(messages);
                
                console.log(`👍 WebSocket: Réaction ${action}`, {
                    messageId,
                    emoji,
                    userId: reactionUserId
                });
            });

            // ────────────────────────────────────────────────────────
            // �👁️ Événements de saisie
            // ────────────────────────────────────────────────────────

            chatSocket.on('message:typing', (data) => {
                const { userId: typingUserId, conversationId, isTyping } = data;
                
                if (isTyping && typingUserId !== (currentUser?.id || 'anonymous')) {
                    showTypingIndicator(conversationId, typingUserId);
                } else {
                    hideTypingIndicator(conversationId, typingUserId);
                }
            });

            // ────────────────────────────────────────────────────────
            // 👤 Événements d'utilisateur
            // ────────────────────────────────────────────────────────

            chatSocket.on('user:status', (data) => {
                const { userId, status, isOnline, lastSeenAt } = data;
                
                console.log(`👤 WebSocket: Utilisateur ${status}`, userId, {
                    isOnline,
                    lastSeenAt
                });

                // Mettre à jour le statut utilisateur dans les conversations
                let updateCount = 0;
                conversations.forEach(conv => {
                    if (conv.participants?.some(p => p.userId === userId)) {
                        const participant = conv.participants.find(p => p.userId === userId);
                        if (participant) {
                            console.log(`  📍 Conversation ${conv.id}: Mise à jour participant`, {
                                before: {
                                    isOnline: participant.isOnline,
                                    status: participant.status,
                                    lastSeenAt: participant.lastSeenAt
                                },
                                after: {
                                    isOnline: isOnline || false,
                                    status: status,
                                    lastSeenAt: lastSeenAt || null
                                }
                            });
                            
                            participant.status = status;
                            participant.isOnline = isOnline || false;
                            participant.lastSeenAt = lastSeenAt || null;
                            updateCount++;
                        }
                    }
                });
                
                console.log(`✅ ${updateCount} conversation(s) mises à jour`);

                // Mettre à jour l'en-tête du chat si c'est la conversation courante
                if (currentConversation) {
                    updateChatHeader();
                }

                // Re-appliquer le filtre actif (important pour le filtre "online")
                filterConversations();
                renderConversationsList(conversations);
            });

            // ────────────────────────────────────────────────────────
            // 👥 Événements de conversation
            // ────────────────────────────────────────────────────────

            chatSocket.on('conversation:user-joined', (data) => {
                const { userId: joinedUserId, userCount } = data;
                console.log(`👥 WebSocket: ${joinedUserId} a rejoint`, { userCount });
                updateConversationUserCount(userCount);
            });

            chatSocket.on('conversation:user-left', (data) => {
                const { userId: leftUserId, userCount } = data;
                console.log(`👥 WebSocket: ${leftUserId} a quitté`, { userCount });
                updateConversationUserCount(userCount);
            });

            // ────────────────────────────────────────────────────────
            //  Événements de synchronisation
            // ────────────────────────────────────────────────────────

            chatSocket.on('conversations:sync-request', (data) => {
                console.log('🔄 WebSocket: Demande de synchronisation', data);
                // Le serveur demande une synchronisation
                loadConversations(true);
            });

            // ────────────────────────────────────────────────────────
            // 🗑️ Événement de suppression de conversation
            // ────────────────────────────────────────────────────────

            chatSocket.on('conversation:deleted', (data) => {
                const { conversationId, deletedBy, timestamp } = data;
                
                console.log('🗑️ WebSocket: Conversation supprimée', { conversationId, deletedBy });

                // ✅ Supprimer la conversation de la liste locale
                const conversationIndex = conversations.findIndex(c => c.id === conversationId);
                if (conversationIndex > -1) {
                    conversations.splice(conversationIndex, 1);
                }

                // ✅ Si c'est la conversation actuellement ouverte
                if (currentConversationId === conversationId) {
                    // Déterminer qui a supprimé (nom du supprimant)
                    let deleterName = 'Un utilisateur';
                    if (deletedBy !== (currentUser?.id || 'anonymous')) {
                        // Chercher le nom dans les participants
                        const deleterConv = conversations.find(c => 
                            c.participants?.some(p => p.userId === deletedBy)
                        );
                        if (deleterConv) {
                            const deleter = deleterConv.participants.find(p => p.userId === deletedBy);
                            if (deleter) {
                                deleterName = deleter.name || deleter.email || 'Un utilisateur';
                            }
                        }
                    }

                    // Fermer le chat
                    currentConversationId = null;
                    currentConversation = null;
                    messages = [];
                    messagePage = 1;

                    // Afficher le message
                    if (deletedBy === (currentUser?.id || 'anonymous')) {
                        showToast('Vous avez supprimé cette conversation', 'info');
                    } else {
                        showToast(`${deleterName} a supprimé cette conversation`, 'info');
                    }

                    // Cacher le chat
                    hideChatArea();
                } else {
                    // Simplement montrer un toast si ce n'est pas la conversation courante
                    showToast('Une conversation a été supprimée', 'info');
                }

                // Rerendre la liste des conversations
                renderConversationsList(conversations);
            });
        }

        // Fonctions utilitaires WebSocket

        function showTypingIndicator(conversationId, userId) {
            const typingElement = document.querySelector(`[data-typing-indicator="${userId}"]`);
            if (!typingElement) {
                const indicator = document.createElement('div');
                indicator.setAttribute('data-typing-indicator', userId);
                indicator.className = 'typing-indicator';
                indicator.innerHTML = '<span></span><span></span><span></span>';
                
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer) {
                    messagesContainer.appendChild(indicator);
                }
            }
        }

        function hideTypingIndicator(conversationId, userId) {
            const indicator = document.querySelector(`[data-typing-indicator="${userId}"]`);
            if (indicator) {
                indicator.remove();
            }
        }

        function updateConversationUserCount(userCount) {
            const userCountElement = document.querySelector('[data-user-count]');
            if (userCountElement) {
                userCountElement.textContent = `${userCount} en ligne`;
            }
        }

        // Envoyer un message via WebSocket
        function sendMessageViaWebSocket(conversationId, content) {
            if (chatSocket && chatSocket.connected) {
                const messageId = 'msg_' + Date.now();
                const timestamp = new Date();

                chatSocket.emit('message:send', {
                    conversationId,
                    content,
                    messageId,
                    timestamp
                });

                return true;
            }
            return false;
        }

        // Notifier une saisie en cours
        function notifyTyping(conversationId) {
            if (chatSocket && chatSocket.connected) {
                
                chatSocket.emit('message:typing', { conversationId });
            }
        }

        // Notifier fin de saisie
        function notifyStopTyping(conversationId) {
            if (chatSocket && chatSocket.connected) {
                chatSocket.emit('message:stop-typing', { conversationId });
            }
        }

        // Rejoindre une conversation
        function joinConversationViaWebSocket(conversationId) {
            if (chatSocket && chatSocket.connected) {
                chatSocket.emit('conversation:join', { conversationId });
            }
        }

        // Quitter une conversation
        function leaveConversationViaWebSocket(conversationId) {
            if (chatSocket && chatSocket.connected) {
                chatSocket.emit('conversation:leave', { conversationId });
            }
        }

        // Ajouter une réaction
        function addReactionViaWebSocket(conversationId, messageId, emoji) {
            if (chatSocket && chatSocket.connected) {
                chatSocket.emit('message:reaction:add', {
                    conversationId,
                    messageId,
                    emoji
                });
            }
        }

        // Éditer un message
        function editMessageViaWebSocket(conversationId, messageId, newContent) {
            if (chatSocket && chatSocket.connected) {
                chatSocket.emit('message:edit', {
                    conversationId,
                    messageId,
                    newContent
                });
            }
        }

        // Supprimer un message
        function deleteMessageViaWebSocket(conversationId, messageId) {
            if (chatSocket && chatSocket.connected) {
                chatSocket.emit('message:delete', {
                    conversationId,
                    messageId
                });
            }
        }

        // ════════════════════════════════════════════════════════════════════
        // Initialiser les composants
        function initComponents() {
            // Initialiser le picker emoji
            initEmojiPicker();
            
            // Écouteurs d'événements
            setupEventListeners();
            
            // Gestion du drag and drop
            setupDragAndDrop();
            
            // Initialiser la saisie de message
            setupMessageInput();
            
            // Initialiser le panel de nouvelle conversation
            initializeConversationPanel();
            
            // Initialiser le profil du menu mobile
            updateMobileMenuProfile();
            
            // Initialiser le bouton profil du footer
            updateProfileButton();
            
            // Initialiser le retry manuel
            const manualRetryBtn = document.getElementById('manualRetryBtn');
            if (manualRetryBtn) {
                manualRetryBtn.addEventListener('click', manualRetryConnection);
            }
            
            // Mettre à jour l'état de connexion
            updateConnectionStatus();
        }

        // Initialiser le picker emoji
        function initEmojiPicker() {
            const picker = document.querySelector('emoji-picker');
            if (picker) {
                picker.addEventListener('emoji-click', event => {
                    const messageInput = document.getElementById('messageInput');
                    if (messageInput) {
                        messageInput.value += event.detail.unicode;
                        messageInput.focus();
                        adjustTextareaHeight(messageInput);
                    }
                });
            }
        }
        function setupEventListeners() {
            // Boutons de navigation
            document.getElementById('backToEventsBtn')?.addEventListener('click', () => {
                window.location.href = '../welcome/index.html';
            });

            document.getElementById('toggleConversationsBtn')?.addEventListener('click', () => {
                const conversationsPanel = document.getElementById('conversationsPanel');
                const chatMain = document.getElementById('chatMain');
                conversationsPanel.classList.toggle('active');
                chatMain.classList.toggle('active');
            });

            // Recherche de conversations
            const searchInput = document.getElementById('conversationsSearch');
            if (searchInput) {
                searchInput.addEventListener('input', debounce(filterConversations, 300));
            }

            // ✅ Filtres rapides des conversations
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Mettre à jour le style actif
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Appliquer le filtre
                    const filterType = btn.dataset.filter;
                    applyConversationFilter(filterType);
                });
            });

            // Boutons d'action
            document.getElementById('newConversationBtn')?.addEventListener('click', openConversationPanel);
            document.getElementById('refreshConversationsBtn')?.addEventListener('click', () => {
                loadConversations(true);
            });

            // Menu mobile
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            
            mobileMenuBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                mobileMenu?.classList.toggle('active');
                
                // Mettre à jour le profil dans le menu
                if (mobileMenu?.classList.contains('active') && currentUser) {
                    updateMobileMenuProfile();
                }
            });

            // Fermer le menu quand on clique ailleurs
            document.addEventListener('click', () => {
                if (mobileMenu?.classList.contains('active')) {
                    mobileMenu.classList.remove('active');
                }
            });

            // Cliquer sur le profile block pour ouvrir le panel profil
            document.getElementById('mobileMenuProfile')?.addEventListener('click', () => {
                mobileMenu?.classList.remove('active');
                openProfilePanel();
            });

            // Items du menu mobile
            document.getElementById('menuNewConversation')?.addEventListener('click', () => {
                mobileMenu?.classList.remove('active');
                openConversationPanel();
            });

            document.getElementById('menuRefresh')?.addEventListener('click', () => {
                mobileMenu?.classList.remove('active');
                loadConversations(true);
            });

            document.getElementById('menuSettings')?.addEventListener('click', () => {
                mobileMenu?.classList.remove('active');
                openSettingsPanel();
            });

            document.getElementById('menuProfile')?.addEventListener('click', () => {
                mobileMenu?.classList.remove('active');
                openProfilePanel();
            });

            document.getElementById('MenuProfile')?.addEventListener('click', () => {
                mobileMenu?.classList.remove('active');
                openProfilePanel();
            });

            

            // Boutons de la barre d'options (desktop)
            document.getElementById('conversationsProfileBtn')?.addEventListener('click', () => {
                openProfilePanel();
            });

            document.getElementById('conversationsSettingsBtn')?.addEventListener('click', () => {
                openSettingsPanel();
            });

           
            // Menu d'actions du chat
            document.getElementById('chatActionsBtn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                const dropdown = document.getElementById('actionsDropdown');
                dropdown?.classList.toggle('active');
            });

            // Fermer le menu d'actions quand on clique ailleurs
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-actions-menu')) {
                    document.getElementById('actionsDropdown')?.classList.remove('active');
                }
            });

            // Bouton Info du menu
            document.getElementById('actionInfoBtn')?.addEventListener('click', () => {
                if (currentConversationId) {
                    showChatInfoModal();
                }
                document.getElementById('actionsDropdown')?.classList.remove('active');
            });

            // Bouton Fermer du menu
            document.getElementById('actionCloseBtn')?.addEventListener('click', () => {
                closeConversation();
                document.getElementById('actionsDropdown')?.classList.remove('active');
            });

            // Bouton Supprimer du menu
            document.getElementById('actionDeleteBtn')?.addEventListener('click', () => {
                if (currentConversationId) {
                    showDeleteConversationDialog(currentConversationId);
                }
                document.getElementById('actionsDropdown')?.classList.remove('active');
            });

            // Bouton d'appel audio
            document.getElementById('audioCallBtn')?.addEventListener('click', () => {
                startAudioCall();
            });

            // Bouton d'appel vidéo
            document.getElementById('videoCallBtn')?.addEventListener('click', () => {
                startVideoCall();
            });

            // Boutons des appels audio
            document.getElementById('endCallBtn')?.addEventListener('click', endAudioCall);
            document.getElementById('muteBtn')?.addEventListener('click', toggleMute);
            document.getElementById('speakerBtn')?.addEventListener('click', toggleSpeaker);
            
            // Bouton de retour depuis l'appel audio
            document.getElementById('backFromAudioBtn')?.addEventListener('click', endAudioCall);

            // Boutons des appels vidéo
            document.getElementById('videoEndCallBtn')?.addEventListener('click', endVideoCall);
            document.getElementById('videoMuteBtn')?.addEventListener('click', toggleVideoMute);
            document.getElementById('cameraBtn')?.addEventListener('click', toggleCamera);
            document.getElementById('videoSpeakerBtn')?.addEventListener('click', toggleVideoSpeaker);
            
            // Bouton de retour depuis l'appel vidéo
            document.getElementById('backFromVideoBtn')?.addEventListener('click', endVideoCall);

            // Boutons d'envoi
            document.getElementById('sendBtn')?.addEventListener('click', sendMessage);
            document.getElementById('messageInput')?.addEventListener('keydown', handleMessageInputKeydown);
            
            // Boutons de pièces jointes
            document.getElementById('attachFileBtn')?.addEventListener('click', () => {
                document.getElementById('fileInput').click();
            });

            document.getElementById('attachImageBtn')?.addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.onchange = handleImageSelection;
                input.click();
            });

            document.getElementById('emojiBtn')?.addEventListener('click', toggleMessageEmojiPicker);

            // Gestion des fichiers
            document.getElementById('fileInput').addEventListener('change', handleFileSelection);
            document.getElementById('removePreviewBtn').addEventListener('click', clearFilePreview);
            document.getElementById('cancelUploadBtn').addEventListener('click', closeFileUploadModal);
            document.getElementById('confirmUploadBtn').addEventListener('click', uploadFile);

            // Fermeture des modaux
            document.getElementById('closeInfoBtn').addEventListener('click', () => {
                document.getElementById('chatInfoModal').classList.remove('active');
            });

            document.getElementById('closeUploadBtn').addEventListener('click', closeFileUploadModal);

            // Gestion des clics hors des modaux
            document.addEventListener('click', handleOutsideClick);
            
            // Fermer les menus actions et réactions quand on clique ailleurs
            document.addEventListener('click', function(event) {
                // Si on ne clique pas sur un menu ou un bouton d'action
                if (!event.target.closest('.message-actions-menu') && 
                    !event.target.closest('.btn-message-actions') &&
                    !event.target.closest('.emoji-reactions-picker') &&
                    !event.target.closest('.add-reaction-btn') &&
                    !event.target.closest('.reaction-item')) {
                    
                    // Fermer tous les menus actions
                    document.querySelectorAll('.message-actions-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                        const btn = menu.closest('.message-actions-dropdown')?.querySelector('.btn-message-actions');
                        if (btn) {
                            btn.classList.remove('open');
                        }
                        const wrapper = menu.closest('.message-wrapper');
                        if (wrapper) {
                            wrapper.style.zIndex = 'auto';
                        }
                    });
                    
                    // Fermer tous les pickers emoji
                    document.querySelectorAll('.emoji-reactions-picker.show').forEach(picker => {
                        picker.classList.remove('show');
                    });
                }
            });
            
            // Redimension
            // Boutons d'action
            const newConvBtn = document.getElementById('newConversationBtn');
            if (newConvBtn) {
                newConvBtn.addEventListener('click', openConversationPanel);
            }

            const refreshBtn = document.getElementById('refreshConversationsBtn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    loadConversations(true);
                });
            }
        }

function showLoadMoreMessagesIndicator() {
    const loadMoreContainer = document.createElement('div');
    loadMoreContainer.id = 'loadMoreMessages';
    loadMoreContainer.className = 'skeleton-loader-container';
    loadMoreContainer.style.padding = '12px';
    loadMoreContainer.style.marginBottom = '12px';
    
    // Créer 3 skeletons pour les anciens messages
    const skeletons = Array(3).fill(0).map((_, i) => {
        const isOutgoing = i % 2 === 0;
        return `
            <div class="skeleton-message ${isOutgoing ? 'outgoing' : 'incoming'}">
                <div class="skeleton-message-avatar"></div>
                <div class="skeleton-message-content">
                    <div class="skeleton-message-bubble"></div>
                    <div class="skeleton-message-time"></div>
                </div>
            </div>
        `;
    }).join('');
    
    loadMoreContainer.innerHTML = skeletons;
    
    const messagesContainer = document.getElementById('messagesContainer');
    const messagesWrapper = document.getElementById('messagesWrapper');
    
    if (messagesWrapper) {
        messagesWrapper.insertBefore(loadMoreContainer, messagesWrapper.firstChild);
    } else if (messagesContainer) {
        messagesContainer.insertBefore(loadMoreContainer, messagesContainer.firstChild);
    }
}

// Masquer l'indicateur de chargement de plus de messages
function hideLoadMoreMessagesIndicator() {
    const loadMoreIndicator = document.getElementById('loadMoreMessages');
    if (loadMoreIndicator) {
        loadMoreIndicator.remove();
    }
}

// ==========================================
// FONCTIONS PRINCIPALES DE GESTION DU CHAT
// ==========================================

function getConversations(conversations, eventId) {
    return conversations.map(conversation => {
        const enrichedParticipants = conversation.participants.map(participant => {
           
            if (participant.firstName && participant.lastName) {
                // Déjà enrichi
                return participant;
            }
            
            let guestInfo = window.storage.data?.guests?.find(g => 
                g.id === participant.userId && g.eventId === eventId
            );
            
            if (!guestInfo) {
                guestInfo = window.storage.data?.users?.find(u => u.id === participant.userId);
            }
            
            if (guestInfo) {
                return {
                    ...participant,
                    name: guestInfo.firstName && guestInfo.lastName 
                        ? `${guestInfo.firstName} ${guestInfo.lastName}` 
                        : guestInfo.name || 'Utilisateur',
                    email: guestInfo.email || '',
                    firstName: guestInfo.firstName || '',
                    lastName: guestInfo.lastName || '',
                    gender: guestInfo.gender || guestInfo.sexe || '',
                    notes: guestInfo.notes || '',
                    // Statut en ligne (défaut: false, pas stocké en BD)
                    isOnline: false,
                    status: 'offline',
                    // Attributs de conversation (rejointe, dernière lecture)
                    joinedAt: participant.joinedAt || null,
                    lastReadAt: participant.lastReadAt || null
                };
            }
            
            return participant;
        });
        
        return {
            ...conversation,
            participants: enrichedParticipants
        };
    });
}

// Charger les conversations
async function loadConversations(forceRefresh = false) {
    try {
        showLoader('conversations');
        
        // Récupérer la session actuelle
        const sessionResult = await window.storage.getCurrentSessionDetails();
        if (!sessionResult?.success) {
            throw new Error('Session invalide');
        }
        
        const eventId = sessionResult.data.event?.id;
        if (!eventId) {
            throw new Error('Aucun événement actif');
        }
        
        const result = await window.storage.getConversations(eventId, forceRefresh);
        
        // Serveur est revenu en ligne
        if (!isServerOnline) {
            isServerOnline = true;
            connectionRetryCount = 0;
            showConnectionStatus(true);
        }
       
        if (result && Array.isArray(result)) {
            conversations = result;
            
            conversations = getConversations(conversations, eventId);
            
            // 🔌 Rejoindre les salles WebSocket pour chaque conversation
            if (chatSocket && chatSocket.connected) {
                conversations.forEach(conv => {
                    joinConversationViaWebSocket(conv.id);
                    console.log(`✅ WebSocket: Rejoint la conversation ${conv.id}`);
                });
            }
            
            renderConversationsList(conversations);
        } else {
            conversations = [];
            renderConversationsList([]);
        }
        
        hideLoader('conversations');
        return conversations;
    } catch (error) {
        console.error('Erreur lors du chargement des conversations:', error);
        hideLoader('conversations');
        
        // Vérifier si c'est une erreur de connexion
        if (error.message.includes('Failed to fetch') || error.message.includes('REFUSED')) {
            handleConnectionError();
        }
        
        renderConversationsList([]);
        return [];
    }
}

// Gérer une erreur de connexion au serveur
function handleConnectionError() {
    if (isServerOnline) {
        isServerOnline = false;
        connectionRetryCount = 0;
        showConnectionStatus(false);
        startAutoRetry();
    }
}

// Afficher l'état de connexion
function showConnectionStatus(online) {
    const noConvSelected = document.getElementById('noConversationSelected');
    const errorState = document.getElementById('connectionErrorState');
    const messagesContainer = document.getElementById('messagesContainer');
    
    if (online) {
        // Serveur en ligne
        if (errorState) errorState.style.display = 'none';
        if (noConvSelected && !currentConversationId) {
            noConvSelected.style.display = 'flex';
        }
        if (messagesContainer) {
            messagesContainer.classList.remove('connection-error');
        }
        console.log('✅ Serveur en ligne');
    } else {
        // Serveur hors ligne
        if (currentConversationId) {
            // Si une conversation est ouverte, afficher l'état d'erreur
            if (messagesContainer) {
                messagesContainer.classList.add('connection-error');
            }
            if (errorState) {
                errorState.innerHTML = `
                    <i class="fas fa-wifi-off big"></i>
                    <h3>Connexion perdue</h3>
                    <p>Le serveur est actuellement indisponible.</p>
                    <p>Tentative de reconnexion automatique en cours...</p>
                    <button class="retry-btn" id="manualRetryBtn">
                        <i class="fas fa-redo me-2"></i>Réessayer maintenant
                    </button>
                `;
                errorState.style.display = 'flex';
                
                // Attacher le listener au bouton
                const retryBtn = document.getElementById('manualRetryBtn');
                if (retryBtn) {
                    retryBtn.onclick = () => manualRetryConnection();
                }
            }
        } else {
            // Pas de conversation ouverte, afficher le message normal
            if (noConvSelected) noConvSelected.style.display = 'flex';
            if (errorState) errorState.style.display = 'none';
        }
        console.log('❌ Serveur hors ligne');
    }
}

// Tentative de reconnexion automatique
function startAutoRetry() {
    if (connectionRetryInterval) clearInterval(connectionRetryInterval);
    
    connectionRetryInterval = setInterval(async () => {
        if (isServerOnline) {
            clearInterval(connectionRetryInterval);
            return;
        }
        
        connectionRetryCount++;
        console.log(`🔄 Tentative de reconnexion ${connectionRetryCount}/${maxConnectionRetries}`);
        
        try {
            // Tenter un appel simple au serveur
            const sessionResult = await window.storage.getCurrentSessionDetails();
            if (sessionResult?.success) {
                isServerOnline = true;
                connectionRetryCount = 0;
                clearInterval(connectionRetryInterval);
                showConnectionStatus(true);
                
                // Recharger les conversations
                await loadConversations(true);
                showToast('Reconnecté au serveur avec succès', 'success');
            }
        } catch (error) {
            console.log(`❌ Reconnexion échouée (tentative ${connectionRetryCount})`);
            
            if (connectionRetryCount >= maxConnectionRetries) {
                clearInterval(connectionRetryInterval);
                console.error('Impossible de se reconnecter après plusieurs tentatives');
            }
        }
    }, connectionRetryDelay);
}

// Retry manuel
async function manualRetryConnection() {
    const retryBtn = document.getElementById('manualRetryBtn');
    if (retryBtn) {
        retryBtn.disabled = true;
        retryBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Reconnexion...';
    }
    
    try {
        await loadConversations(true);
        showToast('Reconnecté avec succès', 'success');
    } catch (error) {
        showToast('Échec de la reconnexion. Réessayez dans quelques secondes.', 'error');
    } finally {
        if (retryBtn) {
            retryBtn.disabled = false;
            retryBtn.innerHTML = '<i class="fas fa-redo me-2"></i>Réessayer maintenant';
        }
    }
}

// Rendre la liste des conversations
function renderConversationsList(conversationsList) {
    const container = document.getElementById('conversationsList');
    if (!container) return;
    
    if (!conversationsList || conversationsList.length === 0) {
        container.innerHTML = `
            <div class="empty-conversations">
                <i class="fas fa-comments big"></i>
                <p>Aucune conversation</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">Commencez une nouvelle conversation</p>
                <button class="create-first-conversation-btn" id="createFirstConversationBtn">
                    <i class="fas fa-comments"></i>
                    <span class="btn-text">Nouvelle Conversation</span>
                </button>
            </div>
        `;
        
        document.getElementById('createFirstConversationBtn')?.addEventListener('click', openConversationPanel);

        return;
    }
    
    // Trier les conversations par dernier message
    conversationsList.sort((a, b) => {
        const aTime = a.updatedAt || a.createdAt;
        const bTime = b.updatedAt || b.createdAt;
        return new Date(bTime) - new Date(aTime);
    });
    
    container.innerHTML = conversationsList.map(conversation => {
        const isActive = conversation.id === currentConversationId;
        const lastMessage = conversation.lastMessage || conversation.messages?.[conversation.messages?.length - 1];
        const unreadCount = conversation.unreadCount || 0;
        
        // Formater la date du dernier message
        let timeText = '';
        if (lastMessage?.createdAt) {
            const messageDate = new Date(lastMessage.createdAt);
            const now = new Date();
            const diffMs = now - messageDate;
            const diffHours = diffMs / (1000 * 60 * 60);
            
            if (diffHours < 24) {
                timeText = messageDate.toLocaleTimeString('fr-FR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                timeText = messageDate.toLocaleDateString('fr-FR', { 
                    day: '2-digit', 
                    month: '2-digit' 
                });
            }
        }
        
        // Extraire le preview du dernier message
        let previewText = '';
        if (lastMessage) {
            if (lastMessage.content) {
                previewText = lastMessage.content.length > 50 
                    ? lastMessage.content.substring(0, 20) + '...' 
                    : lastMessage.content;
            } else if (lastMessage.type === 'image') {
                previewText = '📷 Photo';
            } else if (lastMessage.type === 'file') {
                previewText = '📎 Fichier';
            }
        }
        
        // Nom de la conversation et infos de la personne
        let conversationName = conversation.name || 'Chat';
        let otherParticipant = null;
        let onlineStatus = '';
        
        if (conversation.type === 'direct' && conversation.participants) {
            // Pour les chats directs, afficher le nom de l'autre participant
            const otherParticipants = conversation.participants.filter(p => p.userId !== currentUser?.id);
            if (otherParticipants.length > 0) {
                otherParticipant = otherParticipants[0];
                conversationName = otherParticipant.name || otherParticipant.email || 'Utilisateur';
                
                

            if (otherParticipant.isOnline) {
                onlineStatus = '<span class="status-dot connection-status-indicator online"></span>En ligne';
            } else if (otherParticipant.lastReadAt) {
                const lastReadDate = new Date(otherParticipant.lastReadAt);
                const now = new Date();
                const diffMs = now - lastReadDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                let lastReadText;
                if (diffMins < 1) {
                    lastReadText = 'vu à l\'instant';
                } else if (diffMins < 60) {
                    lastReadText = `vu il y a ${diffMins}m`;
                } else if (diffHours < 24) {
                    lastReadText = `vu il y a ${diffHours}h`;
                } else if (diffDays < 7) {
                    lastReadText = `vu il y a ${diffDays}j`;
                } else {
                    lastReadText = `vu le ${lastReadDate.toLocaleDateString('fr-FR')}`;
                }
                onlineStatus = `<span class="status-dot offline"></span><span>${lastReadText}</span>`;
            } else {
                onlineStatus = '<span class="status-dot offline"></span>Hors ligne';
            }


        }
    }else if (conversation.type === 'group') {
        


            const participantCount = conversation.participants ? conversation.participants.length : 0;
            conversationName = conversation.name ? `${conversation.name} (${participantCount})` : `Groupe (${participantCount})`;

        }
                
        // Avatar de la conversation - Générer via getGuestAvatarImage() selon sexe/nom
        let avatarHTML = '';
        if (otherParticipant) {

            const avatarUrl = getGuestAvatarImage(otherParticipant);
            if (avatarUrl) {
                // Avatar généré (homme.png, femme.png, couple.png, maman.png, etc.)
                avatarHTML = `<img src="${avatarUrl}" alt="${conversationName}" class="conversation-avatar-image">`;
            } else {
                // Fallback aux initiales si aucune détection
                const initials = (otherParticipant.name || otherParticipant.email || 'U').charAt(0).toUpperCase();
                avatarHTML = `<span class="conversation-avatar-text">${initials}</span>`;
            }
        } else {
            const avatarText = conversationName.charAt(0).toUpperCase();
            avatarHTML = `<span class="conversation-avatar-text">${avatarText}</span>`;
        }

        let statusIcon = '';
        let isOutgoing = lastMessage?.senderId === currentUser?.id;
        let isRead = lastMessage?.readBy && lastMessage.readBy.length > 0;

    if (isOutgoing) {
        if (isRead) {
            statusIcon = '<i class="fas fa-check-double status-icon read" title="Message lu"></i>';
        } else if (lastMessage?.delivered) {
           
            statusIcon = '<i class="fas fa-check status-icon delivered" title="Message délivré"></i>';
        } else {
            statusIcon = '<i class="fas fa-check status-icon sent" title="Message envoyé"></i>';
        }
    }
        
        return `
            <div class="conversation-item ${isActive ? 'active' : ''}" 
                 data-conversation-id="${conversation.id}"
                 data-type="${conversation.type}">
                <div class="conversation-avatar">
                    ${avatarHTML}
                    ${conversation.type === 'direct' && otherParticipant?.isOnline ? '<div class="conversation-status online"></div>' : conversation.type === 'direct' ? '<div class="conversation-status"></div>' : ''}
                </div>
                <div class="conversation-details">
                    <div class="conversation-header">
                        <div class="conversation-name">${escapeHtml(conversationName)}</div>
                        <div class="conversation-time-status">
                            <div class="conversation-time">${timeText}</div>
                            ${lastMessage?.senderId === currentUser?.id ? 
                                `<span class="message-status status-icon ${lastMessage?.readBy && lastMessage.readBy.length > 0 ? 'read' : lastMessage?.delivered ? 'delivered' : 'sent'}">
                                    ${statusIcon}
                                </span>` : ''}
                        </div>
                    </div>
                    

                    <div class="conversation-header">
                    <div class="conversation-preview">${escapeHtml(previewText || 'Envoyez un message')}</div>
                    ${onlineStatus ? `<div class="conversation-status-text">${onlineStatus}</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    // Ajouter les écouteurs d'événements aux éléments de conversation
    container.querySelectorAll('.conversation-item').forEach(item => {
        item.addEventListener('click', () => {
            const conversationId = item.getAttribute('data-conversation-id');
            selectConversation(conversationId);
        });
    });
}

async function selectConversationWithUser(conversationId){
    closeConversationPanel();
    await selectConversation(conversationId);
}

// Sélectionner une conversation
async function selectConversation(conversationId) {
    try {
        currentCallState = null;
        callStartTime = null;
        
        const audioCallState = document.getElementById('audioCallState');
        const videoCallState = document.getElementById('videoCallState');
        if (audioCallState) audioCallState.style.display = 'none';
        if (videoCallState) videoCallState.style.display = 'none';
        
        const toggles = document.querySelectorAll('.call-action-btn');
        toggles.forEach(btn => btn.classList.remove('active'));
        
        if (window.innerWidth <= 768) {
            const conversationsPanel = document.getElementById('conversationsPanel');
            const chatMain = document.getElementById('chatMain');
            
            if (conversationsPanel) {
                conversationsPanel.classList.remove('visible');
                conversationsPanel.classList.add('hidden');
            }
            
            // Afficher le chat avec transition
            if (chatMain) {
                chatMain.classList.add('active');
                chatMain.classList.remove('hidden');
            }
        }
        
        // Réinitialiser la pagination des messages
        messagePage = 1;
        messages = [];
        
        // Mettre à jour la conversation actuelle
        currentConversationId = conversationId;
        currentConversation = conversations.find(c => c.id === conversationId);
        
        if (!currentConversation) {
            throw new Error('Conversation non trouvée');
        }
        
        // 🔌 Rejoindre la salle WebSocket pour cette conversation
        if (chatSocket && chatSocket.connected) {
            joinConversationViaWebSocket(conversationId);
            console.log(`✅ WebSocket: Rejoint la conversation active ${conversationId}`);
        }
        
        // Mettre à jour l'interface
        updateChatHeader();
        showChatArea();
        
        // Charger les messages
        await loadMessages(conversationId);
        
        // Marquer comme lu
        await markConversationAsRead(conversationId);
        
        // Mettre à jour la liste des conversations
        renderConversationsList(conversations);
        
        // Focaliser sur le champ de saisie
        setTimeout(() => {
            document.getElementById('messageInput').focus();
        }, 100);
        
    } catch (error) {
        console.error('Erreur lors de la sélection de la conversation:', error);
        showToast('Impossible de charger la conversation', 'error');
    }
}

// Mettre à jour l'en-tête du chat
function updateChatHeader() {
    if (!currentConversation) return;
    
    const chatHeader = document.getElementById('chatHeader');
    const chatTitle = document.getElementById('chatTitle');
    const chatAvatar = document.getElementById('chatAvatar');
    const chatStatus = document.getElementById('statusText');
    
    if (!chatHeader || !chatTitle || !chatAvatar) return;
    
    // Afficher l'en-tête
    chatHeader.style.display = 'flex';
    
    // Mettre à jour le titre
    let conversationName = currentConversation.name || 'Chat';
    if (currentConversation.type === 'direct' && currentConversation.participants) {
        const otherParticipants = currentConversation.participants.filter(p => p.userId !== currentUser?.id);
        if (otherParticipants.length > 0) {
            const firstParticipant = otherParticipants[0];
            conversationName = firstParticipant.name || firstParticipant.email || 'Utilisateur';
        }
    }
    
    chatTitle.textContent = conversationName;
    
    // Mettre à jour l'avatar - Utiliser getGuestAvatarImage pour générer selon sexe/nom
    if (currentConversation.type === 'direct' && currentConversation.participants) {
        const otherParticipants = currentConversation.participants.filter(p => p.userId !== currentUser?.id);
        if (otherParticipants.length > 0) {
            const firstParticipant = otherParticipants[0];
            const avatarUrl = getGuestAvatarImage(firstParticipant);
            if (avatarUrl) {
                chatAvatar.innerHTML = `<img src="${avatarUrl}" alt="${conversationName}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                // Fallback aux initiales
                const avatarText = conversationName.charAt(0).toUpperCase();
                chatAvatar.innerHTML = avatarText;
            }
        }
    } else {
        // Chat de groupe : première lettre du nom
        const avatarText = conversationName.charAt(0).toUpperCase();
        chatAvatar.innerHTML = avatarText;
    }
    
    // Mettre à jour le statut de présence
    if (currentConversation.type === 'direct' && currentConversation.participants) {
        const otherParticipants = currentConversation.participants.filter(p => p.userId !== currentUser?.id);
        if (otherParticipants.length > 0) {
            const participant = otherParticipants[0];
            
            // Afficher le statut de présence
            if (participant.isOnline) {
                chatStatus.innerHTML = '<span class="status-dot connection-status-indicator online"></span>En ligne';
            } else if (participant.lastReadAt) {
                const lastReadDate = new Date(participant.lastReadAt);
                const now = new Date();
                const diffMs = now - lastReadDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);
                
                let lastReadText;
                if (diffMins < 1) {
                    lastReadText = 'vu à l\'instant';
                } else if (diffMins < 60) {
                    lastReadText = `vu il y a ${diffMins}m`;
                } else if (diffHours < 24) {
                    lastReadText = `vu il y a ${diffHours}h`;
                } else if (diffDays < 7) {
                    lastReadText = `vu il y a ${diffDays}j`;
                } else {
                    lastReadText = `vu le ${lastReadDate.toLocaleDateString('fr-FR')}`;
                }
                chatStatus.innerHTML = `<span class="status-dot offline"></span><span>${lastReadText}</span>`;
            } else {
                chatStatus.innerHTML = '<span class="status-dot offline"></span>Hors ligne';
            }
        }
    } else {
        const participantCount = currentConversation.participants?.length || 0;
        chatStatus.textContent = `${participantCount} participant${participantCount > 1 ? 's' : ''}`;
    }
}

// Afficher la zone de chat
function showChatArea() {
    // Masquer "aucune conversation sélectionnée"
    const noConversationSelected = document.getElementById('noConversationSelected');
    if (noConversationSelected) {
        noConversationSelected.style.display = 'none';
    }
    
    // Afficher la zone de chat (noMessagesState s'affichera/masquera dans renderMessages)
    document.getElementById('chatInputArea').style.display = 'flex';
    document.getElementById('messagesContainer').style.display = 'flex';
    
    // Sur mobile: afficher le chat et masquer le panel conversations avec transition
    if (window.innerWidth <= 768) {
        const chatMain = document.getElementById('chatMain');
        const conversationsPanel = document.getElementById('conversationsPanel');
        
        if (chatMain) {
            chatMain.classList.add('active');
            chatMain.classList.remove('hidden');
        }
        
        if (conversationsPanel) {
            conversationsPanel.classList.remove('visible');
            conversationsPanel.classList.add('hidden');
        }
    } else {
        // Sur grand écran: s'assurer que les deux sont visibles
        const chatMain = document.getElementById('chatMain');
        const conversationsPanel = document.getElementById('conversationsPanel');
        if (chatMain) {
            chatMain.classList.remove('hidden', 'active');
        }
        if (conversationsPanel) {
            conversationsPanel.classList.remove('visible', 'hidden');
        }
    }
}

// Masquer la zone de chat et afficher "aucune conversation sélectionnée"
function hideChatArea() {
    // ✅ Vider le wrapper des messages
    const messagesWrapper = document.getElementById('messagesWrapper');
    if (messagesWrapper) {
        messagesWrapper.innerHTML = '';
    }
    
    // Afficher "aucune conversation sélectionnée"
    const noConversationSelected = document.getElementById('noConversationSelected');
    if (noConversationSelected) {
        noConversationSelected.style.display = 'flex';
    }
    
    // Masquer la zone de chat
    const chatInputArea = document.getElementById('chatInputArea');
    const chatHeader = document.getElementById('chatHeader');
    const messagesContainer = document.getElementById('messagesContainer');
    
    if (chatInputArea) {
        chatInputArea.style.display = 'none';
    }
    if (chatHeader) {
        chatHeader.style.display = 'none';
    }

    
    // ✅ Masquer le placeholder de messages vides
    const noMessagesState = document.getElementById('noMessagesState');
    if (noMessagesState) {
        noMessagesState.style.display = 'none';
    }
    
    // Sur mobile: afficher le panel conversations
    if (window.innerWidth <= 768) {
        const conversationsPanel = document.getElementById('conversationsPanel');
        const chatMain = document.getElementById('chatMain');
        
        if (conversationsPanel) {
            conversationsPanel.classList.add('visible');
            conversationsPanel.classList.remove('hidden');
        }
        
        if (chatMain) {
            chatMain.classList.remove('active');
            chatMain.classList.add('hidden');
        }
    }
}

// Charger les messages
async function loadMessages(conversationId, loadMore = false) {
    try {
        if (!loadMore) {
            showLoader('messages');
        } else {
            showLoadMoreMessagesIndicator();
        }
        
        // Utiliser la méthode du storage pour récupérer les messages
        const result = await window.storage.getMessages(conversationId, {
            limit: messagesPerPage,
            offset: loadMore ? (messagePage - 1) * messagesPerPage : 0
        });
        
        if (result && Array.isArray(result)) {
            if (loadMore) {
                // Ajouter les anciens messages au début
                messages = [...result, ...messages];
            } else {
                messages = result;
            }
            
            renderMessages(messages, loadMore);
            
            if (loadMore) {
                messagePage++;
            }
        } else {
            messages = [];
            renderMessages([], loadMore);
        }
        
        if (loadMore) {
            hideLoadMoreMessagesIndicator();
        } else {
            hideLoader('messages');
        }
        
        // Faire défiler vers le bas si ce n'est pas un chargement de plus de messages
        if (!loadMore) {
            setTimeout(() => {
                scrollToBottom();
            }, 100);
        }
        
        return messages;
    } catch (error) {
        console.error('Erreur lors du chargement des messages:', error);
        
        if (loadMore) {
            hideLoadMoreMessagesIndicator();
        } else {
            hideLoader('messages');
        }
        
        return [];
    }
}

// Rendre les messages
function renderMessages(messagesList, loadMore = false) {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // Vérification de sécurité
    if (!Array.isArray(messagesList)) {
        console.warn('⚠️ renderMessages: messagesList n\'est pas un array', messagesList);
        messagesList = [];
    }
    
    // Récupérer ou créer le conteneur des messages (séparé des placeholders)
    let messagesWrapper = document.getElementById('messagesWrapper');
    if (!messagesWrapper) {
        messagesWrapper = document.createElement('div');
        messagesWrapper.id = 'messagesWrapper';
        messagesWrapper.style.display = 'flex';
        messagesWrapper.style.flexDirection = 'column';
        messagesWrapper.style.flex = '1';
        messagesWrapper.style.overflowY = 'auto';
        messagesWrapper.style.paddingBottom = '20px';
        container.appendChild(messagesWrapper);
    }
    
    // Grouper les messages par date
    const groupedMessages = groupMessagesByDate(messagesList);
    
    // Générer le HTML des messages
    let messagesHTML = '';
    
    // Si c'est un chargement de plus de messages, nous ajoutons au début
    if (loadMore) {
        const existingMessages = messagesWrapper.querySelectorAll('.message-wrapper, .message-date-group');
        const existingHTML = Array.from(existingMessages).map(el => el.outerHTML).join('');
        
        messagesHTML = renderGroupedMessages(groupedMessages) + existingHTML;
    } else {
        messagesHTML = renderGroupedMessages(groupedMessages);
        
        // Si aucun message
        if (messagesList.length === 0) {
            messagesHTML = ``;
            // Afficher le placeholder avec l'avatar de la personne
            const noMessagesElement = document.getElementById('noMessagesState');
            if (noMessagesElement) {
                noMessagesElement.style.display = 'flex';
                
                // Remplir l'avatar du placeholder avec l'avatar réel
                if (currentConversation?.type === 'direct' && currentConversation?.participants) {
                    const otherParticipants = currentConversation.participants.filter(p => p.userId !== currentUser?.id);
                    if (otherParticipants.length > 0) {
                        const participant = otherParticipants[0];
                        const emptyAvatar = document.getElementById('emptyStateAvatar');
                        if (emptyAvatar) {
                            const avatarUrl = getGuestAvatarImage(participant);
                            if (avatarUrl) {
                                emptyAvatar.innerHTML = `<img src="${avatarUrl}" alt="${participant.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                            } else {
                                // Fallback initiales
                                const initials = (participant.name || 'U').charAt(0).toUpperCase();
                                emptyAvatar.innerHTML = initials;
                            }
                        }
                    }
                }
            }
        } else {
            // Cacher le placeholder
            const noMessagesElement = document.getElementById('noMessagesState');
            if (noMessagesElement) {
                noMessagesElement.style.display = 'none';
            }
        }
    }
    
    messagesWrapper.innerHTML = messagesHTML;
    
    attachMessageEventListeners();
    
    // Si c'est un chargement de plus de messages, ajuster la position de défilement
    if (loadMore) {
        setTimeout(() => {
            const firstNewMessage = messagesWrapper.querySelector('.message-wrapper');
            if (firstNewMessage) {
                firstNewMessage.scrollIntoView({ behavior: 'auto' });
            }
        }, 50);
    }
}

// Grouper les messages par date
function groupMessagesByDate(messages) {
    const groups = {};
    
    // Vérification de sécurité - si messages n'est pas un array, retourner un objet vide
    if (!Array.isArray(messages)) {
        console.warn('⚠️ groupMessagesByDate: messages n\'est pas un array', messages);
        return groups;
    }
    
    messages.forEach(message => {
        if (!message || !message.createdAt) return;
        
        const messageDate = new Date(message.createdAt);
        const dateKey = messageDate.toDateString();
        
        if (!groups[dateKey]) {
            groups[dateKey] = [];
        }
        
        groups[dateKey].push(message);
    });
    
    return groups;
}

// Rendre les messages groupés
function renderGroupedMessages(groupedMessages) {
    let html = '';
    
    Object.keys(groupedMessages).forEach(dateKey => {
        const messages = groupedMessages[dateKey];
        const date = new Date(dateKey);
        
        // Formater la date
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        let dateText = '';
        if (date.toDateString() === today.toDateString()) {
            dateText = 'Aujourd\'hui';
        } else if (date.toDateString() === yesterday.toDateString()) {
            dateText = 'Hier';
        } else {
            dateText = date.toLocaleDateString('fr-FR', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
        }
        
        html += `<div class="message-date-group">
                    <span class="date-separator">${dateText}</span>
                 </div>`;
        
        messages.forEach(message => {
            html += renderSingleMessage(message);
        });
    });
    
    return html;
}

// Rendre un seul message
function renderSingleMessage(message) {
    const isOutgoing = message.senderId === currentUser?.id;
    const messageDate = new Date(message.createdAt);
    const timeText = messageDate.toLocaleTimeString('fr-FR', {
        hour: '2-digit',
        minute: '2-digit'
    });
    
    // Récupérer les infos de l'expéditeur
    let sender = null;
    let senderName = 'Inconnu';
    if (currentConversation?.participants) {
        sender = currentConversation.participants.find(p => p.userId === message.senderId);
        if (sender) {
            senderName = sender.name || sender.email || 'Utilisateur';
        }
    }
    
    const isRead = message.readBy && message.readBy.length > 0;
    
    // Avatar de l'expéditeur avec getGuestAvatarImage() si disponible
    let avatarHTML = '';
    if (sender) {
        const avatarUrl = getGuestAvatarImage(sender);
        if (avatarUrl) {
            avatarHTML = `<img src="${avatarUrl}" alt="${senderName}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
        } else {
            const initials = senderName.charAt(0).toUpperCase();
            avatarHTML = initials;
        }
    } else {
        const avatarText = senderName.charAt(0).toUpperCase();
        avatarHTML = avatarText;
    }
    
    // Contenu du message en fonction du type
    let messageContent = '';
    
    switch (message.type) {
        case 'text':
            messageContent = `
                <div class="message-text">${escapeHtml(message.content || '')}</div>
            `;
            break;
            
        case 'image':
            messageContent = `
                <div class="message-image">
                    <img src="${message.content}" alt="Image" onerror="this.src='https://via.placeholder.com/300?text=Image+non+disponible'">
                </div>
                ${message.caption ? `<div class="message-text">${escapeHtml(message.caption)}</div>` : ''}
            `;
            break;
            
        case 'file':
            const fileName = message.content.split('/').pop() || 'Fichier';
            const fileSize = message.fileSize ? formatFileSize(message.fileSize) : '';
            
            messageContent = `
                <div class="message-file">
                    <div class="file-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${escapeHtml(fileName)}</div>
                        ${fileSize ? `<div class="file-size">${fileSize}</div>` : ''}
                    </div>
                    <a href="${message.content}" class="download-btn" download>
                        <i class="fas fa-download"></i>
                    </a>
                </div>
            `;
            break;
            
        default:
            messageContent = `
                <div class="message-text">${escapeHtml(message.content || '')}</div>
            `;
    }
    
    // Réponse à un message
    let replySection = '';
    if (message.replyTo) {
        const repliedMessage = messages.find(m => m.id === message.replyTo);
        if (repliedMessage) {
            const repliedSender = currentConversation?.participants?.find(p => p.userId === repliedMessage.senderId);
            const repliedSenderName = repliedSender?.name || repliedSender?.email || 'Utilisateur';
            const repliedContent = repliedMessage.content || '';
            
            replySection = `
                <div class="message-replied">
                    <div class="replied-sender">${escapeHtml(repliedSenderName)}</div>
                    <div class="replied-content">${escapeHtml(repliedContent.length > 100 ? repliedContent.substring(0, 100) + '...' : repliedContent)}</div>
                </div>
            `;
        }
    }
    
    // Réactions
    let reactionsSection = '';
    if (message.reactions && Object.keys(message.reactions).length > 0) {
        // Vérifier si l'utilisateur a déjà réagi à au moins une réaction
        const userHasReacted = Object.values(message.reactions).some(users => 
            users.includes(currentUser.id)
        );
        
        const reactionsHTML = Object.entries(message.reactions)
            .map(([emoji, users]) => {
                const count = Array.isArray(users) ? users.length : 1;
                const hasReacted = users.includes(currentUser.id);
                const title = hasReacted ? `Cliquez pour retirer votre réaction` : `Cliquez pour ajouter votre réaction`;
                
                return `
                    <button class="reaction-item ${hasReacted ? 'user-reacted' : ''}" 
                            onclick="toggleReaction('${message.id}', '${emoji}')"
                            title="${title}">
                        <span class="reaction-emoji">${emoji}</span>
                      ${currentConversation.type !== 'direct' ?  `<span class="reaction-count">${count}</span>` : ''}
                    </button>
                `;
            })
            .join('');
        
        // N'afficher le bouton add QUE si l'utilisateur n'a pas déjà réagi
        const addButtonHTML = userHasReacted ? '' : `
            <button class="add-reaction-btn" onclick="const msgId='${message.id}'; toggleEmojiPicker(msgId)" title="Ajouter réaction">
                <span>❤️</span>
            </button>
        `;
        
        reactionsSection = `
            <div class="message-reactions">
                ${reactionsHTML}
                ${addButtonHTML}
            </div>
        `;
    } else {
        reactionsSection = `
            <div class="message-reactions">
                <button class="add-reaction-btn" onclick="const msgId='${message.id}'; toggleEmojiPicker(msgId)" title="Ajouter réaction">
                    <span>❤️</span>
                </button>
            </div>
        `;
    }
    
    let statusIcon = '';
    if (isOutgoing) {
        if (isRead) {
            statusIcon = '<i class="fas fa-check-double status-icon read" title="Message lu"></i>';
        } else if (message.delivered) {
           
            statusIcon = '<i class="fas fa-check-double status-icon delivered" title="Message délivré"></i>';
        } else {
            statusIcon = '<i class="fas fa-check status-icon sent" title="Message envoyé"></i>';
        }
    }
    
    // Dropdown actions pour le message
    let actionsDropdown = '';
    let emojiPicker = '';
    
    // Le picker emoji est toujours accessible (au survol)
    const emojis = ['👍', '❤️', '😂', '😮', '😢', '🔥', '👏'];
    const emojiPickerButtons = emojis.map(emoji => 
        `<button class="emoji-reaction-btn" onclick="addReaction('${message.id}', '${emoji}')" title="Réaction">${emoji}</button>`
    ).join('');
    
    emojiPicker = `
        <div class="emoji-reactions-picker" id="emoji-picker-${message.id}">
            ${emojiPickerButtons}
        </div>
    `;
    
    if (isOutgoing) {
        actionsDropdown = `
            <div class="message-actions-dropdown" style="position: absolute; top: 0; right: 0;">
                <button class="btn-message-actions" onclick="const msgId='${message.id}'; toggleMessageActions(event, msgId)" title="Autres actions">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="message-actions-menu " id="actions-${message.id}">
                    <button onclick="let msgId='${message.id}'; replyToMessage(msgId)">
                        <i class="fas fa-reply"></i> Répondre
                    </button>
                    <button onclick="let msgId='${message.id}'; toggleEmojiPicker(msgId)">
                        <i class="fas fa-smile"></i> Réagir
                    </button>
                    <button onclick="let msgId='${message.id}'; copyMessageContent(msgId)">
                        <i class="fas fa-copy"></i> Copier
                    </button>
                    <button onclick="let msgId='${message.id}'; forwardMessageContent(msgId)">
                        <i class="fas fa-share"></i> Transférer
                    </button>
                    <button onclick="editMessage('${message.id}')">
                        <i class="fas fa-edit"></i> Éditer
                    </button>
                    <button class="danger" onclick="deleteMessage('${message.id}')">
                        <i class="fas fa-trash"></i> Supprimer
                    </button>
                </div>
            </div>
            ${emojiPicker}
        `;
    }
    
    return `
        <div class="message-wrapper ${isOutgoing ? 'outgoing' : 'incoming'}" 
             data-message-id="${message.id}"
             data-sender-id="${message.senderId}">
            
            ${!isOutgoing ? `
                <div class="message-avatar">
                    ${avatarHTML}
                </div>
            ` : ''}
            
            <div class="message-content">
                ${!isOutgoing ? `<div class="conversation-meta sender-name">${escapeHtml(senderName)}</div>` : ''}
                
                ${replySection}
                ${messageContent}
                
                <div class="message-footer">
                    <div class="conversation-meta message-time">${timeText}</div>
                    ${statusIcon ? `<div class="message-status-icons">${statusIcon}</div>` : ''}
                    ${actionsDropdown}
                </div>
                
                ${reactionsSection}
            </div>
            
            ${isOutgoing ? `
                <div class="message-avatar">
                    ${avatarHTML}
                </div>
            ` : ''}
        </div>
    `;
}

// Formater la taille du fichier
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Faire défiler vers le bas
function scrollToBottom() {
    const messagesWrapper = document.getElementById('messagesWrapper');
    if (messagesWrapper) {
        messagesWrapper.scrollTop = messagesWrapper.scrollHeight;
    }
}

// Configurer la saisie du message
function setupMessageInput() {
    const messageInput = document.getElementById('messageInput');
    if (!messageInput) return;
    
    // Ajuster automatiquement la hauteur
    messageInput.addEventListener('input', function() {
        adjustTextareaHeight(this);
    });
    
    // Détecter la saisie pour l'indicateur d'écriture
    let typingTimeout;
    messageInput.addEventListener('input', function() {
        if (!currentConversationId) return;
        
        emitTypingEvent();

        clearTimeout(typingTimeout);
        
        // Définir un nouveau timeout pour arrêter l'indicateur d'écriture
        typingTimeout = setTimeout(() => {
            emitStopTypingEvent();
        }, 1000);
    });
}

// Ajuster la hauteur du textarea
function adjustTextareaHeight(textarea) {
    textarea.style.height = 'auto';
    const newHeight = Math.min(textarea.scrollHeight, 120);
    textarea.style.height = newHeight + 'px';
    
    // Activer/désactiver le bouton d'envoi
    const sendBtn = document.getElementById('sendBtn');
    if (sendBtn) {
        sendBtn.disabled = textarea.value.trim().length === 0;
    }
}

// Gérer les touches du clavier pour l'envoi
function handleMessageInputKeydown(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
}

// Envoyer un message
async function sendMessage() {
    try {
        const messageInput = document.getElementById('messageInput');
        const messageText = messageInput.value.trim();
        
        if (!messageText || !currentConversationId) return;
        
        // Récupérer l'ID du message auquel répondre (s'il existe)
        const replyToId = messageInput.dataset.replyToId || null;
        
        // Désactiver le champ pendant l'envoi
        messageInput.disabled = true;
        const sendBtn = document.getElementById('sendBtn');
        sendBtn.disabled = true;
        
        // Créer l'objet message temporaire pour l'UI
        const tempMessageId = 'msg_temp_' + Date.now();
        const tempMessage = {
            id: tempMessageId,
            conversationId: currentConversationId,
            content: messageText,
            type: 'text',
            replyTo: replyToId,
            senderId: currentUser?.id,
            senderName: currentUser ? `${currentUser.firstName} ${currentUser.lastName}` : 'Anonyme',
            createdAt: new Date().toISOString(),
            delivered: false,
            readBy: []
        };
        
        // 1️⃣ Afficher immédiatement le message temporaire dans l'UI
        if (!Array.isArray(messages)) {
            messages = [];
        }
        messages.push(tempMessage);
        renderMessages(messages);
        scrollToBottom();
        
        console.log('📤 Envoi du message via HTTP/REST...', { replyToId, messageText });
        const result = await window.storage.sendMessage(currentConversationId, messageText, {
            replyTo: replyToId
        });
        
        if (result && result.id) {
            
            const messageIndex = messages.findIndex(m => m.id === tempMessageId);
            if (messageIndex !== -1) {
                messages.splice(messageIndex, 1);
            }
            
            
            if (chatSocket && chatSocket.connected) {
                console.log('📡 Émission via WebSocket...');
                sendMessageViaWebSocket(currentConversationId, messageText);
            } else {
                console.warn('⚠️ WebSocket non connecté, affichage immédiat du message');
                messages.push({
                    id: result.id,
                    conversationId: currentConversationId,
                    senderId: currentUser?.id,
                    content: messageText,
                    replyTo: replyToId,
                    createdAt: result.createdAt || new Date().toISOString(),
                    type: 'text',
                    delivered: true,
                    readBy: [],
                    reactions: {}
                });
                renderMessages(messages);
                scrollToBottom();
            }
            
            SECURA_AUDIO.play('notification');
            
        } else {
            // ❌ Erreur d'enregistrement - afficher un message d'erreur
            console.error('❌ Échec de l\'enregistrement du message');
            showToast('Impossible d\'envoyer le message', 'error');
            
            // Retirer le message temporaire
            const messageIndex = messages.findIndex(m => m.id === tempMessageId);
            if (messageIndex !== -1) {
                messages.splice(messageIndex, 1);
                renderMessages(messages);
            }
        }
        
    } catch (error) {
        console.error('❌ Erreur lors de l\'envoi du message:', error);
        showToast('Impossible d\'envoyer le message', 'error');
        
        // Essayer de retirer le message temporaire en cas d'erreur
        if (messages && Array.isArray(messages)) {
            const tempIndex = messages.findIndex(m => m.id?.startsWith('msg_temp_'));
            if (tempIndex !== -1) {
                messages.splice(tempIndex, 1);
                renderMessages(messages);
            }
        }
    } finally {
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        
        if (messageInput) {
            messageInput.disabled = false;
            messageInput.value = '';
            messageInput.style.height = 'auto';
        }
        
        if (sendBtn) {
            sendBtn.disabled = messageInput.value.trim().length === 0;
        }
        
        messageInput.focus();
        
        // Réinitialiser la réponse
        cancelReply();
    }
}

// Émettre l'événement de saisie
function emitTypingEvent() {
    if (chatSocket && chatSocket.connected && currentConversationId) {
        notifyTyping(currentConversationId);
    }
}

// Émettre l'événement d'arrêt de saisie
function emitStopTypingEvent() {
    // Utiliser WebSocket si disponible
    if (chatSocket && chatSocket.connected && currentConversationId) {
        notifyStopTyping(currentConversationId);
    }
}

// Marquer une conversation comme lue
async function markConversationAsRead(conversationId) {
    try {
        await window.storage.markAsRead(conversationId);
        
        // Mettre à jour localement
        const conversation = conversations.find(c => c.id === conversationId);
        if (conversation) {
            conversation.unreadCount = 0;
        }
    } catch (error) {
        console.error('Erreur lors du marquage comme lu:', error);
    }
}

// ==========================================
// GESTION DES PIÈCES JOINTES
// ==========================================

// Configurer le drag and drop
function setupDragAndDrop() {
    const uploadZone = document.getElementById('uploadZone');
    if (!uploadZone) return;
    
    // Événements pour le drag and drop
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('drag-over');
    });
    
    uploadZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('drag-over');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelection({ target: { files } });
        }
    });
    
    uploadZone.addEventListener('click', () => {
        document.getElementById('fileInput').click();
    });
}

// Gérer la sélection de fichier
function handleFileSelection(e) {
    const file = e.target.files?.[0] || e.files?.[0];
    if (!file) return;
    
    selectedFile = file;
    showFilePreview(file);
}

// Gérer la sélection d'image
function handleImageSelection(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    
    // Vérifier que c'est bien une image
    if (!file.type.startsWith('image/')) {
        showToast('Veuillez sélectionner une image', 'error');
        return;
    }
    
    selectedFile = file;
    uploadFile(file, 'image');
}

// Afficher l'aperçu du fichier
function showFilePreview(file) {
    const previewContainer = document.getElementById('filePreview');
    const previewContent = document.getElementById('previewContent');
    
    if (!previewContainer || !previewContent) return;
    
    // Afficher le conteneur d'aperçu
    previewContainer.style.display = 'block';
    
    // Déterminer l'icône en fonction du type de fichier
    let fileIcon = 'fa-file';
    if (file.type.startsWith('image/')) fileIcon = 'fa-image';
    else if (file.type.includes('pdf')) fileIcon = 'fa-file-pdf';
    else if (file.type.includes('word')) fileIcon = 'fa-file-word';
    else if (file.type.includes('excel')) fileIcon = 'fa-file-excel';
    else if (file.type.includes('zip')) fileIcon = 'fa-file-archive';
    
    // Afficher l'aperçu
    previewContent.innerHTML = `
        <div class="preview-icon">
            <i class="fas ${fileIcon}"></i>
        </div>
        <div class="preview-info">
            <div class="preview-name">${escapeHtml(file.name)}</div>
            <div class="preview-size">${formatFileSize(file.size)}</div>
        </div>
    `;
    
    // Activer le bouton de confirmation
    document.getElementById('confirmUploadBtn').disabled = false;
    
    // Afficher le modal
    document.getElementById('fileUploadModal').classList.add('active');
}

// Effacer l'aperçu du fichier
function clearFilePreview() {
    selectedFile = null;
    
    const previewContainer = document.getElementById('filePreview');
    const fileInput = document.getElementById('fileInput');
    
    if (previewContainer) previewContainer.style.display = 'none';
    if (fileInput) fileInput.value = '';
    
    document.getElementById('confirmUploadBtn').disabled = true;
}

// Fermer le modal d'upload
function closeFileUploadModal() {
    document.getElementById('fileUploadModal').classList.remove('active');
    clearFilePreview();
}

// Uploader un fichier
async function uploadFile(file, type = 'file') {
    try {
        if (!file || !currentConversationId) return;
        
        // Afficher la progression
        const progressBar = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadProgress = document.getElementById('uploadProgress');
        
        if (uploadProgress) uploadProgress.style.display = 'block';
        if (progressBar) progressBar.style.width = '0%';
        if (progressText) progressText.textContent = '0%';
        
        // Simuler la progression (dans une vraie implémentation, utiliser XMLHttpRequest avec événements de progression)
        simulateUploadProgress(progressBar, progressText, async () => {
            try {
                let result;
                
                if (type === 'image') {
                    // Uploader l'image
                    result = await window.storage.uploadFile(file, 'gallery', {
                        userId: currentUser?.id,
                        conversationId: currentConversationId
                    });
                } else {
                    // Uploader le fichier générique
                    result = await window.storage.uploadFile(file, 'chat', {
                        userId: currentUser?.id,
                        conversationId: currentConversationId
                    });
                }
                
                if (result) {
                    // Créer le message avec le fichier
                    const message = {
                        conversationId: currentConversationId,
                        content: result.url || result.path,
                        type: type === 'image' ? 'image' : 'file',
                        fileSize: file.size,
                        fileName: file.name
                    };
                    
                    // Envoyer le message via l'API
                    const messageResult = await window.storage.sendMessage(currentConversationId, 
                        type === 'image' ? '📷 Image' : '📎 ' + file.name);
                    
                    if (messageResult) {
                        // Ajouter le message à la liste locale
                        messages.push({
                            ...messageResult,
                            content: result.url || result.path,
                            type: type === 'image' ? 'image' : 'file',
                            fileSize: file.size,
                            fileName: file.name
                        });
                        
                        // Rendre les messages
                        renderMessages(messages);
                        
                        // Faire défiler vers le bas
                        setTimeout(scrollToBottom, 100);
                        
                        // Fermer le modal
                        closeFileUploadModal();
                        
                        // Émettre un son
                        SECURA_AUDIO.play('message_sent');
                        
                        showToast('Fichier envoyé avec succès', 'success');
                    }
                }
            } catch (error) {
                console.error('Erreur lors de l\'upload:', error);
                showToast('Erreur lors de l\'envoi du fichier', 'error');
            }
        });
        
    } catch (error) {
        console.error('Erreur lors de l\'upload:', error);
        showToast('Erreur lors de l\'envoi du fichier', 'error');
    }
}

// Simuler la progression de l'upload
function simulateUploadProgress(progressBar, progressText, callback) {
    let progress = 0;
    const interval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 100) progress = 100;
        
        if (progressBar) progressBar.style.width = progress + '%';
        if (progressText) progressText.textContent = Math.round(progress) + '%';
        
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(callback, 500);
        }
    }, 100);
}

// ==========================================
// GESTION DES RÉACTIONS ET RÉPONSES
// ==========================================

// Attacher les écouteurs d'événements aux messages
// ========================================
// GESTION DU SWIPE ET LONG-PRESS UNIFIÉE
// ========================================

let touchStartX = 0;
let touchStartY = 0;
let touchStartTime = 0;
let touchStartElement = null;
const SWIPE_THRESHOLD = 50;
const LONG_PRESS_DURATION = 500;

// Variables globales supplémentaires
let currentContextMessage = null;
let touchHoldTimeout = null;
let uploadInProgress = false;

function attachMessageEventListeners() {
    document.querySelectorAll('.message-wrapper').forEach(messageWrapper => {
        const messageContent = messageWrapper.querySelector('.message-content');
        
        if (!messageContent) return;
        
        // Longpress pour sélection et emoji picker - PASSIVE EVENT LISTENERS
        messageContent.addEventListener('touchstart', handleTouchStart, { passive: true });
        messageContent.addEventListener('touchmove', handleTouchMove, { passive: true });
        messageContent.addEventListener('touchend', handleTouchEnd, { passive: true });
        
        // Desktop: Right-click context menu
        messageContent.addEventListener('contextmenu', handleMessageContextMenu, false);
        
        // Swipe right pour répondre - PASSIVE EVENT LISTENERS
        messageWrapper.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].clientX;
            touchStartY = e.changedTouches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: true });
        
        messageWrapper.addEventListener('touchend', (e) => {
            const touchEndX = e.changedTouches[0].clientX;
            const touchEndY = e.changedTouches[0].clientY;
            const diffX = touchStartX - touchEndX;
            const diffY = Math.abs(touchStartY - touchEndY);
            
            // Swipe right pour répondre (glisser vers la droite)
            if (diffX < -SWIPE_THRESHOLD && diffY < 50) {
                const messageId = messageWrapper.dataset.messageId;
                if (messageId) {
                    const message = messages.find(m => m.id === messageId);
                    if (message) {
                        replyToMessage(message);
                    }
                }
            }
        }, { passive: true });
    });
}

// Touch handlers
function handleTouchStart(e) {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    touchStartTime = Date.now();
    touchStartElement = e.target.closest('.message-wrapper');
}

function handleTouchMove(e) {
    // Peut être utilisé pour preview du swipe
}

function handleTouchEnd(e) {
    const touchEndTime = Date.now();
    const duration = touchEndTime - touchStartTime;
    
    // Long press (> 500ms sans mouvement significatif)
    if (duration > LONG_PRESS_DURATION && touchStartElement) {
        const messageWrapper = e.target.closest('.message-wrapper');
        if (messageWrapper) {
            const messageId = messageWrapper.dataset.messageId;
            
            if (messageId) {
                const message = messages.find(m => m.id === messageId);
                if (message) {
                    // Show context menu or emoji picker
                    const touch = e.changedTouches[0];
                    showMessageContextMenu(touch.clientX, touch.clientY, message);
                }
            }
        }
    }
    
    touchStartElement = null;
}

// Context menu handler (desktop)
function handleMessageContextMenu(e) {
    e.preventDefault();
    
    const messageWrapper = e.target.closest('.message-wrapper');
    if (!messageWrapper) return;
    
    const messageId = messageWrapper.getAttribute('data-message-id') || messageWrapper.dataset.messageId;
    if (!messageId) return;
    
    const message = messages.find(m => m.id === messageId);
    if (!message) return;
    
    // Afficher le menu contextuel à la position de la souris
    showMessageContextMenu(e.clientX, e.clientY, message);
}

// Afficher le menu contextuel du message
function showMessageContextMenu(x, y, message) {
    const menu = document.getElementById('messageContextMenu');
    if (!menu) return;
    
    // Positionner le menu
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    menu.style.display = 'block';
    
    // Stocker le message actuel pour les actions
    currentContextMessage = message;
    
    // Ajouter les écouteurs d'événements aux boutons du menu
    const replyBtn = document.getElementById('replyMessageBtn');
    const reactBtn = document.getElementById('reactMessageBtn');
    const copyBtn = document.getElementById('copyMessageBtn');
    const forwardBtn = document.getElementById('forwardMessageBtn');
    const deleteBtn = document.getElementById('deleteMessageBtn');
    
    if (replyBtn) {
        replyBtn.onclick = () => {
            replyToMessage(message);
            hideMessageContextMenu();
        };
    }
    
    if (reactBtn) {
        reactBtn.onclick = () => {
            const messageId = message.id;
            const picker = document.getElementById(`emoji-picker-${messageId}`);
            if (picker) {
                picker.style.display = picker.style.display === 'flex' ? 'none' : 'flex';
                
                // Fermer les autres pickers
                document.querySelectorAll('.emoji-reactions-picker').forEach(p => {
                    if (p.id !== `emoji-picker-${messageId}`) {
                        p.style.display = 'none';
                    }
                });
            }
            hideMessageContextMenu();
        };
    }
    
    if (copyBtn) {
        copyBtn.onclick = () => {
            copyMessage(message);
            hideMessageContextMenu();
        };
    }
    
    if (forwardBtn) {
        forwardBtn.onclick = () => {
            forwardMessage(message);
            hideMessageContextMenu();
        };
    }
    
    if (deleteBtn) {
        deleteBtn.onclick = () => {
            deleteMessage(message);
            hideMessageContextMenu();
        };
    }
    
    // Masquer le menu en cliquant ailleurs
    setTimeout(() => {
        document.addEventListener('click', hideMessageContextMenuOutside, { once: true });
    }, 10);
}

// Masquer le menu contextuel en cliquant ailleurs
function hideMessageContextMenuOutside(e) {
    const menu = document.getElementById('messageContextMenu');
    if (menu && !menu.contains(e.target)) {
        hideMessageContextMenu();
    }
}

function hideMessageContextMenu() {
    const menu = document.getElementById('messageContextMenu');
    if (menu) {
        menu.style.display = 'none';
    }
    currentContextMessage = null;
}

// Répondre à un message
// ⚠️ DEPRECATED: Old modal-based reply system removed. Now using inline reply preview in message-input-container

// Fermer le modal de réponse
function closeReplyModal() {
    // ⚠️ DEPRECATED: Old modal system. Use cancelReply() instead
    cancelReply();
}

// Afficher le menu de réactions
function showReactionMenu(message) {
    reactingToMessage = message;
    
    const menu = document.getElementById('reactionModal');
    if (!menu) return;
    
    // Positionner le menu près du message
    const messageElement = document.querySelector(`[data-message-id="${message.id}"]`);
    if (!messageElement) return;
    
    const rect = messageElement.getBoundingClientRect();
    menu.style.left = (rect.left + rect.width / 2 - 100) + 'px';
    menu.style.top = (rect.top - 60) + 'px';
    menu.style.display = 'flex';
    
    // Ajouter les écouteurs d'événements
    document.querySelectorAll('.reaction-option').forEach(option => {
        option.onclick = () => {
            const reaction = option.getAttribute('data-reaction');
            addReaction(message, reaction);
            hideReactionMenu();
        };
    });
    
    // Masquer le menu en cliquant ailleurs
    setTimeout(() => {
        document.addEventListener('click', hideReactionMenuOutside, { once: true });
    }, 10);
}

// Masquer le menu de réactions en cliquant ailleurs
function hideReactionMenuOutside(e) {
    const menu = document.getElementById('reactionModal');
    if (menu && !menu.contains(e.target)) {
        hideReactionMenu();
    }
}

function hideReactionMenu() {
    const menu = document.getElementById('reactionModal');
    if (menu) {
        menu.style.display = 'none';
    }
    reactingToMessage = null;
}

// Basculer une réaction (ajouter ou retirer)
function toggleReaction(messageId, emoji) {
    const message = messages.find(m => m.id === messageId);
    if (!message) return;
    
    // Vérifier si l'utilisateur a déjà mis cette réaction
    if (message.reactions && message.reactions[emoji] && message.reactions[emoji].includes(currentUser.id)) {
        // Retirer la réaction
        removeReaction(messageId, emoji);
    } else {
        // Ajouter la réaction
        addReaction(messageId, emoji);
    }
}

// Ajouter une réaction à un message
async function addReaction(messageId, emoji) {
    try {
        if (!messageId || !currentConversationId) return;
        
        // Trouver le message
        const message = messages.find(m => m.id === messageId);
        if (!message) return;
        
        // 1️⃣ Mettre à jour localement en premier pour l'UI optimiste
        if (!message.reactions) {
            message.reactions = {};
        }
        
        if (!message.reactions[emoji]) {
            message.reactions[emoji] = [];
        }
        
        if (!message.reactions[emoji].includes(currentUser.id)) {
            message.reactions[emoji].push(currentUser.id);
        }
        
        // Rerendre les messages immédiatement avec la classe user-reacted
        renderMessages(messages);
        
        // 2️⃣ Envoyer via REST API au serveur
        try {
            const response = await fetch(
                `${window.storage.API_URL}/chat/conversations/${currentConversationId}/messages/${messageId}/reaction`,
                {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ emoji })
                }
            );
            
            if (!response.ok) {
                throw new Error('Échec de l\'ajout au serveur');
            }
            
            const data = await response.json();
            console.log('✅ Réaction envoyée au serveur:', data);
          
            
        } catch (apiError) {
            console.error('❌ Erreur API:', apiError);
            // La réaction est déjà visuelle, afficher un warning
            showToast('Réaction envoyée en local (sync en arrière-plan)', 'info');
            // Recharger quand même pour synchroniser
            await loadMessages(currentConversationId, false);
        }
        
        // 4️⃣ Émettre via Socket.io pour les autres clients
        addReactionViaWebSocket(currentConversationId, messageId, emoji);
        
    } catch (error) {
        console.error('❌ Erreur lors de l\'ajout de la réaction:', error);
        showToast('Impossible d\'ajouter la réaction', 'error');
        // Recharger pour revenir à l'état correct
        await loadMessages(currentConversationId, false);
    }
}

// Retirer une réaction d'un message
async function removeReaction(messageId, emoji) {
    try {
        if (!messageId || !currentConversationId) return;
        
        // Trouver le message
        const message = messages.find(m => m.id === messageId);
        if (!message || !message.reactions || !message.reactions[emoji]) return;
        
        // 1️⃣ Mettre à jour localement en premier pour l'UI optimiste
        const reactionIndex = message.reactions[emoji].indexOf(currentUser.id);
        if (reactionIndex !== -1) {
            message.reactions[emoji].splice(reactionIndex, 1);
            
            // Supprimer l'emoji s'il n'y a plus de réactions
            if (message.reactions[emoji].length === 0) {
                delete message.reactions[emoji];
            }
        }
        
        
        // 2️⃣ Envoyer via REST API au serveur
        try {
            const response = await fetch(
                `${window.storage.API_URL}/chat/conversations/${currentConversationId}/messages/${messageId}/reaction/${encodeURIComponent(emoji)}`,
                {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`,
                        'Content-Type': 'application/json'
                    }
                }
            );
            
            if (!response.ok) {
                throw new Error('Échec de la suppression au serveur');
            }
            
            const data = await response.json();
            console.log('✅ Réaction retirée du serveur:', data);
           
             renderMessages(messages);
            
        } catch (apiError) {
            console.error('❌ Erreur API:', apiError);
            showToast('Réaction retirée en local (sync en arrière-plan)', 'info');
        
            await loadMessages(currentConversationId, false);
        }
        
        // 4️⃣ Émettre via Socket.io pour les autres utilisateurs
        if (chatSocket && chatSocket.connected) {
            chatSocket.emit('message:reaction:remove', {
                conversationId: currentConversationId,
                messageId: messageId,
                emoji: emoji
            });
        }
        
    } catch (error) {
        console.error('❌ Erreur lors du retrait de la réaction:', error);
        showToast('Impossible de retirer la réaction', 'error');
        // Recharger pour revenir à l'état correct
        await loadMessages(currentConversationId, false);
    }
}

// Copier un message
function copyMessage(message) {
    const textToCopy = message.content || '';
    
    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            showToast('Message copié dans le presse-papier', 'success');
        })
        .catch(err => {
            console.error('Erreur lors de la copie:', err);
            showToast('Impossible de copier le message', 'error');
        });
}

// Transférer un message
function forwardMessage(message) {
    // Afficher un modal pour sélectionner la conversation de destination
    showForwardMessageModal(message);
}

// Supprimer un message
async function deleteMessage(message) {
    try {
        // Demander confirmation
        const result = await Swal.fire({
            title: 'Supprimer le message ?',
            text: 'Cette action est irréversible',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            confirmButtonText: 'Supprimer',
            cancelButtonText: 'Annuler'
        });
        
        if (!result.isConfirmed) return;
        
        // Utiliser l'API pour supprimer le message
        const response = await fetch(
            `${window.storage.API_URL}/chat/conversations/${currentConversationId}/messages/${message.id}`,
            {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${getAuthToken()}`
                }
            }
        );
        
        if (!response.ok) throw new Error('Échec de la suppression');
        
        // Supprimer le message localement
        const messageIndex = messages.findIndex(m => m.id === message.id);
        if (messageIndex !== -1) {
            messages.splice(messageIndex, 1);
            renderMessages(messages);
        }
        
        showToast('Message supprimé', 'success');
        
    } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        showToast('Impossible de supprimer le message', 'error');
    }
}

// ==========================================
// MODAL POUR TRANSFÉRER UN MESSAGE
// ==========================================

function showForwardMessageModal(message) {
    // Créer le modal de transfert
    const modalHTML = `
        <div class="modal fade" id="forwardModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-share me-2"></i>
                            Transférer le message
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="search-container mb-3">
                            <input type="text" class="form-control" id="forwardSearch" placeholder="Rechercher une conversation...">
                        </div>
                        <div class="conversations-list" id="forwardConversationsList" style="max-height: 300px; overflow-y: auto;">
                            <!-- Conversations pour le transfert -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-primary" id="confirmForwardBtn" disabled>
                            <i class="fas fa-paper-plane me-1"></i> Transférer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Ajouter le modal au DOM s'il n'existe pas
    if (!document.getElementById('forwardModal')) {
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    // Afficher le modal
    const modal = new bootstrap.Modal(document.getElementById('forwardModal'));
    modal.show();
    
    // Charger les conversations pour le transfert
    loadForwardConversations(message);
}

async function loadForwardConversations(messageToForward) {
    try {
        const container = document.getElementById('forwardConversationsList');
        if (!container) return;
        
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Chargement des conversations...</p>
            </div>
        `;
        
        // Exclure la conversation actuelle
        const availableConversations = conversations.filter(conv => conv.id !== currentConversationId);
        
        if (availableConversations.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-comments fa-2x text-muted mb-3"></i>
                    <p>Aucune autre conversation disponible</p>
                </div>
            `;
            return;
        }
        
        // Afficher la liste des conversations
        container.innerHTML = availableConversations.map(conversation => {
            let conversationName = conversation.name || 'Chat';
            if (conversation.type === 'direct' && conversation.participants) {
                const otherParticipants = conversation.participants.filter(p => p.userId !== currentUser?.id);
                if (otherParticipants.length > 0) {
                    const firstParticipant = otherParticipants[0];
                    conversationName = firstParticipant.name || firstParticipant.email || 'Utilisateur';
                }
            }
            
            const avatarText = conversationName.charAt(0).toUpperCase();
            
            return `
                <div class="conversation-item-forward d-flex align-items-center p-3 border-bottom" 
                     data-conversation-id="${conversation.id}">
                    <div class="me-3">
                        <div class="conversation-avatar-small">
                            ${avatarText}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-bold">${escapeHtml(conversationName)}</div>
                        <small class="text-muted">
                            ${conversation.participants?.length || 0} participant${conversation.participants?.length > 1 ? 's' : ''}
                        </small>
                    </div>
                    <div>
                        <input class="form-check-input" type="radio" name="forwardTo" value="${conversation.id}">
                    </div>
                </div>
            `;
        }).join('');
        
        // Ajouter les écouteurs d'événements
        container.querySelectorAll('.conversation-item-forward').forEach(item => {
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('form-check-input')) {
                    const radio = item.querySelector('input[type="radio"]');
                    if (radio) {
                        radio.checked = !radio.checked;
                        updateForwardButton();
                    }
                }
            });
            
            const radio = item.querySelector('input[type="radio"]');
            if (radio) {
                radio.addEventListener('change', updateForwardButton);
            }
        });
        
        // Recherche dans les conversations
        const searchInput = document.getElementById('forwardSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                container.querySelectorAll('.conversation-item-forward').forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
                });
            });
        }
        
        // Bouton de confirmation
        document.getElementById('confirmForwardBtn').onclick = () => {
            forwardToSelectedConversation(messageToForward);
        };
        
    } catch (error) {
        console.error('Erreur lors du chargement des conversations:', error);
        const container = document.getElementById('forwardConversationsList');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erreur lors du chargement des conversations
                </div>
            `;
        }
    }
}

function updateForwardButton() {
    const selected = document.querySelector('input[name="forwardTo"]:checked');
    const confirmBtn = document.getElementById('confirmForwardBtn');
    
    if (confirmBtn) {
        confirmBtn.disabled = !selected;
    }
}

async function forwardToSelectedConversation(message) {
    try {
        const selectedRadio = document.querySelector('input[name="forwardTo"]:checked');
        if (!selectedRadio) return;
        
        const targetConversationId = selectedRadio.value;
        const targetConversation = conversations.find(c => c.id === targetConversationId);
        
        if (!targetConversation) {
            showToast('Conversation non trouvée', 'error');
            return;
        }
        
        // Préparer le texte à transférer
        let forwardedContent = '';
        if (message.type === 'text') {
            forwardedContent = message.content;
        } else if (message.type === 'image') {
            forwardedContent = '📷 Image transférée';
        } else if (message.type === 'file') {
            forwardedContent = `📎 ${message.fileName || 'Fichier transféré'}`;
        }
        
        // Ajouter la mention "Transféré"
        forwardedContent = `↪️ Transféré: ${forwardedContent}`;
        
        // Envoyer le message transféré
        const response = await window.storage.sendMessage(targetConversationId, forwardedContent);
        
        if (response) {
            showToast('Message transféré avec succès', 'success');
            
            // Fermer le modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('forwardModal'));
            if (modal) {
                modal.hide();
            }
        }
        
    } catch (error) {
        console.error('Erreur lors du transfert:', error);
        showToast('Impossible de transférer le message', 'error');
    }
}

// ==========================================
// MODAL D'INFORMATIONS DE LA CONVERSATION
// ==========================================

// Récupérer les détails complets de la conversation
async function getConversationDetails(conversationId) {
    try {
        const response = await fetch(`${window.storage.API_URL}/chat/conversations/${conversationId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        if (!response.ok) throw new Error('Échec de la récupération des détails');
        
        const data = await response.json();
        return data.success ? data.conversation : null;
    } catch (error) {
        console.error('Erreur getConversationDetails:', error);
        return null;
    }
}

// Obtenir le temps écoulé depuis une date
function getTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'à l\'instant';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes}m`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours}h`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days}j`;
    const weeks = Math.floor(days / 7);
    return `${weeks}sem`;
}

async function showChatInfoModal() {
    try {
        if (!currentConversationId) return;
        
        const modal = document.getElementById('chatInfoModal');
        const infoBody = document.getElementById('chatInfoBody');
        

        if (!modal || !infoBody) return;
        
        infoBody.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-primary"></div>
                <p class="mt-2">Chargement des informations...</p>
            </div>
        `;
        
        // Utiliser currentConversation (déjà chargée) ou récupérer les détails
        const conversationDetails = currentConversation || await getConversationDetails(currentConversationId);
        
        if (!conversationDetails) {
            throw new Error('Conversation non trouvée');
        }
        // Mettre à jour le contenu
        let infoHTML = '';
        
        // Infos générales
        infoHTML += `
            <div class="mb-4">
                <div class="section-title">Informations</div>
                <div class="d-flex align-items-center mb-3">
                    <div class="chat-avatar-large me-3">
                         <img src="../assets/images/logo.png" alt="secura-group" class="guest-avatar" onerror="this.style.display='none'">
                    </div>
                    <div>
                        <h4 class="mb-1">${escapeHtml(conversationDetails.name || 'Chat')}</h4>
                        <p class="mb-0">
                            <i class="fas fa-users me-1"></i>
                            ${conversationDetails.participants?.length || 0} participant${conversationDetails.participants?.length > 1 ? 's' : ''}
                        </p>
                    </div>
                </div>
                
                ${conversationDetails?.createdAt ? `
                    <div class="info-item">
                        <i class="fas fa-calendar-plus me-2"></i>
                        <span>Créé le ${new Date(conversationDetails.createdAt).toLocaleDateString('fr-FR')}</span>
                    </div>
                ` : ''}
                
                ${conversationDetails?.description ? `
                    <div class="info-item mt-2">
                        <i class="fas fa-align-left me-2"></i>
                        <span>${escapeHtml(conversationDetails.description)}</span>
                    </div>
                ` : ''}
            </div>
        `;
        
        // Participants
        if (conversationDetails.participants && conversationDetails.participants.length > 0) {
            infoHTML += `
                <div class="participants-section">
                    <div class="section-title">Participants (${conversationDetails.participants.length})</div>
                    <div class="participants-list">
                        ${conversationDetails.participants.map(participant => `
                            <div class="guest-card" style=" display: flex; align-items: center; padding: 10px; border-radius: 8px; margin-bottom: 10px;">
                                <div class="guest-avatar-container ${participant.isOnline ? 'online' : ''}">
                                   
                                    ${getGuestAvatarImage(participant) ? `
                                        <img src="${getGuestAvatarImage(participant)}" alt="${escapeHtml(participant.fullName)}" class="guest-avatar" onerror="this.style.display='none'">
                                    ` : `
                                        <div class="guest-avatar">
                                            ${(participant.name || participant.email || 'U').charAt(0).toUpperCase()}
                                        </div>
                                    `}

                                     <span class="participant-status-badge"></span>
                                </div>
                                <div class="guest-info">
                                    <div class="guest-name">
                                        ${escapeHtml(participant.name || participant.email || 'Utilisateur')}
                                        ${participant.userId === currentUser?.id ? ' <span class="badge bg-primary">Vous</span>' : ''}
                                    </div>
                                    ${participant.email ? `
                                        <div class="guest-email small">${escapeHtml(participant.email)}</div>
                                    ` : ''}
                                    ${participant.isOnline ? `
                                        <div class="participant-status text-success small">
                                            <i class="fas fa-circle me-1" style="font-size: 0.6em;"></i>
                                            En ligne
                                        </div>
                                    ` : `
                                        <div class="participant-status small">
                                            ${participant.lastReadAt ? 'Vu il y a ' + getTimeAgo(participant.lastReadAt) : 'Hors ligne'}
                                        </div>
                                    `}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        
        
        infoBody.innerHTML = infoHTML;
        
        // Ajouter les écouteurs d'événements pour les actions
        document.getElementById('addParticipantsBtn')?.addEventListener('click', () => {
            showAddParticipantsModal();
        });
        
        document.getElementById('changeNameBtn')?.addEventListener('click', () => {
            showChangeNameModal();
        });
        
        document.getElementById('leaveConversationBtn')?.addEventListener('click', () => {
            leaveConversation();
        });
        
        // Afficher le modal
        modal.classList.add('active');
        
    } catch (error) {
        console.error('Erreur lors du chargement des infos:', error);
        const infoBody = document.getElementById('chatInfoBody');
        if (infoBody) {
            infoBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erreur lors du chargement des informations
                </div>
            `;
        }
    }
}


async function showChangeNameModal() {
    const currentName = currentConversation?.name || '';
    
    const { value: newName } = await Swal.fire({
        title: 'Modifier le nom',
        input: 'text',
        inputLabel: 'Nouveau nom de la conversation',
        inputValue: currentName,
        showCancelButton: true,
        confirmButtonText: 'Modifier',
        cancelButtonText: 'Annuler',
        inputValidator: (value) => {
            if (!value) {
                return 'Le nom ne peut pas être vide';
            }
            if (value.length > 50) {
                return 'Le nom ne peut pas dépasser 50 caractères';
            }
        }
    });
    
    if (newName && newName !== currentName) {
        await updateConversationName(newName);
    }
}

async function updateConversationName(newName) {
    try {
        const response = await fetch(`${window.storage.API_URL}/chat/conversations/${currentConversationId}`, {
            method: 'PATCH',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: newName
            })
        });
        
        if (!response.ok) throw new Error('Échec de la modification');
        
        // Mettre à jour localement
        currentConversation.name = newName;
        updateChatHeader();
        
        showToast('Nom modifié avec succès', 'success');
        
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Impossible de modifier le nom', 'error');
    }
}

async function leaveConversation() {
    try {
        const result = await Swal.fire({
            title: 'Quitter la conversation ?',
            text: 'Vous ne recevrez plus de messages de cette conversation',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#EF4444',
            cancelButtonColor: '#6B7280',
            confirmButtonText: 'Quitter',
            cancelButtonText: 'Annuler'
        });
        
        if (!result.isConfirmed) return;
        
        const response = await fetch(`${window.storage.API_URL}/chat/conversations/${currentConversationId}/leave`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${getAuthToken()}`
            }
        });
        
        if (!response.ok) throw new Error('Échec de la sortie');
        
        showToast('Vous avez quitté la conversation', 'success');
        
        // Recharger les conversations
        await loadConversations(true);
        
        // Désélectionner la conversation actuelle
        currentConversationId = null;
        currentConversation = null;
        
        // Masquer la zone de chat avec hideChatArea()
        hideChatArea();
        renderConversationsList(conversations);
        
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Impossible de quitter la conversation', 'error');
    }
}





function initializeConversationPanel() {
    const panel = document.getElementById('newConversationPanel');
    const overlay = document.getElementById('panelOverlay');
    const backBtn = document.getElementById('backToConversationsBtn');
    const cancelBtn = document.getElementById('cancelConversationBtn');
    const createBtn = document.getElementById('createConversationBtn');
    const typeRadios = document.querySelectorAll('input[name="conversationType"]');
    const panelTitle = document.querySelector('.panel-title h3');

    // Gérer le clic sur le bouton de création
    if (createBtn) {
        createBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const isDirect = document.getElementById('typeDirect')?.checked;
            const isGroup = document.getElementById('typeGroup')?.checked;
            
            if (isDirect) {
                // Pour chat direct, créer directement
                createNewConversation();
            } else if (isGroup) {
                // Pour groupe, fermer le panel d'abord, puis ouvrir le modal
                closeConversationPanel();
                // Délai pour que le panel se ferme avant d'ouvrir le modal
                setTimeout(() => {
                    openGroupCreationModal();
                }, 300);
            }
        });
    }
    
    // Gérer le changement de type
    typeRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            const searchInput = document.getElementById('newConversationSearch');
            
            // Réinitialiser complètement l'état
            if (e.target.id === 'typeGroup') {
                if (panelTitle) {
                    panelTitle.innerHTML = '<i class="fas fa-users me-2"></i>Nouveau groupe';
                }
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.placeholder = 'Ajouter des participants...';
                }
                // Décocher toutes les cartes sélectionnées
                document.querySelectorAll('.guest-card.selected').forEach(card => {
                    card.classList.remove('selected');
                });
            } else {
                if (panelTitle) {
                    panelTitle.innerHTML = '<i class="fas fa-user me-2"></i>Chat Direct';
                }
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.placeholder = 'Rechercher un contact...';
                }
                // Réinitialiser les checkboxes cochées
                document.querySelectorAll('.user-select-checkbox:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
            }
            // Recharger les invités quand le type change (pour afficher/masquer checkboxes)
            loadUsersForNewConversation();
            updateCreateButton();
        });
    });
    
    // Boutons de fermeture
    if (backBtn) backBtn.addEventListener('click', closeConversationPanel);
    if (cancelBtn) cancelBtn.addEventListener('click', closeConversationPanel);
    
    // Initialiser les listeners du modal de groupe
    initializeGroupCreationModal();
    
    // Fermeture par overlay click
    if (overlay) {
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                closeConversationPanel();
            }
        });
    }
    
    // Empêcher la propagation des clicks sur le panel
    if (panel) {
        panel.addEventListener('click', (e) => e.stopPropagation());
    }
    
    // Ajouter le listener de recherche
    const searchInput = document.getElementById('newConversationSearch');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(() => {
            filterNewConversationUsers();
        }, 300));
    }
    
    // Charger les invités
    loadUsersForNewConversation();
}

function openConversationPanel() {
    const panel = document.getElementById('newConversationPanel');
    const overlay = document.getElementById('panelOverlay');
    if (panel) {
        // Réinitialiser l'état du panel
        const typeDirect = document.getElementById('typeDirect');
        if (typeDirect) typeDirect.checked = true; // Par défaut: chat direct
        
        const searchInput = document.getElementById('newConversationSearch');
        if (searchInput) searchInput.value = '';
        
        // Décocher toutes les checkboxes
        document.querySelectorAll('.user-select-checkbox:checked').forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Retirer les sélections de cartes
        document.querySelectorAll('.guest-card.selected').forEach(card => {
            card.classList.remove('selected');
        });
        
        panel.classList.add('active');
        overlay.classList.add('active');
        
        // Recharger les utilisateurs
        loadUsersForNewConversation();
        updateCreateButton();
    }
}


function closeConversationPanel() {
    const panel = document.getElementById('newConversationPanel');
    const overlay = document.getElementById('panelOverlay');
    if (panel) {
        panel.classList.remove('active');
        overlay.classList.remove('active');
    }
}

// Obtenir l'avatar selon le sexe avec détection intelligente
function getGuestAvatarImage(guest) {
    const baseUrl = '../assets/images/';
    const validGenders = ['m', 'f', 'homme', 'femme', 'male', 'female', 'couple', 'maman', 'mother', 'autre'];
    
    // 1️⃣ Vérifier d'abord le champ gender/sexe
    const gender = (guest.gender?.toLowerCase() || guest.sexe?.toLowerCase() || '').trim();
    
    if (gender) {
        // Normaliser et checker les valeurs connues
        if (gender === 'f' || gender === 'femme' || gender === 'woman' || gender === 'female') {
            return `${baseUrl}femme.png`;
        } else if (gender === 'm' || gender === 'homme' || gender === 'man' || gender === 'male') {
            return `${baseUrl}homme.png`;
        } else if (gender === 'couple') {
            return `${baseUrl}couple.png`;
        } else if (gender === 'maman' || gender === 'mother') {
            return `${baseUrl}maman.png`;
        } else if (gender === 'autre') {
            return null; // Utiliser les initiales
        }
    }
    
    // 2️⃣ Détection intelligente basée sur les titres de civilité et notes
    const firstName = (guest.firstName || '').toLowerCase().trim();
    const lastName = (guest.lastName || '').toLowerCase().trim();
    const notes = (guest.notes || '').toLowerCase().trim();
    
    const maleIndicators = ['mr', 'monsieur', 'homme', 'male', 'son', 'père', 'fils', 'dad', 'boy'];
    const femaleIndicators = ['mme', 'mlle', 'madame', 'mademoiselle', 'femme', 'female', 'fille', 'maman', 'mother', 'mom', 'girl', 'daughter'];
    
    const fullName = `${firstName} ${lastName}`.toLowerCase();
    
    // Checker dans le nom complet
    for (let indicator of femaleIndicators) {
        if (fullName.includes(indicator) || notes.includes(indicator)) {
            return `${baseUrl}femme.png`;
        }
    }
    
    for (let indicator of maleIndicators) {
        if (fullName.includes(indicator) || notes.includes(indicator)) {
            return `${baseUrl}homme.png`;
        }
    }
    
    // 3️⃣ Si aucune détection, utiliser null (affichera les initiales)
    return null;
}

// Méthode générique pour obtenir l'avatar de n'importe quel utilisateur ou guest
function getAvatarImage(user) {
    if (!user) return null;
    
    return getGuestAvatarImage(user);
}

async function loadUsersForNewConversation() {
    try {
        const container = document.getElementById('newConversationUsersList');
        if (!container) return;
        
        // Récupérer les invités de l'événement
        const session = await window.storage.getCurrentSessionDetails();
        if (!session?.success) return;
        
        const eventId = session.data.event?.id;
        if (!eventId) return;
        
        // Utiliser la méthode du storage pour récupérer les invités
        const guests = window.storage.getGuestsByEventId(eventId);
        const users = guests || [];
        
        // Filtrer l'utilisateur courant
        const otherUsers = users.filter(user => user.id !== currentUser?.id);
        
        if (otherUsers.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-user-slash fa-2x text-muted mb-3"></i>
                    <p>Aucun autre utilisateur disponible</p>
                </div>
            `;
            return;
        }
        
        // Vérifier le type de conversation
        const isDirect = document.getElementById('typeDirect')?.checked;
        
        // Séparer les utilisateurs avec/sans conversation existante
        const usersWithConversation = [];
        const usersWithoutConversation = [];
        
        otherUsers.forEach(user => {
            // Chercher une conversation directe existante avec cet utilisateur
            const existingConversation = conversations.find(conv => 
                conv.type === 'direct' && 
                conv.participants.some(p => p.userId === user.id)
            );
            
            if (existingConversation) {
                usersWithConversation.push({ ...user, conversationId: existingConversation.id });
            } else {
                usersWithoutConversation.push(user);
            }
        });
        
        // Afficher les utilisateurs sans conversation d'abord
        let htmlContent = '';
        
        // Section: Utilisateurs disponibles pour nouvelle conversation
        if (usersWithoutConversation.length > 0) {
            htmlContent += usersWithoutConversation.map((user, index) => {
                const fullName = `${(user.firstName || '')} ${(user.lastName || '')}`.trim() || user.email || 'Invité';
                const initials = (user.firstName?.charAt(0) || '') + (user.lastName?.charAt(0) || '') || fullName.charAt(0);
                const avatarImage = getGuestAvatarImage(user);
                
                // Pour chat direct : pas de checkbox
                // Pour groupe : afficher checkbox (JAMAIS pré-coché!)
                const checkboxHTML = !isDirect ? `<input type="checkbox" class="guest-checkbox user-select-checkbox" value="${user.id}" id="guest-${user.id}" autocomplete="off">` : '';
                const checkboxLabelFor = !isDirect ? `for="guest-${user.id}"` : '';
                const indicatorHTML = !isDirect ? `<div class="guest-checkbox-indicator"><i class="fas fa-check-circle"></i></div>` : '';
                
                return `
                    <div class="guest-card" data-guest-id="${user.id}">
                        ${checkboxHTML}
                        
                        <label ${checkboxLabelFor} class="guest-card-label">
                            <div class="guest-avatar-container">
                                ${avatarImage ? `
                                    <img src="${avatarImage}" alt="${escapeHtml(fullName)}" class="guest-avatar" onerror="this.style.display='none'">
                                ` : `
                                    <div class="guest-avatar">
                                        ${initials.toUpperCase()}
                                    </div>
                                `}
                                <div class="guest-info">
                                    <div class="guest-name">${escapeHtml(fullName)}</div>
                                    <div class="guest-email">${escapeHtml(user.email || 'Sans email')}</div>
                                </div>
                            </div>
                            ${indicatorHTML}
                        </label>
                    </div>
                `;
            }).join('');
        }
        
        // Section: Utilisateurs avec conversation existante
        if (usersWithConversation.length > 0) {
            if (htmlContent) {
                htmlContent += `
                    <div class="conversation-divider" style="margin: 15px 0; padding: 10px 0; border-top: 1px solid var(--border-color); font-size: 12px; color: #999; text-align: center;">
                        Conversations existantes
                    </div>
                `;
            }
            
            htmlContent += usersWithConversation.map((user, index) => {
                const fullName = `${(user.firstName || '')} ${(user.lastName || '')}`.trim() || user.email || 'Invité';
                const initials = (user.firstName?.charAt(0) || '') + (user.lastName?.charAt(0) || '') || fullName.charAt(0);
                const avatarImage = getGuestAvatarImage(user);
                
                return `
                    <div onclick="selectConversationWithUser('${user.conversationId}')" class="guest-card existing-conversation" style="display: flex; !important" data-guest-id="${user.id}" data-conversation-id="${user.conversationId}">
                        <div class="guest-card-label">
                            <div class="guest-avatar-container">
                                ${avatarImage ? `
                                    <img src="${avatarImage}" alt="${escapeHtml(fullName)}" class="guest-avatar" onerror="this.style.display='none'">
                                ` : `
                                    <div class="guest-avatar">
                                        ${initials.toUpperCase()}
                                    </div>
                                `}
                                <div class="guest-info">
                                    <div class="guest-name">${escapeHtml(fullName)}</div>
                                    <div class="guest-email">${escapeHtml(user.email || 'Sans email')}</div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-sm chat-existing-btn" onclick="selectConversationWithUser('${user.conversationId}')" title="Aller au chat">
                            <i class="fas fa-comments"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Si aucun utilisateur
        if (usersWithoutConversation.length === 0 && usersWithConversation.length === 0) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-user-slash fa-2x text-muted mb-3"></i>
                    <p>Aucun autre utilisateur disponible</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = htmlContent;
        
        // Ajouter les événements aux cartes (SAUF les conversations existantes)
        document.querySelectorAll('.guest-card:not(.existing-conversation)').forEach(card => {
            card.addEventListener('click', (e) => {
                const isDirect = document.getElementById('typeDirect')?.checked;
                const checkbox = card.querySelector('.guest-checkbox');
                
                if (isDirect) {
                    // Pour chat direct: sélection exclusive
                    document.querySelectorAll('.guest-card:not(.existing-conversation)').forEach(c => c.classList.remove('selected'));
                    document.querySelectorAll('.guest-checkbox').forEach(cb => cb.checked = false);
                    card.classList.add('selected');
                    if (checkbox) checkbox.checked = true;
                    updateCreateButton();
                } else if (checkbox && e.target.type !== 'checkbox') {
                    // Pour groupe: empêcher l'action par défaut du label (qui togglerait
                    // le checkbox automatiquement) pour éviter un double-toggle.
                    e.preventDefault();

                    // Toggle checkbox avec limite de 5
                    const currentlyChecked = document.querySelectorAll('.user-select-checkbox:checked').length;

                    if (!checkbox.checked && currentlyChecked >= 5) {
                        showToast('Maximum 5 participants par groupe', 'warning');
                        return;
                    }

                    checkbox.checked = !checkbox.checked;
                    card.classList.toggle('selected', checkbox.checked);
                    // Déclencher manuellement l'événement change pour synchroniser
                    // les autres gestionnaires (et updateCreateButton).
                    checkbox.dispatchEvent(new Event('change'));
                    updateCreateButton();
                }
            });
            
            // Pour les checkboxes, gérer le changement
            const checkbox = card.querySelector('.guest-checkbox');
            if (checkbox) {
                // S'assurer que le checkbox n'est pas coché au départ
                checkbox.checked = false;
                
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    const isDirect = document.getElementById('typeDirect')?.checked;
                    
                    if (isDirect) {
                        // Pour chat direct: sélection exclusive
                        document.querySelectorAll('.guest-checkbox').forEach(cb => cb.checked = false);
                        document.querySelectorAll('.guest-card:not(.existing-conversation)').forEach(c => c.classList.remove('selected'));
                        checkbox.checked = true;
                        card.classList.add('selected');
                    } else {
                        // Pour groupe: vérifier la limite de 5
                        const currentlyChecked = document.querySelectorAll('.user-select-checkbox:checked').length;
                        
                        if (checkbox.checked && currentlyChecked > 5) {
                            checkbox.checked = false;
                            card.classList.remove('selected');
                            showToast('Maximum 5 participants par groupe', 'warning');
                            updateCreateButton();
                            return;
                        }
                        
                        // Marquer comme sélectionné
                        if (checkbox.checked) {
                            card.classList.add('selected');
                        } else {
                            card.classList.remove('selected');
                        }
                    }
                    updateCreateButton();
                });
            }
        });
        
        updateCreateButton();
        
    } catch (error) {
        console.error('Erreur:', error);
        const container = document.getElementById('newConversationUsersList');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erreur lors du chargement des utilisateurs
                </div>
            `;
        }
    }
}

// Filtrer les utilisateurs dans la nouvelle conversation
function filterNewConversationUsers() {
    const searchInput = document.getElementById('newConversationSearch');
    if (!searchInput) return;
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    const container = document.getElementById('newConversationUsersList');
    if (!container) return;
    
    // Récupérer toutes les cartes
    const cards = container.querySelectorAll('.guest-card');
    let visibleCount = 0;
    
    if (searchTerm.length === 0) {
        // Afficher tous les utilisateurs
        cards.forEach(card => {
            card.style.display = 'block';
            visibleCount++;
        });
        // Supprimer le message d'aucun résultat s'il existe
        const emptyMessage = container.querySelector('.empty-search-state');
        if (emptyMessage) emptyMessage.remove();
    } else {
        // Filtrer par nom ou email
        cards.forEach(card => {
            const name = card.querySelector('.guest-name')?.textContent.toLowerCase() || '';
            const email = card.querySelector('.guest-email')?.textContent.toLowerCase() || '';
            
            const match = name.includes(searchTerm) || email.includes(searchTerm);
            card.style.display = match ? 'flex' : 'none';
            if (match) visibleCount++;
        });
        
        // Afficher le message d'aucun résultat si aucune carte n'est visible
        if (visibleCount === 0) {
            // Vérifier si le message existe déjà
            let emptyMessage = container.querySelector('.empty-search-state');
            if (!emptyMessage) {
                emptyMessage = document.createElement('div');
                emptyMessage.className = 'empty-search-state';
                emptyMessage.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--text-muted, #999);">
                        <i class="fas fa-search fa-3x mb-3" style="display: block; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p style="margin: 0; font-size: 14px;">Aucun résultat trouvé</p>
                        <p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.7;">Modifiez votre recherche et réessayez</p>
                    </div>
                `;
                container.appendChild(emptyMessage);
            }
        } else {
            // Supprimer le message d'aucun résultat s'il existe
            const emptyMessage = container.querySelector('.empty-search-state');
            if (emptyMessage) emptyMessage.remove();
        }
    }
}

function updateCreateButton() {
    const isDirect = document.getElementById('typeDirect')?.checked;
    const isGroup = document.getElementById('typeGroup')?.checked;
    
    const createBtn = document.getElementById('createConversationBtn');
    if (!createBtn) return;
    
    // Mise à jour du texte du bouton
    if (isDirect) {
        createBtn.innerHTML = '<i class="fas fa-comments me-1"></i> Créer Chat Direct';
        const selectedCard = document.querySelector('.guest-card.selected');
        createBtn.disabled = !selectedCard;
    } else if (isGroup) {
        const selectedUsers = Array.from(
            document.querySelectorAll('.user-select-checkbox:checked')
        ).map(input => input.value);
        
        const count = selectedUsers.length;
        
        // Afficher le nombre de participants sélectionnés
        if (count === 0) {
            createBtn.innerHTML = '<i class="fas fa-users me-1"></i> Sélectionnez 2-5 participants';
        } else if (count === 1) {
            createBtn.innerHTML = '<i class="fas fa-users me-1"></i> Ajoutez 1 plus (max 5)';
        } else {
            createBtn.innerHTML = `<i class="fas fa-users me-1"></i> Continuer (${count}/5)`;
        }
        
        // Désactiver si: moins de 2 participants ou plus de 5.
        // Le bouton s'active dès que 2 à 5 participants sont sélectionnés.
        createBtn.disabled = count < 2 || count > 5;
    }
}

function updateAddParticipantsButton() {
    const selectedUsers = Array.from(
        document.querySelectorAll('#addUsersList .user-select-checkbox:checked')
    ).map(input => input.value);
    
    const confirmBtn = document.getElementById('confirmAddParticipantsBtn');
    if (confirmBtn) {
        confirmBtn.disabled = selectedUsers.length === 0;
    }
}

// Initialiser les listeners du modal de création de groupe
function initializeGroupCreationModal() {
    const modal = document.getElementById('newGroupModal');
    const overlay = document.getElementById('groupModalOverlay');
    const closeBtn = document.getElementById('closeGroupModalBtn');
    const cancelBtn = document.getElementById('cancelGroupModalBtn');
    const nameInput = document.getElementById('groupNameModalInput');
    const confirmBtn = document.getElementById('confirmGroupCreationBtn');
    
    // Fermer le modal
    const closeModal = () => {
        modal.style.display = 'none';
        overlay.style.display = 'none';
    };
    
    if (closeBtn) closeBtn.addEventListener('click', closeModal);
    if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
    if (overlay) overlay.addEventListener('click', closeModal);
    
    // Valider en écoutant la saisie du nom
    if (nameInput) {
        nameInput.addEventListener('input', () => {
            const groupName = nameInput.value.trim();
            confirmBtn.disabled = groupName.length === 0;
        });
    }
    
    // Soumettre la création du groupe
    if (confirmBtn) {
        confirmBtn.addEventListener('click', async () => {
            const groupName = nameInput.value.trim();
            if (!groupName) {
                showToast('Entrez un nom pour le groupe', 'warning');
                return;
            }
            
            // Récupérer les participants sélectionnés
            const selectedUsers = Array.from(
                document.querySelectorAll('.user-select-checkbox:checked')
            ).map(input => input.value);
            
            if (selectedUsers.length < 2 || selectedUsers.length > 5) {
                showToast('Sélectionnez entre 2 et 5 participants', 'warning');
                return;
            }
            
            // Créer la conversation
            await createNewConversationWithGroupName(groupName, selectedUsers);
            closeModal();
        });
    }
}

// Ouvrir le modal de création de groupe
async function openGroupCreationModal() {
    const modal = document.getElementById('newGroupModal');
    const overlay = document.getElementById('groupModalOverlay');
    const nameInput = document.getElementById('groupNameModalInput');
    const participantsContainer = document.getElementById('groupModalParticipants');
    const participantCount = document.getElementById('participantCount');
    const confirmBtn = document.getElementById('confirmGroupCreationBtn');
    
    // Récupérer les participants sélectionnés
    const selectedCheckboxes = document.querySelectorAll('.user-select-checkbox:checked');
    const selectedUsers = Array.from(selectedCheckboxes).map(input => input.value);
    
    if (selectedUsers.length < 2 || selectedUsers.length > 5) {
        showToast('Sélectionnez entre 2 et 5 participants', 'warning');
        return;
    }
    
    // Mettre à jour le compteur
    participantCount.textContent = selectedUsers.length;
    
    // Afficher les participants sélectionnés
    try {
        const session = await window.storage.getCurrentSessionDetails();
        const eventId = session?.data?.event?.id;
        const guests = eventId ? window.storage.getGuestsByEventId(eventId) : [];
        
        participantsContainer.innerHTML = selectedUsers.map(userId => {
            const guest = guests.find(g => g.id === userId);
            
            if (!guest) return '';
            
            const fullName = `${(guest.firstName || '')} ${(guest.lastName || '')}`.trim() || guest.email || 'Invité';
            const initials = (guest.firstName?.charAt(0) || '') + (guest.lastName?.charAt(0) || '') || fullName.charAt(0);
            const avatarImage = getGuestAvatarImage(guest);
            
            return `
                <div style="display: flex; align-items: center; gap: 12px; padding: 8px 12px; background: var(--hover-bg); border-radius: 8px;">
                    ${avatarImage ? `
                        <img src="${avatarImage}" alt="${fullName}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'">
                    ` : `
                        <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--secura-red) 0%, var(--secura-accent) 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px; flex-shrink: 0;">
                            ${initials.toUpperCase()}
                        </div>
                    `}
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 14px; font-weight: 500; color: var(--text-color); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${fullName}</div>
                        <div style="font-size: 12px; color: var(--secura-medium-gray); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${guest.email || 'Sans email'}</div>
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Erreur affichage participants:', error);
    }
    
    // Réinitialiser et afficher
    nameInput.value = '';
    nameInput.focus();
    confirmBtn.disabled = true;
    
    modal.style.display = 'flex';
    overlay.style.display = 'block';
}

async function createNewConversationWithGroupName(groupName, selectedUsers) {
    try {
        // Récupérer l'événement actuel
        const session = await window.storage.getCurrentSessionDetails();
        if (!session?.success) throw new Error('Session invalide');
        
        const eventId = session.data.event?.id;
        if (!eventId) throw new Error('Aucun événement actif');
        
        // Créer la conversation via la méthode du storage
        const result = await window.storage.createConversation(
            eventId,
            groupName,
            selectedUsers
        );
        
        // Récupérer les résultats
        if (!result) throw new Error('Échec création conversation');
        
        // Recharger les conversations
        await loadConversations(eventId, true);
        
        // Fermer le panel
        closeConversationPanel();
        
        // Sélectionner la nouvelle conversation
        if (result && result.id) {
            selectConversation(result.id);
        }
        
        showToast('Groupe créé avec succès!', 'success');
        
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Impossible de créer le groupe', 'error');
    }
}

async function createNewConversation() {
    try {
        const isDirect = document.getElementById('typeDirect')?.checked;
        
        // Récupérer les participants sélectionnés
        let selectedUsers = [];
        
        if (isDirect) {
            // Pour chat direct: récupérer la carte sélectionnée
            const selectedCard = document.querySelector('.guest-card.selected');
            if (selectedCard) {
                selectedUsers = [selectedCard.getAttribute('data-guest-id')];
            }
        }
        
        // Validation
        if (isDirect && selectedUsers.length !== 1) {
            showToast('Sélectionnez un contact pour le chat direct', 'warning');
            return;
        }
        
        // Récupérer l'événement actuel
        const session = await window.storage.getCurrentSessionDetails();
        if (!session?.success) throw new Error('Session invalide');
        
        const eventId = session.data.event?.id;
        if (!eventId) throw new Error('Aucun événement actif');
        
        // Créer la conversation via la méthode du storage (chat direct)
        const result = await window.storage.createConversation(
            eventId,
            `Chat with participant`,
            selectedUsers
        );
        
        // Récupérer les résultats
        if (!result) throw new Error('Échec création conversation');
        
        // Recharger les conversations
        await loadConversations(eventId, true);
        
        // Fermer le panel
        closeConversationPanel();
        
        // Sélectionner la nouvelle conversation
        if (result && result.id) {
            selectConversation(result.id);
        }
        
        showToast('Chat direct créé avec succès!', 'success');
        
    } catch (error) {
        console.error('Erreur:', error);
        showToast('Impossible de créer la conversation', 'error');
    }
}

// ==========================================
// GESTION DU POLLING ET WEBSOCKETS
// ==========================================

// Système de listeners en temps réel avancé
const realtimeListeners = {
    conversations: null,
    currentConversation: null,
    stopListeners() {
        if (this.conversations) clearInterval(this.conversations);
        if (this.currentConversation) clearInterval(this.currentConversation);
    }
};

function startPolling() {
    // Arrêter les anciens listeners
    realtimeListeners.stopListeners();
    
    // Variables de suivi pour détecter les changements
    let lastConversationHash = null;
    let lastMessageHash = null;
    let conversationUpdateQueue = [];
    let isProcessingUpdates = false;
    
    // Listener granulaire pour les conversations (toutes les 5 secondes au lieu de 30)
    realtimeListeners.conversations = setInterval(async () => {
        if (document.visibilityState !== 'visible') return;
        
        try {
            // Récupérer les conversations de manière légère
            const result = await window.storage.getConversations();
            if (!result?.success || !result?.data) return;
            
            const newConversations = result.data;
            
            // Créer un hash pour détecter les changements
            const currentHash = JSON.stringify(
                newConversations.map(c => ({ 
                    id: c.id, 
                    updatedAt: c.updatedAt,
                    lastMessageId: c.lastMessage?.id 
                }))
            );
            
            // Si rien n'a changé, ne pas traiter
            if (currentHash === lastConversationHash) return;
            
            lastConversationHash = currentHash;
            
            // Détecter les changements spécifiques
            const changes = detectConversationChanges(conversations, newConversations);
            
            if (changes.length > 0) {
                // Ajouter à la file d'attente
                conversationUpdateQueue.push(...changes);
                
                // Traiter les mises à jour de manière granulaire
                if (!isProcessingUpdates) {
                    await processConversationUpdates(newConversations, changes);
                }
            }
            
            // Mettre à jour la liste globale
            conversations = newConversations;
            
        } catch (error) {
            console.error('Erreur listener conversations:', error);
        }
    }, 5000); // Plus rapide pour une meilleure UX
    
    // Listener granulaire pour les messages de la conversation actuelle (2 secondes)
    realtimeListeners.currentConversation = setInterval(async () => {
        if (!currentConversationId || document.visibilityState !== 'visible') return;
        
        try {
            // Récupérer uniquement les nouveaux messages depuis le dernier connu
            const lastMessage = messages[messages.length - 1];
            const lastMessageTimestamp = lastMessage?.createdAt || 0;
            
            const result = await window.storage.getMessages(currentConversationId, {
                limit: 50,
                since: lastMessageTimestamp
            });
            
            if (!result?.success || !result?.data) return;
            const newMessages = result.data;
            
            if (newMessages.length > 0) {
                // Filtrer pour éviter les doublons
                const messageIds = new Set(messages.map(m => m.id));
                const uniqueNewMessages = newMessages.filter(m => !messageIds.has(m.id));
                
                if (uniqueNewMessages.length > 0) {
                    // Ajouter les messages
                    messages.push(...uniqueNewMessages);
                    
                    // Render avec animation
                    renderMessages(messages);
                    
                    // Scroll vers le bas avec animation smooth
                    scrollToBottomSmooth();
                    
                    // Trigger notification pour les messages entrants
                    const incomingMessages = uniqueNewMessages.filter(m => m.senderId !== currentUser?.id);
                    if (incomingMessages.length > 0) {
                        playMessageNotificationSound();
                    }
                }
            }
            
        } catch (error) {
            console.error('Erreur listener messages:', error);
        }
    }, 2000); // Plus rapide pour les messages
}

// Détecter les changements dans les conversations
function detectConversationChanges(oldConversations, newConversations) {
    const changes = [];
    const oldMap = new Map(oldConversations.map(c => [c.id, c]));
    const newMap = new Map(newConversations.map(c => [c.id, c]));
    
    // Détecter les nouvelles conversations
    for (const [id, newConv] of newMap) {
        if (!oldMap.has(id)) {
            changes.push({ type: 'new', conversation: newConv });
        } else {
            // Détecter les mises à jour
            const oldConv = oldMap.get(id);
            if (oldConv.updatedAt !== newConv.updatedAt) {
                changes.push({ type: 'updated', conversation: newConv, old: oldConv });
            }
        }
    }
    
    // Détecter les conversations supprimées
    for (const [id] of oldMap) {
        if (!newMap.has(id)) {
            changes.push({ type: 'deleted', conversationId: id });
        }
    }
    
    return changes;
}

// Traiter les mises à jour de conversations de manière granulaire
async function processConversationUpdates(allConversations, changes) {
    isProcessingUpdates = true;
    
    try {
        for (const change of changes) {
            if (change.type === 'new') {
                // Nouvelle conversation - la rendre avec animation
                renderConversationsList(allConversations);
                
                // Attendre que le DOM soit mis à jour
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Appliquer l'animation à la nouvelle conversation
                const newConvElement = document.querySelector(`[data-conversation-id="${change.conversation.id}"]`);
                if (newConvElement) {
                    newConvElement.classList.add('conversation-list-update');
                }
            } else if (change.type === 'updated') {
                // Conversation mise à jour - l'amener en haut avec smooth animation
                // Re-render la liste complète pour retrier
                renderConversationsList(allConversations);
                
                // Attendre que le DOM soit mis à jour
                await new Promise(resolve => setTimeout(resolve, 50));
                
                // Appliquer l'animation à la conversation mise à jour
                const updatedConvElement = document.querySelector(`[data-conversation-id="${change.conversation.id}"]`);
                if (updatedConvElement) {
                    updatedConvElement.classList.add('conversation-message-received');
                    
                    // Ajouter un indicateur si nouveau message d'un autre utilisateur
                    const lastMessage = change.conversation.lastMessage;
                    if (lastMessage && lastMessage.senderId !== currentUser?.id) {
                        // Pulser le badge de message non lu
                        const unreadBadge = updatedConvElement.querySelector('.conversation-unread-badge');
                        if (unreadBadge) {
                            unreadBadge.classList.add('pulse-badge');
                        }
                    }
                }
            } else if (change.type === 'deleted') {
                // Conversation supprimée - l'enlever avec animation
                const conversationElement = document.querySelector(`[data-conversation-id="${change.conversationId}"]`);
                if (conversationElement) {
                    conversationElement.style.animation = 'slideOut 0.3s ease-out forwards';
                    
                    // Attendre l'animation avant de supprimer
                    await new Promise(resolve => setTimeout(resolve, 300));
                    conversationElement.remove();
                }
            }
        }
    } finally {
        isProcessingUpdates = false;
    }
}

// Scroll vers le bas avec animation smooth (sans loader)
function scrollToBottomSmooth() {
    const messagesWrapper = document.getElementById('messagesWrapper');
    if (!messagesWrapper) return;
    
    // Utiliser requestAnimationFrame pour une animation fluide
    requestAnimationFrame(() => {
        messagesWrapper.scrollTo({
            top: messagesWrapper.scrollHeight,
            behavior: 'smooth'
        });
    });
}

function playMessageNotificationSound() {
    try {
        // Si vous avez un fichier audio
        const audio = new Audio('../assets/sounds/message-notification.mp3');
        audio.volume = 0.3;
        audio.play().catch(() => {});
    } catch (error) {
        console.error('Erreur de lecture du son de notification:', error);
    }
}

function truncateText(text, maxLength) {
    if (!text) return '';
    return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

// ==========================================
// GESTION DE LA CONNEXION RÉSEAU
// ==========================================

function setupNetworkHandling() {
    // Surveiller les changements de connexion
    window.addEventListener('online', handleOnlineStatus);
    window.addEventListener('offline', handleOfflineStatus);
    
    // Vérifier la connexion initiale
    if (navigator.onLine) {
        handleOnlineStatus();
    } else {
        handleOfflineStatus();
    }
}

function handleOnlineStatus() {
    isOnline = true;
    updateConnectionStatus();
    
    // 🔌 Tenter de se reconnecter aux WebSockets si nécessaire
    if (!chatSocket || !chatSocket.connected) {
        console.log('🔌 Reconnexion WebSocket...');
        initWebSocket();
    }
    
    // Synchroniser les données
    if (currentConversationId) {
        loadMessages(currentConversationId);
    }
    
    loadConversations(true);
}

function handleOfflineStatus() {
    isOnline = false;
    updateConnectionStatus();
    showToast('Vous êtes hors ligne', 'warning');
}

function updateConnectionStatus() {
    const statusElement = document.getElementById('connectionStatus');
    if (!statusElement) return;
    
    if (isOnline) {
        statusElement.innerHTML = '<i class="fas fa-circle"></i> Connecté';
        statusElement.className = 'connection-status connected';
    } else {
        statusElement.innerHTML = '<i class="fas fa-circle"></i> Hors ligne';
        statusElement.className = 'connection-status disconnected';
    }
    
    // Afficher l'indicateur
    statusElement.classList.remove('hidden');
    
    // Masquer après 3 secondes si connecté
    if (isOnline) {
        setTimeout(() => {
            statusElement.classList.add('hidden');
        }, 3000);
    }
}


// ==========================================
// UTILITAIRES
// ==========================================

// Ouvrir le panel profil
function openProfilePanel() {
    if (!currentUser) {
        showToast('Utilisateur non connecté', 'error');
        return;
    }

    const panel = document.getElementById('profilePanel');
    const overlay = document.getElementById('profileSettingsOverlay');
    
    if (!panel || !overlay) return;

    // Remplir les infos du profil
    const fullName = `${(currentUser.firstName || '')} ${(currentUser.lastName || '')}`.trim() || currentUser.name || 'Utilisateur';
    const initials = (currentUser.firstName?.charAt(0) || '') + (currentUser.lastName?.charAt(0) || '') || 'U';
    const avatarImage = getAvatarImage(currentUser);
    
    // Mettre à jour l'avatar
    const profileAvatarLarge = document.getElementById('profileAvatarLarge');
    if (profileAvatarLarge) {
        if (avatarImage) {
            profileAvatarLarge.innerHTML = `<img src="${avatarImage}" alt="${escapeHtml(fullName)}" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
            profileAvatarLarge.innerHTML = initials.toUpperCase();
        }
    }

    // Mettre à jour les infos
    document.getElementById('profileName').textContent = fullName;
    document.getElementById('profileEmail').textContent = currentUser.email || 'Sans email';
    document.getElementById('detailName').textContent = fullName;
    document.getElementById('detailEmail').textContent = currentUser.email || '-';
    document.getElementById('detailPhone').textContent = currentUser.phone || '-';
    
    if (currentUser.createdAt) {
        const joinDate = new Date(currentUser.createdAt);
        document.getElementById('detailJoinDate').textContent = joinDate.toLocaleDateString('fr-FR');
    } else {
        document.getElementById('detailJoinDate').textContent = '-';
    }

    // Afficher le panel
    panel.classList.add('active');
    overlay.classList.add('active');

    // Event listeners pour le panel profil
    setupProfilePanelListeners();
}

// Ouvrir le panel paramètres
function openSettingsPanel() {
    const panel = document.getElementById('settingsPanel');
    const overlay = document.getElementById('profileSettingsOverlay');
    
    if (!panel || !overlay) return;

    // Afficher le panel
    panel.classList.add('active');
    overlay.classList.add('active');

    // Event listeners pour le panel paramètres
    setupSettingsPanelListeners();
}

// Event listeners pour le panel profil
function setupProfilePanelListeners() {
    // Fermer le panel
    document.getElementById('closeProfileBtn')?.addEventListener('click', closeProfilePanel);
    document.getElementById('backProfileBtn')?.addEventListener('click', closeProfilePanel);

    // Status selector
    document.querySelectorAll('.status-option').forEach(option => {
        option.addEventListener('click', (e) => {
            const status = option.getAttribute('data-status');
            
            // Retirer la classe active de tous les options
            document.querySelectorAll('.status-option').forEach(opt => {
                opt.classList.remove('active');
            });
            
            // Ajouter la classe active à l'option sélectionnée
            option.classList.add('active');
            
            // Mettre à jour l'indicator et le texte
            const indicator = document.getElementById('profileStatusIndicator');
            const statusText = document.getElementById('profileStatusText');
            
            indicator.className = `status-indicator ${status}`;
            
            if (status === 'online') {
                statusText.textContent = 'En ligne';
            } else if (status === 'busy') {
                statusText.textContent = 'Occupé';
            } else if (status === 'away') {
                statusText.textContent = 'Absent';
            }
            
            showToast(`Statut: ${statusText.textContent}`, 'success');
        });
    });

    // Actions buttons
    document.getElementById('editProfileBtn')?.addEventListener('click', () => {
        showToast('Édition du profil bientôt disponible', 'info');
    });

    document.getElementById('changePasswordBtn')?.addEventListener('click', () => {
        showToast('Changement du mot de passe bientôt disponible', 'info');
    });

    // Fermer en cliquant sur l'overlay
    document.getElementById('profileSettingsOverlay')?.addEventListener('click', closeProfilePanel);
}

// Mettre à jour le profil dans le menu mobile
function updateMobileMenuProfile() {
    if (!currentUser) return;

    const fullName = `${(currentUser.firstName || '')} ${(currentUser.lastName || '')}`.trim() || currentUser.name || 'Utilisateur';
    const initials = (currentUser.firstName?.charAt(0) || '') + (currentUser.lastName?.charAt(0) || '') || 'U';
    const avatarImage = getAvatarImage(currentUser);

    // Mettre à jour l'avatar
    const mobileMenuProfileAvatar = document.getElementById('mobileMenuProfileAvatar');
    if (mobileMenuProfileAvatar) {
        if (avatarImage) {
            mobileMenuProfileAvatar.innerHTML = `<img src="${avatarImage}" alt="${escapeHtml(fullName)}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
        } else {
            mobileMenuProfileAvatar.textContent = initials.toUpperCase();
        }
    }
    const MenuProfileAvatar = document.getElementById('MenuProfileAvatar');
    if (MenuProfileAvatar) {
        if (avatarImage) {
            MenuProfileAvatar.innerHTML = `<img src="${avatarImage}" alt="${escapeHtml(fullName)}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
        } else {
            MenuProfileAvatar.textContent = initials.toUpperCase();
        }
    }

    // Mettre à jour le nom
    const MenuProfileName = document.getElementById('MenuProfileName');
    if (MenuProfileName) {
        MenuProfileName.textContent = fullName;
    }
    const mobileMenuProfileName = document.getElementById('mobileMenuProfileName');
    if (mobileMenuProfileName) {
        mobileMenuProfileName.textContent = fullName;
    }
}

// Mettre à jour le bouton profil dans le footer
function updateProfileButton() {
    if (!currentUser) return;

    const fullName = `${(currentUser.firstName || '')} ${(currentUser.lastName || '')}`.trim() || currentUser.name || 'Utilisateur';
    const initials = (currentUser.firstName?.charAt(0) || '') + (currentUser.lastName?.charAt(0) || '') || 'U';
    const avatarImage = getAvatarImage(currentUser);
    const userStatus = currentUser.status || 'online'; // online, busy, away

    // Mettre à jour l'avatar
    const profileBtnAvatar = document.getElementById('profileBtnAvatar');
    if (profileBtnAvatar) {
        if (avatarImage) {
            profileBtnAvatar.innerHTML = `<img src="${avatarImage}" alt="${escapeHtml(fullName)}" style="width: 100%; height: 100%; object-fit: cover;">`;
        } else {
            profileBtnAvatar.textContent = initials.toUpperCase();
        }
    }

    // Mettre à jour le nom
    const profileBtnName = document.getElementById('profileBtnName');
    if (profileBtnName) {
        profileBtnName.textContent = fullName;
    }

    // Mettre à jour le statut
    const profileBtnStatus = document.getElementById('profileBtnStatus');
    const statusDot = document.querySelector('.profile-btn-status .status-dot');
    
    if (profileBtnStatus) {
        if (userStatus === 'online') {
            profileBtnStatus.textContent = 'En ligne';
        } else if (userStatus === 'busy') {
            profileBtnStatus.textContent = 'Occupé';
        } else if (userStatus === 'away') {
            profileBtnStatus.textContent = 'Absent';
        } else {
            profileBtnStatus.textContent = 'En ligne';
        }
    }

    // Mettre à jour le point de couleur du statut
    if (statusDot) {
        statusDot.className = `status-dot ${userStatus}`;
    }
}

// Fermer le panel profil
function closeProfilePanel() {
    const panel = document.getElementById('profilePanel');
    const overlay = document.getElementById('profileSettingsOverlay');
    
    if (panel) panel.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
}

// Event listeners pour le panel paramètres
function setupSettingsPanelListeners() {
    // Fermer le panel
    document.getElementById('closeSettingsBtn')?.addEventListener('click', closeSettingsPanel);
    document.getElementById('backSettingsBtn')?.addEventListener('click', closeSettingsPanel);

    // Toggle switches
    document.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
            const id = e.target.id;
            const isChecked = e.target.checked;
            
            // Stocker les préférences en localStorage
            localStorage.setItem(`setting_${id}`, isChecked);
            
            // Log pour debug
            console.log(`Paramètre ${id}: ${isChecked}`);
        });
    });

    // Theme selector
    const themeSelect = document.getElementById('themeSelect');
    if (themeSelect) {
        themeSelect.addEventListener('change', (e) => {
            const theme = e.target.value;
            localStorage.setItem('theme', theme);
            
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else if (theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            showToast(`Thème: ${theme}`, 'success');
        });
    }

    // Font size range
    const fontSizeRange = document.getElementById('fontSizeRange');
    const fontSizeValue = document.getElementById('fontSizeValue');
    
    if (fontSizeRange) {
        fontSizeRange.addEventListener('input', (e) => {
            const size = e.target.value;
            fontSizeValue.textContent = size + 'px';
            document.documentElement.style.fontSize = size + 'px';
            localStorage.setItem('fontSize', size);
        });
    }

    // Action buttons
    document.getElementById('clearCacheBtn')?.addEventListener('click', () => {
        if (confirm('Êtes-vous sûr de vouloir vider le cache?')) {
            localStorage.clear();
            showToast('Cache vidé avec succès', 'success');
        }
    });

    document.getElementById('downloadDataBtn')?.addEventListener('click', () => {
        showToast('Téléchargement des données bientôt disponible', 'info');
    });

    document.getElementById('deleteAccountBtn')?.addEventListener('click', () => {
        if (confirm('Êtes-vous ABSOLUMENT sûr? Cette action est irréversible!')) {
            showToast('Suppression du compte bientôt disponible', 'info');
        }
    });

    // Fermer en cliquant sur l'overlay
    document.getElementById('profileSettingsOverlay')?.addEventListener('click', closeSettingsPanel);
}

// Fermer le panel paramètres
function closeSettingsPanel() {
    const panel = document.getElementById('settingsPanel');
    const overlay = document.getElementById('profileSettingsOverlay');
    
    if (panel) panel.classList.remove('active');
    if (overlay) overlay.classList.remove('active');
}

// ========================================
// GESTION DES ACTIONS SUR LES MESSAGES
// ========================================

function toggleMessageActions(event, messageId) {
    event.stopPropagation();
    
    // Assurer que messageId est bien une string
    if (typeof messageId !== 'string' || !messageId.trim()) {
        console.error('toggleMessageActions: invalid messageId', messageId);
        return;
    }
    
    const menu = document.getElementById(`actions-${messageId}`);
    const chevronBtn = event.target.closest('.btn-message-actions');
    if (!menu) {
        console.warn('Menu not found with ID:', `actions-${messageId}`);
        return;
    }
    
    const messageWrapper = menu.closest('.message-wrapper');
    const wasShown = menu.classList.contains('show');
    
    // Fermer tous les autres menus
    document.querySelectorAll('.message-actions-menu').forEach(m => {
        m.classList.remove('show');
        const btn = m.closest('.message-actions-dropdown')?.querySelector('.btn-message-actions');
        if (btn) {
            btn.classList.remove('open');
        }
        const wrapper = m.closest('.message-wrapper');
        if (wrapper) {
            wrapper.style.zIndex = 'auto';
        }
    });
    
    // Fermer les pickers emoji
    document.querySelectorAll('.emoji-reactions-picker').forEach(p => {
        p.classList.remove('show');
    });
    
    if (!wasShown) {
        menu.classList.add('show');
        if (chevronBtn) {
            chevronBtn.classList.add('open');
        }
        // Augmenter z-index du message-wrapper pour sortir du stacking context
        if (messageWrapper) {
            messageWrapper.style.zIndex = '9999';
        }
    } else {
        if (chevronBtn) {
            chevronBtn.classList.remove('open');
        }
    }
}

function editMessage(messageId) {
    const message = messages.find(m => m.id === messageId);
    if (!message) return;
    
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
        messageInput.value = message.content;
        messageInput.focus();
        
        // Marquer qu'on est en édition
        messageInput.dataset.editingMessageId = messageId;
        
        // Ajouter un badge "Édition..."
        const inputContainer = messageInput.parentElement;
        if (!inputContainer.querySelector('.editing-badge')) {
            const badge = document.createElement('span');
            badge.className = 'editing-badge';
            badge.textContent = `Édition du message...`;
            inputContainer.appendChild(badge);
        }
    }
    
    // Fermer le menu
    const menu = document.getElementById(`actions-${messageId}`);
    if (menu) {
        menu.classList.remove('show');
        const wrapper = menu.closest('.message-wrapper');
        if (wrapper) wrapper.style.zIndex = 'auto';
    }
}

function deleteMessage(messageId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce message ?')) return;
    
    const messageIndex = messages.findIndex(m => m.id === messageId);
    if (messageIndex === -1) return;
    
    // Marquer comme supprimé
    messages[messageIndex].deletedAt = new Date().toISOString();
    messages[messageIndex].content = '[Message supprimé]';
    
    // Mettre à jour en base de données
    const message = messages[messageIndex];
    fetch(`${window.storage.API_URL}/chat/conversations/${currentConversationId}/messages/${messageId}`, {
        method: 'DELETE',
        headers: {
            'Authorization': `Bearer ${getAuthToken()}`,
            'Content-Type': 'application/json'
        }
    }).catch(err => console.error('Erreur suppression:', err));
    
    // Rafraîchir l'affichage
    renderMessages(messages);
    
    // Fermer le menu
    const menu = document.getElementById(`actions-${messageId}`);
    if (menu) {
        menu.classList.remove('show');
        const wrapper = menu.closest('.message-wrapper');
        if (wrapper) wrapper.style.zIndex = 'auto';
    }
}

function replyToMessage(message) {
    if (!message) return;
    if (typeof message === 'string') {
        message = messages.find(m => m.id === message);
        if (!message) return;
    }
    
    // D'abord, enlever le marquage de tous les autres messages
    document.querySelectorAll('.message-being-replied').forEach(el => {
        el.classList.remove('message-being-replied');
    });
    
    // Marquer le nouveau message à répondre
    const messageWrapper = document.querySelector(`[data-message-id="${message.id}"]`);
    if (messageWrapper) {
        messageWrapper.classList.add('message-being-replied');
    }
    
    // Afficher la section de réponse dans le message-input-container
    const replyPreview = document.getElementById('replyPreview');
    if (replyPreview) {
        const sender = currentConversation?.participants?.find(p => p.userId === message.senderId);
        const senderName = sender?.name || sender?.email || 'Utilisateur';
        
        // Créer le contenu du preview
        let replyContent = message.content || '';
        if (message.type === 'image') {
            replyContent = '📷 Image';
            if (message.caption) replyContent += ` - ${message.caption}`;
        } else if (message.type === 'file') {
            replyContent = `📎 ${message.fileName || 'Fichier'}`;
        }
        
        replyPreview.innerHTML = `
            <div class="reply-preview-content">
                <div class="reply-info">
                    <span class="reply-sender">↳ ${escapeHtml(senderName)}</span>
                    <button onclick="cancelReply()" class="btn-cancel-reply" title="Annuler la réponse">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="reply-text">${escapeHtml(replyContent)}</div>
            </div>
        `;
        replyPreview.style.display = 'flex';
    }
    
    // Stocker le messageId à répondre
    document.getElementById('messageInput').dataset.replyToId = message.id;
    document.getElementById('messageInput').focus();
    
    console.log('📝 Reply to message:', message.id);
}

function cancelReply() {
    // Enlever le marquage du message
    document.querySelectorAll('.message-being-replied').forEach(el => {
        el.classList.remove('message-being-replied');
    });
    
    // Masquer le preview
    const replyPreview = document.getElementById('replyPreview');
    if (replyPreview) {
        replyPreview.style.display = 'none';
        replyPreview.innerHTML = '';
    }
    
    // Réinitialiser les données
    document.getElementById('messageInput').dataset.replyToId = '';
    
    console.log('❌ Reply cancelled');
}

// Wrapper pour copier le message par messageId
function copyMessageContent(messageId) {
    const message = messages.find(m => m.id === messageId);
    if (!message) return;
    
    const textToCopy = message.content || '';
    navigator.clipboard.writeText(textToCopy)
        .then(() => {
            showToast('Message copié', 'success');
        })
        .catch(err => {
            console.error('Erreur copie:', err);
            showToast('Impossible de copier', 'error');
        });
    
    // Fermer le menu
    const menu = document.getElementById(`actions-${messageId}`);
    if (menu) menu.classList.remove('show');
}

// Wrapper pour transférer le message par messageId
function forwardMessageContent(messageId) {
    const message = messages.find(m => m.id === messageId);
    if (!message) return;
    
    // Ouvrir modal de transfert si la fonction existe
    if (typeof showForwardMessageModal === 'function') {
        showForwardMessageModal(message);
    } else {
        showToast('Fonction de transfert non disponible', 'info');
    }
    
    // Fermer le menu
    const menu = document.getElementById(`actions-${messageId}`);
    if (menu) menu.classList.remove('show');
}

// ========================================
// GESTION DES RÉACTIONS EMOJI
// ========================================
function toggleMessageEmojiPicker() {
    const container = document.getElementById('emojiPickerContainer');
    if (container) {
        container.classList.toggle('show');
    }
}

function toggleEmojiPicker(messageId) {
    const picker = document.getElementById(`emoji-picker-${messageId}`);
    
    if (!picker) {
        return;
    }
    
    picker.classList.toggle('show');
    
    // Fermer les autres pickers
    document.querySelectorAll('.emoji-reactions-picker').forEach(p => {
        if (p.id !== `emoji-picker-${messageId}`) {
            p.classList.remove('show');
        }
    });
    
    // Fermer les menus actions aussi
    document.querySelectorAll('.message-actions-menu').forEach(m => {
        m.classList.remove('show');
    });
}

// ⚠️ DUPLICATE REMOVED - See unified version above at line 7898

function cancelReply() {
    const replyPreview = document.getElementById('replyPreview');
    if (replyPreview) {
        replyPreview.style.display = 'none';
        replyPreview.innerHTML = '';
    }
    
    document.getElementById('messageInput').dataset.replyToId = '';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// ✅ Appliquer le filtre rapide sur les conversations
function applyConversationFilter(filterType) {
    const searchInput = document.getElementById('conversationsSearch');
    const searchTerm = searchInput?.value.toLowerCase().trim() || '';
    
    let filtered = conversations;
    
    // Appliquer le filtre rapide
    switch(filterType) {
        case 'all':
            // Afficher toutes les conversations
            filtered = conversations;
            break;
        case 'online':
            // Afficher uniquement les conversations avec des utilisateurs en ligne
            filtered = conversations.filter(conv => {
                if (!conv.participants || conv.participants.length === 0) return false;
                // Au moins un participant autre que l'utilisateur actuel est en ligne
                return conv.participants.some(p => 
                    p.userId !== currentUser?.id && p.isOnline === true
                );
            });
            break;
        case 'unread':
            // Afficher uniquement les conversations non lues
            filtered = conversations.filter(conv => (conv.unreadCount || 0) > 0);
            break;
        case 'direct':
            // Afficher uniquement les conversations directes
            filtered = conversations.filter(conv => conv.type === 'direct');
            break;
        case 'group':
            // Afficher uniquement les conversations de groupe
            filtered = conversations.filter(conv => conv.type === 'group');
            break;
        case 'archived':
            // Afficher uniquement les conversations archivées
            filtered = conversations.filter(conv => conv.archived === true);
            break;
        default:
            filtered = conversations;
    }
    
    // Appliquer aussi la recherche si elle existe
    if (searchTerm.length > 0) {
        filtered = filtered.filter(conversation => {
            let conversationName = conversation.name || '';
            if (conversation.type === 'direct' && conversation.participants) {
                const otherParticipants = conversation.participants.filter(p => p.userId !== currentUser?.id);
                if (otherParticipants.length > 0) {
                    const firstParticipant = otherParticipants[0];
                    conversationName = firstParticipant.name || firstParticipant.email || 'Utilisateur';
                }
            }
            
            const lastMessage = conversation.lastMessage || conversation.messages?.[conversation.messages?.length - 1];
            const lastMessageContent = lastMessage?.content || '';
            
            const participantsText = conversation.participants?.map(p => 
                p.name || p.email
            ).join(' ') || '';
            
            const searchText = (
                conversationName + ' ' + 
                lastMessageContent + ' ' + 
                participantsText
            ).toLowerCase();
            
            return searchText.includes(searchTerm);
        });
    }
    
    renderConversationsList(filtered);
}

function filterConversations() {
    const searchInput = document.getElementById('conversationsSearch');
    if (!searchInput) return;
    
    // Obtenir le filtre actuellement actif
    const activeFilter = document.querySelector('.filter-btn.active');
    const filterType = activeFilter?.dataset.filter || 'all';
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    if (searchTerm.length === 0) {
        applyConversationFilter(filterType);
        return;
    }
    
    // Appliquer le filtre courant et la recherche
    applyConversationFilter(filterType);
}

function closeEmojiPickerOutside(e) {
    const pickerContainer = document.getElementById('emojiPickerContainer');
    const emojiBtn = document.getElementById('emojiBtn');
    
    if (pickerContainer && 
        !pickerContainer.contains(e.target) && 
        !emojiBtn.contains(e.target)) {
        pickerContainer.classList.remove('show');
    }
}

// Afficher le skeleton loader pour conversations
function showSkeletonConversations() {
    const container = document.getElementById('conversationsList');
    if (!container) return;
    
    const skeletons = Array(6).fill(0).map(() => `
        <div class="skeleton-conversation">
            <div class="skeleton-conversation-avatar"></div>
            <div class="skeleton-conversation-content" style="flex: 1; width: 100%;">
                <div class="skeleton-conversation-name"></div>
                <div class="skeleton-conversation-preview"></div>
            </div>
            <div class="skeleton-conversation-time"></div>
        </div>
    `).join('');
    
    container.innerHTML = `<div class="skeleton-loader-container">${skeletons}</div>`;
}

// Afficher le skeleton loader pour messages
function showSkeletonMessages() {
    const container = document.getElementById('messagesContainer');
    if (!container) return;
    
    // Créer le wrapper des messages s'il n'existe pas
    let messagesWrapper = document.getElementById('messagesWrapper');
    if (!messagesWrapper) {
        messagesWrapper = document.createElement('div');
        messagesWrapper.id = 'messagesWrapper';
        messagesWrapper.style.display = 'flex';
        messagesWrapper.style.flexDirection = 'column';
        messagesWrapper.style.flex = '1';
        messagesWrapper.style.overflowY = 'auto';
        messagesWrapper.style.paddingBottom = '20px';
        container.appendChild(messagesWrapper);
    }
    
    // Générer les skeletons avec alternance incoming/outgoing
    const skeletons = Array(8).fill(0).map((_, i) => {
        const isOutgoing = i % 2 === 0;
        return `
            <div class="skeleton-message ${isOutgoing ? 'outgoing' : 'incoming'}">
                <div class="skeleton-message-avatar"></div>
                <div class="skeleton-message-content">
                    <div class="skeleton-message-bubble"></div>
                    <div class="skeleton-message-time"></div>
                </div>
            </div>
        `;
    }).join('');
    
    messagesWrapper.innerHTML = `<div class="skeleton-loader-container">${skeletons}</div>`;
}

// Version legacy pour compatibilité
function showLoader(type) {
    switch (type) {
        case 'conversations':
            showSkeletonConversations();
            break;
        case 'messages':
            showSkeletonMessages();
            break;
    }
}

function hideLoader(type) {
    // Les skeletons sont remplacés par le contenu réel, rien à faire
    // Cette fonction reste pour la compatibilité avec le code existant
}

function showToast(message, type = 'info') {
    const colors = {
        success: '#10B981',
        error: '#EF4444',
        warning: '#F59E0B',
        info: '#3B82F6'
    };
    
    Toastify({
        text: message,
        duration: 3000,
        gravity: "top",
        position: "right",
        backgroundColor: colors[type] || colors.info,
        stopOnFocus: true,
    }).showToast();
}

function handleOutsideClick(e) {
    // Fermer le menu contextuel des messages
    const contextMenu = document.getElementById('messageContextMenu');
    if (contextMenu && contextMenu.style.display === 'block' && !contextMenu.contains(e.target)) {
        hideMessageContextMenu();
    }
    
    // Fermer le menu de réactions
    const reactionMenu = document.getElementById('reactionModal');
    if (reactionMenu && reactionMenu.style.display === 'flex' && !reactionMenu.contains(e.target)) {
        hideReactionMenu();
    }
    
    // Fermer le picker emoji
    const emojiPicker = document.getElementById('emojiPickerContainer');
    const emojiBtn = document.getElementById('emojiBtn');
    if (emojiPicker && emojiPicker.classList.contains('show') && 
        !emojiPicker.contains(e.target) && 
        (!emojiBtn || !emojiBtn.contains(e.target))) {
        emojiPicker.classList.remove('show');
    }
}

// ==========================================
// GESTION DU DÉFILEMENT INFINI
// ==========================================

function setupInfiniteScroll() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (!messagesContainer) return;
    
    messagesContainer.addEventListener('scroll', () => {
        // Ne charger que si on est en mode chat (pas en appel)
        if (currentCallState !== null) return;
        
        // Charger plus de messages quand l'utilisateur atteint le haut
        if (messagesContainer.scrollTop < 100 && messages.length > 0) {
            loadMoreMessages();
        }
    });
}

async function loadMoreMessages() {
    // Éviter les chargements multiples simultanés
    if (uploadInProgress || !currentConversationId) return;
    
    uploadInProgress = true;
    messagePage++;
    
    try {
        await loadMessages(currentConversationId, true);
    } catch (error) {
        console.error('Erreur lors du chargement des anciens messages:', error);
        messagePage--; // Revenir à la page précédente en cas d'erreur
    } finally {
        uploadInProgress = false;
    }
}

// ==========================================
// INITIALISATION FINALE
// ==========================================

// Ajouter les écouteurs d'événements finaux
document.addEventListener('DOMContentLoaded', () => {
    // Initialiser le défilement infini
    setupInfiniteScroll();
    
    // Bouton pour démarrer une nouvelle conversation
    document.getElementById('startNewConversationBtn')?.addEventListener('click', openConversationPanel);
    
    // Gestion de la visibilité de la page
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible' && currentConversationId) {
            // Marquer les messages comme lus quand l'utilisateur revient sur la page
            markConversationAsRead(currentConversationId);
        }
    });
    
    window.addEventListener('beforeunload', () => {
        emitStopTypingEvent();
    });
});

// ==========================================
// STYLES SUPPLEMENTAIRES
// ==========================================

const additionalStyles = `
    <style>
        /* Styles pour les avatars */
        .conversation-avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .user-avatar-small {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
        }
        
        .chat-avatar-large {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.5rem;
        }
        
    </style>
`;

// Ajouter les styles supplémentaires au document
document.head.insertAdjacentHTML('beforeend', additionalStyles);

// ==========================================
// GESTION DE L'ÉTAT DE CONNEXION
// ==========================================

// Mettre à jour le statut de connexion
function updateConnectionStatus() {
    const indicator = document.getElementById('connectionIndicator');

    
    if (!indicator) return;
    
    if (isServerOnline) {
        indicator.classList.remove('offline');
        indicator.classList.add('online');
        indicator.textContent = ' En ligne';
        indicator.title = 'Serveur en ligne';
    } else {
        indicator.classList.remove('online');
        indicator.classList.add('offline');
        indicator.textContent = 'Hors ligne';
        indicator.title = 'Serveur indisponible';
    }
}

// Gestion de la fenêtre quand elle redevient active
window.addEventListener('focus', async () => {
    console.log('🔄 Page redevenue active - Tentative de synchronisation');
    if (!isServerOnline) {
        connectionRetryCount = 0;
        try {
            const sessionResult = await window.storage.getCurrentSessionDetails();
            if (sessionResult?.success) {
                isServerOnline = true;
                connectionRetryCount = 0;
                clearInterval(connectionRetryInterval);
                showConnectionStatus(true);
                await loadConversations(true);
                showToast('Serveur restauré - Données synchronisées', 'success');
            }
        } catch (error) {
            console.log('❌ Serveur toujours hors ligne');
        }
    }
});

// ==========================================
// GESTION DES PANNEAUX RESPONSIFS (Mobile)
// ==========================================

// Initialiser le panel conversations avec la bonne classe au chargement
function initializePanelStates() {
    const conversationsPanel = document.getElementById('conversationsPanel');
    const chatMain = document.getElementById('chatMain');
    
    if (window.innerWidth <= 768) {
        // Sur mobile: le panel conversations est visible par défaut
        if (conversationsPanel) {
            conversationsPanel.classList.add('visible');
            conversationsPanel.classList.remove('hidden');
        }
        
        // Le chat est caché par défaut
        if (chatMain) {
            chatMain.classList.remove('active', 'hidden');
        }
    }
}

// Ajouter un écouteur pour le resize window
window.addEventListener('resize', () => {
    const conversationsPanel = document.getElementById('conversationsPanel');
    const chatMain = document.getElementById('chatMain');
    
    if (window.innerWidth > 768) {
        // Sur grand écran: TOUJOURS montrer les deux (jamais fermer le panel)
        if (conversationsPanel) {
            conversationsPanel.classList.remove('visible', 'hidden');
            conversationsPanel.style.display = 'flex'; // S'assurer qu'il est visible
        }
        if (chatMain) {
            chatMain.classList.remove('active', 'hidden');
            chatMain.style.display = 'flex'; // S'assurer qu'il est visible
        }
    } else {
        // Sur mobile: adapter selon l'état (aucune action automatique, laisser le toggle décider)
        // Ne rien faire - laisser les classes visible/hidden décider
    }
});

// Gérer le clic sur le bouton toggle
const toggleConversationsBtn = document.getElementById('toggleConversationsBtn');
if (toggleConversationsBtn) {
    toggleConversationsBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const conversationsPanel = document.getElementById('conversationsPanel');
        const chatMain = document.getElementById('chatMain');
        
        if (conversationsPanel && chatMain) {
            // Afficher le panel et masquer le chat
            conversationsPanel.classList.add('visible');
            conversationsPanel.classList.remove('hidden');
            
            chatMain.classList.remove('active');
            chatMain.classList.add('hidden');
        }
    });
}

// Initialiser les états des panneaux quand le DOM est prêt
document.addEventListener('DOMContentLoaded', () => {
    initializePanelStates();
});

// ==========================================
// 🎤 FONCTIONS D'APPELS (PLACEHOLDERS)
// ==========================================

/**
 * Système de gestion des états de vue
 * Gère les transitions fluides entre: conversation -> audio/vidéo -> conversation
 */

// Variables globales pour l'état des appels
let currentCallState = null; // 'audio' | 'video' | null
let callStartTime = null;

/**
 * Obtenir l'état actuel de la vue
 */
function getCurrentViewState() {
    const audioCallState = document.getElementById('audioCallState');
    const videoCallState = document.getElementById('videoCallState');
    const messagesWrapper = document.getElementById('messagesWrapper');
    
    if (audioCallState?.style.display !== 'none') return 'audio';
    if (videoCallState?.style.display !== 'none') return 'video';
    if (messagesWrapper?.style.display !== 'none') return 'chat';
    return null;
}

/**
 * Afficher une vue spécifique et masquer les autres
 */
function switchViewState(newState) {
    const audioCallState = document.getElementById('audioCallState');
    const videoCallState = document.getElementById('videoCallState');
    const messagesWrapper = document.getElementById('messagesWrapper');
    const noMessagesState = document.getElementById('noMessagesState');
    const noConversationSelected = document.getElementById('noConversationSelected');
    const chatInputArea = document.getElementById('chatInputArea');
    const messagesContainer = document.getElementById('messagesContainer');
    
    // D'abord masquer tout
    if (audioCallState) audioCallState.style.display = 'none';
    if (videoCallState) videoCallState.style.display = 'none';
    if (messagesWrapper) messagesWrapper.style.display = 'none';
    if (noMessagesState) noMessagesState.style.display = 'none';
    if (noConversationSelected) noConversationSelected.style.display = 'none';
    
    // Puis afficher l'état souhaité
    switch (newState) {
        case 'audio':
            if (audioCallState) {
                audioCallState.style.display = 'flex';
                currentCallState = 'audio';
            }
            // Désactiver le scroll (pas pointer-events, le container est parent!)
            if (messagesContainer) {
                messagesContainer.style.overflowY = 'hidden';
                messagesContainer.style.overflowX = 'hidden';
            }
            if (chatInputArea) chatInputArea.style.display = 'none';
            break;
            
        case 'video':
            if (videoCallState) {
                videoCallState.style.display = 'flex';
                currentCallState = 'video';
            }
            // Désactiver le scroll (pas pointer-events, le container est parent!)
            if (messagesContainer) {
                messagesContainer.style.overflowY = 'hidden';
                messagesContainer.style.overflowX = 'hidden';
            }
            if (chatInputArea) chatInputArea.style.display = 'none';
            break;
            
        case 'chat':
            // Réactiver le scroll
            if (messagesContainer) {
                messagesContainer.style.overflowY = 'auto';
                messagesContainer.style.overflowX = 'hidden';
            }
            // Afficher les messages ou le placeholder
            if (messagesWrapper) {
                messagesWrapper.style.display = 'flex';
                // Afficher le bon placeholder selon le contexte
                if (messages && messages.length === 0) {
                    if (noMessagesState) noMessagesState.style.display = 'flex';
                } else if (messagesWrapper.innerHTML.trim() === '') {
                    if (noMessagesState) noMessagesState.style.display = 'flex';
                }
            }
            if (chatInputArea) chatInputArea.style.display = 'flex';
            currentCallState = null;
            break;
            
        case 'empty':
            if (noConversationSelected) {
                noConversationSelected.style.display = 'flex';
            }
            if (chatInputArea) chatInputArea.style.display = 'none';
            if (messagesContainer) {
                messagesContainer.style.overflowY = 'auto';
                messagesContainer.style.overflowX = 'hidden';
            }
            currentCallState = null;
            break;
    }
}

/**
 * Démarrer un appel audio
 * Affiche l'interface d'appel audio et change l'état
 */
function startAudioCall() {
    if (!currentConversationId) return;

    const audioCallState = document.getElementById('audioCallState');
    
    // Utiliser le nouveau système d'états
    switchViewState('audio');
    
    // Initialiser l'appel
    callStartTime = Date.now();
    
    if (audioCallState && currentConversation?.type === 'direct' && currentConversation?.participants) {
        const otherParticipant = currentConversation.participants.find(p => p.userId !== currentUser?.id);
        if (otherParticipant) {
            const callName = document.getElementById('callName');
            const callAvatar = document.getElementById('callAvatar');
            if (callName) callName.textContent = otherParticipant.name || otherParticipant.email;
            if (callAvatar) {
                const avatarUrl = getGuestAvatarImage(otherParticipant);
                callAvatar.innerHTML = avatarUrl 
                    ? `<img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`
                    : `<i class="fas fa-user"></i>`;
            }
        }
    }
    
    showToast('Appel audio démarré', 'info');
}

/**
 * Terminer l'appel audio et retourner à la conversation
 */
function endAudioCall() {
    currentCallState = null;
    callStartTime = null;
    switchViewState('chat');
    renderMessages(messages);
    showToast('Appel audio terminé', 'info');
}

/**
 * Démarrer un appel vidéo
 */
function startVideoCall() {
    if (!currentConversationId) return;
    
    const videoCallState = document.getElementById('videoCallState');
    
    // Utiliser le nouveau système d'états
    switchViewState('video');
    
    // Initialiser l'appel
    callStartTime = Date.now();
    
    if (videoCallState && currentConversation?.type === 'direct' && currentConversation?.participants) {
        const otherParticipant = currentConversation.participants.find(p => p.userId !== currentUser?.id);
        if (otherParticipant) {
            const callName = document.getElementById('videoCallName');
            const callAvatar = document.getElementById('videoCallAvatar');
            if (callName) callName.textContent = otherParticipant.name || otherParticipant.email;
            if (callAvatar) {
                const avatarUrl = getGuestAvatarImage(otherParticipant);
                callAvatar.innerHTML = avatarUrl 
                    ? `<img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`
                    : `<i class="fas fa-user"></i>`;
            }
        }
    }
    
    showToast('Appel vidéo démarré', 'info');
}

/**
 * Terminer l'appel vidéo et retourner à la conversation
 */
function endVideoCall() {
    currentCallState = null;
    callStartTime = null;
    switchViewState('chat');
    renderMessages(messages);
    showToast('Appel vidéo terminé', 'info');
}

/**
 * Basculer le microphone en appel audio
 */
function toggleMute() {
    const btn = document.getElementById('muteBtn');
    if (!btn) return;
    
    btn.classList.toggle('active');
    const isMuted = btn.classList.contains('active');
    btn.innerHTML = isMuted 
        ? '<i class="fas fa-microphone-slash"></i>'
        : '<i class="fas fa-microphone"></i>';
    
    showToast(isMuted ? 'Microphone désactivé' : 'Microphone activé', 'info');
}

/**
 * Basculer le haut-parleur en appel audio
 */
function toggleSpeaker() {
    const btn = document.getElementById('speakerBtn');
    if (!btn) return;
    
    btn.classList.toggle('active');
    const isSpeaker = btn.classList.contains('active');
    btn.innerHTML = isSpeaker 
        ? '<i class="fas fa-volume-up"></i>'
        : '<i class="fas fa-volume-down"></i>';
    
    showToast(isSpeaker ? 'Haut-parleur activé' : 'Haut-parleur désactivé', 'info');
}

/**
 * Basculer le microphone en appel vidéo
 */
function toggleVideoMute() {
    const btn = document.getElementById('videoMuteBtn');
    if (!btn) return;
    
    btn.classList.toggle('active');
    const isMuted = btn.classList.contains('active');
    btn.innerHTML = isMuted 
        ? '<i class="fas fa-microphone-slash"></i>'
        : '<i class="fas fa-microphone"></i>';
    
    showToast(isMuted ? 'Microphone désactivé' : 'Microphone activé', 'info');
}

/**
 * Basculer la caméra en appel vidéo
 */
function toggleCamera() {
    const btn = document.getElementById('cameraBtn');
    if (!btn) return;
    
    btn.classList.toggle('active');
    const isCameraOff = btn.classList.contains('active');
    btn.innerHTML = isCameraOff 
        ? '<i class="fas fa-video-slash"></i>'
        : '<i class="fas fa-video"></i>';
    
    showToast(isCameraOff ? 'Caméra désactivée' : 'Caméra activée', 'info');
}

/**
 * Basculer le haut-parleur en appel vidéo
 */
function toggleVideoSpeaker() {
    const btn = document.getElementById('videoSpeakerBtn');
    if (!btn) return;
    
    btn.classList.toggle('active');
    const isSpeaker = btn.classList.contains('active');
    btn.innerHTML = isSpeaker 
        ? '<i class="fas fa-volume-up"></i>'
        : '<i class="fas fa-volume-down"></i>';
    
    showToast(isSpeaker ? 'Haut-parleur activé' : 'Haut-parleur désactivé', 'info');
}

/**
 * Fermer la conversation courante
 */
function closeConversation() {
    // Émettre l'événement leave si une conversation est active
    if (currentConversationId && chatSocket) {
        chatSocket.emit('conversation:leave', {
            conversationId: currentConversationId
        });
    }
    
    // Réinitialiser les données
    currentConversationId = null;
    currentConversation = null;
    messages = [];
    messagePage = 1;
    
    // Masquer le header et la zone de chat
    hideChatArea();
    
    // Re-appliquer le filtre actif
    filterConversations();
    renderConversationsList(conversations);
    
}

/**
 * Supprimer la conversation courante
 */
function showDeleteConversationDialog(conversationId) {
    const conversation = conversations.find(c => c.id === conversationId);
    if (!conversation) return;
    
    // Déterminer le nom de la conversation
    let conversationName = conversation.name || 'Chat';
    if (conversation.type === 'direct' && conversation.participants) {
        const otherParticipants = conversation.participants.filter(p => p.userId !== currentUser?.id);
        if (otherParticipants.length > 0) {
            conversationName = otherParticipants[0].name || otherParticipants[0].email || 'Utilisateur';
        }
    }
    
    // Afficher la confirmation avec SweetAlert2
    Swal.fire({
        title: 'Supprimer cette conversation ?',
        html: `<p>Êtes-vous sûr de vouloir supprimer la conversation avec <strong>${escapeHtml(conversationName)}</strong> ?</p>
               <p style="margin-top: 12px; font-size: 0.9rem; color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> Cette action est irréversible.</p>`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Oui, supprimer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#dc2626',
        cancelButtonColor: '#6b7280',
        didOpen: (modal) => {
            // Appliquer les styles du thème sombre
            modal.style.backgroundColor = 'var(--card-bg)';
            const title = modal.querySelector('.swal2-title');
            const content = modal.querySelector('.swal2-html-container');
            if (title) title.style.color = 'var(--text-color)';
            if (content) content.style.color = 'var(--text-color)';
        }
    }).then((result) => {
        if (result.isConfirmed) {
            deleteConversation(conversationId);
        }
    });
}

// Supprimer une conversation
async function deleteConversation(conversationId) {
    try {
        // Afficher le spinner
        Swal.fire({
            title: 'Suppression en cours...',
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: async (modal) => {
                Swal.showLoading();
                
                try {
                    // Appeler l'API pour supprimer
                    const response = await fetch(
                        `${window.storage.API_URL}/chat/conversations/${conversationId}`,
                        {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${getAuthToken()}`,
                                'Content-Type': 'application/json'
                            }
                        }
                    );
                    
                    if (!response.ok) {
                        throw new Error('Échec de la suppression');
                    }
                    
                    const result = await response.json();
                    
                    // ✅ Émettre l'événement WebSocket pour notifier tous les utilisateurs
                    if (chatSocket && chatSocket.connected) {
                        console.log('📡 WebSocket: Émission de la suppression de conversation...');
                        chatSocket.emit('conversation:deleted', {
                            conversationId,
                            deletedBy: currentUser?.id || 'anonymous',
                            timestamp: new Date()
                        });
                    }
                    
                    // Fermer la conversation localement
                    currentConversationId = null;
                    currentConversation = null;
                    messages = [];
                    messagePage = 1;
                    
                    // Recharger les conversations
                    await loadConversations(true);
                    
                    hideChatArea();
                    renderConversationsList(conversations);
                    
                    // Fermer le modal de confirmation
                    Swal.close();
                    
                } catch (error) {
                    console.error('❌ Erreur suppression conversation:', error);
                    Swal.close();
                    showToast('Impossible de supprimer la conversation', 'error');
                }
            }
        });
        
    } catch (error) {
        console.error('❌ Erreur suppression conversation:', error);
    }
}

// ==========================================
// EXPORT DES FONCTIONS PRINCIPALES
// ==========================================

// Exposer les fonctions principales pour le débogage
window.chatManager = {
    loadConversations,
    selectConversation,
    sendMessage,
    uploadFile,
    replyToMessage,
    addReaction,
    openConversationPanel,
    getCurrentConversation: () => currentConversation,
    getCurrentUser: () => currentUser,
    getMessages: () => messages,
    startAudioCall,
    startVideoCall,
    endAudioCall,
    endVideoCall,
    closeConversation,
    deleteConversation
};

console.log('Chat System Initialized Successfully!');
</script>