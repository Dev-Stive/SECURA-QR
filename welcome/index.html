<!DOCTYPE html>
<html lang="fr" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SECURA - Tableau de bord événementiel intelligent">
    <title>Tableau de Bord - SECURA</title>
    
    <link rel="icon" href="../assets/images/icon.png" type="image/x-icon">
    
    <!-- Preload critical resources -->
    <link rel="preload" href="../css/styles.css" as="style">
    <link rel="preload" href="../css/dash.css" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" as="style">
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Styles locaux -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/loading.css">
    <link rel="stylesheet" href="../css/dash.css">
    <link rel="stylesheet" href="../css/toastify.css">
    <link rel="stylesheet" href="../css/index.css">
    
    <!-- SweetAlert2 -->
    <link rel="preload" href="../js/auth-check.js" as="script">
    
    <style>
        /* ==========================================
           VARIABLES GLOBALES
           ========================================== */
        :root {
            --primary: #D97706;
            --primary-dark: #B45309;
            --primary-light: #F59E0B;
            --dark: #0A0A0A;
            --dark-card: #121212;
            --dark-elevated: #1A1A1A;
            --gradient: linear-gradient(135deg, #B45309 0%, #D97706 50%, #F59E0B 100%);
            --success: #10B981;
            --danger: #EF4444;
            --warning: #F59E0B;
            --info: #3B82F6;
            --border-radius: 0.5rem;
            --border-radius-sm: 0.375rem;
            --card-shadow: 0 12px 40px rgba(0,0,0,0.4);
            
            /* Variables pour thème clair */
            --body-bg: #ffffff;
            --text-color: #333333;
            --card-bg: #f8f9fa;
            --input-bg: #ffffff;
            --input-border: #e0e0e0;
            --input-text: #333333;
            --placeholder-color: #666666;
            --border-color: rgba(0, 0, 0, 0.1);
            --hover-bg: rgba(0, 0, 0, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --progress-bg: rgba(0, 0, 0, 0.05);
        }

        /* Variables pour thème sombre */
        .dark-theme {
            --body-bg: #0A0A0A;
            --text-color: #ffffff;
            --card-bg: #121212;
            --input-bg: rgba(255, 255, 255, 0.04);
            --input-border: rgba(255, 255, 255, 0.12);
            --input-text: #ffffff;
            --placeholder-color: rgba(255, 255, 255, 0.4);
            --border-color: rgba(255, 255, 255, 0.1);
            --hover-bg: rgba(255, 255, 255, 0.05);
            --shadow-color: rgba(0, 0, 0, 0.5);
            --progress-bg: rgba(0, 0, 0, 0.2);
        }

        /* ==========================================
           STYLES DE BASE
           ========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--body-bg);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            filter: blur(25px) brightness(0.4) saturate(0.8);
            opacity: 0.3;
            z-index: -1;
            pointer-events: none;
        }

        body {
            background-image:
                radial-gradient(circle at 10% 20%, rgba(217, 119, 6, 0.15) 0%, transparent 30%),
                radial-gradient(circle at 90% 80%, rgba(217, 119, 6, 0.15) 0%, transparent 30%);
        }

        .dark-theme body {
            background-image:
                radial-gradient(circle at 10% 20%, rgba(217, 119, 6, 0.08) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(217, 119, 6, 0.08) 0%, transparent 40%);
        }

        /* ==========================================
           LAYOUT PRINCIPAL
           ========================================== */
        .dashboard-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .dashboard-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .dashboard-title h1 {
            font-size: 2rem;
            font-weight: 700;
            background: var(--gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        .dashboard-subtitle {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-top: 5px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        /* ==========================================
           BOUTONS
           ========================================== */
        .btn {
            padding: 12px 24px;
            border-radius: var(--border-radius-sm);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(217, 119, 6, 0.3);
        }

        .btn-secondary {
            background: var(--hover-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--input-bg);
            color: var(--text-color);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #0DA673;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #DC2626;
            transform: translateY(-2px);
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #2563EB;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-xs {
            padding: 6px 12px;
            font-size: 0.75rem;
            gap: 5px;
        }

        /* ==========================================
           SECTION DE BIENVENUE
           ========================================== */
        .welcome-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }

        .welcome-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .welcome-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.2rem;
            font-weight: 800;
            color: white;
            background: var(--gradient);
            flex-shrink: 0;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .welcome-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .welcome-info {
            flex: 1;
        }

        .welcome-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .welcome-subtitle {
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .table-badge-large {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(217, 119, 6, 0.15);
            border-radius: 20px;
            font-weight: 600;
            color: var(--primary);
            border: 2px solid rgba(217, 119, 6, 0.3);
        }

        /* ==========================================
           STATISTIQUES RAPIDES
           ========================================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-color);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .stat-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 10px;
            background: var(--gradient);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stat-details {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* ==========================================
           GRID DE FONCTIONNALITÉS
           ========================================== */
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .feature-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px var(--shadow-color);
            border-color: var(--primary);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .feature-card:hover .feature-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .feature-card h3 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .feature-card p {
            color: var(--text-color);
            opacity: 0.7;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        /* ==========================================
           MEMBRES DE LA TABLE
           ========================================== */
        .table-mates-section {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .section-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 0;
        }

        .mates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .mate-card {
            background: var(--hover-bg);
            border-radius: var(--border-radius-sm);
            padding: 20px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .mate-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px var(--shadow-color);
            border-color: var(--primary);
        }

        .mate-card.current-user {
            border-color: var(--primary);
            background: rgba(217, 119, 6, 0.1);
        }

        .mate-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            flex-shrink: 0;
            position: relative;
        }

        .mate-avatar.current-user::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            border: 2px solid var(--card-bg);
        }

        .mate-info {
            flex: 1;
            min-width: 0;
        }

        .mate-name {
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .mate-company {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .mate-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-present {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* ==========================================
           ÉVÉNEMENT ACTIF
           ========================================== */
        .event-details-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
            position: relative;
        }

        .event-details-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient);
        }

        .event-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }

        .event-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .event-meta-item i {
            color: var(--primary);
        }

        /* ==========================================
           CHART STATISTIQUES
           ========================================== */
        .chart-container {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            margin-bottom: 30px;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-placeholder {
            height: 300px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            opacity: 0.5;
        }

        /* ==========================================
           ÉTATS VIDES
           ========================================== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-color);
        }

        .empty-state i {
            font-size: 4rem;
            color: var(--primary);
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .empty-state p {
            margin-bottom: 30px;
            opacity: 0.7;
        }

        /* ==========================================
           LOADER
           ========================================== */
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ==========================================
           BADGES
           ========================================== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-primary {
            background: rgba(217, 119, 6, 0.2);
            color: var(--primary);
            border: 1px solid rgba(217, 119, 6, 0.3);
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.2);
            color: var(--info);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* ==========================================
           RESPONSIVE
           ========================================== */
        @media (max-width: 1200px) {
            .dashboard-container {
                padding: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .features-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .features-grid {
                grid-template-columns: 1fr;
            }
            
            .welcome-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .welcome-avatar-large {
                width: 80px;
                height: 80px;
                font-size: 1.8rem;
            }
            
            .welcome-title {
                font-size: 1.5rem;
            }
            
            .mates-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .dashboard-title h1 {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .feature-card {
                padding: 20px;
            }
            
            .feature-icon {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
        }

        /* ==========================================
           ANIMATIONS
           ========================================== */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ==========================================
           UTILITAIRES
           ========================================== */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .p-20 {
            padding: 20px;
        }

        /* ==========================================
           BOUTON DE DÉCONNEXION FIXE
           ========================================== */
        .logout-fixed-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* ==========================================
           SCROLLBAR PERSONNALISÉE
           ========================================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--hover-bg);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }

        /* ==========================================
           TEXTE TRONQUÉ
           ========================================== */
        .truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .truncate-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ==========================================
           TOOLTIPS
           ========================================== */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-card);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1000;
            pointer-events: none;
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 10px);
        }

        /* ==========================================
           TRANSITIONS
           ========================================== */
        .fade-enter {
            opacity: 0;
        }

        .fade-enter-active {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .fade-exit {
            opacity: 1;
        }

        .fade-exit-active {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        /* ==========================================
           SPLASH SCREEN
           ========================================== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--body-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            background: var(--gradient);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            animation: pulse 2s infinite;
        }

        .splash-logo img {
            width: 60px;
            height: 60px;
        }

        .splash-text {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
        }

        .splash-subtext {
            color: var(--text-color);
            opacity: 0.7;
            margin-bottom: 40px;
        }

        .splash-progress {
            width: 200px;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .splash-progress-bar {
            height: 100%;
            background: var(--gradient);
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.7);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 20px rgba(217, 119, 6, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(217, 119, 6, 0);
            }
        }
    </style>
</head>

<body class="dark-theme">
    <!-- Splash Screen -->
    <div id="splashScreen" class="splash-screen">
        <div class="splash-logo">
            <img src="../assets/images/icon.png" alt="SECURA Logo">
        </div>
        <div class="splash-text">SECURA</div>
        <div class="splash-subtext">Chargement de votre session...</div>
        <div class="splash-progress">
            <div class="splash-progress-bar" id="splashProgressBar"></div>
        </div>
    </div>

    <!-- Particles Background -->
    <div id="particles-js"></div>
    
    <!-- Top Bar -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo-icon">
                    <img src="../assets/images/icon.png" alt="logo secura">
                </div>
                <div class="logo-text">
                    <h1>SECURA</h1>
                    <p class="form-title">Tableau de Bord</p>
                </div>
            </div>
           
            <!-- Profile Button -->
            <button class="profile-toggle header-profile-btn" id="profileToggle" aria-haspopup="true" aria-expanded="false">
                <div class="profile-avatar">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div class="profile-info">
                    <span class="profile-name" id="profileName">Chargement...</span>
                    <span class="profile-role" id="profileRole">Utilisateur</span>
                </div>
                <i class="bi bi-chevron-down profile-arrow"></i>
            </button>
        </div>
    </header>
    
    <!-- Profile Menu -->
    <div class="floating-profile-menu" id="floatingProfileMenu">
        <div class="profile-dropdown show" id="profileDropdown" role="menu">
            <div class="profile-header">
                <div class="profile-avatar large">
                    <i class="bi bi-person-circle"></i>
                </div>
                <div class="profile-details">
                    <strong id="dropdownName">Chargement...</strong>
                    <small id="dropdownEmail">email@exemple.com</small>
                    <span class="badge-role" id="dropdownRole">Utilisateur</span>
                </div>
            </div>
            <div class="dropdown-actions">
                <a href="profile.html" class="dropdown-item" role="menuitem">
                    <i class="bi bi-person"></i> Mon Profil
                </a>
                <a href="settings.html" class="dropdown-item" role="menuitem">
                    <i class="bi bi-gear"></i> Paramètres
                </a>
                <hr class="dropdown-divider">
                <button class="dropdown-item text-danger" id="logout-btn" role="menuitem">
                    <i class="bi bi-box-arrow-right"></i> Déconnexion
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main id="mainContent" class="main-content animate-fade-in" style="display: none;">
        <div class="dashboard-container">
            <!-- Section de bienvenue -->
            <div class="welcome-section">
                <div class="welcome-header">
                    <div class="welcome-avatar-large" id="guestAvatar">
                        <!-- Initiales -->
                    </div>
                    <div class="welcome-info">
                        <h1 class="welcome-title" id="welcomeTitle">Bienvenue !</h1>
                                                <p class="welcome-subtitle" id="welcomeSubtitle">Chargement de vos informations...</p>
                        <div class="table-badge-large" id="tableBadge">
                            <i class="fas fa-chair"></i>
                            <span id="tableName">Table non assignée</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistiques rapides -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-title">Invités à votre table</div>
                    <div class="stat-value" id="tableGuestsCount">0</div>
                    <div class="stat-details">
                        <span id="presentGuestsCount">0</span> présents • 
                        <span id="confirmedGuestsCount">0</span> confirmés
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div class="stat-title">Événement</div>
                    <div class="stat-value" id="eventStatus">Actif</div>
                    <div class="stat-details" id="eventDate">Chargement...</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <div class="stat-title">Votre QR Code</div>
                    <div class="stat-value">Prêt</div>
                    <div class="stat-details">Scannez pour accéder à l'événement</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-title">Progression</div>
                    <div class="stat-value" id="eventProgress">0%</div>
                    <div class="stat-details" id="eventTimeRemaining">Chargement...</div>
                </div>
            </div>

            <!-- Détails de l'événement -->
            <div class="event-details-card">
                <h3><i class="fas fa-info-circle"></i> Détails de l'événement</h3>
                <p id="eventDescription">Chargement des détails de l'événement...</p>
                <div class="event-meta" id="eventMeta">
                    <!-- Les métadonnées seront injectées ici -->
                </div>
            </div>

            <!-- Grille de fonctionnalités -->
            <div class="features-grid">
                <div class="feature-card" onclick="goToFeature('chat')">
                    <div class="feature-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3>Chat de Table</h3>
                    <p>Échangez avec les autres invités de votre table en temps réel</p>
                </div>
                
                <div class="feature-card" onclick="goToFeature('schedule')">
                    <div class="feature-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <h3>Programme</h3>
                    <p>Consultez le déroulement de l'événement et les activités prévues</p>
                </div>
                
                <div class="feature-card" onclick="goToFeature('map')">
                    <div class="feature-icon">
                        <i class="fas fa-map-marked-alt"></i>
                    </div>
                    <h3>Plan interactif</h3>
                    <p>Trouvez facilement votre table, les toilettes, les sorties</p>
                </div>
                
                <div class="feature-card" onclick="goToFeature('guests')">
                    <div class="feature-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Liste des invités</h3>
                    <p>Découvrez qui participe à l'événement et faites des rencontres</p>
                </div>
                
                <div class="feature-card" onclick="goToFeature('photos')">
                    <div class="feature-icon">
                        <i class="fas fa-camera"></i>
                    </div>
                    <h3>Photos & Médias</h3>
                    <p>Partagez et consultez les photos de l'événement</p>
                </div>
                
                <div class="feature-card" onclick="goToFeature('info')">
                    <div class="feature-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h3>Informations pratiques</h3>
                    <p>Tout ce que vous devez savoir pour profiter au maximum</p>
                </div>
                
                <div class="feature-card" onclick="goToFeature('qr')">
                    <div class="feature-icon">
                        <i class="fas fa-qrcode"></i>
                    </div>
                    <h3>Mon QR Code</h3>
                    <p>Accédez à votre QR Code personnel pour l'événement</p>
                </div>
                
                <div class="feature-card" onclick="goToFeature('support')">
                    <div class="feature-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h3>Support</h3>
                    <p>Contactez l'équipe organisatrice en cas de besoin</p>
                </div>
            </div>

            <!-- Membres de la table -->
            <div class="table-mates-section">
                <div class="section-header">
                    <h3><i class="fas fa-users"></i> Les membres de votre table</h3>
                    <span class="badge badge-primary" id="matesCount">0 membre(s)</span>
                </div>
                <div class="mates-grid" id="tableMatesGrid">
                    <!-- Les membres seront injectés ici -->
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <h3>Aucun membre à afficher</h3>
                        <p>Chargement des membres de la table...</p>
                    </div>
                </div>
            </div>

            <!-- Statistiques de présence -->
            <div class="chart-container">
                <div class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Statistiques de présence à votre table
                </div>
                <div class="chart-placeholder" id="attendanceChart">
                    <!-- Chart.js s'affichera ici -->
                </div>
            </div>
        </div>
    </main>

    <!-- Bouton de déconnexion fixe -->
    <button class="btn btn-danger logout-fixed-btn" onclick="logoutFromEvent()">
        <i class="fas fa-sign-out-alt"></i>
        Quitter l'événement
    </button>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-top">
                <div class="row">
                    <div class="col-lg-4 mb-5 mb-lg-0">
                        <div class="footer-brand">
                            <div class="footer-logo">
                                <img src="../assets/images/icon.png" alt="SECURA Logo">
                            </div>
                            <div class="footer-title">
                                <h3>SECURA</h3>
                                <p>Plateforme d'accès événementiel</p>
                            </div>
                        </div>
                        <p class="footer-description">
                            SECURA révolutionne l'accès aux événements avec des solutions innovantes, 
                            sécurisées et intuitives pour organisateurs et participants.
                        </p>
                        <div class="social-links">
                            <a href="#" class="social-link">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-instagram"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-linkedin-in"></i>
                            </a>
                            <a href="#" class="social-link">
                                <i class="fab fa-youtube"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="col-lg-2 col-md-4 mb-5">
                        <h4>Navigation</h4>
                        <ul class="footer-links">
                            <li><a href="../index.html">Accueil</a></li>
                            <li><a href="../access.html">Accès événement</a></li>
                            <li><a href="#features">Fonctionnalités</a></li>
                            <li><a href="#how-it-works">Comment ça marche</a></li>
                        </ul>
                    </div>
                    
                    <div class="col-lg-2 col-md-4 mb-5">
                        <h4>Compte</h4>
                        <ul class="footer-links">
                            <li><a href="../login.html">Connexion</a></li>
                            <li><a href="../register.html">Inscription</a></li>
                            <li><a href="../forgot-password.html">Mot de passe oublié</a></li>
                        </ul>
                    </div>
                    
                    <div class="col-lg-4 col-md-4">
                        <h4>Newsletter</h4>
                        <p class="mb-4">Inscrivez-vous pour recevoir nos actualités et offres exclusives.</p>
                        <form class="newsletter-form" id="newsletterForm">
                            <div class="newsletter-input-group">
                                <input type="email" class="newsletter-input" placeholder="Votre email" required>
                                <button type="submit" class="newsletter-btn">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </form>
                       
                        <div class="footer-controls-inline">
                            <!-- Theme Switch Button -->
                            <div class="theme-switch-footer">
                                <label class="theme-switch">
                                    <input type="checkbox" id="themeSwitchFooter" aria-label="Basculer le thème">
                                    <span class="theme-switch-slider">
                                        <i class="fas fa-moon"></i>
                                        <i class="fas fa-sun"></i>
                                    </span>
                                </label>
                            </div>

                            <!-- Language Selector -->
                            <div class="language-selector"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <p class="copyright">© 2025 SECURA. Tous droits réservés.</p>
                    </div>
                    <div class="col-md-6">
                        <div class="footer-legal">
                            <a href="#">Mentions légales</a>
                            <a href="#">Confidentialité</a>
                            <a href="#">CGU</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/audio-utils.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            SECURA_AUDIO.preload();
        });
    </script>
    
    <!-- Librairies -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    
    <!-- Scripts locaux -->
    <script src="../js/storage.js"></script>
    <script src="../js/auth-check.js"></script>
    <script src="../js/particles-config.js" defer></script>
    <script src="../js/theme.js" defer></script>
    <script src="../js/main.js" defer></script>
    <script src="../js/toastify.js" defer></script>
    <script src="../js/langue.js" defer></script>

    <!-- Script d'initialisation -->
    <script>
        // Fonction pour mettre à jour la barre de progression du splash screen
        function updateSplashProgress(percentage) {
            const progressBar = document.getElementById('splashProgressBar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }

        // Fonction pour masquer le splash screen
        function hideSplashScreen() {
            const splashScreen = document.getElementById('splashScreen');
            const mainContent = document.getElementById('mainContent');
            
            if (splashScreen && mainContent) {
                // Animation de fondu
                splashScreen.style.opacity = '0';
                
                setTimeout(() => {
                    splashScreen.style.display = 'none';
                    mainContent.style.display = 'block';
                    
                    // Animation d'entrée
                    mainContent.style.animation = 'fadeIn 0.6s ease-out';
                    
                    // Initialiser les particules
                    if (typeof particlesJS !== 'undefined') {
                        particlesJS.load('particles-js', '../js/particles-config.json', function() {
                            console.log('Particles.js loaded');
                        });
                    }
                }, 500);
            }
        }

        // Fonction pour afficher une notification toast
        function showToast(message, type = 'info') {
            const toastColors = {
                success: '#10B981',
                error: '#EF4444',
                warning: '#F59E0B',
                info: '#3B82F6'
            };
            
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: toastColors[type] || toastColors.info,
                stopOnFocus: true,
            }).showToast();
        }

        // Fonction pour obtenir l'avatar selon le sexe
        function getGuestAvatarImage(guest) {
            const baseUrl = '../assets/images/';
            const validGenders = ['m', 'f', 'homme', 'femme', 'male', 'female', 'couple', 'maman', 'mother', 'autre'];
            
            // 1️⃣ Vérifier d'abord le champ gender/sexe
            const gender = (guest.gender?.toLowerCase() || guest.sexe?.toLowerCase() || '').trim();
            
            if (gender) {
                // Normaliser et checker les valeurs connues
                if (gender === 'f' || gender === 'femme' || gender === 'woman' || gender === 'female') {
                    return `${baseUrl}femme.png`;
                } else if (gender === 'm' || gender === 'homme' || gender === 'man' || gender === 'male') {
                    return `${baseUrl}homme.png`;
                } else if (gender === 'couple') {
                    return `${baseUrl}couple.png`;
                } else if (gender === 'maman' || gender === 'mother') {
                    return `${baseUrl}maman.png`;
                } else if (gender === 'autre') {
                    return null; // Utiliser les initiales
                }
            }
            
            // 2️⃣ Détection intelligente basée sur les titres de civilité et notes
            const firstName = (guest.firstName || '').toLowerCase().trim();
            const lastName = (guest.lastName || '').toLowerCase().trim();
            const notes = (guest.notes || '').toLowerCase().trim();
            const company = (guest.company || '').toLowerCase().trim();
            
            if (notes.includes('maman') || notes.includes('mother') || 
                firstName.includes('maman') || firstName.includes('mother') ||
                lastName.includes('maman') || lastName.includes('mother')) {
                return `${baseUrl}maman.png`;
            }
            
            if (guest.type === 'couple' || 
                notes.includes('couple') || 
                company.includes('couple')) {
                return `${baseUrl}couple.png`;
            }
            
            const malePatterns = [
                /\bm\b\.?/i,           // M. ou M
                /\bmonsieur\b/i,       // Monsieur
                /\bmr\b\.?/i,          // Mr ou Mr.
                /\bmon\b\.?/i,         // Mon (de Monsieur)
                /père/i,               // Père
                /father/i,             // Father
                /dad\b/i,              // Dad
                /papa/i                // Papa
            ];
            
            // Chercher dans les notes
            if (malePatterns.some(pattern => pattern.test(notes))) {
                return `${baseUrl}homme.png`;
            }
            
            // Chercher dans le prénom ou nom
            if (malePatterns.some(pattern => pattern.test(firstName + ' ' + lastName))) {
                return `${baseUrl}homme.png`;
            }
            
            const femalePatterns = [
                /\bm[lle]{1,3}\.?/i,    // Mlle ou Mme ou Mme.
                /\bmme\b\.?/i,          // Mme
                /\bmlle\b\.?/i,         // Mlle
                /\bmademoiselle\b/i,    // Mademoiselle
                /\bmadame\b/i,          // Madame
                /\bmrs\b\.?/i,          // Mrs
                /\bms\b\.?/i,           // Ms
                /mère/i,                // Mère
                /mother/i,              // Mother
                /maman/i,               // Maman
                /mom\b/i,               // Mom
                /mama/i                 // Mama
            ];
            
            // Chercher dans les notes
            if (femalePatterns.some(pattern => pattern.test(notes))) {
                return `${baseUrl}femme.png`;
            }
            
            // Chercher dans le prénom ou nom
            if (femalePatterns.some(pattern => pattern.test(firstName + ' ' + lastName))) {
                return `${baseUrl}femme.png`;
            }
            
            const commonFemaleNames = [
                'marie', 'anne', 'sophie', 'christine', 'catherine', 'nathalie',
                'isabelle', 'francine', 'fabienne', 'nadine', 'monique', 'dominique',
                'michelle', 'carole', 'patricia', 'béatrice', 'denise', 'brigitte',
                'véronique', 'christine', 'joëlle', 'chantal', 'thérèse', 'simone',
                'valerie', 'annie', 'elise', 'alice', 'claire', 'nicole', 'sylvie',
                'martine', 'emilie', 'victoria', 'laura', 'sarah', 'jessica'
            ];
            
            const commonMaleNames = [
                'jean', 'pierre', 'michel', 'andré', 'bernard', 'françois',
                'jacques', 'patrick', 'christian', 'daniel', 'olivier', 'alain',
                'marc', 'thierry', 'charles', 'paul', 'jean-paul', 'jean-claude',
                'serge', 'gérard', 'dominique', 'richard', 'joseph', 'louis',
                'luc', 'eric', 'david', 'nicolas', 'thomas', 'alexandre', 'benoit'
            ];
            
            if (firstName) {
                if (commonFemaleNames.includes(firstName)) {
                    return `${baseUrl}femme.png`;
                } else if (commonMaleNames.includes(firstName)) {
                    return `${baseUrl}homme.png`;
                }
            }
            
            return null;
        }

        // Fonction pour obtenir les initiales
        function getInitials(name) {
            if (!name || typeof name !== 'string') return '?';
            return name
                .split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .slice(0, 2);
        }

        // Fonction pour échapper le HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fonction pour naviguer vers les fonctionnalités
        function goToFeature(feature) {
            const features = {
                chat: '../event-chat.html',
                schedule: '../event-schedule.html',
                map: '../event-map.html',
                guests: '../event-guests.html',
                photos: '../event-photos.html',
                info: '../event-info.html',
                qr: '../my-qr.html',
                support: '../support.html'
            };
            
            if (features[feature]) {
                window.location.href = features[feature];
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'Bientôt disponible',
                    text: 'Cette fonctionnalité sera disponible prochainement',
                    confirmButtonColor: '#D97706'
                });
            }
        }

        // Fonction de déconnexion de l'événement
        async function logoutFromEvent() {
            const result = await Swal.fire({
                title: 'Quitter l\'événement ?',
                html: `
                    <div style="text-align: center; padding: 20px 0;">
                        <i class="fas fa-sign-out-alt" style="font-size: 4rem; color: var(--danger); margin-bottom: 15px;"></i>
                        <p>Vous serez déconnecté de l'événement</p>
                        <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 10px;">
                            Vous pourrez vous reconnecter à tout moment
                        </p>
                    </div>
                `,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Oui, quitter',
                cancelButtonText: 'Annuler',
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6B7280',
                reverseButtons: true
            });
            
            if (result.isConfirmed) {
                // Effacer la session
                localStorage.removeItem('secura_event_session_token');
                
                // Rediriger vers la page d'accès
                window.location.href = '../access.html';
            }
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', async function() {
            updateSplashProgress(30);
            
            try {
                // Attendre que le storage soit prêt
                await new Promise(resolve => {
                    const checkStorage = () => {
                        if (window.storage && window.storage.isInitialized) {
                            resolve();
                        } else {
                            setTimeout(checkStorage, 100);
                        }
                    };
                    checkStorage();
                });
                
                updateSplashProgress(60);
                
                // Charger les données de session
                await loadSessionData();
                
                updateSplashProgress(90);
                
                // Afficher le contenu principal
                setTimeout(() => {
                    hideSplashScreen();
                    updateSplashProgress(100);
                    
                    // Jouer un son de bienvenue
                    SECURA_AUDIO.play('notification');
                    
                    // Afficher une notification
                    showToast('Bienvenue sur votre tableau de bord !', 'success');
                }, 1000);
                
            } catch (error) {
                console.error('Erreur d\'initialisation:', error);
                showToast('Erreur de chargement des données', 'error');
                
                // Rediriger vers l'accès en cas d'erreur
                setTimeout(() => {
                    window.location.href = '../access.html';
                }, 2000);
            }
        });

        // Fonction pour charger les données de session
        async function loadSessionData() {
            try {
                // Vérifier si une session existe
                const token = localStorage.getItem('secura_event_session_token');
                if (!token) {
                    throw new Error('Aucune session active');
                }

                // Récupérer les détails de la session via API
                const response = await fetch(`${window.storage.API_URL}/event-sessions/details`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('secura_event_session_token');
                        throw new Error('Session expirée');
                    }
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    // Stocker les données dans le storage
                    window.storage.currentSession = result.data;
                    
                    // Mettre à jour l'interface
                    populateDashboard(result.data);
                    
                    // Charger les membres de la table
                    if (result.data.table && result.data.table.id) {
                        await loadTableMates(result.data.table.id);
                    }
                    
                    // Initialiser les graphiques
                    initializeCharts(result.data);
                    
                    return result.data;
                } else {
                    throw new Error(result.error || 'Erreur de session');
                }

            } catch (error) {
                console.error('Erreur chargement session:', error);
                throw error;
            }
        }

        // Fonction pour peupler le dashboard
        function populateDashboard(sessionData) {
            // Mettre à jour les informations de l'invité
            if (sessionData.guest) {
                const guest = sessionData.guest;
                const fullName = `${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email;
                const initials = getInitials(fullName);
                
                // Avatar
                const avatarElement = document.getElementById('guestAvatar');
                const avatarImage = getGuestAvatarImage(guest);
                
                if (avatarImage) {
                    avatarElement.innerHTML = `<img src="${avatarImage}" alt="${escapeHtml(fullName)}">`;
                } else {
                    avatarElement.textContent = initials;
                }
                
                // Titre de bienvenue
                document.getElementById('welcomeTitle').textContent = `Bienvenue, ${guest.firstName || ''} !`;
                document.getElementById('profileName').textContent = fullName;
                document.getElementById('dropdownName').textContent = fullName;
                document.getElementById('dropdownEmail').textContent = guest.email || 'Non spécifié';
                
                // Rôle
                const role = guest.type === 'vip' ? 'VIP' : 'Invité';
                document.getElementById('profileRole').textContent = role;
                document.getElementById('dropdownRole').textContent = role;
            }
            
            // Mettre à jour les informations de la table
            if (sessionData.table) {
                const table = sessionData.table;
                document.getElementById('tableName').textContent = `Table ${table.tableNumber || 'Inconnue'}`;
                
                if (table.tableName && table.tableName !== table.tableNumber) {
                    document.getElementById('welcomeSubtitle').textContent = 
                        `Ravi de vous accueillir à "${table.tableName}"`;
                }
            }
            
            // Mettre à jour les informations de l'événement
            if (sessionData.event) {
                const event = sessionData.event;
                
                // Description
                document.getElementById('eventDescription').textContent = 
                    event.description || 'Aucune description disponible';
                
                // Métadonnées
                const eventMeta = document.getElementById('eventMeta');
                if (eventMeta) {
                    eventMeta.innerHTML = `
                        <div class="event-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>${formatDate(event.date)} ${event.time || ''}</span>
                        </div>
                        <div class="event-meta-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${event.location || 'Non spécifié'}</span>
                        </div>
                        <div class="event-meta-item">
                            <i class="fas fa-users"></i>
                            <span>${event.capacity || 0} places</span>
                        </div>
                        <div class="event-meta-item">
                            <i class="fas fa-tag"></i>
                            <span>${getEventTypeLabel(event.type)}</span>
                        </div>
                    `;
                }
                
                // Date de l'événement
                document.getElementById('eventDate').textContent = 
                    `${formatDate(event.date)} • ${event.time || 'Heure non spécifiée'}`;
            }
            
            // Mettre à jour le statut
            document.getElementById('eventStatus').textContent = 
                sessionData.event?.status === 'active' ? 'Actif' : 'Inactif';
        }

        // Fonction pour charger les membres de la table
        async function loadTableMates(tableId) {
            try {
                const token = localStorage.getItem('secura_event_session_token');
                if (!token) return;

                const response = await fetch(`${window.storage.API_URL}/tables/${tableId}/guests`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data && result.data.guests) {
                        renderTableMates(result.data.guests);
                    } else {
                        renderDemoTableMates();
                    }
                } else {
                    renderDemoTableMates();
                }
            } catch (error) {
                console.error('Erreur chargement membres:', error);
                renderDemoTableMates();
            }
        }

        // Fonction pour afficher les membres de la table
        function renderTableMates(guests) {
            const container = document.getElementById('tableMatesGrid');
            const currentGuest = window.storage.currentSession?.guest;
            
            if (!guests || guests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users-slash"></i>
                        <h3>Aucun autre invité sur cette table</h3>
                        <p>Vous êtes actuellement le seul invité à cette table</p>
                    </div>
                `;
                document.getElementById('matesCount').textContent = '0 membre(s)';
                document.getElementById('tableGuestsCount').textContent = '0';
                return;
            }
            
            let presentCount = 0;
            let confirmedCount = 0;
            
            const matesHTML = guests.map(item => {
                const guest = item.guest;
                if (!guest) return '';
                
                const isCurrentUser = currentGuest && guest.id === currentGuest.id;
                const fullName = `${guest.firstName || ''} ${guest.lastName || ''}`.trim() || guest.email;
                const initials = getInitials(fullName);
                const avatarImage = getGuestAvatarImage(guest);
                
                // Compter les statuts
                if (guest.status === 'confirmed' || guest.status === 'checkedin') confirmedCount++;
                if (guest.scanned) presentCount++;
                
                return `
                    <div class="mate-card ${isCurrentUser ? 'current-user' : ''}">
                        <div class="mate-avatar ${isCurrentUser ? 'current-user' : ''}">
                            ${avatarImage ? 
                                `<img src="${avatarImage}" alt="${escapeHtml(fullName)}">` : 
                                initials}
                        </div>
                        <div class="mate-info">
                            <div class="mate-name">
                                ${escapeHtml(fullName)}
                                ${isCurrentUser ? '<span class="badge badge-primary">Vous</span>' : ''}
                            </div>
                            ${guest.company ? 
                                `<div class="mate-company">${escapeHtml(guest.company)}</div>` : ''}
                            <div class="mate-status ${guest.scanned ? 'status-present' : 'status-pending'}">
                                <i class="fas fa-${guest.scanned ? 'check' : 'clock'}"></i>
                                ${guest.scanned ? 'Présent' : 'En attente'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = matesHTML;
            
            // Mettre à jour les compteurs
            const totalGuests = guests.length;
            document.getElementById('matesCount').textContent = `${totalGuests} membre(s)`;
            document.getElementById('tableGuestsCount').textContent = totalGuests;
            document.getElementById('presentGuestsCount').textContent = presentCount;
            document.getElementById('confirmedGuestsCount').textContent = confirmedCount;
        }

        // Fonction pour afficher des membres de démo
        function renderDemoTableMates() {
            const demoMates = [
                { 
                    firstName: 'Jean', 
                    lastName: 'Dupont', 
                    company: 'Entreprise A', 
                    scanned: true,
                    type: 'standard'
                },
                { 
                    firstName: 'Marie', 
                    lastName: 'Martin', 
                    company: 'Entreprise B', 
                    scanned: true,
                    type: 'standard'
                },
                { 
                    firstName: 'Pierre', 
                    lastName: 'Bernard', 
                    company: 'Entreprise C', 
                    scanned: false,
                    type: 'vip'
                },
                { 
                    firstName: 'Sophie', 
                    lastName: 'Petit', 
                    company: 'Entreprise D', 
                    scanned: true,
                    type: 'standard'
                }
            ];
            
            const currentGuest = window.storage.currentSession?.guest || 
                { firstName: 'Vous', lastName: '', email: 'vous@exemple.com', type: 'standard' };
            
            const allMates = [currentGuest, ...demoMates];
            
            const container = document.getElementById('tableMatesGrid');
            let presentCount = 3; // 3 présents dans la démo
            let confirmedCount = 4; // 4 confirmés dans la démo
            
            const matesHTML = allMates.map((mate, index) => {
                const isCurrentUser = index === 0;
                const fullName = `${mate.firstName || ''} ${mate.lastName || ''}`.trim();
                const initials = getInitials(fullName);
                const avatarImage = getGuestAvatarImage(mate);
                
                return `
                    <div class="mate-card ${isCurrentUser ? 'current-user' : ''}">
                        <div class="mate-avatar ${isCurrentUser ? 'current-user' : ''}">
                            ${avatarImage ? 
                                `<img src="${avatarImage}" alt="${escapeHtml(fullName)}">` : 
                                initials}
                        </div>
                        <div class="mate-info">
                            <div class="mate-name">
                                ${escapeHtml(fullName)}
                                ${isCurrentUser ? '<span class="badge badge-primary">Vous</span>' : ''}
                                ${mate.type === 'vip' ? '<span class="badge badge-warning">VIP</span>' : ''}
                            </div>
                            ${mate.company ? 
                                `<div class="mate-company">${escapeHtml(mate.company)}</div>` : ''}
                            <div class="mate-status ${mate.scanned ? 'status-present' : 'status-pending'}">
                                <i class="fas fa-${mate.scanned ? 'check' : 'clock'}"></i>
                                ${mate.scanned ? 'Présent' : 'En attente'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = matesHTML;
            
            // Mettre à jour les compteurs
            const totalGuests = allMates.length;
            document.getElementById('matesCount').textContent = `${totalGuests} membre(s)`;
            document.getElementById('tableGuestsCount').textContent = totalGuests;
            document.getElementById('presentGuestsCount').textContent = presentCount;
            document.getElementById('confirmedGuestsCount').textContent = confirmedCount;
        }

        // Fonction pour initialiser les graphiques
        function initializeCharts(sessionData) {
                          // Graphique de présence
                const ctx = document.getElementById('attendanceChart');
                if (!ctx) return;
                
                // Créer un élément canvas si nécessaire
                if (typeof ctx.getContext !== 'function') {
                    ctx.innerHTML = '<canvas></canvas>';
                    chartCtx = ctx.querySelector('canvas').getContext('2d');
                } else {
                    chartCtx = ctx.getContext('2d');
                }
                
                // Données basées sur les membres de table
                const present = sessionData.stats?.present || 3;
                const pending = sessionData.stats?.pending || 2;
                const total = present + pending;
                
                // Calculer la progression
                const progress = total > 0 ? Math.round((present / total) * 100) : 0;
                document.getElementById('eventProgress').textContent = `${progress}%`;
                
                // Mettre à jour le temps restant
                updateTimeRemaining(sessionData.event);
                
                new Chart(chartCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Présents', 'En attente'],
                        datasets: [{
                            data: [present, pending],
                            backgroundColor: [
                                'rgba(16, 185, 129, 0.8)',
                                'rgba(245, 158, 11, 0.8)'
                            ],
                            borderColor: [
                                'rgba(16, 185, 129, 1)',
                                'rgba(245, 158, 11, 1)'
                            ],
                            borderWidth: 2,
                            hoverOffset: 15
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'var(--text-color)',
                                    font: {
                                        size: 12
                                    },
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ${value} personne${value > 1 ? 's' : ''} (${percentage}%)`;
                                    }
                                },
                                backgroundColor: 'var(--card-bg)',
                                titleColor: 'var(--text-color)',
                                bodyColor: 'var(--text-color)',
                                borderColor: 'var(--border-color)',
                                borderWidth: 1
                            }
                        },
                        cutout: '70%',
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1000
                        }
                    }
                });
            }

            // Fonction pour mettre à jour le temps restant
            function updateTimeRemaining(event) {
                if (!event || !event.date) {
                    document.getElementById('eventTimeRemaining').textContent = 'Durée inconnue';
                    return;
                }
                
                try {
                    const eventDate = new Date(event.date);
                    const now = new Date();
                    
                    if (eventDate > now) {
                        // Événement à venir
                        const diff = eventDate - now;
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        
                        if (hours > 24) {
                            const days = Math.floor(hours / 24);
                            document.getElementById('eventTimeRemaining').textContent = 
                                `Commence dans ${days} jour${days > 1 ? 's' : ''}`;
                        } else if (hours > 0) {
                            document.getElementById('eventTimeRemaining').textContent = 
                                `Commence dans ${hours}h${minutes > 0 ? `${minutes}min` : ''}`;
                        } else {
                            document.getElementById('eventTimeRemaining').textContent = 
                                `Commence dans ${minutes} minutes`;
                        }
                    } else {
                        // Événement en cours ou terminé
                        const endTime = new Date(eventDate);
                        if (event.duration) {
                            endTime.setHours(endTime.getHours() + parseInt(event.duration) || 3);
                        } else {
                            endTime.setHours(endTime.getHours() + 3); // Durée par défaut
                        }
                        
                        if (endTime > now) {
                            // Événement en cours
                            const diff = endTime - now;
                            const hours = Math.floor(diff / (1000 * 60 * 60));
                            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                            
                            document.getElementById('eventTimeRemaining').textContent = 
                                `Termine dans ${hours}h${minutes > 0 ? `${minutes}min` : ''}`;
                        } else {
                            // Événement terminé
                            document.getElementById('eventTimeRemaining').textContent = 'Événement terminé';
                        }
                    }
                } catch (error) {
                    console.error('Erreur calcul temps:', error);
                    document.getElementById('eventTimeRemaining').textContent = 'Durée inconnue';
                }
            }

            // Fonction pour formater la date
            function formatDate(dateString) {
                if (!dateString) return 'Date non spécifiée';
                
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('fr-FR', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (error) {
                    return dateString;
                }
            }

            // Fonction pour obtenir le libellé du type d'événement
            function getEventTypeLabel(type) {
                const types = {
                    'conference': 'Conférence',
                    'seminar': 'Séminaire',
                    'workshop': 'Atelier',
                    'meeting': 'Réunion',
                    'networking': 'Networking',
                    'gala': 'Gala',
                    'wedding': 'Mariage',
                    'birthday': 'Anniversaire',
                    'corporate': 'Entreprise',
                    'other': 'Autre'
                };
                
                return types[type] || type || 'Événement';
            }

            // Gestionnaire d'erreurs global
            window.addEventListener('error', function(event) {
                console.error('Erreur globale:', event.error);
                showToast('Une erreur est survenue', 'error');
            });

            // Gestionnaire pour les promesses non catchées
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Promesse non catchée:', event.reason);
                showToast('Erreur de traitement des données', 'error');
            });

            // Rafraîchissement automatique des données
            function startAutoRefresh() {
                // Rafraîchir toutes les 30 secondes
                setInterval(async () => {
                    try {
                        await loadSessionData();
                    } catch (error) {
                        console.log('Rafraîchissement échoué:', error);
                    }
                }, 30000);
            }

            // Démarrer le rafraîchissement automatique
            setTimeout(startAutoRefresh, 5000);

            // Écouter les changements de session
            window.addEventListener('storage', function(event) {
                if (event.key === 'secura_event_session_token') {
                    if (!event.newValue) {
                        // Session supprimée, rediriger
                        window.location.href = '../access.html';
                    } else {
                        // Session mise à jour, rafraîchir
                        loadSessionData();
                    }
                }
            });

            // Gestion du thème
            const themeSwitch = document.getElementById('themeSwitchFooter');
            if (themeSwitch) {
                themeSwitch.addEventListener('change', function() {
                    document.body.classList.toggle('dark-theme');
                    
                    // Sauvegarder la préférence
                    const isDarkMode = document.body.classList.contains('dark-theme');
                    localStorage.setItem('secura-theme', isDarkMode ? 'dark' : 'light');
                    
                    // Mettre à jour les graphiques si nécessaire
                    if (window.storage.currentSession) {
                        initializeCharts(window.storage.currentSession);
                    }
                });
                
                // Restaurer le thème sauvegardé
                const savedTheme = localStorage.getItem('secura-theme');
                if (savedTheme === 'light') {
                    document.body.classList.remove('dark-theme');
                    themeSwitch.checked = false;
                } else {
                    document.body.classList.add('dark-theme');
                    themeSwitch.checked = true;
                }
            }

            // Gestion de la newsletter
            const newsletterForm = document.getElementById('newsletterForm');
            if (newsletterForm) {
                newsletterForm.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const emailInput = this.querySelector('.newsletter-input');
                    const email = emailInput.value.trim();
                    
                    if (!email) {
                        showToast('Veuillez entrer une adresse email', 'warning');
                        return;
                    }
                    
                    if (!isValidEmail(email)) {
                        showToast('Adresse email invalide', 'warning');
                        return;
                    }
                    
                    // Simuler l'envoi
                    emailInput.value = '';
                    showToast('Inscription à la newsletter confirmée !', 'success');
                });
            }

            // Validation d'email
            function isValidEmail(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }

            // Animation des cartes au défilement
            function animateCardsOnScroll() {
                const cards = document.querySelectorAll('.stat-card, .feature-card, .mate-card');
                
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            entry.target.style.opacity = '1';
                            entry.target.style.transform = 'translateY(0)';
                        }
                    });
                }, { threshold: 0.1 });
                
                cards.forEach(card => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                    observer.observe(card);
                });
            }

            // Démarrer les animations au chargement
            setTimeout(animateCardsOnScroll, 1000);

            // Gestion de la déconnexion
            document.getElementById('logout-btn')?.addEventListener('click', async function() {
                const result = await Swal.fire({
                    title: 'Déconnexion',
                    html: `
                        <div style="text-align: center; padding: 20px 0;">
                            <i class="fas fa-sign-out-alt" style="font-size: 4rem; color: var(--danger); margin-bottom: 15px;"></i>
                            <p>Êtes-vous sûr de vouloir vous déconnecter ?</p>
                            <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 10px;">
                                Vous serez redirigé vers la page de connexion
                            </p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Oui, déconnecter',
                    cancelButtonText: 'Annuler',
                    confirmButtonColor: '#EF4444',
                    cancelButtonColor: '#6B7280',
                    reverseButtons: true
                });
                
                if (result.isConfirmed) {
                    try {
                        // Effacer toutes les données de session
                        localStorage.removeItem('secura_event_session_token');
                        localStorage.removeItem('secura_token');
                        localStorage.removeItem('secura_user');
                        
                        // Rediriger vers la page de connexion
                        window.location.href = '../login.html';
                    } catch (error) {
                        console.error('Erreur déconnexion:', error);
                        window.location.href = '../index.html';
                    }
                }
            });

            // Gestion du responsive
            function handleResponsive() {
                const header = document.querySelector('.dashboard-header');
                const statsGrid = document.querySelector('.stats-grid');
                
                if (window.innerWidth < 768) {
                    if (header) {
                        header.style.flexDirection = 'column';
                        header.style.gap = '15px';
                    }
                    
                    if (statsGrid) {
                        statsGrid.style.gridTemplateColumns = '1fr';
                    }
                } else {
                    if (header) {
                        header.style.flexDirection = 'row';
                        header.style.gap = '0';
                    }
                    
                    if (statsGrid) {
                        statsGrid.style.gridTemplateColumns = 'repeat(auto-fit, minmax(250px, 1fr))';
                    }
                }
            }

            // Écouter le redimensionnement
            window.addEventListener('resize', handleResponsive);
            handleResponsive(); // Appel initial

            // Fonction pour partager l'événement
            function shareEvent() {
                if (navigator.share) {
                    const event = window.storage.currentSession?.event;
                    const guest = window.storage.currentSession?.guest;
                    
                    navigator.share({
                        title: event?.name || 'Événement SECURA',
                        text: `Je participe à ${event?.name || 'un événement'} avec SECURA !`,
                        url: window.location.href
                    }).then(() => {
                        showToast('Événement partagé avec succès !', 'success');
                    }).catch(error => {
                        console.log('Partage annulé:', error);
                    });
                } else {
                    // Fallback pour les navigateurs qui ne supportent pas l'API Web Share
                    Swal.fire({
                        title: 'Partager',
                        text: 'Copiez le lien pour partager',
                        input: 'text',
                        inputValue: window.location.href,
                        showCancelButton: true,
                        confirmButtonText: 'Copier',
                        cancelButtonText: 'Annuler'
                    }).then(result => {
                        if (result.isConfirmed) {
                            navigator.clipboard.writeText(window.location.href).then(() => {
                                showToast('Lien copié dans le presse-papier !', 'success');
                            });
                        }
                    });
                }
            }

            // Bouton de partage (à ajouter dans le header)
            const shareButton = document.createElement('button');
            shareButton.className = 'btn btn-secondary btn-sm';
            shareButton.innerHTML = '<i class="fas fa-share-alt"></i> Partager';
            shareButton.onclick = shareEvent;
            
            // Ajouter le bouton au header si l'API de partage est disponible
            if (navigator.share || navigator.clipboard) {
                const headerActions = document.querySelector('.header-actions');
                if (headerActions) {
                    headerActions.appendChild(shareButton);
                }
            }

            // Gestion de l'accessibilité
            document.addEventListener('keydown', function(event) {
                // Navigation au clavier dans les cartes de fonctionnalités
                if (event.key === 'Tab') {
                    const focusableCards = document.querySelectorAll('.feature-card');
                    const focused = document.activeElement;
                    
                    if (focused && focused.classList.contains('feature-card')) {
                        event.preventDefault();
                        
                        const currentIndex = Array.from(focusableCards).indexOf(focused);
                        let nextIndex;
                        
                        if (event.shiftKey) {
                            // Shift + Tab : aller à l'élément précédent
                            nextIndex = currentIndex > 0 ? currentIndex - 1 : focusableCards.length - 1;
                        } else {
                            // Tab : aller à l'élément suivant
                            nextIndex = currentIndex < focusableCards.length - 1 ? currentIndex + 1 : 0;
                        }
                        
                        focusableCards[nextIndex].focus();
                        focusableCards[nextIndex].setAttribute('tabindex', '0');
                    }
                }
                
                // Espace ou Entrée pour activer les cartes
                if ((event.key === 'Enter' || event.key === ' ') && 
                    document.activeElement.classList.contains('feature-card')) {
                    event.preventDefault();
                    document.activeElement.click();
                }
            });

            // Amélioration de l'accessibilité des cartes
            const featureCards = document.querySelectorAll('.feature-card');
            featureCards.forEach((card, index) => {
                card.setAttribute('tabindex', index === 0 ? '0' : '-1');
                card.setAttribute('role', 'button');
                card.setAttribute('aria-label', card.querySelector('h3').textContent + '. ' + card.querySelector('p').textContent);
            });

            

            // Gestion de la connexion/réponse
            window.addEventListener('online', function() {
                showToast('Connecté à Internet', 'success');
                
                // Rafraîchir les données
                setTimeout(loadSessionData, 1000);
            });

            window.addEventListener('offline', function() {
                showToast('Mode hors ligne activé', 'warning');
            });

            // Initialiser les tooltips Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Animation de bienvenue
            setTimeout(() => {
                const welcomeTitle = document.querySelector('.welcome-title');
                if (welcomeTitle) {
                    welcomeTitle.style.animation = 'none';
                    setTimeout(() => {
                        welcomeTitle.style.animation = 'fadeIn 1s ease-out';
                    }, 10);
                }
            }, 2000);

            // Initialisation finale
            console.log('Dashboard SECURA initialisé avec succès');
      
    </script>
</body>
</html>