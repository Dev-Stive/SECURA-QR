<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SECURA - Plateforme de gestion d'événements sécurisée avec QR Code">
    <title>SECURA - Gestion d'Événements Sécurisée</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dash.css">
    
<style>








</style>
</head>
<body class="light-theme">
    <!-- Particles Background -->
    <div id="particles-js"></div>


 <!-- Header Premium -->
<header class="header">
    <div class="header-content">
        <div class="logo-section">
            <div class="logo-icon">
                <img src="assets/images/icon.png" alt="logo secura">
            </div>
            <div class="logo-text">
                <h1>SECURA</h1>
                <p>Tableau de Bord • Gestion Sécurisée</p>
            </div>
        </div>

        <nav class="nav-menu" id="navMenu">
            <a href="index.html" class="nav-link active">Accueil</a>
            <a href="events.html" class="nav-link">Événements</a>
            <a href="guests.html" class="nav-link">Invités</a>
            <a href="qr-generator.html" class="nav-link">Générateur QR</a>
            <a href="ticket-generator.html" class="nav-link">Billets</a>
            <a href="scanner.html" class="nav-link">Scanner</a>
        </nav>

        <div class="header-actions">
            <button class="theme-toggle" id="themeToggle" aria-label="Changer le thème">
                <i class="fas fa-moon"></i>
            </button>
            <button class="fullscreen-toggle" id="fullscreenToggle" aria-label="Plein écran">
                <i class="fas fa-expand"></i>
            </button>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Menu">
                <i class="fas fa-bars"></i>
            </button>
        </div>

        <!-- BOUTON PROFIL DANS LE HEADER -->
        <button class="profile-toggle header-profile-btn" id="profileToggle" aria-haspopup="true" aria-expanded="false">
            <div class="profile-avatar">
                <i class="bi bi-person-circle"></i>
            </div>
            <div class="profile-info">
                <span class="profile-name" id="profileName">Chargement...</span>
                <span class="profile-role" id="profileRole">Utilisateur</span>
            </div>
            <i class="bi bi-chevron-down profile-arrow"></i>
        </button>
    </div>
</header>

<!-- MENU PROFIL FLOTTANT (HORS HEADER) -->
<div class="floating-profile-menu" id="floatingProfileMenu">
    <div class="profile,-dropdown show" id="profileDropdown" role="menu">
        <div class="profile-header">
            <div class="profile-avatar large">
                <i class="bi bi-person-circle"></i>
            </div>
            <div class="profile-details">
                <strong id="dropdownName">Chargement...</strong>
                <small id="dropdownEmail">email@exemple.com</small>
                <span class="badge-role" id="dropdownRole">Utilisateur</span>
            </div>
        </div>

        <div class="dropdown-actions">
            <a href="profile.html" class="dropdown-item" role="menuitem">
                <i class="bi bi-person"></i> Mon Profil
            </a>
            <a href="settings.html" class="dropdown-item" role="menuitem">
                <i class="bi bi-gear"></i> Paramètres
            </a>
            <hr class="dropdown-divider">
            <button class="dropdown-item text-danger" id="logout-btn" role="menuitem">
                <i class="bi bi-box-arrow-right"></i> Déconnexion
            </button>
        </div>
    </div>
</div>

    <!-- Hero Section -->
  

<!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <div class="hero-content animate-fade-in">
                <h1 class="hero-title">Bienvenue sur <span>SECURA</span></h1>
                <p class="hero-subtitle">La plateforme complète pour gérer vos événements avec des QR Codes stylisés et sécurisés</p>
                <div class="hero-features">
                    <div class="feature-card">
                        <i class="bi bi-calendar-event"></i>
                        <h3>Créer des Événements</h3>
                        <p>Mariages, anniversaires, conférences</p>
                    </div>
                    <div class="feature-card">
                        <i class="bi bi-people"></i>
                        <h3>Gérer les Invités</h3>
                        <p>Import CSV, formulaire, export</p>
                    </div>
                    <div class="feature-card">
                        <i class="bi bi-qr-code"></i>
                        <h3>QR Codes Stylisés</h3>
                        <p>Personnalisables et téléchargeables</p>
                    </div>
                    <div class="feature-card">
                        <i class="bi bi-share"></i>
                        <h3>Partage Facile</h3>
                        <p>Email, SMS, téléchargement direct</p>
                    </div>
                </div>
                <div class="hero-cta">
                    <a href="events.html" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i>
                        Créer un Événement
                    </a>
                    <a href="scanner.html" class="btn btn-secondary">
                        <i class="bi bi-camera"></i>
                        Scanner un QR Code
                    </a>
                </div>
            </div>
        </div>
    </section>


       <!-- STATS -->
        <section class="stats-section">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card animate-slide-up">
                    <div class="stat-icon">
                        <i class="bi bi-calendar-event"></i>
                    </div>
                    <div class="stat-value" id="totalEvents">0</div>
                    <div class="stat-label">Événements</div>
                </div>
                <div class="stat-card animate-slide-up">
                    <div class="stat-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="stat-value"  id="totalGuests">0</div>
                    <div class="stat-label">Invités</div>
                </div>
                <div class="stat-card animate-slide-up">
                    <div class="stat-icon">
                        <i class="bi bi-qr-code"></i>
                    </div>
                    <div class="stat-value" id="totalQrCodes">0</div>
                    <div class="stat-label">QR Codes</div>
                </div>
                <div class="stat-card animate-slide-up">
                    <div class="stat-icon">
                        <i class="bi bi-upc-scan"></i>
                    </div>
                    <div class="stat-value" id="scannedQrCodes">0</div>
                    <div class="stat-label">Scans</div>
                </div>
            </div>
            </div>
            </section>

        <!-- Charts Section -->
<section class="charts-section">
    <div class="container">
        <h2 class="charts-title">
            <i class="bi bi-bar-chart-line-fill"></i> Statistiques d’utilisation
        </h2>
        <p class="charts-subtitle">
            Suivez en temps réel les scans de QR Codes et la répartition de vos événements
        </p>

        <div class="row g-4">
            <div class="col-lg-6">
                <div class="chart-container">
                    <div class="chart-label">
                        <i class="bi bi-check-circle-fill"></i> Taux de Scan
                    </div>
                    <canvas id="scanChart"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-container">
                    <div class="chart-label">
                        <i class="bi bi-pie-chart-fill"></i> Événements les plus populaires
                    </div>
                    <canvas id="eventTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>
            
    <!-- Recent Events -->
    <section class="recent-events">
        <div class="container">
            <div class="section-header">
                <h2>Événements Récents</h2>
                <a href="events.html" class="btn btn-outline">Voir Tout</a>
            </div>
            <div class="row g-4 justify-content-center" id="recentEventsGrid">
                <div class="empty-state">
                    <i class="bi bi-calendar-plus"></i>
                    <p>Aucun événement créé</p>
                    <a href="events.html" class="btn btn-primary">Créer votre premier événement</a>
                </div>
            </div>
        </div>
    </section>
<!-- Footer -->

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-shield-check" style="font-size:1.5rem;"></i>
                    <span style="font-weight:600;">SECURA</span>
                </div>
                <p class="mb-0">© 2025 SECURA. Tous droits réservés.</p>
                <div class="d-flex gap-3">
                    <a href="#" class="footer-link">Confidentialité</a>
                    <a href="#" class="footer-link">Conditions</a>
                    <a href="#" class="footer-link">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- Scroll to Top -->
    <button class="scroll-top" id="scrollTop" aria-label="Retour en haut">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- Scripts -->

          <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>


<!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="js/particles-config.js"></script>
    <script src="js/audio-utils.js"></script>
    <script src="js/theme.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/events.js"></script>
    <script src="js/main.js"></script>

    <script>
   



        // === LOGOUT ==
        document.getElementById('logout-btn').addEventListener('click', () => {
            storage.logout();
    });
        

    let scanChart, eventTypeChart;
let popularEventsChart = null;

// === STRING TO COLOR (pour couleurs dynamiques) ===
function stringToColor(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
    return "#" + "00000".substring(0, 6 - c.length) + c;
}
        
async function updateDashboard() {
            try {
                const stats = await storage.getStatistics();
                const eventsResp = await storage.getAllEvents();

                // Stats
                document.getElementById('totalEvents').textContent = stats.totalEvents || 0;
                document.getElementById('totalGuests').textContent = stats.totalGuests || 0;
                document.getElementById('totalQrCodes').textContent = stats.totalQRCodes || 0;
                document.getElementById('scannedQrCodes').textContent = stats.scannedGuests || 0;

    Chart.register(ChartDataLabels);


             // === CHARTS ===
        updateScanChart(stats);
        updatePopularEventsChart(eventsResp);


            } catch (err) {
                console.error("Dashboard update failed:", err);
            }
        }

      function updateScanChart(stats) {
    const ctx = document.getElementById('scanChart').getContext('2d');
    if (scanChart) scanChart.destroy();
    scanChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Scannés', 'En attente'],
            datasets: [{
                data: [
                    stats.scannedGuests || 0,
                    Math.max((stats.totalGuests || 0) - (stats.scannedGuests || 0), 0)
                ],
                backgroundColor: ['#10B981', '#EF4444'],
                borderWidth: 0,
                borderRadius: 8,
                spacing: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#fff',
                        font: { size: 13, family: 'Poppins', weight: '600' },
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleFont: { family: 'Poppins' },
                    bodyFont: { family: 'Poppins' }
                }
            },
            cutout: '68%',
            animation: {
                animateRotate: true,
                duration: 1800,
                easing: 'easeOutQuart'
            }
        }
    });
}



function updatePopularEventsChart(eventsResp) {
     const events = eventsResp || [];


    // -----------------------------------------------------------------
    // 1. Aucun événement → message vide
    // -----------------------------------------------------------------
    const container = document.getElementById('eventTypeChart').parentElement;
    if (events.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-center py-8">Aucun événement</p>';
        return;
    }

    // -----------------------------------------------------------------
    // 2. Stats par événement (total + scannés)
    // -----------------------------------------------------------------
    const eventStats = events.map(ev => {
        const allGuests   = storage.getGuestsByEventId(ev.id);             
        const scanned     = allGuests.filter(g => g.scanned).length;
        const total       = allGuests.length;

        return {
            id:       ev.id,
            name:     ev.name,
            date:     ev.date,
            location: ev.location || 'Non spécifié',
            total,
            scanned,
            color:    stringToColor(ev.name)               // couleur unique
        };
    });

    // tri décroissant (total)
    eventStats.sort((a, b) => b.total - a.total);
    const top = eventStats.slice(0, 8);                    

    const ctx = document.getElementById('eventTypeChart').getContext('2d');

    // détruire l’ancien graphique
    if (popularEventsChart) popularEventsChart.destroy();

    // -----------------------------------------------------------------
    // 3. Datasets
    // -----------------------------------------------------------------
    const datasets = [
        {
            label: 'Total invités',
            data: top.map(e => e.total),
            backgroundColor: top.map(e => e.color + '33'), 
            borderColor: top.map(e => e.color),
            borderWidth: 2,
            borderRadius: 12,
            barPercentage: 0.9,
            categoryPercentage: 0.8
        },
        {
            label: 'Scannés',
            data: top.map(e => e.scanned),
            backgroundColor: top.map(e => e.color),      
            borderColor: top.map(e => e.color),
            borderWidth: 0,
            borderRadius: 12,
            barPercentage: 0.9,
            categoryPercentage: 0.8
        }
    ];

    // -----------------------------------------------------------------
    // 4. Chart
    // -----------------------------------------------------------------
    popularEventsChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: top.map(e => e.name), datasets },
        options: {
            indexAxis: 'x',                    
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 1800, easing: 'easeOutQuart' },

            plugins: {
                legend: { display: false },

                tooltip: {
                    backgroundColor: '#1E293B',
                    titleColor: '#F8FAFC',
                    bodyColor: '#E2E8F0',
                    cornerRadius: 10,
                    padding: 12,
                    displayColors: false,
                    callbacks: {
                        label: ctx => {
                            const e = top[ctx.dataIndex];
                            const set = ctx.datasetIndex === 0 ? 'total' : 'scanned';
                            const val = set === 'total' ? e.total : e.scanned;
                            return `${val} invité${val > 1 ? 's' : ''} ${set === 'scanned' ? '(scanné)' : ''}`;
                        },
                        afterLabel: ctx => {
                            const e = top[ctx.dataIndex];
                            return [
                                `Date: ${new Date(e.date).toLocaleDateString('fr-FR')}`,
                                `Lieu: ${e.location}`
                            ];
                        }
                    }
                },

                // -------------------------------------------------
                //  DATALABELS – affiché **sur la barre**
                // -------------------------------------------------
                datalabels: {
                    anchor: 'end',
                    align: 'end',               // à droite de la barre
                    offset: 8,
                    color: '#F8FAFC',
                    font: { weight: '600', size: 13, family: 'Poppins' },
                    formatter: (value, ctx) => {
                        if (ctx.datasetIndex === 1) return `${value} scannés`;
                        return `${value} total`;
                    }
                }
            },

            scales: {
                x: {
                    stacked: true,
                    beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#94A3B8', font: { size: 12, family: 'Inter' } }
                },
                y: {
                    stacked: true,
                    grid: { display: false },
                    ticks: {
                        color: '#F8FAFC',
                        font: { size: 13, weight: '600', family: 'Poppins' },
                        padding: 12
                    }
                }
            }
        },

        // -------------------------------------------------
        //  PLUGIN : ombre douce (glow)
        // -------------------------------------------------
        plugins: [{
            id: 'barGlow',
            beforeDatasetsDraw(chart) {
                const { ctx } = chart;
                ctx.save();
                chart.data.datasets.forEach((ds, i) => {
                    const meta = chart.getDatasetMeta(i);
                    meta.data.forEach((bar, idx) => {
                        const col = top[idx].color;
                        ctx.shadowColor = col + '44';
                        ctx.shadowBlur = 12;
                        ctx.fillStyle = ds.backgroundColor[idx];
                        ctx.fillRect(bar.x - bar.width / 2, bar.y, bar.width, bar.height);
                    });
                });
                ctx.restore();
            }
        }]
    });
}


        // === PARTICLES JS ===
        function initParticles() {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: '#D97706' },
                    shape: { type: 'circle' },
                    opacity: { value: 0.3, random: true },
                    size: { value: 3, random: true },
                    line_linked: { enable: true, distance: 150, color: '#D97706', opacity: 0.2, width: 1 },
                    move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
                    modes: { repulse: { distance: 100, duration: 0.4 }, push: { particles_nb: 4 } }
                },
                retina_detect: true
            });
        }

        

        // === INIT ===
        document.addEventListener('DOMContentLoaded', async () => {
            initParticles();
            await window.storageReady;
            updateDashboard();

            

            // Real-time updates
            window.addEventListener('secura:data-updated', updateDashboard);
        });

        // === AUDIO PRELOAD ===
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof SECURA_AUDIO !== 'undefined') {
                SECURA_AUDIO.preload();
            }
        });

        </script>
</body>
</html>